<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ManagementServiceBatchTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.mgmt</a> &gt; <span class="el_source">ManagementServiceBatchTest.java</span></div><h1>ManagementServiceBatchTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.engine.test.api.mgmt;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.tuple;

import java.util.Arrays;
import java.util.List;

import org.flowable.batch.api.Batch;
import org.flowable.batch.api.BatchPart;
import org.flowable.common.engine.api.scope.ScopeTypes;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.impl.util.CommandContextUtil;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.Test;

/**
 * @author Filip Hrisafov
 */
<span class="nc" id="L32">class ManagementServiceBatchTest extends PluggableFlowableTestCase {</span>

    @AfterEach
    void tearDown() {
<span class="nc" id="L36">        List&lt;Batch&gt; batches = managementService.getAllBatches();</span>
<span class="nc bnc" id="L37" title="All 2 branches missed.">        for (Batch batch : batches) {</span>
<span class="nc" id="L38">            managementService.deleteBatch(batch.getId());</span>
<span class="nc" id="L39">        }</span>
<span class="nc" id="L40">    }</span>

    @Test
    void createBatchPart() {
<span class="nc" id="L44">        Batch batch = managementService.createBatchBuilder()</span>
<span class="nc" id="L45">                .batchType(&quot;test&quot;)</span>
<span class="nc" id="L46">                .searchKey(&quot;search 1&quot;)</span>
<span class="nc" id="L47">                .searchKey2(&quot;search 2&quot;)</span>
<span class="nc" id="L48">                .status(&quot;start&quot;)</span>
<span class="nc" id="L49">                .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L50">                .create();</span>

<span class="nc" id="L52">        assertThat(batch.getBatchType()).isEqualTo(&quot;test&quot;);</span>
<span class="nc" id="L53">        assertThat(batch.getBatchSearchKey()).isEqualTo(&quot;search 1&quot;);</span>
<span class="nc" id="L54">        assertThat(batch.getBatchSearchKey2()).isEqualTo(&quot;search 2&quot;);</span>
<span class="nc" id="L55">        assertThat(batch.getStatus()).isEqualTo(&quot;start&quot;);</span>
<span class="nc" id="L56">        assertThat(batch.getTenantId()).isEqualTo(&quot;flowable&quot;);</span>

<span class="nc" id="L58">        BatchPart part = managementService.createBatchPartBuilder(batch)</span>
<span class="nc" id="L59">                .type(&quot;testPart&quot;)</span>
<span class="nc" id="L60">                .searchKey(&quot;part search 1&quot;)</span>
<span class="nc" id="L61">                .searchKey2(&quot;part search 2&quot;)</span>
<span class="nc" id="L62">                .status(&quot;startPart&quot;)</span>
<span class="nc" id="L63">                .scopeId(&quot;scope1&quot;)</span>
<span class="nc" id="L64">                .subScopeId(&quot;subScope1&quot;)</span>
<span class="nc" id="L65">                .scopeType(&quot;test&quot;)</span>
<span class="nc" id="L66">                .create();</span>

<span class="nc" id="L68">        assertThat(part).isNotNull();</span>
<span class="nc" id="L69">        assertThat(part.getType()).isEqualTo(&quot;testPart&quot;);</span>
<span class="nc" id="L70">        assertThat(part.getBatchType()).isEqualTo(&quot;test&quot;);</span>
<span class="nc" id="L71">        assertThat(part.getBatchId()).isEqualTo(batch.getId());</span>
<span class="nc" id="L72">        assertThat(part.getCreateTime()).isNotNull();</span>
<span class="nc" id="L73">        assertThat(part.getCompleteTime()).isNull();</span>
<span class="nc" id="L74">        assertThat(part.isCompleted()).isFalse();</span>
<span class="nc" id="L75">        assertThat(part.getSearchKey()).isEqualTo(&quot;part search 1&quot;);</span>
<span class="nc" id="L76">        assertThat(part.getSearchKey2()).isEqualTo(&quot;part search 2&quot;);</span>
<span class="nc" id="L77">        assertThat(part.getBatchSearchKey()).isEqualTo(&quot;search 1&quot;);</span>
<span class="nc" id="L78">        assertThat(part.getBatchSearchKey2()).isEqualTo(&quot;search 2&quot;);</span>
<span class="nc" id="L79">        assertThat(part.getStatus()).isEqualTo(&quot;startPart&quot;);</span>
<span class="nc" id="L80">        assertThat(part.getScopeId()).isEqualTo(&quot;scope1&quot;);</span>
<span class="nc" id="L81">        assertThat(part.getSubScopeId()).isEqualTo(&quot;subScope1&quot;);</span>
<span class="nc" id="L82">        assertThat(part.getScopeType()).isEqualTo(&quot;test&quot;);</span>
<span class="nc" id="L83">        assertThat(part.getTenantId()).isEqualTo(&quot;flowable&quot;);</span>

<span class="nc" id="L85">        part = managementService.createBatchPartQuery().id(part.getId()).singleResult();</span>
<span class="nc" id="L86">        assertThat(part).isNotNull();</span>
<span class="nc" id="L87">        assertThat(part.getType()).isEqualTo(&quot;testPart&quot;);</span>
<span class="nc" id="L88">        assertThat(part.getBatchType()).isEqualTo(&quot;test&quot;);</span>
<span class="nc" id="L89">        assertThat(part.getBatchId()).isEqualTo(batch.getId());</span>
<span class="nc" id="L90">        assertThat(part.getCreateTime()).isNotNull();</span>
<span class="nc" id="L91">        assertThat(part.getCompleteTime()).isNull();</span>
<span class="nc" id="L92">        assertThat(part.isCompleted()).isFalse();</span>
<span class="nc" id="L93">        assertThat(part.getSearchKey()).isEqualTo(&quot;part search 1&quot;);</span>
<span class="nc" id="L94">        assertThat(part.getSearchKey2()).isEqualTo(&quot;part search 2&quot;);</span>
<span class="nc" id="L95">        assertThat(part.getBatchSearchKey()).isEqualTo(&quot;search 1&quot;);</span>
<span class="nc" id="L96">        assertThat(part.getBatchSearchKey2()).isEqualTo(&quot;search 2&quot;);</span>
<span class="nc" id="L97">        assertThat(part.getStatus()).isEqualTo(&quot;startPart&quot;);</span>
<span class="nc" id="L98">        assertThat(part.getScopeId()).isEqualTo(&quot;scope1&quot;);</span>
<span class="nc" id="L99">        assertThat(part.getSubScopeId()).isEqualTo(&quot;subScope1&quot;);</span>
<span class="nc" id="L100">        assertThat(part.getScopeType()).isEqualTo(&quot;test&quot;);</span>
<span class="nc" id="L101">        assertThat(part.getTenantId()).isEqualTo(&quot;flowable&quot;);</span>
<span class="nc" id="L102">    }</span>

    @Test
    void queryBatchParts() {
<span class="nc" id="L106">        Batch flowableBatch = managementService.createBatchBuilder()</span>
<span class="nc" id="L107">                .batchType(&quot;testFlowable&quot;)</span>
<span class="nc" id="L108">                .searchKey(&quot;search 1&quot;)</span>
<span class="nc" id="L109">                .searchKey2(&quot;flowable search 1&quot;)</span>
<span class="nc" id="L110">                .status(&quot;start&quot;)</span>
<span class="nc" id="L111">                .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L112">                .create();</span>
<span class="nc" id="L113">        Batch acmeBatch = managementService.createBatchBuilder()</span>
<span class="nc" id="L114">                .batchType(&quot;testAcme&quot;)</span>
<span class="nc" id="L115">                .searchKey(&quot;search 1&quot;)</span>
<span class="nc" id="L116">                .searchKey2(&quot;acme search 1&quot;)</span>
<span class="nc" id="L117">                .status(&quot;start&quot;)</span>
<span class="nc" id="L118">                .tenantId(&quot;acme&quot;)</span>
<span class="nc" id="L119">                .create();</span>

<span class="nc" id="L121">        managementService.createBatchPartBuilder(flowableBatch)</span>
<span class="nc" id="L122">                .type(&quot;partStart&quot;)</span>
<span class="nc" id="L123">                .status(&quot;start&quot;)</span>
<span class="nc" id="L124">                .searchKey(&quot;part 1&quot;)</span>
<span class="nc" id="L125">                .searchKey2(&quot;flowable part 1&quot;)</span>
<span class="nc" id="L126">                .scopeId(&quot;flowable1&quot;)</span>
<span class="nc" id="L127">                .subScopeId(&quot;subFlowable1&quot;)</span>
<span class="nc" id="L128">                .scopeType(&quot;test&quot;)</span>
<span class="nc" id="L129">                .create();</span>
<span class="nc" id="L130">        managementService.createBatchPartBuilder(flowableBatch)</span>
<span class="nc" id="L131">                .type(&quot;partWait&quot;)</span>
<span class="nc" id="L132">                .status(&quot;wait&quot;)</span>
<span class="nc" id="L133">                .searchKey(&quot;part 2&quot;)</span>
<span class="nc" id="L134">                .searchKey2(&quot;flowable part 2&quot;)</span>
<span class="nc" id="L135">                .scopeId(&quot;flowable2&quot;)</span>
<span class="nc" id="L136">                .subScopeId(&quot;subFlowable2&quot;)</span>
<span class="nc" id="L137">                .scopeType(&quot;test&quot;)</span>
<span class="nc" id="L138">                .create();</span>
<span class="nc" id="L139">        managementService.createBatchPartBuilder(flowableBatch)</span>
<span class="nc" id="L140">                .type(&quot;partRun&quot;)</span>
<span class="nc" id="L141">                .status(&quot;run&quot;)</span>
<span class="nc" id="L142">                .searchKey(&quot;part 3&quot;)</span>
<span class="nc" id="L143">                .searchKey2(&quot;flowable part 3&quot;)</span>
<span class="nc" id="L144">                .scopeId(&quot;flowable3&quot;)</span>
<span class="nc" id="L145">                .subScopeId(&quot;subFlowable3&quot;)</span>
<span class="nc" id="L146">                .scopeType(ScopeTypes.BPMN)</span>
<span class="nc" id="L147">                .create();</span>

<span class="nc" id="L149">        managementService.createBatchPartBuilder(acmeBatch)</span>
<span class="nc" id="L150">                .type(&quot;partStart&quot;)</span>
<span class="nc" id="L151">                .status(&quot;start&quot;)</span>
<span class="nc" id="L152">                .searchKey(&quot;part 1&quot;)</span>
<span class="nc" id="L153">                .searchKey2(&quot;acme part 1&quot;)</span>
<span class="nc" id="L154">                .scopeId(&quot;acme1&quot;)</span>
<span class="nc" id="L155">                .subScopeId(&quot;subAcme1&quot;)</span>
<span class="nc" id="L156">                .scopeType(&quot;test&quot;)</span>
<span class="nc" id="L157">                .create();</span>
<span class="nc" id="L158">        managementService.createBatchPartBuilder(acmeBatch)</span>
<span class="nc" id="L159">                .type(&quot;partWait&quot;)</span>
<span class="nc" id="L160">                .status(&quot;wait&quot;)</span>
<span class="nc" id="L161">                .searchKey(&quot;part 2&quot;)</span>
<span class="nc" id="L162">                .searchKey2(&quot;acme part 2&quot;)</span>
<span class="nc" id="L163">                .scopeId(&quot;acme2&quot;)</span>
<span class="nc" id="L164">                .subScopeId(&quot;subAcme2&quot;)</span>
<span class="nc" id="L165">                .scopeType(&quot;test&quot;)</span>
<span class="nc" id="L166">                .create();</span>
<span class="nc" id="L167">        managementService.createBatchPartBuilder(acmeBatch)</span>
<span class="nc" id="L168">                .type(&quot;partRun&quot;)</span>
<span class="nc" id="L169">                .status(&quot;run&quot;)</span>
<span class="nc" id="L170">                .searchKey(&quot;part 3&quot;)</span>
<span class="nc" id="L171">                .searchKey2(&quot;acme part 3&quot;)</span>
<span class="nc" id="L172">                .scopeId(&quot;acme3&quot;)</span>
<span class="nc" id="L173">                .subScopeId(&quot;subAcme3&quot;)</span>
<span class="nc" id="L174">                .scopeType(ScopeTypes.BPMN)</span>
<span class="nc" id="L175">                .create();</span>

<span class="nc" id="L177">        assertThat(managementService.createBatchPartQuery().list())</span>
<span class="nc" id="L178">                .extracting(BatchPart::getScopeId, BatchPart::getSubScopeId)</span>
<span class="nc" id="L179">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L180">                        tuple(&quot;flowable1&quot;, &quot;subFlowable1&quot;),</span>
<span class="nc" id="L181">                        tuple(&quot;flowable2&quot;, &quot;subFlowable2&quot;),</span>
<span class="nc" id="L182">                        tuple(&quot;flowable3&quot;, &quot;subFlowable3&quot;),</span>
<span class="nc" id="L183">                        tuple(&quot;acme1&quot;, &quot;subAcme1&quot;),</span>
<span class="nc" id="L184">                        tuple(&quot;acme2&quot;, &quot;subAcme2&quot;),</span>
<span class="nc" id="L185">                        tuple(&quot;acme3&quot;, &quot;subAcme3&quot;)</span>
                );
<span class="nc" id="L187">        assertThat(managementService.createBatchPartQuery().count()).isEqualTo(6);</span>

<span class="nc" id="L189">        assertThat(managementService.createBatchPartQuery().batchId(acmeBatch.getId()).list())</span>
<span class="nc" id="L190">                .extracting(BatchPart::getScopeId, BatchPart::getSubScopeId)</span>
<span class="nc" id="L191">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L192">                        tuple(&quot;acme1&quot;, &quot;subAcme1&quot;),</span>
<span class="nc" id="L193">                        tuple(&quot;acme2&quot;, &quot;subAcme2&quot;),</span>
<span class="nc" id="L194">                        tuple(&quot;acme3&quot;, &quot;subAcme3&quot;)</span>
                );
<span class="nc" id="L196">        assertThat(managementService.createBatchPartQuery().batchId(acmeBatch.getId()).count()).isEqualTo(3);</span>

<span class="nc" id="L198">        assertThat(managementService.createBatchPartQuery().type(&quot;partStart&quot;).list())</span>
<span class="nc" id="L199">                .extracting(BatchPart::getScopeId, BatchPart::getSubScopeId)</span>
<span class="nc" id="L200">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L201">                        tuple(&quot;flowable1&quot;, &quot;subFlowable1&quot;),</span>
<span class="nc" id="L202">                        tuple(&quot;acme1&quot;, &quot;subAcme1&quot;)</span>
                );
<span class="nc" id="L204">        assertThat(managementService.createBatchPartQuery().type(&quot;partStart&quot;).count()).isEqualTo(2);</span>

<span class="nc" id="L206">        assertThat(managementService.createBatchPartQuery().type(&quot;partRun&quot;).list())</span>
<span class="nc" id="L207">                .extracting(BatchPart::getScopeId, BatchPart::getSubScopeId)</span>
<span class="nc" id="L208">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L209">                        tuple(&quot;flowable3&quot;, &quot;subFlowable3&quot;),</span>
<span class="nc" id="L210">                        tuple(&quot;acme3&quot;, &quot;subAcme3&quot;)</span>
                );
<span class="nc" id="L212">        assertThat(managementService.createBatchPartQuery().type(&quot;partRun&quot;).count()).isEqualTo(2);</span>

<span class="nc" id="L214">        assertThat(managementService.createBatchPartQuery().type(&quot;unknown&quot;).list()).isEmpty();</span>
<span class="nc" id="L215">        assertThat(managementService.createBatchPartQuery().type(&quot;unknown&quot;).count()).isZero();</span>

<span class="nc" id="L217">        assertThat(managementService.createBatchPartQuery().searchKey(&quot;part 1&quot;).list())</span>
<span class="nc" id="L218">                .extracting(BatchPart::getScopeId, BatchPart::getSubScopeId)</span>
<span class="nc" id="L219">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L220">                        tuple(&quot;flowable1&quot;, &quot;subFlowable1&quot;),</span>
<span class="nc" id="L221">                        tuple(&quot;acme1&quot;, &quot;subAcme1&quot;)</span>
                );
<span class="nc" id="L223">        assertThat(managementService.createBatchPartQuery().searchKey(&quot;part 1&quot;).count()).isEqualTo(2);</span>

<span class="nc" id="L225">        assertThat(managementService.createBatchPartQuery().searchKey2(&quot;part 1&quot;).list()).isEmpty();</span>
<span class="nc" id="L226">        assertThat(managementService.createBatchPartQuery().searchKey2(&quot;part 1&quot;).count()).isZero();</span>

<span class="nc" id="L228">        assertThat(managementService.createBatchPartQuery().searchKey2(&quot;flowable part 1&quot;).list())</span>
<span class="nc" id="L229">                .extracting(BatchPart::getScopeId, BatchPart::getSubScopeId)</span>
<span class="nc" id="L230">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L231">                        tuple(&quot;flowable1&quot;, &quot;subFlowable1&quot;)</span>
                );
<span class="nc" id="L233">        assertThat(managementService.createBatchPartQuery().searchKey2(&quot;flowable part 1&quot;).count()).isEqualTo(1);</span>

<span class="nc" id="L235">        assertThat(managementService.createBatchPartQuery().batchType(&quot;testFlowable&quot;).list())</span>
<span class="nc" id="L236">                .extracting(BatchPart::getScopeId, BatchPart::getSubScopeId)</span>
<span class="nc" id="L237">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L238">                        tuple(&quot;flowable1&quot;, &quot;subFlowable1&quot;),</span>
<span class="nc" id="L239">                        tuple(&quot;flowable2&quot;, &quot;subFlowable2&quot;),</span>
<span class="nc" id="L240">                        tuple(&quot;flowable3&quot;, &quot;subFlowable3&quot;)</span>
                );
<span class="nc" id="L242">        assertThat(managementService.createBatchPartQuery().batchType(&quot;testFlowable&quot;).count()).isEqualTo(3);</span>

<span class="nc" id="L244">        assertThat(managementService.createBatchPartQuery().batchType(&quot;unknown&quot;).list()).isEmpty();</span>
<span class="nc" id="L245">        assertThat(managementService.createBatchPartQuery().batchType(&quot;unknown&quot;).count()).isZero();</span>

<span class="nc" id="L247">        assertThat(managementService.createBatchPartQuery().batchSearchKey(&quot;search 1&quot;).list())</span>
<span class="nc" id="L248">                .extracting(BatchPart::getScopeId, BatchPart::getSubScopeId)</span>
<span class="nc" id="L249">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L250">                        tuple(&quot;flowable1&quot;, &quot;subFlowable1&quot;),</span>
<span class="nc" id="L251">                        tuple(&quot;flowable2&quot;, &quot;subFlowable2&quot;),</span>
<span class="nc" id="L252">                        tuple(&quot;flowable3&quot;, &quot;subFlowable3&quot;),</span>
<span class="nc" id="L253">                        tuple(&quot;acme1&quot;, &quot;subAcme1&quot;),</span>
<span class="nc" id="L254">                        tuple(&quot;acme2&quot;, &quot;subAcme2&quot;),</span>
<span class="nc" id="L255">                        tuple(&quot;acme3&quot;, &quot;subAcme3&quot;)</span>
                );
<span class="nc" id="L257">        assertThat(managementService.createBatchPartQuery().batchSearchKey(&quot;search 1&quot;).count()).isEqualTo(6);</span>

<span class="nc" id="L259">        assertThat(managementService.createBatchPartQuery().batchSearchKey2(&quot;search 1&quot;).list()).isEmpty();</span>
<span class="nc" id="L260">        assertThat(managementService.createBatchPartQuery().batchSearchKey2(&quot;search 1&quot;).count()).isZero();</span>

<span class="nc" id="L262">        assertThat(managementService.createBatchPartQuery().batchSearchKey2(&quot;flowable search 1&quot;).list())</span>
<span class="nc" id="L263">                .extracting(BatchPart::getScopeId, BatchPart::getSubScopeId)</span>
<span class="nc" id="L264">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L265">                        tuple(&quot;flowable1&quot;, &quot;subFlowable1&quot;),</span>
<span class="nc" id="L266">                        tuple(&quot;flowable2&quot;, &quot;subFlowable2&quot;),</span>
<span class="nc" id="L267">                        tuple(&quot;flowable3&quot;, &quot;subFlowable3&quot;)</span>
                );
<span class="nc" id="L269">        assertThat(managementService.createBatchPartQuery().batchSearchKey2(&quot;flowable search 1&quot;).count()).isEqualTo(3);</span>

<span class="nc" id="L271">        assertThat(managementService.createBatchPartQuery().status(&quot;wait&quot;).list())</span>
<span class="nc" id="L272">                .extracting(BatchPart::getScopeId, BatchPart::getSubScopeId)</span>
<span class="nc" id="L273">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L274">                        tuple(&quot;flowable2&quot;, &quot;subFlowable2&quot;),</span>
<span class="nc" id="L275">                        tuple(&quot;acme2&quot;, &quot;subAcme2&quot;)</span>
                );
<span class="nc" id="L277">        assertThat(managementService.createBatchPartQuery().status(&quot;wait&quot;).count()).isEqualTo(2);</span>

<span class="nc" id="L279">        assertThat(managementService.createBatchPartQuery().scopeId(&quot;flowable2&quot;).list())</span>
<span class="nc" id="L280">                .extracting(BatchPart::getScopeId, BatchPart::getSubScopeId)</span>
<span class="nc" id="L281">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L282">                        tuple(&quot;flowable2&quot;, &quot;subFlowable2&quot;)</span>
                );
<span class="nc" id="L284">        assertThat(managementService.createBatchPartQuery().scopeId(&quot;flowable2&quot;).count()).isEqualTo(1);</span>

<span class="nc" id="L286">        assertThat(managementService.createBatchPartQuery().scopeId(&quot;unknown&quot;).list()).isEmpty();</span>
<span class="nc" id="L287">        assertThat(managementService.createBatchPartQuery().scopeId(&quot;unknown&quot;).count()).isZero();</span>

<span class="nc" id="L289">        assertThat(managementService.createBatchPartQuery().subScopeId(&quot;subFlowable3&quot;).list())</span>
<span class="nc" id="L290">                .extracting(BatchPart::getScopeId, BatchPart::getSubScopeId)</span>
<span class="nc" id="L291">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L292">                        tuple(&quot;flowable3&quot;, &quot;subFlowable3&quot;)</span>
                );
<span class="nc" id="L294">        assertThat(managementService.createBatchPartQuery().subScopeId(&quot;subFlowable3&quot;).count()).isEqualTo(1);</span>

<span class="nc" id="L296">        assertThat(managementService.createBatchPartQuery().subScopeId(&quot;unknown&quot;).list()).isEmpty();</span>
<span class="nc" id="L297">        assertThat(managementService.createBatchPartQuery().subScopeId(&quot;unknown&quot;).count()).isZero();</span>

<span class="nc" id="L299">        assertThat(managementService.createBatchPartQuery().scopeType(&quot;test&quot;).list())</span>
<span class="nc" id="L300">                .extracting(BatchPart::getScopeId, BatchPart::getSubScopeId)</span>
<span class="nc" id="L301">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L302">                        tuple(&quot;flowable1&quot;, &quot;subFlowable1&quot;),</span>
<span class="nc" id="L303">                        tuple(&quot;flowable2&quot;, &quot;subFlowable2&quot;),</span>
<span class="nc" id="L304">                        tuple(&quot;acme1&quot;, &quot;subAcme1&quot;),</span>
<span class="nc" id="L305">                        tuple(&quot;acme2&quot;, &quot;subAcme2&quot;)</span>
                );
<span class="nc" id="L307">        assertThat(managementService.createBatchPartQuery().scopeType(&quot;test&quot;).count()).isEqualTo(4);</span>

<span class="nc" id="L309">        assertThat(managementService.createBatchPartQuery().scopeType(&quot;unknown&quot;).list()).isEmpty();</span>
<span class="nc" id="L310">        assertThat(managementService.createBatchPartQuery().scopeType(&quot;unknown&quot;).count()).isZero();</span>

<span class="nc" id="L312">        assertThat(managementService.createBatchPartQuery().tenantId(&quot;flowable&quot;).list())</span>
<span class="nc" id="L313">                .extracting(BatchPart::getScopeId, BatchPart::getSubScopeId)</span>
<span class="nc" id="L314">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L315">                        tuple(&quot;flowable1&quot;, &quot;subFlowable1&quot;),</span>
<span class="nc" id="L316">                        tuple(&quot;flowable2&quot;, &quot;subFlowable2&quot;),</span>
<span class="nc" id="L317">                        tuple(&quot;flowable3&quot;, &quot;subFlowable3&quot;)</span>
                );
<span class="nc" id="L319">        assertThat(managementService.createBatchPartQuery().tenantId(&quot;flowable&quot;).count()).isEqualTo(3);</span>

<span class="nc" id="L321">        assertThat(managementService.createBatchPartQuery().tenantId(&quot;unknown&quot;).list()).isEmpty();</span>
<span class="nc" id="L322">        assertThat(managementService.createBatchPartQuery().tenantId(&quot;unknown&quot;).count()).isZero();</span>

<span class="nc" id="L324">        assertThat(managementService.createBatchPartQuery().tenantIdLike(&quot;%a%&quot;).list())</span>
<span class="nc" id="L325">                .extracting(BatchPart::getScopeId, BatchPart::getSubScopeId)</span>
<span class="nc" id="L326">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L327">                        tuple(&quot;flowable1&quot;, &quot;subFlowable1&quot;),</span>
<span class="nc" id="L328">                        tuple(&quot;flowable2&quot;, &quot;subFlowable2&quot;),</span>
<span class="nc" id="L329">                        tuple(&quot;flowable3&quot;, &quot;subFlowable3&quot;),</span>
<span class="nc" id="L330">                        tuple(&quot;acme1&quot;, &quot;subAcme1&quot;),</span>
<span class="nc" id="L331">                        tuple(&quot;acme2&quot;, &quot;subAcme2&quot;),</span>
<span class="nc" id="L332">                        tuple(&quot;acme3&quot;, &quot;subAcme3&quot;)</span>
                );
<span class="nc" id="L334">        assertThat(managementService.createBatchPartQuery().tenantIdLike(&quot;%a%&quot;).count()).isEqualTo(6);</span>

<span class="nc" id="L336">        assertThat(managementService.createBatchPartQuery().tenantIdLike(&quot;%acm%&quot;).list())</span>
<span class="nc" id="L337">                .extracting(BatchPart::getScopeId, BatchPart::getSubScopeId)</span>
<span class="nc" id="L338">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L339">                        tuple(&quot;acme1&quot;, &quot;subAcme1&quot;),</span>
<span class="nc" id="L340">                        tuple(&quot;acme2&quot;, &quot;subAcme2&quot;),</span>
<span class="nc" id="L341">                        tuple(&quot;acme3&quot;, &quot;subAcme3&quot;)</span>
                );
<span class="nc" id="L343">        assertThat(managementService.createBatchPartQuery().tenantIdLike(&quot;%acm%&quot;).count()).isEqualTo(3);</span>
<span class="nc" id="L344">    }</span>

    @Test
    void queryCompletedBatchParts() {
<span class="nc" id="L348">        Batch batch = managementService.createBatchBuilder()</span>
<span class="nc" id="L349">                .batchType(&quot;test&quot;)</span>
<span class="nc" id="L350">                .status(&quot;start&quot;)</span>
<span class="nc" id="L351">                .create();</span>

<span class="nc" id="L353">        BatchPart completedBatchPart = managementService.createBatchPartBuilder(batch)</span>
<span class="nc" id="L354">                .type(&quot;start&quot;)</span>
<span class="nc" id="L355">                .status(&quot;completed&quot;)</span>
<span class="nc" id="L356">                .searchKey(&quot;Completed Part&quot;)</span>
<span class="nc" id="L357">                .create();</span>

<span class="nc" id="L359">        managementService.createBatchPartBuilder(batch)</span>
<span class="nc" id="L360">                .type(&quot;start&quot;)</span>
<span class="nc" id="L361">                .status(&quot;waiting&quot;)</span>
<span class="nc" id="L362">                .searchKey(&quot;Not Completed Part&quot;)</span>
<span class="nc" id="L363">                .create();</span>

<span class="nc" id="L365">        assertThat(managementService.createBatchPartQuery().list())</span>
<span class="nc" id="L366">                .extracting(BatchPart::getSearchKey)</span>
<span class="nc" id="L367">                .containsExactlyInAnyOrder(</span>
                        &quot;Completed Part&quot;,
                        &quot;Not Completed Part&quot;
                );

<span class="nc" id="L372">        assertThat(managementService.createBatchPartQuery().completed().list())</span>
<span class="nc" id="L373">                .extracting(BatchPart::getSearchKey)</span>
<span class="nc" id="L374">                .isEmpty();</span>

<span class="nc" id="L376">        managementService.executeCommand(commandContext -&gt; {</span>
<span class="nc" id="L377">            CommandContextUtil.getBatchService(commandContext)</span>
<span class="nc" id="L378">                    .completeBatchPart(completedBatchPart.getId(), &quot;completed&quot;, &quot;{}&quot;);</span>
<span class="nc" id="L379">            return null;</span>
        });

<span class="nc" id="L382">        assertThat(managementService.createBatchPartQuery().completed().list())</span>
<span class="nc" id="L383">                .extracting(BatchPart::getSearchKey)</span>
<span class="nc" id="L384">                .containsExactlyInAnyOrder(</span>
                        &quot;Completed Part&quot;
                );
<span class="nc" id="L387">    }</span>

    @Test
    void queryBatches() {
<span class="nc" id="L391">        managementService.createBatchBuilder()</span>
<span class="nc" id="L392">                .batchType(&quot;testFlowable&quot;)</span>
<span class="nc" id="L393">                .searchKey(&quot;search 1&quot;)</span>
<span class="nc" id="L394">                .searchKey2(&quot;flowable search 1&quot;)</span>
<span class="nc" id="L395">                .status(&quot;start&quot;)</span>
<span class="nc" id="L396">                .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L397">                .create();</span>
<span class="nc" id="L398">        Batch acmeBatch = managementService.createBatchBuilder()</span>
<span class="nc" id="L399">                .batchType(&quot;testAcme&quot;)</span>
<span class="nc" id="L400">                .searchKey(&quot;search 1&quot;)</span>
<span class="nc" id="L401">                .searchKey2(&quot;acme search 1&quot;)</span>
<span class="nc" id="L402">                .status(&quot;start&quot;)</span>
<span class="nc" id="L403">                .tenantId(&quot;acme&quot;)</span>
<span class="nc" id="L404">                .create();</span>
<span class="nc" id="L405">        managementService.createBatchBuilder()</span>
<span class="nc" id="L406">                .batchType(&quot;testMuppets&quot;)</span>
<span class="nc" id="L407">                .searchKey(&quot;search 2&quot;)</span>
<span class="nc" id="L408">                .searchKey2(&quot;muppets search 1&quot;)</span>
<span class="nc" id="L409">                .status(&quot;start&quot;)</span>
<span class="nc" id="L410">                .tenantId(&quot;muppets&quot;)</span>
<span class="nc" id="L411">                .create();</span>

<span class="nc" id="L413">        assertThat(managementService.createBatchQuery().list())</span>
<span class="nc" id="L414">                .extracting(Batch::getBatchSearchKey2)</span>
<span class="nc" id="L415">                .containsExactlyInAnyOrder(</span>
                        &quot;flowable search 1&quot;,
                        &quot;acme search 1&quot;,
                        &quot;muppets search 1&quot;
                );
<span class="nc" id="L420">        assertThat(managementService.createBatchQuery().count()).isEqualTo(3);</span>

<span class="nc" id="L422">        assertThat(managementService.createBatchQuery().batchId(acmeBatch.getId()).list())</span>
<span class="nc" id="L423">                .extracting(Batch::getBatchSearchKey2)</span>
<span class="nc" id="L424">                .containsExactlyInAnyOrder(</span>
                        &quot;acme search 1&quot;
                );
<span class="nc" id="L427">        assertThat(managementService.createBatchQuery().batchId(acmeBatch.getId()).count()).isEqualTo(1);</span>

<span class="nc" id="L429">        assertThat(managementService.createBatchQuery().batchType(&quot;testFlowable&quot;).list())</span>
<span class="nc" id="L430">                .extracting(Batch::getBatchSearchKey2)</span>
<span class="nc" id="L431">                .containsExactlyInAnyOrder(</span>
                        &quot;flowable search 1&quot;
                );
<span class="nc" id="L434">        assertThat(managementService.createBatchQuery().batchType(&quot;testFlowable&quot;).count()).isEqualTo(1);</span>

<span class="nc" id="L436">        assertThat(managementService.createBatchQuery().batchType(&quot;unknown&quot;).list())</span>
<span class="nc" id="L437">                .extracting(Batch::getBatchSearchKey2)</span>
<span class="nc" id="L438">                .isEmpty();</span>
<span class="nc" id="L439">        assertThat(managementService.createBatchQuery().batchType(&quot;unknown&quot;).count()).isZero();</span>
        
<span class="nc" id="L441">        assertThat(managementService.createBatchQuery().batchTypes(Arrays.asList(&quot;testFlowable&quot;, &quot;unknown&quot;)).list())</span>
<span class="nc" id="L442">                .extracting(Batch::getBatchSearchKey2)</span>
<span class="nc" id="L443">                .containsExactlyInAnyOrder(</span>
                        &quot;flowable search 1&quot;
                );
<span class="nc" id="L446">        assertThat(managementService.createBatchQuery().batchTypes(Arrays.asList(&quot;testFlowable&quot;, &quot;unknown&quot;)).count()).isEqualTo(1);</span>
        
<span class="nc" id="L448">        assertThat(managementService.createBatchQuery().batchTypes(Arrays.asList(&quot;testFlowable&quot;, &quot;testAcme&quot;)).list())</span>
<span class="nc" id="L449">                .extracting(Batch::getBatchSearchKey2)</span>
<span class="nc" id="L450">                .containsExactlyInAnyOrder(</span>
                        &quot;flowable search 1&quot;,
                        &quot;acme search 1&quot;
                );
<span class="nc" id="L454">        assertThat(managementService.createBatchQuery().batchTypes(Arrays.asList(&quot;testFlowable&quot;, &quot;testAcme&quot;)).count()).isEqualTo(2);</span>
        
<span class="nc" id="L456">        assertThat(managementService.createBatchQuery().batchTypes(Arrays.asList(&quot;unknown1&quot;, &quot;unknown2&quot;)).list())</span>
<span class="nc" id="L457">                .extracting(Batch::getBatchSearchKey2)</span>
<span class="nc" id="L458">                .isEmpty();</span>
<span class="nc" id="L459">        assertThat(managementService.createBatchQuery().batchTypes(Arrays.asList(&quot;unknown1&quot;, &quot;unknown2&quot;)).count()).isZero();</span>
        
<span class="nc" id="L461">        assertThat(managementService.createBatchQuery().searchKey(&quot;search 1&quot;).list())</span>
<span class="nc" id="L462">                .extracting(Batch::getBatchSearchKey2)</span>
<span class="nc" id="L463">                .containsExactlyInAnyOrder(</span>
                        &quot;flowable search 1&quot;,
                        &quot;acme search 1&quot;
                );
<span class="nc" id="L467">        assertThat(managementService.createBatchQuery().searchKey(&quot;search 1&quot;).count()).isEqualTo(2);</span>

<span class="nc" id="L469">        assertThat(managementService.createBatchQuery().searchKey2(&quot;search 1&quot;).list()).isEmpty();</span>
<span class="nc" id="L470">        assertThat(managementService.createBatchQuery().searchKey2(&quot;search 1&quot;).count()).isZero();</span>

<span class="nc" id="L472">        assertThat(managementService.createBatchQuery().searchKey2(&quot;muppets search 1&quot;).list())</span>
<span class="nc" id="L473">                .extracting(Batch::getBatchSearchKey2)</span>
<span class="nc" id="L474">                .containsExactlyInAnyOrder(</span>
                        &quot;muppets search 1&quot;
                );
<span class="nc" id="L477">        assertThat(managementService.createBatchQuery().searchKey2(&quot;muppets search 1&quot;).count()).isEqualTo(1);</span>

<span class="nc" id="L479">        assertThat(managementService.createBatchQuery().status(&quot;start&quot;).list())</span>
<span class="nc" id="L480">                .extracting(Batch::getBatchSearchKey2)</span>
<span class="nc" id="L481">                .containsExactlyInAnyOrder(</span>
                        &quot;flowable search 1&quot;,
                        &quot;acme search 1&quot;,
                        &quot;muppets search 1&quot;
                );
<span class="nc" id="L486">        assertThat(managementService.createBatchQuery().status(&quot;start&quot;).count()).isEqualTo(3);</span>

<span class="nc" id="L488">        assertThat(managementService.createBatchQuery().status(&quot;unknown&quot;).list())</span>
<span class="nc" id="L489">                .extracting(Batch::getBatchSearchKey2)</span>
<span class="nc" id="L490">                .isEmpty();</span>
<span class="nc" id="L491">        assertThat(managementService.createBatchQuery().status(&quot;unknown&quot;).count()).isZero();</span>

<span class="nc" id="L493">        assertThat(managementService.createBatchQuery().tenantId(&quot;flowable&quot;).list())</span>
<span class="nc" id="L494">                .extracting(Batch::getBatchSearchKey2)</span>
<span class="nc" id="L495">                .containsExactlyInAnyOrder(</span>
                        &quot;flowable search 1&quot;
                );
<span class="nc" id="L498">        assertThat(managementService.createBatchQuery().tenantId(&quot;flowable&quot;).count()).isEqualTo(1);</span>

<span class="nc" id="L500">        assertThat(managementService.createBatchQuery().tenantId(&quot;unknown&quot;).list()).isEmpty();</span>
<span class="nc" id="L501">        assertThat(managementService.createBatchQuery().tenantId(&quot;unknown&quot;).count()).isZero();</span>

<span class="nc" id="L503">        assertThat(managementService.createBatchQuery().tenantIdLike(&quot;%a%&quot;).list())</span>
<span class="nc" id="L504">                .extracting(Batch::getBatchSearchKey2)</span>
<span class="nc" id="L505">                .containsExactlyInAnyOrder(</span>
                        &quot;flowable search 1&quot;,
                        &quot;acme search 1&quot;
                );
<span class="nc" id="L509">        assertThat(managementService.createBatchQuery().tenantIdLike(&quot;%a%&quot;).count()).isEqualTo(2);</span>

<span class="nc" id="L511">        assertThat(managementService.createBatchQuery().tenantIdLike(&quot;%acm%&quot;).list())</span>
<span class="nc" id="L512">                .extracting(Batch::getBatchSearchKey2)</span>
<span class="nc" id="L513">                .containsExactlyInAnyOrder(</span>
                        &quot;acme search 1&quot;
                );
<span class="nc" id="L516">        assertThat(managementService.createBatchQuery().tenantIdLike(&quot;%acm%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L517">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>