<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ActivityInstanceEntityManagerImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.impl.persistence.entity</a> &gt; <span class="el_source">ActivityInstanceEntityManagerImpl.java</span></div><h1>ActivityInstanceEntityManagerImpl.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.engine.impl.persistence.entity;

import static org.flowable.engine.impl.util.CommandContextUtil.getEntityCache;

import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Objects;

import org.apache.commons.lang3.StringUtils;
import org.flowable.bpmn.model.FlowElement;
import org.flowable.bpmn.model.FlowNode;
import org.flowable.bpmn.model.SequenceFlow;
import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.api.delegate.Expression;
import org.flowable.common.engine.impl.cfg.IdGenerator;
import org.flowable.engine.history.HistoricActivityInstance;
import org.flowable.engine.impl.ActivityInstanceQueryImpl;
import org.flowable.engine.impl.cfg.ProcessEngineConfigurationImpl;
import org.flowable.engine.impl.history.HistoryManager;
import org.flowable.engine.impl.persistence.entity.data.ActivityInstanceDataManager;
import org.flowable.engine.impl.util.CommandContextUtil;
import org.flowable.engine.runtime.ActivityInstance;
import org.flowable.task.service.impl.persistence.entity.TaskEntity;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * @author martin.grofcik
 */
public class ActivityInstanceEntityManagerImpl
    extends AbstractProcessEngineEntityManager&lt;ActivityInstanceEntity, ActivityInstanceDataManager&gt;
    implements ActivityInstanceEntityManager {

    protected static final String NO_ACTIVITY_ID_PREFIX = &quot;_flow_&quot;;
    protected static final String NO_ACTIVITY_ID_SEPARATOR = &quot;__&quot;;

<span class="nc" id="L51">    protected final Logger logger = LoggerFactory.getLogger(getClass());</span>
    protected final boolean usePrefixId;

    public ActivityInstanceEntityManagerImpl(ProcessEngineConfigurationImpl processEngineConfiguration, ActivityInstanceDataManager activityInstanceDataManager) {
<span class="nc" id="L55">        super(processEngineConfiguration, activityInstanceDataManager);</span>
<span class="nc" id="L56">        this.usePrefixId = processEngineConfiguration.isUsePrefixId();</span>
<span class="nc" id="L57">    }</span>

    protected List&lt;ActivityInstanceEntity&gt; findUnfinishedActivityInstancesByExecutionAndActivityId(String executionId, String activityId) {
<span class="nc" id="L60">        return dataManager.findUnfinishedActivityInstancesByExecutionAndActivityId(executionId, activityId);</span>
    }
    
    @Override
    public List&lt;ActivityInstanceEntity&gt; findActivityInstancesByExecutionAndActivityId(String executionId, String activityId) {
<span class="nc" id="L65">        return dataManager.findActivityInstancesByExecutionIdAndActivityId(executionId, activityId);</span>
    }
    
    @Override
    public List&lt;ActivityInstanceEntity&gt; findActivityInstancesByProcessInstanceId(String processInstanceId, boolean includeDeleted) {
<span class="nc" id="L70">        return dataManager.findActivityInstancesByProcessInstanceId(processInstanceId, includeDeleted);</span>
    }

    @Override
    public ActivityInstanceEntity findActivityInstanceByTaskId(String taskId) {
<span class="nc" id="L75">        return dataManager.findActivityInstanceByTaskId(taskId);</span>
    }

    @Override
    public void deleteActivityInstancesByProcessInstanceId(String processInstanceId) {
<span class="nc" id="L80">        dataManager.deleteActivityInstancesByProcessInstanceId(processInstanceId);</span>
<span class="nc" id="L81">    }</span>

    @Override
    public long findActivityInstanceCountByQueryCriteria(ActivityInstanceQueryImpl historicActivityInstanceQuery) {
<span class="nc" id="L85">        return dataManager.findActivityInstanceCountByQueryCriteria(historicActivityInstanceQuery);</span>
    }

    @Override
    public List&lt;ActivityInstance&gt; findActivityInstancesByQueryCriteria(ActivityInstanceQueryImpl historicActivityInstanceQuery) {
<span class="nc" id="L90">        return dataManager.findActivityInstancesByQueryCriteria(historicActivityInstanceQuery);</span>
    }

    @Override
    public List&lt;ActivityInstance&gt; findActivityInstancesByNativeQuery(Map&lt;String, Object&gt; parameterMap) {
<span class="nc" id="L95">        return dataManager.findActivityInstancesByNativeQuery(parameterMap);</span>
    }

    @Override
    public long findActivityInstanceCountByNativeQuery(Map&lt;String, Object&gt; parameterMap) {
<span class="nc" id="L100">        return dataManager.findActivityInstanceCountByNativeQuery(parameterMap);</span>
    }

    @Override
    public void recordActivityStart(ExecutionEntity executionEntity) {
<span class="nc" id="L105">        ActivityInstance activityInstance = recordRuntimeActivityStart(executionEntity);</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (activityInstance != null) {</span>
<span class="nc" id="L107">            getHistoryManager().recordActivityStart(activityInstance);</span>
        }
<span class="nc" id="L109">    }</span>

    @Override
    public void recordActivityEnd(ExecutionEntity executionEntity, String deleteReason) {
<span class="nc" id="L113">        ActivityInstance activityInstance = recordActivityInstanceEnd(executionEntity, deleteReason);</span>

        // If the activity instance is null, this means that no runtime activity instance nor historic activity instance exists.
        // In the DefaultHistoryManager implementation, the end is ignored (which it needs to be, this is for example when an execution
        // has reached a certain step, but hasn't gone into the behavior yet. When the execution is deleted, this method is called,
        // but no historic activity instance should be created for this use case).
        // However, in the async history manager, this leads to the creation of an activity-end history job.
        // To have this consistent, the recordActivityEnd is thus only called when there is a runtime activity available.

<span class="nc bnc" id="L122" title="All 2 branches missed.">        if (activityInstance != null) {</span>
<span class="nc" id="L123">            getHistoryManager().recordActivityEnd(activityInstance);</span>
        }
<span class="nc" id="L125">    }</span>

    @Override
    public void recordSequenceFlowTaken(ExecutionEntity executionEntity) {
<span class="nc" id="L129">        ActivityInstanceEntity activityInstance = createActivityInstanceEntity(executionEntity);</span>
<span class="nc" id="L130">        activityInstance.setDurationInMillis(0L);</span>
<span class="nc" id="L131">        activityInstance.setEndTime(activityInstance.getStartTime());</span>
<span class="nc" id="L132">        getHistoryManager().createHistoricActivityInstance(activityInstance);</span>
<span class="nc" id="L133">    }</span>

    @Override
    public void recordSubProcessInstanceStart(ExecutionEntity parentExecution, ExecutionEntity subProcessInstance) {
<span class="nc" id="L137">        ActivityInstanceEntity activityInstance = findUnfinishedActivityInstance(parentExecution);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">        if (activityInstance != null) {</span>
<span class="nc" id="L139">            activityInstance.setCalledProcessInstanceId(subProcessInstance.getProcessInstanceId());</span>
<span class="nc" id="L140">            getHistoryManager().updateHistoricActivityInstance(activityInstance);</span>
        }

<span class="nc" id="L143">        getHistoryManager().recordProcessInstanceStart(subProcessInstance);</span>
<span class="nc" id="L144">    }</span>

    @Override
    public void recordTaskCreated(TaskEntity task, ExecutionEntity execution) {
<span class="nc" id="L148">        recordActivityTaskCreated(task, execution);</span>
<span class="nc" id="L149">        getHistoryManager().recordTaskCreated(task, execution);</span>
<span class="nc" id="L150">    }</span>

    protected void recordActivityTaskCreated(TaskEntity task, ExecutionEntity execution) {
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (execution != null) {</span>
<span class="nc" id="L154">            ActivityInstanceEntity activityInstance = findUnfinishedActivityInstance(execution);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">            if (activityInstance != null) {</span>
<span class="nc" id="L156">                activityInstance.setTaskId(task.getId());</span>
<span class="nc" id="L157">                getHistoryManager().updateHistoricActivityInstance(activityInstance);</span>
            }
        }
<span class="nc" id="L160">    }</span>

    @Override
    public void recordTaskInfoChange(TaskEntity taskEntity, Date changeTime) {
<span class="nc" id="L164">        ActivityInstanceEntity activityInstanceEntity = recordActivityTaskInfoChange(taskEntity);</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        getHistoryManager().recordTaskInfoChange(taskEntity, activityInstanceEntity != null ? activityInstanceEntity.getId() : null, changeTime);</span>
<span class="nc" id="L166">    }</span>

    @Override
    public void syncUserTaskExecution(ExecutionEntity executionEntity, FlowElement newFlowElement, String oldActivityId, TaskEntity task) {
<span class="nc" id="L170">        syncUserTaskExecutionActivityInstance(executionEntity, oldActivityId, newFlowElement);</span>
<span class="nc" id="L171">        getHistoryManager().updateActivity(executionEntity, oldActivityId, newFlowElement, task, getClock().getCurrentTime());</span>
<span class="nc" id="L172">    }</span>

    @Override
    public void updateActivityInstancesProcessDefinitionId(String newProcessDefinitionId, String processInstanceId) {
<span class="nc" id="L176">        ActivityInstanceQueryImpl activityQuery = new ActivityInstanceQueryImpl();</span>
<span class="nc" id="L177">        activityQuery.processInstanceId(processInstanceId);</span>
<span class="nc" id="L178">        List&lt;ActivityInstance&gt; activities = findActivityInstancesByQueryCriteria(activityQuery);</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (activities != null) {</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">            for (ActivityInstance activityInstance : activities) {</span>
<span class="nc" id="L181">                ActivityInstanceEntity activityEntity = (ActivityInstanceEntity) activityInstance;</span>
<span class="nc" id="L182">                activityEntity.setProcessDefinitionId(newProcessDefinitionId);</span>
<span class="nc" id="L183">                update(activityEntity);</span>
<span class="nc" id="L184">            }</span>
        }
<span class="nc" id="L186">    }</span>

    protected void syncUserTaskExecutionActivityInstance(ExecutionEntity childExecution, String oldActivityId,
        FlowElement newFlowElement) {
<span class="nc" id="L190">        ActivityInstanceEntityManager activityInstanceEntityManager = CommandContextUtil.getActivityInstanceEntityManager();</span>
<span class="nc" id="L191">        List&lt;ActivityInstanceEntity&gt; activityInstances = activityInstanceEntityManager.findActivityInstancesByExecutionAndActivityId(childExecution.getId(), oldActivityId);</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">        for (ActivityInstanceEntity activityInstance : activityInstances) {</span>
<span class="nc" id="L193">            activityInstance.setProcessDefinitionId(childExecution.getProcessDefinitionId());</span>
<span class="nc" id="L194">            activityInstance.setActivityId(childExecution.getActivityId());</span>
<span class="nc" id="L195">            activityInstance.setActivityName(newFlowElement.getName());</span>
<span class="nc" id="L196">        }</span>
<span class="nc" id="L197">    }</span>

    protected ActivityInstanceEntity recordActivityTaskInfoChange(TaskEntity taskEntity) {
<span class="nc" id="L200">        ActivityInstanceEntity activityInstance = null;</span>
<span class="nc" id="L201">        ExecutionEntity executionEntity = getExecutionEntityManager().findById(taskEntity.getExecutionId());</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">        if (executionEntity != null) {</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">            if (!Objects.equals(getOriginalAssignee(taskEntity), taskEntity.getAssignee())) {</span>
<span class="nc" id="L204">                activityInstance = findActivityInstanceByTaskId(taskEntity.getId());</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">                if (activityInstance == null) {</span>
<span class="nc" id="L206">                    HistoricActivityInstanceEntity historicActivityInstance = getHistoryManager().findHistoricActivityInstance(executionEntity, true);</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">                    if (historicActivityInstance != null) {</span>
<span class="nc" id="L208">                        activityInstance = createActivityInstance(historicActivityInstance);</span>
                    }
                }
<span class="nc bnc" id="L211" title="All 2 branches missed.">                if (activityInstance != null) {</span>
<span class="nc" id="L212">                    activityInstance.setAssignee(taskEntity.getAssignee());</span>
<span class="nc" id="L213">                    getHistoryManager().updateHistoricActivityInstance(activityInstance);</span>
                }
            }
        }

<span class="nc" id="L218">        return activityInstance;</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    protected Object getOriginalAssignee(TaskEntity taskEntity) {
<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (taskEntity.getOriginalPersistentState() != null) {</span>
<span class="nc" id="L224">            return ((Map&lt;String, Object&gt;) taskEntity.getOriginalPersistentState()).get(&quot;assignee&quot;);</span>
        } else {
<span class="nc" id="L226">            return null;</span>
        }
    }

    protected ActivityInstance recordRuntimeActivityStart(ExecutionEntity executionEntity) {
<span class="nc" id="L231">        ActivityInstance activityInstance = null;</span>
<span class="nc bnc" id="L232" title="All 4 branches missed.">        if (executionEntity.getActivityId() != null &amp;&amp; executionEntity.getCurrentFlowElement() != null) {</span>
<span class="nc" id="L233">            activityInstance = findUnfinishedActivityInstance(executionEntity);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">            if (activityInstance == null) {</span>
<span class="nc" id="L235">                return createActivityInstance(executionEntity);</span>
            }
        }

<span class="nc" id="L239">        return null;</span>
    }

    protected ActivityInstance createActivityInstance(ExecutionEntity executionEntity) {
<span class="nc" id="L243">        ActivityInstance activityInstance = null;</span>
<span class="nc bnc" id="L244" title="All 4 branches missed.">        if (executionEntity.getActivityId() != null &amp;&amp; executionEntity.getCurrentFlowElement() != null) {</span>

            // activity instance could have been created (but only in cache, never persisted)
            // for example when submitting form properties
<span class="nc" id="L248">            activityInstance = getActivityInstanceFromCache(executionEntity.getId(), executionEntity.getActivityId(), true);</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">            if (activityInstance  == null) {</span>
<span class="nc" id="L250">                activityInstance = createActivityInstanceEntity(executionEntity);</span>
            } else {
                // activityInstance is not null only on its creation time
<span class="nc" id="L253">                activityInstance = null;</span>
            }
        }
<span class="nc" id="L256">        return activityInstance;</span>
    }

    protected ActivityInstance recordActivityInstanceEnd(ExecutionEntity executionEntity, String deleteReason) {

        // It is possible that we record the activity instance end twice,
        // which could lead to having no finished activity instance in the DB.
        // if there is a finished runtime one, we should use the runtime one.
        //
        // It is also OK for pre 6.4.1.2 activity instances (when the runtime activities were added).
        // Since the first time we go through here we won't find anything in the cache and the DB,
        // so we will create one from the history (this will add one to the cache).
        //
        // The second time we go through here, there will be nothing in the DB, but one finished one in the cache.
        // This one should be used, in order to avoid going to the historic tables again.

<span class="nc" id="L272">        ActivityInstanceEntity activityInstance = findUnfinishedActivityInstance(executionEntity, true);</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">        if (activityInstance != null) {</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">            if (activityInstance.getEndTime() == null) {</span>
<span class="nc" id="L275">                activityInstance.markEnded(deleteReason);</span>
            }

        } else {
            // in the case of upgrade from 6.4.1.1 to 6.4.1.2 we have to create the runtime activityInstance (when a matching historicActivityInstance is found)
<span class="nc" id="L280">            HistoricActivityInstanceEntity historicActivityInstance = getHistoryManager().findHistoricActivityInstance(executionEntity, true);</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">            if (historicActivityInstance != null) {</span>
<span class="nc" id="L282">                activityInstance = createActivityInstance(historicActivityInstance);</span>
<span class="nc" id="L283">                activityInstance.markEnded(deleteReason);</span>
            }

        }

<span class="nc" id="L288">        return activityInstance;</span>
    }

    @Override
    public ActivityInstanceEntity findUnfinishedActivityInstance(ExecutionEntity execution) {
<span class="nc" id="L293">        return findUnfinishedActivityInstance(execution, false);</span>
    }

    protected ActivityInstanceEntity findUnfinishedActivityInstance(ExecutionEntity execution, boolean returnNotFinishedFromCacheIfNothingInDb) {
<span class="nc" id="L297">        String activityId = getActivityIdForExecution(execution);</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">        if (activityId != null) {</span>
            // No use looking for the ActivityInstance when no activityId is provided.

<span class="nc" id="L301">            String executionId = execution.getId();</span>

            // Check the cache
<span class="nc" id="L304">            ActivityInstanceEntity activityInstanceFromCache = getActivityInstanceFromCache(executionId, activityId, true);</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">            if (activityInstanceFromCache != null) {</span>
<span class="nc" id="L306">                return activityInstanceFromCache;</span>
            }

            // If the execution was freshly created, there is no need to check the database,
            // there can never be an entry for a activity instance with this execution id.
<span class="nc bnc" id="L311" title="All 4 branches missed.">            if (!execution.isInserted() &amp;&amp; !execution.isProcessInstanceType()) {</span>

                // Check the database
<span class="nc" id="L314">                List&lt;ActivityInstanceEntity&gt; activityInstances = findUnfinishedActivityInstancesByExecutionAndActivityId(executionId, activityId);</span>
                // cache can be updated before DB
<span class="nc" id="L316">                ActivityInstanceEntity activityFromCache = getActivityInstanceFromCache(executionId, activityId, false);</span>
<span class="nc bnc" id="L317" title="All 4 branches missed.">                if (activityFromCache != null &amp;&amp; activityFromCache.getEndTime() != null) {</span>
<span class="nc" id="L318">                    activityInstances.remove(activityFromCache);</span>
                }
<span class="nc bnc" id="L320" title="All 2 branches missed.">                if (activityInstances.size() &gt; 0) {</span>
<span class="nc" id="L321">                    return activityInstances.get(0);</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">                } else if (returnNotFinishedFromCacheIfNothingInDb) {</span>
<span class="nc" id="L323">                    return activityFromCache;</span>
                }

            }
        }

<span class="nc" id="L329">        return null;</span>
    }

    protected ActivityInstanceEntity createActivityInstanceEntity(ExecutionEntity execution) {
<span class="nc" id="L333">        IdGenerator idGenerator = engineConfiguration.getIdGenerator();</span>

<span class="nc" id="L335">        String processDefinitionId = execution.getProcessDefinitionId();</span>
<span class="nc" id="L336">        String processInstanceId = execution.getProcessInstanceId();</span>

<span class="nc" id="L338">        ActivityInstanceEntity activityInstanceEntity = create();</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">        if (usePrefixId) {</span>
<span class="nc" id="L340">            activityInstanceEntity.setId(activityInstanceEntity.getIdPrefix() + idGenerator.getNextId());</span>
        } else {
<span class="nc" id="L342">            activityInstanceEntity.setId(idGenerator.getNextId());</span>
        }

<span class="nc" id="L345">        activityInstanceEntity.setProcessDefinitionId(processDefinitionId);</span>
<span class="nc" id="L346">        activityInstanceEntity.setProcessInstanceId(processInstanceId);</span>
<span class="nc" id="L347">        activityInstanceEntity.setExecutionId(execution.getId());</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">        if (execution.getActivityId() != null ) {</span>
<span class="nc" id="L349">            activityInstanceEntity.setActivityId(execution.getActivityId());</span>
        } else {
            // sequence flow activity id can be null
<span class="nc bnc" id="L352" title="All 2 branches missed.">            if (execution.getCurrentFlowElement() instanceof SequenceFlow) {</span>
<span class="nc" id="L353">                SequenceFlow currentFlowElement = (SequenceFlow) execution.getCurrentFlowElement();</span>
<span class="nc" id="L354">                activityInstanceEntity.setActivityId(getArtificialSequenceFlowId(currentFlowElement));</span>
            }
        }

<span class="nc bnc" id="L358" title="All 2 branches missed.">        if (execution.getCurrentFlowElement() != null) {</span>
<span class="nc" id="L359">            String currentFlowName = execution.getCurrentFlowElement().getName();</span>
<span class="nc bnc" id="L360" title="All 6 branches missed.">            if (StringUtils.isNotEmpty(currentFlowName) &amp;&amp; (currentFlowName.contains(&quot;${&quot;) || currentFlowName.contains(&quot;#{&quot;))) {</span>
<span class="nc" id="L361">                Expression activityNameExpression = CommandContextUtil.getProcessEngineConfiguration().getExpressionManager()</span>
<span class="nc" id="L362">                        .createExpression(currentFlowName);</span>

<span class="nc" id="L364">                String nameValue = null;</span>
                try {
<span class="nc" id="L366">                    Object expressionValue = activityNameExpression.getValue(execution);</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">                    if (expressionValue != null) {</span>
<span class="nc" id="L368">                        nameValue = expressionValue.toString();</span>
                    }
<span class="nc" id="L370">                } catch (FlowableException e) {</span>
<span class="nc" id="L371">                    nameValue = currentFlowName;</span>
<span class="nc" id="L372">                    logger.warn(&quot;property not found in task name expression {} for execution {}&quot;, e.getMessage(), execution);</span>
<span class="nc" id="L373">                }</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">                if (nameValue != null) {</span>
<span class="nc" id="L375">                    execution.setCurrentActivityName(nameValue);</span>
<span class="nc" id="L376">                    activityInstanceEntity.setActivityName(nameValue);</span>
                }
<span class="nc" id="L378">            } else {</span>
<span class="nc" id="L379">                activityInstanceEntity.setActivityName(currentFlowName);</span>
            }

<span class="nc" id="L382">            activityInstanceEntity.setActivityType(parseActivityType(execution.getCurrentFlowElement()));</span>
        }

<span class="nc" id="L385">        Date now = getClock().getCurrentTime();</span>
<span class="nc" id="L386">        activityInstanceEntity.setStartTime(now);</span>
        
<span class="nc" id="L388">        activityInstanceEntity.setTransactionOrder(getTransactionOrderFromCache(processInstanceId));</span>

<span class="nc bnc" id="L390" title="All 2 branches missed.">        if (execution.getTenantId() != null) {</span>
<span class="nc" id="L391">            activityInstanceEntity.setTenantId(execution.getTenantId());</span>
        }

<span class="nc" id="L394">        insert(activityInstanceEntity);</span>
<span class="nc" id="L395">        return activityInstanceEntity;</span>
    }

    protected ActivityInstanceEntity getActivityInstanceFromCache(String executionId, String activityId, boolean endTimeMustBeNull) {
<span class="nc" id="L399">        List&lt;ActivityInstanceEntity&gt; cachedActivityInstances = getEntityCache().findInCache(ActivityInstanceEntity.class);</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">        for (ActivityInstanceEntity cachedActivityInstance : cachedActivityInstances) {</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">            if (activityId != null</span>
<span class="nc bnc" id="L402" title="All 4 branches missed.">                &amp;&amp; activityId.equals(cachedActivityInstance.getActivityId())</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">                &amp;&amp; (!endTimeMustBeNull || cachedActivityInstance.getEndTime() == null)) {</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">                if (executionId.equals(cachedActivityInstance.getExecutionId())) {</span>
<span class="nc" id="L405">                    return cachedActivityInstance;</span>
                }
            }
<span class="nc" id="L408">        }</span>

<span class="nc" id="L410">        return null;</span>
    }
    
    protected int getTransactionOrderFromCache(String processInstanceId) {
<span class="nc" id="L414">        int transactionOrder = 1;</span>
<span class="nc" id="L415">        List&lt;ActivityInstanceEntity&gt; cachedActivityInstances = getEntityCache().findInCache(ActivityInstanceEntity.class);</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">        for (ActivityInstanceEntity cachedActivityInstance : cachedActivityInstances) {</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">            if (processInstanceId.equals(cachedActivityInstance.getProcessInstanceId())) {</span>
                
<span class="nc bnc" id="L419" title="All 4 branches missed.">                if (cachedActivityInstance.isInserted() &amp;&amp; cachedActivityInstance.getTransactionOrder() != null &amp;&amp; </span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">                        cachedActivityInstance.getTransactionOrder() &gt;= transactionOrder) {</span>
                    
<span class="nc" id="L422">                    transactionOrder = cachedActivityInstance.getTransactionOrder() + 1;</span>
                }
            }
<span class="nc" id="L425">        }</span>

<span class="nc" id="L427">        return transactionOrder;</span>
    }

    protected String parseActivityType(FlowElement element) {
<span class="nc" id="L431">        String elementType = element.getClass().getSimpleName();</span>
<span class="nc" id="L432">        elementType = elementType.substring(0, 1).toLowerCase() + elementType.substring(1);</span>
<span class="nc" id="L433">        return elementType;</span>
    }

    protected String getActivityIdForExecution(ExecutionEntity execution) {
<span class="nc" id="L437">        String activityId = null;</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">        if (execution.getCurrentFlowElement() instanceof FlowNode) {</span>
<span class="nc" id="L439">            activityId = execution.getCurrentFlowElement().getId();</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">        } else if (execution.getCurrentFlowElement() instanceof SequenceFlow</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">            &amp;&amp; execution.getCurrentFlowableListener() == null) { // while executing sequence flow listeners, we don't want historic activities</span>
<span class="nc" id="L442">            activityId = ((SequenceFlow) execution.getCurrentFlowElement()).getSourceFlowElement().getId();</span>
        }
<span class="nc" id="L444">        return activityId;</span>
    }

    protected ActivityInstanceEntity createActivityInstance(HistoricActivityInstance historicActivityInstance) {
<span class="nc" id="L448">        ActivityInstanceEntity activityInstanceEntity = create();</span>
<span class="nc" id="L449">        activityInstanceEntity.setId(historicActivityInstance.getId());</span>

<span class="nc" id="L451">        activityInstanceEntity.setProcessDefinitionId(historicActivityInstance.getProcessDefinitionId());</span>
<span class="nc" id="L452">        activityInstanceEntity.setProcessInstanceId(historicActivityInstance.getProcessInstanceId());</span>
<span class="nc" id="L453">        activityInstanceEntity.setCalledProcessInstanceId(historicActivityInstance.getCalledProcessInstanceId());</span>
<span class="nc" id="L454">        activityInstanceEntity.setExecutionId(historicActivityInstance.getExecutionId());</span>
<span class="nc" id="L455">        activityInstanceEntity.setTaskId(historicActivityInstance.getTaskId());</span>
<span class="nc" id="L456">        activityInstanceEntity.setActivityId(historicActivityInstance.getActivityId());</span>
<span class="nc" id="L457">        activityInstanceEntity.setActivityName(historicActivityInstance.getActivityName());</span>
<span class="nc" id="L458">        activityInstanceEntity.setActivityType(historicActivityInstance.getActivityType());</span>
<span class="nc" id="L459">        activityInstanceEntity.setAssignee(historicActivityInstance.getAssignee());</span>
<span class="nc" id="L460">        activityInstanceEntity.setStartTime(historicActivityInstance.getStartTime());</span>
<span class="nc" id="L461">        activityInstanceEntity.setEndTime(historicActivityInstance.getEndTime());</span>
<span class="nc" id="L462">        activityInstanceEntity.setTransactionOrder(historicActivityInstance.getTransactionOrder());</span>
<span class="nc" id="L463">        activityInstanceEntity.setDeleteReason(historicActivityInstance.getDeleteReason());</span>
<span class="nc" id="L464">        activityInstanceEntity.setDurationInMillis(historicActivityInstance.getDurationInMillis());</span>
<span class="nc" id="L465">        activityInstanceEntity.setTenantId(historicActivityInstance.getTenantId());</span>

<span class="nc" id="L467">        insert(activityInstanceEntity);</span>
<span class="nc" id="L468">        return activityInstanceEntity;</span>
    }

    protected String getArtificialSequenceFlowId(SequenceFlow sequenceFlow) {
<span class="nc" id="L472">        return NO_ACTIVITY_ID_PREFIX + sequenceFlow.getSourceRef() + NO_ACTIVITY_ID_SEPARATOR + sequenceFlow.getTargetRef();</span>
    }

    protected HistoryManager getHistoryManager() {
<span class="nc" id="L476">        return engineConfiguration.getHistoryManager();</span>
    }

    protected ExecutionEntityManager getExecutionEntityManager() {
<span class="nc" id="L480">        return engineConfiguration.getExecutionEntityManager();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>