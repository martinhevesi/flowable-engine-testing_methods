<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CaseInstanceMigrationTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.cmmn.test.migration</a> &gt; <span class="el_source">CaseInstanceMigrationTest.java</span></div><h1>CaseInstanceMigrationTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.cmmn.test.migration;

import static net.javacrumbs.jsonunit.assertj.JsonAssertions.assertThatJson;
import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.flowable.cmmn.converter.CmmnXmlConstants.ELEMENT_STAGE;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.stream.Collectors;

import org.assertj.core.groups.Tuple;
import org.flowable.cmmn.api.history.HistoricMilestoneInstance;
import org.flowable.cmmn.api.history.HistoricPlanItemInstance;
import org.flowable.cmmn.api.migration.ActivatePlanItemDefinitionMapping;
import org.flowable.cmmn.api.migration.CaseInstanceMigrationDocument;
import org.flowable.cmmn.api.migration.ChangePlanItemDefinitionWithNewTargetIdsMapping;
import org.flowable.cmmn.api.migration.ChangePlanItemIdMapping;
import org.flowable.cmmn.api.migration.ChangePlanItemIdWithDefinitionIdMapping;
import org.flowable.cmmn.api.migration.PlanItemDefinitionMappingBuilder;
import org.flowable.cmmn.api.migration.TerminatePlanItemDefinitionMapping;
import org.flowable.cmmn.api.repository.CaseDefinition;
import org.flowable.cmmn.api.repository.CmmnDeployment;
import org.flowable.cmmn.api.runtime.CaseInstance;
import org.flowable.cmmn.api.runtime.MilestoneInstance;
import org.flowable.cmmn.api.runtime.PlanItemInstance;
import org.flowable.cmmn.api.runtime.PlanItemInstanceState;
import org.flowable.cmmn.api.runtime.UserEventListenerInstance;
import org.flowable.cmmn.engine.impl.migration.CaseInstanceMigrationDocumentConverter;
import org.flowable.cmmn.engine.impl.persistence.entity.SentryPartInstanceEntity;
import org.flowable.cmmn.engine.test.impl.CmmnHistoryTestHelper;
import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.impl.DefaultTenantProvider;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.common.engine.impl.interceptor.Command;
import org.flowable.common.engine.impl.interceptor.CommandContext;
import org.flowable.eventsubscription.api.EventSubscription;
import org.flowable.task.api.Task;
import org.flowable.task.api.history.HistoricTaskInstance;
import org.junit.jupiter.api.Test;

/**
 * @author Valentin Zickner
 */
<span class="nc" id="L60">public class CaseInstanceMigrationTest extends AbstractCaseMigrationTest {</span>

    @Test
    void withSimpleOneTaskCase() {
        // Arrange
<span class="nc" id="L65">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>
<span class="nc" id="L66">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L67">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/two-task.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L70">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L71">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L72">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask2&quot;))</span>
<span class="nc" id="L73">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L76">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L77">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L78">                .singleResult();</span>
<span class="nc" id="L79">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L80">        assertThat(caseInstanceAfterMigration.getCaseDefinitionKey()).isEqualTo(&quot;testCase&quot;);</span>
<span class="nc" id="L81">        assertThat(caseInstanceAfterMigration.getCaseDefinitionName()).isEqualTo(&quot;Two Task Test Case&quot;);</span>
<span class="nc" id="L82">        assertThat(caseInstanceAfterMigration.getCaseDefinitionVersion()).isEqualTo(2);</span>
<span class="nc" id="L83">        assertThat(caseInstanceAfterMigration.getCaseDefinitionDeploymentId()).isEqualTo(destinationDefinition.getDeploymentId());</span>
<span class="nc" id="L84">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L85">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L86">                .list();</span>
<span class="nc" id="L87">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L88">        assertThat(planItemInstances)</span>
<span class="nc" id="L89">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L90">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L91">        assertThat(planItemInstances)</span>
<span class="nc" id="L92">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L93">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;);</span>
<span class="nc" id="L94">        assertThat(planItemInstances)</span>
<span class="nc" id="L95">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L96">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L98">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L99">        assertThat(tasks).hasSize(2);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">        for (Task task : tasks) {</span>
<span class="nc" id="L101">            assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L102">            cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L103">        }</span>
        
<span class="nc" id="L105">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L108">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L109">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L110">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L112">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L113">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L114">            assertThat(historicPlanItemInstances).hasSize(2);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L116">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L117">            }</span>

<span class="nc" id="L119">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L120">            assertThat(historicTasks).hasSize(2);</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L122">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L123">            }</span>
        }
<span class="nc" id="L125">    }</span>
    
    @Test
    void withNoChanges() {
        // Arrange
<span class="nc" id="L130">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>
<span class="nc" id="L131">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L132">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L135">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L136">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L137">                .migrateCaseInstances(&quot;testCase&quot;, 1, &quot;&quot;);</span>

        // Assert
<span class="nc" id="L140">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L141">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L142">                .singleResult();</span>
<span class="nc" id="L143">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L144">        assertThat(caseInstanceAfterMigration.getCaseDefinitionKey()).isEqualTo(&quot;testCase&quot;);</span>
<span class="nc" id="L145">        assertThat(caseInstanceAfterMigration.getCaseDefinitionName()).isEqualTo(&quot;One Task Test Case&quot;);</span>
<span class="nc" id="L146">        assertThat(caseInstanceAfterMigration.getCaseDefinitionVersion()).isEqualTo(2);</span>
<span class="nc" id="L147">        assertThat(caseInstanceAfterMigration.getCaseDefinitionDeploymentId()).isEqualTo(destinationDefinition.getDeploymentId());</span>
<span class="nc" id="L148">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L149">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L150">                .list();</span>
<span class="nc" id="L151">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L152">        assertThat(planItemInstances)</span>
<span class="nc" id="L153">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L154">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L155">        assertThat(planItemInstances)</span>
<span class="nc" id="L156">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L157">                .containsExactly(&quot;Task 1&quot;);</span>
<span class="nc" id="L158">        assertThat(planItemInstances)</span>
<span class="nc" id="L159">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L160">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L162">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L163">        assertThat(tasks).hasSize(1);</span>
<span class="nc" id="L164">        Task task = tasks.get(0);</span>
<span class="nc" id="L165">        assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L166">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L168">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L171">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L172">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L173">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L175">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L176">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L177">            assertThat(historicPlanItemInstances).hasSize(1);</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L179">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L180">            }</span>

<span class="nc" id="L182">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L183">            assertThat(historicTasks).hasSize(1);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L185">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L186">            }</span>
        }
<span class="nc" id="L188">    }</span>

    @Test
    void withSimpleOneTaskCaseWithMappingToSecondNewTask() {
        // Arrange
<span class="nc" id="L193">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>
<span class="nc" id="L194">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L195">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/two-task.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L198">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L199">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L200">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask2&quot;))</span>
<span class="nc" id="L201">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;humanTask1&quot;))</span>
<span class="nc" id="L202">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L205">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L206">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L207">                .singleResult();</span>
<span class="nc" id="L208">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L209">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L210">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L211">                .includeEnded()</span>
<span class="nc" id="L212">                .list();</span>
<span class="nc" id="L213">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L214">        assertThat(planItemInstances)</span>
<span class="nc" id="L215">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L216">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L217">        assertThat(planItemInstances)</span>
<span class="nc" id="L218">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L219">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;);</span>
<span class="nc" id="L220">        assertThat(planItemInstances)</span>
<span class="nc" id="L221">                .filteredOn(&quot;name&quot;, &quot;Task 2&quot;)</span>
<span class="nc" id="L222">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L223">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L225">        assertThat(planItemInstances)</span>
<span class="nc" id="L226">                .filteredOn(&quot;name&quot;, &quot;Task 1&quot;)</span>
<span class="nc" id="L227">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L228">                .containsOnly(PlanItemInstanceState.TERMINATED);</span>
        
<span class="nc" id="L230">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L231">        cmmnTaskService.complete(task.getId());</span>
    
<span class="nc" id="L233">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L235" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L236">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L237">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L238">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L240">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L241">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L242">            assertThat(historicPlanItemInstances).hasSize(2);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L244">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L245">            }</span>

<span class="nc" id="L247">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L248">            assertThat(historicTasks).hasSize(2);</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L250">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L251">            }</span>
        }
<span class="nc" id="L253">    }</span>

    @Test
    void withSimpleOneTaskCaseIntroducingNewTaskWithSentry() {
        // Arrange
<span class="nc" id="L258">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>
<span class="nc" id="L259">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L260">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/second-task-with-sentry.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L263">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L264">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L265">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask2&quot;))</span>
<span class="nc" id="L266">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L269">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L270">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L271">                .singleResult();</span>
<span class="nc" id="L272">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L273">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L274">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L275">                .list();</span>
<span class="nc" id="L276">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L277">        assertThat(planItemInstances)</span>
<span class="nc" id="L278">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L279">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L280">        assertThat(planItemInstances)</span>
<span class="nc" id="L281">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L282">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;);</span>
<span class="nc" id="L283">        assertThat(planItemInstances)</span>
<span class="nc" id="L284">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L285">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L287">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L288">        assertThat(tasks).hasSize(2);</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">        for (Task task : tasks) {</span>
<span class="nc" id="L290">            assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L291">            cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L292">        }</span>
    
<span class="nc" id="L294">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L296" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L297">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L298">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L299">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L301">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L302">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L303">            assertThat(historicPlanItemInstances).hasSize(2);</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L305">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L306">            }</span>

<span class="nc" id="L308">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L309">            assertThat(historicTasks).hasSize(2);</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L311">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L312">            }</span>
        }
<span class="nc" id="L314">    }</span>

    @Test
    void withSimpleOneTaskCaseIntroducingNewTaskWithSentryLinkedToFirstTask() {
        // Arrange
<span class="nc" id="L319">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>
<span class="nc" id="L320">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L321">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/second-task-linked-with-sentry.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L324">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L325">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L326">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;humanTask2&quot;))</span>
<span class="nc" id="L327">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L330">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L331">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L332">                .singleResult();</span>
<span class="nc" id="L333">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L334">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L335">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L336">                .list();</span>
<span class="nc" id="L337">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L338">        Map&lt;String, List&lt;PlanItemInstance&gt;&gt; planItemsByElementId = planItemInstances.stream()</span>
<span class="nc" id="L339">                .collect(Collectors.groupingBy(PlanItemInstance::getElementId));</span>
<span class="nc" id="L340">        PlanItemInstance planItem1 = planItemsByElementId.get(&quot;planItem1&quot;).get(0);</span>
<span class="nc" id="L341">        assertThat(planItem1.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L342">        assertThat(planItem1.getName()).isEqualTo(&quot;Task 1&quot;);</span>
<span class="nc" id="L343">        assertThat(planItem1.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L344">        PlanItemInstance planItem2 = planItemsByElementId.get(&quot;planItem2&quot;).get(0);</span>
<span class="nc" id="L345">        assertThat(planItem2.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L346">        assertThat(planItem2.getName()).isEqualTo(&quot;Task 2&quot;);</span>
<span class="nc" id="L347">        assertThat(planItem2.getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
        
<span class="nc" id="L349">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L350">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;humanTask1&quot;);</span>
<span class="nc" id="L351">        assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L352">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L354">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L355">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;humanTask2&quot;);</span>
<span class="nc" id="L356">        assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L357">        cmmnTaskService.complete(task.getId());</span>
    
<span class="nc" id="L359">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L361" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L362">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L363">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L364">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L366">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L367">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L368">            assertThat(historicPlanItemInstances).hasSize(2);</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L370">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L371">            }</span>

<span class="nc" id="L373">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L374">            assertThat(historicTasks).hasSize(2);</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L376">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L377">            }</span>
        }
<span class="nc" id="L379">    }</span>

    @Test
    void withTwoTasksIntroducingANewStageAroundSecondTask() {
        // Arrange
<span class="nc" id="L384">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/second-task-linked-with-sentry.cmmn.xml&quot;);</span>
<span class="nc" id="L385">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L386">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-linked-with-sentry.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L389">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L390">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L391">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;humanTask2&quot;))</span>
<span class="nc" id="L392">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;expandedStage1&quot;))</span>
<span class="nc" id="L393">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;humanTask2&quot;))</span>
<span class="nc" id="L394">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L397">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L398">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L399">                .singleResult();</span>
<span class="nc" id="L400">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L401">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L402">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L403">                .list();</span>
<span class="nc" id="L404">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L405">        Map&lt;String, List&lt;PlanItemInstance&gt;&gt; planItemsByElementId = planItemInstances.stream()</span>
<span class="nc" id="L406">                .collect(Collectors.groupingBy(PlanItemInstance::getElementId));</span>
<span class="nc" id="L407">        PlanItemInstance planItem1 = planItemsByElementId.get(&quot;planItem1&quot;).get(0);</span>
<span class="nc" id="L408">        assertThat(planItem1.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L409">        assertThat(planItem1.getName()).isEqualTo(&quot;Task 1&quot;);</span>
<span class="nc" id="L410">        assertThat(planItem1.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L411">        PlanItemInstance planItem2 = planItemsByElementId.get(&quot;planItem2&quot;).get(0);</span>
<span class="nc" id="L412">        assertThat(planItem2.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L413">        assertThat(planItem2.getName()).isEqualTo(&quot;Task 2&quot;);</span>
<span class="nc" id="L414">        assertThat(planItem2.getStageInstanceId()).isNotNull();</span>
<span class="nc" id="L415">        assertThat(planItem2.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L416">        PlanItemInstance planItem3 = planItemsByElementId.get(&quot;planItem3&quot;).get(0);</span>
<span class="nc" id="L417">        assertThat(planItem3.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L418">        assertThat(planItem3.getPlanItemDefinitionId()).isEqualTo(&quot;expandedStage1&quot;);</span>
<span class="nc" id="L419">        assertThat(planItem3.getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
        
<span class="nc" id="L421">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask1&quot;).singleResult();</span>
<span class="nc" id="L422">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;humanTask1&quot;);</span>
<span class="nc" id="L423">        assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L424">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L426">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask2&quot;).singleResult();</span>
<span class="nc" id="L427">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;humanTask2&quot;);</span>
<span class="nc" id="L428">        assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L429">        cmmnTaskService.complete(task.getId());</span>
    
<span class="nc" id="L431">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L433" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L434">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L435">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L436">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L438">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L439">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L440">            assertThat(historicPlanItemInstances).hasSize(4);</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L442">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L443">            }</span>

<span class="nc" id="L445">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L446">            assertThat(historicTasks).hasSize(2);</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L448">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L449">            }</span>
        }
<span class="nc" id="L451">    }</span>

    @Test
    void withTwoTasksIntroducingANewStageAroundSecondTaskAndSecondTaskActive() {
        // Arrange
<span class="nc" id="L456">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/second-task-linked-with-sentry.cmmn.xml&quot;);</span>
<span class="nc" id="L457">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L458">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-linked-with-sentry.cmmn.xml&quot;);</span>
<span class="nc" id="L459">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L460">        assertThat(task).isNotNull();</span>
<span class="nc" id="L461">        cmmnTaskService.complete(task.getId());</span>

        // Act
<span class="nc" id="L464">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L465">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L466">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;humanTask2&quot;))</span>
<span class="nc" id="L467">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;expandedStage1&quot;))</span>
<span class="nc" id="L468">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L471">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L472">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L473">                .singleResult();</span>
<span class="nc" id="L474">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L475">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L476">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L477">                .list();</span>
<span class="nc" id="L478">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L479">        Map&lt;String, List&lt;PlanItemInstance&gt;&gt; planItemsByElementId = planItemInstances.stream()</span>
<span class="nc" id="L480">                .collect(Collectors.groupingBy(PlanItemInstance::getElementId));</span>
<span class="nc" id="L481">        PlanItemInstance planItem2 = planItemsByElementId.get(&quot;planItem2&quot;).get(0);</span>
<span class="nc" id="L482">        assertThat(planItem2.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L483">        assertThat(planItem2.getName()).isEqualTo(&quot;Task 2&quot;);</span>
<span class="nc" id="L484">        assertThat(planItem2.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L485">        PlanItemInstance planItem3 = planItemsByElementId.get(&quot;planItem3&quot;).get(0);</span>
<span class="nc" id="L486">        assertThat(planItem3.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L487">        assertThat(planItem3.getPlanItemDefinitionId()).isEqualTo(&quot;expandedStage1&quot;);</span>
<span class="nc" id="L488">        assertThat(planItem3.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L489">    }</span>

    @Test
    void withSimpleOneTaskCaseIntroducingNewTaskWithConditionalSentryNotActivated() {
        // Arrange
<span class="nc" id="L494">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>
<span class="nc" id="L495">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L496">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/second-task-with-conditional-sentry.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L499">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L500">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L501">                .withCaseInstanceVariable(&quot;activate&quot;, false)</span>
<span class="nc" id="L502">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;humanTask2&quot;))</span>
<span class="nc" id="L503">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L506">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L507">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L508">                .singleResult();</span>
<span class="nc" id="L509">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L510">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L511">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L512">                .list();</span>
<span class="nc" id="L513">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L514">        Map&lt;String, List&lt;PlanItemInstance&gt;&gt; planItemsByElementId = planItemInstances.stream()</span>
<span class="nc" id="L515">                .collect(Collectors.groupingBy(PlanItemInstance::getElementId));</span>
<span class="nc" id="L516">        PlanItemInstance planItem1 = planItemsByElementId.get(&quot;planItem1&quot;).get(0);</span>
<span class="nc" id="L517">        assertThat(planItem1.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L518">        assertThat(planItem1.getName()).isEqualTo(&quot;Task 1&quot;);</span>
<span class="nc" id="L519">        assertThat(planItem1.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L520">        PlanItemInstance planItem2 = planItemsByElementId.get(&quot;planItem2&quot;).get(0);</span>
<span class="nc" id="L521">        assertThat(planItem2.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L522">        assertThat(planItem2.getName()).isEqualTo(&quot;Task 2&quot;);</span>
<span class="nc" id="L523">        assertThat(planItem2.getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L524">    }</span>

    @Test
    void withConditionalMoveToAvailableOnTwoTaskProcessWithSentryAndTaskIsActive() {
        // Arrange
<span class="nc" id="L529">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/second-task-linked-with-sentry.cmmn.xml&quot;);</span>
<span class="nc" id="L530">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L531">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L532">        assertThat(task).isNotNull();</span>
<span class="nc" id="L533">        cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L535">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/second-task-linked-with-sentry.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L538">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L539">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L540">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;humanTask2&quot;, &quot;${false}&quot;))</span>
<span class="nc" id="L541">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L544">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L545">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L546">                .singleResult();</span>
<span class="nc" id="L547">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L548">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L549">                .list();</span>
<span class="nc" id="L550">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L551">        assertThat(planItemInstances)</span>
<span class="nc" id="L552">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L553">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L554">        assertThat(planItemInstances)</span>
<span class="nc" id="L555">                .extracting(PlanItemInstance::getName, PlanItemInstance::getState)</span>
<span class="nc" id="L556">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L557">                        Tuple.tuple(&quot;Task 2&quot;, PlanItemInstanceState.ACTIVE)</span>
                );
<span class="nc" id="L559">    }</span>

    @Test
    void withSimpleOneTaskCaseIntroducingNewTaskWithConditionalSentryActivated() {
        // Arrange
<span class="nc" id="L564">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>
<span class="nc" id="L565">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L566">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/second-task-with-conditional-sentry.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L569">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L570">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L571">                .withCaseInstanceVariable(&quot;activate&quot;, true)</span>
<span class="nc" id="L572">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask2&quot;))</span>
<span class="nc" id="L573">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L576">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L577">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L578">                .singleResult();</span>
<span class="nc" id="L579">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L580">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L581">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L582">                .list();</span>
<span class="nc" id="L583">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L584">        Map&lt;String, List&lt;PlanItemInstance&gt;&gt; planItemsByElementId = planItemInstances.stream()</span>
<span class="nc" id="L585">                .collect(Collectors.groupingBy(PlanItemInstance::getElementId));</span>
<span class="nc" id="L586">        PlanItemInstance planItem1 = planItemsByElementId.get(&quot;planItem1&quot;).get(0);</span>
<span class="nc" id="L587">        assertThat(planItem1.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L588">        assertThat(planItem1.getName()).isEqualTo(&quot;Task 1&quot;);</span>
<span class="nc" id="L589">        assertThat(planItem1.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L590">        PlanItemInstance planItem2 = planItemsByElementId.get(&quot;planItem2&quot;).get(0);</span>
<span class="nc" id="L591">        assertThat(planItem2.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L592">        assertThat(planItem2.getName()).isEqualTo(&quot;Task 2&quot;);</span>
<span class="nc" id="L593">        assertThat(planItem2.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L594">    }</span>

    @Test
    void withChangingTheAssignee() {
        // Arrange
<span class="nc" id="L599">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>
<span class="nc" id="L600">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L601">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/two-task.cmmn.xml&quot;);</span>

<span class="nc bnc" id="L603" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L604">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L605">                    .isNotEqualTo(destinationDefinition.getId());</span>
        }

        // Act
<span class="nc" id="L609">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L610">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L611">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask2&quot;, &quot;kermit&quot;, null))</span>
<span class="nc" id="L612">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;humanTask1&quot;))</span>
<span class="nc" id="L613">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L616">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L617">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L618">                .singleResult();</span>
<span class="nc" id="L619">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L620">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L621">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L622">                .list();</span>
<span class="nc" id="L623">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L624">        PlanItemInstance task2PlanItemInstance = planItemInstances.get(0);</span>
<span class="nc" id="L625">        assertThat(task2PlanItemInstance).isNotNull();</span>
<span class="nc" id="L626">        assertThat(task2PlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L627">        assertThat(task2PlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
        
<span class="nc" id="L629">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L630">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;humanTask2&quot;);</span>
<span class="nc" id="L631">        assertThat(task.getAssignee()).isEqualTo(&quot;kermit&quot;);</span>
<span class="nc" id="L632">        assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L633">        cmmnTaskService.complete(task.getId());</span>
    
<span class="nc" id="L635">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L637" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L638">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L639">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L640">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L642">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L643">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L644">            assertThat(historicPlanItemInstances).hasSize(2);</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L646">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L647">            }</span>

<span class="nc" id="L649">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L650">            assertThat(historicTasks).hasSize(2);</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L652">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L653">            }</span>

<span class="nc" id="L655">            HistoricTaskInstance historicTask = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).taskAssignee(&quot;kermit&quot;)</span>
<span class="nc" id="L656">                .singleResult();</span>
<span class="nc" id="L657">            assertThat(historicTask.getTaskDefinitionKey()).isEqualTo(&quot;humanTask2&quot;);</span>
<span class="nc" id="L658">            assertThat(historicTask.getAssignee()).isEqualTo(&quot;kermit&quot;);</span>
        }
<span class="nc" id="L660">    }</span>
    
    @Test
    void withNoNewPlanItemForPlanItemInstance() {
        // Arrange
<span class="nc" id="L665">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/two-task.cmmn.xml&quot;);</span>
<span class="nc" id="L666">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L667">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L670">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L671">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L672">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L675">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L676">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L677">                .singleResult();</span>
<span class="nc" id="L678">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L679">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L680">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L681">                .includeEnded()</span>
<span class="nc" id="L682">                .list();</span>
<span class="nc" id="L683">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L684">        assertThat(planItemInstances)</span>
<span class="nc" id="L685">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L686">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L687">        assertThat(planItemInstances)</span>
<span class="nc" id="L688">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L689">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;);</span>
<span class="nc" id="L690">        assertThat(planItemInstances)</span>
<span class="nc" id="L691">                .filteredOn(&quot;name&quot;, &quot;Task 1&quot;)</span>
<span class="nc" id="L692">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L693">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L695">        assertThat(planItemInstances)</span>
<span class="nc" id="L696">                .filteredOn(&quot;name&quot;, &quot;Task 2&quot;)</span>
<span class="nc" id="L697">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L698">                .containsOnly(PlanItemInstanceState.TERMINATED);</span>
        
<span class="nc" id="L700">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask1&quot;).singleResult();</span>
<span class="nc" id="L701">        cmmnTaskService.complete(task.getId());</span>
    
<span class="nc" id="L703">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L705" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L706">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L707">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L708">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L710">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L711">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L712">            assertThat(historicPlanItemInstances).hasSize(2);</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L714">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L715">            }</span>
            
<span class="nc" id="L717">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;humanTask1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.COMPLETED);</span>
<span class="nc" id="L718">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;humanTask2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.TERMINATED);</span>

<span class="nc" id="L720">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L721">            assertThat(historicTasks).hasSize(2);</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L723">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L724">                assertThat(historicTask.getEndTime()).isNotNull();</span>
<span class="nc" id="L725">            }</span>
        }
<span class="nc" id="L727">    }</span>
    
    @Test
    void withChangingPlanItemId() {
        // Arrange
<span class="nc" id="L732">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>
<span class="nc" id="L733">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L734">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task-other-planitem-id.cmmn.xml&quot;);</span>

<span class="nc bnc" id="L736" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L737">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L738">                    .isNotEqualTo(destinationDefinition.getId());</span>
        }

        // Act
<span class="nc" id="L742">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L743">            cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L744">                    .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L745">                    .migrate(caseInstance.getId());</span>
<span class="nc" id="L746">        }).isInstanceOf(FlowableException.class)</span>
<span class="nc" id="L747">                .hasMessageStartingWith(&quot;Plan item could not be found for PlanItemInstance with id: &quot;)</span>
<span class="nc" id="L748">                .hasMessageContainingAll(&quot;name: Task 1&quot;, &quot;definitionId: humanTask1&quot;, &quot;state: active&quot;, &quot;elementId: planItem1&quot;,</span>
<span class="nc" id="L749">                        &quot;caseInstanceId: &quot; + caseInstance.getId(),</span>
<span class="nc" id="L750">                        &quot;caseDefinitionId: &quot; + destinationDefinition.getId());</span>

<span class="nc" id="L752">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L753">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L754">                .addChangePlanItemIdMapping(new ChangePlanItemIdMapping(&quot;planItem1&quot;, &quot;planItem2&quot;))</span>
<span class="nc" id="L755">                .migrate(caseInstance.getId());</span>
        
        // Assert
<span class="nc" id="L758">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L759">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L760">                .singleResult();</span>
<span class="nc" id="L761">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L762">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L763">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L764">                .list();</span>
<span class="nc" id="L765">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L766">        PlanItemInstance task1PlanItemInstance = planItemInstances.get(0);</span>
<span class="nc" id="L767">        assertThat(task1PlanItemInstance).isNotNull();</span>
<span class="nc" id="L768">        assertThat(task1PlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L769">        assertThat(task1PlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L770">        assertThat(task1PlanItemInstance.getElementId()).isEqualTo(&quot;planItem2&quot;);</span>
        
<span class="nc" id="L772">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L773">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;humanTask1&quot;);</span>
<span class="nc" id="L774">        assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
        
<span class="nc" id="L776">        cmmnTaskService.complete(task.getId());</span>
    
<span class="nc" id="L778">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L780" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L781">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L782">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L783">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L785">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L786">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L787">            assertThat(historicPlanItemInstances).hasSize(1);</span>
<span class="nc" id="L788">            HistoricPlanItemInstance historicPlanItemInstance = historicPlanItemInstances.get(0);</span>
<span class="nc" id="L789">            assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L790">            assertThat(historicPlanItemInstance.getElementId()).isEqualTo(&quot;planItem2&quot;);</span>

<span class="nc" id="L792">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L793">            assertThat(historicTasks).hasSize(1);</span>
<span class="nc" id="L794">            HistoricTaskInstance historicTask = historicTasks.get(0);</span>
<span class="nc" id="L795">            assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L796">            assertThat(historicTask.getTaskDefinitionKey()).isEqualTo(&quot;humanTask1&quot;);</span>
        }
<span class="nc" id="L798">    }</span>
    
    @Test
    void withChangingPlanItemIdWithDefinitionId() {
        // Arrange
<span class="nc" id="L803">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>
<span class="nc" id="L804">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L805">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task-other-planitem-id.cmmn.xml&quot;);</span>

<span class="nc bnc" id="L807" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L808">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L809">                    .isNotEqualTo(destinationDefinition.getId());</span>
        }

        // Act
<span class="nc" id="L813">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L814">            cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L815">                    .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L816">                    .migrate(caseInstance.getId());</span>
<span class="nc" id="L817">        }).isInstanceOf(FlowableException.class)</span>
<span class="nc" id="L818">                .hasMessageStartingWith(&quot;Plan item could not be found for PlanItemInstance with id: &quot;)</span>
<span class="nc" id="L819">                .hasMessageContainingAll(&quot;name: Task 1&quot;, &quot;definitionId: humanTask1&quot;, &quot;state: active&quot;, &quot;elementId: planItem1&quot;,</span>
<span class="nc" id="L820">                        &quot;caseInstanceId: &quot; + caseInstance.getId(),</span>
<span class="nc" id="L821">                        &quot;caseDefinitionId: &quot; + destinationDefinition.getId());</span>

<span class="nc" id="L823">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L824">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L825">                .addChangePlanItemIdWithDefinitionIdMapping(new ChangePlanItemIdWithDefinitionIdMapping(&quot;humanTask1&quot;, &quot;humanTask1&quot;))</span>
<span class="nc" id="L826">                .migrate(caseInstance.getId());</span>
        
        // Assert
<span class="nc" id="L829">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L830">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L831">                .singleResult();</span>
<span class="nc" id="L832">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L833">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L834">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L835">                .list();</span>
<span class="nc" id="L836">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L837">        PlanItemInstance task1PlanItemInstance = planItemInstances.get(0);</span>
<span class="nc" id="L838">        assertThat(task1PlanItemInstance).isNotNull();</span>
<span class="nc" id="L839">        assertThat(task1PlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L840">        assertThat(task1PlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L841">        assertThat(task1PlanItemInstance.getElementId()).isEqualTo(&quot;planItem2&quot;);</span>
        
<span class="nc" id="L843">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L844">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;humanTask1&quot;);</span>
<span class="nc" id="L845">        assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
        
<span class="nc" id="L847">        cmmnTaskService.complete(task.getId());</span>
    
<span class="nc" id="L849">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L851" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L852">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L853">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L854">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L856">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L857">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L858">            assertThat(historicPlanItemInstances).hasSize(1);</span>
<span class="nc" id="L859">            HistoricPlanItemInstance historicPlanItemInstance = historicPlanItemInstances.get(0);</span>
<span class="nc" id="L860">            assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L861">            assertThat(historicPlanItemInstance.getElementId()).isEqualTo(&quot;planItem2&quot;);</span>

<span class="nc" id="L863">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L864">            assertThat(historicTasks).hasSize(1);</span>
<span class="nc" id="L865">            HistoricTaskInstance historicTask = historicTasks.get(0);</span>
<span class="nc" id="L866">            assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L867">            assertThat(historicTask.getTaskDefinitionKey()).isEqualTo(&quot;humanTask1&quot;);</span>
        }
<span class="nc" id="L869">    }</span>
    
    @Test
    void withChangingPlanItemIdWithNewTargetIds() {
        // Arrange
<span class="nc" id="L874">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>
<span class="nc" id="L875">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L876">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task-other-target-ids.cmmn.xml&quot;);</span>

<span class="nc bnc" id="L878" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L879">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L880">                    .isNotEqualTo(destinationDefinition.getId());</span>
        }

<span class="nc" id="L883">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L884">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L885">                .addChangePlanItemDefinitionWithNewTargetIdsMapping(new ChangePlanItemDefinitionWithNewTargetIdsMapping(&quot;humanTask1&quot;, &quot;planItem2&quot;, &quot;humanTask2&quot;))</span>
<span class="nc" id="L886">                .migrate(caseInstance.getId());</span>
        
        // Assert
<span class="nc" id="L889">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L890">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L891">                .singleResult();</span>
<span class="nc" id="L892">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L893">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L894">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L895">                .list();</span>
<span class="nc" id="L896">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L897">        PlanItemInstance task1PlanItemInstance = planItemInstances.get(0);</span>
<span class="nc" id="L898">        assertThat(task1PlanItemInstance).isNotNull();</span>
<span class="nc" id="L899">        assertThat(task1PlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L900">        assertThat(task1PlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L901">        assertThat(task1PlanItemInstance.getElementId()).isEqualTo(&quot;planItem2&quot;);</span>
<span class="nc" id="L902">        assertThat(task1PlanItemInstance.getPlanItemDefinitionId()).isEqualTo(&quot;humanTask2&quot;);</span>
        
<span class="nc" id="L904">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L905">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;humanTask2&quot;);</span>
<span class="nc" id="L906">        assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
        
<span class="nc" id="L908">        cmmnTaskService.complete(task.getId());</span>
    
<span class="nc" id="L910">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L912" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L913">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L914">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L915">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L917">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L918">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L919">            assertThat(historicPlanItemInstances).hasSize(1);</span>
<span class="nc" id="L920">            HistoricPlanItemInstance historicPlanItemInstance = historicPlanItemInstances.get(0);</span>
<span class="nc" id="L921">            assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L922">            assertThat(historicPlanItemInstance.getElementId()).isEqualTo(&quot;planItem2&quot;);</span>
<span class="nc" id="L923">            assertThat(historicPlanItemInstance.getPlanItemDefinitionId()).isEqualTo(&quot;humanTask2&quot;);</span>

<span class="nc" id="L925">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L926">            assertThat(historicTasks).hasSize(1);</span>
<span class="nc" id="L927">            HistoricTaskInstance historicTask = historicTasks.get(0);</span>
<span class="nc" id="L928">            assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L929">            assertThat(historicTask.getTaskDefinitionKey()).isEqualTo(&quot;humanTask2&quot;);</span>
        }
<span class="nc" id="L931">    }</span>
    
    @Test
    void withChangingPlanItemIdAndTerminateDefinition() {
        // Arrange
<span class="nc" id="L936">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>
<span class="nc" id="L937">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L938">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/two-task-other-planitem-id.cmmn.xml&quot;);</span>

<span class="nc bnc" id="L940" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L941">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L942">                    .isNotEqualTo(destinationDefinition.getId());</span>
        }

        // Act
<span class="nc" id="L946">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L947">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L948">                .addTerminatePlanItemDefinitionMapping(new TerminatePlanItemDefinitionMapping(&quot;humanTask1&quot;))</span>
<span class="nc" id="L949">                .addActivatePlanItemDefinitionMapping(new ActivatePlanItemDefinitionMapping(&quot;humanTask2&quot;))</span>
<span class="nc" id="L950">                .addChangePlanItemIdMapping(new ChangePlanItemIdMapping(&quot;planItem1&quot;, &quot;planItem3&quot;))</span>
<span class="nc" id="L951">                .addChangePlanItemIdMapping(new ChangePlanItemIdMapping(&quot;planItem2&quot;, &quot;planItem4&quot;))</span>
<span class="nc" id="L952">                .migrate(caseInstance.getId());</span>
        
        // Assert
<span class="nc" id="L955">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L956">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L957">                .singleResult();</span>
<span class="nc" id="L958">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L959">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L960">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L961">                .list();</span>
<span class="nc" id="L962">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L963">        PlanItemInstance task1PlanItemInstance = planItemInstances.get(0);</span>
<span class="nc" id="L964">        assertThat(task1PlanItemInstance).isNotNull();</span>
<span class="nc" id="L965">        assertThat(task1PlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L966">        assertThat(task1PlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L967">        assertThat(task1PlanItemInstance.getElementId()).isEqualTo(&quot;planItem4&quot;);</span>
        
<span class="nc" id="L969">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L970">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;humanTask2&quot;);</span>
<span class="nc" id="L971">        assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
        
<span class="nc" id="L973">        cmmnTaskService.complete(task.getId());</span>
    
<span class="nc" id="L975">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L977" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L978">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L979">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L980">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L982">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L983">                .planItemInstanceCaseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L984">                .orderByCreateTime()</span>
<span class="nc" id="L985">                .asc()</span>
<span class="nc" id="L986">                .list();</span>
            
<span class="nc" id="L988">            assertThat(historicPlanItemInstances).hasSize(2);</span>
<span class="nc" id="L989">            HistoricPlanItemInstance historicPlanItemInstance = historicPlanItemInstances.get(0);</span>
<span class="nc" id="L990">            assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L991">            assertThat(historicPlanItemInstance.getElementId()).isEqualTo(&quot;planItem3&quot;);</span>
            
<span class="nc" id="L993">            historicPlanItemInstance = historicPlanItemInstances.get(1);</span>
<span class="nc" id="L994">            assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L995">            assertThat(historicPlanItemInstance.getElementId()).isEqualTo(&quot;planItem4&quot;);</span>

<span class="nc" id="L997">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L998">                    .caseInstanceId(caseInstance.getId()).orderByTaskCreateTime().asc().list();</span>
<span class="nc" id="L999">            assertThat(historicTasks).hasSize(2);</span>
<span class="nc" id="L1000">            HistoricTaskInstance historicTask = historicTasks.get(0);</span>
<span class="nc" id="L1001">            assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1002">            assertThat(historicTask.getTaskDefinitionKey()).isEqualTo(&quot;humanTask1&quot;);</span>
<span class="nc" id="L1003">            historicTask = historicTasks.get(1);</span>
<span class="nc" id="L1004">            assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1005">            assertThat(historicTask.getTaskDefinitionKey()).isEqualTo(&quot;humanTask2&quot;);</span>
        }
<span class="nc" id="L1007">    }</span>
    
    @Test
    void withMilestoneAndChangingPlanItemId() {
        // Arrange
<span class="nc" id="L1012">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task-milestone.cmmn.xml&quot;);</span>
<span class="nc" id="L1013">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L1014">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task-milestone-other-planitem-id.cmmn.xml&quot;);</span>

<span class="nc bnc" id="L1016" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1017">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L1018">                    .isNotEqualTo(destinationDefinition.getId());</span>
        }

        // Act
<span class="nc" id="L1022">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L1023">            cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L1024">                    .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L1025">                    .migrate(caseInstance.getId());</span>
<span class="nc" id="L1026">        }).isInstanceOf(FlowableException.class)</span>
<span class="nc" id="L1027">                .hasMessageStartingWith(&quot;Plan item could not be found for PlanItemInstance with id: &quot;)</span>
<span class="nc" id="L1028">                .hasMessageContainingAll(&quot;name: Task 1&quot;, &quot;definitionId: humanTask1&quot;, &quot;state: active&quot;, &quot;elementId: planItem1&quot;,</span>
<span class="nc" id="L1029">                        &quot;caseInstanceId: &quot; + caseInstance.getId(),</span>
<span class="nc" id="L1030">                        &quot;caseDefinitionId: &quot; + destinationDefinition.getId());</span>

<span class="nc" id="L1032">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L1033">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L1034">                .addChangePlanItemIdMapping(new ChangePlanItemIdMapping(&quot;planItem1&quot;, &quot;planItem3&quot;))</span>
<span class="nc" id="L1035">                .addChangePlanItemIdMapping(new ChangePlanItemIdMapping(&quot;planItem2&quot;, &quot;planItem4&quot;))</span>
<span class="nc" id="L1036">                .migrate(caseInstance.getId());</span>
        
        // Assert
<span class="nc" id="L1039">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1040">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1041">                .singleResult();</span>
<span class="nc" id="L1042">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1043">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L1044">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1045">                .list();</span>
<span class="nc" id="L1046">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L1047">        PlanItemInstance task1PlanItemInstance = planItemInstances.get(0);</span>
<span class="nc" id="L1048">        assertThat(task1PlanItemInstance).isNotNull();</span>
<span class="nc" id="L1049">        assertThat(task1PlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L1050">        assertThat(task1PlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1051">        assertThat(task1PlanItemInstance.getElementId()).isEqualTo(&quot;planItem3&quot;);</span>
        
<span class="nc" id="L1053">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L1054">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;humanTask1&quot;);</span>
<span class="nc" id="L1055">        assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
        
<span class="nc" id="L1057">        List&lt;MilestoneInstance&gt; milestoneInstances = cmmnRuntimeService.createMilestoneInstanceQuery()</span>
<span class="nc" id="L1058">                .milestoneInstanceCaseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1059">                .list();</span>
<span class="nc" id="L1060">        assertThat(milestoneInstances).hasSize(1);</span>
<span class="nc" id="L1061">        MilestoneInstance milestonePlanItemInstance = milestoneInstances.get(0);</span>
<span class="nc" id="L1062">        assertThat(milestonePlanItemInstance).isNotNull();</span>
<span class="nc" id="L1063">        assertThat(milestonePlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1064">        assertThat(milestonePlanItemInstance.getElementId()).isEqualTo(&quot;planItem4&quot;);</span>
        
<span class="nc" id="L1066">        cmmnTaskService.complete(task.getId());</span>
    
<span class="nc" id="L1068">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L1070" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1071">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L1072">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L1073">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L1075">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L1076">                .planItemInstanceCaseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1077">                .orderByName()</span>
<span class="nc" id="L1078">                .desc()</span>
<span class="nc" id="L1079">                .list();</span>
<span class="nc" id="L1080">            assertThat(historicPlanItemInstances).hasSize(2);</span>
<span class="nc" id="L1081">            HistoricPlanItemInstance historicPlanItemInstance = historicPlanItemInstances.get(0);</span>
<span class="nc" id="L1082">            assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1083">            assertThat(historicPlanItemInstance.getElementId()).isEqualTo(&quot;planItem3&quot;);</span>
            
<span class="nc" id="L1085">            historicPlanItemInstance = historicPlanItemInstances.get(1);</span>
<span class="nc" id="L1086">            assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1087">            assertThat(historicPlanItemInstance.getElementId()).isEqualTo(&quot;planItem4&quot;);</span>
            
<span class="nc" id="L1089">            List&lt;HistoricMilestoneInstance&gt; historicMilestoneInstances = cmmnHistoryService.createHistoricMilestoneInstanceQuery()</span>
<span class="nc" id="L1090">                    .milestoneInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1091">            assertThat(historicMilestoneInstances).hasSize(1);</span>
<span class="nc" id="L1092">            HistoricMilestoneInstance historicMilestoneInstance = historicMilestoneInstances.get(0);</span>
<span class="nc" id="L1093">            assertThat(historicMilestoneInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1094">            assertThat(historicMilestoneInstance.getElementId()).isEqualTo(&quot;planItem4&quot;);</span>

<span class="nc" id="L1096">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1097">            assertThat(historicTasks).hasSize(1);</span>
<span class="nc" id="L1098">            HistoricTaskInstance historicTask = historicTasks.get(0);</span>
<span class="nc" id="L1099">            assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1100">            assertThat(historicTask.getTaskDefinitionKey()).isEqualTo(&quot;humanTask1&quot;);</span>
        }
<span class="nc" id="L1102">    }</span>
    
    @Test
    void withMilestoneAndChangingPlanItemIdWithDefinitionId() {
        // Arrange
<span class="nc" id="L1107">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task-milestone.cmmn.xml&quot;);</span>
<span class="nc" id="L1108">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L1109">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task-milestone-other-planitem-id.cmmn.xml&quot;);</span>

<span class="nc bnc" id="L1111" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1112">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L1113">                    .isNotEqualTo(destinationDefinition.getId());</span>
        }

        // Act
<span class="nc" id="L1117">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L1118">            cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L1119">                    .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L1120">                    .migrate(caseInstance.getId());</span>
<span class="nc" id="L1121">        }).isInstanceOf(FlowableException.class)</span>
<span class="nc" id="L1122">                .hasMessageStartingWith(&quot;Plan item could not be found for PlanItemInstance with id: &quot;)</span>
<span class="nc" id="L1123">                .hasMessageContainingAll(&quot;name: Task 1&quot;, &quot;definitionId: humanTask1&quot;, &quot;state: active&quot;, &quot;elementId: planItem1&quot;,</span>
<span class="nc" id="L1124">                        &quot;caseInstanceId: &quot; + caseInstance.getId(),</span>
<span class="nc" id="L1125">                        &quot;caseDefinitionId: &quot; + destinationDefinition.getId());</span>

<span class="nc" id="L1127">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L1128">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L1129">                .addChangePlanItemIdWithDefinitionIdMapping(new ChangePlanItemIdWithDefinitionIdMapping(&quot;humanTask1&quot;, &quot;humanTask1&quot;))</span>
<span class="nc" id="L1130">                .addChangePlanItemIdWithDefinitionIdMapping(new ChangePlanItemIdWithDefinitionIdMapping(&quot;milestone1&quot;, &quot;milestone1&quot;))</span>
<span class="nc" id="L1131">                .migrate(caseInstance.getId());</span>
        
        // Assert
<span class="nc" id="L1134">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1135">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1136">                .singleResult();</span>
<span class="nc" id="L1137">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1138">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L1139">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1140">                .list();</span>
<span class="nc" id="L1141">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L1142">        PlanItemInstance task1PlanItemInstance = planItemInstances.get(0);</span>
<span class="nc" id="L1143">        assertThat(task1PlanItemInstance).isNotNull();</span>
<span class="nc" id="L1144">        assertThat(task1PlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L1145">        assertThat(task1PlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1146">        assertThat(task1PlanItemInstance.getElementId()).isEqualTo(&quot;planItem3&quot;);</span>
        
<span class="nc" id="L1148">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L1149">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;humanTask1&quot;);</span>
<span class="nc" id="L1150">        assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
        
<span class="nc" id="L1152">        List&lt;MilestoneInstance&gt; milestoneInstances = cmmnRuntimeService.createMilestoneInstanceQuery()</span>
<span class="nc" id="L1153">                .milestoneInstanceCaseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1154">                .list();</span>
<span class="nc" id="L1155">        assertThat(milestoneInstances).hasSize(1);</span>
<span class="nc" id="L1156">        MilestoneInstance milestonePlanItemInstance = milestoneInstances.get(0);</span>
<span class="nc" id="L1157">        assertThat(milestonePlanItemInstance).isNotNull();</span>
<span class="nc" id="L1158">        assertThat(milestonePlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1159">        assertThat(milestonePlanItemInstance.getElementId()).isEqualTo(&quot;planItem4&quot;);</span>
        
<span class="nc" id="L1161">        cmmnTaskService.complete(task.getId());</span>
    
<span class="nc" id="L1163">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L1165" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1166">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L1167">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L1168">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L1170">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L1171">                .planItemInstanceCaseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1172">                .orderByName()</span>
<span class="nc" id="L1173">                .desc()</span>
<span class="nc" id="L1174">                .list();</span>
<span class="nc" id="L1175">            assertThat(historicPlanItemInstances).hasSize(2);</span>
<span class="nc" id="L1176">            HistoricPlanItemInstance historicPlanItemInstance = historicPlanItemInstances.get(0);</span>
<span class="nc" id="L1177">            assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1178">            assertThat(historicPlanItemInstance.getElementId()).isEqualTo(&quot;planItem3&quot;);</span>
            
<span class="nc" id="L1180">            historicPlanItemInstance = historicPlanItemInstances.get(1);</span>
<span class="nc" id="L1181">            assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1182">            assertThat(historicPlanItemInstance.getElementId()).isEqualTo(&quot;planItem4&quot;);</span>
            
<span class="nc" id="L1184">            List&lt;HistoricMilestoneInstance&gt; historicMilestoneInstances = cmmnHistoryService.createHistoricMilestoneInstanceQuery()</span>
<span class="nc" id="L1185">                    .milestoneInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1186">            assertThat(historicMilestoneInstances).hasSize(1);</span>
<span class="nc" id="L1187">            HistoricMilestoneInstance historicMilestoneInstance = historicMilestoneInstances.get(0);</span>
<span class="nc" id="L1188">            assertThat(historicMilestoneInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1189">            assertThat(historicMilestoneInstance.getElementId()).isEqualTo(&quot;planItem4&quot;);</span>

<span class="nc" id="L1191">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1192">            assertThat(historicTasks).hasSize(1);</span>
<span class="nc" id="L1193">            HistoricTaskInstance historicTask = historicTasks.get(0);</span>
<span class="nc" id="L1194">            assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1195">            assertThat(historicTask.getTaskDefinitionKey()).isEqualTo(&quot;humanTask1&quot;);</span>
        }
<span class="nc" id="L1197">    }</span>
    
    @Test
    void withIfSentryEventDeferredAndChangingPlanItemId() {
        // Arrange
<span class="nc" id="L1202">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/twosentry-ifpart-eventdeferred.cmmn.xml&quot;);</span>
<span class="nc" id="L1203">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L1204">                .caseDefinitionKey(&quot;testCase&quot;)</span>
<span class="nc" id="L1205">                .variable(&quot;var1&quot;, &quot;test&quot;)</span>
<span class="nc" id="L1206">                .start();</span>
        
<span class="nc" id="L1208">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/twosentry-ifpart-eventdeferred-other-planitem-id.cmmn.xml&quot;);</span>

<span class="nc bnc" id="L1210" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1211">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L1212">                    .isNotEqualTo(destinationDefinition.getId());</span>
        }

        // Act
<span class="nc" id="L1216">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L1217">            cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L1218">                    .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L1219">                    .migrate(caseInstance.getId());</span>
<span class="nc" id="L1220">        }).isInstanceOf(FlowableException.class)</span>
<span class="nc" id="L1221">                .hasMessageStartingWith(&quot;Plan item could not be found for PlanItemInstance with id: &quot;)</span>
<span class="nc" id="L1222">                .hasMessageContainingAll(&quot;name: Task 1&quot;, &quot;definitionId: humanTask1&quot;, &quot;state: active&quot;, &quot;elementId: planItem1&quot;,</span>
<span class="nc" id="L1223">                        &quot;caseInstanceId: &quot; + caseInstance.getId(),</span>
<span class="nc" id="L1224">                        &quot;caseDefinitionId: &quot; + destinationDefinition.getId());</span>

<span class="nc" id="L1226">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L1227">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L1228">                .addChangePlanItemIdMapping(new ChangePlanItemIdMapping(&quot;planItem1&quot;, &quot;planItem3&quot;))</span>
<span class="nc" id="L1229">                .addChangePlanItemIdMapping(new ChangePlanItemIdMapping(&quot;planItem2&quot;, &quot;planItem4&quot;))</span>
<span class="nc" id="L1230">                .migrate(caseInstance.getId());</span>
        
        // Assert
<span class="nc" id="L1233">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1234">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1235">                .singleResult();</span>
<span class="nc" id="L1236">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1237">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L1238">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1239">                .list();</span>
<span class="nc" id="L1240">        assertThat(planItemInstances).hasSize(2);</span>
        
<span class="nc" id="L1242">        PlanItemInstance task1PlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().planItemDefinitionId(&quot;humanTask1&quot;).singleResult();</span>
<span class="nc" id="L1243">        assertThat(task1PlanItemInstance).isNotNull();</span>
<span class="nc" id="L1244">        assertThat(task1PlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L1245">        assertThat(task1PlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1246">        assertThat(task1PlanItemInstance.getElementId()).isEqualTo(&quot;planItem3&quot;);</span>
        
<span class="nc" id="L1248">        PlanItemInstance task2PlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().planItemDefinitionId(&quot;humanTask2&quot;).singleResult();</span>
<span class="nc" id="L1249">        assertThat(task2PlanItemInstance).isNotNull();</span>
<span class="nc" id="L1250">        assertThat(task2PlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L1251">        assertThat(task2PlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1252">        assertThat(task2PlanItemInstance.getElementId()).isEqualTo(&quot;planItem4&quot;);</span>
        
<span class="nc" id="L1254">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L1255">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;humanTask1&quot;);</span>
<span class="nc" id="L1256">        assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
        
<span class="nc" id="L1258">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L1260">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L1261">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;humanTask2&quot;);</span>
<span class="nc" id="L1262">        assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
        
<span class="nc" id="L1264">        cmmnTaskService.complete(task.getId());</span>
    
<span class="nc" id="L1266">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L1268" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1269">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L1270">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L1271">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L1273">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L1274">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1275">            assertThat(historicPlanItemInstances).hasSize(2);</span>
            
<span class="nc" id="L1277">            HistoricPlanItemInstance historicPlanItemInstance = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L1278">                    .planItemInstanceCaseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1279">                    .planItemInstanceDefinitionId(&quot;humanTask1&quot;)</span>
<span class="nc" id="L1280">                    .singleResult();</span>
<span class="nc" id="L1281">            assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1282">            assertThat(historicPlanItemInstance.getElementId()).isEqualTo(&quot;planItem3&quot;);</span>
            
<span class="nc" id="L1284">            historicPlanItemInstance = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L1285">                    .planItemInstanceCaseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1286">                    .planItemInstanceDefinitionId(&quot;humanTask2&quot;)</span>
<span class="nc" id="L1287">                    .singleResult();</span>
<span class="nc" id="L1288">            assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1289">            assertThat(historicPlanItemInstance.getElementId()).isEqualTo(&quot;planItem4&quot;);</span>

<span class="nc" id="L1291">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1292">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1293">                    .orderByTaskCreateTime()</span>
<span class="nc" id="L1294">                    .asc()</span>
<span class="nc" id="L1295">                    .list();</span>
<span class="nc" id="L1296">            assertThat(historicTasks).hasSize(2);</span>
            
<span class="nc" id="L1298">            HistoricTaskInstance historicTask = historicTasks.get(0);</span>
<span class="nc" id="L1299">            assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1300">            assertThat(historicTask.getTaskDefinitionKey()).isEqualTo(&quot;humanTask1&quot;);</span>
            
<span class="nc" id="L1302">            historicTask = historicTasks.get(1);</span>
<span class="nc" id="L1303">            assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1304">            assertThat(historicTask.getTaskDefinitionKey()).isEqualTo(&quot;humanTask2&quot;);</span>
        }
<span class="nc" id="L1306">    }</span>
    
    @Test
    void withIfSentryEventDeferredAndChangingPlanItemIdWithDefinitionId() {
        // Arrange
<span class="nc" id="L1311">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/twosentry-ifpart-eventdeferred.cmmn.xml&quot;);</span>
<span class="nc" id="L1312">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L1313">                .caseDefinitionKey(&quot;testCase&quot;)</span>
<span class="nc" id="L1314">                .variable(&quot;var1&quot;, &quot;test&quot;)</span>
<span class="nc" id="L1315">                .start();</span>
        
<span class="nc" id="L1317">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/twosentry-ifpart-eventdeferred-other-planitem-id.cmmn.xml&quot;);</span>

<span class="nc bnc" id="L1319" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1320">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L1321">                    .isNotEqualTo(destinationDefinition.getId());</span>
        }

        // Act
<span class="nc" id="L1325">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L1326">            cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L1327">                    .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L1328">                    .migrate(caseInstance.getId());</span>
<span class="nc" id="L1329">        }).isInstanceOf(FlowableException.class)</span>
<span class="nc" id="L1330">                .hasMessageStartingWith(&quot;Plan item could not be found for PlanItemInstance with id: &quot;)</span>
<span class="nc" id="L1331">                .hasMessageContainingAll(&quot;name: Task 1&quot;, &quot;definitionId: humanTask1&quot;, &quot;state: active&quot;, &quot;elementId: planItem1&quot;,</span>
<span class="nc" id="L1332">                        &quot;caseInstanceId: &quot; + caseInstance.getId(),</span>
<span class="nc" id="L1333">                        &quot;caseDefinitionId: &quot; + destinationDefinition.getId());</span>

<span class="nc" id="L1335">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L1336">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L1337">                .addChangePlanItemIdWithDefinitionIdMapping(new ChangePlanItemIdWithDefinitionIdMapping(&quot;humanTask1&quot;, &quot;humanTask1&quot;))</span>
<span class="nc" id="L1338">                .addChangePlanItemIdWithDefinitionIdMapping(new ChangePlanItemIdWithDefinitionIdMapping(&quot;humanTask2&quot;, &quot;humanTask2&quot;))</span>
<span class="nc" id="L1339">                .migrate(caseInstance.getId());</span>
        
        // Assert
<span class="nc" id="L1342">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1343">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1344">                .singleResult();</span>
<span class="nc" id="L1345">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1346">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L1347">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1348">                .list();</span>
<span class="nc" id="L1349">        assertThat(planItemInstances).hasSize(2);</span>
        
<span class="nc" id="L1351">        PlanItemInstance task1PlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().planItemDefinitionId(&quot;humanTask1&quot;).singleResult();</span>
<span class="nc" id="L1352">        assertThat(task1PlanItemInstance).isNotNull();</span>
<span class="nc" id="L1353">        assertThat(task1PlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L1354">        assertThat(task1PlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1355">        assertThat(task1PlanItemInstance.getElementId()).isEqualTo(&quot;planItem3&quot;);</span>
        
<span class="nc" id="L1357">        PlanItemInstance task2PlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().planItemDefinitionId(&quot;humanTask2&quot;).singleResult();</span>
<span class="nc" id="L1358">        assertThat(task2PlanItemInstance).isNotNull();</span>
<span class="nc" id="L1359">        assertThat(task2PlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L1360">        assertThat(task2PlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1361">        assertThat(task2PlanItemInstance.getElementId()).isEqualTo(&quot;planItem4&quot;);</span>
        
<span class="nc" id="L1363">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L1364">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;humanTask1&quot;);</span>
<span class="nc" id="L1365">        assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
        
<span class="nc" id="L1367">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L1369">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L1370">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;humanTask2&quot;);</span>
<span class="nc" id="L1371">        assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
        
<span class="nc" id="L1373">        cmmnTaskService.complete(task.getId());</span>
    
<span class="nc" id="L1375">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L1377" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1378">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L1379">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L1380">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L1382">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L1383">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1384">            assertThat(historicPlanItemInstances).hasSize(2);</span>
            
<span class="nc" id="L1386">            HistoricPlanItemInstance historicPlanItemInstance = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L1387">                    .planItemInstanceCaseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1388">                    .planItemInstanceDefinitionId(&quot;humanTask1&quot;)</span>
<span class="nc" id="L1389">                    .singleResult();</span>
<span class="nc" id="L1390">            assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1391">            assertThat(historicPlanItemInstance.getElementId()).isEqualTo(&quot;planItem3&quot;);</span>
            
<span class="nc" id="L1393">            historicPlanItemInstance = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L1394">                    .planItemInstanceCaseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1395">                    .planItemInstanceDefinitionId(&quot;humanTask2&quot;)</span>
<span class="nc" id="L1396">                    .singleResult();</span>
<span class="nc" id="L1397">            assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1398">            assertThat(historicPlanItemInstance.getElementId()).isEqualTo(&quot;planItem4&quot;);</span>

<span class="nc" id="L1400">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1401">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1402">                    .orderByTaskCreateTime()</span>
<span class="nc" id="L1403">                    .asc()</span>
<span class="nc" id="L1404">                    .list();</span>
<span class="nc" id="L1405">            assertThat(historicTasks).hasSize(2);</span>
            
<span class="nc" id="L1407">            HistoricTaskInstance historicTask = historicTasks.get(0);</span>
<span class="nc" id="L1408">            assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1409">            assertThat(historicTask.getTaskDefinitionKey()).isEqualTo(&quot;humanTask1&quot;);</span>
            
<span class="nc" id="L1411">            historicTask = historicTasks.get(1);</span>
<span class="nc" id="L1412">            assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1413">            assertThat(historicTask.getTaskDefinitionKey()).isEqualTo(&quot;humanTask2&quot;);</span>
        }
<span class="nc" id="L1415">    }</span>

    @Test
    void withTwoCaseTasksToThreeTaskTasks() {
        // Arrange
<span class="nc" id="L1420">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/two-task.cmmn.xml&quot;);</span>
<span class="nc" id="L1421">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L1422">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/three-task.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L1425">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L1426">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L1427">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask3&quot;))</span>
<span class="nc" id="L1428">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L1431">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1432">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1433">                .singleResult();</span>
<span class="nc" id="L1434">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1435">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L1436">                .list();</span>
<span class="nc" id="L1437">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L1438">        assertThat(planItemInstances)</span>
<span class="nc" id="L1439">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1440">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L1441">        assertThat(planItemInstances)</span>
<span class="nc" id="L1442">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L1443">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;, &quot;Task 3&quot;);</span>
<span class="nc" id="L1444">    }</span>
    
    @Test
    void withThreeCaseTasksToTwoTaskTasks() {
        // Arrange
<span class="nc" id="L1449">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/three-task.cmmn.xml&quot;);</span>
<span class="nc" id="L1450">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L1451">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/two-task.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L1454">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L1455">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L1456">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;humanTask3&quot;))</span>
<span class="nc" id="L1457">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L1460">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1461">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1462">                .singleResult();</span>
<span class="nc" id="L1463">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1464">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L1465">                .list();</span>
<span class="nc" id="L1466">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L1467">        assertThat(planItemInstances)</span>
<span class="nc" id="L1468">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1469">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L1470">        assertThat(planItemInstances)</span>
<span class="nc" id="L1471">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L1472">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;);</span>
<span class="nc" id="L1473">    }</span>

    @Test
    void withMappingOldTaskToCompleteNewTask() {
        // Arrange
<span class="nc" id="L1478">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/two-task.cmmn.xml&quot;);</span>
<span class="nc" id="L1479">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L1480">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/three-task.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L1483">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L1484">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L1485">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask3&quot;))</span>
<span class="nc" id="L1486">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;humanTask2&quot;))</span>
<span class="nc" id="L1487">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L1490">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1491">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1492">                .singleResult();</span>
<span class="nc" id="L1493">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1494">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().list();</span>
<span class="nc" id="L1495">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L1496">        assertThat(planItemInstances)</span>
<span class="nc" id="L1497">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1498">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L1499">        assertThat(planItemInstances)</span>
<span class="nc" id="L1500">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L1501">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 3&quot;);</span>
<span class="nc" id="L1502">    }</span>
    
    @Test
    void stageWithListener() {
        // Arrange
<span class="nc" id="L1507">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-and-listener.cmmn.xml&quot;);</span>
<span class="nc" id="L1508">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
        
<span class="nc" id="L1510">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().list();</span>
<span class="nc" id="L1511">        assertThat(planItemInstances).hasSize(5);</span>
<span class="nc" id="L1512">        assertThat(planItemInstances)</span>
<span class="nc" id="L1513">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1514">                .containsOnly(originalDefinition.getId());</span>
<span class="nc" id="L1515">        assertThat(planItemInstances)</span>
<span class="nc" id="L1516">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L1517">                .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;expandedStage2&quot;, &quot;humanTask1&quot;, &quot;humanTask4&quot;, &quot;userEventListener1&quot;);</span>
        
<span class="nc" id="L1519">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-and-listener2.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L1522">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L1523">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L1524">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;userEventListener2&quot;))</span>
<span class="nc" id="L1525">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;expandedStage3&quot;))</span>
<span class="nc" id="L1526">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L1529">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1530">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1531">                .singleResult();</span>
<span class="nc" id="L1532">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1533">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().list();</span>
<span class="nc" id="L1534">        assertThat(planItemInstances).hasSize(7);</span>
<span class="nc" id="L1535">        assertThat(planItemInstances)</span>
<span class="nc" id="L1536">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1537">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L1538">        assertThat(planItemInstances)</span>
<span class="nc" id="L1539">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L1540">                .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;expandedStage2&quot;, &quot;expandedStage3&quot;, &quot;humanTask1&quot;,</span>
                        &quot;humanTask4&quot;, &quot;userEventListener1&quot;, &quot;userEventListener2&quot;);
<span class="nc" id="L1542">    }</span>
    
    @Test
    void withActivateStage() {
        // Arrange
<span class="nc" id="L1547">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/case-with-stage.cmmn.xml&quot;);</span>
<span class="nc" id="L1548">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;migrationCase&quot;).start();</span>
<span class="nc" id="L1549">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/case-with-stage.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L1552">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L1553">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L1554">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;cmmnStage1&quot;))</span>
<span class="nc" id="L1555">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L1558">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1559">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1560">                .singleResult();</span>
<span class="nc" id="L1561">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1562">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L1563">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1564">                .includeEnded()</span>
<span class="nc" id="L1565">                .list();</span>
<span class="nc" id="L1566">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L1567">        assertThat(planItemInstances)</span>
<span class="nc" id="L1568">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1569">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L1570">        assertThat(planItemInstances)</span>
<span class="nc" id="L1571">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L1572">                .containsExactlyInAnyOrder(&quot;Stage 1&quot;, &quot;Stage 1&quot;, &quot;Human task 1&quot;);</span>
<span class="nc" id="L1573">        assertThat(planItemInstances)</span>
<span class="nc" id="L1574">                .filteredOn(&quot;name&quot;, &quot;Human task 1&quot;)</span>
<span class="nc" id="L1575">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L1576">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L1578">        assertThat(planItemInstances)</span>
<span class="nc" id="L1579">                .filteredOn(&quot;name&quot;, &quot;Stage 1&quot;)</span>
<span class="nc" id="L1580">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L1581">                .containsOnly(PlanItemInstanceState.WAITING_FOR_REPETITION, PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L1583">        PlanItemInstance stagePlanItem = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;cmmnStage1&quot;).planItemInstanceState(PlanItemInstanceState.ACTIVE).singleResult();</span>
        
<span class="nc" id="L1585">        PlanItemInstance taskPlanItem = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;stageTask1&quot;).singleResult();</span>
        
<span class="nc" id="L1587">        assertThat(taskPlanItem.getStageInstanceId()).isEqualTo(stagePlanItem.getId());</span>
        
<span class="nc" id="L1589">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L1590">        cmmnTaskService.complete(task.getId());</span>
    
<span class="nc" id="L1592">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L1594" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1595">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L1596">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L1597">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L1599">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L1600">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1601">            assertThat(historicPlanItemInstances).hasSize(3);</span>
<span class="nc bnc" id="L1602" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L1603">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1604">            }</span>

<span class="nc" id="L1606">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1607">            assertThat(historicTasks).hasSize(1);</span>
<span class="nc bnc" id="L1608" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L1609">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1610">            }</span>
        }
<span class="nc" id="L1612">    }</span>
    
    @Test
    void withActivateAnotherRepetitionStage() {
        // Arrange
<span class="nc" id="L1617">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/case-with-active-stage.cmmn.xml&quot;);</span>
<span class="nc" id="L1618">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;migrationCase&quot;).start();</span>
<span class="nc" id="L1619">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/case-with-active-stage.cmmn.xml&quot;);</span>

<span class="nc" id="L1621">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L1622">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1623">                .includeEnded()</span>
<span class="nc" id="L1624">                .list();</span>
<span class="nc" id="L1625">        assertThat(planItemInstances).hasSize(3);</span>
        
<span class="nc" id="L1627">        assertThat(planItemInstances)</span>
<span class="nc" id="L1628">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L1629">                .containsExactlyInAnyOrder(&quot;Stage 1&quot;, &quot;Stage 1&quot;, &quot;Human task 1&quot;);</span>
<span class="nc" id="L1630">        assertThat(planItemInstances)</span>
<span class="nc" id="L1631">                .filteredOn(&quot;name&quot;, &quot;Human task 1&quot;)</span>
<span class="nc" id="L1632">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L1633">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L1635">        assertThat(planItemInstances)</span>
<span class="nc" id="L1636">                .filteredOn(&quot;name&quot;, &quot;Stage 1&quot;)</span>
<span class="nc" id="L1637">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L1638">                .containsOnly(PlanItemInstanceState.WAITING_FOR_REPETITION, PlanItemInstanceState.ACTIVE);</span>
        
        // Act
<span class="nc" id="L1641">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L1642">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L1643">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;stageTask1&quot;))</span>
<span class="nc" id="L1644">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L1647">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1648">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1649">                .singleResult();</span>
<span class="nc" id="L1650">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1651">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L1652">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1653">                .includeEnded()</span>
<span class="nc" id="L1654">                .list();</span>
<span class="nc" id="L1655">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L1656">        assertThat(planItemInstances)</span>
<span class="nc" id="L1657">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1658">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L1659">        assertThat(planItemInstances)</span>
<span class="nc" id="L1660">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L1661">                .containsExactlyInAnyOrder(&quot;Stage 1&quot;, &quot;Stage 1&quot;, &quot;Human task 1&quot;, &quot;Human task 1&quot;);</span>
<span class="nc" id="L1662">        assertThat(planItemInstances)</span>
<span class="nc" id="L1663">                .filteredOn(&quot;name&quot;, &quot;Human task 1&quot;)</span>
<span class="nc" id="L1664">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L1665">                .containsOnly(PlanItemInstanceState.ACTIVE, PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L1667">        assertThat(planItemInstances)</span>
<span class="nc" id="L1668">                .filteredOn(&quot;name&quot;, &quot;Stage 1&quot;)</span>
<span class="nc" id="L1669">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L1670">                .containsOnly(PlanItemInstanceState.WAITING_FOR_REPETITION, PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L1672">        PlanItemInstance stagePlanItem = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;cmmnStage1&quot;).planItemInstanceState(PlanItemInstanceState.ACTIVE).singleResult();</span>
        
<span class="nc" id="L1674">        List&lt;PlanItemInstance&gt; taskPlanItems = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;stageTask1&quot;).list();</span>
        
<span class="nc bnc" id="L1676" title="All 2 branches missed.">        for (PlanItemInstance taskPlanItemInstance : taskPlanItems) {</span>
<span class="nc" id="L1677">            assertThat(taskPlanItemInstance.getStageInstanceId()).isEqualTo(stagePlanItem.getId());</span>
<span class="nc" id="L1678">        }</span>
        
<span class="nc bnc" id="L1680" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1681">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L1682">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L1683">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L1685">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L1686">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1687">            assertThat(historicPlanItemInstances).hasSize(4);</span>
<span class="nc bnc" id="L1688" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L1689">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1690">            }</span>

<span class="nc" id="L1692">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1693">            assertThat(historicTasks).hasSize(2);</span>
<span class="nc bnc" id="L1694" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L1695">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1696">            }</span>
        }
<span class="nc" id="L1698">    }</span>
    
    @Test
    void terminateListener() {
        // Arrange
<span class="nc" id="L1703">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener.cmmn.xml&quot;);</span>
<span class="nc" id="L1704">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
        
<span class="nc" id="L1706">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1707">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L1708">        assertThat(planItemInstances)</span>
<span class="nc" id="L1709">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1710">                .containsOnly(originalDefinition.getId());</span>
<span class="nc" id="L1711">        assertThat(planItemInstances)</span>
<span class="nc" id="L1712">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L1713">                .containsExactlyInAnyOrder(&quot;humanTask1&quot;, &quot;userEventListener1&quot;);</span>
        
<span class="nc" id="L1715">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L1718">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L1719">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L1720">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;userEventListener1&quot;))</span>
<span class="nc" id="L1721">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L1724">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1725">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1726">                .singleResult();</span>
<span class="nc" id="L1727">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1728">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1729">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L1730">        assertThat(planItemInstances)</span>
<span class="nc" id="L1731">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1732">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L1733">        assertThat(planItemInstances)</span>
<span class="nc" id="L1734">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L1735">                .containsExactlyInAnyOrder(&quot;humanTask1&quot;);</span>
<span class="nc" id="L1736">    }</span>
    
    @Test
    void listenerAndTasksWithoutMapping() {
        // Arrange
<span class="nc" id="L1741">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener.cmmn.xml&quot;);</span>
<span class="nc" id="L1742">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
        
<span class="nc" id="L1744">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1745">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L1746">        assertThat(planItemInstances)</span>
<span class="nc" id="L1747">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1748">                .containsOnly(originalDefinition.getId());</span>
<span class="nc" id="L1749">        assertThat(planItemInstances)</span>
<span class="nc" id="L1750">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L1751">                .containsExactlyInAnyOrder(&quot;humanTask1&quot;, &quot;userEventListener1&quot;);</span>
        
<span class="nc" id="L1753">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener-and-2tasks.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L1756">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L1757">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L1758">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L1761">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1762">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1763">                .singleResult();</span>
<span class="nc" id="L1764">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1765">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1766">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L1767">        assertThat(planItemInstances)</span>
<span class="nc" id="L1768">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1769">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L1770">        assertThat(planItemInstances)</span>
<span class="nc" id="L1771">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L1772">                .containsExactlyInAnyOrder(&quot;humanTask1&quot;, &quot;userEventListener1&quot;);</span>
        
<span class="nc" id="L1774">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L1775">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L1776">    }</span>
    
    @Test
    void listenerAndTasksWithMapping() {
        // Arrange
<span class="nc" id="L1781">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener.cmmn.xml&quot;);</span>
<span class="nc" id="L1782">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
        
<span class="nc" id="L1784">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1785">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L1786">        assertThat(planItemInstances)</span>
<span class="nc" id="L1787">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1788">                .containsOnly(originalDefinition.getId());</span>
<span class="nc" id="L1789">        assertThat(planItemInstances)</span>
<span class="nc" id="L1790">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L1791">                .containsExactlyInAnyOrder(&quot;humanTask1&quot;, &quot;userEventListener1&quot;);</span>
        
<span class="nc" id="L1793">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener-and-2tasks.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L1796">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L1797">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L1798">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask2&quot;))</span>
<span class="nc" id="L1799">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;userEventListener2&quot;))</span>
<span class="nc" id="L1800">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L1803">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1804">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1805">                .singleResult();</span>
<span class="nc" id="L1806">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1807">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1808">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L1809">        assertThat(planItemInstances)</span>
<span class="nc" id="L1810">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1811">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L1812">        assertThat(planItemInstances)</span>
<span class="nc" id="L1813">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L1814">                .containsExactlyInAnyOrder(&quot;humanTask1&quot;, &quot;humanTask2&quot;, &quot;userEventListener1&quot;, &quot;userEventListener2&quot;);</span>
        
<span class="nc" id="L1816">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L1817">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L1818">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L1819">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L1820">    }</span>
    
    @Test
    void listenerAndTaskInStages() {
        // Arrange
<span class="nc" id="L1825">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener-in-stage.cmmn.xml&quot;);</span>
<span class="nc" id="L1826">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
        
<span class="nc" id="L1828">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1829">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L1830">        assertThat(planItemInstances)</span>
<span class="nc" id="L1831">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1832">                .containsOnly(originalDefinition.getId());</span>
<span class="nc" id="L1833">        assertThat(planItemInstances)</span>
<span class="nc" id="L1834">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L1835">                .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;humanTask1&quot;, &quot;userEventListener1&quot;);</span>
        
<span class="nc" id="L1837">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listeners-in-stages.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L1840">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L1841">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L1842">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;expandedStage2&quot;))</span>
<span class="nc" id="L1843">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L1846">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1847">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1848">                .singleResult();</span>
<span class="nc" id="L1849">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1850">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1851">        assertThat(planItemInstances).hasSize(6);</span>
<span class="nc" id="L1852">        assertThat(planItemInstances)</span>
<span class="nc" id="L1853">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1854">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L1855">        assertThat(planItemInstances)</span>
<span class="nc" id="L1856">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L1857">                .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;expandedStage2&quot;, &quot;humanTask1&quot;, &quot;humanTask2&quot;, &quot;userEventListener1&quot;, &quot;userEventListener2&quot;);</span>
        
<span class="nc" id="L1859">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L1860">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L1861">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L1862">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L1863">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L1864">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L1865">    }</span>
    
    @Test
    void listenerAndTaskInStagesWithSentry() {
        // Arrange
<span class="nc" id="L1870">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener-in-stage.cmmn.xml&quot;);</span>
<span class="nc" id="L1871">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
        
<span class="nc" id="L1873">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1874">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L1875">        assertThat(planItemInstances)</span>
<span class="nc" id="L1876">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1877">                .containsOnly(originalDefinition.getId());</span>
<span class="nc" id="L1878">        assertThat(planItemInstances)</span>
<span class="nc" id="L1879">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L1880">                .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;humanTask1&quot;, &quot;userEventListener1&quot;);</span>
        
<span class="nc" id="L1882">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listeners-in-stages-withsentry.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L1885">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L1886">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L1887">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;expandedStage2&quot;))</span>
<span class="nc" id="L1888">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L1891">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1892">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1893">                .singleResult();</span>
<span class="nc" id="L1894">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1895">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1896">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L1897">        assertThat(planItemInstances)</span>
<span class="nc" id="L1898">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1899">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L1900">        assertThat(planItemInstances)</span>
<span class="nc" id="L1901">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L1902">                .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;expandedStage2&quot;, &quot;humanTask1&quot;, &quot;userEventListener1&quot;);</span>
        
<span class="nc" id="L1904">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L1905">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L1906">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L1907">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
        
<span class="nc" id="L1909">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L1910">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;humanTask1&quot;);</span>
<span class="nc" id="L1911">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L1913">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1914">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L1915">        assertThat(planItemInstances)</span>
<span class="nc" id="L1916">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1917">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L1918">        assertThat(planItemInstances)</span>
<span class="nc" id="L1919">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L1920">                .containsExactlyInAnyOrder(&quot;expandedStage2&quot;, &quot;humanTask2&quot;, &quot;userEventListener2&quot;);</span>
        
<span class="nc" id="L1922">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L1923">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L1924">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L1925">    }</span>
    
    @Test
    void listenerAndTaskInStagesWithSentryAndIfPart() {
        // Arrange
<span class="nc" id="L1930">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listeners-in-3stages-withsentry-and-ifpart.cmmn.xml&quot;);</span>
<span class="nc" id="L1931">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
        
<span class="nc" id="L1933">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1934">        assertThat(planItemInstances).hasSize(5);</span>
<span class="nc" id="L1935">        assertThat(planItemInstances)</span>
<span class="nc" id="L1936">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1937">                .containsOnly(originalDefinition.getId());</span>
<span class="nc" id="L1938">        assertThat(planItemInstances)</span>
<span class="nc" id="L1939">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L1940">                .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;expandedStage2&quot;, &quot;expandedStage3&quot;, &quot;humanTask1&quot;, &quot;userEventListener1&quot;);</span>
        
<span class="nc" id="L1942">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listeners-in-stages-withsentry-and-ifpart.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L1945">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L1946">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L1947">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;expandedStage3&quot;))</span>
<span class="nc" id="L1948">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L1951">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1952">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1953">                .singleResult();</span>
<span class="nc" id="L1954">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L1955">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1956">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L1957">        assertThat(planItemInstances)</span>
<span class="nc" id="L1958">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1959">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L1960">        assertThat(planItemInstances)</span>
<span class="nc" id="L1961">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L1962">                .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;expandedStage2&quot;, &quot;humanTask1&quot;, &quot;userEventListener1&quot;);</span>
        
<span class="nc" id="L1964">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L1965">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L1966">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L1967">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
        
<span class="nc" id="L1969">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L1970">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;humanTask1&quot;);</span>
<span class="nc" id="L1971">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L1973">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1974">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L1975">        assertThat(planItemInstances)</span>
<span class="nc" id="L1976">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L1977">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L1978">        assertThat(planItemInstances)</span>
<span class="nc" id="L1979">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L1980">                .containsExactlyInAnyOrder(&quot;expandedStage2&quot;, &quot;humanTask2&quot;, &quot;userEventListener2&quot;);</span>
        
<span class="nc" id="L1982">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L1983">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L1984">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L1985">    }</span>
    
    @Test
    void repetitionListenerAndChangedTask() {
        // Arrange
<span class="nc" id="L1990">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/repetition-with-listener-and-task.cmmn.xml&quot;);</span>
<span class="nc" id="L1991">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L1992">                .caseDefinitionKey(&quot;repetitionTaskCase&quot;)</span>
<span class="nc" id="L1993">                .variable(&quot;exitVar&quot;, &quot;test&quot;)</span>
<span class="nc" id="L1994">                .start();</span>
        
<span class="nc" id="L1996">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L1997">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L1998">        assertThat(planItemInstances)</span>
<span class="nc" id="L1999">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2000">                .containsOnly(originalDefinition.getId());</span>
<span class="nc" id="L2001">        assertThat(planItemInstances)</span>
<span class="nc" id="L2002">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2003">                .containsExactlyInAnyOrder(&quot;userEventListener1&quot;, &quot;repeatableTask&quot;, &quot;cmmnStage1&quot;, &quot;stageTask&quot;);</span>
        
<span class="nc" id="L2005">        UserEventListenerInstance userEventListenerInstance = cmmnRuntimeService.createUserEventListenerInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L2006">        cmmnRuntimeService.completeUserEventListenerInstance(userEventListenerInstance.getId());</span>
        
<span class="nc" id="L2008">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2009">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L2010">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;repeatableTask&quot;).singleResult();</span>
<span class="nc" id="L2011">        assertThat(planItemInstance.getState()).isEqualTo(PlanItemInstanceState.WAITING_FOR_REPETITION);</span>
        
<span class="nc" id="L2013">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/repetition-with-listener-and-changed-task.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L2016">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L2017">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L2018">                .removeWaitingForRepetitionPlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createRemoveWaitingForRepetitionPlanItemDefinitionMappingFor(&quot;repeatableTask&quot;))</span>
<span class="nc" id="L2019">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;changedTask&quot;))</span>
<span class="nc" id="L2020">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;stageTask&quot;))</span>
<span class="nc" id="L2021">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L2024">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L2025">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2026">                .singleResult();</span>
<span class="nc" id="L2027">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2028">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2029">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L2030">        assertThat(planItemInstances)</span>
<span class="nc" id="L2031">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2032">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2033">        assertThat(planItemInstances)</span>
<span class="nc" id="L2034">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2035">                .containsExactlyInAnyOrder(&quot;userEventListener1&quot;, &quot;changedTask&quot;);</span>
        
<span class="nc" id="L2037">        userEventListenerInstance = cmmnRuntimeService.createUserEventListenerInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L2038">        cmmnRuntimeService.completeUserEventListenerInstance(userEventListenerInstance.getId());</span>
<span class="nc" id="L2039">    }</span>
    
    @Test
    void activateNewStageWithSentry() {
        // Arrange
<span class="nc" id="L2044">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener-in-stage.cmmn.xml&quot;);</span>
<span class="nc" id="L2045">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
        
<span class="nc" id="L2047">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2048">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L2049">        assertThat(planItemInstances)</span>
<span class="nc" id="L2050">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2051">                .containsOnly(originalDefinition.getId());</span>
<span class="nc" id="L2052">        assertThat(planItemInstances)</span>
<span class="nc" id="L2053">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2054">                .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;humanTask1&quot;, &quot;userEventListener1&quot;);</span>
        
<span class="nc" id="L2056">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listeners-in-stages-withsentry.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L2059">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L2060">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L2061">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;humanTask1&quot;))</span>
<span class="nc" id="L2062">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;userEventListener1&quot;))</span>
<span class="nc" id="L2063">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;expandedStage1&quot;))</span>
<span class="nc" id="L2064">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;expandedStage2&quot;))</span>
<span class="nc" id="L2065">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L2068">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L2069">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2070">                .singleResult();</span>
<span class="nc" id="L2071">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2072">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2073">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L2074">        assertThat(planItemInstances)</span>
<span class="nc" id="L2075">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2076">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2077">        assertThat(planItemInstances)</span>
<span class="nc" id="L2078">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2079">                .containsExactlyInAnyOrder(&quot;expandedStage2&quot;, &quot;humanTask2&quot;, &quot;userEventListener2&quot;);</span>
        
<span class="nc" id="L2081">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2082">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L2083">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L2085">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L2086">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;humanTask2&quot;);</span>
<span class="nc" id="L2087">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L2089">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list()).hasSize(0);</span>
<span class="nc" id="L2090">    }</span>
    
    @Test
    void terminateExistingActiveStateActivateNewOtherState() {
        // Arrange
<span class="nc" id="L2095">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener-in-stage.cmmn.xml&quot;);</span>
<span class="nc" id="L2096">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
        
<span class="nc" id="L2098">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2099">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L2100">        assertThat(planItemInstances)</span>
<span class="nc" id="L2101">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2102">                .containsOnly(originalDefinition.getId());</span>
<span class="nc" id="L2103">        assertThat(planItemInstances)</span>
<span class="nc" id="L2104">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2105">                .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;humanTask1&quot;, &quot;userEventListener1&quot;);</span>
        
<span class="nc" id="L2107">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/another-listener-in-stage.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L2110">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L2111">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L2112">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;humanTask1&quot;))</span>
<span class="nc" id="L2113">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;userEventListener1&quot;))</span>
<span class="nc" id="L2114">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;expandedStage1&quot;))</span>
<span class="nc" id="L2115">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;expandedStage2&quot;))</span>
<span class="nc" id="L2116">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L2119">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L2120">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2121">                .singleResult();</span>
<span class="nc" id="L2122">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2123">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2124">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L2125">        assertThat(planItemInstances)</span>
<span class="nc" id="L2126">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2127">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2128">        assertThat(planItemInstances)</span>
<span class="nc" id="L2129">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2130">                .containsExactlyInAnyOrder(&quot;expandedStage2&quot;, &quot;humanTask2&quot;, &quot;userEventListener2&quot;);</span>
        
<span class="nc" id="L2132">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2133">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L2134">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L2136">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask1&quot;).count()).isZero();</span>
<span class="nc" id="L2137">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask2&quot;).count()).isEqualTo(1);</span>
        
<span class="nc" id="L2139">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L2140">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;humanTask2&quot;);</span>
<span class="nc" id="L2141">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L2143">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list()).hasSize(0);</span>
        
<span class="nc bnc" id="L2145" title="All 2 branches missed.">        if (!cmmnEngineConfiguration.isAsyncHistoryEnabled()) {</span>
<span class="nc" id="L2146">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2147">            assertThat(historicPlanItemInstances).hasSize(6);</span>
<span class="nc" id="L2148">            assertThat(historicPlanItemInstances)</span>
<span class="nc" id="L2149">                    .extracting(HistoricPlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2150">                    .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2151">            assertThat(historicPlanItemInstances)</span>
<span class="nc" id="L2152">                    .extracting(HistoricPlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2153">                    .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;humanTask1&quot;, &quot;userEventListener1&quot;, &quot;expandedStage2&quot;, &quot;humanTask2&quot;, &quot;userEventListener2&quot;);</span>
            
<span class="nc" id="L2155">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;humanTask1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.TERMINATED);</span>
<span class="nc" id="L2156">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;userEventListener1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.TERMINATED);</span>
<span class="nc" id="L2157">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;expandedStage1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.TERMINATED);</span>
<span class="nc" id="L2158">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;humanTask2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.COMPLETED);</span>
<span class="nc" id="L2159">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;userEventListener2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.TERMINATED);</span>
<span class="nc" id="L2160">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;expandedStage2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.COMPLETED);</span>
        }
<span class="nc" id="L2162">    }</span>
    
    @Test
    void listenerAndTaskInStagesWithCompletedRootTask() {
        // Arrange
<span class="nc" id="L2167">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listeners-in-stages-and-root-task.cmmn.xml&quot;);</span>
<span class="nc" id="L2168">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
        
<span class="nc" id="L2170">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2171">        assertThat(planItemInstances).hasSize(7);</span>
<span class="nc" id="L2172">        assertThat(planItemInstances)</span>
<span class="nc" id="L2173">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2174">                .containsOnly(originalDefinition.getId());</span>
<span class="nc" id="L2175">        assertThat(planItemInstances)</span>
<span class="nc" id="L2176">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2177">                .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;expandedStage2&quot;, &quot;humanTask1&quot;, &quot;humanTask2&quot;, &quot;userEventListener1&quot;, &quot;userEventListener2&quot;, &quot;rootTask&quot;);</span>
        
<span class="nc" id="L2179">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;rootTask&quot;).singleResult();</span>
<span class="nc" id="L2180">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L2182">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listeners-in-stages.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L2185">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L2186">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L2187">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L2190">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L2191">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2192">                .singleResult();</span>
<span class="nc" id="L2193">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2194">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2195">        assertThat(planItemInstances).hasSize(6);</span>
<span class="nc" id="L2196">        assertThat(planItemInstances)</span>
<span class="nc" id="L2197">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2198">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2199">        assertThat(planItemInstances)</span>
<span class="nc" id="L2200">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2201">                .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;expandedStage2&quot;, &quot;humanTask1&quot;, &quot;humanTask2&quot;, &quot;userEventListener1&quot;, &quot;userEventListener2&quot;);</span>
        
<span class="nc" id="L2203">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2204">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2205">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L2206">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2207">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2208">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
        
<span class="nc" id="L2210">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask1&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2211">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask2&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2212">    }</span>
    
    @Test
    void repetitionInMigratedStage() {
        // Arrange
<span class="nc" id="L2217">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener-in-stage-userlistener.cmmn.xml&quot;);</span>
<span class="nc" id="L2218">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
        
<span class="nc" id="L2220">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2221">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L2222">        assertThat(planItemInstances)</span>
<span class="nc" id="L2223">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2224">                .containsOnly(originalDefinition.getId());</span>
<span class="nc" id="L2225">        assertThat(planItemInstances)</span>
<span class="nc" id="L2226">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2227">                .containsExactlyInAnyOrder(&quot;userEventListener1&quot;, &quot;expandedStage1&quot;);</span>
        
<span class="nc" id="L2229">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener-in-stage-repetition.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L2232">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L2233">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L2234">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L2237">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L2238">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2239">                .singleResult();</span>
<span class="nc" id="L2240">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2241">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2242">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L2243">        assertThat(planItemInstances)</span>
<span class="nc" id="L2244">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2245">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2246">        assertThat(planItemInstances)</span>
<span class="nc" id="L2247">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2248">                .containsExactlyInAnyOrder(&quot;userEventListener1&quot;, &quot;expandedStage1&quot;);</span>
        
<span class="nc" id="L2250">        cmmnRuntimeService.completeUserEventListenerInstance(</span>
<span class="nc" id="L2251">                cmmnRuntimeService.createUserEventListenerInstanceQuery()</span>
<span class="nc" id="L2252">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2253">                    .singleResult().getId());</span>
        
<span class="nc" id="L2255">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2256">        assertThat(planItemInstances).hasSize(5);</span>
<span class="nc" id="L2257">        assertThat(planItemInstances)</span>
<span class="nc" id="L2258">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2259">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2260">        assertThat(planItemInstances)</span>
<span class="nc" id="L2261">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2262">                .containsExactlyInAnyOrder(&quot;userEventListener1&quot;, &quot;expandedStage1&quot;, &quot;expandedStage1&quot;, &quot;humanTask1&quot;, &quot;userEventListener2&quot;);</span>
        
<span class="nc" id="L2264">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L2265">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2266">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L2267">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage1&quot;).planItemInstanceState(PlanItemInstanceState.WAITING_FOR_REPETITION).count()).isEqualTo(1);</span>
<span class="nc" id="L2268">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage1&quot;).planItemInstanceState(PlanItemInstanceState.ACTIVE).count()).isEqualTo(1);</span>
        
<span class="nc" id="L2270">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L2271">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L2273">        cmmnRuntimeService.completeUserEventListenerInstance(</span>
<span class="nc" id="L2274">                cmmnRuntimeService.createUserEventListenerInstanceQuery()</span>
<span class="nc" id="L2275">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2276">                    .singleResult().getId());</span>
        
<span class="nc" id="L2278">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2279">        assertThat(planItemInstances).hasSize(5);</span>
<span class="nc" id="L2280">        assertThat(planItemInstances)</span>
<span class="nc" id="L2281">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2282">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2283">        assertThat(planItemInstances)</span>
<span class="nc" id="L2284">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2285">                .containsExactlyInAnyOrder(&quot;userEventListener1&quot;, &quot;expandedStage1&quot;, &quot;expandedStage1&quot;, &quot;humanTask1&quot;, &quot;userEventListener2&quot;);</span>
        
<span class="nc" id="L2287">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L2288">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2289">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L2290">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage1&quot;).planItemInstanceState(PlanItemInstanceState.WAITING_FOR_REPETITION).count()).isEqualTo(1);</span>
<span class="nc" id="L2291">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage1&quot;).planItemInstanceState(PlanItemInstanceState.ACTIVE).count()).isEqualTo(1);</span>
<span class="nc" id="L2292">    }</span>
    
    @Test
    void repetitionInActiveStage() {
        // Arrange
<span class="nc" id="L2297">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener-in-stage-userlistener.cmmn.xml&quot;);</span>
<span class="nc" id="L2298">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
        
<span class="nc" id="L2300">        cmmnRuntimeService.completeUserEventListenerInstance(</span>
<span class="nc" id="L2301">                cmmnRuntimeService.createUserEventListenerInstanceQuery()</span>
<span class="nc" id="L2302">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2303">                    .singleResult().getId());</span>
        
<span class="nc" id="L2305">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2306">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L2307">        assertThat(planItemInstances)</span>
<span class="nc" id="L2308">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2309">                .containsOnly(originalDefinition.getId());</span>
<span class="nc" id="L2310">        assertThat(planItemInstances)</span>
<span class="nc" id="L2311">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2312">                .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;userEventListener2&quot;, &quot;humanTask1&quot;);</span>
        
<span class="nc" id="L2314">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener-in-stage-repetition.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L2317">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L2318">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L2319">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;userEventListener1&quot;))</span>
<span class="nc" id="L2320">                .addWaitingForRepetitionPlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createWaitingForRepetitionPlanItemDefinitionMappingFor(&quot;expandedStage1&quot;))</span>
<span class="nc" id="L2321">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L2324">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L2325">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2326">                .singleResult();</span>
<span class="nc" id="L2327">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2328">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2329">        assertThat(planItemInstances).hasSize(5);</span>
<span class="nc" id="L2330">        assertThat(planItemInstances)</span>
<span class="nc" id="L2331">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2332">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2333">        assertThat(planItemInstances)</span>
<span class="nc" id="L2334">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2335">                .containsExactlyInAnyOrder(&quot;userEventListener1&quot;, &quot;expandedStage1&quot;, &quot;expandedStage1&quot;, &quot;userEventListener2&quot;, &quot;humanTask1&quot;);</span>
        
<span class="nc bnc" id="L2337" title="All 2 branches missed.">        if (!cmmnEngineConfiguration.isAsyncHistoryEnabled()) {</span>
<span class="nc" id="L2338">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2339">            assertThat(historicPlanItemInstances).hasSize(6);</span>
<span class="nc" id="L2340">            assertThat(historicPlanItemInstances)</span>
<span class="nc" id="L2341">                    .extracting(HistoricPlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2342">                    .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2343">            assertThat(historicPlanItemInstances)</span>
<span class="nc" id="L2344">                    .extracting(HistoricPlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2345">                    .containsExactlyInAnyOrder(&quot;userEventListener1&quot;, &quot;userEventListener1&quot;, &quot;expandedStage1&quot;, &quot;expandedStage1&quot;, &quot;userEventListener2&quot;, &quot;humanTask1&quot;);</span>
            
<span class="nc" id="L2347">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;userEventListener1&quot;).planItemInstanceState(PlanItemInstanceState.COMPLETED).singleResult().getState()).isEqualTo(PlanItemInstanceState.COMPLETED);</span>
<span class="nc" id="L2348">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;userEventListener1&quot;).planItemInstanceState(PlanItemInstanceState.AVAILABLE).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L2349">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;humanTask1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2350">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;expandedStage1&quot;).planItemInstanceState(PlanItemInstanceState.ACTIVE).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2351">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;expandedStage1&quot;).planItemInstanceState(PlanItemInstanceState.WAITING_FOR_REPETITION).singleResult().getState()).isEqualTo(PlanItemInstanceState.WAITING_FOR_REPETITION);</span>
<span class="nc" id="L2352">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;userEventListener2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
        }
        
<span class="nc" id="L2355">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L2356">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L2358">        cmmnRuntimeService.completeUserEventListenerInstance(</span>
<span class="nc" id="L2359">                cmmnRuntimeService.createUserEventListenerInstanceQuery()</span>
<span class="nc" id="L2360">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2361">                    .singleResult().getId());</span>
        
<span class="nc" id="L2363">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2364">        assertThat(planItemInstances).hasSize(5);</span>
<span class="nc" id="L2365">        assertThat(planItemInstances)</span>
<span class="nc" id="L2366">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2367">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2368">        assertThat(planItemInstances)</span>
<span class="nc" id="L2369">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2370">                .containsExactlyInAnyOrder(&quot;userEventListener1&quot;, &quot;expandedStage1&quot;, &quot;expandedStage1&quot;, &quot;humanTask1&quot;, &quot;userEventListener2&quot;);</span>
        
<span class="nc" id="L2372">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L2373">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2374">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L2375">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage1&quot;).planItemInstanceState(PlanItemInstanceState.WAITING_FOR_REPETITION).count()).isEqualTo(1);</span>
<span class="nc" id="L2376">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage1&quot;).planItemInstanceState(PlanItemInstanceState.ACTIVE).count()).isEqualTo(1);</span>
<span class="nc" id="L2377">    }</span>
    
    @Test
    void repetitionInCompletedStage() {
        // Arrange
<span class="nc" id="L2382">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/task-and-listener-in-stage-userlistener.cmmn.xml&quot;);</span>
<span class="nc" id="L2383">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
        
<span class="nc" id="L2385">        cmmnRuntimeService.completeUserEventListenerInstance(</span>
<span class="nc" id="L2386">                cmmnRuntimeService.createUserEventListenerInstanceQuery()</span>
<span class="nc" id="L2387">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2388">                    .singleResult().getId());</span>
        
<span class="nc" id="L2390">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask1&quot;).singleResult();</span>
<span class="nc" id="L2391">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L2393">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2394">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L2395">        assertThat(planItemInstances)</span>
<span class="nc" id="L2396">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2397">                .containsOnly(originalDefinition.getId());</span>
<span class="nc" id="L2398">        assertThat(planItemInstances)</span>
<span class="nc" id="L2399">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2400">                .containsExactlyInAnyOrder(&quot;rootTask&quot;);</span>
        
<span class="nc" id="L2402">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/task-and-listener-in-stage-repetition.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L2405">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L2406">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L2407">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;userEventListener1&quot;))</span>
<span class="nc" id="L2408">                .addWaitingForRepetitionPlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createWaitingForRepetitionPlanItemDefinitionMappingFor(&quot;expandedStage1&quot;))</span>
<span class="nc" id="L2409">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L2412">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L2413">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2414">                .singleResult();</span>
<span class="nc" id="L2415">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2416">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2417">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L2418">        assertThat(planItemInstances)</span>
<span class="nc" id="L2419">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2420">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2421">        assertThat(planItemInstances)</span>
<span class="nc" id="L2422">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2423">                .containsExactlyInAnyOrder(&quot;userEventListener1&quot;, &quot;expandedStage1&quot;, &quot;rootTask&quot;);</span>
        
<span class="nc" id="L2425">        cmmnRuntimeService.completeUserEventListenerInstance(</span>
<span class="nc" id="L2426">                cmmnRuntimeService.createUserEventListenerInstanceQuery()</span>
<span class="nc" id="L2427">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2428">                    .singleResult().getId());</span>
        
<span class="nc" id="L2430">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2431">        assertThat(planItemInstances).hasSize(6);</span>
<span class="nc" id="L2432">        assertThat(planItemInstances)</span>
<span class="nc" id="L2433">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2434">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2435">        assertThat(planItemInstances)</span>
<span class="nc" id="L2436">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2437">                .containsExactlyInAnyOrder(&quot;userEventListener1&quot;, &quot;expandedStage1&quot;, &quot;expandedStage1&quot;, &quot;humanTask1&quot;, &quot;userEventListener2&quot;, &quot;rootTask&quot;);</span>
        
<span class="nc" id="L2439">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L2440">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2441">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L2442">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage1&quot;).planItemInstanceState(PlanItemInstanceState.WAITING_FOR_REPETITION).count()).isEqualTo(1);</span>
<span class="nc" id="L2443">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage1&quot;).planItemInstanceState(PlanItemInstanceState.ACTIVE).count()).isEqualTo(1);</span>
<span class="nc" id="L2444">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;rootTask&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L2446">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask1&quot;).singleResult();</span>
<span class="nc" id="L2447">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L2449">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2450">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L2451">        assertThat(planItemInstances)</span>
<span class="nc" id="L2452">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2453">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2454">        assertThat(planItemInstances)</span>
<span class="nc" id="L2455">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2456">                .containsExactlyInAnyOrder(&quot;userEventListener1&quot;, &quot;expandedStage1&quot;, &quot;rootTask&quot;);</span>
        
<span class="nc" id="L2458">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L2459">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;rootTask&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2460">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage1&quot;).planItemInstanceState(PlanItemInstanceState.WAITING_FOR_REPETITION).count()).isEqualTo(1);</span>
<span class="nc" id="L2461">    }</span>
    
    @Test
    void removeActiveStageWithRepetition() {
        // Arrange
<span class="nc" id="L2466">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/task-and-listener-in-stage-repetition.cmmn.xml&quot;);</span>
<span class="nc" id="L2467">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
        
<span class="nc" id="L2469">        cmmnRuntimeService.completeUserEventListenerInstance(</span>
<span class="nc" id="L2470">                cmmnRuntimeService.createUserEventListenerInstanceQuery()</span>
<span class="nc" id="L2471">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2472">                    .singleResult().getId());</span>
        
<span class="nc" id="L2474">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2475">        assertThat(planItemInstances).hasSize(6);</span>
<span class="nc" id="L2476">        assertThat(planItemInstances)</span>
<span class="nc" id="L2477">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2478">                .containsOnly(originalDefinition.getId());</span>
<span class="nc" id="L2479">        assertThat(planItemInstances)</span>
<span class="nc" id="L2480">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2481">                .containsExactlyInAnyOrder(&quot;userEventListener1&quot;, &quot;expandedStage1&quot;, &quot;expandedStage1&quot;, &quot;humanTask1&quot;, &quot;userEventListener2&quot;, &quot;rootTask&quot;);</span>
        
<span class="nc" id="L2483">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/task-and-listener.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L2486">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L2487">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L2488">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;expandedStage1&quot;))</span>
<span class="nc" id="L2489">                .removeWaitingForRepetitionPlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createRemoveWaitingForRepetitionPlanItemDefinitionMappingFor(&quot;expandedStage1&quot;))</span>
<span class="nc" id="L2490">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L2493">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L2494">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2495">                .singleResult();</span>
<span class="nc" id="L2496">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2497">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2498">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L2499">        assertThat(planItemInstances)</span>
<span class="nc" id="L2500">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2501">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2502">        assertThat(planItemInstances)</span>
<span class="nc" id="L2503">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2504">                .containsExactlyInAnyOrder(&quot;userEventListener1&quot;, &quot;rootTask&quot;);</span>
        
<span class="nc bnc" id="L2506" title="All 2 branches missed.">        if (!cmmnEngineConfiguration.isAsyncHistoryEnabled()) {</span>
<span class="nc" id="L2507">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2508">            assertThat(historicPlanItemInstances).hasSize(7);</span>
<span class="nc" id="L2509">            assertThat(historicPlanItemInstances)</span>
<span class="nc" id="L2510">                    .extracting(HistoricPlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2511">                    .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2512">            assertThat(historicPlanItemInstances)</span>
<span class="nc" id="L2513">                    .extracting(HistoricPlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2514">                    .containsExactlyInAnyOrder(&quot;userEventListener1&quot;, &quot;userEventListener1&quot;, &quot;expandedStage1&quot;, &quot;expandedStage1&quot;, &quot;humanTask1&quot;, &quot;userEventListener2&quot;, &quot;rootTask&quot;);</span>
            
<span class="nc" id="L2516">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;userEventListener1&quot;).planItemInstanceState(PlanItemInstanceState.COMPLETED).singleResult().getState()).isEqualTo(PlanItemInstanceState.COMPLETED);</span>
<span class="nc" id="L2517">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;userEventListener1&quot;).planItemInstanceState(PlanItemInstanceState.AVAILABLE).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L2518">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;humanTask1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.TERMINATED);</span>
<span class="nc" id="L2519">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;expandedStage1&quot;).planItemInstanceState(PlanItemInstanceState.TERMINATED).count()).isEqualTo(2);</span>
<span class="nc" id="L2520">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;userEventListener2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.TERMINATED);</span>
<span class="nc" id="L2521">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;rootTask&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
        }
        
<span class="nc" id="L2524">        cmmnRuntimeService.completeUserEventListenerInstance(</span>
<span class="nc" id="L2525">                cmmnRuntimeService.createUserEventListenerInstanceQuery()</span>
<span class="nc" id="L2526">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2527">                    .singleResult().getId());</span>
        
<span class="nc" id="L2529">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2530">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L2531">        assertThat(planItemInstances)</span>
<span class="nc" id="L2532">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2533">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2534">        assertThat(planItemInstances)</span>
<span class="nc" id="L2535">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2536">                .containsExactlyInAnyOrder(&quot;userEventListener1&quot;, &quot;rootTask&quot;);</span>
<span class="nc" id="L2537">    }</span>
    
    @Test
    void removeEventListenerWithRepetitionFromActiveStage() {
        // Arrange
<span class="nc" id="L2542">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener-in-stage-with-repetition-eventlistener.cmmn.xml&quot;);</span>
<span class="nc" id="L2543">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
        
<span class="nc" id="L2545">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2546">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L2547">        assertThat(planItemInstances)</span>
<span class="nc" id="L2548">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2549">                .containsOnly(originalDefinition.getId());</span>
<span class="nc" id="L2550">        assertThat(planItemInstances)</span>
<span class="nc" id="L2551">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2552">                .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;userEventListener1&quot;, &quot;humanTask1&quot;, &quot;eventListener1&quot;);</span>
        
<span class="nc" id="L2554">        EventSubscription eventSubscription = cmmnRuntimeService.createEventSubscriptionQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L2555">        assertThat(eventSubscription).isNotNull();</span>
<span class="nc" id="L2556">        assertThat(eventSubscription.getScopeId()).isEqualTo(caseInstance.getId());</span>
<span class="nc" id="L2557">        assertThat(eventSubscription.getEventType()).isEqualTo(&quot;TEST_E001&quot;);</span>
        
<span class="nc" id="L2559">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener-in-stage.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L2562">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L2563">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L2564">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;eventListener1&quot;))</span>
<span class="nc" id="L2565">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L2568">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L2569">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2570">                .singleResult();</span>
<span class="nc" id="L2571">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2572">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2573">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L2574">        assertThat(planItemInstances)</span>
<span class="nc" id="L2575">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2576">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2577">        assertThat(planItemInstances)</span>
<span class="nc" id="L2578">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2579">                .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;userEventListener1&quot;, &quot;humanTask1&quot;);</span>
        
<span class="nc" id="L2581">        assertThat(cmmnRuntimeService.createEventSubscriptionQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(0);</span>
<span class="nc" id="L2582">    }</span>
    
    @Test
    void addNewTaskInAdditionToNewStage() {
        // Arrange
<span class="nc" id="L2587">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener-in-stage.cmmn.xml&quot;);</span>
<span class="nc" id="L2588">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
        
<span class="nc" id="L2590">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2591">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L2592">        assertThat(planItemInstances)</span>
<span class="nc" id="L2593">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2594">                .containsOnly(originalDefinition.getId());</span>
<span class="nc" id="L2595">        assertThat(planItemInstances)</span>
<span class="nc" id="L2596">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2597">                .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;humanTask1&quot;, &quot;userEventListener1&quot;);</span>
        
<span class="nc" id="L2599">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener-in-stage-with-new-tasks.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L2602">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L2603">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L2604">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;newTask2&quot;))</span>
<span class="nc" id="L2605">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L2608">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L2609">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2610">                .singleResult();</span>
<span class="nc" id="L2611">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2612">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2613">        assertThat(planItemInstances).hasSize(5);</span>
<span class="nc" id="L2614">        assertThat(planItemInstances)</span>
<span class="nc" id="L2615">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2616">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2617">        assertThat(planItemInstances)</span>
<span class="nc" id="L2618">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2619">                .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;humanTask1&quot;, &quot;userEventListener1&quot;, &quot;newExpandedStage&quot;, &quot;newSubTask&quot;);</span>
        
<span class="nc" id="L2621">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2622">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2623">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L2624">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;newExpandedStage&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2625">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;newSubTask&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc bnc" id="L2627" title="All 2 branches missed.">        if (!cmmnEngineConfiguration.isAsyncHistoryEnabled()) {</span>
<span class="nc" id="L2628">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2629">            assertThat(historicPlanItemInstances).hasSize(6);</span>
<span class="nc" id="L2630">            assertThat(historicPlanItemInstances)</span>
<span class="nc" id="L2631">                    .extracting(HistoricPlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2632">                    .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2633">            assertThat(historicPlanItemInstances)</span>
<span class="nc" id="L2634">                    .extracting(HistoricPlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2635">                    .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;humanTask1&quot;, &quot;userEventListener1&quot;, &quot;newExpandedStage&quot;, &quot;newSubTask&quot;, &quot;newTask2&quot;);</span>
            
<span class="nc" id="L2637">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;expandedStage1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2638">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;userEventListener1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L2639">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;humanTask1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2640">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;newExpandedStage&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2641">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;newSubTask&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2642">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;newTask2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.COMPLETED);</span>
        }
<span class="nc" id="L2644">    }</span>
    
    @Test
    void addNewTasksInAdditionToNewStage() {
        // Arrange
<span class="nc" id="L2649">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener-in-stage.cmmn.xml&quot;);</span>
<span class="nc" id="L2650">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
        
<span class="nc" id="L2652">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2653">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L2654">        assertThat(planItemInstances)</span>
<span class="nc" id="L2655">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2656">                .containsOnly(originalDefinition.getId());</span>
<span class="nc" id="L2657">        assertThat(planItemInstances)</span>
<span class="nc" id="L2658">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2659">                .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;humanTask1&quot;, &quot;userEventListener1&quot;);</span>
        
<span class="nc" id="L2661">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener-in-stage-with-new-tasks.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L2664">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L2665">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L2666">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;newTask&quot;))</span>
<span class="nc" id="L2667">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;newTask2&quot;))</span>
<span class="nc" id="L2668">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L2671">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L2672">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2673">                .singleResult();</span>
<span class="nc" id="L2674">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2675">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2676">        assertThat(planItemInstances).hasSize(5);</span>
<span class="nc" id="L2677">        assertThat(planItemInstances)</span>
<span class="nc" id="L2678">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2679">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2680">        assertThat(planItemInstances)</span>
<span class="nc" id="L2681">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2682">                .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;humanTask1&quot;, &quot;userEventListener1&quot;, &quot;newExpandedStage&quot;, &quot;newSubTask&quot;);</span>
        
<span class="nc" id="L2684">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2685">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2686">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L2687">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;newExpandedStage&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2688">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;newSubTask&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc bnc" id="L2690" title="All 2 branches missed.">        if (!cmmnEngineConfiguration.isAsyncHistoryEnabled()) {</span>
<span class="nc" id="L2691">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2692">            assertThat(historicPlanItemInstances).hasSize(7);</span>
<span class="nc" id="L2693">            assertThat(historicPlanItemInstances)</span>
<span class="nc" id="L2694">                    .extracting(HistoricPlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2695">                    .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2696">            assertThat(historicPlanItemInstances)</span>
<span class="nc" id="L2697">                    .extracting(HistoricPlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2698">                    .containsExactlyInAnyOrder(&quot;expandedStage1&quot;, &quot;humanTask1&quot;, &quot;userEventListener1&quot;, &quot;newExpandedStage&quot;, &quot;newSubTask&quot;, &quot;newTask&quot;, &quot;newTask2&quot;);</span>
            
<span class="nc" id="L2700">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;expandedStage1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2701">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;userEventListener1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L2702">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;humanTask1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2703">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;newExpandedStage&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2704">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;newSubTask&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2705">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;newTask&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.COMPLETED);</span>
<span class="nc" id="L2706">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).planItemInstanceDefinitionId(&quot;newTask2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.COMPLETED);</span>
        }
<span class="nc" id="L2708">    }</span>
    
    @Test
    void addSentryForNewTaskInActiveStageWithRepetition() {
        // Arrange
<span class="nc" id="L2713">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener-in-stage-repetition.cmmn.xml&quot;);</span>
<span class="nc" id="L2714">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
        
<span class="nc" id="L2716">        cmmnRuntimeService.completeUserEventListenerInstance(</span>
<span class="nc" id="L2717">                cmmnRuntimeService.createUserEventListenerInstanceQuery()</span>
<span class="nc" id="L2718">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2719">                    .singleResult().getId());</span>
        
<span class="nc" id="L2721">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2722">        assertThat(planItemInstances).hasSize(5);</span>
<span class="nc" id="L2723">        assertThat(planItemInstances)</span>
<span class="nc" id="L2724">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2725">                .containsOnly(originalDefinition.getId());</span>
<span class="nc" id="L2726">        assertThat(planItemInstances)</span>
<span class="nc" id="L2727">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2728">                .containsExactlyInAnyOrder(&quot;userEventListener1&quot;, &quot;expandedStage1&quot;, &quot;expandedStage1&quot;, &quot;humanTask1&quot;, &quot;userEventListener2&quot;);</span>
        
<span class="nc" id="L2730">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/listener-and-2tasks-in-stage-repetition.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L2733">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L2734">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L2735">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;humanTask2&quot;))</span>
<span class="nc" id="L2736">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L2739">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L2740">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2741">                .singleResult();</span>
<span class="nc" id="L2742">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2743">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2744">        assertThat(planItemInstances).hasSize(6);</span>
<span class="nc" id="L2745">        assertThat(planItemInstances)</span>
<span class="nc" id="L2746">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2747">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2748">        assertThat(planItemInstances)</span>
<span class="nc" id="L2749">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2750">                .containsExactlyInAnyOrder(&quot;userEventListener1&quot;, &quot;expandedStage1&quot;, &quot;expandedStage1&quot;, &quot;humanTask1&quot;, &quot;userEventListener2&quot;, &quot;humanTask2&quot;);</span>
        
<span class="nc" id="L2752">        cmmnRuntimeService.completeUserEventListenerInstance(</span>
<span class="nc" id="L2753">                cmmnRuntimeService.createUserEventListenerInstanceQuery()</span>
<span class="nc" id="L2754">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2755">                    .planItemDefinitionId(&quot;userEventListener2&quot;)</span>
<span class="nc" id="L2756">                    .singleResult().getId());</span>
        
<span class="nc" id="L2758">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2759">        assertThat(planItemInstances).hasSize(5);</span>
<span class="nc" id="L2760">        assertThat(planItemInstances)</span>
<span class="nc" id="L2761">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2762">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2763">        assertThat(planItemInstances)</span>
<span class="nc" id="L2764">                .extracting(PlanItemInstance::getPlanItemDefinitionId)</span>
<span class="nc" id="L2765">                .containsExactlyInAnyOrder(&quot;userEventListener1&quot;, &quot;expandedStage1&quot;, &quot;expandedStage1&quot;, &quot;humanTask1&quot;, &quot;humanTask2&quot;);</span>
        
<span class="nc" id="L2767">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;userEventListener1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L2768">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask1&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2769">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;humanTask2&quot;).singleResult().getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L2770">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage1&quot;).planItemInstanceState(PlanItemInstanceState.WAITING_FOR_REPETITION).count()).isEqualTo(1);</span>
<span class="nc" id="L2771">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;expandedStage1&quot;).planItemInstanceState(PlanItemInstanceState.ACTIVE).count()).isEqualTo(1);</span>
        
<span class="nc" id="L2773">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask2&quot;).singleResult();</span>
<span class="nc" id="L2774">        assertThat(task).isNotNull();</span>
<span class="nc" id="L2775">    }</span>
    
    @Test
    void testMultiTenantCaseInstanceMigrationWithDefaultTenantDefinition() {
<span class="nc" id="L2779">        DefaultTenantProvider originalDefaultTenantValue = cmmnEngineConfiguration.getDefaultTenantProvider();</span>
<span class="nc" id="L2780">        cmmnEngineConfiguration.setDefaultTenantValue(&quot;default&quot;);</span>
<span class="nc" id="L2781">        cmmnEngineConfiguration.setFallbackToDefaultTenant(true);</span>
        
        try {
            // Arrange
<span class="nc" id="L2785">            CmmnDeployment deployment = cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L2786">                    .name(&quot;my deploy&quot;)</span>
<span class="nc" id="L2787">                    .addClasspathResource(&quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;)</span>
<span class="nc" id="L2788">                    .tenantId(&quot;default&quot;)</span>
<span class="nc" id="L2789">                    .deploy();</span>
            
<span class="nc" id="L2791">            CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L2792">                    .caseDefinitionKey(&quot;testCase&quot;)</span>
<span class="nc" id="L2793">                    .tenantId(&quot;tenant1&quot;)</span>
<span class="nc" id="L2794">                    .start();</span>
            
<span class="nc" id="L2796">            deployment = cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L2797">                    .name(&quot;my deploy&quot;)</span>
<span class="nc" id="L2798">                    .addClasspathResource(&quot;org/flowable/cmmn/test/migration/two-task.cmmn.xml&quot;)</span>
<span class="nc" id="L2799">                    .tenantId(&quot;default&quot;)</span>
<span class="nc" id="L2800">                    .deploy();</span>
            
<span class="nc" id="L2802">            CaseDefinition destinationDefinition = cmmnRepositoryService.createCaseDefinitionQuery().deploymentId(deployment.getId()).singleResult();</span>
    
            // Act
<span class="nc" id="L2805">            cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L2806">                    .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L2807">                    .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask2&quot;))</span>
<span class="nc" id="L2808">                    .migrate(caseInstance.getId());</span>
    
            // Assert
<span class="nc" id="L2811">            CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L2812">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2813">                    .singleResult();</span>
<span class="nc" id="L2814">            assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2815">            assertThat(caseInstanceAfterMigration.getCaseDefinitionKey()).isEqualTo(&quot;testCase&quot;);</span>
<span class="nc" id="L2816">            assertThat(caseInstanceAfterMigration.getCaseDefinitionName()).isEqualTo(&quot;Two Task Test Case&quot;);</span>
<span class="nc" id="L2817">            assertThat(caseInstanceAfterMigration.getCaseDefinitionVersion()).isEqualTo(2);</span>
<span class="nc" id="L2818">            assertThat(caseInstanceAfterMigration.getCaseDefinitionDeploymentId()).isEqualTo(destinationDefinition.getDeploymentId());</span>
<span class="nc" id="L2819">            List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L2820">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2821">                    .list();</span>
<span class="nc" id="L2822">            assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L2823">            assertThat(planItemInstances)</span>
<span class="nc" id="L2824">                    .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2825">                    .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2826">            assertThat(planItemInstances)</span>
<span class="nc" id="L2827">                    .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L2828">                    .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;);</span>
<span class="nc" id="L2829">            assertThat(planItemInstances)</span>
<span class="nc" id="L2830">                    .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L2831">                    .containsOnly(PlanItemInstanceState.ACTIVE);</span>
            
<span class="nc" id="L2833">            List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2834">            assertThat(tasks).hasSize(2);</span>
<span class="nc bnc" id="L2835" title="All 2 branches missed.">            for (Task task : tasks) {</span>
<span class="nc" id="L2836">                assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2837">                cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L2838">            }</span>
            
<span class="nc" id="L2840">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>
    
<span class="nc bnc" id="L2842" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L2843">                assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L2844">                assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L2845">                    .isEqualTo(destinationDefinition.getId());</span>
    
<span class="nc" id="L2847">                List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L2848">                    .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2849">                assertThat(historicPlanItemInstances).hasSize(2);</span>
<span class="nc bnc" id="L2850" title="All 2 branches missed.">                for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L2851">                    assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2852">                }</span>
    
<span class="nc" id="L2854">                List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2855">                assertThat(historicTasks).hasSize(2);</span>
<span class="nc bnc" id="L2856" title="All 2 branches missed.">                for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L2857">                    assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2858">                }</span>
            }
            
        } finally {
<span class="nc" id="L2862">            cmmnEngineConfiguration.setFallbackToDefaultTenant(false);</span>
<span class="nc" id="L2863">            cmmnEngineConfiguration.setDefaultTenantProvider(originalDefaultTenantValue);</span>
        }
<span class="nc" id="L2865">    }</span>
    
    @Test
    void testMultiTenantCaseInstanceMigrationWithCustomDefaultTenantProvider() {
<span class="nc" id="L2869">        DefaultTenantProvider originalDefaultTenantValue = cmmnEngineConfiguration.getDefaultTenantProvider();</span>
<span class="nc" id="L2870">        cmmnEngineConfiguration.setFallbackToDefaultTenant(true);</span>
<span class="nc" id="L2871">        CustomTenantProvider customTenantProvider = new CustomTenantProvider();</span>
<span class="nc" id="L2872">        cmmnEngineConfiguration.setDefaultTenantProvider(customTenantProvider);</span>
        
        try {
            // Arrange
<span class="nc" id="L2876">            CmmnDeployment deployment = cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L2877">                    .name(&quot;my deploy&quot;)</span>
<span class="nc" id="L2878">                    .addClasspathResource(&quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;)</span>
<span class="nc" id="L2879">                    .tenantId(&quot;tenant1-default&quot;)</span>
<span class="nc" id="L2880">                    .deploy();</span>
            
<span class="nc" id="L2882">            CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L2883">                    .caseDefinitionKey(&quot;testCase&quot;)</span>
<span class="nc" id="L2884">                    .tenantId(&quot;tenant1&quot;)</span>
<span class="nc" id="L2885">                    .start();</span>
            
<span class="nc" id="L2887">            deployment = cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L2888">                    .name(&quot;my deploy&quot;)</span>
<span class="nc" id="L2889">                    .addClasspathResource(&quot;org/flowable/cmmn/test/migration/two-task.cmmn.xml&quot;)</span>
<span class="nc" id="L2890">                    .tenantId(&quot;tenant1-default&quot;)</span>
<span class="nc" id="L2891">                    .deploy();</span>
            
<span class="nc" id="L2893">            CaseDefinition destinationDefinition = cmmnRepositoryService.createCaseDefinitionQuery().deploymentId(deployment.getId()).singleResult();</span>
    
            // Act
<span class="nc" id="L2896">            cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L2897">                    .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L2898">                    .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask2&quot;))</span>
<span class="nc" id="L2899">                    .migrate(caseInstance.getId());</span>
    
            // Assert
<span class="nc" id="L2902">            CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L2903">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2904">                    .singleResult();</span>
<span class="nc" id="L2905">            assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2906">            assertThat(caseInstanceAfterMigration.getCaseDefinitionKey()).isEqualTo(&quot;testCase&quot;);</span>
<span class="nc" id="L2907">            assertThat(caseInstanceAfterMigration.getCaseDefinitionName()).isEqualTo(&quot;Two Task Test Case&quot;);</span>
<span class="nc" id="L2908">            assertThat(caseInstanceAfterMigration.getCaseDefinitionVersion()).isEqualTo(2);</span>
<span class="nc" id="L2909">            assertThat(caseInstanceAfterMigration.getCaseDefinitionDeploymentId()).isEqualTo(destinationDefinition.getDeploymentId());</span>
<span class="nc" id="L2910">            List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L2911">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2912">                    .list();</span>
<span class="nc" id="L2913">            assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L2914">            assertThat(planItemInstances)</span>
<span class="nc" id="L2915">                    .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L2916">                    .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L2917">            assertThat(planItemInstances)</span>
<span class="nc" id="L2918">                    .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L2919">                    .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;);</span>
<span class="nc" id="L2920">            assertThat(planItemInstances)</span>
<span class="nc" id="L2921">                    .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L2922">                    .containsOnly(PlanItemInstanceState.ACTIVE);</span>
            
<span class="nc" id="L2924">            List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2925">            assertThat(tasks).hasSize(2);</span>
<span class="nc bnc" id="L2926" title="All 2 branches missed.">            for (Task task : tasks) {</span>
<span class="nc" id="L2927">                assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2928">                cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L2929">            }</span>
            
<span class="nc" id="L2931">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>
    
<span class="nc bnc" id="L2933" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L2934">                assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L2935">                assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L2936">                    .isEqualTo(destinationDefinition.getId());</span>
    
<span class="nc" id="L2938">                List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L2939">                    .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2940">                assertThat(historicPlanItemInstances).hasSize(2);</span>
<span class="nc bnc" id="L2941" title="All 2 branches missed.">                for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L2942">                    assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2943">                }</span>
    
<span class="nc" id="L2945">                List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L2946">                assertThat(historicTasks).hasSize(2);</span>
<span class="nc bnc" id="L2947" title="All 2 branches missed.">                for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L2948">                    assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2949">                }</span>
            }
            
        } finally {
<span class="nc" id="L2953">            cmmnEngineConfiguration.setFallbackToDefaultTenant(false);</span>
<span class="nc" id="L2954">            cmmnEngineConfiguration.setDefaultTenantProvider(originalDefaultTenantValue);</span>
        }
<span class="nc" id="L2956">    }</span>
    
    @Test
    void testMultiTenantCaseInstanceMigrationWithTargetDefaultTenantDefinition() {
<span class="nc" id="L2960">        DefaultTenantProvider originalDefaultTenantValue = cmmnEngineConfiguration.getDefaultTenantProvider();</span>
<span class="nc" id="L2961">        cmmnEngineConfiguration.setDefaultTenantValue(&quot;default&quot;);</span>
<span class="nc" id="L2962">        cmmnEngineConfiguration.setFallbackToDefaultTenant(true);</span>
        
        try {
            // Arrange
<span class="nc" id="L2966">            CmmnDeployment deployment = cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L2967">                    .name(&quot;my deploy&quot;)</span>
<span class="nc" id="L2968">                    .addClasspathResource(&quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;)</span>
<span class="nc" id="L2969">                    .tenantId(&quot;tenant1&quot;)</span>
<span class="nc" id="L2970">                    .deploy();</span>
            
<span class="nc" id="L2972">            CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L2973">                    .caseDefinitionKey(&quot;testCase&quot;)</span>
<span class="nc" id="L2974">                    .tenantId(&quot;tenant1&quot;)</span>
<span class="nc" id="L2975">                    .start();</span>
            
<span class="nc" id="L2977">            deployment = cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L2978">                    .name(&quot;my deploy&quot;)</span>
<span class="nc" id="L2979">                    .addClasspathResource(&quot;org/flowable/cmmn/test/migration/two-task.cmmn.xml&quot;)</span>
<span class="nc" id="L2980">                    .tenantId(&quot;default&quot;)</span>
<span class="nc" id="L2981">                    .deploy();</span>
            
<span class="nc" id="L2983">            CaseDefinition destinationDefinition = cmmnRepositoryService.createCaseDefinitionQuery().deploymentId(deployment.getId()).singleResult();</span>
    
            // Act
<span class="nc" id="L2986">            cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L2987">                    .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L2988">                    .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask2&quot;))</span>
<span class="nc" id="L2989">                    .migrate(caseInstance.getId());</span>
    
            // Assert
<span class="nc" id="L2992">            CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L2993">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L2994">                    .singleResult();</span>
<span class="nc" id="L2995">            assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L2996">            assertThat(caseInstanceAfterMigration.getCaseDefinitionKey()).isEqualTo(&quot;testCase&quot;);</span>
<span class="nc" id="L2997">            assertThat(caseInstanceAfterMigration.getCaseDefinitionName()).isEqualTo(&quot;Two Task Test Case&quot;);</span>
<span class="nc" id="L2998">            assertThat(caseInstanceAfterMigration.getCaseDefinitionVersion()).isEqualTo(1);</span>
<span class="nc" id="L2999">            assertThat(caseInstanceAfterMigration.getCaseDefinitionDeploymentId()).isEqualTo(destinationDefinition.getDeploymentId());</span>
<span class="nc" id="L3000">            List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L3001">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3002">                    .list();</span>
<span class="nc" id="L3003">            assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L3004">            assertThat(planItemInstances)</span>
<span class="nc" id="L3005">                    .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L3006">                    .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L3007">            assertThat(planItemInstances)</span>
<span class="nc" id="L3008">                    .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L3009">                    .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;);</span>
<span class="nc" id="L3010">            assertThat(planItemInstances)</span>
<span class="nc" id="L3011">                    .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L3012">                    .containsOnly(PlanItemInstanceState.ACTIVE);</span>
            
<span class="nc" id="L3014">            List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3015">            assertThat(tasks).hasSize(2);</span>
<span class="nc bnc" id="L3016" title="All 2 branches missed.">            for (Task task : tasks) {</span>
<span class="nc" id="L3017">                assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3018">                cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L3019">            }</span>
            
<span class="nc" id="L3021">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>
    
<span class="nc bnc" id="L3023" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L3024">                assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L3025">                assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L3026">                    .isEqualTo(destinationDefinition.getId());</span>
    
<span class="nc" id="L3028">                List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L3029">                    .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3030">                assertThat(historicPlanItemInstances).hasSize(2);</span>
<span class="nc bnc" id="L3031" title="All 2 branches missed.">                for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L3032">                    assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3033">                }</span>
    
<span class="nc" id="L3035">                List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3036">                assertThat(historicTasks).hasSize(2);</span>
<span class="nc bnc" id="L3037" title="All 2 branches missed.">                for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L3038">                    assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3039">                }</span>
            }
            
        } finally {
<span class="nc" id="L3043">            cmmnEngineConfiguration.setFallbackToDefaultTenant(false);</span>
<span class="nc" id="L3044">            cmmnEngineConfiguration.setDefaultTenantProvider(originalDefaultTenantValue);</span>
        }
<span class="nc" id="L3046">    }</span>
    
    @Test
    void testMultiTenantCaseInstanceMigrationWithDefaultTenantDefinitionFailsWithNoFallback() {
<span class="nc" id="L3050">        DefaultTenantProvider originalDefaultTenantValue = cmmnEngineConfiguration.getDefaultTenantProvider();</span>
<span class="nc" id="L3051">        cmmnEngineConfiguration.setDefaultTenantValue(&quot;default&quot;);</span>
        
        try {
            // Arrange
<span class="nc" id="L3055">            CmmnDeployment deployment = cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L3056">                    .name(&quot;my deploy&quot;)</span>
<span class="nc" id="L3057">                    .addClasspathResource(&quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;)</span>
<span class="nc" id="L3058">                    .tenantId(&quot;tenant1&quot;)</span>
<span class="nc" id="L3059">                    .deploy();</span>
            
<span class="nc" id="L3061">            CaseDefinition sourceDefinition = cmmnRepositoryService.createCaseDefinitionQuery().deploymentId(deployment.getId()).singleResult();</span>
            
<span class="nc" id="L3063">            CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L3064">                    .caseDefinitionKey(&quot;testCase&quot;)</span>
<span class="nc" id="L3065">                    .tenantId(&quot;tenant1&quot;)</span>
<span class="nc" id="L3066">                    .start();</span>
            
<span class="nc" id="L3068">            deployment = cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L3069">                    .name(&quot;my deploy&quot;)</span>
<span class="nc" id="L3070">                    .addClasspathResource(&quot;org/flowable/cmmn/test/migration/two-task.cmmn.xml&quot;)</span>
<span class="nc" id="L3071">                    .tenantId(&quot;default&quot;)</span>
<span class="nc" id="L3072">                    .deploy();</span>
            
<span class="nc" id="L3074">            CaseDefinition destinationDefinition = cmmnRepositoryService.createCaseDefinitionQuery().deploymentId(deployment.getId()).singleResult();</span>
    
<span class="nc" id="L3076">            assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L3077">                cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L3078">                    .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L3079">                    .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask2&quot;))</span>
<span class="nc" id="L3080">                    .migrate(caseInstance.getId());</span>
<span class="nc" id="L3081">            }).isInstanceOf(FlowableException.class).hasMessage(&quot;Tenant mismatch between Case Instance ('tenant1') and Case Definition ('default') to migrate to&quot;);</span>
            
<span class="nc" id="L3083">            CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L3084">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3085">                    .singleResult();</span>
<span class="nc" id="L3086">            assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(sourceDefinition.getId());</span>
<span class="nc" id="L3087">            assertThat(caseInstanceAfterMigration.getCaseDefinitionKey()).isEqualTo(&quot;testCase&quot;);</span>
<span class="nc" id="L3088">            assertThat(caseInstanceAfterMigration.getCaseDefinitionName()).isEqualTo(&quot;One Task Test Case&quot;);</span>
<span class="nc" id="L3089">            assertThat(caseInstanceAfterMigration.getCaseDefinitionVersion()).isEqualTo(1);</span>
<span class="nc" id="L3090">            assertThat(caseInstanceAfterMigration.getCaseDefinitionDeploymentId()).isEqualTo(sourceDefinition.getDeploymentId());</span>
            
        } finally {
<span class="nc" id="L3093">            cmmnEngineConfiguration.setDefaultTenantProvider(originalDefaultTenantValue);</span>
        }
<span class="nc" id="L3095">    }</span>

    @Test
    void withChangedTaskName() {
        // Arrange
<span class="nc" id="L3100">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task-expression-name.cmmn.xml&quot;);</span>

<span class="nc" id="L3102">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L3103">        variables.put(&quot;myVar1&quot;, &quot;foo&quot;);</span>
<span class="nc" id="L3104">        variables.put(&quot;myVar2&quot;, &quot;bar&quot;);</span>

<span class="nc" id="L3106">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L3107">                .caseDefinitionId(originalDefinition.getId())</span>
<span class="nc" id="L3108">                .variables(variables)</span>
<span class="nc" id="L3109">                .start();</span>

        // Assert
<span class="nc" id="L3112">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L3113">        assertThat(task.getName()).isEqualTo(&quot;Human Task: foo&quot;);</span>
<span class="nc" id="L3114">        assertThat(task.getDescription()).isEqualTo(&quot;Description: foo&quot;);</span>

<span class="nc" id="L3116">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task-expression-name-v2.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L3119">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L3120">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L3121">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;humanTask1&quot;))</span>
<span class="nc" id="L3122">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask1&quot;))</span>
<span class="nc" id="L3123">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L3126">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L3127">        assertThat(task.getName()).isEqualTo(&quot;Human Task: bar&quot;);</span>
<span class="nc" id="L3128">        assertThat(task.getDescription()).isEqualTo(&quot;Description: bar&quot;);</span>
<span class="nc" id="L3129">    }</span>
    
    @Test
    void withAdditionalReptitionTask() {
        // Arrange
<span class="nc" id="L3134">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/repetition-task.cmmn.xml&quot;);</span>

<span class="nc" id="L3136">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L3137">                .caseDefinitionId(originalDefinition.getId())</span>
<span class="nc" id="L3138">                .start();</span>

        // Assert
<span class="nc" id="L3141">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L3142">        assertThat(task.getName()).isEqualTo(&quot;repeatableTask&quot;);</span>
        
<span class="nc" id="L3144">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;repeatableTask&quot;).list();</span>
<span class="nc" id="L3145">        assertThat(planItemInstances.size()).isEqualTo(1);</span>
        
<span class="nc" id="L3147">        Map&lt;String, Object&gt; localVarMap = cmmnRuntimeService.getLocalVariables(planItemInstances.get(0).getId());</span>
<span class="nc" id="L3148">        assertThat(localVarMap.size()).isEqualTo(1);</span>
<span class="nc" id="L3149">        assertThat(localVarMap.get(&quot;repetitionCounter&quot;)).isEqualTo(1);</span>

<span class="nc" id="L3151">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/repetition-task-new-repetition-task.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L3154">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L3155">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L3156">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;repeatableTask2&quot;))</span>
<span class="nc" id="L3157">                .migrate(caseInstance.getId());</span>

<span class="nc" id="L3159">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;repeatableTask2&quot;).singleResult();</span>
<span class="nc" id="L3160">        assertThat(task.getName()).isEqualTo(&quot;repeatableTask2&quot;);</span>
        
<span class="nc" id="L3162">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;repeatableTask2&quot;).list();</span>
<span class="nc" id="L3163">        assertThat(planItemInstances.size()).isEqualTo(1);</span>
        
<span class="nc" id="L3165">        localVarMap = cmmnRuntimeService.getLocalVariables(planItemInstances.get(0).getId());</span>
<span class="nc" id="L3166">        assertThat(localVarMap.size()).isEqualTo(1);</span>
<span class="nc" id="L3167">        assertThat(localVarMap.get(&quot;repetitionCounter2&quot;)).isEqualTo(1);</span>
        
        // Assert
<span class="nc" id="L3170">        cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L3171">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;repeatableTask2&quot;).singleResult();</span>
<span class="nc" id="L3172">        assertThat(task.getName()).isEqualTo(&quot;repeatableTask2&quot;);</span>
        
<span class="nc" id="L3174">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;repeatableTask2&quot;).list();</span>
<span class="nc" id="L3175">        assertThat(planItemInstances.size()).isEqualTo(1);</span>
        
<span class="nc" id="L3177">        localVarMap = cmmnRuntimeService.getLocalVariables(planItemInstances.get(0).getId());</span>
<span class="nc" id="L3178">        assertThat(localVarMap.size()).isEqualTo(1);</span>
<span class="nc" id="L3179">        assertThat(localVarMap.get(&quot;repetitionCounter2&quot;)).isEqualTo(2);</span>
<span class="nc" id="L3180">    }</span>
    
    @Test
    void withAdditionalRepetitionWithTwoTasks() {
        // Arrange
<span class="nc" id="L3185">        CaseDefinition originalDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/repetition-2tasks.cmmn.xml&quot;);</span>

<span class="nc" id="L3187">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L3188">                .caseDefinitionId(originalDefinition.getId())</span>
<span class="nc" id="L3189">                .start();</span>

        // Assert
<span class="nc" id="L3192">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L3193">        assertThat(task.getName()).isEqualTo(&quot;initialTask&quot;);</span>
        
<span class="nc" id="L3195">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;initialTask&quot;).list();</span>
<span class="nc" id="L3196">        assertThat(planItemInstances.size()).isEqualTo(1);</span>
        
<span class="nc" id="L3198">        Map&lt;String, Object&gt; localVarMap = cmmnRuntimeService.getLocalVariables(planItemInstances.get(0).getId());</span>
<span class="nc" id="L3199">        assertThat(localVarMap.size()).isEqualTo(1);</span>
<span class="nc" id="L3200">        assertThat(localVarMap.get(&quot;initialCounter&quot;)).isEqualTo(1);</span>
        
<span class="nc" id="L3202">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;dependingTask&quot;).list();</span>
<span class="nc" id="L3203">        assertThat(planItemInstances.size()).isEqualTo(1);</span>
<span class="nc" id="L3204">        assertThat(planItemInstances.get(0).getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L3205">        localVarMap  = cmmnRuntimeService.getLocalVariables(planItemInstances.get(0).getId());</span>
<span class="nc" id="L3206">        assertThat(localVarMap.size()).isEqualTo(1);</span>
<span class="nc" id="L3207">        assertThat(localVarMap.get(&quot;dependingCounter&quot;)).isEqualTo(1);</span>
        
<span class="nc" id="L3209">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L3211">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;dependingTask&quot;).singleResult();</span>
<span class="nc" id="L3212">        assertThat(task.getName()).isEqualTo(&quot;dependingTask&quot;);</span>
        
<span class="nc" id="L3214">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;dependingTask&quot;).list();</span>
<span class="nc" id="L3215">        assertThat(planItemInstances.size()).isEqualTo(2);</span>
        
<span class="nc" id="L3217">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;dependingTask&quot;).planItemInstanceStateActive().list();</span>
<span class="nc" id="L3218">        assertThat(planItemInstances.size()).isEqualTo(1);</span>
        
<span class="nc" id="L3220">        localVarMap = cmmnRuntimeService.getLocalVariables(planItemInstances.get(0).getId());</span>
<span class="nc" id="L3221">        assertThat(localVarMap.size()).isEqualTo(1);</span>
<span class="nc" id="L3222">        assertThat(localVarMap.get(&quot;dependingCounter&quot;)).isEqualTo(1);</span>
        
<span class="nc" id="L3224">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;dependingTask&quot;).planItemInstanceStateWaitingForRepetition().list();</span>
<span class="nc" id="L3225">        assertThat(planItemInstances.size()).isEqualTo(1);</span>
        
<span class="nc" id="L3227">        localVarMap = cmmnRuntimeService.getLocalVariables(planItemInstances.get(0).getId());</span>
<span class="nc" id="L3228">        assertThat(localVarMap.size()).isEqualTo(1);</span>
<span class="nc" id="L3229">        assertThat(localVarMap.get(&quot;dependingCounter&quot;)).isEqualTo(2);</span>

<span class="nc" id="L3231">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/repetition-2tasks-new-repetition-2tasks.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L3234">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L3235">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L3236">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;extraInitialTask&quot;))</span>
<span class="nc" id="L3237">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;extraDependingTask&quot;))</span>
<span class="nc" id="L3238">                .migrate(caseInstance.getId());</span>

<span class="nc" id="L3240">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;extraInitialTask&quot;).singleResult();</span>
<span class="nc" id="L3241">        assertThat(task.getName()).isEqualTo(&quot;extraInitialTask&quot;);</span>
        
<span class="nc" id="L3243">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;extraInitialTask&quot;).list();</span>
<span class="nc" id="L3244">        assertThat(planItemInstances.size()).isEqualTo(1);</span>
        
<span class="nc" id="L3246">        localVarMap = cmmnRuntimeService.getLocalVariables(planItemInstances.get(0).getId());</span>
<span class="nc" id="L3247">        assertThat(localVarMap.size()).isEqualTo(1);</span>
<span class="nc" id="L3248">        assertThat(localVarMap.get(&quot;extraInitialCounter&quot;)).isEqualTo(1);</span>
        
<span class="nc" id="L3250">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;extraDependingTask&quot;).count()).isEqualTo(0);</span>
        
        // Assert
<span class="nc" id="L3253">        cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L3254">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;extraDependingTask&quot;).singleResult();</span>
<span class="nc" id="L3255">        assertThat(task.getName()).isEqualTo(&quot;extraDependingTask&quot;);</span>
        
<span class="nc" id="L3257">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;extraDependingTask&quot;).list();</span>
<span class="nc" id="L3258">        assertThat(planItemInstances.size()).isEqualTo(2);</span>
        
<span class="nc" id="L3260">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;extraDependingTask&quot;).planItemInstanceStateActive().list();</span>
<span class="nc" id="L3261">        assertThat(planItemInstances.size()).isEqualTo(1);</span>
        
<span class="nc" id="L3263">        localVarMap = cmmnRuntimeService.getLocalVariables(planItemInstances.get(0).getId());</span>
<span class="nc" id="L3264">        assertThat(localVarMap.size()).isEqualTo(1);</span>
<span class="nc" id="L3265">        assertThat(localVarMap.get(&quot;extraDependingCounter&quot;)).isEqualTo(1);</span>
        
<span class="nc" id="L3267">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionId(&quot;extraDependingTask&quot;).planItemInstanceStateWaitingForRepetition().list();</span>
<span class="nc" id="L3268">        assertThat(planItemInstances.size()).isEqualTo(1);</span>
        
<span class="nc" id="L3270">        localVarMap = cmmnRuntimeService.getLocalVariables(planItemInstances.get(0).getId());</span>
<span class="nc" id="L3271">        assertThat(localVarMap.size()).isEqualTo(1);</span>
<span class="nc" id="L3272">        assertThat(localVarMap.get(&quot;extraDependingCounter&quot;)).isEqualTo(2);</span>
<span class="nc" id="L3273">    }</span>
    
    @Test
    void migrateCaseInstancesWithSimpleOneTaskCaseWithMappingToSecondNewTask() {
        // Arrange
<span class="nc" id="L3278">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>
<span class="nc" id="L3279">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L3280">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/two-task.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L3283">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L3284">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L3285">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;humanTask2&quot;))</span>
<span class="nc" id="L3286">                .migrateCaseInstances(&quot;testCase&quot;, 1, &quot;&quot;);</span>

        // Assert
<span class="nc" id="L3289">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L3290">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3291">                .singleResult();</span>
<span class="nc" id="L3292">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3293">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L3294">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3295">                .includeEnded()</span>
<span class="nc" id="L3296">                .list();</span>
<span class="nc" id="L3297">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L3298">        assertThat(planItemInstances)</span>
<span class="nc" id="L3299">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L3300">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L3301">        assertThat(planItemInstances)</span>
<span class="nc" id="L3302">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L3303">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;);</span>
<span class="nc" id="L3304">        assertThat(planItemInstances)</span>
<span class="nc" id="L3305">                .filteredOn(&quot;name&quot;, &quot;Task 2&quot;)</span>
<span class="nc" id="L3306">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L3307">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L3309">        assertThat(planItemInstances)</span>
<span class="nc" id="L3310">                .filteredOn(&quot;name&quot;, &quot;Task 1&quot;)</span>
<span class="nc" id="L3311">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L3312">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L3314">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc bnc" id="L3315" title="All 2 branches missed.">        for (Task task : tasks) {</span>
<span class="nc" id="L3316">            cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L3317">        }</span>
    
<span class="nc" id="L3319">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L3321" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L3322">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L3323">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L3324">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L3326">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L3327">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3328">            assertThat(historicPlanItemInstances).hasSize(2);</span>
<span class="nc bnc" id="L3329" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L3330">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3331">            }</span>

<span class="nc" id="L3333">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3334">            assertThat(historicTasks).hasSize(2);</span>
<span class="nc bnc" id="L3335" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L3336">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3337">            }</span>
        }
<span class="nc" id="L3339">    }</span>
    
    @Test
    void migrateCaseInstancesWithSimpleOneTaskMultipleCaseWithMappingsToSecondNewTask() {
        // Arrange
<span class="nc" id="L3344">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>
<span class="nc" id="L3345">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L3346">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/two-task.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L3349">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L3350">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L3351">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;humanTask1&quot;))</span>
<span class="nc" id="L3352">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;humanTask2&quot;))</span>
<span class="nc" id="L3353">                .migrateCaseInstances(&quot;testCase&quot;, 1, &quot;&quot;);</span>

        // Assert
<span class="nc" id="L3356">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L3357">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3358">                .singleResult();</span>
<span class="nc" id="L3359">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3360">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L3361">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3362">                .includeEnded()</span>
<span class="nc" id="L3363">                .list();</span>
<span class="nc" id="L3364">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L3365">        assertThat(planItemInstances)</span>
<span class="nc" id="L3366">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L3367">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L3368">        assertThat(planItemInstances)</span>
<span class="nc" id="L3369">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L3370">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;);</span>
<span class="nc" id="L3371">        assertThat(planItemInstances)</span>
<span class="nc" id="L3372">                .filteredOn(&quot;name&quot;, &quot;Task 2&quot;)</span>
<span class="nc" id="L3373">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L3374">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L3376">        assertThat(planItemInstances)</span>
<span class="nc" id="L3377">                .filteredOn(&quot;name&quot;, &quot;Task 1&quot;)</span>
<span class="nc" id="L3378">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L3379">                .containsOnly(PlanItemInstanceState.TERMINATED);</span>
        
<span class="nc" id="L3381">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L3382">        cmmnTaskService.complete(task.getId());</span>
    
<span class="nc" id="L3384">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L3386" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L3387">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L3388">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L3389">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L3391">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L3392">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3393">            assertThat(historicPlanItemInstances).hasSize(2);</span>
<span class="nc bnc" id="L3394" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L3395">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3396">            }</span>

<span class="nc" id="L3398">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3399">            assertThat(historicTasks).hasSize(2);</span>
<span class="nc bnc" id="L3400" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L3401">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3402">            }</span>
        }
<span class="nc" id="L3404">    }</span>
    
    @Test
    void withTwoSentriesOnPartEventDeferred() {
        // Arrange
<span class="nc" id="L3409">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/twosentry-onpart-eventdeferred.cmmn.xml&quot;);</span>
<span class="nc" id="L3410">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L3411">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/twosentry-onpart-eventdeferred-extratask.cmmn.xml&quot;);</span>

<span class="nc" id="L3413">        Task firstTask = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask1&quot;).singleResult();</span>
<span class="nc" id="L3414">        cmmnTaskService.complete(firstTask.getId());</span>
        
<span class="nc" id="L3416">        List&lt;SentryPartInstanceEntity&gt; sentryPartInstances = cmmnEngineConfiguration.getCommandExecutor().execute(new Command&lt;&gt;() {</span>

            @Override
            public List&lt;SentryPartInstanceEntity&gt; execute(CommandContext commandContext) {
<span class="nc" id="L3420">                return cmmnEngineConfiguration.getSentryPartInstanceEntityManager().findSentryPartInstancesByCaseInstanceId(caseInstance.getId());</span>
            }

        });
        
<span class="nc" id="L3425">        assertThat(sentryPartInstances).hasSize(1);</span>
<span class="nc" id="L3426">        assertThat(sentryPartInstances.get(0).getOnPartId()).isEqualTo(&quot;sentryOnPartcmmnEntrySentry_2&quot;);</span>
        
        // Act
<span class="nc" id="L3429">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L3430">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L3431">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask4&quot;))</span>
<span class="nc" id="L3432">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L3435">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L3436">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3437">                .singleResult();</span>
<span class="nc" id="L3438">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3439">        assertThat(caseInstanceAfterMigration.getCaseDefinitionKey()).isEqualTo(&quot;testCase&quot;);</span>
<span class="nc" id="L3440">        assertThat(caseInstanceAfterMigration.getCaseDefinitionName()).isEqualTo(&quot;Sentry On Part Test Case&quot;);</span>
<span class="nc" id="L3441">        assertThat(caseInstanceAfterMigration.getCaseDefinitionVersion()).isEqualTo(2);</span>
<span class="nc" id="L3442">        assertThat(caseInstanceAfterMigration.getCaseDefinitionDeploymentId()).isEqualTo(destinationDefinition.getDeploymentId());</span>
        
<span class="nc" id="L3444">        sentryPartInstances = cmmnEngineConfiguration.getCommandExecutor().execute(new Command&lt;&gt;() {</span>

            @Override
            public List&lt;SentryPartInstanceEntity&gt; execute(CommandContext commandContext) {
<span class="nc" id="L3448">                return cmmnEngineConfiguration.getSentryPartInstanceEntityManager().findSentryPartInstancesByCaseInstanceId(caseInstance.getId());</span>
            }

        });
        
<span class="nc" id="L3453">        assertThat(sentryPartInstances).hasSize(1);</span>
<span class="nc" id="L3454">        assertThat(sentryPartInstances.get(0).getOnPartId()).isEqualTo(&quot;sentryOnPartcmmnEntrySentry_2&quot;);</span>
        
<span class="nc" id="L3456">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L3457">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3458">                .list();</span>
<span class="nc" id="L3459">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L3460">        assertThat(planItemInstances)</span>
<span class="nc" id="L3461">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L3462">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L3463">        assertThat(planItemInstances)</span>
<span class="nc" id="L3464">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L3465">                .containsExactlyInAnyOrder(&quot;Task 2&quot;, &quot;Task 3&quot;, &quot;Task 4&quot;);</span>
<span class="nc" id="L3466">        assertThat(planItemInstances)</span>
<span class="nc" id="L3467">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L3468">                .containsOnly(PlanItemInstanceState.AVAILABLE, PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L3470">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3471">        assertThat(tasks).hasSize(2);</span>
<span class="nc bnc" id="L3472" title="All 2 branches missed.">        for (Task task : tasks) {</span>
<span class="nc" id="L3473">            assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3474">            cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L3475">        }</span>
        
<span class="nc" id="L3477">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L3478">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3479">                .list();</span>
        
<span class="nc" id="L3481">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L3482">        assertThat(planItemInstances)</span>
<span class="nc" id="L3483">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L3484">                .containsExactlyInAnyOrder(&quot;Task 3&quot;);</span>
<span class="nc" id="L3485">        assertThat(planItemInstances)</span>
<span class="nc" id="L3486">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L3487">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L3489">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L3490">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L3492">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L3494" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L3495">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L3496">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L3497">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L3499">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L3500">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3501">            assertThat(historicPlanItemInstances).hasSize(4);</span>
<span class="nc bnc" id="L3502" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L3503">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3504">            }</span>

<span class="nc" id="L3506">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3507">            assertThat(historicTasks).hasSize(4);</span>
<span class="nc bnc" id="L3508" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L3509">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3510">            }</span>
        }
<span class="nc" id="L3512">    }</span>
    
    @Test
    void withTwoSentriesOnPartChangeIdEventDeferred() {
        // Arrange
<span class="nc" id="L3517">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/twosentry-onpart-id-eventdeferred.cmmn.xml&quot;);</span>
<span class="nc" id="L3518">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L3519">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/twosentry-onpart-eventdeferred-extratask.cmmn.xml&quot;);</span>

<span class="nc" id="L3521">        Task firstTask = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask1&quot;).singleResult();</span>
<span class="nc" id="L3522">        cmmnTaskService.complete(firstTask.getId());</span>
        
<span class="nc" id="L3524">        List&lt;SentryPartInstanceEntity&gt; sentryPartInstances = cmmnEngineConfiguration.getCommandExecutor().execute(new Command&lt;&gt;() {</span>

            @Override
            public List&lt;SentryPartInstanceEntity&gt; execute(CommandContext commandContext) {
<span class="nc" id="L3528">                return cmmnEngineConfiguration.getSentryPartInstanceEntityManager().findSentryPartInstancesByCaseInstanceId(caseInstance.getId());</span>
            }

        });
        
<span class="nc" id="L3533">        assertThat(sentryPartInstances).hasSize(1);</span>
<span class="nc" id="L3534">        assertThat(sentryPartInstances.get(0).getOnPartId()).isEqualTo(&quot;sentryOnPart1cmmnEntrySentry_2&quot;);</span>
        
        // Act
<span class="nc" id="L3537">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L3538">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L3539">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask4&quot;))</span>
<span class="nc" id="L3540">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L3543">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L3544">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3545">                .singleResult();</span>
<span class="nc" id="L3546">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3547">        assertThat(caseInstanceAfterMigration.getCaseDefinitionKey()).isEqualTo(&quot;testCase&quot;);</span>
<span class="nc" id="L3548">        assertThat(caseInstanceAfterMigration.getCaseDefinitionName()).isEqualTo(&quot;Sentry On Part Test Case&quot;);</span>
<span class="nc" id="L3549">        assertThat(caseInstanceAfterMigration.getCaseDefinitionVersion()).isEqualTo(2);</span>
<span class="nc" id="L3550">        assertThat(caseInstanceAfterMigration.getCaseDefinitionDeploymentId()).isEqualTo(destinationDefinition.getDeploymentId());</span>
        
<span class="nc" id="L3552">        sentryPartInstances = cmmnEngineConfiguration.getCommandExecutor().execute(new Command&lt;&gt;() {</span>

            @Override
            public List&lt;SentryPartInstanceEntity&gt; execute(CommandContext commandContext) {
<span class="nc" id="L3556">                return cmmnEngineConfiguration.getSentryPartInstanceEntityManager().findSentryPartInstancesByCaseInstanceId(caseInstance.getId());</span>
            }

        });
        
<span class="nc" id="L3561">        assertThat(sentryPartInstances).hasSize(1);</span>
<span class="nc" id="L3562">        assertThat(sentryPartInstances.get(0).getOnPartId()).isEqualTo(&quot;sentryOnPartcmmnEntrySentry_2&quot;);</span>
        
<span class="nc" id="L3564">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L3565">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3566">                .list();</span>
<span class="nc" id="L3567">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L3568">        assertThat(planItemInstances)</span>
<span class="nc" id="L3569">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L3570">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L3571">        assertThat(planItemInstances)</span>
<span class="nc" id="L3572">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L3573">                .containsExactlyInAnyOrder(&quot;Task 2&quot;, &quot;Task 3&quot;, &quot;Task 4&quot;);</span>
<span class="nc" id="L3574">        assertThat(planItemInstances)</span>
<span class="nc" id="L3575">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L3576">                .containsOnly(PlanItemInstanceState.AVAILABLE, PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L3578">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3579">        assertThat(tasks).hasSize(2);</span>
<span class="nc bnc" id="L3580" title="All 2 branches missed.">        for (Task task : tasks) {</span>
<span class="nc" id="L3581">            assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3582">            cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L3583">        }</span>
        
<span class="nc" id="L3585">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L3586">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3587">                .list();</span>
        
<span class="nc" id="L3589">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L3590">        assertThat(planItemInstances)</span>
<span class="nc" id="L3591">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L3592">                .containsExactlyInAnyOrder(&quot;Task 3&quot;);</span>
<span class="nc" id="L3593">        assertThat(planItemInstances)</span>
<span class="nc" id="L3594">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L3595">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L3597">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L3598">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L3600">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L3602" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L3603">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L3604">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L3605">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L3607">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L3608">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3609">            assertThat(historicPlanItemInstances).hasSize(4);</span>
<span class="nc bnc" id="L3610" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L3611">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3612">            }</span>

<span class="nc" id="L3614">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3615">            assertThat(historicTasks).hasSize(4);</span>
<span class="nc bnc" id="L3616" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L3617">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3618">            }</span>
        }
<span class="nc" id="L3620">    }</span>
    
    @Test
    void withTwoSentriesOnPartChangePlanItemEventDeferred() {
        // Arrange
<span class="nc" id="L3625">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/twosentry-onpart-planitem-eventdeferred.cmmn.xml&quot;);</span>
<span class="nc" id="L3626">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L3627">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/twosentry-onpart-eventdeferred-extratask.cmmn.xml&quot;);</span>

<span class="nc" id="L3629">        Task zeroTask = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask0&quot;).singleResult();</span>
<span class="nc" id="L3630">        cmmnTaskService.complete(zeroTask.getId());</span>
        
<span class="nc" id="L3632">        List&lt;SentryPartInstanceEntity&gt; sentryPartInstances = cmmnEngineConfiguration.getCommandExecutor().execute(new Command&lt;&gt;() {</span>

            @Override
            public List&lt;SentryPartInstanceEntity&gt; execute(CommandContext commandContext) {
<span class="nc" id="L3636">                return cmmnEngineConfiguration.getSentryPartInstanceEntityManager().findSentryPartInstancesByCaseInstanceId(caseInstance.getId());</span>
            }

        });
        
<span class="nc" id="L3641">        assertThat(sentryPartInstances).hasSize(1);</span>
<span class="nc" id="L3642">        assertThat(sentryPartInstances.get(0).getOnPartId()).isEqualTo(&quot;sentryOnPart1cmmnEntrySentry_2&quot;);</span>
        
        // Act
<span class="nc" id="L3645">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L3646">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L3647">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask1&quot;))</span>
<span class="nc" id="L3648">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask4&quot;))</span>
<span class="nc" id="L3649">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L3652">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L3653">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3654">                .singleResult();</span>
<span class="nc" id="L3655">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3656">        assertThat(caseInstanceAfterMigration.getCaseDefinitionKey()).isEqualTo(&quot;testCase&quot;);</span>
<span class="nc" id="L3657">        assertThat(caseInstanceAfterMigration.getCaseDefinitionName()).isEqualTo(&quot;Sentry On Part Test Case&quot;);</span>
<span class="nc" id="L3658">        assertThat(caseInstanceAfterMigration.getCaseDefinitionVersion()).isEqualTo(2);</span>
<span class="nc" id="L3659">        assertThat(caseInstanceAfterMigration.getCaseDefinitionDeploymentId()).isEqualTo(destinationDefinition.getDeploymentId());</span>
        
<span class="nc" id="L3661">        sentryPartInstances = cmmnEngineConfiguration.getCommandExecutor().execute(new Command&lt;&gt;() {</span>

            @Override
            public List&lt;SentryPartInstanceEntity&gt; execute(CommandContext commandContext) {
<span class="nc" id="L3665">                return cmmnEngineConfiguration.getSentryPartInstanceEntityManager().findSentryPartInstancesByCaseInstanceId(caseInstance.getId());</span>
            }

        });
        
<span class="nc" id="L3670">        assertThat(sentryPartInstances).hasSize(0);</span>
        
<span class="nc" id="L3672">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L3673">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3674">                .list();</span>
<span class="nc" id="L3675">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L3676">        assertThat(planItemInstances)</span>
<span class="nc" id="L3677">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L3678">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L3679">        assertThat(planItemInstances)</span>
<span class="nc" id="L3680">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L3681">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;, &quot;Task 3&quot;, &quot;Task 4&quot;);</span>
<span class="nc" id="L3682">        assertThat(planItemInstances)</span>
<span class="nc" id="L3683">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L3684">                .containsOnly(PlanItemInstanceState.AVAILABLE, PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L3686">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3687">        assertThat(tasks).hasSize(3);</span>
        
<span class="nc" id="L3689">        Task secondTask = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask2&quot;).singleResult();</span>
<span class="nc" id="L3690">        assertThat(secondTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3691">        cmmnTaskService.complete(secondTask.getId());</span>
        
<span class="nc" id="L3693">        tasks = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3694">        assertThat(tasks).hasSize(2);</span>
        
<span class="nc" id="L3696">        Task firstTask = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask1&quot;).singleResult();</span>
<span class="nc" id="L3697">        assertThat(firstTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3698">        cmmnTaskService.complete(firstTask.getId());</span>
        
<span class="nc" id="L3700">        tasks = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3701">        assertThat(tasks).hasSize(2);</span>
        
<span class="nc bnc" id="L3703" title="All 2 branches missed.">        for (Task task : tasks) {</span>
<span class="nc" id="L3704">            assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3705">            cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L3706">        }</span>
        
<span class="nc" id="L3708">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L3709">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3710">                .list();</span>
        
<span class="nc" id="L3712">        assertThat(planItemInstances).hasSize(0);</span>
        
<span class="nc" id="L3714">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L3716" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L3717">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L3718">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L3719">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L3721">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L3722">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3723">            assertThat(historicPlanItemInstances).hasSize(5);</span>
<span class="nc bnc" id="L3724" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L3725">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3726">            }</span>

<span class="nc" id="L3728">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3729">            assertThat(historicTasks).hasSize(5);</span>
<span class="nc bnc" id="L3730" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L3731">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3732">            }</span>
        }
<span class="nc" id="L3734">    }</span>
    
    @Test
    void withTwoSentriesOnPartEventDeferredToOnEvent() {
        // Arrange
<span class="nc" id="L3739">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/twosentry-ifpart-eventdeferred.cmmn.xml&quot;);</span>
<span class="nc" id="L3740">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L3741">                .caseDefinitionKey(&quot;testCase&quot;)</span>
<span class="nc" id="L3742">                .variable(&quot;var1&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L3743">                .start();</span>
        
<span class="nc" id="L3745">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L3746">        assertThat(task.getName()).isEqualTo(&quot;Task 1&quot;);</span>
        
<span class="nc" id="L3748">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L3750">        List&lt;SentryPartInstanceEntity&gt; sentryPartInstances = cmmnEngineConfiguration.getCommandExecutor().execute(new Command&lt;&gt;() {</span>

            @Override
            public List&lt;SentryPartInstanceEntity&gt; execute(CommandContext commandContext) {
<span class="nc" id="L3754">                return cmmnEngineConfiguration.getSentryPartInstanceEntityManager().findSentryPartInstancesByCaseInstanceId(caseInstance.getId());</span>
            }

        });
        
<span class="nc" id="L3759">        assertThat(sentryPartInstances).hasSize(1);</span>
<span class="nc" id="L3760">        assertThat(sentryPartInstances.get(0).getOnPartId()).isEqualTo(&quot;sentryOnPartcmmnEntrySentry_2&quot;);</span>
        
<span class="nc" id="L3762">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/twosentry-ifpart-onevent.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L3765">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L3766">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L3767">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L3770">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L3771">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3772">                .singleResult();</span>
<span class="nc" id="L3773">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3774">        assertThat(caseInstanceAfterMigration.getCaseDefinitionKey()).isEqualTo(&quot;testCase&quot;);</span>
<span class="nc" id="L3775">        assertThat(caseInstanceAfterMigration.getCaseDefinitionName()).isEqualTo(&quot;Sentry If Part Test Case&quot;);</span>
<span class="nc" id="L3776">        assertThat(caseInstanceAfterMigration.getCaseDefinitionVersion()).isEqualTo(2);</span>
<span class="nc" id="L3777">        assertThat(caseInstanceAfterMigration.getCaseDefinitionDeploymentId()).isEqualTo(destinationDefinition.getDeploymentId());</span>
        
<span class="nc" id="L3779">        sentryPartInstances = cmmnEngineConfiguration.getCommandExecutor().execute(new Command&lt;&gt;() {</span>

            @Override
            public List&lt;SentryPartInstanceEntity&gt; execute(CommandContext commandContext) {
<span class="nc" id="L3783">                return cmmnEngineConfiguration.getSentryPartInstanceEntityManager().findSentryPartInstancesByCaseInstanceId(caseInstance.getId());</span>
            }

        });
        
<span class="nc" id="L3788">        assertThat(sentryPartInstances).hasSize(0);</span>
        
<span class="nc" id="L3790">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L3791">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3792">                .list();</span>
<span class="nc" id="L3793">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L3794">        assertThat(planItemInstances)</span>
<span class="nc" id="L3795">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L3796">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L3797">        assertThat(planItemInstances)</span>
<span class="nc" id="L3798">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L3799">                .containsExactlyInAnyOrder(&quot;Task 2&quot;);</span>
<span class="nc" id="L3800">        assertThat(planItemInstances)</span>
<span class="nc" id="L3801">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L3802">                .containsOnly(PlanItemInstanceState.AVAILABLE);</span>
        
<span class="nc" id="L3804">        cmmnRuntimeService.createChangePlanItemStateBuilder().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3805">                .activatePlanItemDefinitionId(&quot;humanTask1&quot;)</span>
<span class="nc" id="L3806">                .changeState();</span>
        
<span class="nc" id="L3808">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L3809">        assertThat(task.getName()).isEqualTo(&quot;Task 1&quot;);</span>
        
<span class="nc" id="L3811">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L3813">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L3814">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3815">                .list();</span>
        
<span class="nc" id="L3817">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L3818">        assertThat(planItemInstances)</span>
<span class="nc" id="L3819">            .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L3820">            .containsExactlyInAnyOrder(&quot;Task 2&quot;);</span>
<span class="nc" id="L3821">        assertThat(planItemInstances)</span>
<span class="nc" id="L3822">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L3823">                .containsOnly(PlanItemInstanceState.AVAILABLE);</span>
        
<span class="nc" id="L3825">        cmmnRuntimeService.createChangePlanItemStateBuilder().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3826">            .activatePlanItemDefinitionId(&quot;humanTask1&quot;)</span>
<span class="nc" id="L3827">            .changeState();</span>
        
<span class="nc" id="L3829">        cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;var1&quot;, &quot;test&quot;);</span>
        
<span class="nc" id="L3831">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L3832">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L3834">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L3835">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3836">                .list();</span>
        
<span class="nc" id="L3838">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L3839">        assertThat(planItemInstances)</span>
<span class="nc" id="L3840">            .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L3841">            .containsExactlyInAnyOrder(&quot;Task 2&quot;);</span>
<span class="nc" id="L3842">        assertThat(planItemInstances)</span>
<span class="nc" id="L3843">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L3844">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L3846">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L3847">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L3849">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L3851" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L3852">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L3853">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L3854">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L3856">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L3857">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3858">            assertThat(historicPlanItemInstances).hasSize(4);</span>
<span class="nc bnc" id="L3859" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L3860">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3861">            }</span>

<span class="nc" id="L3863">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3864">            assertThat(historicTasks).hasSize(4);</span>
<span class="nc bnc" id="L3865" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L3866">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3867">            }</span>
        }
<span class="nc" id="L3869">    }</span>
    
    @Test
    void withTwoSentriesIfPartEventDeferred() {
        // Arrange
<span class="nc" id="L3874">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/twosentry-ifpart-eventdeferred.cmmn.xml&quot;);</span>
<span class="nc" id="L3875">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L3876">                .caseDefinitionKey(&quot;testCase&quot;)</span>
<span class="nc" id="L3877">                .variable(&quot;var1&quot;, &quot;test&quot;)</span>
<span class="nc" id="L3878">                .start();</span>
        
<span class="nc" id="L3880">        cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;var1&quot;, &quot;test2&quot;);</span>
        
<span class="nc" id="L3882">        List&lt;SentryPartInstanceEntity&gt; sentryPartInstances = cmmnEngineConfiguration.getCommandExecutor().execute(new Command&lt;&gt;() {</span>

            @Override
            public List&lt;SentryPartInstanceEntity&gt; execute(CommandContext commandContext) {
<span class="nc" id="L3886">                return cmmnEngineConfiguration.getSentryPartInstanceEntityManager().findSentryPartInstancesByCaseInstanceId(caseInstance.getId());</span>
            }

        });
        
<span class="nc" id="L3891">        assertThat(sentryPartInstances).hasSize(1);</span>
<span class="nc" id="L3892">        assertThat(sentryPartInstances.get(0).getIfPartId()).isEqualTo(&quot;ifpart1&quot;);</span>
        
<span class="nc" id="L3894">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/twosentry-ifpart-eventdeferred-extratask.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L3897">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L3898">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L3899">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask3&quot;))</span>
<span class="nc" id="L3900">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L3903">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L3904">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3905">                .singleResult();</span>
<span class="nc" id="L3906">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3907">        assertThat(caseInstanceAfterMigration.getCaseDefinitionKey()).isEqualTo(&quot;testCase&quot;);</span>
<span class="nc" id="L3908">        assertThat(caseInstanceAfterMigration.getCaseDefinitionName()).isEqualTo(&quot;Sentry If Part Test Case&quot;);</span>
<span class="nc" id="L3909">        assertThat(caseInstanceAfterMigration.getCaseDefinitionVersion()).isEqualTo(2);</span>
<span class="nc" id="L3910">        assertThat(caseInstanceAfterMigration.getCaseDefinitionDeploymentId()).isEqualTo(destinationDefinition.getDeploymentId());</span>
        
<span class="nc" id="L3912">        sentryPartInstances = cmmnEngineConfiguration.getCommandExecutor().execute(new Command&lt;&gt;() {</span>

            @Override
            public List&lt;SentryPartInstanceEntity&gt; execute(CommandContext commandContext) {
<span class="nc" id="L3916">                return cmmnEngineConfiguration.getSentryPartInstanceEntityManager().findSentryPartInstancesByCaseInstanceId(caseInstance.getId());</span>
            }

        });
        
<span class="nc" id="L3921">        assertThat(sentryPartInstances).hasSize(1);</span>
<span class="nc" id="L3922">        assertThat(sentryPartInstances.get(0).getIfPartId()).isEqualTo(&quot;ifpart2&quot;);</span>
        
<span class="nc" id="L3924">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L3925">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3926">                .list();</span>
<span class="nc" id="L3927">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L3928">        assertThat(planItemInstances)</span>
<span class="nc" id="L3929">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L3930">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L3931">        assertThat(planItemInstances)</span>
<span class="nc" id="L3932">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L3933">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;, &quot;Task 3&quot;);</span>
<span class="nc" id="L3934">        assertThat(planItemInstances)</span>
<span class="nc" id="L3935">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L3936">                .containsOnly(PlanItemInstanceState.AVAILABLE, PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L3938">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3939">        assertThat(tasks).hasSize(2);</span>
<span class="nc bnc" id="L3940" title="All 2 branches missed.">        for (Task task : tasks) {</span>
<span class="nc" id="L3941">            assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3942">            cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L3943">        }</span>
        
<span class="nc" id="L3945">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L3946">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L3947">                .list();</span>
        
<span class="nc" id="L3949">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L3950">        assertThat(planItemInstances)</span>
<span class="nc" id="L3951">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L3952">                .containsExactlyInAnyOrder(&quot;Task 2&quot;);</span>
<span class="nc" id="L3953">        assertThat(planItemInstances)</span>
<span class="nc" id="L3954">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L3955">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L3957">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L3958">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L3960">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L3962" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L3963">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L3964">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L3965">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L3967">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L3968">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3969">            assertThat(historicPlanItemInstances).hasSize(3);</span>
<span class="nc bnc" id="L3970" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L3971">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3972">            }</span>

<span class="nc" id="L3974">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L3975">            assertThat(historicTasks).hasSize(3);</span>
<span class="nc bnc" id="L3976" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L3977">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L3978">            }</span>
        }
<span class="nc" id="L3980">    }</span>
    
    @Test
    void withTwoSentriesIfPartChangedConditionEventDeferred() {
        // Arrange
<span class="nc" id="L3985">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/twosentry-ifpart-condition-eventdeferred.cmmn.xml&quot;);</span>
<span class="nc" id="L3986">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L3987">                .caseDefinitionKey(&quot;testCase&quot;)</span>
<span class="nc" id="L3988">                .variable(&quot;var1&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L3989">                .start();</span>
        
<span class="nc" id="L3991">        cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;var1&quot;, &quot;test3&quot;);</span>
        
<span class="nc" id="L3993">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/twosentry-ifpart-eventdeferred-extratask.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L3996">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L3997">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L3998">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask3&quot;))</span>
<span class="nc" id="L3999">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L4002">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L4003">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4004">                .singleResult();</span>
<span class="nc" id="L4005">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4006">        assertThat(caseInstanceAfterMigration.getCaseDefinitionKey()).isEqualTo(&quot;testCase&quot;);</span>
<span class="nc" id="L4007">        assertThat(caseInstanceAfterMigration.getCaseDefinitionName()).isEqualTo(&quot;Sentry If Part Test Case&quot;);</span>
<span class="nc" id="L4008">        assertThat(caseInstanceAfterMigration.getCaseDefinitionVersion()).isEqualTo(2);</span>
<span class="nc" id="L4009">        assertThat(caseInstanceAfterMigration.getCaseDefinitionDeploymentId()).isEqualTo(destinationDefinition.getDeploymentId());</span>
        
<span class="nc" id="L4011">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4012">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4013">                .list();</span>
<span class="nc" id="L4014">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L4015">        assertThat(planItemInstances)</span>
<span class="nc" id="L4016">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L4017">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L4018">        assertThat(planItemInstances)</span>
<span class="nc" id="L4019">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L4020">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;, &quot;Task 3&quot;);</span>
<span class="nc" id="L4021">        assertThat(planItemInstances)</span>
<span class="nc" id="L4022">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4023">                .containsOnly(PlanItemInstanceState.AVAILABLE, PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L4025">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4026">        assertThat(tasks).hasSize(2);</span>
<span class="nc bnc" id="L4027" title="All 2 branches missed.">        for (Task task : tasks) {</span>
<span class="nc" id="L4028">            assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4029">            cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L4030">        }</span>
        
<span class="nc" id="L4032">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4033">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4034">                .list();</span>
        
<span class="nc" id="L4036">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L4037">        assertThat(planItemInstances)</span>
<span class="nc" id="L4038">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L4039">                .containsExactlyInAnyOrder(&quot;Task 2&quot;);</span>
<span class="nc" id="L4040">        assertThat(planItemInstances)</span>
<span class="nc" id="L4041">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4042">                .containsOnly(PlanItemInstanceState.AVAILABLE);</span>
        
<span class="nc" id="L4044">        cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;var1&quot;, &quot;test&quot;);</span>
        
<span class="nc" id="L4046">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4047">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4048">                .list();</span>
        
<span class="nc" id="L4050">        assertThat(planItemInstances)</span>
<span class="nc" id="L4051">            .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4052">            .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L4054">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L4055">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L4057">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L4059" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L4060">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L4061">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L4062">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L4064">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L4065">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4066">            assertThat(historicPlanItemInstances).hasSize(3);</span>
<span class="nc bnc" id="L4067" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L4068">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4069">            }</span>

<span class="nc" id="L4071">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4072">            assertThat(historicTasks).hasSize(3);</span>
<span class="nc bnc" id="L4073" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L4074">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4075">            }</span>
        }
<span class="nc" id="L4077">    }</span>
    
    @Test
    void withTwoSentriesIfPartEventDeferredToOnEvent() {
        // Arrange
<span class="nc" id="L4082">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/twosentry-ifpart-eventdeferred.cmmn.xml&quot;);</span>
<span class="nc" id="L4083">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L4084">                .caseDefinitionKey(&quot;testCase&quot;)</span>
<span class="nc" id="L4085">                .variable(&quot;var1&quot;, &quot;test&quot;)</span>
<span class="nc" id="L4086">                .start();</span>
        
<span class="nc" id="L4088">        cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;var1&quot;, &quot;test2&quot;);</span>
        
<span class="nc" id="L4090">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/twosentry-ifpart-onevent.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L4093">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L4094">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L4095">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L4098">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L4099">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4100">                .singleResult();</span>
<span class="nc" id="L4101">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4102">        assertThat(caseInstanceAfterMigration.getCaseDefinitionKey()).isEqualTo(&quot;testCase&quot;);</span>
<span class="nc" id="L4103">        assertThat(caseInstanceAfterMigration.getCaseDefinitionName()).isEqualTo(&quot;Sentry If Part Test Case&quot;);</span>
<span class="nc" id="L4104">        assertThat(caseInstanceAfterMigration.getCaseDefinitionVersion()).isEqualTo(2);</span>
<span class="nc" id="L4105">        assertThat(caseInstanceAfterMigration.getCaseDefinitionDeploymentId()).isEqualTo(destinationDefinition.getDeploymentId());</span>
        
<span class="nc" id="L4107">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4108">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4109">                .list();</span>
<span class="nc" id="L4110">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L4111">        assertThat(planItemInstances)</span>
<span class="nc" id="L4112">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L4113">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L4114">        assertThat(planItemInstances)</span>
<span class="nc" id="L4115">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L4116">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;);</span>
<span class="nc" id="L4117">        assertThat(planItemInstances)</span>
<span class="nc" id="L4118">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4119">                .containsOnly(PlanItemInstanceState.AVAILABLE, PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L4121">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4122">        assertThat(tasks).hasSize(1);</span>
<span class="nc" id="L4123">        assertThat(tasks.get(0).getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4124">        cmmnTaskService.complete(tasks.get(0).getId());</span>
        
<span class="nc" id="L4126">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4127">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4128">                .list();</span>
        
<span class="nc" id="L4130">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L4131">        assertThat(planItemInstances)</span>
<span class="nc" id="L4132">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L4133">                .containsExactlyInAnyOrder(&quot;Task 2&quot;);</span>
<span class="nc" id="L4134">        assertThat(planItemInstances)</span>
<span class="nc" id="L4135">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4136">                .containsOnly(PlanItemInstanceState.AVAILABLE);</span>
        
<span class="nc" id="L4138">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>
        
<span class="nc" id="L4140">        cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;var1&quot;, &quot;test&quot;);</span>
        
<span class="nc" id="L4142">        cmmnRuntimeService.createChangePlanItemStateBuilder().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4143">                .activatePlanItemDefinitionId(&quot;humanTask1&quot;)</span>
<span class="nc" id="L4144">                .changeState();</span>
        
<span class="nc" id="L4146">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L4147">        assertThat(task.getName()).isEqualTo(&quot;Task 1&quot;);</span>
        
<span class="nc" id="L4149">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L4151">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4152">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4153">                .list();</span>
        
<span class="nc" id="L4155">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L4156">        assertThat(planItemInstances)</span>
<span class="nc" id="L4157">            .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L4158">            .containsExactlyInAnyOrder(&quot;Task 2&quot;);</span>
<span class="nc" id="L4159">        assertThat(planItemInstances)</span>
<span class="nc" id="L4160">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4161">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L4163">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L4164">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L4166">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L4168" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L4169">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L4170">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L4171">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L4173">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L4174">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4175">            assertThat(historicPlanItemInstances).hasSize(3);</span>
<span class="nc bnc" id="L4176" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L4177">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4178">            }</span>

<span class="nc" id="L4180">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4181">            assertThat(historicTasks).hasSize(3);</span>
<span class="nc bnc" id="L4182" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L4183">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4184">            }</span>
        }
<span class="nc" id="L4186">    }</span>
    
    @Test
    void withExitSentryOnPartEventDeferred() {
        // Arrange
<span class="nc" id="L4191">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/exitsentry-onpart-eventdeferred.cmmn.xml&quot;);</span>
<span class="nc" id="L4192">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L4193">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/exitsentry-onpart-eventdeferred-extratask.cmmn.xml&quot;);</span>

<span class="nc" id="L4195">        Task firstTask = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask1&quot;).singleResult();</span>
<span class="nc" id="L4196">        cmmnTaskService.complete(firstTask.getId());</span>
        
<span class="nc" id="L4198">        List&lt;SentryPartInstanceEntity&gt; sentryPartInstances = cmmnEngineConfiguration.getCommandExecutor().execute(new Command&lt;&gt;() {</span>

            @Override
            public List&lt;SentryPartInstanceEntity&gt; execute(CommandContext commandContext) {
<span class="nc" id="L4202">                return cmmnEngineConfiguration.getSentryPartInstanceEntityManager().findSentryPartInstancesByCaseInstanceId(caseInstance.getId());</span>
            }

        });
        
<span class="nc" id="L4207">        assertThat(sentryPartInstances).hasSize(1);</span>
<span class="nc" id="L4208">        assertThat(sentryPartInstances.get(0).getOnPartId()).isEqualTo(&quot;sentryOnPartcmmnExitSentry_1&quot;);</span>
        
        // Act
<span class="nc" id="L4211">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L4212">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L4213">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask3&quot;))</span>
<span class="nc" id="L4214">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L4217">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L4218">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4219">                .singleResult();</span>
<span class="nc" id="L4220">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4221">        assertThat(caseInstanceAfterMigration.getCaseDefinitionKey()).isEqualTo(&quot;testCase&quot;);</span>
<span class="nc" id="L4222">        assertThat(caseInstanceAfterMigration.getCaseDefinitionName()).isEqualTo(&quot;Sentry On Part Test Case&quot;);</span>
<span class="nc" id="L4223">        assertThat(caseInstanceAfterMigration.getCaseDefinitionVersion()).isEqualTo(2);</span>
<span class="nc" id="L4224">        assertThat(caseInstanceAfterMigration.getCaseDefinitionDeploymentId()).isEqualTo(destinationDefinition.getDeploymentId());</span>
        
<span class="nc" id="L4226">        sentryPartInstances = cmmnEngineConfiguration.getCommandExecutor().execute(new Command&lt;&gt;() {</span>

            @Override
            public List&lt;SentryPartInstanceEntity&gt; execute(CommandContext commandContext) {
<span class="nc" id="L4230">                return cmmnEngineConfiguration.getSentryPartInstanceEntityManager().findSentryPartInstancesByCaseInstanceId(caseInstance.getId());</span>
            }

        });
        
<span class="nc" id="L4235">        assertThat(sentryPartInstances).hasSize(1);</span>
<span class="nc" id="L4236">        assertThat(sentryPartInstances.get(0).getOnPartId()).isEqualTo(&quot;sentryOnPartcmmnExitSentry_1&quot;);</span>
        
<span class="nc" id="L4238">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4239">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4240">                .list();</span>
<span class="nc" id="L4241">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L4242">        assertThat(planItemInstances)</span>
<span class="nc" id="L4243">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L4244">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L4245">        assertThat(planItemInstances)</span>
<span class="nc" id="L4246">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L4247">                .containsExactlyInAnyOrder(&quot;Task 2&quot;, &quot;Task 3&quot;);</span>
<span class="nc" id="L4248">        assertThat(planItemInstances)</span>
<span class="nc" id="L4249">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4250">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L4252">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask2&quot;).singleResult();</span>
<span class="nc" id="L4253">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L4255">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L4257" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L4258">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L4259">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L4260">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L4262">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L4263">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4264">            assertThat(historicPlanItemInstances).hasSize(3);</span>
<span class="nc bnc" id="L4265" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L4266">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4267">            }</span>

<span class="nc" id="L4269">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4270">            assertThat(historicTasks).hasSize(3);</span>
<span class="nc bnc" id="L4271" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L4272">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4273">            }</span>
        }
<span class="nc" id="L4275">    }</span>
    
    @Test
    void withExitSentryOnPartChangedIdEventDeferred() {
        // Arrange
<span class="nc" id="L4280">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/exitsentry-onpart-id-eventdeferred.cmmn.xml&quot;);</span>
<span class="nc" id="L4281">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L4282">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/exitsentry-onpart-eventdeferred-extratask.cmmn.xml&quot;);</span>

<span class="nc" id="L4284">        Task firstTask = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask1&quot;).singleResult();</span>
<span class="nc" id="L4285">        cmmnTaskService.complete(firstTask.getId());</span>
        
<span class="nc" id="L4287">        List&lt;SentryPartInstanceEntity&gt; sentryPartInstances = cmmnEngineConfiguration.getCommandExecutor().execute(new Command&lt;&gt;() {</span>

            @Override
            public List&lt;SentryPartInstanceEntity&gt; execute(CommandContext commandContext) {
<span class="nc" id="L4291">                return cmmnEngineConfiguration.getSentryPartInstanceEntityManager().findSentryPartInstancesByCaseInstanceId(caseInstance.getId());</span>
            }

        });
        
<span class="nc" id="L4296">        assertThat(sentryPartInstances).hasSize(1);</span>
<span class="nc" id="L4297">        assertThat(sentryPartInstances.get(0).getOnPartId()).isEqualTo(&quot;sentryOnPart1cmmnExitSentry_1&quot;);</span>
        
        // Act
<span class="nc" id="L4300">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L4301">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L4302">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask3&quot;))</span>
<span class="nc" id="L4303">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L4306">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L4307">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4308">                .singleResult();</span>
<span class="nc" id="L4309">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4310">        assertThat(caseInstanceAfterMigration.getCaseDefinitionKey()).isEqualTo(&quot;testCase&quot;);</span>
<span class="nc" id="L4311">        assertThat(caseInstanceAfterMigration.getCaseDefinitionName()).isEqualTo(&quot;Sentry On Part Test Case&quot;);</span>
<span class="nc" id="L4312">        assertThat(caseInstanceAfterMigration.getCaseDefinitionVersion()).isEqualTo(2);</span>
<span class="nc" id="L4313">        assertThat(caseInstanceAfterMigration.getCaseDefinitionDeploymentId()).isEqualTo(destinationDefinition.getDeploymentId());</span>
        
<span class="nc" id="L4315">        sentryPartInstances = cmmnEngineConfiguration.getCommandExecutor().execute(new Command&lt;&gt;() {</span>

            @Override
            public List&lt;SentryPartInstanceEntity&gt; execute(CommandContext commandContext) {
<span class="nc" id="L4319">                return cmmnEngineConfiguration.getSentryPartInstanceEntityManager().findSentryPartInstancesByCaseInstanceId(caseInstance.getId());</span>
            }

        });
        
<span class="nc" id="L4324">        assertThat(sentryPartInstances).hasSize(1);</span>
<span class="nc" id="L4325">        assertThat(sentryPartInstances.get(0).getOnPartId()).isEqualTo(&quot;sentryOnPartcmmnExitSentry_1&quot;);</span>
        
<span class="nc" id="L4327">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4328">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4329">                .list();</span>
<span class="nc" id="L4330">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L4331">        assertThat(planItemInstances)</span>
<span class="nc" id="L4332">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L4333">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L4334">        assertThat(planItemInstances)</span>
<span class="nc" id="L4335">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L4336">                .containsExactlyInAnyOrder(&quot;Task 2&quot;, &quot;Task 3&quot;);</span>
<span class="nc" id="L4337">        assertThat(planItemInstances)</span>
<span class="nc" id="L4338">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4339">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L4341">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask2&quot;).singleResult();</span>
<span class="nc" id="L4342">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L4344">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L4346" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L4347">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L4348">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L4349">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L4351">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L4352">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4353">            assertThat(historicPlanItemInstances).hasSize(3);</span>
<span class="nc bnc" id="L4354" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L4355">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4356">            }</span>

<span class="nc" id="L4358">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4359">            assertThat(historicTasks).hasSize(3);</span>
<span class="nc bnc" id="L4360" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L4361">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4362">            }</span>
        }
<span class="nc" id="L4364">    }</span>
    
    @Test
    void withExitSentryOnPartEventDeferredOnStage() {
        // Arrange
<span class="nc" id="L4369">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/exitsentry-stage-onpart-eventdeferred.cmmn.xml&quot;);</span>
<span class="nc" id="L4370">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L4371">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/exitsentry-stage-onpart-eventdeferred-extratask.cmmn.xml&quot;);</span>

<span class="nc" id="L4373">        Task firstTask = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;stageHumanTask1&quot;).singleResult();</span>
<span class="nc" id="L4374">        cmmnTaskService.complete(firstTask.getId());</span>
        
<span class="nc" id="L4376">        List&lt;SentryPartInstanceEntity&gt; sentryPartInstances = cmmnEngineConfiguration.getCommandExecutor().execute(new Command&lt;&gt;() {</span>

            @Override
            public List&lt;SentryPartInstanceEntity&gt; execute(CommandContext commandContext) {
<span class="nc" id="L4380">                return cmmnEngineConfiguration.getSentryPartInstanceEntityManager().findSentryPartInstancesByCaseInstanceId(caseInstance.getId());</span>
            }

        });
        
<span class="nc" id="L4385">        assertThat(sentryPartInstances).hasSize(1);</span>
<span class="nc" id="L4386">        assertThat(sentryPartInstances.get(0).getOnPartId()).isEqualTo(&quot;sentryOnPartcmmnExitSentry_1&quot;);</span>
        
        // Act
<span class="nc" id="L4389">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L4390">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L4391">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;stageHumanTask3&quot;))</span>
<span class="nc" id="L4392">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L4395">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L4396">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4397">                .singleResult();</span>
<span class="nc" id="L4398">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4399">        assertThat(caseInstanceAfterMigration.getCaseDefinitionKey()).isEqualTo(&quot;testCase&quot;);</span>
<span class="nc" id="L4400">        assertThat(caseInstanceAfterMigration.getCaseDefinitionName()).isEqualTo(&quot;Sentry On Part Test Case&quot;);</span>
<span class="nc" id="L4401">        assertThat(caseInstanceAfterMigration.getCaseDefinitionVersion()).isEqualTo(2);</span>
<span class="nc" id="L4402">        assertThat(caseInstanceAfterMigration.getCaseDefinitionDeploymentId()).isEqualTo(destinationDefinition.getDeploymentId());</span>
        
<span class="nc" id="L4404">        sentryPartInstances = cmmnEngineConfiguration.getCommandExecutor().execute(new Command&lt;&gt;() {</span>

            @Override
            public List&lt;SentryPartInstanceEntity&gt; execute(CommandContext commandContext) {
<span class="nc" id="L4408">                return cmmnEngineConfiguration.getSentryPartInstanceEntityManager().findSentryPartInstancesByCaseInstanceId(caseInstance.getId());</span>
            }

        });
        
<span class="nc" id="L4413">        assertThat(sentryPartInstances).hasSize(1);</span>
<span class="nc" id="L4414">        assertThat(sentryPartInstances.get(0).getOnPartId()).isEqualTo(&quot;sentryOnPartcmmnExitSentry_1&quot;);</span>
        
<span class="nc" id="L4416">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4417">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4418">                .list();</span>
<span class="nc" id="L4419">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L4420">        assertThat(planItemInstances)</span>
<span class="nc" id="L4421">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L4422">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L4423">        assertThat(planItemInstances)</span>
<span class="nc" id="L4424">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L4425">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Stage&quot;, &quot;Stage task 2&quot;, &quot;Stage task 3&quot;);</span>
<span class="nc" id="L4426">        assertThat(planItemInstances)</span>
<span class="nc" id="L4427">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4428">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L4430">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4431">        assertThat(tasks).hasSize(3);</span>
        
<span class="nc" id="L4433">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;stageHumanTask2&quot;).singleResult();</span>
<span class="nc" id="L4434">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L4436">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4437">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4438">                .list();</span>
        
<span class="nc" id="L4440">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L4441">        assertThat(planItemInstances)</span>
<span class="nc" id="L4442">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L4443">                .containsExactlyInAnyOrder(&quot;Task 1&quot;);</span>
<span class="nc" id="L4444">        assertThat(planItemInstances)</span>
<span class="nc" id="L4445">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4446">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L4448">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask1&quot;).singleResult();</span>
<span class="nc" id="L4449">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L4451">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L4453" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L4454">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L4455">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L4456">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L4458">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L4459">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4460">            assertThat(historicPlanItemInstances).hasSize(5);</span>
<span class="nc bnc" id="L4461" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L4462">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4463">            }</span>

<span class="nc" id="L4465">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4466">            assertThat(historicTasks).hasSize(4);</span>
<span class="nc bnc" id="L4467" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L4468">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4469">            }</span>
        }
<span class="nc" id="L4471">    }</span>
    
    @Test
    void withSentryIfPartEventDeferred() {
        // Arrange
<span class="nc" id="L4476">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/sentry-ifpart-eventdeferred.cmmn.xml&quot;);</span>
<span class="nc" id="L4477">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L4478">                .caseDefinitionKey(&quot;testCase&quot;)</span>
<span class="nc" id="L4479">                .variable(&quot;var1&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L4480">                .start();</span>
        
<span class="nc" id="L4482">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/sentry-ifpart-eventdeferred-extratask.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L4485">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L4486">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L4487">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;humanTask3&quot;))</span>
<span class="nc" id="L4488">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L4491">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L4492">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4493">                .singleResult();</span>
<span class="nc" id="L4494">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4495">        assertThat(caseInstanceAfterMigration.getCaseDefinitionKey()).isEqualTo(&quot;testCase&quot;);</span>
<span class="nc" id="L4496">        assertThat(caseInstanceAfterMigration.getCaseDefinitionName()).isEqualTo(&quot;Sentry If Part Test Case&quot;);</span>
<span class="nc" id="L4497">        assertThat(caseInstanceAfterMigration.getCaseDefinitionVersion()).isEqualTo(2);</span>
<span class="nc" id="L4498">        assertThat(caseInstanceAfterMigration.getCaseDefinitionDeploymentId()).isEqualTo(destinationDefinition.getDeploymentId());</span>
        
<span class="nc" id="L4500">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4501">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4502">                .list();</span>
<span class="nc" id="L4503">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L4504">        assertThat(planItemInstances)</span>
<span class="nc" id="L4505">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L4506">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L4507">        assertThat(planItemInstances)</span>
<span class="nc" id="L4508">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L4509">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;, &quot;Task 3&quot;);</span>
<span class="nc" id="L4510">        assertThat(planItemInstances)</span>
<span class="nc" id="L4511">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4512">                .containsOnly(PlanItemInstanceState.AVAILABLE, PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L4514">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4515">        assertThat(tasks).hasSize(2);</span>
<span class="nc bnc" id="L4516" title="All 2 branches missed.">        for (Task task : tasks) {</span>
<span class="nc" id="L4517">            assertThat(task.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4518">            cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L4519">        }</span>
        
<span class="nc" id="L4521">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4522">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4523">                .list();</span>
        
<span class="nc" id="L4525">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L4526">        assertThat(planItemInstances)</span>
<span class="nc" id="L4527">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L4528">                .containsExactlyInAnyOrder(&quot;Task 2&quot;);</span>
<span class="nc" id="L4529">        assertThat(planItemInstances)</span>
<span class="nc" id="L4530">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4531">                .containsOnly(PlanItemInstanceState.AVAILABLE);</span>
        
<span class="nc" id="L4533">        cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;var1&quot;, &quot;test&quot;);</span>
        
<span class="nc" id="L4535">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4536">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4537">                .list();</span>
        
<span class="nc" id="L4539">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L4540">        assertThat(planItemInstances)</span>
<span class="nc" id="L4541">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L4542">                .containsExactlyInAnyOrder(&quot;Task 2&quot;);</span>
<span class="nc" id="L4543">        assertThat(planItemInstances)</span>
<span class="nc" id="L4544">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4545">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L4547">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L4548">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L4550">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L4552" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L4553">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L4554">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L4555">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L4557">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L4558">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4559">            assertThat(historicPlanItemInstances).hasSize(3);</span>
<span class="nc bnc" id="L4560" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L4561">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4562">            }</span>

<span class="nc" id="L4564">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4565">            assertThat(historicTasks).hasSize(3);</span>
<span class="nc bnc" id="L4566" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L4567">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4568">            }</span>
        }
<span class="nc" id="L4570">    }</span>

    @Test
    void withPreUpgradeExpression() {
        // Arrange
<span class="nc" id="L4575">        CaseDefinition definition1 = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>
<span class="nc" id="L4576">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L4577">        CaseDefinition definition2 = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L4580">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L4581">                .migrateToCaseDefinition(definition2.getId())</span>
<span class="nc" id="L4582">                .withPreUpgradeExpression(&quot;${variableContainer.setVariable('preUpgradeExpressionExecuted', true)}&quot;)</span>
<span class="nc" id="L4583">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L4586">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L4587">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4588">                .includeCaseVariables()</span>
<span class="nc" id="L4589">                .singleResult();</span>
<span class="nc" id="L4590">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(definition2.getId());</span>
<span class="nc" id="L4591">        assertThat(caseInstanceAfterMigration.getCaseDefinitionVersion()).isEqualTo(2);</span>
<span class="nc" id="L4592">        assertThat(caseInstanceAfterMigration.getCaseDefinitionDeploymentId()).isEqualTo(definition2.getDeploymentId());</span>

<span class="nc" id="L4594">        assertThat((Boolean) caseInstanceAfterMigration.getCaseVariables().getOrDefault(&quot;preUpgradeExpressionExecuted&quot;, false)).isTrue();</span>
<span class="nc" id="L4595">    }</span>

    @Test
    void withPostUpgradeExpression() {
        // Arrange
<span class="nc" id="L4600">        CaseDefinition definition1 = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>
<span class="nc" id="L4601">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L4602">        CaseDefinition definition2 = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L4605">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L4606">                .migrateToCaseDefinition(definition2.getId())</span>
<span class="nc" id="L4607">                .withPostUpgradeExpression(&quot;${variableContainer.setVariable('postUpgradeExpressionExecuted', true)}&quot;)</span>
<span class="nc" id="L4608">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L4611">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L4612">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4613">                .includeCaseVariables()</span>
<span class="nc" id="L4614">                .singleResult();</span>
<span class="nc" id="L4615">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(definition2.getId());</span>
<span class="nc" id="L4616">        assertThat(caseInstanceAfterMigration.getCaseDefinitionVersion()).isEqualTo(2);</span>
<span class="nc" id="L4617">        assertThat(caseInstanceAfterMigration.getCaseDefinitionDeploymentId()).isEqualTo(definition2.getDeploymentId());</span>

<span class="nc" id="L4619">        assertThat((Boolean) caseInstanceAfterMigration.getCaseVariables().getOrDefault(&quot;postUpgradeExpressionExecuted&quot;, false)).isTrue();</span>
<span class="nc" id="L4620">    }</span>
    
    @Test
    void activatePlanItemWithCompletedStage() {
        // Arrange
<span class="nc" id="L4625">        CaseDefinition sourceDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/activate-planitem-ended-stages.cmmn.xml&quot;);</span>
<span class="nc" id="L4626">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;caseWithEndedStage&quot;).start();</span>
<span class="nc" id="L4627">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/activate-planitem-ended-stages.cmmn.xml&quot;);</span>

<span class="nc" id="L4629">        Task task = cmmnTaskService.createTaskQuery().scopeId(caseInstance.getId()).taskDefinitionKey(&quot;humanTask1&quot;).singleResult();</span>
<span class="nc" id="L4630">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L4632">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4633">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4634">                .list();</span>
<span class="nc" id="L4635">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L4636">        assertThat(planItemInstances)</span>
<span class="nc" id="L4637">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L4638">                .containsOnly(sourceDefinition.getId());</span>
<span class="nc" id="L4639">        assertThat(planItemInstances)</span>
<span class="nc" id="L4640">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L4641">                .containsExactlyInAnyOrder(&quot;Human task 2&quot;);</span>
        
<span class="nc" id="L4643">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4644">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4645">                .includeEnded()</span>
<span class="nc" id="L4646">                .list();</span>
<span class="nc" id="L4647">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L4648">        assertThat(planItemInstances)</span>
<span class="nc" id="L4649">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L4650">                .containsOnly(sourceDefinition.getId());</span>
<span class="nc" id="L4651">        assertThat(planItemInstances)</span>
<span class="nc" id="L4652">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L4653">                .containsExactlyInAnyOrder(&quot;Human task&quot;, &quot;Human task 2&quot;, &quot;Service task&quot;, &quot;Expanded stage&quot;);</span>

        // Act
<span class="nc" id="L4656">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L4657">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L4658">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;serviceTask1&quot;))</span>
<span class="nc" id="L4659">                .migrate(caseInstance.getId());</span>
        
<span class="nc" id="L4661">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L4662">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4663">                .singleResult();</span>
<span class="nc" id="L4664">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4665">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4666">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4667">                .list();</span>
<span class="nc" id="L4668">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L4669">        assertThat(planItemInstances)</span>
<span class="nc" id="L4670">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L4671">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L4672">        assertThat(planItemInstances)</span>
<span class="nc" id="L4673">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L4674">                .containsExactlyInAnyOrder(&quot;Human task 2&quot;);</span>
<span class="nc" id="L4675">        assertThat(planItemInstances)</span>
<span class="nc" id="L4676">                .filteredOn(&quot;name&quot;, &quot;Human task 2&quot;)</span>
<span class="nc" id="L4677">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4678">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L4680">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4681">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4682">                .includeEnded()</span>
<span class="nc" id="L4683">                .list();</span>
<span class="nc" id="L4684">        assertThat(planItemInstances).hasSize(5);</span>
<span class="nc" id="L4685">        assertThat(planItemInstances)</span>
<span class="nc" id="L4686">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L4687">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L4688">        assertThat(planItemInstances)</span>
<span class="nc" id="L4689">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L4690">                .containsExactlyInAnyOrder(&quot;Human task&quot;, &quot;Human task 2&quot;, &quot;Service task&quot;, &quot;Service task&quot;, &quot;Expanded stage&quot;);</span>

        // Assert
<span class="nc" id="L4693">        List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L4694">                .planItemInstanceCaseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4695">                .planItemInstanceDefinitionId(&quot;expandedStage1&quot;)</span>
<span class="nc" id="L4696">                .list();</span>

<span class="nc" id="L4698">        assertThat(historicPlanItemInstances.size()).isEqualTo(1);</span>
<span class="nc" id="L4699">        assertThat(historicPlanItemInstances.get(0).getState()).isEqualTo(&quot;completed&quot;);</span>
<span class="nc" id="L4700">    }</span>
    
    @Test
    void migrateCaseInstancesWithLocalVariablesForStage() {
        // Arrange
<span class="nc" id="L4705">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-local-variables.cmmn.xml&quot;);</span>
<span class="nc" id="L4706">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;example-stage-case&quot;).start();</span>
<span class="nc" id="L4707">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-local-variables-extra-task.cmmn.xml&quot;);</span>

<span class="nc" id="L4709">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
        
<span class="nc" id="L4711">        Map&lt;String, Object&gt; localStageVarMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L4712">        localStageVarMap.put(&quot;stageNr&quot;, 1);</span>
        
        // Act
<span class="nc" id="L4715">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L4716">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L4717">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;extra-task&quot;))</span>
<span class="nc" id="L4718">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;stage&quot;, null, localStageVarMap))</span>
<span class="nc" id="L4719">                .migrateCaseInstances(caseInstance.getCaseDefinitionId());</span>

        // Assert
<span class="nc" id="L4722">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L4723">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4724">                .singleResult();</span>
<span class="nc" id="L4725">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4726">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4727">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4728">                .includeEnded()</span>
<span class="nc" id="L4729">                .list();</span>
<span class="nc" id="L4730">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L4731">        assertThat(planItemInstances)</span>
<span class="nc" id="L4732">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L4733">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L4734">        assertThat(planItemInstances)</span>
<span class="nc" id="L4735">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L4736">                .containsExactlyInAnyOrder(&quot;Start Task&quot;, &quot;Stage&quot;, &quot;Stage Task 1&quot;, &quot;Extra Task&quot;);</span>
<span class="nc" id="L4737">        assertThat(planItemInstances)</span>
<span class="nc" id="L4738">                .filteredOn(&quot;name&quot;, &quot;Start Task&quot;)</span>
<span class="nc" id="L4739">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4740">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L4742">        assertThat(planItemInstances)</span>
<span class="nc" id="L4743">                .filteredOn(&quot;name&quot;, &quot;Stage&quot;)</span>
<span class="nc" id="L4744">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4745">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L4747">        assertThat(planItemInstances)</span>
<span class="nc" id="L4748">                .filteredOn(&quot;name&quot;, &quot;Stage Task 1&quot;)</span>
<span class="nc" id="L4749">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4750">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L4752">        assertThat(planItemInstances)</span>
<span class="nc" id="L4753">                .filteredOn(&quot;name&quot;, &quot;Extra Task&quot;)</span>
<span class="nc" id="L4754">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4755">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L4757">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(3);</span>
        
<span class="nc" id="L4759">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;stage-task&quot;).singleResult();</span>
<span class="nc" id="L4760">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L4762">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(2);</span>
        
<span class="nc" id="L4764">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;task&quot;).singleResult();</span>
<span class="nc" id="L4765">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L4767">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
        
<span class="nc" id="L4769">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;extra-task&quot;).singleResult();</span>
<span class="nc" id="L4770">        cmmnTaskService.complete(task.getId());</span>
    
<span class="nc" id="L4772">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L4774" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L4775">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L4776">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L4777">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L4779">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L4780">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4781">            assertThat(historicPlanItemInstances).hasSize(4);</span>
<span class="nc bnc" id="L4782" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L4783">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4784">            }</span>

<span class="nc" id="L4786">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4787">            assertThat(historicTasks).hasSize(3);</span>
<span class="nc bnc" id="L4788" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L4789">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4790">            }</span>
        }
<span class="nc" id="L4792">    }</span>
    
    @Test
    void migrateCaseInstancesWithLocalVariablesForRepeatingStage() {
        // Arrange
<span class="nc" id="L4797">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-repetition-local-variables.cmmn.xml&quot;);</span>
<span class="nc" id="L4798">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;example-stage-case&quot;).start();</span>
<span class="nc" id="L4799">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-repetition-local-variables-extra-task.cmmn.xml&quot;);</span>

<span class="nc" id="L4801">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(2);</span>
        
<span class="nc" id="L4803">        Map&lt;String, Object&gt; localStageVarMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L4804">        localStageVarMap.put(&quot;stageNr&quot;, 1);</span>
        
        // Act
<span class="nc" id="L4807">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L4808">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L4809">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;extra-task&quot;))</span>
<span class="nc" id="L4810">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;repeating-stage&quot;, null, localStageVarMap))</span>
<span class="nc" id="L4811">                .migrateCaseInstances(caseInstance.getCaseDefinitionId());</span>

        // Assert
<span class="nc" id="L4814">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L4815">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4816">                .singleResult();</span>
<span class="nc" id="L4817">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4818">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4819">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4820">                .includeEnded()</span>
<span class="nc" id="L4821">                .list();</span>
<span class="nc" id="L4822">        assertThat(planItemInstances).hasSize(6);</span>
<span class="nc" id="L4823">        assertThat(planItemInstances)</span>
<span class="nc" id="L4824">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L4825">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L4826">        assertThat(planItemInstances)</span>
<span class="nc" id="L4827">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L4828">                .containsExactlyInAnyOrder(&quot;Exit Task&quot;, &quot;Start Repeating Task&quot;, &quot;Repeating Stage&quot;, &quot;Repeating Stage&quot;, &quot;Stage repeating Task 1&quot;, &quot;Extra Task&quot;);</span>
<span class="nc" id="L4829">        assertThat(planItemInstances)</span>
<span class="nc" id="L4830">                .filteredOn(&quot;name&quot;, &quot;Start Repeating Task&quot;)</span>
<span class="nc" id="L4831">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4832">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L4834">        assertThat(planItemInstances)</span>
<span class="nc" id="L4835">                .filteredOn(&quot;name&quot;, &quot;Repeating Stage&quot;)</span>
<span class="nc" id="L4836">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4837">                .containsOnly(PlanItemInstanceState.ACTIVE, PlanItemInstanceState.WAITING_FOR_REPETITION);</span>
        
<span class="nc" id="L4839">        assertThat(planItemInstances)</span>
<span class="nc" id="L4840">                .filteredOn(&quot;name&quot;, &quot;Stage repeating Task 1&quot;)</span>
<span class="nc" id="L4841">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4842">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L4844">        assertThat(planItemInstances)</span>
<span class="nc" id="L4845">                .filteredOn(&quot;name&quot;, &quot;Extra Task&quot;)</span>
<span class="nc" id="L4846">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4847">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L4849">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(4);</span>
        
<span class="nc" id="L4851">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;stage-repeating-task&quot;).singleResult();</span>
<span class="nc" id="L4852">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L4854">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(3);</span>
        
<span class="nc" id="L4856">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;exit-task&quot;).singleResult();</span>
<span class="nc" id="L4857">        cmmnTaskService.complete(task.getId());</span>
    
<span class="nc" id="L4859">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L4861" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L4862">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L4863">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L4864">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L4866">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L4867">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4868">            assertThat(historicPlanItemInstances).hasSize(6);</span>
<span class="nc bnc" id="L4869" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L4870">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4871">            }</span>

<span class="nc" id="L4873">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4874">            assertThat(historicTasks).hasSize(4);</span>
<span class="nc bnc" id="L4875" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L4876">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4877">            }</span>
        }
<span class="nc" id="L4879">    }</span>
    
    @Test
    void migrateCaseInstancesWithLocalVariablesForAvailableStage() {
        // Arrange
<span class="nc" id="L4884">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/task-local-variables.cmmn.xml&quot;);</span>
<span class="nc" id="L4885">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;example-stage-case&quot;).start();</span>
<span class="nc" id="L4886">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-local-variables.cmmn.xml&quot;);</span>

<span class="nc" id="L4888">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
        
<span class="nc" id="L4890">        Map&lt;String, Object&gt; localStageVarMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L4891">        localStageVarMap.put(&quot;stageNr&quot;, 1);</span>
        
        // Act
<span class="nc" id="L4894">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L4895">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L4896">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;stage&quot;, localStageVarMap))</span>
<span class="nc" id="L4897">                .migrateCaseInstances(caseInstance.getCaseDefinitionId());</span>

        // Assert
<span class="nc" id="L4900">        CaseInstance caseInstanceAfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L4901">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4902">                .singleResult();</span>
<span class="nc" id="L4903">        assertThat(caseInstanceAfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4904">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4905">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L4906">                .includeEnded()</span>
<span class="nc" id="L4907">                .list();</span>
<span class="nc" id="L4908">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L4909">        assertThat(planItemInstances)</span>
<span class="nc" id="L4910">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L4911">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L4912">        assertThat(planItemInstances)</span>
<span class="nc" id="L4913">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L4914">                .containsExactlyInAnyOrder(&quot;Start Task&quot;, &quot;Stage&quot;);</span>
<span class="nc" id="L4915">        assertThat(planItemInstances)</span>
<span class="nc" id="L4916">                .filteredOn(&quot;name&quot;, &quot;Start Task&quot;)</span>
<span class="nc" id="L4917">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4918">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
        
<span class="nc" id="L4920">        assertThat(planItemInstances)</span>
<span class="nc" id="L4921">                .filteredOn(&quot;name&quot;, &quot;Stage&quot;)</span>
<span class="nc" id="L4922">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4923">                .containsOnly(PlanItemInstanceState.AVAILABLE);</span>
        
<span class="nc" id="L4925">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
        
<span class="nc" id="L4927">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;task&quot;).singleResult();</span>
<span class="nc" id="L4928">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L4930">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
        
<span class="nc" id="L4932">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).taskDefinitionKey(&quot;stage-task&quot;).singleResult();</span>
<span class="nc" id="L4933">        cmmnTaskService.complete(task.getId());</span>
        
<span class="nc" id="L4935">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L4937" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L4938">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L4939">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getCaseDefinitionId())</span>
<span class="nc" id="L4940">                .isEqualTo(destinationDefinition.getId());</span>

<span class="nc" id="L4942">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L4943">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4944">            assertThat(historicPlanItemInstances).hasSize(3);</span>
<span class="nc bnc" id="L4945" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItemInstances) {</span>
<span class="nc" id="L4946">                assertThat(historicPlanItemInstance.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4947">            }</span>

<span class="nc" id="L4949">            List&lt;HistoricTaskInstance&gt; historicTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L4950">            assertThat(historicTasks).hasSize(2);</span>
<span class="nc bnc" id="L4951" title="All 2 branches missed.">            for (HistoricTaskInstance historicTask : historicTasks) {</span>
<span class="nc" id="L4952">                assertThat(historicTask.getScopeDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4953">            }</span>
        }
<span class="nc" id="L4955">    }</span>

    @Test
    void migrateCaseInstancesWithConditionalActivate() {
        // Arrange
<span class="nc" id="L4960">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/two-task.cmmn.xml&quot;);</span>
<span class="nc" id="L4961">        CaseInstance caseInstance1 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).variable(&quot;activateTask3&quot;, true).start();</span>
<span class="nc" id="L4962">        CaseInstance caseInstance2 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).variable(&quot;activateTask3&quot;, false).start();</span>
<span class="nc" id="L4963">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/three-task.cmmn.xml&quot;);</span>

<span class="nc" id="L4965">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance1.getId()).count()).isEqualTo(2);</span>

        // Act
<span class="nc" id="L4968">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L4969">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L4970">                .addMoveToAvailablePlanItemDefinitionMapping(</span>
<span class="nc" id="L4971">                        PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;humanTask3&quot;, &quot;${activateTask3}&quot;))</span>
<span class="nc" id="L4972">                .migrateCaseInstances(caseInstance1.getCaseDefinitionId());</span>

        // Assert
<span class="nc" id="L4975">        CaseInstance caseInstance1AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L4976">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L4977">                .singleResult();</span>
<span class="nc" id="L4978">        assertThat(caseInstance1AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4979">        List&lt;PlanItemInstance&gt; planItemInstances1 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L4980">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L4981">                .includeEnded()</span>
<span class="nc" id="L4982">                .list();</span>
<span class="nc" id="L4983">        assertThat(planItemInstances1).hasSize(3);</span>
<span class="nc" id="L4984">        assertThat(planItemInstances1)</span>
<span class="nc" id="L4985">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L4986">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L4987">        assertThat(planItemInstances1)</span>
<span class="nc" id="L4988">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L4989">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;, &quot;Task 3&quot;);</span>
<span class="nc" id="L4990">        assertThat(planItemInstances1)</span>
<span class="nc" id="L4991">                .filteredOn(&quot;name&quot;, &quot;Task 3&quot;)</span>
<span class="nc" id="L4992">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L4993">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>

<span class="nc" id="L4995">        CaseInstance caseInstance2AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L4996">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L4997">                .singleResult();</span>
<span class="nc" id="L4998">        assertThat(caseInstance2AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L4999">        List&lt;PlanItemInstance&gt; planItemInstances2 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5000">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5001">                .includeEnded()</span>
<span class="nc" id="L5002">                .list();</span>
<span class="nc" id="L5003">        assertThat(planItemInstances2).hasSize(2);</span>
<span class="nc" id="L5004">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5005">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5006">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5007">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5008">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5009">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;);</span>
<span class="nc" id="L5010">    }</span>

    @Test
    void migrateCaseInstancesWithConditionalTerminateAndLocalVariable() {
        // Arrange
<span class="nc" id="L5015">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/two-task.cmmn.xml&quot;);</span>
<span class="nc" id="L5016">        CaseInstance caseInstance1 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L5017">        CaseInstance caseInstance2 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L5018">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/second-task-with-sentry.cmmn.xml&quot;);</span>

<span class="nc" id="L5020">        PlanItemInstance planItemInstanceCase1Task2 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5021">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5022">                .planItemInstanceName(&quot;Task 2&quot;)</span>
<span class="nc" id="L5023">                .singleResult();</span>
<span class="nc" id="L5024">        PlanItemInstance planItemInstanceCase2Task2 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5025">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5026">                .planItemInstanceName(&quot;Task 2&quot;)</span>
<span class="nc" id="L5027">                .singleResult();</span>
<span class="nc" id="L5028">        cmmnRuntimeService.setLocalVariable(planItemInstanceCase1Task2.getId(), &quot;disableTask2&quot;, false);</span>
<span class="nc" id="L5029">        cmmnRuntimeService.setLocalVariable(planItemInstanceCase2Task2.getId(), &quot;disableTask2&quot;, true);</span>

<span class="nc" id="L5031">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance1.getId()).count()).isEqualTo(2);</span>

        // Act
<span class="nc" id="L5034">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L5035">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L5036">                .addTerminatePlanItemDefinitionMapping(</span>
<span class="nc" id="L5037">                        PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;humanTask2&quot;, &quot;${disableTask2}&quot;))</span>
<span class="nc" id="L5038">                .migrateCaseInstances(caseInstance1.getCaseDefinitionId());</span>

        // Assert
<span class="nc" id="L5041">        CaseInstance caseInstance1AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5042">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5043">                .singleResult();</span>
<span class="nc" id="L5044">        assertThat(caseInstance1AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5045">        List&lt;PlanItemInstance&gt; planItemInstances1 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5046">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5047">                .includeEnded()</span>
<span class="nc" id="L5048">                .list();</span>
<span class="nc" id="L5049">        assertThat(planItemInstances1).hasSize(2);</span>
<span class="nc" id="L5050">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5051">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5052">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5053">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5054">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5055">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;);</span>
<span class="nc" id="L5056">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5057">                .filteredOn(&quot;name&quot;, &quot;Task 2&quot;)</span>
<span class="nc" id="L5058">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5059">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>

<span class="nc" id="L5061">        CaseInstance caseInstance2AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5062">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5063">                .singleResult();</span>
<span class="nc" id="L5064">        assertThat(caseInstance2AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5065">        List&lt;PlanItemInstance&gt; planItemInstances2 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5066">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5067">                .includeEnded()</span>
<span class="nc" id="L5068">                .list();</span>
<span class="nc" id="L5069">        assertThat(planItemInstances2).hasSize(2);</span>
<span class="nc" id="L5070">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5071">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5072">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5073">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5074">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5075">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;);</span>
<span class="nc" id="L5076">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5077">                .filteredOn(&quot;name&quot;, &quot;Task 2&quot;)</span>
<span class="nc" id="L5078">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5079">                .containsOnly(PlanItemInstanceState.TERMINATED);</span>
<span class="nc" id="L5080">    }</span>

    @Test
    void migrateCaseInstancesWithStageActive() {
        // Arrange
<span class="nc" id="L5085">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-three-tasks.cmmn.xml&quot;);</span>
<span class="nc" id="L5086">        CaseInstance caseInstance1 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;example-stage-case&quot;).start();</span>
<span class="nc" id="L5087">        CaseInstance caseInstance2 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;example-stage-case&quot;).start();</span>
<span class="nc" id="L5088">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-three-tasks-two-new.cmmn.xml&quot;);</span>

<span class="nc" id="L5090">        Task task = cmmnTaskService.createTaskQuery()</span>
<span class="nc" id="L5091">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5092">                .taskName(&quot;Task 1&quot;)</span>
<span class="nc" id="L5093">                .singleResult();</span>
<span class="nc" id="L5094">        cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L5096">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance1.getId()).count()).isEqualTo(2);</span>
<span class="nc" id="L5097">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance2.getId()).count()).isEqualTo(2);</span>

        // Act
<span class="nc" id="L5100">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L5101">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L5102">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;task4&quot;,</span>
                        &quot;${planItemInstances.definitionId(\&quot;cmmnStage_1\&quot;).active().exists()}&quot;))
<span class="nc" id="L5104">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;task5&quot;,</span>
                        &quot;${planItemInstances.definitionId(\&quot;cmmnStage_2\&quot;).active().exists()}&quot;))
<span class="nc" id="L5106">                .migrateCaseInstances(caseInstance1.getCaseDefinitionId());</span>

        // Assert
<span class="nc" id="L5109">        CaseInstance caseInstance1AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5110">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5111">                .singleResult();</span>
<span class="nc" id="L5112">        assertThat(caseInstance1AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5113">        List&lt;PlanItemInstance&gt; planItemInstances1 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5114">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5115">                .includeEnded()</span>
<span class="nc" id="L5116">                .list();</span>
<span class="nc" id="L5117">        assertThat(planItemInstances1).hasSize(6);</span>
<span class="nc" id="L5118">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5119">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5120">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5121">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5122">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5123">                .containsExactlyInAnyOrder(&quot;Task 2&quot;, &quot;Task 5&quot;, &quot;Task 3&quot;, &quot;Stage 1&quot;, &quot;Stage 2&quot;, &quot;Task 1&quot;);</span>
<span class="nc" id="L5124">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5125">                .filteredOn(&quot;name&quot;, &quot;Task 5&quot;)</span>
<span class="nc" id="L5126">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5127">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>

<span class="nc" id="L5129">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5130">                .filteredOn(&quot;name&quot;, &quot;Stage 1&quot;)</span>
<span class="nc" id="L5131">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5132">                .containsOnly(PlanItemInstanceState.COMPLETED);</span>
<span class="nc" id="L5133">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5134">                .filteredOn(&quot;name&quot;, &quot;Task 1&quot;)</span>
<span class="nc" id="L5135">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5136">                .containsOnly(PlanItemInstanceState.COMPLETED);</span>

<span class="nc" id="L5138">        CaseInstance caseInstance2AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5139">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5140">                .singleResult();</span>
<span class="nc" id="L5141">        assertThat(caseInstance2AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5142">        List&lt;PlanItemInstance&gt; planItemInstances2 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5143">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5144">                .includeEnded()</span>
<span class="nc" id="L5145">                .list();</span>
<span class="nc" id="L5146">        assertThat(planItemInstances2).hasSize(5);</span>
<span class="nc" id="L5147">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5148">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5149">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5150">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5151">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5152">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 4&quot;, &quot;Task 3&quot;, &quot;Stage 1&quot;, &quot;Stage 2&quot;);</span>
<span class="nc" id="L5153">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5154">                .filteredOn(&quot;name&quot;, &quot;Task 4&quot;)</span>
<span class="nc" id="L5155">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5156">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L5157">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5158">                .filteredOn(&quot;name&quot;, &quot;Stage 1&quot;)</span>
<span class="nc" id="L5159">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5160">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L5161">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5162">                .filteredOn(&quot;name&quot;, &quot;Stage 2&quot;)</span>
<span class="nc" id="L5163">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5164">                .containsOnly(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L5165">    }</span>

    @Test
    void migrateCaseInstancesWithStageActiveBasedOnStageCondition() {
        // Arrange
<span class="nc" id="L5170">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-three-tasks.cmmn.xml&quot;);</span>
<span class="nc" id="L5171">        CaseInstance caseInstance1 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;example-stage-case&quot;).variable(&quot;activateTask&quot;, false).start();</span>
<span class="nc" id="L5172">        CaseInstance caseInstance2 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;example-stage-case&quot;).variable(&quot;activateTask&quot;, false).start();</span>
<span class="nc" id="L5173">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-three-tasks-two-new.cmmn.xml&quot;);</span>

<span class="nc" id="L5175">        Task task = cmmnTaskService.createTaskQuery()</span>
<span class="nc" id="L5176">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5177">                .taskName(&quot;Task 1&quot;)</span>
<span class="nc" id="L5178">                .singleResult();</span>
<span class="nc" id="L5179">        cmmnTaskService.complete(task.getId());</span>

        // write the local variables activateTask to true to make the information available for every stage in which we are
<span class="nc" id="L5182">        List&lt;PlanItemInstance&gt; activeStages = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5183">                .planItemDefinitionType(ELEMENT_STAGE)</span>
<span class="nc" id="L5184">                .planItemInstanceStateActive()</span>
<span class="nc" id="L5185">                .list();</span>
<span class="nc bnc" id="L5186" title="All 2 branches missed.">        for (PlanItemInstance activeStage : activeStages) {</span>
<span class="nc" id="L5187">            cmmnRuntimeService.setLocalVariable(activeStage.getId(), &quot;activateTask&quot;, true);</span>
<span class="nc" id="L5188">        }</span>

<span class="nc" id="L5190">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance1.getId()).count()).isEqualTo(2);</span>
<span class="nc" id="L5191">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance2.getId()).count()).isEqualTo(2);</span>

        // Act
<span class="nc" id="L5194">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L5195">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
                // we can't assume that it's the direct parent, since it's always taking the closest active ancestor
<span class="nc" id="L5197">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;task4&quot;,</span>
                        &quot;${activateTask}&quot;))
<span class="nc" id="L5199">                .addActivatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;task5&quot;,</span>
                        &quot;${activateTask}&quot;))
<span class="nc" id="L5201">                .migrateCaseInstances(caseInstance1.getCaseDefinitionId());</span>

        // Assert
<span class="nc" id="L5204">        CaseInstance caseInstance1AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5205">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5206">                .singleResult();</span>
<span class="nc" id="L5207">        assertThat(caseInstance1AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5208">        List&lt;PlanItemInstance&gt; planItemInstances1 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5209">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5210">                .includeEnded()</span>
<span class="nc" id="L5211">                .list();</span>
<span class="nc" id="L5212">        assertThat(planItemInstances1).hasSize(6);</span>
<span class="nc" id="L5213">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5214">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5215">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5216">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5217">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5218">                .containsExactlyInAnyOrder(&quot;Task 2&quot;, &quot;Task 5&quot;, &quot;Task 3&quot;, &quot;Stage 1&quot;, &quot;Stage 2&quot;, &quot;Task 1&quot;);</span>
<span class="nc" id="L5219">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5220">                .filteredOn(&quot;name&quot;, &quot;Task 5&quot;)</span>
<span class="nc" id="L5221">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5222">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>

<span class="nc" id="L5224">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5225">                .filteredOn(&quot;name&quot;, &quot;Stage 1&quot;)</span>
<span class="nc" id="L5226">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5227">                .containsOnly(PlanItemInstanceState.COMPLETED);</span>
<span class="nc" id="L5228">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5229">                .filteredOn(&quot;name&quot;, &quot;Task 1&quot;)</span>
<span class="nc" id="L5230">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5231">                .containsOnly(PlanItemInstanceState.COMPLETED);</span>

<span class="nc" id="L5233">        CaseInstance caseInstance2AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5234">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5235">                .singleResult();</span>
<span class="nc" id="L5236">        assertThat(caseInstance2AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5237">        List&lt;PlanItemInstance&gt; planItemInstances2 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5238">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5239">                .includeEnded()</span>
<span class="nc" id="L5240">                .list();</span>
<span class="nc" id="L5241">        assertThat(planItemInstances2).hasSize(5);</span>
<span class="nc" id="L5242">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5243">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5244">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5245">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5246">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5247">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 4&quot;, &quot;Task 3&quot;, &quot;Stage 1&quot;, &quot;Stage 2&quot;);</span>
<span class="nc" id="L5248">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5249">                .filteredOn(&quot;name&quot;, &quot;Task 4&quot;)</span>
<span class="nc" id="L5250">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5251">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L5252">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5253">                .filteredOn(&quot;name&quot;, &quot;Stage 1&quot;)</span>
<span class="nc" id="L5254">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5255">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L5256">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5257">                .filteredOn(&quot;name&quot;, &quot;Stage 2&quot;)</span>
<span class="nc" id="L5258">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5259">                .containsOnly(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L5260">    }</span>

    @Test
    void migrateCaseInstancesWithStageAvailableBasedOnStageCondition() {
        // Arrange
<span class="nc" id="L5265">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-three-tasks.cmmn.xml&quot;);</span>
<span class="nc" id="L5266">        CaseInstance caseInstance1 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;example-stage-case&quot;).variable(&quot;activateTask&quot;, false).start();</span>
<span class="nc" id="L5267">        CaseInstance caseInstance2 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;example-stage-case&quot;).variable(&quot;activateTask&quot;, false).start();</span>
<span class="nc" id="L5268">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-three-tasks-two-new.cmmn.xml&quot;);</span>

<span class="nc" id="L5270">        Task task = cmmnTaskService.createTaskQuery()</span>
<span class="nc" id="L5271">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5272">                .taskName(&quot;Task 1&quot;)</span>
<span class="nc" id="L5273">                .singleResult();</span>
<span class="nc" id="L5274">        cmmnTaskService.complete(task.getId());</span>

        // write the local variables activateTask to true to make the information available for every stage in which we are
<span class="nc" id="L5277">        List&lt;PlanItemInstance&gt; activeStages = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5278">                .planItemDefinitionType(ELEMENT_STAGE)</span>
<span class="nc" id="L5279">                .planItemInstanceStateActive()</span>
<span class="nc" id="L5280">                .list();</span>
<span class="nc bnc" id="L5281" title="All 2 branches missed.">        for (PlanItemInstance activeStage : activeStages) {</span>
<span class="nc" id="L5282">            cmmnRuntimeService.setLocalVariable(activeStage.getId(), &quot;activateTask&quot;, true);</span>
<span class="nc" id="L5283">        }</span>

<span class="nc" id="L5285">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance1.getId()).count()).isEqualTo(2);</span>
<span class="nc" id="L5286">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance2.getId()).count()).isEqualTo(2);</span>

        // Act
<span class="nc" id="L5289">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L5290">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
                // we can't assume that it's the direct parent, since it's always taking the closest active ancestor
<span class="nc" id="L5292">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;task4&quot;,</span>
                        &quot;${activateTask}&quot;))
<span class="nc" id="L5294">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;task5&quot;,</span>
                        &quot;${activateTask}&quot;))
<span class="nc" id="L5296">                .migrateCaseInstances(caseInstance1.getCaseDefinitionId());</span>

        // Assert
<span class="nc" id="L5299">        CaseInstance caseInstance1AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5300">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5301">                .singleResult();</span>
<span class="nc" id="L5302">        assertThat(caseInstance1AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5303">        List&lt;PlanItemInstance&gt; planItemInstances1 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5304">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5305">                .includeEnded()</span>
<span class="nc" id="L5306">                .list();</span>
<span class="nc" id="L5307">        assertThat(planItemInstances1).hasSize(6);</span>
<span class="nc" id="L5308">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5309">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5310">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5311">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5312">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5313">                .containsExactlyInAnyOrder(&quot;Task 2&quot;, &quot;Task 5&quot;, &quot;Task 3&quot;, &quot;Stage 1&quot;, &quot;Stage 2&quot;, &quot;Task 1&quot;);</span>
<span class="nc" id="L5314">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5315">                .filteredOn(&quot;name&quot;, &quot;Task 5&quot;)</span>
<span class="nc" id="L5316">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5317">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>

<span class="nc" id="L5319">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5320">                .filteredOn(&quot;name&quot;, &quot;Stage 1&quot;)</span>
<span class="nc" id="L5321">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5322">                .containsOnly(PlanItemInstanceState.COMPLETED);</span>
<span class="nc" id="L5323">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5324">                .filteredOn(&quot;name&quot;, &quot;Task 1&quot;)</span>
<span class="nc" id="L5325">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5326">                .containsOnly(PlanItemInstanceState.COMPLETED);</span>

<span class="nc" id="L5328">        CaseInstance caseInstance2AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5329">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5330">                .singleResult();</span>
<span class="nc" id="L5331">        assertThat(caseInstance2AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5332">        List&lt;PlanItemInstance&gt; planItemInstances2 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5333">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5334">                .includeEnded()</span>
<span class="nc" id="L5335">                .list();</span>
<span class="nc" id="L5336">        assertThat(planItemInstances2).hasSize(5);</span>
<span class="nc" id="L5337">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5338">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5339">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5340">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5341">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5342">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 4&quot;, &quot;Task 3&quot;, &quot;Stage 1&quot;, &quot;Stage 2&quot;);</span>
<span class="nc" id="L5343">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5344">                .filteredOn(&quot;name&quot;, &quot;Task 4&quot;)</span>
<span class="nc" id="L5345">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5346">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L5347">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5348">                .filteredOn(&quot;name&quot;, &quot;Stage 1&quot;)</span>
<span class="nc" id="L5349">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5350">                .containsOnly(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L5351">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5352">                .filteredOn(&quot;name&quot;, &quot;Stage 2&quot;)</span>
<span class="nc" id="L5353">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5354">                .containsOnly(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L5355">    }</span>

    @Test
    void migrateCaseInstancesWithMoveStageToAvailableAndAlreadyAvailableStage() {
        // Arrange
<span class="nc" id="L5360">        CaseDefinition definition1 = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/task-followed-by-stage.cmmn.xml&quot;);</span>
<span class="nc" id="L5361">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L5362">        CaseDefinition definition2 = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/task-followed-by-stage.cmmn.xml&quot;);</span>

<span class="nc" id="L5364">        assertThat(definition2.getId()).isNotEqualTo(definition1.getId());</span>

        // Act
<span class="nc" id="L5367">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L5368">                .migrateToCaseDefinition(definition2.getId())</span>
<span class="nc" id="L5369">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;cmmnStage_2&quot;))</span>
<span class="nc" id="L5370">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L5373">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5374">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L5375">                .list();</span>
<span class="nc" id="L5376">        assertThat(planItemInstances)</span>
<span class="nc" id="L5377">                .hasSize(2)</span>
<span class="nc" id="L5378">                .extracting(PlanItemInstance::getName, PlanItemInstance::getState)</span>
<span class="nc" id="L5379">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L5380">                        Tuple.tuple(&quot;Task 1&quot;, PlanItemInstanceState.ACTIVE),</span>
<span class="nc" id="L5381">                        Tuple.tuple(&quot;Stage&quot;, PlanItemInstanceState.AVAILABLE)</span>
                );
<span class="nc" id="L5383">    }</span>

    @Test
    void migrateCaseInstancesWithRepetitionAndStageVariable() {
        // Arrange
<span class="nc" id="L5388">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-with-user-event-listener-and-task.cmmn.xml&quot;);</span>
<span class="nc" id="L5389">        CaseInstance caseInstance1 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;repetitionCase&quot;).start();</span>
<span class="nc" id="L5390">        CaseInstance caseInstance2 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;repetitionCase&quot;).start();</span>
<span class="nc" id="L5391">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-with-user-event-listener-and-task-with-repetition.cmmn.xml&quot;);</span>

<span class="nc" id="L5393">        PlanItemInstance caseInstance1Stage = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5394">                .planItemInstanceName(&quot;Stage&quot;)</span>
<span class="nc" id="L5395">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5396">                .singleResult();</span>
<span class="nc" id="L5397">        cmmnRuntimeService.setLocalVariable(caseInstance1Stage.getId(), &quot;addRepetition&quot;, true);</span>

<span class="nc" id="L5399">        PlanItemInstance userEventListenerPlanItemInstance1 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5400">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5401">                .planItemDefinitionId(&quot;userEventListener&quot;)</span>
<span class="nc" id="L5402">                .singleResult();</span>
<span class="nc" id="L5403">        cmmnRuntimeService.triggerPlanItemInstance(userEventListenerPlanItemInstance1.getId());</span>

<span class="nc" id="L5405">        PlanItemInstance caseInstance2Stage = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5406">                .planItemInstanceName(&quot;Stage&quot;)</span>
<span class="nc" id="L5407">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5408">                .singleResult();</span>
<span class="nc" id="L5409">        cmmnRuntimeService.setLocalVariable(caseInstance2Stage.getId(), &quot;addRepetition&quot;, false);</span>

        // Act
<span class="nc" id="L5412">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L5413">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L5414">                .addWaitingForRepetitionPlanItemDefinitionMapping(</span>
<span class="nc" id="L5415">                        PlanItemDefinitionMappingBuilder.createWaitingForRepetitionPlanItemDefinitionMappingFor(&quot;humanTask&quot;, &quot;${addRepetition}&quot;)</span>
                )
<span class="nc" id="L5417">                .migrateCaseInstances(caseInstance1.getCaseDefinitionId());</span>

        // Assert
<span class="nc" id="L5420">        CaseInstance caseInstance1AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5421">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5422">                .singleResult();</span>
<span class="nc" id="L5423">        assertThat(caseInstance1AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5424">        List&lt;PlanItemInstance&gt; planItemInstances1 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5425">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5426">                .includeEnded()</span>
<span class="nc" id="L5427">                .list();</span>
<span class="nc" id="L5428">        assertThat(planItemInstances1).hasSize(4);</span>
<span class="nc" id="L5429">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5430">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5431">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5432">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5433">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5434">                .containsExactlyInAnyOrder(&quot;Stage&quot;, &quot;User Event Listener&quot;, &quot;Human Task&quot;, &quot;Human Task&quot;);</span>
<span class="nc" id="L5435">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5436">                .filteredOn(&quot;name&quot;, &quot;Human Task&quot;)</span>
<span class="nc" id="L5437">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5438">                .containsExactlyInAnyOrder(PlanItemInstanceState.ACTIVE, PlanItemInstanceState.WAITING_FOR_REPETITION);</span>

<span class="nc" id="L5440">        CaseInstance caseInstance2AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5441">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5442">                .singleResult();</span>
<span class="nc" id="L5443">        assertThat(caseInstance2AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5444">        List&lt;PlanItemInstance&gt; planItemInstances2 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5445">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5446">                .includeEnded()</span>
<span class="nc" id="L5447">                .list();</span>
<span class="nc" id="L5448">        assertThat(planItemInstances2).hasSize(3);</span>
<span class="nc" id="L5449">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5450">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5451">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5452">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5453">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5454">                .containsExactlyInAnyOrder(&quot;Stage&quot;, &quot;User Event Listener&quot;, &quot;Human Task&quot;);</span>
<span class="nc" id="L5455">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5456">                .filteredOn(&quot;name&quot;, &quot;Human Task&quot;)</span>
<span class="nc" id="L5457">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5458">                .containsExactlyInAnyOrder(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L5459">    }</span>

    @Test
    void migrateCaseInstancesWithRepetitionAndStageVariableAndInactiveHumanTask() {
        // Arrange
<span class="nc" id="L5464">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-with-user-event-listener-and-task.cmmn.xml&quot;);</span>
<span class="nc" id="L5465">        CaseInstance caseInstance1 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;repetitionCase&quot;).start();</span>
<span class="nc" id="L5466">        CaseInstance caseInstance2 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;repetitionCase&quot;).start();</span>
<span class="nc" id="L5467">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-with-user-event-listener-and-task-with-repetition.cmmn.xml&quot;);</span>

<span class="nc" id="L5469">        PlanItemInstance caseInstance1Stage = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5470">                .planItemInstanceName(&quot;Stage&quot;)</span>
<span class="nc" id="L5471">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5472">                .singleResult();</span>
<span class="nc" id="L5473">        cmmnRuntimeService.setLocalVariable(caseInstance1Stage.getId(), &quot;addRepetition&quot;, true);</span>

<span class="nc" id="L5475">        PlanItemInstance caseInstance2Stage = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5476">                .planItemInstanceName(&quot;Stage&quot;)</span>
<span class="nc" id="L5477">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5478">                .singleResult();</span>
<span class="nc" id="L5479">        cmmnRuntimeService.setLocalVariable(caseInstance2Stage.getId(), &quot;addRepetition&quot;, false);</span>

        // Act
<span class="nc" id="L5482">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L5483">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L5484">                .addWaitingForRepetitionPlanItemDefinitionMapping(</span>
<span class="nc" id="L5485">                        PlanItemDefinitionMappingBuilder.createWaitingForRepetitionPlanItemDefinitionMappingFor(&quot;humanTask&quot;, &quot;${addRepetition}&quot;)</span>
                )
<span class="nc" id="L5487">                .migrateCaseInstances(caseInstance1.getCaseDefinitionId());</span>

        // Assert
<span class="nc" id="L5490">        CaseInstance caseInstance1AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5491">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5492">                .singleResult();</span>
<span class="nc" id="L5493">        assertThat(caseInstance1AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5494">        List&lt;PlanItemInstance&gt; planItemInstances1 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5495">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5496">                .includeEnded()</span>
<span class="nc" id="L5497">                .list();</span>
<span class="nc" id="L5498">        assertThat(planItemInstances1).hasSize(4);</span>
<span class="nc" id="L5499">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5500">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5501">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5502">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5503">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5504">                .containsExactlyInAnyOrder(&quot;Stage&quot;, &quot;User Event Listener&quot;, &quot;Human Task&quot;, &quot;Human Task&quot;);</span>
<span class="nc" id="L5505">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5506">                .filteredOn(&quot;name&quot;, &quot;Human Task&quot;)</span>
<span class="nc" id="L5507">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5508">                .containsExactlyInAnyOrder(PlanItemInstanceState.AVAILABLE, PlanItemInstanceState.WAITING_FOR_REPETITION);</span>

<span class="nc" id="L5510">        CaseInstance caseInstance2AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5511">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5512">                .singleResult();</span>
<span class="nc" id="L5513">        assertThat(caseInstance2AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5514">        List&lt;PlanItemInstance&gt; planItemInstances2 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5515">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5516">                .includeEnded()</span>
<span class="nc" id="L5517">                .list();</span>
<span class="nc" id="L5518">        assertThat(planItemInstances2).hasSize(3);</span>
<span class="nc" id="L5519">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5520">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5521">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5522">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5523">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5524">                .containsExactlyInAnyOrder(&quot;Stage&quot;, &quot;User Event Listener&quot;, &quot;Human Task&quot;);</span>
<span class="nc" id="L5525">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5526">                .filteredOn(&quot;name&quot;, &quot;Human Task&quot;)</span>
<span class="nc" id="L5527">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5528">                .containsExactlyInAnyOrder(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L5529">    }</span>

    @Test
    void migrateCaseInstancesWithRepetitionAndPlanItemVariable() {
        // Arrange
<span class="nc" id="L5534">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-with-user-event-listener-and-task.cmmn.xml&quot;);</span>
<span class="nc" id="L5535">        CaseInstance caseInstance1 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;repetitionCase&quot;).start();</span>
<span class="nc" id="L5536">        CaseInstance caseInstance2 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;repetitionCase&quot;).start();</span>
<span class="nc" id="L5537">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-with-user-event-listener-and-task-with-repetition.cmmn.xml&quot;);</span>

<span class="nc" id="L5539">        PlanItemInstance humanTaskCase1 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5540">                .planItemInstanceName(&quot;Human Task&quot;)</span>
<span class="nc" id="L5541">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5542">                .singleResult();</span>
<span class="nc" id="L5543">        cmmnRuntimeService.setLocalVariable(humanTaskCase1.getId(), &quot;addRepetition&quot;, true);</span>

<span class="nc" id="L5545">        PlanItemInstance userEventListenerPlanItemInstance1 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5546">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5547">                .planItemDefinitionId(&quot;userEventListener&quot;)</span>
<span class="nc" id="L5548">                .singleResult();</span>
<span class="nc" id="L5549">        cmmnRuntimeService.triggerPlanItemInstance(userEventListenerPlanItemInstance1.getId());</span>

<span class="nc" id="L5551">        PlanItemInstance caseInstance2Stage = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5552">                .planItemInstanceName(&quot;Stage&quot;)</span>
<span class="nc" id="L5553">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5554">                .singleResult();</span>
<span class="nc" id="L5555">        cmmnRuntimeService.setLocalVariable(caseInstance2Stage.getId(), &quot;addRepetition&quot;, false);</span>

        // Act
<span class="nc" id="L5558">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L5559">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L5560">                .addWaitingForRepetitionPlanItemDefinitionMapping(</span>
<span class="nc" id="L5561">                        PlanItemDefinitionMappingBuilder.createWaitingForRepetitionPlanItemDefinitionMappingFor(&quot;humanTask&quot;, &quot;${addRepetition}&quot;)</span>
                )
<span class="nc" id="L5563">                .migrateCaseInstances(caseInstance1.getCaseDefinitionId());</span>

        // Assert
<span class="nc" id="L5566">        CaseInstance caseInstance1AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5567">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5568">                .singleResult();</span>
<span class="nc" id="L5569">        assertThat(caseInstance1AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5570">        List&lt;PlanItemInstance&gt; planItemInstances1 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5571">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5572">                .includeEnded()</span>
<span class="nc" id="L5573">                .list();</span>
<span class="nc" id="L5574">        assertThat(planItemInstances1).hasSize(4);</span>
<span class="nc" id="L5575">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5576">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5577">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5578">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5579">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5580">                .containsExactlyInAnyOrder(&quot;Stage&quot;, &quot;User Event Listener&quot;, &quot;Human Task&quot;, &quot;Human Task&quot;);</span>
<span class="nc" id="L5581">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5582">                .filteredOn(&quot;name&quot;, &quot;Human Task&quot;)</span>
<span class="nc" id="L5583">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5584">                .containsExactlyInAnyOrder(PlanItemInstanceState.ACTIVE, PlanItemInstanceState.WAITING_FOR_REPETITION);</span>

<span class="nc" id="L5586">        CaseInstance caseInstance2AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5587">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5588">                .singleResult();</span>
<span class="nc" id="L5589">        assertThat(caseInstance2AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5590">        List&lt;PlanItemInstance&gt; planItemInstances2 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5591">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5592">                .includeEnded()</span>
<span class="nc" id="L5593">                .list();</span>
<span class="nc" id="L5594">        assertThat(planItemInstances2).hasSize(3);</span>
<span class="nc" id="L5595">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5596">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5597">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5598">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5599">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5600">                .containsExactlyInAnyOrder(&quot;Stage&quot;, &quot;User Event Listener&quot;, &quot;Human Task&quot;);</span>
<span class="nc" id="L5601">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5602">                .filteredOn(&quot;name&quot;, &quot;Human Task&quot;)</span>
<span class="nc" id="L5603">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5604">                .containsExactlyInAnyOrder(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L5605">    }</span>

    @Test
    void migrateCaseInstancesWithTerminateBasedOnCondition() {
        // Arrange
<span class="nc" id="L5610">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/two-task-repetition.cmmn.xml&quot;);</span>
<span class="nc" id="L5611">        CaseInstance caseInstance1 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L5612">        CaseInstance caseInstance2 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L5613">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/two-task.cmmn.xml&quot;);</span>

<span class="nc" id="L5615">        Task task = cmmnTaskService.createTaskQuery()</span>
<span class="nc" id="L5616">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5617">                .taskName(&quot;Task 2&quot;)</span>
<span class="nc" id="L5618">                .singleResult();</span>
<span class="nc" id="L5619">        cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L5621">        List&lt;PlanItemInstance&gt; planItemInstances1Before = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5622">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5623">                .includeEnded()</span>
<span class="nc" id="L5624">                .list();</span>
<span class="nc" id="L5625">        assertThat(planItemInstances1Before)</span>
<span class="nc" id="L5626">                .filteredOn(&quot;name&quot;, &quot;Task 2&quot;)</span>
<span class="nc" id="L5627">                .hasSize(2)</span>
<span class="nc" id="L5628">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5629">                .containsExactlyInAnyOrder(PlanItemInstanceState.ACTIVE, PlanItemInstanceState.COMPLETED);</span>

<span class="nc" id="L5631">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance1.getId()).count()).isEqualTo(2);</span>
<span class="nc" id="L5632">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance2.getId()).count()).isEqualTo(2);</span>

        // Act
<span class="nc" id="L5635">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L5636">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L5637">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;humanTask2&quot;,</span>
                        &quot;${planItemInstances.definitionId(\&quot;humanTask2\&quot;).completed().exists()}&quot;))
<span class="nc" id="L5639">                .migrateCaseInstances(caseInstance1.getCaseDefinitionId());</span>

        // Assert
<span class="nc" id="L5642">        CaseInstance caseInstance1AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5643">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5644">                .singleResult();</span>
<span class="nc" id="L5645">        assertThat(caseInstance1AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5646">        List&lt;PlanItemInstance&gt; planItemInstances1 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5647">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5648">                .includeEnded()</span>
<span class="nc" id="L5649">                .list();</span>
<span class="nc" id="L5650">        assertThat(planItemInstances1).hasSize(3);</span>
<span class="nc" id="L5651">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5652">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5653">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5654">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5655">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5656">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;, &quot;Task 2&quot;);</span>
<span class="nc" id="L5657">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5658">                .filteredOn(&quot;name&quot;, &quot;Task 2&quot;)</span>
<span class="nc" id="L5659">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5660">                .containsExactlyInAnyOrder(PlanItemInstanceState.TERMINATED, PlanItemInstanceState.COMPLETED);</span>

<span class="nc" id="L5662">        CaseInstance caseInstance2AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5663">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5664">                .singleResult();</span>
<span class="nc" id="L5665">        assertThat(caseInstance2AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5666">        List&lt;PlanItemInstance&gt; planItemInstances2 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5667">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5668">                .includeEnded()</span>
<span class="nc" id="L5669">                .list();</span>
<span class="nc" id="L5670">        assertThat(planItemInstances2).hasSize(2);</span>
<span class="nc" id="L5671">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5672">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5673">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5674">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5675">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5676">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;);</span>
<span class="nc" id="L5677">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5678">                .filteredOn(&quot;name&quot;, &quot;Task 2&quot;)</span>
<span class="nc" id="L5679">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5680">                .containsExactlyInAnyOrder(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L5681">    }</span>

    @Test
    void migrateCaseInstancesWithRepetitionRemoveWaitingForRepetitionAndPlanItemVariable() {
        // Arrange
<span class="nc" id="L5686">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-with-user-event-listener-and-task-with-repetition.cmmn.xml&quot;);</span>
<span class="nc" id="L5687">        CaseInstance caseInstance1 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;repetitionCase&quot;).start();</span>
<span class="nc" id="L5688">        CaseInstance caseInstance2 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;repetitionCase&quot;).start();</span>
<span class="nc" id="L5689">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-with-user-event-listener-and-task.cmmn.xml&quot;);</span>

<span class="nc" id="L5691">        PlanItemInstance userEventListenerPlanItemInstance1 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5692">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5693">                .planItemDefinitionId(&quot;userEventListener&quot;)</span>
<span class="nc" id="L5694">                .singleResult();</span>
<span class="nc" id="L5695">        cmmnRuntimeService.triggerPlanItemInstance(userEventListenerPlanItemInstance1.getId());</span>

<span class="nc" id="L5697">        PlanItemInstance humanTaskCase1 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5698">                .planItemInstanceName(&quot;Human Task&quot;)</span>
<span class="nc" id="L5699">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5700">                .planItemInstanceStateWaitingForRepetition()</span>
<span class="nc" id="L5701">                .singleResult();</span>
<span class="nc" id="L5702">        cmmnRuntimeService.setLocalVariable(humanTaskCase1.getId(), &quot;removeRepetition&quot;, true);</span>

<span class="nc" id="L5704">        PlanItemInstance userEventListenerPlanItemInstance2 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5705">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5706">                .planItemDefinitionId(&quot;userEventListener&quot;)</span>
<span class="nc" id="L5707">                .singleResult();</span>
<span class="nc" id="L5708">        cmmnRuntimeService.triggerPlanItemInstance(userEventListenerPlanItemInstance2.getId());</span>

<span class="nc" id="L5710">        PlanItemInstance humanTaskCase2 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5711">                .planItemInstanceName(&quot;Human Task&quot;)</span>
<span class="nc" id="L5712">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5713">                .planItemInstanceStateWaitingForRepetition()</span>
<span class="nc" id="L5714">                .singleResult();</span>
<span class="nc" id="L5715">        cmmnRuntimeService.setLocalVariable(humanTaskCase2.getId(), &quot;removeRepetition&quot;, false);</span>

        // Act
<span class="nc" id="L5718">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L5719">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L5720">                .removeWaitingForRepetitionPlanItemDefinitionMapping(</span>
<span class="nc" id="L5721">                        PlanItemDefinitionMappingBuilder.createRemoveWaitingForRepetitionPlanItemDefinitionMappingFor(&quot;humanTask&quot;, &quot;${removeRepetition}&quot;)</span>
                )
<span class="nc" id="L5723">                .migrateCaseInstances(caseInstance1.getCaseDefinitionId());</span>

        // Assert
<span class="nc" id="L5726">        CaseInstance caseInstance1AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5727">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5728">                .singleResult();</span>
<span class="nc" id="L5729">        assertThat(caseInstance1AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5730">        List&lt;PlanItemInstance&gt; planItemInstances1 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5731">                .caseInstanceId(caseInstance1.getId())</span>
<span class="nc" id="L5732">                .includeEnded()</span>
<span class="nc" id="L5733">                .list();</span>
<span class="nc" id="L5734">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5735">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5736">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5737">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5738">                .extracting(PlanItemInstance::getName)</span>
                // User event listener is twice since we triggered it once already
<span class="nc" id="L5740">                .containsExactlyInAnyOrder(&quot;Stage&quot;, &quot;User Event Listener&quot;, &quot;User Event Listener&quot;, &quot;Human Task&quot;);</span>
<span class="nc" id="L5741">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5742">                .filteredOn(&quot;name&quot;, &quot;Human Task&quot;)</span>
<span class="nc" id="L5743">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5744">                .containsExactlyInAnyOrder(PlanItemInstanceState.ACTIVE);</span>

<span class="nc" id="L5746">        CaseInstance caseInstance2AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5747">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5748">                .singleResult();</span>
<span class="nc" id="L5749">        assertThat(caseInstance2AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5750">        List&lt;PlanItemInstance&gt; planItemInstances2 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5751">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5752">                .includeEnded()</span>
<span class="nc" id="L5753">                .list();</span>
<span class="nc" id="L5754">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5755">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5756">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5757">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5758">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5759">                .containsExactlyInAnyOrder(&quot;Stage&quot;, &quot;User Event Listener&quot;, &quot;User Event Listener&quot;, &quot;Human Task&quot;, &quot;Human Task&quot;);</span>
<span class="nc" id="L5760">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5761">                .filteredOn(&quot;name&quot;, &quot;Human Task&quot;)</span>
<span class="nc" id="L5762">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5763">                .containsExactlyInAnyOrder(PlanItemInstanceState.ACTIVE, PlanItemInstanceState.WAITING_FOR_REPETITION);</span>
<span class="nc" id="L5764">    }</span>


    @Test
    void migrateCaseInstancesWithRemoveWaitingForRepetitionBasedOnCondition() {
        // Arrange
<span class="nc" id="L5770">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/user-event-listener-with-repetition.cmmn.xml&quot;);</span>
<span class="nc" id="L5771">        CaseInstance caseInstance1 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;stageCase&quot;).start();</span>
<span class="nc" id="L5772">        CaseInstance caseInstance2 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;stageCase&quot;).start();</span>
<span class="nc" id="L5773">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;,</span>
                &quot;org/flowable/cmmn/test/migration/user-event-listener-without-repetition.cmmn.xml&quot;);

<span class="nc" id="L5776">        String caseInstanceId1 = caseInstance1.getId();</span>
<span class="nc" id="L5777">        PlanItemInstance userEventListener = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5778">                .caseInstanceId(caseInstanceId1)</span>
<span class="nc" id="L5779">                .planItemDefinitionId(&quot;userEventListener&quot;)</span>
<span class="nc" id="L5780">                .singleResult();</span>
<span class="nc" id="L5781">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(userEventListener.getId())</span>
<span class="nc" id="L5782">                .trigger();</span>

<span class="nc" id="L5784">        List&lt;PlanItemInstance&gt; planItemInstances1Before = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5785">                .caseInstanceId(caseInstanceId1)</span>
<span class="nc" id="L5786">                .includeEnded()</span>
<span class="nc" id="L5787">                .list();</span>
<span class="nc" id="L5788">        assertThat(planItemInstances1Before)</span>
<span class="nc" id="L5789">                .filteredOn(&quot;name&quot;, &quot;Task 1&quot;)</span>
<span class="nc" id="L5790">                .hasSize(2)</span>
<span class="nc" id="L5791">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5792">                .containsExactlyInAnyOrder(PlanItemInstanceState.WAITING_FOR_REPETITION, PlanItemInstanceState.ACTIVE);</span>

<span class="nc" id="L5794">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstanceId1).count()).isEqualTo(2);</span>
<span class="nc" id="L5795">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance2.getId()).count()).isEqualTo(1);</span>

        // Act
<span class="nc" id="L5798">        String condition = &quot;${planItemInstances.definitionId(\&quot;humanTask1\&quot;).waitingForRepetition().exists()}&quot;;</span>
<span class="nc" id="L5799">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L5800">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L5801">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;userEventListener&quot;,</span>
                        condition)) // end the event listener first
<span class="nc" id="L5803">                .removeWaitingForRepetitionPlanItemDefinitionMapping(</span>
<span class="nc" id="L5804">                        PlanItemDefinitionMappingBuilder.createRemoveWaitingForRepetitionPlanItemDefinitionMappingFor(&quot;humanTask1&quot;, condition))</span>
<span class="nc" id="L5805">                .migrateCaseInstances(caseInstance1.getCaseDefinitionId());</span>

        // Assert
<span class="nc" id="L5808">        CaseInstance caseInstance1AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5809">                .caseInstanceId(caseInstanceId1)</span>
<span class="nc" id="L5810">                .singleResult();</span>
<span class="nc" id="L5811">        assertThat(caseInstance1AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5812">        List&lt;PlanItemInstance&gt; planItemInstances1 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5813">                .caseInstanceId(caseInstanceId1)</span>
<span class="nc" id="L5814">                .includeEnded()</span>
<span class="nc" id="L5815">                .list();</span>
<span class="nc" id="L5816">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5817">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5818">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5819">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5820">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5821">                .filteredOn(Objects::nonNull)</span>
<span class="nc" id="L5822">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;); // waiting for repetition isn't visible anymore, thus Task 1 is only once in here</span>
<span class="nc" id="L5823">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5824">                .filteredOn(&quot;name&quot;, &quot;Task 1&quot;)</span>
<span class="nc" id="L5825">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5826">                .containsExactlyInAnyOrder(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L5827">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5828">                .filteredOn(&quot;planItemDefinitionId&quot;, &quot;userEventListener&quot;)</span>
<span class="nc" id="L5829">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5830">                .containsExactlyInAnyOrder(PlanItemInstanceState.TERMINATED, PlanItemInstanceState.COMPLETED);</span>

<span class="nc" id="L5832">        CaseInstance caseInstance2AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5833">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5834">                .singleResult();</span>
<span class="nc" id="L5835">        assertThat(caseInstance2AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5836">        List&lt;PlanItemInstance&gt; planItemInstances2 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5837">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5838">                .includeEnded()</span>
<span class="nc" id="L5839">                .list();</span>
<span class="nc" id="L5840">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5841">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5842">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5843">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5844">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5845">                .filteredOn(Objects::nonNull)</span>
<span class="nc" id="L5846">                .containsExactlyInAnyOrder(&quot;Task 1&quot;, &quot;Task 2&quot;);</span>
<span class="nc" id="L5847">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5848">                .filteredOn(&quot;name&quot;, &quot;Task 1&quot;)</span>
<span class="nc" id="L5849">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5850">                .containsExactlyInAnyOrder(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L5851">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5852">                .filteredOn(&quot;planItemDefinitionId&quot;, &quot;userEventListener&quot;)</span>
<span class="nc" id="L5853">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5854">                .containsExactlyInAnyOrder(PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L5855">    }</span>

    @Test
    void migrateCaseInstancesWithMarkAsActiveBasedOnCondition() {
        // Arrange
<span class="nc" id="L5860">        deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-without-event-listener-inside.cmmn.xml&quot;);</span>
<span class="nc" id="L5861">        CaseInstance caseInstance1 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L5862">        CaseInstance caseInstance2 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testCase&quot;).start();</span>
<span class="nc" id="L5863">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/stage-with-event-listener-inside.cmmn.xml&quot;);</span>

<span class="nc" id="L5865">        String caseInstanceId1 = caseInstance1.getId();</span>

<span class="nc" id="L5867">        Task task = cmmnTaskService.createTaskQuery()</span>
<span class="nc" id="L5868">                .caseInstanceId(caseInstanceId1)</span>
<span class="nc" id="L5869">                .taskName(&quot;Task 1&quot;)</span>
<span class="nc" id="L5870">                .singleResult();</span>
<span class="nc" id="L5871">        cmmnTaskService.complete(task.getId());</span>
        // now the stage is active

<span class="nc" id="L5874">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstanceId1).count()).isEqualTo(1); // Task 2</span>
<span class="nc" id="L5875">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance2.getId()).count()).isEqualTo(1); // Task 1</span>

        // Act
<span class="nc" id="L5878">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L5879">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L5880">                .addMoveToAvailablePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(</span>
                        &quot;eventListener&quot;,
                        &quot;${planItemInstances.definitionId(\&quot;cmmnStage_6\&quot;).active().exists()}&quot;
                ))
<span class="nc" id="L5884">                .migrateCaseInstances(caseInstance1.getCaseDefinitionId());</span>

        // Assert
<span class="nc" id="L5887">        CaseInstance caseInstance1AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5888">                .caseInstanceId(caseInstanceId1)</span>
<span class="nc" id="L5889">                .singleResult();</span>
<span class="nc" id="L5890">        assertThat(caseInstance1AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5891">        List&lt;PlanItemInstance&gt; planItemInstances1 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5892">                .caseInstanceId(caseInstanceId1)</span>
<span class="nc" id="L5893">                .includeEnded()</span>
<span class="nc" id="L5894">                .list();</span>
<span class="nc" id="L5895">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5896">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5897">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5898">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5899">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5900">                .filteredOn(Objects::nonNull)</span>
<span class="nc" id="L5901">                .contains(&quot;Event Listener&quot;);</span>
<span class="nc" id="L5902">        assertThat(planItemInstances1)</span>
<span class="nc" id="L5903">                .filteredOn(&quot;name&quot;, &quot;Event Listener&quot;)</span>
<span class="nc" id="L5904">                .extracting(PlanItemInstance::getState)</span>
<span class="nc" id="L5905">                .containsExactlyInAnyOrder(PlanItemInstanceState.AVAILABLE);</span>

<span class="nc" id="L5907">        CaseInstance caseInstance2AfterMigration = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5908">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5909">                .singleResult();</span>
<span class="nc" id="L5910">        assertThat(caseInstance2AfterMigration.getCaseDefinitionId()).isEqualTo(destinationDefinition.getId());</span>
<span class="nc" id="L5911">        List&lt;PlanItemInstance&gt; planItemInstances2 = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L5912">                .caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L5913">                .includeEnded()</span>
<span class="nc" id="L5914">                .list();</span>
<span class="nc" id="L5915">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5916">                .extracting(PlanItemInstance::getCaseDefinitionId)</span>
<span class="nc" id="L5917">                .containsOnly(destinationDefinition.getId());</span>
<span class="nc" id="L5918">        assertThat(planItemInstances2)</span>
<span class="nc" id="L5919">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L5920">                .filteredOn(Objects::nonNull)</span>
<span class="nc" id="L5921">                .doesNotContain(&quot;Event Listener&quot;);</span>
<span class="nc" id="L5922">    }</span>


    @Test
    void withCaseTaskWhichWillBeTerminated() {
        // Arrange
<span class="nc" id="L5928">        CaseDefinition subcaseDefinition = deployCaseDefinition(&quot;test1&quot;, &quot;org/flowable/cmmn/test/migration/one-task.cmmn.xml&quot;);</span>
<span class="nc" id="L5929">        deployCaseDefinition(&quot;test2&quot;, &quot;org/flowable/cmmn/test/migration/case-with-subcase.cmmn.xml&quot;);</span>
<span class="nc" id="L5930">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testParentCase&quot;).start();</span>
<span class="nc" id="L5931">        CaseDefinition destinationDefinition = deployCaseDefinition(&quot;test2&quot;, &quot;org/flowable/cmmn/test/migration/case-without-subcase.cmmn.xml&quot;);</span>

        // Act
<span class="nc" id="L5934">        cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L5935">                .migrateToCaseDefinition(destinationDefinition.getId())</span>
<span class="nc" id="L5936">                .addTerminatePlanItemDefinitionMapping(PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;cmmnTask_1&quot;))</span>
<span class="nc" id="L5937">                .migrate(caseInstance.getId());</span>

        // Assert
<span class="nc" id="L5940">        HistoricPlanItemInstance cmmnTask1 = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L5941">                .planItemInstanceCaseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L5942">                .planItemInstanceDefinitionId(&quot;cmmnTask_1&quot;)</span>
<span class="nc" id="L5943">                .singleResult();</span>
<span class="nc" id="L5944">        assertThat(cmmnTask1.getState()).isEqualTo(PlanItemInstanceState.TERMINATED);</span>
<span class="nc" id="L5945">        long subcaseInstances = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L5946">                .caseDefinitionId(subcaseDefinition.getId())</span>
<span class="nc" id="L5947">                .count();</span>
<span class="nc" id="L5948">        assertThat(subcaseInstances).isEqualTo(0);</span>
<span class="nc" id="L5949">    }</span>

    @Test
    void testCaseInstanceMigrationDocument() {
<span class="nc" id="L5953">        String documentAsJson = this.cmmnMigrationService.createCaseInstanceMigrationBuilder()</span>
<span class="nc" id="L5954">                .addTerminatePlanItemDefinitionMapping(</span>
<span class="nc" id="L5955">                        PlanItemDefinitionMappingBuilder.createTerminatePlanItemDefinitionMappingFor(&quot;terminateId&quot;, &quot;${terminateCondition}&quot;))</span>
<span class="nc" id="L5956">                .addMoveToAvailablePlanItemDefinitionMapping(</span>
<span class="nc" id="L5957">                        PlanItemDefinitionMappingBuilder.createMoveToAvailablePlanItemDefinitionMappingFor(&quot;availableId&quot;, &quot;${availableCondition}&quot;))</span>
<span class="nc" id="L5958">                .addWaitingForRepetitionPlanItemDefinitionMapping(</span>
<span class="nc" id="L5959">                        PlanItemDefinitionMappingBuilder.createWaitingForRepetitionPlanItemDefinitionMappingFor(&quot;repetitionId&quot;, &quot;${repetitionCondition}&quot;))</span>
<span class="nc" id="L5960">                .removeWaitingForRepetitionPlanItemDefinitionMapping(</span>
<span class="nc" id="L5961">                        PlanItemDefinitionMappingBuilder.createRemoveWaitingForRepetitionPlanItemDefinitionMappingFor(&quot;removeRepetitionId&quot;,</span>
                                &quot;${removeRepetitionCondition}&quot;))
<span class="nc" id="L5963">                .addActivatePlanItemDefinitionMapping(</span>
<span class="nc" id="L5964">                        PlanItemDefinitionMappingBuilder.createActivatePlanItemDefinitionMappingFor(&quot;activateId&quot;, &quot;${activateCondition}&quot;))</span>
<span class="nc" id="L5965">                .addChangePlanItemIdMapping(new ChangePlanItemIdMapping(&quot;oldPlanItemId&quot;, &quot;newPlanItemId&quot;))</span>
<span class="nc" id="L5966">                .addChangePlanItemIdWithDefinitionIdMapping(new ChangePlanItemIdWithDefinitionIdMapping(&quot;oldPlanItemDefinitionId&quot;, &quot;newPlanItemDefinitionId&quot;))</span>
<span class="nc" id="L5967">                .withPreUpgradeExpression(&quot;${preExpression}&quot;)</span>
<span class="nc" id="L5968">                .withPostUpgradeExpression(&quot;${postExpression}&quot;)</span>
<span class="nc" id="L5969">                .getCaseInstanceMigrationDocument()</span>
<span class="nc" id="L5970">                .asJsonString();</span>
<span class="nc" id="L5971">        CaseInstanceMigrationDocument caseInstanceMigrationDocumentFromString = CaseInstanceMigrationDocumentConverter.convertFromJson(documentAsJson);</span>
<span class="nc" id="L5972">        String documentAsJsonConverted = this.cmmnMigrationService.createCaseInstanceMigrationBuilderFromCaseInstanceMigrationDocument(</span>
                        caseInstanceMigrationDocumentFromString)
<span class="nc" id="L5974">                .getCaseInstanceMigrationDocument()</span>
<span class="nc" id="L5975">                .asJsonString();</span>
<span class="nc" id="L5976">        assertThatJson(documentAsJsonConverted).isEqualTo(documentAsJson);</span>
<span class="nc" id="L5977">    }</span>

<span class="nc" id="L5979">    protected class CustomTenantProvider implements DefaultTenantProvider {</span>

        @Override
        public String getDefaultTenant(String tenantId, String scope, String scopeKey) {
<span class="nc" id="L5983">            return tenantId + &quot;-default&quot;;</span>
        }
        
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>