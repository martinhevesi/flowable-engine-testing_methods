<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultInternalJobManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.impl.cfg</a> &gt; <span class="el_source">DefaultInternalJobManager.java</span></div><h1>DefaultInternalJobManager.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.engine.impl.cfg;

import java.util.Arrays;
import java.util.Calendar;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.List;

import org.apache.commons.lang3.StringUtils;
import org.flowable.bpmn.model.Event;
import org.flowable.bpmn.model.EventDefinition;
import org.flowable.bpmn.model.FlowElement;
import org.flowable.bpmn.model.TimerEventDefinition;
import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.api.delegate.Expression;
import org.flowable.common.engine.impl.calendar.BusinessCalendar;
import org.flowable.common.engine.impl.calendar.CycleBusinessCalendar;
import org.flowable.common.engine.impl.logging.LoggingSessionConstants;
import org.flowable.engine.impl.jobexecutor.TimerEventHandler;
import org.flowable.engine.impl.jobexecutor.TimerStartEventJobHandler;
import org.flowable.engine.impl.jobexecutor.TriggerTimerEventJobHandler;
import org.flowable.engine.impl.persistence.CountingExecutionEntity;
import org.flowable.engine.impl.persistence.entity.ExecutionEntity;
import org.flowable.engine.impl.persistence.entity.ExecutionEntityManager;
import org.flowable.engine.impl.util.BpmnLoggingSessionUtil;
import org.flowable.engine.impl.util.CommandContextUtil;
import org.flowable.engine.impl.util.CountingEntityUtil;
import org.flowable.engine.impl.util.ProcessDefinitionUtil;
import org.flowable.job.api.Job;
import org.flowable.job.service.ScopeAwareInternalJobManager;
import org.flowable.job.service.impl.persistence.entity.AbstractRuntimeJobEntity;
import org.flowable.job.service.impl.persistence.entity.DeadLetterJobEntity;
import org.flowable.job.service.impl.persistence.entity.ExternalWorkerJobEntity;
import org.flowable.job.service.impl.persistence.entity.JobEntity;
import org.flowable.job.service.impl.persistence.entity.JobInfoEntity;
import org.flowable.job.service.impl.persistence.entity.SuspendedJobEntity;
import org.flowable.job.service.impl.persistence.entity.TimerJobEntity;
import org.flowable.variable.api.delegate.VariableScope;

/**
 * @author Tijs Rademakers
 */
public class DefaultInternalJobManager extends ScopeAwareInternalJobManager {
    
    protected ProcessEngineConfigurationImpl processEngineConfiguration;

<span class="nc" id="L60">    public DefaultInternalJobManager(ProcessEngineConfigurationImpl processEngineConfiguration) {</span>
<span class="nc" id="L61">        this.processEngineConfiguration = processEngineConfiguration;</span>
<span class="nc" id="L62">    }</span>
    
    @Override
    protected VariableScope resolveVariableScopeInternal(Job job) {
<span class="nc bnc" id="L66" title="All 2 branches missed.">        if (job.getExecutionId() != null) {</span>
<span class="nc" id="L67">            return getExecutionEntityManager().findById(job.getExecutionId());</span>
        }
<span class="nc" id="L69">        return null;</span>
    }

    @Override
    protected boolean handleJobInsertInternal(Job job) {
        // add link to execution
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (job.getExecutionId() != null) {</span>
<span class="nc" id="L76">            ExecutionEntity execution = getExecutionEntityManager().findById(job.getExecutionId());</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">            if (execution != null) {</span>
                
                // Inherit tenant if (if applicable)
<span class="nc bnc" id="L80" title="All 2 branches missed.">                if (execution.getTenantId() != null) {</span>
<span class="nc" id="L81">                    ((AbstractRuntimeJobEntity) job).setTenantId(execution.getTenantId());</span>
                }
                
<span class="nc" id="L84">                CountingExecutionEntity countingExecutionEntity = (CountingExecutionEntity) execution;</span>
                
<span class="nc bnc" id="L86" title="All 2 branches missed.">                if (job instanceof TimerJobEntity) {</span>
<span class="nc" id="L87">                    TimerJobEntity timerJobEntity = (TimerJobEntity) job;</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">                    if (CountingEntityUtil.isExecutionRelatedEntityCountEnabled(execution)) {</span>
<span class="nc" id="L89">                        countingExecutionEntity.setTimerJobCount(countingExecutionEntity.getTimerJobCount() + 1);</span>
                    }
                    
<span class="nc bnc" id="L92" title="All 2 branches missed.">                } else if (job instanceof JobEntity) {</span>
<span class="nc" id="L93">                    JobEntity jobEntity = (JobEntity) job;</span>

<span class="nc bnc" id="L95" title="All 2 branches missed.">                    if (CountingEntityUtil.isExecutionRelatedEntityCountEnabled(execution)) {</span>
<span class="nc" id="L96">                        countingExecutionEntity.setJobCount(countingExecutionEntity.getJobCount() + 1);</span>
                    }
                
<span class="nc" id="L99">                } else {</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">                    if (CountingEntityUtil.isExecutionRelatedEntityCountEnabled(execution)) {</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">                        if (job instanceof SuspendedJobEntity) {</span>
<span class="nc" id="L102">                            countingExecutionEntity.setSuspendedJobCount(countingExecutionEntity.getSuspendedJobCount() + 1);</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">                        } else if (job instanceof DeadLetterJobEntity) {</span>
<span class="nc" id="L104">                            countingExecutionEntity.setDeadLetterJobCount(countingExecutionEntity.getDeadLetterJobCount() + 1);</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                        } else if (job instanceof ExternalWorkerJobEntity) {</span>
<span class="nc" id="L106">                            countingExecutionEntity.setExternalWorkerJobCount(countingExecutionEntity.getExternalWorkerJobCount() + 1);</span>
                        }
                    }
                }

<span class="nc" id="L111">            } else {</span>
                // In case the job has an executionId, but the Execution was not found,
                // it means that for example for a boundary timer event on a user task,
                // the task has been completed and the Execution and job have been removed.
<span class="nc" id="L115">                return false;</span>
            }
        }
        
<span class="nc" id="L119">        return true;</span>
    }

    @Override
    protected void handleJobDeleteInternal(Job job) {
<span class="nc bnc" id="L124" title="All 4 branches missed.">        if (job.getExecutionId() != null &amp;&amp; CountingEntityUtil.isExecutionRelatedEntityCountEnabledGlobally()) {</span>
<span class="nc" id="L125">            ExecutionEntity executionEntity = getExecutionEntityManager().findById(job.getExecutionId());</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">            if (CountingEntityUtil.isExecutionRelatedEntityCountEnabled(executionEntity)) {</span>
<span class="nc" id="L127">                CountingExecutionEntity countingExecutionEntity = (CountingExecutionEntity) executionEntity;</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">                if (job instanceof JobEntity) {</span>
<span class="nc" id="L129">                    countingExecutionEntity.setJobCount(countingExecutionEntity.getJobCount() - 1);</span>
                
<span class="nc bnc" id="L131" title="All 2 branches missed.">                } else if (job instanceof TimerJobEntity) {</span>
<span class="nc" id="L132">                    countingExecutionEntity.setTimerJobCount(countingExecutionEntity.getTimerJobCount() - 1);</span>
                
<span class="nc bnc" id="L134" title="All 2 branches missed.">                } else if (job instanceof SuspendedJobEntity) {</span>
<span class="nc" id="L135">                    countingExecutionEntity.setSuspendedJobCount(countingExecutionEntity.getSuspendedJobCount() - 1);</span>
                
<span class="nc bnc" id="L137" title="All 2 branches missed.">                } else if (job instanceof DeadLetterJobEntity) {</span>
<span class="nc" id="L138">                    countingExecutionEntity.setDeadLetterJobCount(countingExecutionEntity.getDeadLetterJobCount() - 1);</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">                } else if (job instanceof ExternalWorkerJobEntity) {</span>
<span class="nc" id="L140">                    countingExecutionEntity.setExternalWorkerJobCount(countingExecutionEntity.getExternalWorkerJobCount() - 1);</span>
                }
            }
        }
<span class="nc" id="L144">    }</span>

    @Override
    protected void lockJobScopeInternal(Job job) {
<span class="nc" id="L148">        ExecutionEntityManager executionEntityManager = getExecutionEntityManager();</span>
<span class="nc" id="L149">        ExecutionEntity execution = executionEntityManager.findById(job.getExecutionId());</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (execution != null) {</span>
<span class="nc" id="L151">            String lockOwner = null;</span>
<span class="nc" id="L152">            Date lockExpirationTime = null;</span>

<span class="nc bnc" id="L154" title="All 2 branches missed.">            if (job instanceof JobInfoEntity) {</span>
<span class="nc" id="L155">                lockOwner = ((JobInfoEntity) job).getLockOwner();</span>
<span class="nc" id="L156">                lockExpirationTime = ((JobInfoEntity) job).getLockExpirationTime();</span>
            }

<span class="nc bnc" id="L159" title="All 4 branches missed.">            if (lockOwner == null || lockExpirationTime == null) {</span>
<span class="nc" id="L160">                int lockMillis = processEngineConfiguration.getAsyncExecutor().getAsyncJobLockTimeInMillis();</span>
<span class="nc" id="L161">                GregorianCalendar lockCal = new GregorianCalendar();</span>
<span class="nc" id="L162">                lockCal.setTime(processEngineConfiguration.getClock().getCurrentTime());</span>
<span class="nc" id="L163">                lockCal.add(Calendar.MILLISECOND, lockMillis);</span>

<span class="nc" id="L165">                lockOwner = processEngineConfiguration.getAsyncExecutor().getLockOwner();</span>
<span class="nc" id="L166">                lockExpirationTime = lockCal.getTime();</span>
            }

<span class="nc" id="L169">            executionEntityManager.updateProcessInstanceLockTime(execution.getProcessInstanceId(), lockOwner, lockExpirationTime);</span>

<span class="nc bnc" id="L171" title="All 2 branches missed.">            if (processEngineConfiguration.isLoggingSessionEnabled()) {</span>
<span class="nc" id="L172">                FlowElement flowElement = execution.getCurrentFlowElement();</span>
<span class="nc" id="L173">                BpmnLoggingSessionUtil.addAsyncActivityLoggingData(&quot;Locking job for &quot; + flowElement.getId() + &quot;, with job id &quot; + job.getId(),</span>
                        LoggingSessionConstants.TYPE_SERVICE_TASK_LOCK_JOB, (JobEntity) job, flowElement, execution);
            }
        }

<span class="nc" id="L178">    }</span>

    @Override
    protected void clearJobScopeLockInternal(Job job) {
<span class="nc" id="L182">        ExecutionEntityManager executionEntityManager = getExecutionEntityManager();</span>
<span class="nc" id="L183">        ExecutionEntity execution = executionEntityManager.findById(job.getProcessInstanceId());</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">        if (execution != null) {</span>
<span class="nc" id="L185">            executionEntityManager.clearProcessInstanceLockTime(execution.getId());</span>
        }

<span class="nc bnc" id="L188" title="All 2 branches missed.">        if (processEngineConfiguration.isLoggingSessionEnabled()) {</span>
<span class="nc" id="L189">            ExecutionEntity localExecution = executionEntityManager.findById(job.getExecutionId());</span>
<span class="nc" id="L190">            FlowElement flowElement = localExecution.getCurrentFlowElement();</span>
<span class="nc" id="L191">            BpmnLoggingSessionUtil.addAsyncActivityLoggingData(&quot;Unlocking job for &quot; + flowElement.getId() + &quot;, with job id &quot; + job.getId(),</span>
                            LoggingSessionConstants.TYPE_SERVICE_TASK_UNLOCK_JOB, (JobEntity) job, flowElement, localExecution);
        }
<span class="nc" id="L194">    }</span>

    @Override
    protected void preTimerJobDeleteInternal(JobEntity jobEntity, VariableScope variableScope) {
<span class="nc" id="L198">        String activityId = jobEntity.getJobHandlerConfiguration();</span>

<span class="nc bnc" id="L200" title="All 2 branches missed.">        if (jobEntity.getJobHandlerType().equalsIgnoreCase(TimerStartEventJobHandler.TYPE) ||</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">                        jobEntity.getJobHandlerType().equalsIgnoreCase(TriggerTimerEventJobHandler.TYPE)) {</span>

<span class="nc" id="L203">            activityId = TimerEventHandler.getActivityIdFromConfiguration(jobEntity.getJobHandlerConfiguration());</span>
<span class="nc" id="L204">            String endDateExpressionString = TimerEventHandler.getEndDateFromConfiguration(jobEntity.getJobHandlerConfiguration());</span>

<span class="nc bnc" id="L206" title="All 2 branches missed.">            if (endDateExpressionString != null) {</span>
<span class="nc" id="L207">                Expression endDateExpression = processEngineConfiguration.getExpressionManager().createExpression(endDateExpressionString);</span>

<span class="nc" id="L209">                String endDateString = null;</span>

<span class="nc" id="L211">                BusinessCalendar businessCalendar = processEngineConfiguration.getBusinessCalendarManager().getBusinessCalendar(</span>
<span class="nc" id="L212">                        getBusinessCalendarName(TimerEventHandler.getCalendarNameFromConfiguration(jobEntity.getJobHandlerConfiguration()), variableScope));</span>

<span class="nc bnc" id="L214" title="All 2 branches missed.">                if (endDateExpression != null) {</span>
<span class="nc" id="L215">                    Object endDateValue = endDateExpression.getValue(variableScope);</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">                    if (endDateValue instanceof String) {</span>
<span class="nc" id="L217">                        endDateString = (String) endDateValue;</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">                    } else if (endDateValue instanceof Date) {</span>
<span class="nc" id="L219">                        jobEntity.setEndDate((Date) endDateValue);</span>
                    } else {
<span class="nc" id="L221">                        throw new FlowableException(&quot;Timer '&quot; + ((ExecutionEntity) variableScope).getActivityId()</span>
                                + &quot;' in &quot; + variableScope + &quot; was not configured with a valid duration/time, either hand in a java.util.Date or a String in format 'yyyy-MM-dd'T'hh:mm:ss'&quot;);
                    }

<span class="nc bnc" id="L225" title="All 2 branches missed.">                    if (jobEntity.getEndDate() == null) {</span>
<span class="nc" id="L226">                        jobEntity.setEndDate(businessCalendar.resolveEndDate(endDateString));</span>
                    }
                }
            }
        }

<span class="nc" id="L232">        int maxIterations = 1;</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">        if (jobEntity.getProcessDefinitionId() != null) {</span>
<span class="nc" id="L234">            org.flowable.bpmn.model.Process process = ProcessDefinitionUtil.getProcess(jobEntity.getProcessDefinitionId());</span>
<span class="nc" id="L235">            maxIterations = getMaxIterations(process, activityId);</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">            if (maxIterations &lt;= 1) {</span>
<span class="nc" id="L237">                maxIterations = getMaxIterations(process, activityId);</span>
            }
        }
<span class="nc" id="L240">        jobEntity.setMaxIterations(maxIterations);</span>
<span class="nc" id="L241">    }</span>
    
    @Override
    protected void preRepeatedTimerScheduleInternal(TimerJobEntity ti, VariableScope variableScope) {
        // Nothing to do
<span class="nc" id="L246">    }</span>

    protected int getMaxIterations(org.flowable.bpmn.model.Process process, String activityId) {
<span class="nc" id="L249">        FlowElement flowElement = process.getFlowElement(activityId, true);</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">        if (flowElement != null) {</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">            if (flowElement instanceof Event) {</span>

<span class="nc" id="L253">                Event event = (Event) flowElement;</span>
<span class="nc" id="L254">                List&lt;EventDefinition&gt; eventDefinitions = event.getEventDefinitions();</span>

<span class="nc bnc" id="L256" title="All 2 branches missed.">                if (eventDefinitions != null) {</span>

<span class="nc bnc" id="L258" title="All 2 branches missed.">                    for (EventDefinition eventDefinition : eventDefinitions) {</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">                        if (eventDefinition instanceof TimerEventDefinition) {</span>
<span class="nc" id="L260">                            TimerEventDefinition timerEventDefinition = (TimerEventDefinition) eventDefinition;</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">                            if (timerEventDefinition.getTimeCycle() != null) {</span>
<span class="nc" id="L262">                                return calculateMaxIterationsValue(timerEventDefinition.getTimeCycle());</span>
                            }
                        }
<span class="nc" id="L265">                    }</span>

                }

            }
        }
<span class="nc" id="L271">        return -1;</span>
    }
    
    protected int calculateMaxIterationsValue(String originalExpression) {
<span class="nc" id="L275">        int times = Integer.MAX_VALUE;</span>
<span class="nc" id="L276">        List&lt;String&gt; expression = Arrays.asList(originalExpression.split(&quot;/&quot;));</span>
<span class="nc bnc" id="L277" title="All 4 branches missed.">        if (expression.size() &gt; 1 &amp;&amp; expression.get(0).startsWith(&quot;R&quot;)) {</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">            if (expression.get(0).length() &gt; 1) {</span>
<span class="nc" id="L279">                times = Integer.parseInt(expression.get(0).substring(1));</span>
            }
        }
        
<span class="nc" id="L283">        return times;</span>
    }
    
    protected String getBusinessCalendarName(String calendarName, VariableScope variableScope) {
<span class="nc" id="L287">        String businessCalendarName = CycleBusinessCalendar.NAME;</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(calendarName)) {</span>
<span class="nc" id="L289">            businessCalendarName = (String) CommandContextUtil.getProcessEngineConfiguration().getExpressionManager()</span>
<span class="nc" id="L290">                    .createExpression(calendarName).getValue(variableScope);</span>
        }
<span class="nc" id="L292">        return businessCalendarName;</span>
    }

    protected ExecutionEntityManager getExecutionEntityManager() {
<span class="nc" id="L296">        return processEngineConfiguration.getExecutionEntityManager();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>