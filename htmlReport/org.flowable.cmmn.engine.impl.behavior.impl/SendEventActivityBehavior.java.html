<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SendEventActivityBehavior.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.cmmn.engine.impl.behavior.impl</a> &gt; <span class="el_source">SendEventActivityBehavior.java</span></div><h1>SendEventActivityBehavior.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.cmmn.engine.impl.behavior.impl;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.Objects;

import org.apache.commons.lang3.StringUtils;
import org.flowable.cmmn.engine.CmmnEngineConfiguration;
import org.flowable.cmmn.engine.impl.persistence.entity.PlanItemInstanceEntity;
import org.flowable.cmmn.engine.impl.util.CommandContextUtil;
import org.flowable.cmmn.engine.impl.util.EventInstanceCmmnUtil;
import org.flowable.cmmn.model.ExtensionElement;
import org.flowable.cmmn.model.SendEventServiceTask;
import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.api.FlowableIllegalArgumentException;
import org.flowable.common.engine.api.delegate.Expression;
import org.flowable.common.engine.impl.el.ExpressionManager;
import org.flowable.common.engine.impl.interceptor.CommandContext;
import org.flowable.eventregistry.api.EventRegistry;
import org.flowable.eventregistry.api.EventRepositoryService;
import org.flowable.eventregistry.api.runtime.EventPayloadInstance;
import org.flowable.eventregistry.impl.runtime.EventInstanceImpl;
import org.flowable.eventregistry.model.ChannelModel;
import org.flowable.eventregistry.model.EventModel;

/**
 * @author Joram Barrez
 */
public class SendEventActivityBehavior extends TaskActivityBehavior{

    protected SendEventServiceTask serviceTask;

    public SendEventActivityBehavior(SendEventServiceTask serviceTask) {
<span class="nc" id="L50">        super(serviceTask.isBlocking(), serviceTask.getBlockingExpression());</span>
<span class="nc" id="L51">        this.serviceTask = serviceTask;</span>
<span class="nc" id="L52">    }</span>

    @Override
    public void execute(CommandContext commandContext, PlanItemInstanceEntity planItemInstanceEntity) {

<span class="nc" id="L57">        String key = getEventKey(planItemInstanceEntity);</span>

<span class="nc" id="L59">        EventRegistry eventRegistry = CommandContextUtil.getEventRegistry();</span>

<span class="nc" id="L61">        EventModel eventModel = getEventModel(planItemInstanceEntity, key);</span>
<span class="nc" id="L62">        boolean sendOnSystemChannel = isSendOnSystemChannel(planItemInstanceEntity);</span>
<span class="nc" id="L63">        List&lt;ChannelModel&gt; channelModels = getChannelModels(commandContext, planItemInstanceEntity, sendOnSystemChannel);</span>

<span class="nc" id="L65">        Collection&lt;EventPayloadInstance&gt; eventPayloadInstances = EventInstanceCmmnUtil</span>
<span class="nc" id="L66">            .createEventPayloadInstances(planItemInstanceEntity, CommandContextUtil.getExpressionManager(commandContext), serviceTask, eventModel);</span>
<span class="nc" id="L67">        EventInstanceImpl eventInstance = new EventInstanceImpl(eventModel.getKey(), eventPayloadInstances, planItemInstanceEntity.getTenantId());</span>

<span class="nc bnc" id="L69" title="All 2 branches missed.">        if (!channelModels.isEmpty()) {</span>
<span class="nc" id="L70">            eventRegistry.sendEventOutbound(eventInstance, channelModels);</span>
        }

<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (sendOnSystemChannel) {</span>
<span class="nc" id="L74">            eventRegistry.sendSystemEventOutbound(eventInstance);</span>
        }

<span class="nc" id="L77">        CommandContextUtil.getAgenda(commandContext).planCompletePlanItemInstanceOperation(planItemInstanceEntity);</span>
<span class="nc" id="L78">    }</span>

    protected EventModel getEventModel(PlanItemInstanceEntity planItemInstanceEntity, String key) {
<span class="nc" id="L81">        EventModel eventModel = null;</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">        if (Objects.equals(CmmnEngineConfiguration.NO_TENANT_ID, planItemInstanceEntity.getTenantId())) {</span>
<span class="nc" id="L83">            eventModel = CommandContextUtil.getEventRepositoryService().getEventModelByKey(key);</span>
        } else {
<span class="nc" id="L85">            eventModel = CommandContextUtil.getEventRepositoryService().getEventModelByKey(key, planItemInstanceEntity.getTenantId());</span>
        }

<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (eventModel == null) {</span>
<span class="nc" id="L89">            throw new FlowableException(&quot;No event model found for event key &quot; + key + &quot; for &quot; + planItemInstanceEntity);</span>
        }
<span class="nc" id="L91">        return eventModel;</span>
    }

    protected boolean isSendOnSystemChannel(PlanItemInstanceEntity planItemInstanceEntity) {
<span class="nc" id="L95">        List&lt;ExtensionElement&gt; systemChannels = planItemInstanceEntity.getPlanItemDefinition().getExtensionElements()</span>
<span class="nc" id="L96">                .getOrDefault(&quot;systemChannel&quot;, Collections.emptyList());</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">        return !systemChannels.isEmpty();</span>
    }

    protected List&lt;ChannelModel&gt; getChannelModels(CommandContext commandContext, PlanItemInstanceEntity planItemInstanceEntity, boolean sendOnSystemChannel) {
<span class="nc" id="L101">        List&lt;String&gt; channelKeys = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L103">        Map&lt;String, List&lt;ExtensionElement&gt;&gt; extensionElements = planItemInstanceEntity.getPlanItem().getPlanItemDefinition().getExtensionElements();</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (extensionElements != null) {</span>
<span class="nc" id="L105">            List&lt;ExtensionElement&gt; channelKeyElements = extensionElements.get(&quot;channelKey&quot;);</span>
<span class="nc bnc" id="L106" title="All 4 branches missed.">            if (channelKeyElements != null &amp;&amp; !channelKeyElements.isEmpty()) {</span>
<span class="nc" id="L107">                String channelKey = channelKeyElements.get(0).getElementText();</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                if (StringUtils.isNotEmpty(channelKey)) {</span>
<span class="nc" id="L109">                    ExpressionManager expressionManager = CommandContextUtil.getCmmnEngineConfiguration(commandContext).getExpressionManager();</span>
<span class="nc" id="L110">                    Expression expression = expressionManager.createExpression(channelKey);</span>
<span class="nc" id="L111">                    Object resolvedChannelKey = expression.getValue(planItemInstanceEntity);</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                    if (resolvedChannelKey instanceof Collection) {</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                        for (Object next : (Collection) resolvedChannelKey) {</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                            if (next instanceof String) {</span>
<span class="nc" id="L115">                                String[] keys = ((String) next).split(&quot;,&quot;);</span>
<span class="nc" id="L116">                                channelKeys.addAll(Arrays.asList(keys));</span>

<span class="nc" id="L118">                            } else {</span>
<span class="nc" id="L119">                                throw new FlowableIllegalArgumentException(&quot;Can only use a collection of String elements for referencing channel model key&quot;);</span>

                            }
<span class="nc" id="L122">                        }</span>

<span class="nc bnc" id="L124" title="All 2 branches missed.">                    } else if (resolvedChannelKey instanceof String) {</span>
<span class="nc" id="L125">                        String[] keys = ((String) resolvedChannelKey).split(&quot;,&quot;);</span>
<span class="nc" id="L126">                        channelKeys.addAll(Arrays.asList(keys));</span>

                    }
                }
            }
        }

<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (channelKeys.isEmpty()) {</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">            if (!sendOnSystemChannel) {</span>
                // If the event is going to be send on the system channel then it is allowed to not define any other channels
<span class="nc" id="L136">                throw new FlowableException(&quot;No channel keys configured for &quot; + planItemInstanceEntity);</span>
            } else {
<span class="nc" id="L138">                return Collections.emptyList();</span>
            }
        }

<span class="nc" id="L142">        EventRepositoryService eventRepositoryService = CommandContextUtil.getEventRegistryEngineConfiguration(commandContext).getEventRepositoryService();</span>
<span class="nc" id="L143">        List&lt;ChannelModel&gt; channelModels = new ArrayList&lt;&gt;(channelKeys.size());</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">        for (String channelKey : channelKeys) {</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">            if (Objects.equals(CmmnEngineConfiguration.NO_TENANT_ID, planItemInstanceEntity.getTenantId())) {</span>
<span class="nc" id="L146">                channelModels.add(eventRepositoryService.getChannelModelByKey(channelKey));</span>
            } else {
<span class="nc" id="L148">                channelModels.add(eventRepositoryService.getChannelModelByKey(channelKey, planItemInstanceEntity.getTenantId()));</span>
            }
<span class="nc" id="L150">        }</span>

<span class="nc" id="L152">        return channelModels;</span>
    }

    protected String getEventKey(PlanItemInstanceEntity planItemInstanceEntity) {
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(serviceTask.getEventType())) {</span>
<span class="nc" id="L157">            return serviceTask.getEventType();</span>
        } else {
<span class="nc" id="L159">            throw new FlowableException(&quot;No event key configured for &quot; + serviceTask.getId() + &quot; for &quot; + planItemInstanceEntity);</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>