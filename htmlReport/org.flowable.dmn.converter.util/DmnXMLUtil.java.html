<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DmnXMLUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.dmn.converter.util</a> &gt; <span class="el_source">DmnXMLUtil.java</span></div><h1>DmnXMLUtil.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.dmn.converter.util;

import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.UUID;

import javax.xml.stream.XMLStreamReader;
import javax.xml.stream.XMLStreamWriter;

import org.apache.commons.lang3.StringUtils;
import org.flowable.dmn.converter.child.AllowedValuesParser;
import org.flowable.dmn.converter.child.BaseChildElementParser;
import org.flowable.dmn.converter.child.InputClauseParser;
import org.flowable.dmn.converter.child.InputEntryParser;
import org.flowable.dmn.converter.child.InputExpressionParser;
import org.flowable.dmn.converter.child.InputValuesParser;
import org.flowable.dmn.converter.child.ItemComponentParser;
import org.flowable.dmn.converter.child.OutputClauseParser;
import org.flowable.dmn.converter.child.OutputEntryParser;
import org.flowable.dmn.converter.child.OutputValuesParser;
import org.flowable.dmn.converter.child.RequiredAuthorityParser;
import org.flowable.dmn.converter.child.RequiredDecisionParser;
import org.flowable.dmn.converter.child.RequiredInputParser;
import org.flowable.dmn.converter.child.TypeRefParser;
import org.flowable.dmn.converter.child.VariableParser;
import org.flowable.dmn.model.Decision;
import org.flowable.dmn.model.DmnElement;
import org.flowable.dmn.model.DmnExtensionAttribute;
import org.flowable.dmn.model.DmnExtensionElement;
import org.flowable.dmn.xml.constants.DmnXMLConstants;

/**
 * @author Tijs Rademakers
 * @author Yvo Swillens
 * @author Bassam Al-Sarori
 */
<span class="nc" id="L53">public class DmnXMLUtil implements DmnXMLConstants {</span>

<span class="nc" id="L55">    private static Map&lt;String, BaseChildElementParser&gt; genericChildParserMap = new HashMap&lt;&gt;();</span>

    static {
<span class="nc" id="L58">        addGenericParser(new InputClauseParser());</span>
<span class="nc" id="L59">        addGenericParser(new OutputClauseParser());</span>
<span class="nc" id="L60">        addGenericParser(new InputEntryParser());</span>
<span class="nc" id="L61">        addGenericParser(new OutputEntryParser());</span>
<span class="nc" id="L62">        addGenericParser(new InputExpressionParser());</span>
<span class="nc" id="L63">        addGenericParser(new InputValuesParser());</span>
<span class="nc" id="L64">        addGenericParser(new OutputValuesParser());</span>
<span class="nc" id="L65">        addGenericParser(new VariableParser());</span>
<span class="nc" id="L66">        addGenericParser(new RequiredAuthorityParser());</span>
<span class="nc" id="L67">        addGenericParser(new RequiredDecisionParser());</span>
<span class="nc" id="L68">        addGenericParser(new RequiredInputParser());</span>
<span class="nc" id="L69">        addGenericParser(new AllowedValuesParser());</span>
<span class="nc" id="L70">        addGenericParser(new ItemComponentParser());</span>
<span class="nc" id="L71">        addGenericParser(new TypeRefParser());</span>
<span class="nc" id="L72">    }</span>

    private static void addGenericParser(BaseChildElementParser parser) {
<span class="nc" id="L75">        genericChildParserMap.put(parser.getElementName(), parser);</span>
<span class="nc" id="L76">    }</span>

    public static void parseChildElements(String elementName, DmnElement parentElement, XMLStreamReader xtr,
            Map&lt;String, BaseChildElementParser&gt; childParsers, Decision decision) throws Exception {

<span class="nc" id="L81">        Map&lt;String, BaseChildElementParser&gt; localParserMap = new HashMap&lt;&gt;(genericChildParserMap);</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">        if (childParsers != null) {</span>
<span class="nc" id="L83">            localParserMap.putAll(childParsers);</span>
        }

<span class="nc" id="L86">        boolean inExtensionElements = false;</span>
<span class="nc" id="L87">        boolean readyWithChildElements = false;</span>
<span class="nc bnc" id="L88" title="All 4 branches missed.">        while (!readyWithChildElements &amp;&amp; xtr.hasNext()) {</span>
<span class="nc" id="L89">            xtr.next();</span>

<span class="nc bnc" id="L91" title="All 2 branches missed.">            if (xtr.isStartElement()) {</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">                if (ELEMENT_EXTENSIONS.equals(xtr.getLocalName())) {</span>
<span class="nc" id="L93">                    inExtensionElements = true;</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">                } else if (localParserMap.containsKey(xtr.getLocalName())) {</span>
<span class="nc" id="L95">                    BaseChildElementParser childParser = localParserMap.get(xtr.getLocalName());</span>
                    // if we're into an extension element but the current element is not accepted by this parentElement then is read as a custom extension element
<span class="nc bnc" id="L97" title="All 4 branches missed.">                    if (inExtensionElements &amp;&amp; !childParser.accepts(parentElement)) {</span>
<span class="nc" id="L98">                        DmnExtensionElement extensionElement = parseExtensionElement(xtr);</span>
<span class="nc" id="L99">                        parentElement.addExtensionElement(extensionElement);</span>
<span class="nc" id="L100">                        continue;</span>
                    }
<span class="nc" id="L102">                    localParserMap.get(xtr.getLocalName()).parseChildElement(xtr, parentElement, decision);</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">                } else if (inExtensionElements) {</span>
<span class="nc" id="L104">                    DmnExtensionElement extensionElement = parseExtensionElement(xtr);</span>
<span class="nc" id="L105">                    parentElement.addExtensionElement(extensionElement);</span>
<span class="nc" id="L106">                }</span>

<span class="nc bnc" id="L108" title="All 2 branches missed.">            } else if (xtr.isEndElement()) {</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">                if (ELEMENT_EXTENSIONS.equals(xtr.getLocalName())) {</span>
<span class="nc" id="L110">                    inExtensionElements = false;</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">                } else if (elementName.equalsIgnoreCase(xtr.getLocalName())) {</span>
<span class="nc" id="L112">                    readyWithChildElements = true;</span>
                }
            }
        }
<span class="nc" id="L116">    }</span>

    public static void writeDefaultAttribute(String attributeName, String value, XMLStreamWriter xtw) throws Exception {
<span class="nc bnc" id="L119" title="All 4 branches missed.">        if (StringUtils.isNotEmpty(value) &amp;&amp; !&quot;null&quot;.equalsIgnoreCase(value)) {</span>
<span class="nc" id="L120">            xtw.writeAttribute(attributeName, value);</span>
        }
<span class="nc" id="L122">    }</span>

    public static void writeQualifiedAttribute(String attributeName, String value, XMLStreamWriter xtw) throws Exception {
<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(value)) {</span>
<span class="nc" id="L126">            xtw.writeAttribute(FLOWABLE_EXTENSIONS_PREFIX, FLOWABLE_EXTENSIONS_NAMESPACE, attributeName, value);</span>
        }
<span class="nc" id="L128">    }</span>

    public static DmnExtensionElement parseExtensionElement(XMLStreamReader xtr) throws Exception {
<span class="nc" id="L131">        DmnExtensionElement extensionElement = new DmnExtensionElement();</span>
<span class="nc" id="L132">        extensionElement.setName(xtr.getLocalName());</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(xtr.getNamespaceURI())) {</span>
<span class="nc" id="L134">            extensionElement.setNamespace(xtr.getNamespaceURI());</span>
        }
<span class="nc bnc" id="L136" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(xtr.getPrefix())) {</span>
<span class="nc" id="L137">            extensionElement.setNamespacePrefix(xtr.getPrefix());</span>
        }

<span class="nc" id="L140">        parseAttributes(extensionElement, xtr);</span>

<span class="nc" id="L142">        boolean readyWithExtensionElement = false;</span>
<span class="nc bnc" id="L143" title="All 4 branches missed.">        while (!readyWithExtensionElement &amp;&amp; xtr.hasNext()) {</span>
<span class="nc" id="L144">            xtr.next();</span>
<span class="nc bnc" id="L145" title="All 4 branches missed.">            if (xtr.isCharacters() || XMLStreamReader.CDATA == xtr.getEventType()) {</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">                if (StringUtils.isNotEmpty(xtr.getText().trim())) {</span>
<span class="nc" id="L147">                    extensionElement.setElementText(xtr.getText().trim());</span>
                }
<span class="nc bnc" id="L149" title="All 2 branches missed.">            } else if (xtr.isStartElement()) {</span>
<span class="nc" id="L150">                DmnExtensionElement childExtensionElement = parseExtensionElement(xtr);</span>
<span class="nc" id="L151">                extensionElement.addChildElement(childExtensionElement);</span>
<span class="nc bnc" id="L152" title="All 4 branches missed.">            } else if (xtr.isEndElement() &amp;&amp; extensionElement.getName().equalsIgnoreCase(xtr.getLocalName())) {</span>
<span class="nc" id="L153">                readyWithExtensionElement = true;</span>
            }
        }
<span class="nc" id="L156">        return extensionElement;</span>
    }

    public static void parseAttributes(DmnElement dmnElement, XMLStreamReader xtr) {
<span class="nc" id="L160">        parseAttributes(dmnElement, xtr, Collections.emptyList());</span>
<span class="nc" id="L161">    }</span>

    public static void parseAttributes(DmnElement dmnElement, XMLStreamReader xtr, Collection&lt;DmnExtensionAttribute&gt; attributesToIgnore) {
<span class="nc bnc" id="L164" title="All 2 branches missed.">        for (int i = 0; i &lt; xtr.getAttributeCount(); i++) {</span>
<span class="nc" id="L165">            DmnExtensionAttribute extensionAttribute = new DmnExtensionAttribute();</span>
<span class="nc" id="L166">            extensionAttribute.setName(xtr.getAttributeLocalName(i));</span>
<span class="nc" id="L167">            extensionAttribute.setValue(xtr.getAttributeValue(i));</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">            if (StringUtils.isNotEmpty(xtr.getAttributeNamespace(i))) {</span>
<span class="nc" id="L169">                extensionAttribute.setNamespace(xtr.getAttributeNamespace(i));</span>
            }
<span class="nc bnc" id="L171" title="All 2 branches missed.">            if (StringUtils.isNotEmpty(xtr.getAttributePrefix(i))) {</span>
<span class="nc" id="L172">                extensionAttribute.setNamespacePrefix(xtr.getAttributePrefix(i));</span>
            }

<span class="nc bnc" id="L175" title="All 2 branches missed.">            if (isAttributedIncluded(extensionAttribute, attributesToIgnore)) {</span>
<span class="nc" id="L176">                dmnElement.addAttribute(extensionAttribute);</span>
            }
        }
<span class="nc" id="L179">    }</span>

    protected static boolean isAttributedIncluded(DmnExtensionAttribute attribute, Collection&lt;DmnExtensionAttribute&gt; attributesToIgnore) {
<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (attributesToIgnore.isEmpty()) {</span>
<span class="nc" id="L183">            return true;</span>
        }

<span class="nc bnc" id="L186" title="All 2 branches missed.">        for (DmnExtensionAttribute attributeToIgnore : attributesToIgnore) {</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">            if (Objects.equals(attributeToIgnore.getName(), attribute.getName())) {</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">                if (Objects.equals(attributeToIgnore.getNamespace(), attribute.getNamespace())) {</span>
<span class="nc" id="L189">                    return false;</span>
                }
            }
<span class="nc" id="L192">        }</span>

<span class="nc" id="L194">        return true;</span>

    }

    public static void writeElementDescription(DmnElement dmnElement, XMLStreamWriter xtw) throws Exception {
<span class="nc bnc" id="L199" title="All 4 branches missed.">        if (StringUtils.isNotEmpty(dmnElement.getDescription()) &amp;&amp; !&quot;null&quot;.equalsIgnoreCase(dmnElement.getDescription())) {</span>
<span class="nc" id="L200">            xtw.writeStartElement(ELEMENT_DESCRIPTION);</span>
<span class="nc" id="L201">            xtw.writeCharacters(dmnElement.getDescription());</span>
<span class="nc" id="L202">            xtw.writeEndElement();</span>
        }
<span class="nc" id="L204">    }</span>

    public static void writeExtensionElements(DmnElement dmnElement, XMLStreamWriter xtw) throws Exception {
<span class="nc" id="L207">        writeExtensionElements(dmnElement, null, xtw);</span>
<span class="nc" id="L208">    }</span>

    public static void writeExtensionElements(DmnElement dmnElement, Map&lt;String, String&gt; namespaceMap, XMLStreamWriter xtw) throws Exception {
<span class="nc bnc" id="L211" title="All 2 branches missed.">        if (writeExtensionElements(dmnElement, false, xtw)) {</span>
<span class="nc" id="L212">            xtw.writeEndElement();</span>
        }
<span class="nc" id="L214">    }</span>

    public static boolean writeExtensionElements(DmnElement dmnElement, boolean didWriteExtensionStartElement, XMLStreamWriter xtw) throws Exception {
<span class="nc" id="L217">        return writeExtensionElements(dmnElement, didWriteExtensionStartElement, null, xtw);</span>
    }

    public static boolean writeExtensionElements(DmnElement dmnElement, boolean didWriteExtensionStartElement, Map&lt;String, String&gt; namespaceMap, XMLStreamWriter xtw) throws Exception {
<span class="nc bnc" id="L221" title="All 2 branches missed.">        if (!dmnElement.getExtensionElements().isEmpty()) {</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">            if (!didWriteExtensionStartElement) {</span>
<span class="nc" id="L223">                xtw.writeStartElement(ELEMENT_EXTENSIONS);</span>
<span class="nc" id="L224">                didWriteExtensionStartElement = true;</span>
            }

<span class="nc bnc" id="L227" title="All 2 branches missed.">            if (namespaceMap == null) {</span>
<span class="nc" id="L228">                namespaceMap = new HashMap&lt;&gt;();</span>
            }

<span class="nc bnc" id="L231" title="All 2 branches missed.">            for (List&lt;DmnExtensionElement&gt; extensionElements : dmnElement.getExtensionElements().values()) {</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">                for (DmnExtensionElement extensionElement : extensionElements) {</span>
<span class="nc" id="L233">                    writeExtensionElement(extensionElement, namespaceMap, xtw);</span>
<span class="nc" id="L234">                }</span>
<span class="nc" id="L235">            }</span>
        }
<span class="nc" id="L237">        return didWriteExtensionStartElement;</span>
    }

    protected static void writeExtensionElement(DmnExtensionElement extensionElement, Map&lt;String, String&gt; namespaceMap, XMLStreamWriter xtw) throws Exception {
<span class="nc bnc" id="L241" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(extensionElement.getName())) {</span>
<span class="nc" id="L242">            Map&lt;String, String&gt; localNamespaceMap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">            if (StringUtils.isNotEmpty(extensionElement.getNamespace())) {</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                if (StringUtils.isNotEmpty(extensionElement.getNamespacePrefix())) {</span>
<span class="nc" id="L245">                    xtw.writeStartElement(extensionElement.getNamespacePrefix(), extensionElement.getName(), extensionElement.getNamespace());</span>

<span class="nc bnc" id="L247" title="All 2 branches missed.">                    if (!namespaceMap.containsKey(extensionElement.getNamespacePrefix()) ||</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">                            !namespaceMap.get(extensionElement.getNamespacePrefix()).equals(extensionElement.getNamespace())) {</span>

<span class="nc" id="L250">                        xtw.writeNamespace(extensionElement.getNamespacePrefix(), extensionElement.getNamespace());</span>
<span class="nc" id="L251">                        namespaceMap.put(extensionElement.getNamespacePrefix(), extensionElement.getNamespace());</span>
<span class="nc" id="L252">                        localNamespaceMap.put(extensionElement.getNamespacePrefix(), extensionElement.getNamespace());</span>
                    }
                } else {
<span class="nc" id="L255">                    xtw.writeStartElement(extensionElement.getNamespace(), extensionElement.getName());</span>
                }
            } else {
<span class="nc" id="L258">                xtw.writeStartElement(extensionElement.getName());</span>
            }

<span class="nc" id="L261">            writeAttributes(extensionElement, namespaceMap, xtw);</span>

<span class="nc bnc" id="L263" title="All 2 branches missed.">            if (extensionElement.getElementText() != null) {</span>
<span class="nc" id="L264">                xtw.writeCharacters(extensionElement.getElementText());</span>
            } else {
<span class="nc bnc" id="L266" title="All 2 branches missed.">                for (List&lt;DmnExtensionElement&gt; childElements : extensionElement.getChildElements().values()) {</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">                    for (DmnExtensionElement childElement : childElements) {</span>
<span class="nc" id="L268">                        writeExtensionElement(childElement, namespaceMap, xtw);</span>
<span class="nc" id="L269">                    }</span>
<span class="nc" id="L270">                }</span>
            }

<span class="nc bnc" id="L273" title="All 2 branches missed.">            for (String prefix : localNamespaceMap.keySet()) {</span>
<span class="nc" id="L274">                namespaceMap.remove(prefix);</span>
<span class="nc" id="L275">            }</span>

<span class="nc" id="L277">            xtw.writeEndElement();</span>
        }
<span class="nc" id="L279">    }</span>

    public static void writeAttributes(DmnElement dmnElement, Map&lt;String, String&gt; namespaceMap, XMLStreamWriter xtw) throws Exception {
<span class="nc bnc" id="L282" title="All 2 branches missed.">        if (!dmnElement.getAttributes().isEmpty()) {</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">            if (namespaceMap == null) {</span>
<span class="nc" id="L284">                namespaceMap = new HashMap&lt;&gt;();</span>
            }
<span class="nc bnc" id="L286" title="All 2 branches missed.">            for (List&lt;DmnExtensionAttribute&gt; attributes : dmnElement.getAttributes().values()) {</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">                for (DmnExtensionAttribute attribute : attributes) {</span>
<span class="nc bnc" id="L288" title="All 4 branches missed.">                    if (StringUtils.isNotEmpty(attribute.getName()) &amp;&amp; attribute.getValue() != null) {</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">                        if (StringUtils.isNotEmpty(attribute.getNamespace())) {</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">                            if (StringUtils.isNotEmpty(attribute.getNamespacePrefix())) {</span>

<span class="nc bnc" id="L292" title="All 2 branches missed.">                                if (!namespaceMap.containsKey(attribute.getNamespacePrefix()) ||</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">                                        !namespaceMap.get(attribute.getNamespacePrefix()).equals(attribute.getNamespace())) {</span>

<span class="nc" id="L295">                                    xtw.writeNamespace(attribute.getNamespacePrefix(), attribute.getNamespace());</span>
<span class="nc" id="L296">                                    namespaceMap.put(attribute.getNamespacePrefix(), attribute.getNamespace());</span>
                                }

<span class="nc" id="L299">                                xtw.writeAttribute(attribute.getNamespacePrefix(), attribute.getNamespace(), attribute.getName(), attribute.getValue());</span>
                            } else {
<span class="nc" id="L301">                                xtw.writeAttribute(attribute.getNamespace(), attribute.getName(), attribute.getValue());</span>
                            }
                        } else {
<span class="nc" id="L304">                            xtw.writeAttribute(attribute.getName(), attribute.getValue());</span>
                        }
                    }
<span class="nc" id="L307">                }</span>
<span class="nc" id="L308">            }</span>
        }
<span class="nc" id="L310">    }</span>

    public static String getUniqueElementId() {
<span class="nc" id="L313">        return getUniqueElementId(null);</span>
    }

    public static String getUniqueElementId(String prefix) {
<span class="nc" id="L317">        UUID uuid = UUID.randomUUID();</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (StringUtils.isEmpty(prefix)) {</span>
<span class="nc" id="L319">            return uuid.toString();</span>
        } else {
<span class="nc" id="L321">            return String.format(&quot;%s_%s&quot;, prefix, uuid);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>