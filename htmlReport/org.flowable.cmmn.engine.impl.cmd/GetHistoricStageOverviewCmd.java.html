<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GetHistoricStageOverviewCmd.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.cmmn.engine.impl.cmd</a> &gt; <span class="el_source">GetHistoricStageOverviewCmd.java</span></div><h1>GetHistoricStageOverviewCmd.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.cmmn.engine.impl.cmd;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Comparator;
import java.util.Date;
import java.util.List;
import java.util.Optional;

import org.flowable.cmmn.api.StageResponse;
import org.flowable.cmmn.api.history.HistoricPlanItemInstance;
import org.flowable.cmmn.api.repository.CaseDefinition;
import org.flowable.cmmn.api.runtime.PlanItemDefinitionType;
import org.flowable.cmmn.api.runtime.PlanItemInstanceState;
import org.flowable.cmmn.engine.CmmnEngineConfiguration;
import org.flowable.cmmn.engine.impl.deployer.CmmnDeploymentManager;
import org.flowable.cmmn.engine.impl.history.HistoricPlanItemInstanceQueryImpl;
import org.flowable.cmmn.engine.impl.persistence.entity.HistoricCaseInstanceEntity;
import org.flowable.cmmn.engine.impl.persistence.entity.HistoricPlanItemInstanceEntityManager;
import org.flowable.cmmn.engine.impl.util.CommandContextUtil;
import org.flowable.cmmn.model.CmmnModel;
import org.flowable.cmmn.model.Milestone;
import org.flowable.cmmn.model.PlanItemDefinition;
import org.flowable.cmmn.model.Stage;
import org.flowable.common.engine.api.FlowableObjectNotFoundException;
import org.flowable.common.engine.impl.interceptor.Command;
import org.flowable.common.engine.impl.interceptor.CommandContext;

/**
 * @author Tijs Rademakers
 */
public class GetHistoricStageOverviewCmd implements Command&lt;List&lt;StageResponse&gt;&gt;, Serializable {

    private static final long serialVersionUID = 1L;
    
    protected String caseInstanceId;

<span class="nc" id="L52">    public GetHistoricStageOverviewCmd(String caseInstanceId) {</span>
<span class="nc" id="L53">        this.caseInstanceId = caseInstanceId;</span>
<span class="nc" id="L54">    }</span>

    @Override
    public List&lt;StageResponse&gt; execute(CommandContext commandContext) {
<span class="nc" id="L58">        CmmnEngineConfiguration cmmnEngineConfiguration = CommandContextUtil.getCmmnEngineConfiguration(commandContext);</span>
<span class="nc" id="L59">        HistoricCaseInstanceEntity caseInstance = cmmnEngineConfiguration.getHistoricCaseInstanceEntityManager().findById(caseInstanceId);</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">        if (caseInstance == null) {</span>
<span class="nc" id="L61">            throw new FlowableObjectNotFoundException(&quot;No case instance found for id &quot; + caseInstanceId, HistoricCaseInstanceEntity.class);</span>
        }

<span class="nc" id="L64">        HistoricPlanItemInstanceEntityManager planItemInstanceEntityManager = cmmnEngineConfiguration.getHistoricPlanItemInstanceEntityManager();</span>
<span class="nc" id="L65">        List&lt;HistoricPlanItemInstance&gt; planItemInstances = planItemInstanceEntityManager.findByCriteria(new HistoricPlanItemInstanceQueryImpl()</span>
<span class="nc" id="L66">            .planItemInstanceCaseInstanceId(caseInstanceId)</span>
<span class="nc" id="L67">            .planItemInstanceDefinitionTypes(Arrays.asList(PlanItemDefinitionType.STAGE, PlanItemDefinitionType.MILESTONE))</span>
<span class="nc" id="L68">            .orderByEndedTime().asc());</span>

        // Filter out the states that shouldn't be returned in the overview
<span class="nc" id="L71">        planItemInstances.removeIf(planItemInstance -&gt; PlanItemInstanceState.INTERMEDIARY_STATES.contains(planItemInstance.getState()));</span>

<span class="nc" id="L73">        CmmnDeploymentManager deploymentManager = cmmnEngineConfiguration.getDeploymentManager();</span>
<span class="nc" id="L74">        CaseDefinition caseDefinition = deploymentManager.findDeployedCaseDefinitionById(caseInstance.getCaseDefinitionId());</span>
<span class="nc" id="L75">        CmmnModel cmmnModel = deploymentManager.resolveCaseDefinition(caseDefinition).getCmmnModel();</span>
<span class="nc" id="L76">        List&lt;Stage&gt; stages = cmmnModel.getPrimaryCase().getPlanModel().findPlanItemDefinitionsOfType(Stage.class, true);</span>
<span class="nc" id="L77">        List&lt;Milestone&gt; milestones = cmmnModel.getPrimaryCase().getPlanModel().findPlanItemDefinitionsOfType(Milestone.class, true);</span>
        
<span class="nc" id="L79">        List&lt;OverviewElement&gt; overviewElements = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">        for (Stage stage : stages) {</span>
<span class="nc" id="L81">            overviewElements.add(new OverviewElement(stage.getId(), stage.getName(), stage.getDisplayOrder(), stage.getIncludeInStageOverview(), stage));</span>
<span class="nc" id="L82">        }</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        for (Milestone milestone : milestones) {</span>
<span class="nc" id="L84">            overviewElements.add(new OverviewElement(milestone.getId(), milestone.getName(), milestone.getDisplayOrder(), milestone.getIncludeInStageOverview(), milestone));</span>
<span class="nc" id="L85">        }</span>

        // If one stage has a display order, they are ordered by that.
        // Otherwise, the order as it comes back from the query is used.
<span class="nc" id="L89">        overviewElements.sort(Comparator.comparing(OverviewElement::getDisplayOrder, Comparator.nullsFirst(Comparator.naturalOrder()))</span>
<span class="nc" id="L90">            .thenComparing(overviewElement -&gt; getPlanItemInstanceEndTime(planItemInstances, overviewElement.getPlanItemDefinition()), Comparator.nullsLast(Comparator.naturalOrder()))</span>
        );
        
<span class="nc" id="L93">        List&lt;StageResponse&gt; stageResponses = new ArrayList&lt;&gt;(stages.size());</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">        for (OverviewElement overviewElement : overviewElements) {</span>
<span class="nc" id="L95">            Optional&lt;HistoricPlanItemInstance&gt; planItemInstance = getPlanItemInstance(planItemInstances, overviewElement.getPlanItemDefinition());</span>
<span class="nc" id="L96">            boolean showInOverview = false;</span>
            
            // If not ended or current, it's implicitly a future one
<span class="nc bnc" id="L99" title="All 2 branches missed.">            if (planItemInstance.isPresent()) {</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">                if (planItemInstance.get().isShowInOverview()) {</span>
<span class="nc" id="L101">                    showInOverview = true;</span>
                }
            
<span class="nc bnc" id="L104" title="All 2 branches missed.">            } else if (caseInstance.getEndTime() == null) {</span>
                // It can be a future one only if the case instance is not completed
<span class="nc bnc" id="L106" title="All 2 branches missed.">                if (!&quot;false&quot;.equalsIgnoreCase(overviewElement.getIncludeInStageOverview())) {</span>
<span class="nc" id="L107">                    showInOverview = true;</span>
                }
            }
            
<span class="nc bnc" id="L111" title="All 2 branches missed.">            if (showInOverview) {</span>
<span class="nc" id="L112">                StageResponse stageResponse = new StageResponse(overviewElement.getId(), overviewElement.getName());</span>
                
                // If not ended or current, it's implicitly a future one
<span class="nc bnc" id="L115" title="All 2 branches missed.">                if (planItemInstance.isPresent()) {</span>
<span class="nc" id="L116">                    stageResponse.setEndTime(planItemInstance.get().getEndedTime());</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">                    stageResponse.setEnded(stageResponse.getEndTime() != null);</span>
<span class="nc" id="L118">                    stageResponse.setCurrent(PlanItemInstanceState.ACTIVE.equals(planItemInstance.get().getState()));</span>
                }

<span class="nc" id="L121">                stageResponses.add(stageResponse);</span>
            }
<span class="nc" id="L123">        }</span>

<span class="nc" id="L125">        return stageResponses;</span>
    }
    
    protected Date getPlanItemInstanceEndTime(List&lt;HistoricPlanItemInstance&gt; planItemInstances, PlanItemDefinition planItemDefinition) {
<span class="nc" id="L129">        return getPlanItemInstance(planItemInstances, planItemDefinition)</span>
<span class="nc" id="L130">            .map(HistoricPlanItemInstance::getEndedTime)</span>
<span class="nc" id="L131">            .orElse(null);</span>
    }

    protected Optional&lt;HistoricPlanItemInstance&gt; getPlanItemInstance(List&lt;HistoricPlanItemInstance&gt; planItemInstances, PlanItemDefinition planItemDefinition) {
<span class="nc" id="L135">        HistoricPlanItemInstance planItemInstance = null;</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">        for (HistoricPlanItemInstance p : planItemInstances) {</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">            if (p.getPlanItemDefinitionId().equals(planItemDefinition.getId())) {</span>
                
<span class="nc bnc" id="L139" title="All 2 branches missed.">                if (p.getEndedTime() == null) {</span>
<span class="nc" id="L140">                    planItemInstance = p; // one that's not ended yet has precedence</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">                } else if (planItemInstance == null) {</span>
<span class="nc" id="L142">                    planItemInstance = p;</span>
                }
            }
<span class="nc" id="L145">        }</span>
<span class="nc" id="L146">        return Optional.ofNullable(planItemInstance);</span>
    }
    
    protected class OverviewElement {
        
        protected String id;
        protected String name;
        protected Integer displayOrder;
        protected String includeInStageOverview;
        protected PlanItemDefinition planItemDefinition;
        
<span class="nc" id="L157">        public OverviewElement(String id, String name, Integer displayOrder, String includeInStageOverview, PlanItemDefinition planItemDefinition) {</span>
<span class="nc" id="L158">            this.id = id;</span>
<span class="nc" id="L159">            this.name = name;</span>
<span class="nc" id="L160">            this.displayOrder = displayOrder;</span>
<span class="nc" id="L161">            this.includeInStageOverview = includeInStageOverview;</span>
<span class="nc" id="L162">            this.planItemDefinition = planItemDefinition;</span>
<span class="nc" id="L163">        }</span>

        public String getId() {
<span class="nc" id="L166">            return id;</span>
        }

        public void setId(String id) {
<span class="nc" id="L170">            this.id = id;</span>
<span class="nc" id="L171">        }</span>

        public String getName() {
<span class="nc" id="L174">            return name;</span>
        }

        public void setName(String name) {
<span class="nc" id="L178">            this.name = name;</span>
<span class="nc" id="L179">        }</span>

        public Integer getDisplayOrder() {
<span class="nc" id="L182">            return displayOrder;</span>
        }

        public void setDisplayOrder(Integer displayOrder) {
<span class="nc" id="L186">            this.displayOrder = displayOrder;</span>
<span class="nc" id="L187">        }</span>

        public String getIncludeInStageOverview() {
<span class="nc" id="L190">            return includeInStageOverview;</span>
        }

        public void setIncludeInStageOverview(String includeInStageOverview) {
<span class="nc" id="L194">            this.includeInStageOverview = includeInStageOverview;</span>
<span class="nc" id="L195">        }</span>

        public PlanItemDefinition getPlanItemDefinition() {
<span class="nc" id="L198">            return planItemDefinition;</span>
        }

        public void setPlanItemDefinition(PlanItemDefinition planItemDefinition) {
<span class="nc" id="L202">            this.planItemDefinition = planItemDefinition;</span>
<span class="nc" id="L203">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>