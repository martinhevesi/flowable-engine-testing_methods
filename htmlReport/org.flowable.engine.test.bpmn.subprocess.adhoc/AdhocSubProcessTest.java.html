<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdhocSubProcessTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.bpmn.subprocess.adhoc</a> &gt; <span class="el_source">AdhocSubProcessTest.java</span></div><h1>AdhocSubProcessTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.engine.test.bpmn.subprocess.adhoc;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.flowable.bpmn.model.FlowNode;
import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.engine.impl.test.HistoryTestHelper;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.runtime.Execution;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.task.api.history.HistoricTaskInstance;
import org.junit.jupiter.api.Test;

/**
 * @author Tijs Rademakers
 */
<span class="nc" id="L37">public class AdhocSubProcessTest extends PluggableFlowableTestCase {</span>

    @Test
    @Deployment
    public void testSimpleAdhocSubProcess() {
<span class="nc" id="L42">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;simpleSubProcess&quot;);</span>
<span class="nc" id="L43">        Execution execution = runtimeService.createExecutionQuery().activityId(&quot;adhocSubProcess&quot;).singleResult();</span>
<span class="nc" id="L44">        assertThat(execution).isNotNull();</span>

<span class="nc" id="L46">        List&lt;FlowNode&gt; enabledActivities = runtimeService.getEnabledActivitiesFromAdhocSubProcess(execution.getId());</span>
<span class="nc" id="L47">        assertThat(enabledActivities).hasSize(2);</span>

<span class="nc" id="L49">        Execution newTaskExecution = runtimeService.executeActivityInAdhocSubProcess(execution.getId(), &quot;subProcessTask&quot;);</span>
<span class="nc" id="L50">        assertThat(newTaskExecution).isNotNull();</span>
<span class="nc" id="L51">        assertThat(newTaskExecution.getId()).isNotNull();</span>

<span class="nc" id="L53">        org.flowable.task.api.Task subProcessTask = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;subProcessTask&quot;).singleResult();</span>
<span class="nc" id="L54">        assertThat(subProcessTask.getName()).isEqualTo(&quot;Task in subprocess&quot;);</span>

<span class="nc" id="L56">        taskService.complete(subProcessTask.getId());</span>

<span class="nc" id="L58">        enabledActivities = runtimeService.getEnabledActivitiesFromAdhocSubProcess(execution.getId());</span>
<span class="nc" id="L59">        assertThat(enabledActivities).hasSize(2);</span>

<span class="nc" id="L61">        runtimeService.completeAdhocSubProcess(execution.getId());</span>

<span class="nc" id="L63">        org.flowable.task.api.Task afterTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L64">        assertThat(afterTask.getName()).isEqualTo(&quot;After task&quot;);</span>

<span class="nc" id="L66">        taskService.complete(afterTask.getId());</span>

<span class="nc" id="L68">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(pi.getId()).singleResult()).isNull();</span>
<span class="nc" id="L69">    }</span>

    @Test
    @Deployment
    public void testSimpleAdhocSubProcessViaExecution() {
<span class="nc" id="L74">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;simpleSubProcess&quot;);</span>
<span class="nc" id="L75">        List&lt;Execution&gt; executions = runtimeService.getAdhocSubProcessExecutions(pi.getId());</span>
<span class="nc" id="L76">        assertThat(executions).hasSize(1);</span>

<span class="nc" id="L78">        List&lt;FlowNode&gt; enabledActivities = runtimeService.getEnabledActivitiesFromAdhocSubProcess(executions.get(0).getId());</span>
<span class="nc" id="L79">        assertThat(enabledActivities).hasSize(2);</span>

<span class="nc" id="L81">        Execution newTaskExecution = runtimeService.executeActivityInAdhocSubProcess(executions.get(0).getId(), &quot;subProcessTask&quot;);</span>
<span class="nc" id="L82">        assertThat(newTaskExecution).isNotNull();</span>
<span class="nc" id="L83">        assertThat(newTaskExecution.getId()).isNotNull();</span>

<span class="nc" id="L85">        org.flowable.task.api.Task subProcessTask = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;subProcessTask&quot;).singleResult();</span>
<span class="nc" id="L86">        assertThat(subProcessTask.getName()).isEqualTo(&quot;Task in subprocess&quot;);</span>

<span class="nc" id="L88">        taskService.complete(subProcessTask.getId());</span>

<span class="nc" id="L90">        executions = runtimeService.getAdhocSubProcessExecutions(pi.getId());</span>
<span class="nc" id="L91">        assertThat(executions).hasSize(1);</span>

<span class="nc" id="L93">        enabledActivities = runtimeService.getEnabledActivitiesFromAdhocSubProcess(executions.get(0).getId());</span>
<span class="nc" id="L94">        assertThat(enabledActivities).hasSize(2);</span>

<span class="nc" id="L96">        runtimeService.completeAdhocSubProcess(executions.get(0).getId());</span>

<span class="nc" id="L98">        executions = runtimeService.getAdhocSubProcessExecutions(pi.getId());</span>
<span class="nc" id="L99">        assertThat(executions).isEmpty();</span>

<span class="nc" id="L101">        org.flowable.task.api.Task afterTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L102">        assertThat(afterTask.getName()).isEqualTo(&quot;After task&quot;);</span>

<span class="nc" id="L104">        taskService.complete(afterTask.getId());</span>

<span class="nc" id="L106">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(pi.getId()).singleResult()).isNull();</span>
<span class="nc" id="L107">    }</span>

    @Test
    @Deployment
    public void testSimpleCompletionCondition() {
<span class="nc" id="L112">        Map&lt;String, Object&gt; variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L113">        variableMap.put(&quot;completed&quot;, false);</span>
<span class="nc" id="L114">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;simpleSubProcess&quot;, variableMap);</span>
<span class="nc" id="L115">        Execution execution = runtimeService.createExecutionQuery().activityId(&quot;adhocSubProcess&quot;).singleResult();</span>
<span class="nc" id="L116">        assertThat(execution).isNotNull();</span>

<span class="nc" id="L118">        List&lt;FlowNode&gt; enabledActivities = runtimeService.getEnabledActivitiesFromAdhocSubProcess(execution.getId());</span>
<span class="nc" id="L119">        assertThat(enabledActivities).hasSize(2);</span>

<span class="nc" id="L121">        Execution newTaskExecution = runtimeService.executeActivityInAdhocSubProcess(execution.getId(), &quot;subProcessTask&quot;);</span>
<span class="nc" id="L122">        assertThat(newTaskExecution).isNotNull();</span>
<span class="nc" id="L123">        assertThat(newTaskExecution.getId()).isNotNull();</span>

<span class="nc" id="L125">        org.flowable.task.api.Task subProcessTask = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;subProcessTask&quot;).singleResult();</span>
<span class="nc" id="L126">        assertThat(subProcessTask.getName()).isEqualTo(&quot;Task in subprocess&quot;);</span>

<span class="nc" id="L128">        taskService.complete(subProcessTask.getId());</span>

<span class="nc" id="L130">        enabledActivities = runtimeService.getEnabledActivitiesFromAdhocSubProcess(execution.getId());</span>
<span class="nc" id="L131">        assertThat(enabledActivities).hasSize(2);</span>

<span class="nc" id="L133">        newTaskExecution = runtimeService.executeActivityInAdhocSubProcess(execution.getId(), &quot;subProcessTask2&quot;);</span>

<span class="nc" id="L135">        subProcessTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L136">        assertThat(subProcessTask.getName()).isEqualTo(&quot;Task2 in subprocess&quot;);</span>

<span class="nc" id="L138">        variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L139">        variableMap.put(&quot;completed&quot;, true);</span>
<span class="nc" id="L140">        taskService.complete(subProcessTask.getId(), variableMap);</span>

<span class="nc" id="L142">        org.flowable.task.api.Task afterTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L143">        assertThat(afterTask.getName()).isEqualTo(&quot;After task&quot;);</span>

<span class="nc" id="L145">        taskService.complete(afterTask.getId());</span>

<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>

<span class="nc" id="L149">            List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L150">                    .processInstanceId(pi.getId())</span>
<span class="nc" id="L151">                    .orderByHistoricTaskInstanceEndTime()</span>
<span class="nc" id="L152">                    .asc()</span>
<span class="nc" id="L153">                    .list();</span>

            // only check for existence and assume that the SQL processing has ordered the values correctly
            // see https://github.com/flowable/flowable-engine/issues/8
<span class="nc" id="L157">            assertThat(historicTasks)</span>
<span class="nc" id="L158">                    .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L159">                    .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;subProcessTask2&quot;, &quot;afterTask&quot;);</span>
        }

<span class="nc" id="L162">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(pi.getId()).singleResult()).isNull();</span>
<span class="nc" id="L163">    }</span>

    @Test
    @Deployment
    public void testParallelAdhocSubProcess() {
<span class="nc" id="L168">        Map&lt;String, Object&gt; variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L169">        variableMap.put(&quot;completed&quot;, false);</span>
<span class="nc" id="L170">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;simpleSubProcess&quot;, variableMap);</span>
<span class="nc" id="L171">        Execution execution = runtimeService.createExecutionQuery().activityId(&quot;adhocSubProcess&quot;).singleResult();</span>
<span class="nc" id="L172">        assertThat(execution).isNotNull();</span>

<span class="nc" id="L174">        List&lt;FlowNode&gt; enabledActivities = runtimeService.getEnabledActivitiesFromAdhocSubProcess(execution.getId());</span>
<span class="nc" id="L175">        assertThat(enabledActivities).hasSize(2);</span>

<span class="nc" id="L177">        runtimeService.executeActivityInAdhocSubProcess(execution.getId(), &quot;subProcessTask&quot;);</span>
<span class="nc" id="L178">        org.flowable.task.api.Task subProcessTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L179">        assertThat(subProcessTask.getName()).isEqualTo(&quot;Task in subprocess&quot;);</span>

<span class="nc" id="L181">        runtimeService.executeActivityInAdhocSubProcess(execution.getId(), &quot;subProcessTask2&quot;);</span>
<span class="nc" id="L182">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(pi.getId()).list();</span>
<span class="nc" id="L183">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L185">        variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L186">        variableMap.put(&quot;completed&quot;, true);</span>
<span class="nc" id="L187">        taskService.complete(subProcessTask.getId(), variableMap);</span>

<span class="nc" id="L189">        org.flowable.task.api.Task afterTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L190">        assertThat(afterTask.getName()).isEqualTo(&quot;After task&quot;);</span>

<span class="nc" id="L192">        taskService.complete(afterTask.getId());</span>

<span class="nc" id="L194">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(pi.getId()).singleResult()).isNull();</span>
<span class="nc" id="L195">    }</span>

    @Test
    @Deployment
    public void testSequentialAdhocSubProcess() {
<span class="nc" id="L200">        Map&lt;String, Object&gt; variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L201">        variableMap.put(&quot;completed&quot;, false);</span>
<span class="nc" id="L202">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;simpleSubProcess&quot;, variableMap);</span>
<span class="nc" id="L203">        Execution execution = runtimeService.createExecutionQuery().activityId(&quot;adhocSubProcess&quot;).singleResult();</span>
<span class="nc" id="L204">        assertThat(execution).isNotNull();</span>

<span class="nc" id="L206">        List&lt;FlowNode&gt; enabledActivities = runtimeService.getEnabledActivitiesFromAdhocSubProcess(execution.getId());</span>
<span class="nc" id="L207">        assertThat(enabledActivities).hasSize(2);</span>

<span class="nc" id="L209">        runtimeService.executeActivityInAdhocSubProcess(execution.getId(), &quot;subProcessTask&quot;);</span>
<span class="nc" id="L210">        org.flowable.task.api.Task subProcessTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L211">        assertThat(subProcessTask.getName()).isEqualTo(&quot;Task in subprocess&quot;);</span>

<span class="nc" id="L213">        assertThatThrownBy(() -&gt; runtimeService.executeActivityInAdhocSubProcess(execution.getId(), &quot;subProcessTask2&quot;))</span>
<span class="nc" id="L214">                .as(&quot;exception expected because can only enable one activity in a sequential ad-hoc sub process&quot;)</span>
<span class="nc" id="L215">                .isInstanceOf(FlowableException.class);</span>

<span class="nc" id="L217">        taskService.complete(subProcessTask.getId());</span>

        // now we can enable the activity
<span class="nc" id="L220">        runtimeService.executeActivityInAdhocSubProcess(execution.getId(), &quot;subProcessTask2&quot;);</span>

<span class="nc" id="L222">        subProcessTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L223">        assertThat(subProcessTask.getName()).isEqualTo(&quot;Task2 in subprocess&quot;);</span>

<span class="nc" id="L225">        variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L226">        variableMap.put(&quot;completed&quot;, true);</span>
<span class="nc" id="L227">        taskService.complete(subProcessTask.getId(), variableMap);</span>

<span class="nc" id="L229">        org.flowable.task.api.Task afterTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L230">        assertThat(afterTask.getName()).isEqualTo(&quot;After task&quot;);</span>

<span class="nc" id="L232">        taskService.complete(afterTask.getId());</span>

<span class="nc" id="L234">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(pi.getId()).singleResult()).isNull();</span>
<span class="nc" id="L235">    }</span>

    @Test
    @Deployment
    public void testFlowsInAdhocSubProcess() {
<span class="nc" id="L240">        Map&lt;String, Object&gt; variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L241">        variableMap.put(&quot;completed&quot;, false);</span>
<span class="nc" id="L242">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;simpleSubProcess&quot;, variableMap);</span>
<span class="nc" id="L243">        Execution execution = runtimeService.createExecutionQuery().activityId(&quot;adhocSubProcess&quot;).singleResult();</span>
<span class="nc" id="L244">        assertThat(execution).isNotNull();</span>

<span class="nc" id="L246">        List&lt;FlowNode&gt; enabledActivities = runtimeService.getEnabledActivitiesFromAdhocSubProcess(execution.getId());</span>
<span class="nc" id="L247">        assertThat(enabledActivities).hasSize(2);</span>

<span class="nc" id="L249">        runtimeService.executeActivityInAdhocSubProcess(execution.getId(), &quot;subProcessTask&quot;);</span>
<span class="nc" id="L250">        org.flowable.task.api.Task subProcessTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L251">        assertThat(subProcessTask.getName()).isEqualTo(&quot;Task in subprocess&quot;);</span>

<span class="nc" id="L253">        taskService.complete(subProcessTask.getId());</span>

<span class="nc" id="L255">        assertThatThrownBy(() -&gt; runtimeService.executeActivityInAdhocSubProcess(execution.getId(), &quot;subProcessTask2&quot;))</span>
<span class="nc" id="L256">                .as(&quot;exception expected because can only enable one activity in a sequential ad-hoc sub process&quot;)</span>
<span class="nc" id="L257">                .isInstanceOf(FlowableException.class);</span>

<span class="nc" id="L259">        subProcessTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L260">        assertThat(subProcessTask.getName()).isEqualTo(&quot;The next task&quot;);</span>

<span class="nc" id="L262">        variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L263">        variableMap.put(&quot;completed&quot;, true);</span>
<span class="nc" id="L264">        taskService.complete(subProcessTask.getId(), variableMap);</span>

<span class="nc" id="L266">        org.flowable.task.api.Task afterTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L267">        assertThat(afterTask.getName()).isEqualTo(&quot;After task&quot;);</span>

<span class="nc" id="L269">        taskService.complete(afterTask.getId());</span>

<span class="nc" id="L271">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(pi.getId()).singleResult()).isNull();</span>
<span class="nc" id="L272">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/bpmn/subprocess/adhoc/AdhocSubProcessTest.testFlowsInAdhocSubProcess.bpmn20.xml&quot;)
    public void testCompleteFlowBeforeEndInAdhocSubProcess() {
<span class="nc" id="L277">        Map&lt;String, Object&gt; variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L278">        variableMap.put(&quot;completed&quot;, false);</span>
<span class="nc" id="L279">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;simpleSubProcess&quot;, variableMap);</span>
<span class="nc" id="L280">        Execution execution = runtimeService.createExecutionQuery().activityId(&quot;adhocSubProcess&quot;).singleResult();</span>
<span class="nc" id="L281">        assertThat(execution).isNotNull();</span>

<span class="nc" id="L283">        List&lt;FlowNode&gt; enabledActivities = runtimeService.getEnabledActivitiesFromAdhocSubProcess(execution.getId());</span>
<span class="nc" id="L284">        assertThat(enabledActivities).hasSize(2);</span>

<span class="nc" id="L286">        runtimeService.executeActivityInAdhocSubProcess(execution.getId(), &quot;subProcessTask&quot;);</span>
<span class="nc" id="L287">        org.flowable.task.api.Task subProcessTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L288">        assertThat(subProcessTask.getName()).isEqualTo(&quot;Task in subprocess&quot;);</span>

<span class="nc" id="L290">        variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L291">        variableMap.put(&quot;completed&quot;, true);</span>
<span class="nc" id="L292">        taskService.complete(subProcessTask.getId(), variableMap);</span>

<span class="nc" id="L294">        org.flowable.task.api.Task afterTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L295">        assertThat(afterTask.getName()).isEqualTo(&quot;After task&quot;);</span>

<span class="nc" id="L297">        taskService.complete(afterTask.getId());</span>

<span class="nc" id="L299">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(pi.getId()).singleResult()).isNull();</span>
<span class="nc" id="L300">    }</span>

    @Test
    @Deployment
    public void testParallelFlowsInAdhocSubProcess() {
<span class="nc" id="L305">        Map&lt;String, Object&gt; variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L306">        variableMap.put(&quot;completed&quot;, false);</span>
<span class="nc" id="L307">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;simpleSubProcess&quot;, variableMap);</span>
<span class="nc" id="L308">        Execution execution = runtimeService.createExecutionQuery().activityId(&quot;adhocSubProcess&quot;).singleResult();</span>
<span class="nc" id="L309">        assertThat(execution).isNotNull();</span>

<span class="nc" id="L311">        List&lt;FlowNode&gt; enabledActivities = runtimeService.getEnabledActivitiesFromAdhocSubProcess(execution.getId());</span>
<span class="nc" id="L312">        assertThat(enabledActivities).hasSize(3);</span>

<span class="nc" id="L314">        runtimeService.executeActivityInAdhocSubProcess(execution.getId(), &quot;subProcessTask&quot;);</span>
<span class="nc" id="L315">        org.flowable.task.api.Task subProcessTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L316">        assertThat(subProcessTask.getName()).isEqualTo(&quot;Task in subprocess&quot;);</span>

<span class="nc" id="L318">        runtimeService.executeActivityInAdhocSubProcess(execution.getId(), &quot;subProcessTask2&quot;);</span>
<span class="nc" id="L319">        runtimeService.executeActivityInAdhocSubProcess(execution.getId(), &quot;subProcessTask3&quot;);</span>

<span class="nc" id="L321">        org.flowable.task.api.Task subProcessTask2 = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;subProcessTask2&quot;).singleResult();</span>
<span class="nc" id="L322">        assertThat(subProcessTask2.getName()).isEqualTo(&quot;Task2 in subprocess&quot;);</span>
<span class="nc" id="L323">        taskService.complete(subProcessTask2.getId());</span>

<span class="nc" id="L325">        subProcessTask2 = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;sequentialTask2&quot;).singleResult();</span>
<span class="nc" id="L326">        assertThat(subProcessTask2.getName()).isEqualTo(&quot;The next task2&quot;);</span>

<span class="nc" id="L328">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(pi.getId()).list();</span>
<span class="nc" id="L329">        assertThat(tasks).hasSize(3);</span>

<span class="nc" id="L331">        variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L332">        variableMap.put(&quot;completed&quot;, true);</span>
<span class="nc" id="L333">        taskService.complete(subProcessTask.getId(), variableMap);</span>

<span class="nc" id="L335">        org.flowable.task.api.Task afterTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L336">        assertThat(afterTask.getName()).isEqualTo(&quot;After task&quot;);</span>

<span class="nc" id="L338">        taskService.complete(afterTask.getId());</span>

<span class="nc" id="L340">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(pi.getId()).singleResult()).isNull();</span>
<span class="nc" id="L341">    }</span>

    @Test
    @Deployment
    public void testKeepRemainingInstancesAdhocSubProcess() {
<span class="nc" id="L346">        Map&lt;String, Object&gt; variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L347">        variableMap.put(&quot;completed&quot;, false);</span>
<span class="nc" id="L348">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;simpleSubProcess&quot;, variableMap);</span>
<span class="nc" id="L349">        Execution execution = runtimeService.createExecutionQuery().activityId(&quot;adhocSubProcess&quot;).singleResult();</span>
<span class="nc" id="L350">        assertThat(execution).isNotNull();</span>

<span class="nc" id="L352">        List&lt;FlowNode&gt; enabledActivities = runtimeService.getEnabledActivitiesFromAdhocSubProcess(execution.getId());</span>
<span class="nc" id="L353">        assertThat(enabledActivities).hasSize(2);</span>

<span class="nc" id="L355">        runtimeService.executeActivityInAdhocSubProcess(execution.getId(), &quot;subProcessTask&quot;);</span>
<span class="nc" id="L356">        org.flowable.task.api.Task subProcessTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L357">        assertThat(subProcessTask.getName()).isEqualTo(&quot;Task in subprocess&quot;);</span>

<span class="nc" id="L359">        runtimeService.executeActivityInAdhocSubProcess(execution.getId(), &quot;subProcessTask2&quot;);</span>
<span class="nc" id="L360">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(pi.getId()).list();</span>
<span class="nc" id="L361">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L363">        variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L364">        variableMap.put(&quot;completed&quot;, true);</span>
<span class="nc" id="L365">        taskService.complete(subProcessTask.getId(), variableMap);</span>

        // ad-hoc sub process is not completed because of cancelRemainingInstances is set to false
<span class="nc" id="L368">        subProcessTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L369">        assertThat(subProcessTask.getName()).isEqualTo(&quot;Task2 in subprocess&quot;);</span>

<span class="nc" id="L371">        taskService.complete(subProcessTask.getId());</span>

        // with no remaining executions the ad-hoc sub process will be completed
<span class="nc" id="L374">        org.flowable.task.api.Task afterTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L375">        assertThat(afterTask.getName()).isEqualTo(&quot;After task&quot;);</span>

<span class="nc" id="L377">        taskService.complete(afterTask.getId());</span>

<span class="nc" id="L379">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(pi.getId()).singleResult()).isNull();</span>
<span class="nc" id="L380">    }</span>

    @Test
    @Deployment
    public void testParallelFlowsWithKeepRemainingInstancesAdhocSubProcess() {
<span class="nc" id="L385">        Map&lt;String, Object&gt; variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L386">        variableMap.put(&quot;completed&quot;, false);</span>
<span class="nc" id="L387">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;simpleSubProcess&quot;, variableMap);</span>
<span class="nc" id="L388">        Execution execution = runtimeService.createExecutionQuery().activityId(&quot;adhocSubProcess&quot;).singleResult();</span>
<span class="nc" id="L389">        assertThat(execution).isNotNull();</span>

<span class="nc" id="L391">        List&lt;FlowNode&gt; enabledActivities = runtimeService.getEnabledActivitiesFromAdhocSubProcess(execution.getId());</span>
<span class="nc" id="L392">        assertThat(enabledActivities).hasSize(3);</span>

<span class="nc" id="L394">        runtimeService.executeActivityInAdhocSubProcess(execution.getId(), &quot;subProcessTask&quot;);</span>
<span class="nc" id="L395">        org.flowable.task.api.Task subProcessTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L396">        assertThat(subProcessTask.getName()).isEqualTo(&quot;Task in subprocess&quot;);</span>

<span class="nc" id="L398">        runtimeService.executeActivityInAdhocSubProcess(execution.getId(), &quot;subProcessTask2&quot;);</span>
<span class="nc" id="L399">        runtimeService.executeActivityInAdhocSubProcess(execution.getId(), &quot;subProcessTask3&quot;);</span>

<span class="nc" id="L401">        org.flowable.task.api.Task subProcessTask2 = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;subProcessTask2&quot;).singleResult();</span>
<span class="nc" id="L402">        assertThat(subProcessTask2.getName()).isEqualTo(&quot;Task2 in subprocess&quot;);</span>
<span class="nc" id="L403">        taskService.complete(subProcessTask2.getId());</span>

<span class="nc" id="L405">        subProcessTask2 = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;sequentialTask2&quot;).singleResult();</span>
<span class="nc" id="L406">        assertThat(subProcessTask2.getName()).isEqualTo(&quot;The next task2&quot;);</span>

<span class="nc" id="L408">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(pi.getId()).list();</span>
<span class="nc" id="L409">        assertThat(tasks).hasSize(3);</span>

<span class="nc" id="L411">        variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L412">        variableMap.put(&quot;completed&quot;, true);</span>
<span class="nc" id="L413">        taskService.complete(subProcessTask.getId(), variableMap);</span>

        // ad-hoc sub process is not completed because of cancelRemainingInstances is set to false
<span class="nc" id="L416">        tasks = taskService.createTaskQuery().processInstanceId(pi.getId()).list();</span>
<span class="nc" id="L417">        assertThat(tasks).hasSize(3);</span>

<span class="nc" id="L419">        subProcessTask = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;sequentialTask&quot;).singleResult();</span>
<span class="nc" id="L420">        assertThat(subProcessTask.getName()).isEqualTo(&quot;The next task&quot;);</span>

<span class="nc" id="L422">        taskService.complete(subProcessTask.getId(), variableMap);</span>

        // ad-hoc sub process is not completed because of cancelRemainingInstances is set to false
<span class="nc" id="L425">        tasks = taskService.createTaskQuery().processInstanceId(pi.getId()).list();</span>
<span class="nc" id="L426">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L428">        taskService.complete(subProcessTask2.getId(), variableMap);</span>

        // ad-hoc sub process is not completed because of cancelRemainingInstances is set to false
<span class="nc" id="L431">        org.flowable.task.api.Task subProcessTask3 = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L432">        assertThat(subProcessTask3.getName()).isEqualTo(&quot;Task3 in subprocess&quot;);</span>

<span class="nc" id="L434">        taskService.complete(subProcessTask3.getId(), variableMap);</span>

        // with no remaining executions the ad-hoc sub process will be completed
<span class="nc" id="L437">        org.flowable.task.api.Task afterTask = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L438">        assertThat(afterTask.getName()).isEqualTo(&quot;After task&quot;);</span>

<span class="nc" id="L440">        taskService.complete(afterTask.getId());</span>

<span class="nc" id="L442">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(pi.getId()).singleResult()).isNull();</span>
<span class="nc" id="L443">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>