<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FullHistoryTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.standalone.history</a> &gt; <span class="el_source">FullHistoryTest.java</span></div><h1>FullHistoryTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.standalone.history;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

import java.text.SimpleDateFormat;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import jakarta.persistence.EntityManager;
import jakarta.persistence.EntityManagerFactory;

import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.api.FlowableIllegalArgumentException;
import org.flowable.common.engine.api.FlowableObjectNotFoundException;
import org.flowable.engine.history.HistoricActivityInstance;
import org.flowable.engine.history.HistoricDetail;
import org.flowable.engine.history.HistoricFormProperty;
import org.flowable.engine.history.HistoricProcessInstance;
import org.flowable.engine.history.HistoricVariableUpdate;
import org.flowable.engine.impl.test.ResourceFlowableTestCase;
import org.flowable.engine.repository.ProcessDefinition;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.engine.test.api.runtime.DummySerializable;
import org.flowable.engine.test.history.SerializableVariable;
import org.flowable.standalone.jpa.FieldAccessJPAEntity;
import org.flowable.task.api.history.HistoricTaskInstance;
import org.flowable.variable.api.history.HistoricVariableInstance;
import org.flowable.variable.api.history.HistoricVariableInstanceQuery;
import org.flowable.variable.service.impl.types.EntityManagerSession;
import org.flowable.variable.service.impl.types.EntityManagerSessionFactory;
import org.junit.jupiter.api.Test;

/**
 * @author Tom Baeyens
 * @author Frederik Heremans
 * @author Joram Barrez
 * @author Christian Lipphardt (camunda)
 */
public class FullHistoryTest extends ResourceFlowableTestCase {

    public FullHistoryTest() {
<span class="nc" id="L62">        super(&quot;org/flowable/standalone/history/fullhistory.flowable.cfg.xml&quot;);</span>
<span class="nc" id="L63">    }</span>

    @Test
    @Deployment
    public void testVariableUpdates() {
<span class="nc" id="L68">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L69">        variables.put(&quot;number&quot;, &quot;one&quot;);</span>
<span class="nc" id="L70">        variables.put(&quot;character&quot;, &quot;a&quot;);</span>
<span class="nc" id="L71">        variables.put(&quot;bytes&quot;, &quot;:-(&quot;.getBytes());</span>
<span class="nc" id="L72">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;receiveTask&quot;, variables);</span>
<span class="nc" id="L73">        runtimeService.setVariable(processInstance.getId(), &quot;number&quot;, &quot;two&quot;);</span>
<span class="nc" id="L74">        runtimeService.setVariable(processInstance.getId(), &quot;bytes&quot;, &quot;:-)&quot;.getBytes());</span>

        // Start-task should be added to history
<span class="nc" id="L77">        HistoricActivityInstance historicStartEvent = historyService.createHistoricActivityInstanceQuery().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L78">                .activityId(&quot;theStart&quot;).singleResult();</span>
<span class="nc" id="L79">        assertThat(historicStartEvent).isNotNull();</span>
<span class="nc" id="L80">        assertActivityInstancesAreSame(historicStartEvent,</span>
<span class="nc" id="L81">                runtimeService.createActivityInstanceQuery().activityInstanceId(historicStartEvent.getId()).singleResult());</span>

<span class="nc" id="L83">        HistoricActivityInstance waitStateActivity = historyService.createHistoricActivityInstanceQuery().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L84">                .activityId(&quot;waitState&quot;).singleResult();</span>
<span class="nc" id="L85">        assertActivityInstancesAreSame(waitStateActivity,</span>
<span class="nc" id="L86">                runtimeService.createActivityInstanceQuery().activityInstanceId(waitStateActivity.getId()).singleResult());</span>
<span class="nc" id="L87">        assertThat(waitStateActivity).isNotNull();</span>

<span class="nc" id="L89">        HistoricActivityInstance serviceTaskActivity = historyService.createHistoricActivityInstanceQuery().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L90">                .activityId(&quot;serviceTask&quot;).singleResult();</span>
<span class="nc" id="L91">        assertActivityInstancesAreSame(serviceTaskActivity,</span>
<span class="nc" id="L92">                runtimeService.createActivityInstanceQuery().activityInstanceId(serviceTaskActivity.getId()).singleResult());</span>
<span class="nc" id="L93">        assertThat(serviceTaskActivity).isNotNull();</span>

<span class="nc" id="L95">        List&lt;HistoricDetail&gt; historicDetails = historyService.createHistoricDetailQuery().orderByVariableName().asc().orderByVariableRevision().asc().list();</span>

<span class="nc" id="L97">        assertThat(historicDetails).hasSize(10);</span>

<span class="nc" id="L99">        HistoricVariableUpdate historicVariableUpdate = (HistoricVariableUpdate) historicDetails.get(0);</span>
<span class="nc" id="L100">        assertThat(historicVariableUpdate.getVariableName()).isEqualTo(&quot;bytes&quot;);</span>
<span class="nc" id="L101">        assertThat(new String((byte[]) historicVariableUpdate.getValue())).isEqualTo(&quot;:-(&quot;);</span>
<span class="nc" id="L102">        assertThat(historicVariableUpdate.getRevision()).isZero();</span>

        // Flowable 6: we don't store the start event activityId anymore!
        // assertThat(historicVariableUpdate.getActivityInstanceId()).isEqualTo(historicStartEvent.getId());
<span class="nc" id="L106">        assertThat(historicVariableUpdate.getActivityInstanceId()).isNull();</span>

        // Variable is updated when process was in waitstate
<span class="nc" id="L109">        historicVariableUpdate = (HistoricVariableUpdate) historicDetails.get(1);</span>
<span class="nc" id="L110">        assertThat(historicVariableUpdate.getVariableName()).isEqualTo(&quot;bytes&quot;);</span>
<span class="nc" id="L111">        assertThat(new String((byte[]) historicVariableUpdate.getValue())).isEqualTo(&quot;:-)&quot;);</span>
<span class="nc" id="L112">        assertThat(historicVariableUpdate.getRevision()).isEqualTo(1);</span>

        // assertThat(historicVariableUpdate.getActivityInstanceId()).isEqualTo(waitStateActivity.getId());
<span class="nc" id="L115">        assertThat(historicVariableUpdate.getActivityInstanceId()).isNull();</span>

<span class="nc" id="L117">        historicVariableUpdate = (HistoricVariableUpdate) historicDetails.get(2);</span>
<span class="nc" id="L118">        assertThat(historicVariableUpdate.getVariableName()).isEqualTo(&quot;character&quot;);</span>
<span class="nc" id="L119">        assertThat(historicVariableUpdate.getValue()).isEqualTo(&quot;a&quot;);</span>
<span class="nc" id="L120">        assertThat(historicVariableUpdate.getRevision()).isZero();</span>

        // assertThat(historicVariableUpdate.getActivityInstanceId()).isEqualTo(historicStartEvent.getId());
<span class="nc" id="L123">        assertThat(historicVariableUpdate.getActivityInstanceId()).isNull();</span>

<span class="nc" id="L125">        historicVariableUpdate = (HistoricVariableUpdate) historicDetails.get(3);</span>
<span class="nc" id="L126">        assertThat(historicVariableUpdate.getVariableName()).isEqualTo(&quot;number&quot;);</span>
<span class="nc" id="L127">        assertThat(historicVariableUpdate.getValue()).isEqualTo(&quot;one&quot;);</span>
<span class="nc" id="L128">        assertThat(historicVariableUpdate.getRevision()).isZero();</span>

        // assertThat(historicVariableUpdate.getActivityInstanceId()).isEqualTo(historicStartEvent.getId());
<span class="nc" id="L131">        assertThat(historicVariableUpdate.getActivityInstanceId()).isNull();</span>

        // Variable is updated when process was in waitstate
<span class="nc" id="L134">        historicVariableUpdate = (HistoricVariableUpdate) historicDetails.get(4);</span>
<span class="nc" id="L135">        assertThat(historicVariableUpdate.getVariableName()).isEqualTo(&quot;number&quot;);</span>
<span class="nc" id="L136">        assertThat(historicVariableUpdate.getValue()).isEqualTo(&quot;two&quot;);</span>
<span class="nc" id="L137">        assertThat(historicVariableUpdate.getRevision()).isEqualTo(1);</span>

        // assertThat(historicVariableUpdate.getActivityInstanceId()).isEqualTo(waitStateActivity.getId());
<span class="nc" id="L140">        assertThat(historicVariableUpdate.getActivityInstanceId()).isNull();</span>

        // Variable set from process-start execution listener
<span class="nc" id="L143">        historicVariableUpdate = (HistoricVariableUpdate) historicDetails.get(5);</span>
<span class="nc" id="L144">        assertThat(historicVariableUpdate.getVariableName()).isEqualTo(&quot;zVar1&quot;);</span>
<span class="nc" id="L145">        assertThat(historicVariableUpdate.getValue()).isEqualTo(&quot;Event: start&quot;);</span>
<span class="nc" id="L146">        assertThat(historicVariableUpdate.getRevision()).isZero();</span>
<span class="nc" id="L147">        assertThat(historicVariableUpdate.getActivityInstanceId()).isNull();</span>

        // Variable set from transition take execution listener
<span class="nc" id="L150">        historicVariableUpdate = (HistoricVariableUpdate) historicDetails.get(6);</span>
<span class="nc" id="L151">        assertThat(historicVariableUpdate.getVariableName()).isEqualTo(&quot;zVar2&quot;);</span>
<span class="nc" id="L152">        assertThat(historicVariableUpdate.getValue()).isEqualTo(&quot;Event: take&quot;);</span>
<span class="nc" id="L153">        assertThat(historicVariableUpdate.getRevision()).isZero();</span>
<span class="nc" id="L154">        assertThat(historicVariableUpdate.getActivityInstanceId()).isNull();</span>

        // Variable set from activity start execution listener on the servicetask
<span class="nc" id="L157">        historicVariableUpdate = (HistoricVariableUpdate) historicDetails.get(7);</span>
<span class="nc" id="L158">        assertThat(historicVariableUpdate.getVariableName()).isEqualTo(&quot;zVar3&quot;);</span>
<span class="nc" id="L159">        assertThat(historicVariableUpdate.getValue()).isEqualTo(&quot;Event: start&quot;);</span>
<span class="nc" id="L160">        assertThat(historicVariableUpdate.getRevision()).isZero();</span>
<span class="nc" id="L161">        assertThat(historicVariableUpdate.getActivityInstanceId()).isEqualTo(serviceTaskActivity.getId());</span>

        // Variable set from activity end execution listener on the servicetask
<span class="nc" id="L164">        historicVariableUpdate = (HistoricVariableUpdate) historicDetails.get(8);</span>
<span class="nc" id="L165">        assertThat(historicVariableUpdate.getVariableName()).isEqualTo(&quot;zVar4&quot;);</span>
<span class="nc" id="L166">        assertThat(historicVariableUpdate.getValue()).isEqualTo(&quot;Event: end&quot;);</span>
<span class="nc" id="L167">        assertThat(historicVariableUpdate.getRevision()).isZero();</span>
<span class="nc" id="L168">        assertThat(historicVariableUpdate.getActivityInstanceId()).isEqualTo(serviceTaskActivity.getId());</span>

        // Variable set from service-task
<span class="nc" id="L171">        historicVariableUpdate = (HistoricVariableUpdate) historicDetails.get(9);</span>
<span class="nc" id="L172">        assertThat(historicVariableUpdate.getVariableName()).isEqualTo(&quot;zzz&quot;);</span>
<span class="nc" id="L173">        assertThat(historicVariableUpdate.getValue()).isEqualTo(123456789L);</span>
<span class="nc" id="L174">        assertThat(historicVariableUpdate.getRevision()).isZero();</span>
<span class="nc" id="L175">        assertThat(historicVariableUpdate.getActivityInstanceId()).isEqualTo(serviceTaskActivity.getId());</span>

        // trigger receive task
<span class="nc" id="L178">        runtimeService.trigger(runtimeService.createExecutionQuery().activityId(&quot;waitState&quot;).singleResult().getId());</span>
<span class="nc" id="L179">        assertProcessEnded(processInstance.getId());</span>

        // check for historic process variables set
<span class="nc" id="L182">        HistoricVariableInstanceQuery historicProcessVariableQuery = historyService.createHistoricVariableInstanceQuery().orderByVariableName().asc();</span>

<span class="nc" id="L184">        assertThat(historicProcessVariableQuery.count()).isEqualTo(8);</span>

<span class="nc" id="L186">        List&lt;HistoricVariableInstance&gt; historicVariables = historicProcessVariableQuery.list();</span>

        // Variable status when process is finished
<span class="nc" id="L189">        HistoricVariableInstance historicVariable = historicVariables.get(0);</span>
<span class="nc" id="L190">        assertThat(historicVariable.getVariableName()).isEqualTo(&quot;bytes&quot;);</span>
<span class="nc" id="L191">        assertThat(new String((byte[]) historicVariable.getValue())).isEqualTo(&quot;:-)&quot;);</span>
<span class="nc" id="L192">        assertThat(historicVariable.getCreateTime()).isNotNull();</span>
<span class="nc" id="L193">        assertThat(historicVariable.getLastUpdatedTime()).isNotNull();</span>

<span class="nc" id="L195">        historicVariable = historicVariables.get(1);</span>
<span class="nc" id="L196">        assertThat(historicVariable.getVariableName()).isEqualTo(&quot;character&quot;);</span>
<span class="nc" id="L197">        assertThat(historicVariable.getValue()).isEqualTo(&quot;a&quot;);</span>
<span class="nc" id="L198">        assertThat(historicVariable.getCreateTime()).isNotNull();</span>
<span class="nc" id="L199">        assertThat(historicVariable.getLastUpdatedTime()).isNotNull();</span>

<span class="nc" id="L201">        historicVariable = historicVariables.get(2);</span>
<span class="nc" id="L202">        assertThat(historicVariable.getVariableName()).isEqualTo(&quot;number&quot;);</span>
<span class="nc" id="L203">        assertThat(historicVariable.getValue()).isEqualTo(&quot;two&quot;);</span>
<span class="nc" id="L204">        assertThat(historicVariable.getCreateTime()).isNotNull();</span>
<span class="nc" id="L205">        assertThat(historicVariable.getLastUpdatedTime()).isNotSameAs(historicVariable.getCreateTime());</span>

<span class="nc" id="L207">        historicVariable = historicVariables.get(3);</span>
<span class="nc" id="L208">        assertThat(historicVariable.getVariableName()).isEqualTo(&quot;zVar1&quot;);</span>
<span class="nc" id="L209">        assertThat(historicVariable.getValue()).isEqualTo(&quot;Event: start&quot;);</span>
<span class="nc" id="L210">        assertThat(historicVariable.getCreateTime()).isNotNull();</span>
<span class="nc" id="L211">        assertThat(historicVariable.getLastUpdatedTime()).isNotNull();</span>

<span class="nc" id="L213">        historicVariable = historicVariables.get(4);</span>
<span class="nc" id="L214">        assertThat(historicVariable.getVariableName()).isEqualTo(&quot;zVar2&quot;);</span>
<span class="nc" id="L215">        assertThat(historicVariable.getValue()).isEqualTo(&quot;Event: take&quot;);</span>
<span class="nc" id="L216">        assertThat(historicVariable.getCreateTime()).isNotNull();</span>
<span class="nc" id="L217">        assertThat(historicVariable.getLastUpdatedTime()).isNotNull();</span>

<span class="nc" id="L219">        historicVariable = historicVariables.get(5);</span>
<span class="nc" id="L220">        assertThat(historicVariable.getVariableName()).isEqualTo(&quot;zVar3&quot;);</span>
<span class="nc" id="L221">        assertThat(historicVariable.getValue()).isEqualTo(&quot;Event: start&quot;);</span>
<span class="nc" id="L222">        assertThat(historicVariable.getCreateTime()).isNotNull();</span>
<span class="nc" id="L223">        assertThat(historicVariable.getLastUpdatedTime()).isNotNull();</span>

<span class="nc" id="L225">        historicVariable = historicVariables.get(6);</span>
<span class="nc" id="L226">        assertThat(historicVariable.getVariableName()).isEqualTo(&quot;zVar4&quot;);</span>
<span class="nc" id="L227">        assertThat(historicVariable.getValue()).isEqualTo(&quot;Event: end&quot;);</span>
<span class="nc" id="L228">        assertThat(historicVariable.getCreateTime()).isNotNull();</span>
<span class="nc" id="L229">        assertThat(historicVariable.getLastUpdatedTime()).isNotNull();</span>

<span class="nc" id="L231">        historicVariable = historicVariables.get(7);</span>
<span class="nc" id="L232">        assertThat(historicVariable.getVariableName()).isEqualTo(&quot;zzz&quot;);</span>
<span class="nc" id="L233">        assertThat(historicVariable.getValue()).isEqualTo(123456789L);</span>
<span class="nc" id="L234">        assertThat(historicVariable.getCreateTime()).isNotNull();</span>
<span class="nc" id="L235">        assertThat(historicVariable.getLastUpdatedTime()).isNotNull();</span>

<span class="nc" id="L237">        historicVariable = historyService.createHistoricVariableInstanceQuery().variableValueLike(&quot;number&quot;, &quot;tw%&quot;).singleResult();</span>
<span class="nc" id="L238">        assertThat(historicVariable).isNotNull();</span>
<span class="nc" id="L239">        assertThat(historicVariable.getVariableName()).isEqualTo(&quot;number&quot;);</span>
<span class="nc" id="L240">        assertThat(historicVariable.getValue()).isEqualTo(&quot;two&quot;);</span>

<span class="nc" id="L242">        historicVariable = historyService.createHistoricVariableInstanceQuery().variableValueLikeIgnoreCase(&quot;number&quot;, &quot;TW%&quot;).singleResult();</span>
<span class="nc" id="L243">        assertThat(historicVariable).isNotNull();</span>
<span class="nc" id="L244">        assertThat(historicVariable.getVariableName()).isEqualTo(&quot;number&quot;);</span>
<span class="nc" id="L245">        assertThat(historicVariable.getValue()).isEqualTo(&quot;two&quot;);</span>

<span class="nc" id="L247">        historicVariable = historyService.createHistoricVariableInstanceQuery().variableValueLikeIgnoreCase(&quot;number&quot;, &quot;TW2%&quot;).singleResult();</span>
<span class="nc" id="L248">        assertThat(historicVariable).isNull();</span>
<span class="nc" id="L249">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/history/oneTaskProcess.bpmn20.xml&quot; })
    public void testHistoricVariableInstanceQueryTaskVariables() {
<span class="nc" id="L254">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L255">        variables.put(&quot;variable&quot;, &quot;setFromProcess&quot;);</span>
<span class="nc" id="L256">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, variables);</span>

<span class="nc" id="L258">        assertThat(historyService.createHistoricVariableInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L260">        org.flowable.task.api.Task activeTask = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L261">        assertThat(activeTask).isNotNull();</span>
<span class="nc" id="L262">        taskService.setVariableLocal(activeTask.getId(), &quot;variable&quot;, &quot;setFromTask&quot;);</span>

        // Check if additional variable is available in history, task-local
<span class="nc" id="L265">        assertThat(historyService.createHistoricVariableInstanceQuery().count()).isEqualTo(2);</span>
<span class="nc" id="L266">        assertThat(historyService.createHistoricVariableInstanceQuery().taskId(activeTask.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L267">        assertThat(historyService.createHistoricVariableInstanceQuery().taskId(activeTask.getId()).singleResult().getValue()).isEqualTo(&quot;setFromTask&quot;);</span>
<span class="nc" id="L268">        assertThat(historyService.createHistoricVariableInstanceQuery().taskId(activeTask.getId()).singleResult().getTaskId()).isEqualTo(activeTask.getId());</span>
<span class="nc" id="L269">        assertThat(historyService.createHistoricVariableInstanceQuery().excludeTaskVariables().count()).isEqualTo(1);</span>

        // Test null task-id
<span class="nc" id="L272">        assertThatThrownBy(() -&gt; historyService.createHistoricVariableInstanceQuery().taskId(null).singleResult())</span>
<span class="nc" id="L273">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L274">                .hasMessage(&quot;taskId is null&quot;);</span>

        // Test invalid usage of taskId together with excludeTaskVariables
<span class="nc" id="L277">        assertThatThrownBy(() -&gt; historyService.createHistoricVariableInstanceQuery().taskId(&quot;123&quot;).excludeTaskVariables().singleResult())</span>
<span class="nc" id="L278">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L279">                .hasMessage(&quot;Cannot use taskId together with excludeTaskVariables&quot;);</span>

<span class="nc" id="L281">        assertThatThrownBy(() -&gt; historyService.createHistoricVariableInstanceQuery().excludeTaskVariables().taskId(&quot;123&quot;).singleResult())</span>
<span class="nc" id="L282">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L283">                .hasMessage(&quot;Cannot use taskId together with excludeTaskVariables&quot;);</span>
<span class="nc" id="L284">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/standalone/history/FullHistoryTest.testVariableUpdates.bpmn20.xml&quot;)
    public void testHistoricVariableInstanceQuery() {
<span class="nc" id="L289">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L290">        variables.put(&quot;process&quot;, &quot;one&quot;);</span>
<span class="nc" id="L291">        runtimeService.startProcessInstanceByKey(&quot;receiveTask&quot;, variables);</span>
<span class="nc" id="L292">        runtimeService.trigger(runtimeService.createExecutionQuery().activityId(&quot;waitState&quot;).singleResult().getId());</span>

<span class="nc" id="L294">        assertThat(historyService.createHistoricVariableInstanceQuery().variableName(&quot;process&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L295">        assertThat(historyService.createHistoricVariableInstanceQuery().variableValueEquals(&quot;process&quot;, &quot;one&quot;).count()).isEqualTo(1);</span>

<span class="nc" id="L297">        Map&lt;String, Object&gt; variables2 = new HashMap&lt;&gt;();</span>
<span class="nc" id="L298">        variables2.put(&quot;process&quot;, &quot;two&quot;);</span>
<span class="nc" id="L299">        runtimeService.startProcessInstanceByKey(&quot;receiveTask&quot;, variables2);</span>
<span class="nc" id="L300">        runtimeService.trigger(runtimeService.createExecutionQuery().activityId(&quot;waitState&quot;).singleResult().getId());</span>

<span class="nc" id="L302">        assertThat(historyService.createHistoricVariableInstanceQuery().variableName(&quot;process&quot;).count()).isEqualTo(2);</span>
<span class="nc" id="L303">        assertThat(historyService.createHistoricVariableInstanceQuery().variableValueEquals(&quot;process&quot;, &quot;one&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L304">        assertThat(historyService.createHistoricVariableInstanceQuery().variableValueEquals(&quot;process&quot;, &quot;two&quot;).count()).isEqualTo(1);</span>

<span class="nc" id="L306">        HistoricVariableInstance historicProcessVariable = historyService.createHistoricVariableInstanceQuery().variableValueEquals(&quot;process&quot;, &quot;one&quot;)</span>
<span class="nc" id="L307">                .singleResult();</span>
<span class="nc" id="L308">        assertThat(historicProcessVariable.getVariableName()).isEqualTo(&quot;process&quot;);</span>
<span class="nc" id="L309">        assertThat(historicProcessVariable.getValue()).isEqualTo(&quot;one&quot;);</span>

<span class="nc" id="L311">        Map&lt;String, Object&gt; variables3 = new HashMap&lt;&gt;();</span>
<span class="nc" id="L312">        variables3.put(&quot;long&quot;, 1000L);</span>
<span class="nc" id="L313">        variables3.put(&quot;double&quot;, 25.43d);</span>
<span class="nc" id="L314">        runtimeService.startProcessInstanceByKey(&quot;receiveTask&quot;, variables3);</span>
<span class="nc" id="L315">        runtimeService.trigger(runtimeService.createExecutionQuery().activityId(&quot;waitState&quot;).singleResult().getId());</span>

<span class="nc" id="L317">        assertThat(historyService.createHistoricVariableInstanceQuery().variableName(&quot;long&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L318">        assertThat(historyService.createHistoricVariableInstanceQuery().variableValueEquals(&quot;long&quot;, 1000L).count()).isEqualTo(1);</span>
<span class="nc" id="L319">        assertThat(historyService.createHistoricVariableInstanceQuery().variableName(&quot;double&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L320">        assertThat(historyService.createHistoricVariableInstanceQuery().variableValueEquals(&quot;double&quot;, 25.43d).count()).isEqualTo(1);</span>
<span class="nc" id="L321">    }</span>

    @Test
    @Deployment
    public void testHistoricVariableUpdatesAllTypes() throws Exception {

<span class="nc" id="L327">        SimpleDateFormat sdf = new SimpleDateFormat(&quot;dd/MM/yyyy hh:mm:ss SSS&quot;);</span>
<span class="nc" id="L328">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L329">        variables.put(&quot;aVariable&quot;, &quot;initial value&quot;);</span>

<span class="nc" id="L331">        Date startedDate = sdf.parse(&quot;01/01/2001 01:23:45 000&quot;);</span>

        // In the javaDelegate, the current time is manipulated
<span class="nc" id="L334">        Date updatedDate = sdf.parse(&quot;01/01/2001 01:23:46 000&quot;);</span>

<span class="nc" id="L336">        processEngineConfiguration.getClock().setCurrentTime(startedDate);</span>

<span class="nc" id="L338">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;HistoricVariableUpdateProcess&quot;, variables);</span>

<span class="nc" id="L340">        List&lt;HistoricDetail&gt; details = historyService.createHistoricDetailQuery().variableUpdates().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L341">                .orderByVariableName().asc().orderByTime().asc().list();</span>

        // 8 variable updates should be present, one performed when starting
        // process
        // the other 7 are set in VariableSetter serviceTask
<span class="nc" id="L346">        assertThat(details).hasSize(9);</span>

        // Since we order by varName, first entry should be aVariable update
        // from startTask
<span class="nc" id="L350">        HistoricVariableUpdate startVarUpdate = (HistoricVariableUpdate) details.get(0);</span>
<span class="nc" id="L351">        assertThat(startVarUpdate.getVariableName()).isEqualTo(&quot;aVariable&quot;);</span>
<span class="nc" id="L352">        assertThat(startVarUpdate.getValue()).isEqualTo(&quot;initial value&quot;);</span>
<span class="nc" id="L353">        assertThat(startVarUpdate.getRevision()).isZero();</span>
<span class="nc" id="L354">        assertThat(startVarUpdate.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
        // Date should the one set when starting
<span class="nc" id="L356">        assertThat(startVarUpdate.getTime()).isEqualTo(startedDate);</span>

<span class="nc" id="L358">        HistoricVariableUpdate updatedStringVariable = (HistoricVariableUpdate) details.get(1);</span>
<span class="nc" id="L359">        assertThat(updatedStringVariable.getVariableName()).isEqualTo(&quot;aVariable&quot;);</span>
<span class="nc" id="L360">        assertThat(updatedStringVariable.getValue()).isEqualTo(&quot;updated value&quot;);</span>
<span class="nc" id="L361">        assertThat(updatedStringVariable.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
        // Date should be the updated date
<span class="nc" id="L363">        assertThat(updatedStringVariable.getTime()).isEqualTo(updatedDate);</span>

<span class="nc" id="L365">        HistoricVariableUpdate intVariable = (HistoricVariableUpdate) details.get(2);</span>
<span class="nc" id="L366">        assertThat(intVariable.getVariableName()).isEqualTo(&quot;bVariable&quot;);</span>
<span class="nc" id="L367">        assertThat(intVariable.getValue()).isEqualTo(123);</span>
<span class="nc" id="L368">        assertThat(intVariable.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L369">        assertThat(intVariable.getTime()).isEqualTo(updatedDate);</span>

<span class="nc" id="L371">        HistoricVariableUpdate longVariable = (HistoricVariableUpdate) details.get(3);</span>
<span class="nc" id="L372">        assertThat(longVariable.getVariableName()).isEqualTo(&quot;cVariable&quot;);</span>
<span class="nc" id="L373">        assertThat(longVariable.getValue()).isEqualTo(12345L);</span>
<span class="nc" id="L374">        assertThat(longVariable.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L375">        assertThat(longVariable.getTime()).isEqualTo(updatedDate);</span>

<span class="nc" id="L377">        HistoricVariableUpdate doubleVariable = (HistoricVariableUpdate) details.get(4);</span>
<span class="nc" id="L378">        assertThat(doubleVariable.getVariableName()).isEqualTo(&quot;dVariable&quot;);</span>
<span class="nc" id="L379">        assertThat(doubleVariable.getValue()).isEqualTo(1234.567);</span>
<span class="nc" id="L380">        assertThat(doubleVariable.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L381">        assertThat(doubleVariable.getTime()).isEqualTo(updatedDate);</span>

<span class="nc" id="L383">        HistoricVariableUpdate shortVariable = (HistoricVariableUpdate) details.get(5);</span>
<span class="nc" id="L384">        assertThat(shortVariable.getVariableName()).isEqualTo(&quot;eVariable&quot;);</span>
<span class="nc" id="L385">        assertThat(shortVariable.getValue()).isEqualTo((short) 12);</span>
<span class="nc" id="L386">        assertThat(shortVariable.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L387">        assertThat(shortVariable.getTime()).isEqualTo(updatedDate);</span>

<span class="nc" id="L389">        HistoricVariableUpdate dateVariable = (HistoricVariableUpdate) details.get(6);</span>
<span class="nc" id="L390">        assertThat(dateVariable.getVariableName()).isEqualTo(&quot;fVariable&quot;);</span>
<span class="nc" id="L391">        assertThat(dateVariable.getValue()).isEqualTo(sdf.parse(&quot;01/01/2001 01:23:45 678&quot;));</span>
<span class="nc" id="L392">        assertThat(dateVariable.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L393">        assertThat(dateVariable.getTime()).isEqualTo(updatedDate);</span>

<span class="nc" id="L395">        HistoricVariableUpdate serializableVariable = (HistoricVariableUpdate) details.get(7);</span>
<span class="nc" id="L396">        assertThat(serializableVariable.getVariableName()).isEqualTo(&quot;gVariable&quot;);</span>
<span class="nc" id="L397">        assertThat(serializableVariable.getValue()).isEqualTo(new SerializableVariable(&quot;hello hello&quot;));</span>
<span class="nc" id="L398">        assertThat(serializableVariable.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L399">        assertThat(serializableVariable.getTime()).isEqualTo(updatedDate);</span>

<span class="nc" id="L401">        HistoricVariableUpdate byteArrayVariable = (HistoricVariableUpdate) details.get(8);</span>
<span class="nc" id="L402">        assertThat(byteArrayVariable.getVariableName()).isEqualTo(&quot;hVariable&quot;);</span>
<span class="nc" id="L403">        assertThat(new String((byte[]) byteArrayVariable.getValue())).isEqualTo(&quot;;-)&quot;);</span>
<span class="nc" id="L404">        assertThat(byteArrayVariable.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L405">        assertThat(byteArrayVariable.getTime()).isEqualTo(updatedDate);</span>

        // end process instance
<span class="nc" id="L408">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L409">        assertThat(tasks).hasSize(1);</span>
<span class="nc" id="L410">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L411">        assertProcessEnded(processInstance.getId());</span>

        // check for historic process variables set
<span class="nc" id="L414">        HistoricVariableInstanceQuery historicProcessVariableQuery = historyService.createHistoricVariableInstanceQuery().orderByVariableName().asc();</span>

<span class="nc" id="L416">        assertThat(historicProcessVariableQuery.count()).isEqualTo(8);</span>

<span class="nc" id="L418">        List&lt;HistoricVariableInstance&gt; historicVariables = historicProcessVariableQuery.list();</span>

        // Variable status when process is finished
<span class="nc" id="L421">        HistoricVariableInstance historicVariable = historicVariables.get(0);</span>
<span class="nc" id="L422">        assertThat(historicVariable.getVariableName()).isEqualTo(&quot;aVariable&quot;);</span>
<span class="nc" id="L423">        assertThat(historicVariable.getValue()).isEqualTo(&quot;updated value&quot;);</span>
<span class="nc" id="L424">        assertThat(historicVariable.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>

<span class="nc" id="L426">        historicVariable = historicVariables.get(1);</span>
<span class="nc" id="L427">        assertThat(historicVariable.getVariableName()).isEqualTo(&quot;bVariable&quot;);</span>
<span class="nc" id="L428">        assertThat(historicVariable.getValue()).isEqualTo(123);</span>
<span class="nc" id="L429">        assertThat(historicVariable.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>

<span class="nc" id="L431">        historicVariable = historicVariables.get(2);</span>
<span class="nc" id="L432">        assertThat(historicVariable.getVariableName()).isEqualTo(&quot;cVariable&quot;);</span>
<span class="nc" id="L433">        assertThat(historicVariable.getValue()).isEqualTo(12345L);</span>
<span class="nc" id="L434">        assertThat(historicVariable.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>

<span class="nc" id="L436">        historicVariable = historicVariables.get(3);</span>
<span class="nc" id="L437">        assertThat(historicVariable.getVariableName()).isEqualTo(&quot;dVariable&quot;);</span>
<span class="nc" id="L438">        assertThat(historicVariable.getValue()).isEqualTo(1234.567);</span>
<span class="nc" id="L439">        assertThat(historicVariable.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>

<span class="nc" id="L441">        historicVariable = historicVariables.get(4);</span>
<span class="nc" id="L442">        assertThat(historicVariable.getVariableName()).isEqualTo(&quot;eVariable&quot;);</span>
<span class="nc" id="L443">        assertThat(historicVariable.getValue()).isEqualTo((short) 12);</span>
<span class="nc" id="L444">        assertThat(historicVariable.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>

<span class="nc" id="L446">        historicVariable = historicVariables.get(5);</span>
<span class="nc" id="L447">        assertThat(historicVariable.getVariableName()).isEqualTo(&quot;fVariable&quot;);</span>
<span class="nc" id="L448">        assertThat(historicVariable.getValue()).isEqualTo(sdf.parse(&quot;01/01/2001 01:23:45 678&quot;));</span>
<span class="nc" id="L449">        assertThat(historicVariable.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>

<span class="nc" id="L451">        historicVariable = historicVariables.get(6);</span>
<span class="nc" id="L452">        assertThat(historicVariable.getVariableName()).isEqualTo(&quot;gVariable&quot;);</span>
<span class="nc" id="L453">        assertThat(historicVariable.getValue()).isEqualTo(new SerializableVariable(&quot;hello hello&quot;));</span>
<span class="nc" id="L454">        assertThat(historicVariable.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>

<span class="nc" id="L456">        historicVariable = historicVariables.get(7);</span>
<span class="nc" id="L457">        assertThat(historicVariable.getVariableName()).isEqualTo(&quot;hVariable&quot;);</span>
<span class="nc" id="L458">        assertThat(new String((byte[]) historicVariable.getValue())).as(&quot;;-)&quot;).isEqualTo(&quot;;-)&quot;);</span>
<span class="nc" id="L459">        assertThat(historicVariable.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L460">    }</span>

    @Test
    @Deployment
    public void testHistoricFormProperties() throws Exception {
<span class="nc" id="L465">        Date startedDate = new SimpleDateFormat(&quot;dd/MM/yyyy hh:mm:ss SSS&quot;).parse(&quot;01/01/2001 01:23:46 000&quot;);</span>

<span class="nc" id="L467">        processEngineConfiguration.getClock().setCurrentTime(startedDate);</span>

<span class="nc" id="L469">        Map&lt;String, String&gt; formProperties = new HashMap&lt;&gt;();</span>
<span class="nc" id="L470">        formProperties.put(&quot;formProp1&quot;, &quot;Activiti rocks&quot;);</span>
<span class="nc" id="L471">        formProperties.put(&quot;formProp2&quot;, &quot;12345&quot;);</span>

<span class="nc" id="L473">        ProcessDefinition procDef = repositoryService.createProcessDefinitionQuery().processDefinitionKey(&quot;historicFormPropertiesProcess&quot;).singleResult();</span>

<span class="nc" id="L475">        ProcessInstance processInstance = formService.submitStartFormData(procDef.getId(), formProperties);</span>

        // Submit form-properties on the created task
<span class="nc" id="L478">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L479">        assertThat(task).isNotNull();</span>

        // Out execution only has a single activity waiting, the task
<span class="nc" id="L482">        List&lt;String&gt; activityIds = runtimeService.getActiveActivityIds(task.getExecutionId());</span>
<span class="nc" id="L483">        assertThat(activityIds).hasSize(1);</span>

<span class="nc" id="L485">        String taskActivityId = activityIds.get(0);</span>

        // Submit form properties
<span class="nc" id="L488">        formProperties = new HashMap&lt;&gt;();</span>
<span class="nc" id="L489">        formProperties.put(&quot;formProp3&quot;, &quot;Activiti still rocks!!!&quot;);</span>
<span class="nc" id="L490">        formProperties.put(&quot;formProp4&quot;, &quot;54321&quot;);</span>
<span class="nc" id="L491">        formService.submitTaskFormData(task.getId(), formProperties);</span>

        // 4 historic form properties should be created. 2 when process started,
        // 2 when task completed
<span class="nc" id="L495">        List&lt;HistoricDetail&gt; props = historyService.createHistoricDetailQuery().formProperties().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L496">                .orderByFormPropertyId().asc().list();</span>

<span class="nc" id="L498">        HistoricFormProperty historicProperty1 = (HistoricFormProperty) props.get(0);</span>
<span class="nc" id="L499">        assertThat(historicProperty1.getPropertyId()).isEqualTo(&quot;formProp1&quot;);</span>
<span class="nc" id="L500">        assertThat(historicProperty1.getPropertyValue()).isEqualTo(&quot;Activiti rocks&quot;);</span>
<span class="nc" id="L501">        assertThat(historicProperty1.getTime()).isEqualTo(startedDate);</span>
<span class="nc" id="L502">        assertThat(historicProperty1.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L503">        assertThat(historicProperty1.getTaskId()).isNull();</span>

<span class="nc" id="L505">        assertThat(historicProperty1.getActivityInstanceId()).isNotNull();</span>
<span class="nc" id="L506">        HistoricActivityInstance historicActivityInstance = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L507">                .activityInstanceId(historicProperty1.getActivityInstanceId()).singleResult();</span>
<span class="nc" id="L508">        assertThat(historicActivityInstance).isNotNull();</span>
<span class="nc" id="L509">        assertThat(historicActivityInstance.getActivityId()).isEqualTo(&quot;start&quot;);</span>

<span class="nc" id="L511">        HistoricFormProperty historicProperty2 = (HistoricFormProperty) props.get(1);</span>
<span class="nc" id="L512">        assertThat(historicProperty2.getPropertyId()).isEqualTo(&quot;formProp2&quot;);</span>
<span class="nc" id="L513">        assertThat(historicProperty2.getPropertyValue()).isEqualTo(&quot;12345&quot;);</span>
<span class="nc" id="L514">        assertThat(historicProperty2.getTime()).isEqualTo(startedDate);</span>
<span class="nc" id="L515">        assertThat(historicProperty2.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L516">        assertThat(historicProperty2.getTaskId()).isNull();</span>

<span class="nc" id="L518">        assertThat(historicProperty2.getActivityInstanceId()).isNotNull();</span>
<span class="nc" id="L519">        historicActivityInstance = historyService.createHistoricActivityInstanceQuery().activityInstanceId(historicProperty2.getActivityInstanceId())</span>
<span class="nc" id="L520">                .singleResult();</span>
<span class="nc" id="L521">        assertThat(historicActivityInstance).isNotNull();</span>
<span class="nc" id="L522">        assertThat(historicActivityInstance.getActivityId()).isEqualTo(&quot;start&quot;);</span>

<span class="nc" id="L524">        HistoricFormProperty historicProperty3 = (HistoricFormProperty) props.get(2);</span>
<span class="nc" id="L525">        assertThat(historicProperty3.getPropertyId()).isEqualTo(&quot;formProp3&quot;);</span>
<span class="nc" id="L526">        assertThat(historicProperty3.getPropertyValue()).isEqualTo(&quot;Activiti still rocks!!!&quot;);</span>
<span class="nc" id="L527">        assertThat(historicProperty3.getTime()).isEqualTo(startedDate);</span>
<span class="nc" id="L528">        assertThat(historicProperty3.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L529">        String activityInstanceId = historicProperty3.getActivityInstanceId();</span>
<span class="nc" id="L530">        historicActivityInstance = historyService.createHistoricActivityInstanceQuery().activityInstanceId(activityInstanceId).singleResult();</span>
<span class="nc" id="L531">        assertThat(historicActivityInstance).isNotNull();</span>
<span class="nc" id="L532">        assertThat(historicActivityInstance.getActivityId()).isEqualTo(taskActivityId);</span>
<span class="nc" id="L533">        assertThat(historicProperty3.getTaskId()).isNotNull();</span>

<span class="nc" id="L535">        HistoricFormProperty historicProperty4 = (HistoricFormProperty) props.get(3);</span>
<span class="nc" id="L536">        assertThat(historicProperty4.getPropertyId()).isEqualTo(&quot;formProp4&quot;);</span>
<span class="nc" id="L537">        assertThat(historicProperty4.getPropertyValue()).isEqualTo(&quot;54321&quot;);</span>
<span class="nc" id="L538">        assertThat(historicProperty4.getTime()).isEqualTo(startedDate);</span>
<span class="nc" id="L539">        assertThat(historicProperty4.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L540">        activityInstanceId = historicProperty4.getActivityInstanceId();</span>
<span class="nc" id="L541">        historicActivityInstance = historyService.createHistoricActivityInstanceQuery().activityInstanceId(activityInstanceId).singleResult();</span>
<span class="nc" id="L542">        assertThat(historicActivityInstance).isNotNull();</span>
<span class="nc" id="L543">        assertThat(historicActivityInstance.getActivityId()).isEqualTo(taskActivityId);</span>
<span class="nc" id="L544">        assertThat(historicProperty4.getTaskId()).isNotNull();</span>

<span class="nc" id="L546">        assertThat(props).hasSize(4);</span>
<span class="nc" id="L547">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/history/oneTaskProcess.bpmn20.xml&quot; })
    public void testHistoricVariableQuery() throws Exception {
<span class="nc" id="L552">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L553">        variables.put(&quot;stringVar&quot;, &quot;activiti rocks!&quot;);</span>
<span class="nc" id="L554">        variables.put(&quot;longVar&quot;, 12345L);</span>

<span class="nc" id="L556">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, variables);</span>

        // Query on activity-instance, activity instance null will return all
        // vars set when starting process
<span class="nc" id="L560">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().activityInstanceId(null).count()).isEqualTo(2);</span>
<span class="nc" id="L561">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().activityInstanceId(&quot;unexisting&quot;).count()).isZero();</span>

        // Query on process-instance
<span class="nc" id="L564">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().processInstanceId(processInstance.getId()).count()).isEqualTo(2);</span>
<span class="nc" id="L565">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().processInstanceId(&quot;unexisting&quot;).count()).isZero();</span>

        // Query both process-instance and activity-instance
<span class="nc" id="L568">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().activityInstanceId(null).processInstanceId(processInstance.getId()).count())</span>
<span class="nc" id="L569">                .isEqualTo(2);</span>

        // end process instance
<span class="nc" id="L572">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L573">        assertThat(tasks).hasSize(1);</span>
<span class="nc" id="L574">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L575">        assertProcessEnded(processInstance.getId());</span>

<span class="nc" id="L577">        assertThat(historyService.createHistoricVariableInstanceQuery().count()).isEqualTo(2);</span>

        // Query on process-instance
<span class="nc" id="L580">        assertThat(historyService.createHistoricVariableInstanceQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(2);</span>
<span class="nc" id="L581">        assertThat(historyService.createHistoricVariableInstanceQuery().processInstanceId(&quot;unexisting&quot;).count()).isZero();</span>
<span class="nc" id="L582">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/history/oneTaskProcess.bpmn20.xml&quot; })
    public void testHistoricVariableQueryExcludeTaskRelatedDetails() throws Exception {
<span class="nc" id="L587">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L588">        variables.put(&quot;stringVar&quot;, &quot;activiti rocks!&quot;);</span>
<span class="nc" id="L589">        variables.put(&quot;longVar&quot;, 12345L);</span>

<span class="nc" id="L591">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, variables);</span>

        // Set a local task-variable
<span class="nc" id="L594">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L595">        assertThat(task).isNotNull();</span>
<span class="nc" id="L596">        taskService.setVariableLocal(task.getId(), &quot;taskVar&quot;, &quot;It is I, le Variable&quot;);</span>

        // Query on process-instance
<span class="nc" id="L599">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().processInstanceId(processInstance.getId()).count()).isEqualTo(3);</span>

        // Query on process-instance, excluding task-details
<span class="nc" id="L602">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().processInstanceId(processInstance.getId()).excludeTaskDetails().count())</span>
<span class="nc" id="L603">                .isEqualTo(2);</span>

        // Check task-id precedence on excluding task-details
<span class="nc" id="L606">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().processInstanceId(processInstance.getId()).excludeTaskDetails()</span>
<span class="nc" id="L607">                .taskId(task.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L608">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/history/oneTaskProcess.bpmn20.xml&quot; })
    public void testHistoricFormPropertiesQuery() throws Exception {
<span class="nc" id="L613">        Map&lt;String, String&gt; formProperties = new HashMap&lt;&gt;();</span>
<span class="nc" id="L614">        formProperties.put(&quot;stringVar&quot;, &quot;activiti rocks!&quot;);</span>
<span class="nc" id="L615">        formProperties.put(&quot;longVar&quot;, &quot;12345&quot;);</span>

<span class="nc" id="L617">        ProcessDefinition procDef = repositoryService.createProcessDefinitionQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).singleResult();</span>
<span class="nc" id="L618">        ProcessInstance processInstance = formService.submitStartFormData(procDef.getId(), formProperties);</span>

        // Query on activity-instance, activity instance null will return all
        // vars set when starting process
<span class="nc" id="L622">        assertThat(historyService.createHistoricDetailQuery().formProperties().activityInstanceId(null).count()).isEqualTo(2);</span>
<span class="nc" id="L623">        assertThat(historyService.createHistoricDetailQuery().formProperties().activityInstanceId(&quot;unexisting&quot;).count()).isZero();</span>

        // Query on process-instance
<span class="nc" id="L626">        assertThat(historyService.createHistoricDetailQuery().formProperties().processInstanceId(processInstance.getId()).count()).isEqualTo(2);</span>
<span class="nc" id="L627">        assertThat(historyService.createHistoricDetailQuery().formProperties().processInstanceId(&quot;unexisting&quot;).count()).isZero();</span>

        // Complete the task by submitting the task properties
<span class="nc" id="L630">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L631">        formProperties = new HashMap&lt;&gt;();</span>
<span class="nc" id="L632">        formProperties.put(&quot;taskVar&quot;, &quot;task form property&quot;);</span>
<span class="nc" id="L633">        formService.submitTaskFormData(task.getId(), formProperties);</span>

<span class="nc" id="L635">        assertThat(historyService.createHistoricDetailQuery().formProperties().processInstanceId(processInstance.getId()).count()).isEqualTo(3);</span>
<span class="nc" id="L636">        assertThat(historyService.createHistoricDetailQuery().formProperties().processInstanceId(&quot;unexisting&quot;).count()).isZero();</span>
<span class="nc" id="L637">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/history/oneTaskProcess.bpmn20.xml&quot; })
    public void testHistoricVariableQuerySorting() throws Exception {
<span class="nc" id="L642">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L643">        variables.put(&quot;stringVar&quot;, &quot;activiti rocks!&quot;);</span>
<span class="nc" id="L644">        variables.put(&quot;longVar&quot;, 12345L);</span>

<span class="nc" id="L646">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, variables);</span>

<span class="nc" id="L648">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().orderByProcessInstanceId().asc().count()).isEqualTo(2);</span>
<span class="nc" id="L649">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().orderByTime().asc().count()).isEqualTo(2);</span>
<span class="nc" id="L650">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().orderByVariableName().asc().count()).isEqualTo(2);</span>
<span class="nc" id="L651">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().orderByVariableRevision().asc().count()).isEqualTo(2);</span>
<span class="nc" id="L652">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().orderByVariableType().asc().count()).isEqualTo(2);</span>

<span class="nc" id="L654">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().orderByProcessInstanceId().desc().count()).isEqualTo(2);</span>
<span class="nc" id="L655">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().orderByTime().desc().count()).isEqualTo(2);</span>
<span class="nc" id="L656">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().orderByVariableName().desc().count()).isEqualTo(2);</span>
<span class="nc" id="L657">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().orderByVariableRevision().desc().count()).isEqualTo(2);</span>
<span class="nc" id="L658">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().orderByVariableType().desc().count()).isEqualTo(2);</span>

<span class="nc" id="L660">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().orderByProcessInstanceId().asc().list()).hasSize(2);</span>
<span class="nc" id="L661">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().orderByTime().asc().list()).hasSize(2);</span>
<span class="nc" id="L662">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().orderByVariableName().asc().list()).hasSize(2);</span>
<span class="nc" id="L663">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().orderByVariableRevision().asc().list()).hasSize(2);</span>
<span class="nc" id="L664">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().orderByVariableType().asc().list()).hasSize(2);</span>

<span class="nc" id="L666">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().orderByProcessInstanceId().desc().list()).hasSize(2);</span>
<span class="nc" id="L667">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().orderByTime().desc().list()).hasSize(2);</span>
<span class="nc" id="L668">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().orderByVariableName().desc().list()).hasSize(2);</span>
<span class="nc" id="L669">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().orderByVariableRevision().desc().list()).hasSize(2);</span>
<span class="nc" id="L670">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().orderByVariableType().desc().list()).hasSize(2);</span>
<span class="nc" id="L671">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/history/oneTaskProcess.bpmn20.xml&quot; })
    public void testHistoricFormPropertySorting() throws Exception {

<span class="nc" id="L677">        Map&lt;String, String&gt; formProperties = new HashMap&lt;&gt;();</span>
<span class="nc" id="L678">        formProperties.put(&quot;stringVar&quot;, &quot;activiti rocks!&quot;);</span>
<span class="nc" id="L679">        formProperties.put(&quot;longVar&quot;, &quot;12345&quot;);</span>

<span class="nc" id="L681">        ProcessDefinition procDef = repositoryService.createProcessDefinitionQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).singleResult();</span>
<span class="nc" id="L682">        formService.submitStartFormData(procDef.getId(), formProperties);</span>

<span class="nc" id="L684">        assertThat(historyService.createHistoricDetailQuery().formProperties().orderByProcessInstanceId().asc().count()).isEqualTo(2);</span>
<span class="nc" id="L685">        assertThat(historyService.createHistoricDetailQuery().formProperties().orderByTime().asc().count()).isEqualTo(2);</span>
<span class="nc" id="L686">        assertThat(historyService.createHistoricDetailQuery().formProperties().orderByFormPropertyId().asc().count()).isEqualTo(2);</span>

<span class="nc" id="L688">        assertThat(historyService.createHistoricDetailQuery().formProperties().orderByProcessInstanceId().desc().count()).isEqualTo(2);</span>
<span class="nc" id="L689">        assertThat(historyService.createHistoricDetailQuery().formProperties().orderByTime().desc().count()).isEqualTo(2);</span>
<span class="nc" id="L690">        assertThat(historyService.createHistoricDetailQuery().formProperties().orderByFormPropertyId().desc().count()).isEqualTo(2);</span>

<span class="nc" id="L692">        assertThat(historyService.createHistoricDetailQuery().formProperties().orderByProcessInstanceId().asc().list()).hasSize(2);</span>
<span class="nc" id="L693">        assertThat(historyService.createHistoricDetailQuery().formProperties().orderByTime().asc().list()).hasSize(2);</span>
<span class="nc" id="L694">        assertThat(historyService.createHistoricDetailQuery().formProperties().orderByFormPropertyId().asc().list()).hasSize(2);</span>

<span class="nc" id="L696">        assertThat(historyService.createHistoricDetailQuery().formProperties().orderByProcessInstanceId().desc().list()).hasSize(2);</span>
<span class="nc" id="L697">        assertThat(historyService.createHistoricDetailQuery().formProperties().orderByTime().desc().list()).hasSize(2);</span>
<span class="nc" id="L698">        assertThat(historyService.createHistoricDetailQuery().formProperties().orderByFormPropertyId().desc().list()).hasSize(2);</span>
<span class="nc" id="L699">    }</span>

    @Test
    @Deployment
    public void testHistoricDetailQueryMixed() throws Exception {

<span class="nc" id="L705">        Map&lt;String, String&gt; formProperties = new HashMap&lt;&gt;();</span>
<span class="nc" id="L706">        formProperties.put(&quot;formProp1&quot;, &quot;activiti rocks!&quot;);</span>
<span class="nc" id="L707">        formProperties.put(&quot;formProp2&quot;, &quot;12345&quot;);</span>

<span class="nc" id="L709">        ProcessDefinition procDef = repositoryService.createProcessDefinitionQuery().processDefinitionKey(&quot;historicDetailMixed&quot;).singleResult();</span>
<span class="nc" id="L710">        ProcessInstance processInstance = formService.submitStartFormData(procDef.getId(), formProperties);</span>

<span class="nc" id="L712">        List&lt;HistoricDetail&gt; details = historyService.createHistoricDetailQuery().processInstanceId(processInstance.getId()).orderByVariableName().asc().list();</span>

<span class="nc" id="L714">        assertThat(details).hasSize(4);</span>

<span class="nc" id="L716">        assertThat(details.get(0)).isInstanceOf(HistoricFormProperty.class);</span>
<span class="nc" id="L717">        HistoricFormProperty formProp1 = (HistoricFormProperty) details.get(0);</span>
<span class="nc" id="L718">        assertThat(formProp1.getPropertyId()).isEqualTo(&quot;formProp1&quot;);</span>
<span class="nc" id="L719">        assertThat(formProp1.getPropertyValue()).isEqualTo(&quot;activiti rocks!&quot;);</span>

<span class="nc" id="L721">        assertThat(details.get(1)).isInstanceOf(HistoricFormProperty.class);</span>
<span class="nc" id="L722">        HistoricFormProperty formProp2 = (HistoricFormProperty) details.get(1);</span>
<span class="nc" id="L723">        assertThat(formProp2.getPropertyId()).isEqualTo(&quot;formProp2&quot;);</span>
<span class="nc" id="L724">        assertThat(formProp2.getPropertyValue()).isEqualTo(&quot;12345&quot;);</span>

<span class="nc" id="L726">        assertThat(details.get(2)).isInstanceOf(HistoricVariableUpdate.class);</span>
<span class="nc" id="L727">        HistoricVariableUpdate varUpdate1 = (HistoricVariableUpdate) details.get(2);</span>
<span class="nc" id="L728">        assertThat(varUpdate1.getVariableName()).isEqualTo(&quot;variable1&quot;);</span>
<span class="nc" id="L729">        assertThat(varUpdate1.getValue()).isEqualTo(&quot;activiti rocks!&quot;);</span>

        // This variable should be of type LONG since this is defined in the
        // process-definition
<span class="nc" id="L733">        assertThat(details.get(3)).isInstanceOf(HistoricVariableUpdate.class);</span>
<span class="nc" id="L734">        HistoricVariableUpdate varUpdate2 = (HistoricVariableUpdate) details.get(3);</span>
<span class="nc" id="L735">        assertThat(varUpdate2.getVariableName()).isEqualTo(&quot;variable2&quot;);</span>
<span class="nc" id="L736">        assertThat(varUpdate2.getValue()).isEqualTo(12345L);</span>
<span class="nc" id="L737">    }</span>

    @Test
    public void testHistoricDetailQueryInvalidSorting() throws Exception {

<span class="nc" id="L742">        assertThatThrownBy(() -&gt; historyService.createHistoricDetailQuery().asc().list())</span>
<span class="nc" id="L743">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>

<span class="nc" id="L745">        assertThatThrownBy(() -&gt; historyService.createHistoricDetailQuery().desc().list())</span>
<span class="nc" id="L746">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>

<span class="nc" id="L748">        assertThatThrownBy(() -&gt; historyService.createHistoricDetailQuery().orderByProcessInstanceId().list())</span>
<span class="nc" id="L749">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>

<span class="nc" id="L751">        assertThatThrownBy(() -&gt; historyService.createHistoricDetailQuery().orderByTime().list())</span>
<span class="nc" id="L752">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>

<span class="nc" id="L754">        assertThatThrownBy(() -&gt; historyService.createHistoricDetailQuery().orderByVariableName().list())</span>
<span class="nc" id="L755">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>

<span class="nc" id="L757">        assertThatThrownBy(() -&gt; historyService.createHistoricDetailQuery().orderByVariableRevision().list())</span>
<span class="nc" id="L758">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>

<span class="nc" id="L760">        assertThatThrownBy(() -&gt; historyService.createHistoricDetailQuery().orderByVariableType().list())</span>
<span class="nc" id="L761">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L762">    }</span>

    @Test
    @Deployment
    public void testHistoricTaskInstanceVariableUpdates() {
<span class="nc" id="L767">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;HistoricTaskInstanceTest&quot;).getId();</span>

<span class="nc" id="L769">        String taskId = taskService.createTaskQuery().singleResult().getId();</span>

<span class="nc" id="L771">        runtimeService.setVariable(processInstanceId, &quot;deadline&quot;, &quot;yesterday&quot;);</span>

<span class="nc" id="L773">        taskService.setVariableLocal(taskId, &quot;bucket&quot;, &quot;23c&quot;);</span>
<span class="nc" id="L774">        taskService.setVariableLocal(taskId, &quot;mop&quot;, &quot;37i&quot;);</span>

<span class="nc" id="L776">        taskService.complete(taskId);</span>

<span class="nc" id="L778">        assertThat(historyService.createHistoricTaskInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L780">        List&lt;HistoricDetail&gt; historicTaskVariableUpdates = historyService.createHistoricDetailQuery().taskId(taskId).variableUpdates().orderByVariableName()</span>
<span class="nc" id="L781">                .asc().list();</span>

<span class="nc" id="L783">        assertThat(historicTaskVariableUpdates).hasSize(2);</span>

<span class="nc" id="L785">        historyService.deleteHistoricTaskInstance(taskId);</span>

        // Check if the variable updates have been removed as well
<span class="nc" id="L788">        historicTaskVariableUpdates = historyService.createHistoricDetailQuery().taskId(taskId).variableUpdates().orderByVariableName().asc().list();</span>

<span class="nc" id="L790">        assertThat(historicTaskVariableUpdates).isEmpty();</span>

<span class="nc" id="L792">        managementService.executeCommand(commandContext -&gt; {</span>
<span class="nc" id="L793">            processEngineConfiguration.getTaskServiceConfiguration().getHistoricTaskService().deleteHistoricTaskLogEntriesForTaskId(taskId);</span>
<span class="nc" id="L794">            return null;</span>
        });
<span class="nc" id="L796">    }</span>

    // ACT-592
    @Test
    @Deployment
    public void testSetVariableOnProcessInstanceWithTimer() {
<span class="nc" id="L802">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;timerVariablesProcess&quot;);</span>
<span class="nc" id="L803">        runtimeService.setVariable(processInstance.getId(), &quot;myVar&quot;, 123456L);</span>
<span class="nc" id="L804">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;myVar&quot;)).isEqualTo(123456L);</span>
<span class="nc" id="L805">    }</span>

    @Test
    @Deployment
    public void testDeleteHistoricProcessInstance() {
        // Start process-instance with some variables set
<span class="nc" id="L811">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L812">        vars.put(&quot;processVar&quot;, 123L);</span>
<span class="nc" id="L813">        vars.put(&quot;anotherProcessVar&quot;, new DummySerializable());</span>

<span class="nc" id="L815">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;HistoricTaskInstanceTest&quot;, vars);</span>
<span class="nc" id="L816">        assertThat(processInstance).isNotNull();</span>

        // Set 2 task properties
<span class="nc" id="L819">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L820">        taskService.setVariableLocal(task.getId(), &quot;taskVar&quot;, 45678);</span>
<span class="nc" id="L821">        taskService.setVariableLocal(task.getId(), &quot;anotherTaskVar&quot;, &quot;value&quot;);</span>

        // Finish the task, this end the process-instance
<span class="nc" id="L824">        taskService.complete(task.getId());</span>

<span class="nc" id="L826">        assertThat(historyService.createHistoricProcessInstanceQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L827">        assertThat(historyService.createHistoricActivityInstanceQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(5);</span>
<span class="nc" id="L828">        assertThat(historyService.createHistoricVariableInstanceQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(4);</span>
<span class="nc" id="L829">        assertThat(historyService.createHistoricDetailQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(4);</span>
<span class="nc" id="L830">        assertThat(historyService.createHistoricTaskInstanceQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(1);</span>

        // Delete the historic process-instance
<span class="nc" id="L833">        historyService.deleteHistoricProcessInstance(processInstance.getId());</span>

        // Verify no traces are left in the history tables
<span class="nc" id="L836">        assertThat(historyService.createHistoricProcessInstanceQuery().processInstanceId(processInstance.getId()).count()).isZero();</span>
<span class="nc" id="L837">        assertThat(historyService.createHistoricActivityInstanceQuery().processInstanceId(processInstance.getId()).count()).isZero();</span>
<span class="nc" id="L838">        assertThat(historyService.createHistoricVariableInstanceQuery().processInstanceId(processInstance.getId()).count()).isZero();</span>
<span class="nc" id="L839">        assertThat(historyService.createHistoricDetailQuery().processInstanceId(processInstance.getId()).count()).isZero();</span>
<span class="nc" id="L840">        assertThat(historyService.createHistoricTaskInstanceQuery().processInstanceId(processInstance.getId()).count()).isZero();</span>

<span class="nc" id="L842">        assertThatThrownBy(() -&gt; historyService.deleteHistoricProcessInstance(&quot;unexisting&quot;))</span>
<span class="nc" id="L843">                .isExactlyInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L844">                .hasMessage(&quot;No historic process instance found with id: unexisting&quot;);</span>
<span class="nc" id="L845">    }</span>

    @Test
    @Deployment
    public void testDeleteRunningHistoricProcessInstance() {
<span class="nc" id="L850">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;HistoricTaskInstanceTest&quot;);</span>
<span class="nc" id="L851">        assertThat(processInstance).isNotNull();</span>

        // Delete the historic process-instance, which is still running
<span class="nc" id="L854">        assertThatThrownBy(() -&gt; historyService.deleteHistoricProcessInstance(processInstance.getId()))</span>
<span class="nc" id="L855">                .isExactlyInstanceOf(FlowableException.class)</span>
<span class="nc" id="L856">                .hasMessageStartingWith(&quot;Process instance is still running, cannot delete HistoricProcessInstanceEntity&quot;)</span>
<span class="nc" id="L857">                .hasMessageContaining(&quot;definition=&quot; + processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L858">    }</span>

    /**
     * Test created to validate ACT-621 fix.
     */
    @Test
    @Deployment
    public void testHistoricFormPropertiesOnReEnteringActivity() {
<span class="nc" id="L866">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L867">        variables.put(&quot;comeBack&quot;, Boolean.TRUE);</span>

<span class="nc" id="L869">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;HistoricFormPropertiesProcess&quot;, variables);</span>
<span class="nc" id="L870">        assertThat(processInstance).isNotNull();</span>

        // Submit form on task
<span class="nc" id="L873">        Map&lt;String, String&gt; data = new HashMap&lt;&gt;();</span>
<span class="nc" id="L874">        data.put(&quot;formProp1&quot;, &quot;Property value&quot;);</span>

<span class="nc" id="L876">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L877">        formService.submitTaskFormData(task.getId(), data);</span>

        // Historic property should be available
<span class="nc" id="L880">        List&lt;HistoricDetail&gt; details = historyService.createHistoricDetailQuery().formProperties().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L881">        assertThat(details).hasSize(1);</span>

        // org.flowable.task.service.Task should be active in the same activity as the previous one
<span class="nc" id="L884">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L885">        formService.submitTaskFormData(task.getId(), data);</span>

<span class="nc" id="L887">        details = historyService.createHistoricDetailQuery().formProperties().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L888">        assertThat(details).hasSize(2);</span>

        // Should have 2 different historic activity instance ID's, with the
        // same activityId
<span class="nc" id="L892">        assertThat(details.get(1).getActivityInstanceId()).isNotSameAs(details.get(0).getActivityInstanceId());</span>

<span class="nc" id="L894">        HistoricActivityInstance historicActInst1 = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L895">                .activityInstanceId(details.get(0).getActivityInstanceId()).singleResult();</span>
<span class="nc" id="L896">        assertActivityInstancesAreSame(historicActInst1,</span>
<span class="nc" id="L897">                runtimeService.createActivityInstanceQuery().activityInstanceId(historicActInst1.getId()).singleResult());</span>

<span class="nc" id="L899">        HistoricActivityInstance historicActInst2 = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L900">                .activityInstanceId(details.get(1).getActivityInstanceId()).singleResult();</span>
<span class="nc" id="L901">        assertActivityInstancesAreSame(historicActInst2,</span>
<span class="nc" id="L902">                runtimeService.createActivityInstanceQuery().activityInstanceId(historicActInst2.getId()).singleResult());</span>

<span class="nc" id="L904">        assertThat(historicActInst2.getActivityId()).isEqualTo(historicActInst1.getActivityId());</span>
<span class="nc" id="L905">    }</span>

    @Test
    @Deployment
    public void testHistoricTaskInstanceQueryTaskVariableValueEquals() throws Exception {
<span class="nc" id="L910">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;HistoricTaskInstanceTest&quot;);</span>
<span class="nc" id="L911">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

        // Set some variables on the task
<span class="nc" id="L914">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L915">        variables.put(&quot;longVar&quot;, 12345L);</span>
<span class="nc" id="L916">        variables.put(&quot;shortVar&quot;, (short) 123);</span>
<span class="nc" id="L917">        variables.put(&quot;integerVar&quot;, 1234);</span>
<span class="nc" id="L918">        variables.put(&quot;stringVar&quot;, &quot;stringValue&quot;);</span>
<span class="nc" id="L919">        variables.put(&quot;booleanVar&quot;, true);</span>
<span class="nc" id="L920">        Date date = Calendar.getInstance().getTime();</span>
<span class="nc" id="L921">        variables.put(&quot;dateVar&quot;, date);</span>
<span class="nc" id="L922">        variables.put(&quot;nullVar&quot;, null);</span>

<span class="nc" id="L924">        taskService.setVariablesLocal(task.getId(), variables);</span>

        // Validate all variable-updates are present in DB
<span class="nc" id="L927">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().taskId(task.getId()).count()).isEqualTo(7);</span>

        // Query Historic task instances based on variable
<span class="nc" id="L930">        assertThat(historyService.createHistoricTaskInstanceQuery().taskVariableValueEquals(&quot;longVar&quot;, 12345L).count()).isEqualTo(1);</span>
<span class="nc" id="L931">        assertThat(historyService.createHistoricTaskInstanceQuery().taskVariableValueEquals(&quot;shortVar&quot;, (short) 123).count()).isEqualTo(1);</span>
<span class="nc" id="L932">        assertThat(historyService.createHistoricTaskInstanceQuery().taskVariableValueEquals(&quot;integerVar&quot;, 1234).count()).isEqualTo(1);</span>
<span class="nc" id="L933">        assertThat(historyService.createHistoricTaskInstanceQuery().taskVariableValueEquals(&quot;stringVar&quot;, &quot;stringValue&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L934">        assertThat(historyService.createHistoricTaskInstanceQuery().taskVariableValueEquals(&quot;booleanVar&quot;, true).count()).isEqualTo(1);</span>
<span class="nc" id="L935">        assertThat(historyService.createHistoricTaskInstanceQuery().taskVariableValueEquals(&quot;dateVar&quot;, date).count()).isEqualTo(1);</span>
<span class="nc" id="L936">        assertThat(historyService.createHistoricTaskInstanceQuery().taskVariableValueEquals(&quot;nullVar&quot;, null).count()).isEqualTo(1);</span>

        // Update the variables
<span class="nc" id="L939">        variables.put(&quot;longVar&quot;, 67890L);</span>
<span class="nc" id="L940">        variables.put(&quot;shortVar&quot;, (short) 456);</span>
<span class="nc" id="L941">        variables.put(&quot;integerVar&quot;, 5678);</span>
<span class="nc" id="L942">        variables.put(&quot;stringVar&quot;, &quot;updatedStringValue&quot;);</span>
<span class="nc" id="L943">        variables.put(&quot;booleanVar&quot;, false);</span>
<span class="nc" id="L944">        Calendar otherCal = Calendar.getInstance();</span>
<span class="nc" id="L945">        otherCal.add(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L946">        Date otherDate = otherCal.getTime();</span>
<span class="nc" id="L947">        variables.put(&quot;dateVar&quot;, otherDate);</span>
<span class="nc" id="L948">        variables.put(&quot;nullVar&quot;, null);</span>

<span class="nc" id="L950">        taskService.setVariablesLocal(task.getId(), variables);</span>

        // Validate all variable-updates are present in DB
<span class="nc" id="L953">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().taskId(task.getId()).count()).isEqualTo(14);</span>

        // Previous values should NOT match
<span class="nc" id="L956">        assertThat(historyService.createHistoricTaskInstanceQuery().taskVariableValueEquals(&quot;longVar&quot;, 12345L).count()).isZero();</span>
<span class="nc" id="L957">        assertThat(historyService.createHistoricTaskInstanceQuery().taskVariableValueEquals(&quot;shortVar&quot;, (short) 123).count()).isZero();</span>
<span class="nc" id="L958">        assertThat(historyService.createHistoricTaskInstanceQuery().taskVariableValueEquals(&quot;integerVar&quot;, 1234).count()).isZero();</span>
<span class="nc" id="L959">        assertThat(historyService.createHistoricTaskInstanceQuery().taskVariableValueEquals(&quot;stringVar&quot;, &quot;stringValue&quot;).count()).isZero();</span>
<span class="nc" id="L960">        assertThat(historyService.createHistoricTaskInstanceQuery().taskVariableValueEquals(&quot;booleanVar&quot;, true).count()).isZero();</span>
<span class="nc" id="L961">        assertThat(historyService.createHistoricTaskInstanceQuery().taskVariableValueEquals(&quot;dateVar&quot;, date).count()).isZero();</span>

        // New values should match
<span class="nc" id="L964">        assertThat(historyService.createHistoricTaskInstanceQuery().taskVariableValueEquals(&quot;longVar&quot;, 67890L).count()).isEqualTo(1);</span>
<span class="nc" id="L965">        assertThat(historyService.createHistoricTaskInstanceQuery().taskVariableValueEquals(&quot;shortVar&quot;, (short) 456).count()).isEqualTo(1);</span>
<span class="nc" id="L966">        assertThat(historyService.createHistoricTaskInstanceQuery().taskVariableValueEquals(&quot;integerVar&quot;, 5678).count()).isEqualTo(1);</span>
<span class="nc" id="L967">        assertThat(historyService.createHistoricTaskInstanceQuery().taskVariableValueEquals(&quot;stringVar&quot;, &quot;updatedStringValue&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L968">        assertThat(historyService.createHistoricTaskInstanceQuery().taskVariableValueEquals(&quot;booleanVar&quot;, false).count()).isEqualTo(1);</span>
<span class="nc" id="L969">        assertThat(historyService.createHistoricTaskInstanceQuery().taskVariableValueEquals(&quot;dateVar&quot;, otherDate).count()).isEqualTo(1);</span>
<span class="nc" id="L970">        assertThat(historyService.createHistoricTaskInstanceQuery().taskVariableValueEquals(&quot;nullVar&quot;, null).count()).isEqualTo(1);</span>
<span class="nc" id="L971">    }</span>

    @Test
    @Deployment
    public void testHistoricTaskInstanceQueryProcessVariableValueEquals() throws Exception {
        // Set some variables on the process instance
<span class="nc" id="L977">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L978">        variables.put(&quot;longVar&quot;, 12345L);</span>
<span class="nc" id="L979">        variables.put(&quot;shortVar&quot;, (short) 123);</span>
<span class="nc" id="L980">        variables.put(&quot;integerVar&quot;, 1234);</span>
<span class="nc" id="L981">        variables.put(&quot;stringVar&quot;, &quot;stringValue&quot;);</span>
<span class="nc" id="L982">        variables.put(&quot;booleanVar&quot;, true);</span>
<span class="nc" id="L983">        Date date = Calendar.getInstance().getTime();</span>
<span class="nc" id="L984">        variables.put(&quot;dateVar&quot;, date);</span>
<span class="nc" id="L985">        variables.put(&quot;nullVar&quot;, null);</span>

<span class="nc" id="L987">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;HistoricTaskInstanceTest&quot;, variables);</span>
<span class="nc" id="L988">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

        // Validate all variable-updates are present in DB
<span class="nc" id="L991">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().processInstanceId(processInstance.getId()).count()).isEqualTo(7);</span>

        // Query Historic task instances based on process variable
<span class="nc" id="L994">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;longVar&quot;, 12345L).count()).isEqualTo(1);</span>
<span class="nc" id="L995">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;shortVar&quot;, (short) 123).count()).isEqualTo(1);</span>
<span class="nc" id="L996">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;integerVar&quot;, 1234).count()).isEqualTo(1);</span>
<span class="nc" id="L997">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;stringVar&quot;, &quot;stringValue&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L998">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;booleanVar&quot;, true).count()).isEqualTo(1);</span>
<span class="nc" id="L999">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;dateVar&quot;, date).count()).isEqualTo(1);</span>
<span class="nc" id="L1000">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;nullVar&quot;, null).count()).isEqualTo(1);</span>

        // Update the variables
<span class="nc" id="L1003">        variables.put(&quot;longVar&quot;, 67890L);</span>
<span class="nc" id="L1004">        variables.put(&quot;shortVar&quot;, (short) 456);</span>
<span class="nc" id="L1005">        variables.put(&quot;integerVar&quot;, 5678);</span>
<span class="nc" id="L1006">        variables.put(&quot;stringVar&quot;, &quot;updatedStringValue&quot;);</span>
<span class="nc" id="L1007">        variables.put(&quot;booleanVar&quot;, false);</span>
<span class="nc" id="L1008">        Calendar otherCal = Calendar.getInstance();</span>
<span class="nc" id="L1009">        otherCal.add(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L1010">        Date otherDate = otherCal.getTime();</span>
<span class="nc" id="L1011">        variables.put(&quot;dateVar&quot;, otherDate);</span>
<span class="nc" id="L1012">        variables.put(&quot;nullVar&quot;, null);</span>

<span class="nc" id="L1014">        runtimeService.setVariables(processInstance.getId(), variables);</span>

        // Validate all variable-updates are present in DB
<span class="nc" id="L1017">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().processInstanceId(processInstance.getId()).count()).isEqualTo(14);</span>

        // Previous values should NOT match
<span class="nc" id="L1020">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;longVar&quot;, 12345L).count()).isZero();</span>
<span class="nc" id="L1021">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;shortVar&quot;, (short) 123).count()).isZero();</span>
<span class="nc" id="L1022">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;integerVar&quot;, 1234).count()).isZero();</span>
<span class="nc" id="L1023">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;stringVar&quot;, &quot;stringValue&quot;).count()).isZero();</span>
<span class="nc" id="L1024">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;booleanVar&quot;, true).count()).isZero();</span>
<span class="nc" id="L1025">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;dateVar&quot;, date).count()).isZero();</span>

        // New values should match
<span class="nc" id="L1028">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;longVar&quot;, 67890L).count()).isEqualTo(1);</span>
<span class="nc" id="L1029">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;shortVar&quot;, (short) 456).count()).isEqualTo(1);</span>
<span class="nc" id="L1030">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;integerVar&quot;, 5678).count()).isEqualTo(1);</span>
<span class="nc" id="L1031">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;stringVar&quot;, &quot;updatedStringValue&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L1032">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;booleanVar&quot;, false).count()).isEqualTo(1);</span>
<span class="nc" id="L1033">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;dateVar&quot;, otherDate).count()).isEqualTo(1);</span>
<span class="nc" id="L1034">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;nullVar&quot;, null).count()).isEqualTo(1);</span>

        // Set a task-variables, shouldn't affect the process-variable matches
<span class="nc" id="L1037">        taskService.setVariableLocal(task.getId(), &quot;longVar&quot;, 9999L);</span>
<span class="nc" id="L1038">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;longVar&quot;, 9999L).count()).isZero();</span>
<span class="nc" id="L1039">        assertThat(historyService.createHistoricTaskInstanceQuery().processVariableValueEquals(&quot;longVar&quot;, 67890L).count()).isEqualTo(1);</span>
<span class="nc" id="L1040">    }</span>

    @Test
    @Deployment
    public void testHistoricProcessInstanceVariableValueEquals() throws Exception {
        // Set some variables on the process instance
<span class="nc" id="L1046">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1047">        variables.put(&quot;longVar&quot;, 12345L);</span>
<span class="nc" id="L1048">        variables.put(&quot;shortVar&quot;, (short) 123);</span>
<span class="nc" id="L1049">        variables.put(&quot;integerVar&quot;, 1234);</span>
<span class="nc" id="L1050">        variables.put(&quot;stringVar&quot;, &quot;stringValue&quot;);</span>
<span class="nc" id="L1051">        variables.put(&quot;booleanVar&quot;, true);</span>
<span class="nc" id="L1052">        Date date = Calendar.getInstance().getTime();</span>
<span class="nc" id="L1053">        variables.put(&quot;dateVar&quot;, date);</span>
<span class="nc" id="L1054">        variables.put(&quot;nullVar&quot;, null);</span>

<span class="nc" id="L1056">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;HistoricProcessInstanceTest&quot;, variables);</span>

        // Validate all variable-updates are present in DB
<span class="nc" id="L1059">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().processInstanceId(processInstance.getId()).count()).isEqualTo(7);</span>

        // Query Historic process instances based on process variable
<span class="nc" id="L1062">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueEquals(&quot;longVar&quot;, 12345L).count()).isEqualTo(1);</span>
<span class="nc" id="L1063">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueEquals(&quot;shortVar&quot;, (short) 123).count()).isEqualTo(1);</span>
<span class="nc" id="L1064">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueEquals(&quot;integerVar&quot;, 1234).count()).isEqualTo(1);</span>
<span class="nc" id="L1065">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueEquals(&quot;stringVar&quot;, &quot;stringValue&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L1066">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueEquals(&quot;booleanVar&quot;, true).count()).isEqualTo(1);</span>
<span class="nc" id="L1067">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueEquals(&quot;dateVar&quot;, date).count()).isEqualTo(1);</span>
<span class="nc" id="L1068">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueEquals(&quot;nullVar&quot;, null).count()).isEqualTo(1);</span>

        // Update the variables
<span class="nc" id="L1071">        variables.put(&quot;longVar&quot;, 67890L);</span>
<span class="nc" id="L1072">        variables.put(&quot;shortVar&quot;, (short) 456);</span>
<span class="nc" id="L1073">        variables.put(&quot;integerVar&quot;, 5678);</span>
<span class="nc" id="L1074">        variables.put(&quot;stringVar&quot;, &quot;updatedStringValue&quot;);</span>
<span class="nc" id="L1075">        variables.put(&quot;booleanVar&quot;, false);</span>
<span class="nc" id="L1076">        Calendar otherCal = Calendar.getInstance();</span>
<span class="nc" id="L1077">        otherCal.add(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L1078">        Date otherDate = otherCal.getTime();</span>
<span class="nc" id="L1079">        variables.put(&quot;dateVar&quot;, otherDate);</span>
<span class="nc" id="L1080">        variables.put(&quot;nullVar&quot;, null);</span>

<span class="nc" id="L1082">        runtimeService.setVariables(processInstance.getId(), variables);</span>

        // Validate all variable-updates are present in DB
<span class="nc" id="L1085">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().processInstanceId(processInstance.getId()).count()).isEqualTo(14);</span>

        // Previous values should NOT match
<span class="nc" id="L1088">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueEquals(&quot;longVar&quot;, 12345L).count()).isZero();</span>
<span class="nc" id="L1089">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueEquals(&quot;shortVar&quot;, (short) 123).count()).isZero();</span>
<span class="nc" id="L1090">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueEquals(&quot;integerVar&quot;, 1234).count()).isZero();</span>
<span class="nc" id="L1091">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueEquals(&quot;stringVar&quot;, &quot;stringValue&quot;).count()).isZero();</span>
<span class="nc" id="L1092">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueEquals(&quot;booleanVar&quot;, true).count()).isZero();</span>
<span class="nc" id="L1093">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueEquals(&quot;dateVar&quot;, date).count()).isZero();</span>

        // New values should match
<span class="nc" id="L1096">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueEquals(&quot;longVar&quot;, 67890L).count()).isEqualTo(1);</span>
<span class="nc" id="L1097">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueEquals(&quot;shortVar&quot;, (short) 456).count()).isEqualTo(1);</span>
<span class="nc" id="L1098">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueEquals(&quot;integerVar&quot;, 5678).count()).isEqualTo(1);</span>
<span class="nc" id="L1099">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueEquals(&quot;stringVar&quot;, &quot;updatedStringValue&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L1100">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueEquals(&quot;booleanVar&quot;, false).count()).isEqualTo(1);</span>
<span class="nc" id="L1101">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueEquals(&quot;dateVar&quot;, otherDate).count()).isEqualTo(1);</span>
<span class="nc" id="L1102">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueEquals(&quot;nullVar&quot;, null).count()).isEqualTo(1);</span>
<span class="nc" id="L1103">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/standalone/history/FullHistoryTest.testHistoricProcessInstanceVariableValueEquals.bpmn20.xml&quot; })
    public void testHistoricProcessInstanceVariableValueNotEquals() throws Exception {
        // Set some variables on the process instance
<span class="nc" id="L1109">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1110">        variables.put(&quot;longVar&quot;, 12345L);</span>
<span class="nc" id="L1111">        variables.put(&quot;shortVar&quot;, (short) 123);</span>
<span class="nc" id="L1112">        variables.put(&quot;integerVar&quot;, 1234);</span>
<span class="nc" id="L1113">        variables.put(&quot;stringVar&quot;, &quot;stringValue&quot;);</span>
<span class="nc" id="L1114">        variables.put(&quot;booleanVar&quot;, true);</span>
<span class="nc" id="L1115">        Date date = Calendar.getInstance().getTime();</span>
<span class="nc" id="L1116">        Calendar otherCal = Calendar.getInstance();</span>
<span class="nc" id="L1117">        otherCal.add(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L1118">        Date otherDate = otherCal.getTime();</span>
<span class="nc" id="L1119">        variables.put(&quot;dateVar&quot;, date);</span>
<span class="nc" id="L1120">        variables.put(&quot;nullVar&quot;, null);</span>

<span class="nc" id="L1122">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;HistoricProcessInstanceTest&quot;, variables);</span>

        // Validate all variable-updates are present in DB
<span class="nc" id="L1125">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().processInstanceId(processInstance.getId()).count()).isEqualTo(7);</span>

        // Query Historic process instances based on process variable, shouldn't match
<span class="nc" id="L1128">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;longVar&quot;, 12345L).count()).isZero();</span>
<span class="nc" id="L1129">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;shortVar&quot;, (short) 123).count()).isZero();</span>
<span class="nc" id="L1130">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;integerVar&quot;, 1234).count()).isZero();</span>
<span class="nc" id="L1131">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;stringVar&quot;, &quot;stringValue&quot;).count()).isZero();</span>
<span class="nc" id="L1132">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;booleanVar&quot;, true).count()).isZero();</span>
<span class="nc" id="L1133">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;dateVar&quot;, date).count()).isZero();</span>
<span class="nc" id="L1134">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;nullVar&quot;, null).count()).isZero();</span>

<span class="nc" id="L1136">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;longVar&quot;, 67890L).count()).isEqualTo(1);</span>
<span class="nc" id="L1137">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;shortVar&quot;, (short) 456).count()).isEqualTo(1);</span>
<span class="nc" id="L1138">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;integerVar&quot;, 5678).count()).isEqualTo(1);</span>
<span class="nc" id="L1139">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;stringVar&quot;, &quot;updatedStringValue&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L1140">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;booleanVar&quot;, false).count()).isEqualTo(1);</span>
<span class="nc" id="L1141">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;dateVar&quot;, otherDate).count()).isEqualTo(1);</span>

        // Update the variables
<span class="nc" id="L1144">        variables.put(&quot;longVar&quot;, 67890L);</span>
<span class="nc" id="L1145">        variables.put(&quot;shortVar&quot;, (short) 456);</span>
<span class="nc" id="L1146">        variables.put(&quot;integerVar&quot;, 5678);</span>
<span class="nc" id="L1147">        variables.put(&quot;stringVar&quot;, &quot;updatedStringValue&quot;);</span>
<span class="nc" id="L1148">        variables.put(&quot;booleanVar&quot;, false);</span>
<span class="nc" id="L1149">        variables.put(&quot;dateVar&quot;, otherDate);</span>
<span class="nc" id="L1150">        variables.put(&quot;nullVar&quot;, null);</span>

<span class="nc" id="L1152">        runtimeService.setVariables(processInstance.getId(), variables);</span>

        // Validate all variable-updates are present in DB
<span class="nc" id="L1155">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().processInstanceId(processInstance.getId()).count()).isEqualTo(14);</span>

<span class="nc" id="L1157">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;longVar&quot;, 12345L).count()).isEqualTo(1);</span>
<span class="nc" id="L1158">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;shortVar&quot;, (short) 123).count()).isEqualTo(1);</span>
<span class="nc" id="L1159">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;integerVar&quot;, 1234).count()).isEqualTo(1);</span>
<span class="nc" id="L1160">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;stringVar&quot;, &quot;stringValue&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L1161">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;booleanVar&quot;, true).count()).isEqualTo(1);</span>
<span class="nc" id="L1162">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;dateVar&quot;, date).count()).isEqualTo(1);</span>

<span class="nc" id="L1164">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;longVar&quot;, 67890L).count()).isZero();</span>
<span class="nc" id="L1165">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;shortVar&quot;, (short) 456).count()).isZero();</span>
<span class="nc" id="L1166">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;integerVar&quot;, 5678).count()).isZero();</span>
<span class="nc" id="L1167">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;stringVar&quot;, &quot;updatedStringValue&quot;).count()).isZero();</span>
<span class="nc" id="L1168">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;booleanVar&quot;, false).count()).isZero();</span>
<span class="nc" id="L1169">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;dateVar&quot;, otherDate).count()).isZero();</span>
<span class="nc" id="L1170">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueNotEquals(&quot;nullVar&quot;, null).count()).isZero();</span>
<span class="nc" id="L1171">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/standalone/history/FullHistoryTest.testHistoricProcessInstanceVariableValueEquals.bpmn20.xml&quot; })
    public void testHistoricProcessInstanceVariableValueLessThanAndGreaterThan() throws Exception {
        // Set some variables on the process instance
<span class="nc" id="L1177">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1178">        variables.put(&quot;longVar&quot;, 12345L);</span>

<span class="nc" id="L1180">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;HistoricProcessInstanceTest&quot;, variables);</span>

        // Validate all variable-updates are present in DB
<span class="nc" id="L1183">        assertThat(historyService.createHistoricDetailQuery().variableUpdates().processInstanceId(processInstance.getId()).count()).isEqualTo(1);</span>

<span class="nc" id="L1185">        assertThat(historyService.createHistoricProcessInstanceQuery().variableValueGreaterThan(&quot;longVar&quot;, 12345L).count()).isZero();</span>
        // assertThat(historyService.createHistoricProcessInstanceQuery().variableValueGreaterThan(&quot;longVar&quot;,
        // 12344L).count()).isEqualTo(1);
        // assertThat(historyService.createHistoricProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;longVar&quot;,
        // 12345L).count()).isEqualTo(1);
        // assertThat(historyService.createHistoricProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;longVar&quot;,
        // 12344L).count()).isEqualTo(1);
        // assertThat(historyService.createHistoricProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;longVar&quot;,
        // 12346L).count()).isZero();
        //
        // assertThat(historyService.createHistoricProcessInstanceQuery().variableValueLessThan(&quot;longVar&quot;,
        // 12345L).count()).isZero();
        // assertThat(historyService.createHistoricProcessInstanceQuery().variableValueLessThan(&quot;longVar&quot;,
        // 12346L).count()).isEqualTo(1);
        // assertThat(historyService.createHistoricProcessInstanceQuery().variableValueLessThanOrEqual(&quot;longVar&quot;,
        // 12345L).count()).isEqualTo(1);
        // assertThat(historyService.createHistoricProcessInstanceQuery().variableValueLessThanOrEqual(&quot;longVar&quot;,
        // 12346L).count()).isEqualTo(1);
        // assertThat(historyService.createHistoricProcessInstanceQuery().variableValueLessThanOrEqual(&quot;longVar&quot;,
        // 12344L).count()).isZero();
<span class="nc" id="L1205">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/standalone/history/FullHistoryTest.testVariableUpdatesAreLinkedToActivity.bpmn20.xml&quot; })
    public void testVariableUpdatesLinkedToActivity() throws Exception {
<span class="nc" id="L1210">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;ProcessWithSubProcess&quot;);</span>

<span class="nc" id="L1212">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L1213">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1214">        variables.put(&quot;test&quot;, &quot;1&quot;);</span>
<span class="nc" id="L1215">        taskService.complete(task.getId(), variables);</span>

        // now we are in the subprocess
<span class="nc" id="L1218">        task = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L1219">        variables.clear();</span>
<span class="nc" id="L1220">        variables.put(&quot;test&quot;, &quot;2&quot;);</span>
<span class="nc" id="L1221">        taskService.complete(task.getId(), variables);</span>

        // now we are ended
<span class="nc" id="L1224">        assertProcessEnded(pi.getId());</span>

        // check history
<span class="nc" id="L1227">        List&lt;HistoricDetail&gt; updates = historyService.createHistoricDetailQuery().variableUpdates().list();</span>
<span class="nc" id="L1228">        assertThat(updates).hasSize(2);</span>

<span class="nc" id="L1230">        Map&lt;String, HistoricVariableUpdate&gt; updatesMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1231">        HistoricVariableUpdate update = (HistoricVariableUpdate) updates.get(0);</span>
<span class="nc" id="L1232">        updatesMap.put((String) update.getValue(), update);</span>
<span class="nc" id="L1233">        update = (HistoricVariableUpdate) updates.get(1);</span>
<span class="nc" id="L1234">        updatesMap.put((String) update.getValue(), update);</span>

<span class="nc" id="L1236">        HistoricVariableUpdate update1 = updatesMap.get(&quot;1&quot;);</span>
<span class="nc" id="L1237">        HistoricVariableUpdate update2 = updatesMap.get(&quot;2&quot;);</span>

<span class="nc" id="L1239">        assertThat(update1.getActivityInstanceId()).isNotNull();</span>
<span class="nc" id="L1240">        assertThat(update1.getExecutionId()).isNotNull();</span>
<span class="nc" id="L1241">        HistoricActivityInstance historicActivityInstance1 = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L1242">                .activityInstanceId(update1.getActivityInstanceId()).singleResult();</span>
<span class="nc" id="L1243">        assertThat(historicActivityInstance1.getActivityId()).isEqualTo(&quot;usertask1&quot;);</span>

<span class="nc" id="L1245">        assertThat(update2.getActivityInstanceId()).isNotNull();</span>
<span class="nc" id="L1246">        HistoricActivityInstance historicActivityInstance2 = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L1247">                .activityInstanceId(update2.getActivityInstanceId()).singleResult();</span>
<span class="nc" id="L1248">        assertThat(historicActivityInstance2.getActivityId()).isEqualTo(&quot;usertask2&quot;);</span>

        /*
         * This is OK! The variable is set on the root execution, on a execution never run through the activity, where the process instances stands when calling the set Variable. But the ActivityId of
         * this flow node is used. So the execution id's doesn't have to be equal.
         *
         * execution id: On which execution it was set activity id: in which activity was the process instance when setting the variable
         */
<span class="nc" id="L1256">        assertThat(historicActivityInstance2.getExecutionId()).isNotEqualTo(update2.getExecutionId());</span>
<span class="nc" id="L1257">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/standalone/jpa/JPAVariableTest.testQueryJPAVariable.bpmn20.xml&quot; })
    public void testReadJpaVariableValueFromHistoricVariableUpdate() {

<span class="nc" id="L1263">        EntityManagerSessionFactory entityManagerSessionFactory = (EntityManagerSessionFactory) processEngineConfiguration.getSessionFactories()</span>
<span class="nc" id="L1264">                .get(EntityManagerSession.class);</span>

<span class="nc" id="L1266">        EntityManagerFactory entityManagerFactory = entityManagerSessionFactory.getEntityManagerFactory();</span>

<span class="nc" id="L1268">        String executionId = runtimeService.startProcessInstanceByKey(&quot;JPAVariableProcess&quot;).getProcessInstanceId();</span>
<span class="nc" id="L1269">        String variableName = &quot;name&quot;;</span>

<span class="nc" id="L1271">        FieldAccessJPAEntity entity = new FieldAccessJPAEntity();</span>
<span class="nc" id="L1272">        entity.setId(1L);</span>
<span class="nc" id="L1273">        entity.setValue(&quot;Test&quot;);</span>

<span class="nc" id="L1275">        EntityManager manager = entityManagerFactory.createEntityManager();</span>
<span class="nc" id="L1276">        manager.getTransaction().begin();</span>
<span class="nc" id="L1277">        manager.persist(entity);</span>
<span class="nc" id="L1278">        manager.flush();</span>
<span class="nc" id="L1279">        manager.getTransaction().commit();</span>
<span class="nc" id="L1280">        manager.close();</span>

<span class="nc" id="L1282">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(executionId).taskName(&quot;my task&quot;).singleResult();</span>

<span class="nc" id="L1284">        runtimeService.setVariable(executionId, variableName, entity);</span>
<span class="nc" id="L1285">        taskService.complete(task.getId());</span>

<span class="nc" id="L1287">        List&lt;HistoricDetail&gt; variableUpdates = historyService.createHistoricDetailQuery().processInstanceId(executionId).variableUpdates().list();</span>

<span class="nc" id="L1289">        assertThat(variableUpdates).hasSize(1);</span>
<span class="nc" id="L1290">        HistoricVariableUpdate update = (HistoricVariableUpdate) variableUpdates.get(0);</span>
<span class="nc" id="L1291">        assertThat(update.getValue()).isInstanceOf(FieldAccessJPAEntity.class);</span>

<span class="nc" id="L1293">        assertThat(((FieldAccessJPAEntity) update.getValue()).getId()).isEqualTo(entity.getId());</span>
<span class="nc" id="L1294">    }</span>

    /**
     * Test confirming fix for ACT-1731
     */
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/history/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryHistoricTaskIncludeBinaryVariable() throws Exception {
        // Start process with a binary variable
<span class="nc" id="L1303">        ProcessInstance processInstance = runtimeService</span>
<span class="nc" id="L1304">                .startProcessInstanceByKey(&quot;oneTaskProcess&quot;, Collections.singletonMap(&quot;binaryVariable&quot;, (Object) &quot;It is I, le binary&quot;.getBytes()));</span>
<span class="nc" id="L1305">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1306">        assertThat(task).isNotNull();</span>
<span class="nc" id="L1307">        taskService.setVariableLocal(task.getId(), &quot;binaryTaskVariable&quot;, (Object) &quot;It is I, le binary&quot;.getBytes());</span>

        // Complete task
<span class="nc" id="L1310">        taskService.complete(task.getId());</span>

        // Query task, including processVariables
<span class="nc" id="L1313">        HistoricTaskInstance historicTask = historyService.createHistoricTaskInstanceQuery().taskId(task.getId()).includeProcessVariables().singleResult();</span>
<span class="nc" id="L1314">        assertThat(historicTask).isNotNull();</span>
<span class="nc" id="L1315">        assertThat(historicTask.getProcessVariables()).isNotNull();</span>
<span class="nc" id="L1316">        byte[] bytes = (byte[]) historicTask.getProcessVariables().get(&quot;binaryVariable&quot;);</span>
<span class="nc" id="L1317">        assertThat(new String(bytes)).isEqualTo(&quot;It is I, le binary&quot;);</span>

        // Query task, including taskVariables
<span class="nc" id="L1320">        historicTask = historyService.createHistoricTaskInstanceQuery().taskId(task.getId()).includeTaskLocalVariables().singleResult();</span>
<span class="nc" id="L1321">        assertThat(historicTask).isNotNull();</span>
<span class="nc" id="L1322">        assertThat(historicTask.getTaskLocalVariables()).isNotNull();</span>
<span class="nc" id="L1323">        bytes = (byte[]) historicTask.getTaskLocalVariables().get(&quot;binaryTaskVariable&quot;);</span>
<span class="nc" id="L1324">        assertThat(new String(bytes)).isEqualTo(&quot;It is I, le binary&quot;);</span>
<span class="nc" id="L1325">    }</span>

    /**
     * Test confirming fix for ACT-1731
     */
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/history/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryHistoricProcessInstanceIncludeBinaryVariable() throws Exception {
        // Start process with a binary variable
<span class="nc" id="L1334">        ProcessInstance processInstance = runtimeService</span>
<span class="nc" id="L1335">                .startProcessInstanceByKey(&quot;oneTaskProcess&quot;, Collections.singletonMap(&quot;binaryVariable&quot;, (Object) &quot;It is I, le binary&quot;.getBytes()));</span>
<span class="nc" id="L1336">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1337">        assertThat(task).isNotNull();</span>

        // Complete task to end process
<span class="nc" id="L1340">        taskService.complete(task.getId());</span>

        // Query task, including processVariables
<span class="nc" id="L1343">        HistoricProcessInstance historicProcess = historyService.createHistoricProcessInstanceQuery().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1344">                .includeProcessVariables().singleResult();</span>
<span class="nc" id="L1345">        assertThat(historicProcess).isNotNull();</span>
<span class="nc" id="L1346">        assertThat(historicProcess.getProcessVariables()).isNotNull();</span>
<span class="nc" id="L1347">        byte[] bytes = (byte[]) historicProcess.getProcessVariables().get(&quot;binaryVariable&quot;);</span>
<span class="nc" id="L1348">        assertThat(new String(bytes)).isEqualTo(&quot;It is I, le binary&quot;);</span>

<span class="nc" id="L1350">    }</span>

    // Test for https://activiti.atlassian.net/browse/ACT-2186
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testHistoricVariableRemovedWhenRuntimeVariableIsRemoved()
            throws Exception {
<span class="nc" id="L1357">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1358">        vars.put(&quot;var1&quot;, &quot;Hello&quot;);</span>
<span class="nc" id="L1359">        vars.put(&quot;var2&quot;, &quot;World&quot;);</span>
<span class="nc" id="L1360">        vars.put(&quot;var3&quot;, &quot;!&quot;);</span>
<span class="nc" id="L1361">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

        // Verify runtime
<span class="nc" id="L1364">        assertThat(runtimeService.getVariables(processInstance.getId())).hasSize(3);</span>
<span class="nc" id="L1365">        assertThat(runtimeService.getVariables(processInstance.getId(), Arrays.asList(&quot;var1&quot;, &quot;var2&quot;, &quot;var3&quot;))).hasSize(3);</span>
<span class="nc" id="L1366">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;var2&quot;)).isNotNull();</span>

        // Verify history
<span class="nc" id="L1369">        assertThat(historyService.createHistoricVariableInstanceQuery().list()).hasSize(3);</span>
<span class="nc" id="L1370">        assertThat(historyService.createHistoricVariableInstanceQuery().processInstanceId(processInstance.getId()).variableName(&quot;var2&quot;).singleResult())</span>
<span class="nc" id="L1371">                .isNotNull();</span>

        // Verify historic details
<span class="nc" id="L1374">        List&lt;HistoricDetail&gt; details = historyService.createHistoricDetailQuery().processInstanceId(processInstance.getId()).variableUpdates().orderByTime()</span>
<span class="nc" id="L1375">                .asc().list();</span>
<span class="nc" id="L1376">        assertThat(details).hasSize(3); // 3 vars</span>
<span class="nc bnc" id="L1377" title="All 2 branches missed.">        for (HistoricDetail historicDetail : details) {</span>
<span class="nc" id="L1378">            assertThat(((HistoricVariableUpdate) historicDetail).getValue()).isNotNull();</span>
<span class="nc" id="L1379">        }</span>

        // Remove one variable
<span class="nc" id="L1382">        Thread.sleep(750);</span>
<span class="nc" id="L1383">        runtimeService.removeVariable(processInstance.getId(), &quot;var2&quot;);</span>

        // Verify runtime
<span class="nc" id="L1386">        assertThat(runtimeService.getVariables(processInstance.getId())).hasSize(2);</span>
<span class="nc" id="L1387">        assertThat(runtimeService.getVariables(processInstance.getId(), Arrays.asList(&quot;var1&quot;, &quot;var2&quot;, &quot;var3&quot;))).hasSize(2);</span>
<span class="nc" id="L1388">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;var2&quot;)).isNull();</span>

        // Verify history
<span class="nc" id="L1391">        assertThat(historyService.createHistoricVariableInstanceQuery().list()).hasSize(2);</span>
<span class="nc" id="L1392">        assertThat(historyService.createHistoricVariableInstanceQuery().processInstanceId(processInstance.getId()).variableName(&quot;var2&quot;).singleResult())</span>
<span class="nc" id="L1393">                .isNull();</span>

        // Verify historic details
<span class="nc" id="L1396">        details = historyService.createHistoricDetailQuery().processInstanceId(processInstance.getId()).variableUpdates().orderByTime().asc().list();</span>
<span class="nc" id="L1397">        assertThat(details).hasSize(4); // 3 vars + 1 delete</span>

        // The last entry should be the delete
<span class="nc bnc" id="L1400" title="All 2 branches missed.">        for (int i = 0; i &lt; details.size(); i++) {</span>
<span class="nc bnc" id="L1401" title="All 2 branches missed.">            if (i != 3) {</span>
<span class="nc" id="L1402">                assertThat(((HistoricVariableUpdate) details.get(i)).getValue()).isNotNull();</span>
            } else {
<span class="nc" id="L1404">                assertThat(((HistoricVariableUpdate) details.get(i)).getValue()).isNull();</span>
            }
        }

<span class="nc" id="L1408">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>