<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractFlowableCmmnTestCase.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.cmmn.engine.test</a> &gt; <span class="el_source">AbstractFlowableCmmnTestCase.java</span></div><h1>AbstractFlowableCmmnTestCase.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.cmmn.engine.test;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertNull;
import static org.junit.Assert.assertTrue;
import static org.junit.Assert.fail;

import java.time.Instant;
import java.time.temporal.ChronoField;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Set;
import java.util.concurrent.Callable;
import java.util.stream.Collectors;

import org.flowable.cmmn.api.CmmnHistoryService;
import org.flowable.cmmn.api.CmmnManagementService;
import org.flowable.cmmn.api.CmmnMigrationService;
import org.flowable.cmmn.api.CmmnRepositoryService;
import org.flowable.cmmn.api.CmmnRuntimeService;
import org.flowable.cmmn.api.CmmnTaskService;
import org.flowable.cmmn.api.DynamicCmmnService;
import org.flowable.cmmn.api.history.HistoricPlanItemInstance;
import org.flowable.cmmn.api.repository.CaseDefinition;
import org.flowable.cmmn.api.repository.CmmnDeployment;
import org.flowable.cmmn.api.runtime.CaseInstance;
import org.flowable.cmmn.api.runtime.PlanItemInstance;
import org.flowable.cmmn.engine.CmmnEngine;
import org.flowable.cmmn.engine.CmmnEngineConfiguration;
import org.flowable.cmmn.engine.impl.history.CmmnHistoryManager;
import org.flowable.cmmn.engine.impl.history.DefaultCmmnHistoryManager;
import org.flowable.cmmn.engine.test.impl.CmmnHistoryTestHelper;
import org.flowable.cmmn.engine.test.impl.CmmnJobTestHelper;
import org.flowable.cmmn.engine.test.impl.CmmnTestHelper;
import org.flowable.cmmn.engine.test.impl.CmmnTestRunner;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.common.engine.impl.identity.Authentication;
import org.flowable.task.api.Task;
import org.junit.After;
import org.junit.runner.RunWith;

/**
 * @author Joram Barrez
 */
@RunWith(CmmnTestRunner.class)
<span class="nc" id="L64">public abstract class AbstractFlowableCmmnTestCase {</span>

    public static CmmnEngine cmmnEngine;

    protected CmmnEngineConfiguration cmmnEngineConfiguration;
    protected CmmnManagementService cmmnManagementService;
    protected CmmnRepositoryService cmmnRepositoryService;
    protected CmmnRuntimeService cmmnRuntimeService;
    protected DynamicCmmnService dynamicCmmnService;
    protected CmmnTaskService cmmnTaskService;
    protected CmmnHistoryService cmmnHistoryService;
    protected CmmnMigrationService cmmnMigrationService;

<span class="nc" id="L77">    protected Set&lt;String&gt; autoCleanupDeploymentIds = new HashSet&lt;&gt;();</span>

    protected String addDeploymentForAutoCleanup(CmmnDeployment cmmnDeployment) {
<span class="nc" id="L80">        String deploymentId = cmmnDeployment.getId();</span>
<span class="nc" id="L81">        addDeploymentForAutoCleanup(deploymentId);</span>
<span class="nc" id="L82">        return deploymentId;</span>
    }

    protected void addDeploymentForAutoCleanup(String deploymentId) {
<span class="nc" id="L86">        this.autoCleanupDeploymentIds.add(deploymentId);</span>
<span class="nc" id="L87">    }</span>

    @After
    public void cleanup() {
<span class="nc bnc" id="L91" title="All 4 branches missed.">        if (autoCleanupDeploymentIds != null &amp;&amp; !autoCleanupDeploymentIds.isEmpty()) {</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">            for (String deploymentId : autoCleanupDeploymentIds) {</span>
<span class="nc" id="L93">                CmmnTestHelper.deleteDeployment(cmmnEngineConfiguration, deploymentId);</span>
<span class="nc" id="L94">            }</span>
        }
<span class="nc" id="L96">        autoCleanupDeploymentIds = new HashSet&lt;&gt;();</span>
<span class="nc" id="L97">        Authentication.setAuthenticatedUserId(null);</span>
<span class="nc" id="L98">    }</span>

    protected void deployOneHumanTaskCaseModel() {
<span class="nc" id="L101">        addDeploymentForAutoCleanup(cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L102">                .addClasspathResource(&quot;org/flowable/cmmn/test/one-human-task-model.cmmn&quot;)</span>
<span class="nc" id="L103">                .deploy()</span>
        );
<span class="nc" id="L105">    }</span>

    protected CaseInstance deployAndStartOneHumanTaskCaseModel() {
<span class="nc" id="L108">        deployOneHumanTaskCaseModel();</span>
<span class="nc" id="L109">        return cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;oneTaskCase&quot;).start();</span>
    }

    protected void deployOneTaskCaseModel() {
<span class="nc" id="L113">        addDeploymentForAutoCleanup(cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L114">                .addClasspathResource(&quot;org/flowable/cmmn/test/one-task-model.cmmn&quot;)</span>
<span class="nc" id="L115">                .deploy());</span>
<span class="nc" id="L116">    }</span>

    protected CaseDefinition deployCaseDefinition(String name, String path) {
<span class="nc" id="L119">        CmmnDeployment deployment = cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L120">            .name(name)</span>
<span class="nc" id="L121">            .addClasspathResource(path)</span>
<span class="nc" id="L122">            .deploy();</span>

<span class="nc" id="L124">        CaseDefinition caseDefinition = cmmnRepositoryService.createCaseDefinitionQuery()</span>
<span class="nc" id="L125">            .deploymentId(deployment.getId()).singleResult();</span>

<span class="nc" id="L127">        return caseDefinition;</span>
    }

    protected void deleteDeployment(String deploymentId) {
<span class="nc" id="L131">        boolean isAsyncHistoryEnabled = cmmnEngineConfiguration.isAsyncHistoryEnabled();</span>
<span class="nc" id="L132">        CmmnHistoryManager asyncHistoryManager = null;</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (isAsyncHistoryEnabled) {</span>
<span class="nc" id="L134">            cmmnEngineConfiguration.setAsyncHistoryEnabled(false);</span>
<span class="nc" id="L135">            asyncHistoryManager = cmmnEngineConfiguration.getCmmnHistoryManager();</span>
<span class="nc" id="L136">            cmmnEngineConfiguration.setCmmnHistoryManager(new DefaultCmmnHistoryManager(cmmnEngineConfiguration));</span>
        }

<span class="nc" id="L139">        cmmnRepositoryService.deleteDeployment(deploymentId, true);</span>

<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (isAsyncHistoryEnabled) {</span>
<span class="nc" id="L142">            cmmnEngineConfiguration.setAsyncHistoryEnabled(true);</span>
<span class="nc" id="L143">            cmmnEngineConfiguration.setCmmnHistoryManager(asyncHistoryManager);</span>
        }
<span class="nc" id="L145">    }</span>
    
    protected Date setClockFixedToCurrentTime() {
        // SQL Server rounds the milliseconds, on order to be stable we set them to 0
<span class="nc" id="L149">        Date date = Date.from(Instant.now().with(ChronoField.MILLI_OF_SECOND, 0));</span>
<span class="nc" id="L150">        cmmnEngineConfiguration.getClock().setCurrentTime(date);</span>
<span class="nc" id="L151">        return date;</span>
    }

    protected void setClockTo(long epochTime) {
<span class="nc" id="L155">        setClockTo(new Date(epochTime));</span>
<span class="nc" id="L156">    }</span>
    
    protected void setClockTo(Date date) {
<span class="nc" id="L159">        cmmnEngineConfiguration.getClock().setCurrentTime(date);</span>
<span class="nc" id="L160">    }</span>

    protected Date forwardClock(long milliseconds) {
<span class="nc" id="L163">        long currentMillis = cmmnEngineConfiguration.getClock().getCurrentTime().getTime();</span>
<span class="nc" id="L164">        Date date = new Date(currentMillis + milliseconds);</span>
<span class="nc" id="L165">        cmmnEngineConfiguration.getClock().setCurrentTime(date);</span>
<span class="nc" id="L166">        return date;</span>
    }

    protected void assertCaseInstanceEnded(CaseInstance caseInstance) {
<span class="nc" id="L170">        assertCaseInstanceEnded(caseInstance.getId());</span>
<span class="nc" id="L171">    }</span>

    protected void assertCaseInstanceEnded(String caseInstanceId) {
<span class="nc" id="L174">        long count = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstanceId).count();</span>
<span class="nc" id="L175">        assertEquals(createCaseInstanceEndedErrorMessage(caseInstanceId, count), 0, count);</span>
<span class="nc" id="L176">        assertEquals(&quot;Runtime case instance found&quot;, 0, cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstanceId).count());</span>

<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L179">            assertEquals(1, cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstanceId).finished().count());</span>
        }
<span class="nc" id="L181">    }</span>

    protected String createCaseInstanceEndedErrorMessage(CaseInstance caseInstance, long count) {
<span class="nc" id="L184">        return createCaseInstanceEndedErrorMessage(caseInstance.getId(), count);</span>
    }

    protected String createCaseInstanceEndedErrorMessage(String caseInstanceId, long count) {
<span class="nc" id="L188">        String errorMessage = &quot;Plan item instances found for case instance: &quot;;</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (count != 0) {</span>
<span class="nc" id="L190">            List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstanceId).list();</span>
<span class="nc" id="L191">            String names = planItemInstances.stream()</span>
<span class="nc" id="L192">                .map(planItemInstance -&gt; planItemInstance.getName() + &quot;(&quot; + planItemInstance.getPlanItemDefinitionType() + &quot;)&quot;)</span>
<span class="nc" id="L193">                .collect(Collectors.joining(&quot;, &quot;));</span>
<span class="nc" id="L194">            errorMessage += names;</span>
        }
<span class="nc" id="L196">        return errorMessage;</span>
    }

    protected void assertCaseInstanceEnded(CaseInstance caseInstance, int nrOfExpectedMilestones) {
<span class="nc" id="L200">        assertCaseInstanceEnded(caseInstance);</span>
<span class="nc" id="L201">        assertEquals(0, cmmnRuntimeService.createMilestoneInstanceQuery().milestoneInstanceCaseInstanceId(caseInstance.getId()).count());</span>

<span class="nc bnc" id="L203" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L204">            assertEquals(nrOfExpectedMilestones,</span>
<span class="nc" id="L205">                cmmnHistoryService.createHistoricMilestoneInstanceQuery().milestoneInstanceCaseInstanceId(caseInstance.getId()).count());</span>
        }
<span class="nc" id="L207">    }</span>
    
    protected void assertCaseInstanceNotEnded(CaseInstance caseInstance) {
<span class="nc bnc" id="L210" title="All 2 branches missed.">        assertTrue(&quot;Found no plan items for case instance&quot;, cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).count() &gt; 0);</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">        assertTrue(&quot;No runtime case instance found&quot;, cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count() &gt; 0);</span>

<span class="nc bnc" id="L213" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L214">            assertNull(&quot;Historical case instance is already marked as ended&quot;,</span>
<span class="nc" id="L215">                cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult().getEndTime());</span>
        }
<span class="nc" id="L217">    }</span>

    protected void assertSingleTaskExists(List&lt;Task&gt; tasks, String name) {
<span class="nc" id="L220">        List&lt;String&gt; taskIds = tasks.stream()</span>
<span class="nc" id="L221">            .filter(task -&gt; Objects.equals(name, task.getName()))</span>
<span class="nc" id="L222">            .map(Task::getId)</span>
<span class="nc" id="L223">            .collect(Collectors.toList());</span>

<span class="nc" id="L225">        assertNotNull(taskIds);</span>
<span class="nc" id="L226">        assertEquals(1, taskIds.size());</span>
<span class="nc" id="L227">    }</span>

    protected void assertSamePlanItemState(CaseInstance c1) {
<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L231">            List&lt;PlanItemInstance&gt; runtimePlanItems = getAllPlanItemInstances(c1.getId());</span>
<span class="nc" id="L232">            List&lt;HistoricPlanItemInstance&gt; historicPlanItems = cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(c1.getId()).list();</span>

<span class="nc" id="L234">            assertNotNull(runtimePlanItems);</span>
<span class="nc" id="L235">            assertNotNull(historicPlanItems);</span>
<span class="nc" id="L236">            assertEquals(runtimePlanItems.size(), historicPlanItems.size());</span>

<span class="nc" id="L238">            Map&lt;String, HistoricPlanItemInstance&gt; historyMap = new HashMap&lt;&gt;(historicPlanItems.size());</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">            for (HistoricPlanItemInstance historicPlanItem : historicPlanItems) {</span>
<span class="nc" id="L240">                historyMap.put(historicPlanItem.getId(), historicPlanItem);</span>
<span class="nc" id="L241">            }</span>

<span class="nc bnc" id="L243" title="All 2 branches missed.">            for (PlanItemInstance runtimePlanItem : runtimePlanItems) {</span>
<span class="nc" id="L244">                HistoricPlanItemInstance historicPlanItemInstance = historyMap.remove(runtimePlanItem.getId());</span>
<span class="nc" id="L245">                assertNotNull(historicPlanItemInstance);</span>
<span class="nc" id="L246">                assertEquals(runtimePlanItem.getState(), historicPlanItemInstance.getState());</span>
<span class="nc" id="L247">            }</span>

<span class="nc" id="L249">            assertEquals(historyMap.size(), 0);</span>
        }
<span class="nc" id="L251">    }</span>

    protected void assertPlanItemInstanceState(CaseInstance caseInstance, String name, String ... states) {
<span class="nc" id="L254">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L255">            .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L256">            .orderByName()</span>
<span class="nc" id="L257">            .asc()</span>
<span class="nc" id="L258">            .includeEnded()</span>
<span class="nc" id="L259">            .list();</span>
<span class="nc" id="L260">        assertPlanItemInstanceState(planItemInstances, name, states);</span>
<span class="nc" id="L261">    }</span>

    protected void assertPlanItemInstanceState(List&lt;PlanItemInstance&gt; planItemInstances, String name, String ... states) {
<span class="nc" id="L264">        List&lt;String&gt; planItemInstanceStates = planItemInstances.stream()</span>
<span class="nc" id="L265">            .filter(planItemInstance -&gt; Objects.equals(name, planItemInstance.getName()))</span>
<span class="nc" id="L266">            .map(PlanItemInstance::getState)</span>
<span class="nc" id="L267">            .collect(Collectors.toList());</span>

<span class="nc bnc" id="L269" title="All 2 branches missed.">        if (planItemInstanceStates.isEmpty()) {</span>
<span class="nc" id="L270">            fail(&quot;No plan item instances found with name &quot; + name);</span>
        }

<span class="nc" id="L273">        assertEquals(&quot;Incorrect number of states found: &quot; + planItemInstanceStates, states.length, planItemInstanceStates.size());</span>
<span class="nc" id="L274">        List&lt;String&gt; originalStates = new ArrayList&lt;&gt;(planItemInstanceStates);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">        for (String state : states) {</span>
<span class="nc" id="L276">            assertTrue(&quot;State '&quot; + state + &quot;' not found in plan item instances states '&quot; + originalStates + &quot;'&quot;, planItemInstanceStates.remove(state));</span>
        }
<span class="nc" id="L278">    }</span>

    protected void assertHistoricPlanItemInstanceState(List&lt;HistoricPlanItemInstance&gt; planItemInstances, String name, String ... states) {
<span class="nc" id="L281">        List&lt;String&gt; planItemInstanceStates = planItemInstances.stream()</span>
<span class="nc" id="L282">            .filter(planItemInstance -&gt; Objects.equals(name, planItemInstance.getName()))</span>
<span class="nc" id="L283">            .map(HistoricPlanItemInstance::getState)</span>
<span class="nc" id="L284">            .collect(Collectors.toList());</span>

<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (planItemInstanceStates.isEmpty()) {</span>
<span class="nc" id="L287">            fail(&quot;No historic plan item instances found with name &quot; + name);</span>
        }

<span class="nc" id="L290">        assertEquals(&quot;Incorrect number of states found: &quot; + planItemInstanceStates, states.length, planItemInstanceStates.size());</span>
<span class="nc" id="L291">        List&lt;String&gt; originalStates = new ArrayList&lt;&gt;(planItemInstanceStates);</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">        for (String state : states) {</span>
<span class="nc" id="L293">            assertTrue(&quot;State '&quot; + state + &quot;' not found in historic plan item instances states '&quot; + originalStates + &quot;'&quot;, planItemInstanceStates.remove(state));</span>
        }
<span class="nc" id="L295">    }</span>

    protected void assertNoPlanItemInstance(List&lt;PlanItemInstance&gt; planItemInstances, String name) {
<span class="nc" id="L298">        List&lt;String&gt; planItemInstanceStates = planItemInstances.stream()</span>
<span class="nc" id="L299">            .filter(planItemInstance -&gt; Objects.equals(name, planItemInstance.getName()))</span>
<span class="nc" id="L300">            .map(PlanItemInstance::getState)</span>
<span class="nc" id="L301">            .collect(Collectors.toList());</span>

<span class="nc bnc" id="L303" title="All 2 branches missed.">        if (!planItemInstanceStates.isEmpty()) {</span>
<span class="nc" id="L304">            fail(planItemInstanceStates.size() + &quot; plan item instance(s) found with name &quot; + name + &quot;, but should be 0&quot;);</span>
        }
<span class="nc" id="L306">    }</span>

    protected void assertPlanItemLocalVariables(String caseInstanceId, String planItemName, List&lt;?&gt; itemVariableValues, List&lt;Integer&gt; itemIndexVariableValues) {
<span class="nc" id="L309">        List&lt;PlanItemInstance&gt; tasks = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L310">            .caseInstanceId(caseInstanceId)</span>
<span class="nc" id="L311">            .planItemInstanceName(planItemName)</span>
<span class="nc" id="L312">            .planItemInstanceStateActive()</span>
<span class="nc" id="L313">            .orderByCreateTime().asc()</span>
<span class="nc" id="L314">            .list();</span>

<span class="nc" id="L316">        assertEquals(itemVariableValues.size(), tasks.size());</span>

<span class="nc" id="L318">        List&lt;Object&gt; itemValues = new ArrayList&lt;&gt;(tasks.size());</span>
<span class="nc" id="L319">        List&lt;Object&gt; itemIndexValues = new ArrayList&lt;&gt;(tasks.size());</span>

<span class="nc bnc" id="L321" title="All 2 branches missed.">        for (PlanItemInstance task : tasks) {</span>
<span class="nc" id="L322">            itemValues.add(cmmnRuntimeService.getLocalVariable(task.getId(), &quot;item&quot;));</span>
<span class="nc" id="L323">            itemIndexValues.add(cmmnRuntimeService.getLocalVariable(task.getId(), &quot;itemIndex&quot;));</span>
<span class="nc" id="L324">        }</span>

<span class="nc bnc" id="L326" title="All 2 branches missed.">        for (int ii = 0; ii &lt; itemVariableValues.size(); ii++) {</span>
<span class="nc" id="L327">            int index = searchForMatch(itemVariableValues.get(ii), itemIndexVariableValues.get(ii), itemValues, itemIndexValues);</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">            if (index == -1) {</span>
<span class="nc" id="L329">              fail(&quot;Could not find local variable value '&quot; + itemVariableValues.get(ii) + &quot;' with index value '&quot; + itemIndexVariableValues.get(ii) + &quot;'.&quot;);</span>
            }
<span class="nc" id="L331">            itemValues.remove(index);</span>
<span class="nc" id="L332">            itemIndexValues.remove(index);</span>
        }
<span class="nc" id="L334">    }</span>

    protected int searchForMatch(Object itemValue, Integer index, List&lt;Object&gt; itemValues, List&lt;Object&gt; itemIndexValues) {
<span class="nc bnc" id="L337" title="All 2 branches missed.">        for (int ii = 0; ii &lt; itemValues.size(); ii++) {</span>
<span class="nc bnc" id="L338" title="All 4 branches missed.">            if (itemValues.get(ii).equals(itemValue) &amp;&amp; itemIndexValues.get(ii).equals(index)) {</span>
<span class="nc" id="L339">                return ii;</span>
            }
        }
<span class="nc" id="L342">        return -1;</span>
    }

    protected void completePlanItemsWithItemValues(String caseInstanceId, String planItemName, int expectedTotalCount, Object... itemValues) {
<span class="nc" id="L346">        List&lt;PlanItemInstance&gt; tasks = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L347">            .caseInstanceId(caseInstanceId)</span>
<span class="nc" id="L348">            .planItemInstanceName(planItemName)</span>
<span class="nc" id="L349">            .planItemInstanceStateActive()</span>
<span class="nc" id="L350">            .orderByCreateTime().asc()</span>
<span class="nc" id="L351">            .list();</span>

<span class="nc" id="L353">        assertEquals(expectedTotalCount, tasks.size());</span>
<span class="nc" id="L354">        assertNotNull(itemValues);</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">        assertTrue(itemValues.length &lt;= expectedTotalCount);</span>

<span class="nc bnc" id="L357" title="All 2 branches missed.">        for (Object itemValue : itemValues) {</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">            if (!completePlanItemWithItemValue(tasks, itemValue)) {</span>
<span class="nc" id="L359">                fail(&quot;Could not find plan item instance with 'item' value of '&quot; + itemValue + &quot;'&quot;);</span>
            }
        }
<span class="nc" id="L362">    }</span>

    protected boolean completePlanItemWithItemValue(List&lt;PlanItemInstance&gt; planItemInstances, Object itemValue) {
<span class="nc bnc" id="L365" title="All 2 branches missed.">        for (PlanItemInstance planItemInstance : planItemInstances) {</span>
<span class="nc" id="L366">            Object itemValueVar = cmmnRuntimeService.getLocalVariable(planItemInstance.getId(), &quot;item&quot;);</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">            if (itemValue.equals(itemValueVar)) {</span>
<span class="nc" id="L368">                cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>
<span class="nc" id="L369">                return true;</span>
            }
<span class="nc" id="L371">        }</span>
<span class="nc" id="L372">        return false;</span>
    }

    protected void completeAllPlanItems(String caseInstanceId, String planItemName, int expectedCount) {
<span class="nc" id="L376">        List&lt;PlanItemInstance&gt; tasks = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L377">            .caseInstanceId(caseInstanceId)</span>
<span class="nc" id="L378">            .planItemInstanceName(planItemName)</span>
<span class="nc" id="L379">            .planItemInstanceStateActive()</span>
<span class="nc" id="L380">            .orderByCreateTime().asc()</span>
<span class="nc" id="L381">            .list();</span>

<span class="nc" id="L383">        assertEquals(expectedCount, tasks.size());</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">        for (PlanItemInstance task : tasks) {</span>
<span class="nc" id="L385">            cmmnRuntimeService.triggerPlanItemInstance(task.getId());</span>
<span class="nc" id="L386">        }</span>
<span class="nc" id="L387">    }</span>

    protected List&lt;PlanItemInstance&gt; getAllPlanItemInstances(String caseInstanceId) {
<span class="nc" id="L390">        return cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L391">            .caseInstanceId(caseInstanceId)</span>
<span class="nc" id="L392">            .orderByName().asc()</span>
<span class="nc" id="L393">            .orderByEndTime().asc()</span>
<span class="nc" id="L394">            .includeEnded()</span>
<span class="nc" id="L395">            .list();</span>
    }

    protected List&lt;PlanItemInstance&gt; getPlanItemInstances(String caseInstanceId) {
<span class="nc" id="L399">        return cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L400">            .caseInstanceId(caseInstanceId)</span>
<span class="nc" id="L401">            .orderByName().asc()</span>
<span class="nc" id="L402">            .list();</span>
    }

    protected List&lt;PlanItemInstance&gt; getCompletedPlanItemInstances(String caseInstanceId) {
<span class="nc" id="L406">        return cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L407">            .caseInstanceId(caseInstanceId)</span>
<span class="nc" id="L408">            .planItemInstanceStateCompleted()</span>
<span class="nc" id="L409">            .includeEnded()</span>
<span class="nc" id="L410">            .orderByName().asc()</span>
<span class="nc" id="L411">            .list();</span>
    }

    protected List&lt;PlanItemInstance&gt; getTerminatedPlanItemInstances(String caseInstanceId) {
<span class="nc" id="L415">        return cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L416">            .caseInstanceId(caseInstanceId)</span>
<span class="nc" id="L417">            .orderByName().asc()</span>
<span class="nc" id="L418">            .planItemInstanceStateTerminated()</span>
<span class="nc" id="L419">            .includeEnded()</span>
<span class="nc" id="L420">            .list();</span>
    }

    protected String getPlanItemInstanceIdByName(List&lt;PlanItemInstance&gt; planItemInstances, String name) {
<span class="nc" id="L424">        return getPlanItemInstanceByName(planItemInstances, name, null).getId();</span>
    }

    protected String getPlanItemInstanceIdByNameAndState(List&lt;PlanItemInstance&gt; planItemInstances, String name, String state) {
<span class="nc" id="L428">        return getPlanItemInstanceByName(planItemInstances, name, state).getId();</span>
    }

    protected PlanItemInstance getPlanItemInstanceByName(List&lt;PlanItemInstance&gt; planItemInstances, String name, String state) {
<span class="nc" id="L432">        List&lt;PlanItemInstance&gt; matchingPlanItemInstances = planItemInstances.stream()</span>
<span class="nc" id="L433">            .filter(planItemInstance -&gt; Objects.equals(name, planItemInstance.getName()))</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">            .filter(planItemInstance -&gt; state != null ? Objects.equals(state, planItemInstance.getState()) : true)</span>
<span class="nc" id="L435">            .collect(Collectors.toList());</span>

<span class="nc bnc" id="L437" title="All 2 branches missed.">        if (matchingPlanItemInstances.isEmpty()) {</span>
<span class="nc" id="L438">            fail(&quot;No plan item instances found with name &quot; + name);</span>
        }

<span class="nc bnc" id="L441" title="All 2 branches missed.">        if (matchingPlanItemInstances.size() &gt; 1) {</span>
<span class="nc" id="L442">            fail(&quot;Found &quot; + matchingPlanItemInstances.size() + &quot; plan item instances with name &quot; + name);</span>
        }

<span class="nc" id="L445">        return matchingPlanItemInstances.get(0);</span>
    }

    protected void waitForJobExecutorToProcessAllJobs() {
<span class="nc" id="L449">        CmmnJobTestHelper.waitForJobExecutorToProcessAllJobs(cmmnEngineConfiguration, 20000L, 200L, true);</span>
<span class="nc" id="L450">    }</span>

    protected void waitForJobExecutorToProcessAllAsyncJobs() {
<span class="nc" id="L453">        CmmnJobTestHelper.waitForJobExecutorToProcessAllAsyncJobs(cmmnEngineConfiguration, 20000L, 200L, true);</span>
<span class="nc" id="L454">    }</span>
    
    protected void waitForAsyncHistoryExecutorToProcessAllJobs() {
<span class="nc bnc" id="L457" title="All 2 branches missed.">        if (cmmnEngineConfiguration.isAsyncHistoryEnabled()) {</span>
<span class="nc" id="L458">            CmmnJobTestHelper.waitForAsyncHistoryExecutorToProcessAllJobs(cmmnEngineConfiguration, 20000L, 200L, true);</span>
        }
<span class="nc" id="L460">    }</span>

    protected void waitForJobExecutorOnCondition(Callable&lt;Boolean&gt; predicate) {
<span class="nc" id="L463">        CmmnJobTestHelper.waitForJobExecutorOnCondition(cmmnEngineConfiguration, 20000L, 200L, predicate);</span>
<span class="nc" id="L464">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>