<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TaskHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.impl.util</a> &gt; <span class="el_source">TaskHelper.java</span></div><h1>TaskHelper.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.engine.impl.util;

import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang3.StringUtils;
import org.flowable.bpmn.model.FlowElement;
import org.flowable.bpmn.model.UserTask;
import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.api.delegate.Expression;
import org.flowable.common.engine.api.delegate.event.FlowableEngineEventType;
import org.flowable.common.engine.api.delegate.event.FlowableEventDispatcher;
import org.flowable.common.engine.api.scope.ScopeTypes;
import org.flowable.common.engine.api.variable.VariableContainer;
import org.flowable.common.engine.impl.el.ExpressionManager;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.common.engine.impl.identity.Authentication;
import org.flowable.common.engine.impl.interceptor.CommandContext;
import org.flowable.common.engine.impl.logging.LoggingSessionConstants;
import org.flowable.common.engine.impl.persistence.entity.ByteArrayRef;
import org.flowable.engine.compatibility.Flowable5CompatibilityHandler;
import org.flowable.engine.delegate.BpmnError;
import org.flowable.engine.delegate.TaskListener;
import org.flowable.engine.delegate.event.impl.FlowableEventBuilder;
import org.flowable.engine.impl.bpmn.helper.ErrorPropagation;
import org.flowable.engine.impl.cfg.ProcessEngineConfigurationImpl;
import org.flowable.engine.impl.persistence.CountingExecutionEntity;
import org.flowable.engine.impl.persistence.entity.ExecutionEntity;
import org.flowable.identitylink.service.event.impl.FlowableIdentityLinkEventBuilder;
import org.flowable.identitylink.service.impl.persistence.entity.IdentityLinkEntity;
import org.flowable.task.api.DelegationState;
import org.flowable.task.api.Task;
import org.flowable.task.api.history.HistoricTaskInstance;
import org.flowable.task.api.history.HistoricTaskLogEntryType;
import org.flowable.task.service.HistoricTaskService;
import org.flowable.task.service.TaskService;
import org.flowable.task.service.TaskServiceConfiguration;
import org.flowable.task.service.impl.BaseHistoricTaskLogEntryBuilderImpl;
import org.flowable.task.service.impl.persistence.CountingTaskEntity;
import org.flowable.task.service.impl.persistence.entity.HistoricTaskInstanceEntity;
import org.flowable.task.service.impl.persistence.entity.TaskEntity;
import org.flowable.variable.service.event.impl.FlowableVariableEventBuilder;
import org.flowable.variable.service.impl.persistence.entity.VariableInstanceEntity;

import com.fasterxml.jackson.databind.node.ObjectNode;

/**
 * @author Tijs Rademakers
 * @author Joram Barrez
 */
<span class="nc" id="L65">public class TaskHelper {</span>

    public static void completeTask(TaskEntity taskEntity, String userId, Map&lt;String, Object&gt; variables, Map&lt;String, Object&gt; localVariables,
            Map&lt;String, Object&gt; transientVariables, Map&lt;String, Object&gt; localTransientVariables, CommandContext commandContext) {

<span class="nc bnc" id="L70" title="All 4 branches missed.">        if (taskEntity.getDelegationState() != null &amp;&amp; taskEntity.getDelegationState() == DelegationState.PENDING) {</span>
<span class="nc" id="L71">            throw new FlowableException(&quot;A delegated &quot; + taskEntity + &quot; cannot be completed, but should be resolved instead.&quot;);</span>
        }

<span class="nc bnc" id="L74" title="All 4 branches missed.">        if (localVariables != null &amp;&amp; !localVariables.isEmpty()) {</span>
<span class="nc" id="L75">            taskEntity.setVariablesLocal(localVariables);</span>
        }

<span class="nc bnc" id="L78" title="All 4 branches missed.">        if (variables != null &amp;&amp; !variables.isEmpty()) {</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">            if (taskEntity.getExecutionId() != null) {</span>
<span class="nc" id="L80">                ExecutionEntity execution = CommandContextUtil.getExecutionEntityManager().findById(taskEntity.getExecutionId());</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">                if (execution != null) {</span>
<span class="nc" id="L82">                    execution.setVariables(variables);</span>
                }

<span class="nc" id="L85">            } else {</span>
<span class="nc" id="L86">                taskEntity.setVariables(variables);</span>

            }
        }

<span class="nc bnc" id="L91" title="All 4 branches missed.">        if (localTransientVariables != null &amp;&amp; !localTransientVariables.isEmpty()) {</span>
<span class="nc" id="L92">            taskEntity.setTransientVariablesLocal(localTransientVariables);</span>
        }

<span class="nc bnc" id="L95" title="All 4 branches missed.">        if (transientVariables != null &amp;&amp; !transientVariables.isEmpty()) {</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">            if (taskEntity.getExecutionId() != null) {</span>
<span class="nc" id="L97">                ExecutionEntity execution = CommandContextUtil.getExecutionEntityManager().findById(taskEntity.getExecutionId());</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                if (execution != null) {</span>
<span class="nc" id="L99">                    execution.setTransientVariables(transientVariables);</span>
                }

<span class="nc" id="L102">            } else {</span>
<span class="nc" id="L103">                taskEntity.setTransientVariables(transientVariables);</span>

            }
        }

<span class="nc" id="L108">        ProcessEngineConfigurationImpl processEngineConfiguration = CommandContextUtil.getProcessEngineConfiguration(commandContext);</span>
<span class="nc" id="L109">        boolean bpmnErrorPropagated = false;</span>
        try {
<span class="nc" id="L111">            processEngineConfiguration.getListenerNotificationHelper().executeTaskListeners(taskEntity, TaskListener.EVENTNAME_COMPLETE);</span>
<span class="nc" id="L112">        } catch (BpmnError bpmnError) {</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">            if (taskEntity.getExecutionId() != null) {</span>
<span class="nc" id="L114">                ExecutionEntity execution = CommandContextUtil.getExecutionEntityManager().findById(taskEntity.getExecutionId());</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                if (execution != null) {</span>
<span class="nc" id="L116">                    ErrorPropagation.propagateError(bpmnError, execution);</span>
<span class="nc" id="L117">                    bpmnErrorPropagated = true;</span>
                }
            }
<span class="nc" id="L120">        }</span>

<span class="nc bnc" id="L122" title="All 2 branches missed.">        if (processEngineConfiguration.getIdentityLinkInterceptor() != null) {</span>
<span class="nc" id="L123">            processEngineConfiguration.getIdentityLinkInterceptor().handleCompleteTask(taskEntity);</span>
        }

<span class="nc" id="L126">        logUserTaskCompleted(taskEntity);</span>

<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (taskEntity.getExecutionId() != null) {</span>
<span class="nc" id="L129">            ExecutionEntity execution = CommandContextUtil.getExecutionEntityManager().findById(taskEntity.getExecutionId());</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">            if (execution != null) {</span>
<span class="nc" id="L131">                storeTaskCompleter(taskEntity, execution, processEngineConfiguration);</span>
            }
        }

<span class="nc" id="L135">        FlowableEventDispatcher eventDispatcher = processEngineConfiguration.getEventDispatcher();</span>
<span class="nc bnc" id="L136" title="All 4 branches missed.">        if (eventDispatcher != null &amp;&amp; eventDispatcher.isEnabled()) {</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">            if (variables != null) {</span>

                // The only way a task can be completed + event thrown is either with variables or with localvariables,
                // where a boolean flag is passed through the API.
                // This means that if the flag is set, local variables always have precedence in the event.

<span class="nc bnc" id="L143" title="All 4 branches missed.">                boolean local = localVariables != null &amp;&amp; !localVariables.isEmpty();</span>
<span class="nc" id="L144">                Map&lt;String, Object&gt; eventVariables = null;</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">                if (local) {</span>
<span class="nc" id="L146">                    eventVariables = localVariables;</span>
                } else {
<span class="nc" id="L148">                    eventVariables = variables;</span>
                }

<span class="nc" id="L151">                eventDispatcher.dispatchEvent(FlowableEventBuilder.createEntityWithVariablesEvent(</span>
<span class="nc" id="L152">                        FlowableEngineEventType.TASK_COMPLETED, taskEntity, eventVariables, local), processEngineConfiguration.getEngineCfgKey());</span>

<span class="nc" id="L154">            } else {</span>
<span class="nc" id="L155">                eventDispatcher.dispatchEvent(FlowableEventBuilder.createEntityEvent(FlowableEngineEventType.TASK_COMPLETED, taskEntity),</span>
<span class="nc" id="L156">                        processEngineConfiguration.getEngineCfgKey());</span>
            }
        }

<span class="nc bnc" id="L160" title="All 4 branches missed.">        if (processEngineConfiguration.isLoggingSessionEnabled() &amp;&amp; taskEntity.getExecutionId() != null) {</span>
<span class="nc" id="L161">            String taskLabel = null;</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">            if (StringUtils.isNotEmpty(taskEntity.getName())) {</span>
<span class="nc" id="L163">                taskLabel = taskEntity.getName();</span>
            } else {
<span class="nc" id="L165">                taskLabel = taskEntity.getId();</span>
            }

<span class="nc" id="L168">            ExecutionEntity execution = CommandContextUtil.getExecutionEntityManager().findById(taskEntity.getExecutionId());</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">            if (execution != null) {</span>
<span class="nc" id="L170">                BpmnLoggingSessionUtil.addLoggingData(LoggingSessionConstants.TYPE_USER_TASK_COMPLETE,</span>
                        &quot;User task '&quot; + taskLabel + &quot;' completed&quot;, taskEntity, execution);
            }
        }

<span class="nc" id="L175">        completeTask(taskEntity, userId);</span>

        // Continue process (if not a standalone task)
<span class="nc bnc" id="L178" title="All 4 branches missed.">        if (taskEntity.getExecutionId() != null &amp;&amp; !bpmnErrorPropagated) {</span>
<span class="nc" id="L179">            ExecutionEntity executionEntity = processEngineConfiguration.getExecutionEntityManager().findById(taskEntity.getExecutionId());</span>
<span class="nc" id="L180">            CommandContextUtil.getAgenda(commandContext).planTriggerExecutionOperation(executionEntity);</span>
        }
<span class="nc" id="L182">    }</span>

    protected static void logUserTaskCompleted(TaskEntity taskEntity) {
<span class="nc" id="L185">        ProcessEngineConfigurationImpl processEngineConfiguration = CommandContextUtil.getProcessEngineConfiguration();</span>
<span class="nc" id="L186">        TaskServiceConfiguration taskServiceConfiguration = processEngineConfiguration.getTaskServiceConfiguration();</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">        if (taskServiceConfiguration.isEnableHistoricTaskLogging()) {</span>
<span class="nc" id="L188">            BaseHistoricTaskLogEntryBuilderImpl taskLogEntryBuilder = new BaseHistoricTaskLogEntryBuilderImpl(taskEntity);</span>
<span class="nc" id="L189">            ObjectNode data = taskServiceConfiguration.getObjectMapper().createObjectNode();</span>
<span class="nc" id="L190">            taskLogEntryBuilder.timeStamp(taskServiceConfiguration.getClock().getCurrentTime());</span>
<span class="nc" id="L191">            taskLogEntryBuilder.userId(Authentication.getAuthenticatedUserId());</span>
<span class="nc" id="L192">            taskLogEntryBuilder.data(data.toString());</span>
<span class="nc" id="L193">            taskLogEntryBuilder.type(HistoricTaskLogEntryType.USER_TASK_COMPLETED.name());</span>
<span class="nc" id="L194">            taskServiceConfiguration.getInternalHistoryTaskManager().recordHistoryUserTaskLog(taskLogEntryBuilder);</span>
        }
<span class="nc" id="L196">    }</span>

    protected static void storeTaskCompleter(TaskEntity taskEntity, ExecutionEntity execution, ProcessEngineConfigurationImpl processEngineConfiguration) {
<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (taskEntity.getProcessDefinitionId() != null) {</span>
<span class="nc" id="L200">            FlowElement flowElement = execution.getCurrentFlowElement();</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">            if (flowElement instanceof UserTask) {</span>
<span class="nc" id="L202">                UserTask userTask = (UserTask) flowElement;</span>
<span class="nc" id="L203">                String taskCompleterVariableName = userTask.getTaskCompleterVariableName();</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">                if (StringUtils.isNotEmpty(taskCompleterVariableName)) {</span>
<span class="nc" id="L205">                    ExpressionManager expressionManager = processEngineConfiguration.getExpressionManager();</span>
<span class="nc" id="L206">                    Expression expression = expressionManager.createExpression(userTask.getTaskCompleterVariableName());</span>
<span class="nc" id="L207">                    String completerVariableName = (String) expression.getValue(execution);</span>
<span class="nc" id="L208">                    String completer = Authentication.getAuthenticatedUserId();</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">                    if (StringUtils.isNotEmpty(completerVariableName)) {</span>
<span class="nc" id="L210">                        execution.setVariable(completerVariableName, completer);</span>
                    }
                }
            }
        }
<span class="nc" id="L215">    }</span>

    public static void changeTaskAssignee(TaskEntity taskEntity, String assignee) {
<span class="nc bnc" id="L218" title="All 4 branches missed.">        if ((taskEntity.getAssignee() != null &amp;&amp; !taskEntity.getAssignee().equals(assignee))</span>
<span class="nc bnc" id="L219" title="All 4 branches missed.">                || (taskEntity.getAssignee() == null &amp;&amp; assignee != null)) {</span>

<span class="nc" id="L221">            ProcessEngineConfigurationImpl processEngineConfiguration = CommandContextUtil.getProcessEngineConfiguration();</span>
<span class="nc" id="L222">            processEngineConfiguration.getTaskServiceConfiguration().getTaskService().changeTaskAssignee(taskEntity, assignee);</span>
<span class="nc" id="L223">            fireAssignmentEvents(taskEntity);</span>

<span class="nc bnc" id="L225" title="All 2 branches missed.">            if (taskEntity.getId() != null) {</span>
<span class="nc" id="L226">                addAssigneeIdentityLinks(taskEntity);</span>
            }
        }
<span class="nc" id="L229">    }</span>

    public static void changeTaskOwner(TaskEntity taskEntity, String owner) {
<span class="nc bnc" id="L232" title="All 4 branches missed.">        if ((taskEntity.getOwner() != null &amp;&amp; !taskEntity.getOwner().equals(owner))</span>
<span class="nc bnc" id="L233" title="All 4 branches missed.">                || (taskEntity.getOwner() == null &amp;&amp; owner != null)) {</span>

<span class="nc" id="L235">            ProcessEngineConfigurationImpl processEngineConfiguration = CommandContextUtil.getProcessEngineConfiguration();</span>
<span class="nc" id="L236">            processEngineConfiguration.getTaskServiceConfiguration().getTaskService().changeTaskOwner(taskEntity, owner);</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">            if (taskEntity.getId() != null) {</span>
<span class="nc" id="L238">                addOwnerIdentityLink(taskEntity, taskEntity.getOwner());</span>
            }
        }
<span class="nc" id="L241">    }</span>

    public static void insertTask(TaskEntity taskEntity, ExecutionEntity execution, boolean fireCreateEvent, boolean addEntityLinks) {
        // Inherit tenant id (if applicable)
<span class="nc bnc" id="L245" title="All 4 branches missed.">        if (execution != null &amp;&amp; execution.getTenantId() != null) {</span>
<span class="nc" id="L246">            taskEntity.setTenantId(execution.getTenantId());</span>
        }

<span class="nc bnc" id="L249" title="All 2 branches missed.">        if (execution != null) {</span>
<span class="nc" id="L250">            taskEntity.setExecutionId(execution.getId());</span>
<span class="nc" id="L251">            taskEntity.setProcessInstanceId(execution.getProcessInstanceId());</span>
<span class="nc" id="L252">            taskEntity.setProcessDefinitionId(execution.getProcessDefinitionId());</span>
        }

<span class="nc" id="L255">        insertTask(taskEntity, fireCreateEvent);</span>

<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (execution != null) {</span>

<span class="nc bnc" id="L259" title="All 2 branches missed.">            if (CountingEntityUtil.isExecutionRelatedEntityCountEnabled(execution)) {</span>
<span class="nc" id="L260">                CountingExecutionEntity countingExecutionEntity = (CountingExecutionEntity) execution;</span>
<span class="nc" id="L261">                countingExecutionEntity.setTaskCount(countingExecutionEntity.getTaskCount() + 1);</span>
            }

<span class="nc bnc" id="L264" title="All 2 branches missed.">            if (addEntityLinks) {</span>
<span class="nc" id="L265">                EntityLinkUtil.createEntityLinks(execution.getProcessInstanceId(), execution.getId(),</span>
<span class="nc" id="L266">                        taskEntity.getTaskDefinitionKey(), taskEntity.getId(), ScopeTypes.TASK);</span>
            }

        }

<span class="nc" id="L271">        ProcessEngineConfigurationImpl processEngineConfiguration = CommandContextUtil.getProcessEngineConfiguration();</span>
<span class="nc" id="L272">        FlowableEventDispatcher eventDispatcher = processEngineConfiguration.getEventDispatcher();</span>
<span class="nc bnc" id="L273" title="All 6 branches missed.">        if (fireCreateEvent &amp;&amp; eventDispatcher != null &amp;&amp; eventDispatcher.isEnabled()) {</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">            if (taskEntity.getAssignee() != null) {</span>
<span class="nc" id="L275">                eventDispatcher.dispatchEvent(FlowableEventBuilder.createEntityEvent(FlowableEngineEventType.TASK_ASSIGNED, taskEntity),</span>
<span class="nc" id="L276">                        processEngineConfiguration.getEngineCfgKey());</span>
            }
        }

<span class="nc" id="L280">        processEngineConfiguration.getActivityInstanceEntityManager().recordTaskCreated(taskEntity, execution);</span>
<span class="nc" id="L281">    }</span>

    public static void insertTask(TaskEntity taskEntity, boolean fireCreateEvent) {
<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (taskEntity.getOwner() != null) {</span>
<span class="nc" id="L285">            addOwnerIdentityLink(taskEntity, taskEntity.getOwner());</span>
        }
<span class="nc bnc" id="L287" title="All 2 branches missed.">        if (taskEntity.getAssignee() != null) {</span>
<span class="nc" id="L288">            addAssigneeIdentityLinks(taskEntity);</span>
        }

<span class="nc" id="L291">        ProcessEngineConfigurationImpl processEngineConfiguration = CommandContextUtil.getProcessEngineConfiguration();</span>
<span class="nc" id="L292">        processEngineConfiguration.getTaskServiceConfiguration().getTaskService().insertTask(taskEntity, fireCreateEvent);</span>
<span class="nc" id="L293">    }</span>

    public static void addAssigneeIdentityLinks(TaskEntity taskEntity) {
<span class="nc" id="L296">        ProcessEngineConfigurationImpl processEngineConfiguration = CommandContextUtil.getProcessEngineConfiguration();</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">        if (processEngineConfiguration.getIdentityLinkInterceptor() != null) {</span>
<span class="nc" id="L298">            processEngineConfiguration.getIdentityLinkInterceptor().handleAddAssigneeIdentityLinkToTask(taskEntity, taskEntity.getAssignee());</span>
        }
<span class="nc" id="L300">    }</span>

    public static void addOwnerIdentityLink(TaskEntity taskEntity, String owner) {
<span class="nc bnc" id="L303" title="All 4 branches missed.">        if (owner == null &amp;&amp; taskEntity.getOwner() == null) {</span>
<span class="nc" id="L304">            return;</span>
        }
        
<span class="nc" id="L307">        ProcessEngineConfigurationImpl processEngineConfiguration = CommandContextUtil.getProcessEngineConfiguration();</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">        if (processEngineConfiguration.getIdentityLinkInterceptor() != null) {</span>
<span class="nc" id="L309">            processEngineConfiguration.getIdentityLinkInterceptor().handleAddOwnerIdentityLinkToTask(taskEntity, owner);</span>
        }
<span class="nc" id="L311">    }</span>
    
    /**
     * Deletes all tasks that relate to the same execution.
     *  
     * @param executionEntity The {@link ExecutionEntity} to which the {@link TaskEntity} relate to.
     * @param taskEntities Tasks to be deleted. It is assumed that all {@link TaskEntity} instances need to be related to the same execution.
     */
    public static void deleteTasksForExecution(ExecutionEntity executionEntity, Collection&lt;TaskEntity&gt; taskEntities, String deleteReason) {
        
<span class="nc" id="L321">        CommandContext commandContext = CommandContextUtil.getCommandContext();</span>
<span class="nc" id="L322">        ProcessEngineConfigurationImpl processEngineConfiguration = CommandContextUtil.getProcessEngineConfiguration(commandContext);</span>

        // Delete all entities related to the task entities
<span class="nc bnc" id="L325" title="All 2 branches missed.">        for (TaskEntity taskEntity : taskEntities) {</span>
<span class="nc" id="L326">            internalDeleteTask(taskEntity, null, deleteReason, false, false, true, true);</span>
<span class="nc" id="L327">        }</span>
        
        // Delete the task entities itself
<span class="nc" id="L330">        processEngineConfiguration.getTaskServiceConfiguration().getTaskService().deleteTasksByExecutionId(executionEntity.getId());</span>
        
<span class="nc" id="L332">    }</span>
    
    public static void completeTask(TaskEntity task, String userId) {
<span class="nc" id="L335">        internalDeleteTask(task, userId, null, false, true, true, true);</span>
<span class="nc" id="L336">    }</span>

    /**
     * @param task
     *            The task to be deleted.
     * @param deleteReason
     *            A delete reason that will be stored in the history tables.
     * @param cascade
     *            If true, the historical counterpart will be deleted, otherwise
     *            it will be updated with an end time.
     * @param fireTaskListener
     *            If true, the delete event of the task listener will be called.
     * @param fireEvents
     *            If true, the event dispatcher will be used to fire an event
     *            for the deletion.
     */
    public static void deleteTask(TaskEntity task, String deleteReason, boolean cascade, boolean fireTaskListener, boolean fireEvents) {
<span class="nc" id="L353">        internalDeleteTask(task, null, deleteReason, cascade, true, fireTaskListener, fireEvents);</span>
<span class="nc" id="L354">    }</span>
        
    protected static void internalDeleteTask(TaskEntity task, String userId, String deleteReason, 
            boolean cascade, boolean executeTaskDelete, boolean fireTaskListener, boolean fireEvents) {
        
<span class="nc bnc" id="L359" title="All 2 branches missed.">        if (!task.isDeleted()) {</span>
            
<span class="nc" id="L361">            CommandContext commandContext = CommandContextUtil.getCommandContext();</span>
<span class="nc" id="L362">            FlowableEventDispatcher eventDispatcher = CommandContextUtil.getEventDispatcher(commandContext);</span>
<span class="nc bnc" id="L363" title="All 6 branches missed.">            fireEvents = fireEvents &amp;&amp; eventDispatcher != null &amp;&amp; eventDispatcher.isEnabled();</span>

<span class="nc bnc" id="L365" title="All 2 branches missed.">            if (fireTaskListener) {</span>
                try {
<span class="nc" id="L367">                    CommandContextUtil.getProcessEngineConfiguration(commandContext).getListenerNotificationHelper()</span>
<span class="nc" id="L368">                            .executeTaskListeners(task, TaskListener.EVENTNAME_DELETE);</span>
<span class="nc" id="L369">                } catch (BpmnError bpmnError) {</span>
<span class="nc" id="L370">                    ExecutionEntity execution = CommandContextUtil.getExecutionEntityManager().findById(task.getExecutionId());</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">                    if (execution != null) {</span>
<span class="nc" id="L372">                        ErrorPropagation.propagateError(bpmnError, execution);</span>
                    }
<span class="nc" id="L374">                }</span>
            }

<span class="nc" id="L377">            task.setDeleted(true);</span>

<span class="nc" id="L379">            handleRelatedEntities(task, deleteReason, cascade, fireTaskListener, fireEvents, eventDispatcher, commandContext);</span>
<span class="nc" id="L380">            handleTaskHistory(task, userId, deleteReason, cascade, commandContext);</span>

<span class="nc bnc" id="L382" title="All 2 branches missed.">            if (executeTaskDelete) {</span>
<span class="nc" id="L383">                executeTaskDelete(task, commandContext);</span>
            }

<span class="nc bnc" id="L386" title="All 2 branches missed.">            if (fireEvents) {</span>
<span class="nc" id="L387">                fireTaskDeletedEvent(task, commandContext, eventDispatcher);</span>
            }

        }
<span class="nc" id="L391">    }</span>

    protected static void handleRelatedEntities(TaskEntity task, String deleteReason, boolean cascade,
            boolean fireTaskListener, boolean fireEvents, FlowableEventDispatcher eventDispatcher, CommandContext commandContext) {
        
<span class="nc" id="L396">        boolean isTaskRelatedEntityCountEnabled = CountingEntityUtil.isTaskRelatedEntityCountEnabled(task);</span>
        
<span class="nc" id="L398">        ProcessEngineConfigurationImpl processEngineConfiguration = CommandContextUtil.getProcessEngineConfiguration(commandContext);</span>
<span class="nc bnc" id="L399" title="All 4 branches missed.">        if (!isTaskRelatedEntityCountEnabled</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">                || (isTaskRelatedEntityCountEnabled &amp;&amp; ((CountingTaskEntity) task).getSubTaskCount() &gt; 0)) {</span>
<span class="nc" id="L401">            TaskService taskService = processEngineConfiguration.getTaskServiceConfiguration().getTaskService();</span>
<span class="nc" id="L402">            List&lt;Task&gt; subTasks = taskService.findTasksByParentTaskId(task.getId());</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">            for (Task subTask : subTasks) {</span>
<span class="nc" id="L404">                internalDeleteTask((TaskEntity) subTask, null, deleteReason, cascade, true, fireTaskListener, fireEvents); // Sub tasks are always immediately deleted</span>
<span class="nc" id="L405">            }</span>
        }
        
<span class="nc bnc" id="L408" title="All 4 branches missed.">        if (!isTaskRelatedEntityCountEnabled</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">                || (isTaskRelatedEntityCountEnabled &amp;&amp; ((CountingTaskEntity) task).getIdentityLinkCount() &gt; 0)) {</span>
            
<span class="nc" id="L411">            boolean deleteIdentityLinks = true;</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">            if (fireEvents) {</span>
<span class="nc" id="L413">                List&lt;IdentityLinkEntity&gt; identityLinks = processEngineConfiguration.getIdentityLinkServiceConfiguration().getIdentityLinkService()</span>
<span class="nc" id="L414">                        .findIdentityLinksByTaskId(task.getId());</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">                for (IdentityLinkEntity identityLinkEntity : identityLinks) {</span>
<span class="nc" id="L416">                    eventDispatcher.dispatchEvent(FlowableIdentityLinkEventBuilder.createEntityEvent(FlowableEngineEventType.ENTITY_DELETED, identityLinkEntity),</span>
<span class="nc" id="L417">                            processEngineConfiguration.getEngineCfgKey());</span>
<span class="nc" id="L418">                }</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">                deleteIdentityLinks = !identityLinks.isEmpty();</span>
            }
            
<span class="nc bnc" id="L422" title="All 2 branches missed.">            if (deleteIdentityLinks) {</span>
<span class="nc" id="L423">                processEngineConfiguration.getIdentityLinkServiceConfiguration().getIdentityLinkService().deleteIdentityLinksByTaskId(task.getId());</span>
            }
            
        }
        
<span class="nc bnc" id="L428" title="All 4 branches missed.">        if (!isTaskRelatedEntityCountEnabled</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">                || (isTaskRelatedEntityCountEnabled &amp;&amp; ((CountingTaskEntity) task).getVariableCount() &gt; 0)) {</span>
            
<span class="nc" id="L431">            Map&lt;String, VariableInstanceEntity&gt; taskVariables = task.getVariableInstanceEntities();</span>
<span class="nc" id="L432">            List&lt;ByteArrayRef&gt; variableByteArrayRefs = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">            for (VariableInstanceEntity variableInstanceEntity : taskVariables.values()) {</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">                if (fireEvents) {</span>
<span class="nc" id="L435">                    eventDispatcher.dispatchEvent(FlowableVariableEventBuilder.createEntityEvent(FlowableEngineEventType.ENTITY_DELETED, variableInstanceEntity),</span>
<span class="nc" id="L436">                            processEngineConfiguration.getEngineCfgKey());</span>
                }
<span class="nc bnc" id="L438" title="All 4 branches missed.">                if (variableInstanceEntity.getByteArrayRef() != null &amp;&amp; variableInstanceEntity.getByteArrayRef().getId() != null) {</span>
<span class="nc" id="L439">                    variableByteArrayRefs.add(variableInstanceEntity.getByteArrayRef());</span>
                }
<span class="nc" id="L441">            }</span>
            
<span class="nc bnc" id="L443" title="All 2 branches missed.">            for (ByteArrayRef variableByteArrayRef : variableByteArrayRefs) {</span>
<span class="nc" id="L444">                processEngineConfiguration.getByteArrayEntityManager().deleteByteArrayById(variableByteArrayRef.getId());</span>
<span class="nc" id="L445">            }</span>
            
<span class="nc bnc" id="L447" title="All 2 branches missed.">            if (!taskVariables.isEmpty()) {</span>
<span class="nc" id="L448">                processEngineConfiguration.getVariableServiceConfiguration().getVariableService().deleteVariablesByTaskId(task.getId());</span>
            }
        }
<span class="nc" id="L451">    }</span>

    protected static void handleTaskHistory(TaskEntity task, String userId, String deleteReason, boolean cascade, CommandContext commandContext) {
<span class="nc bnc" id="L454" title="All 2 branches missed.">        if (cascade) {</span>
<span class="nc" id="L455">            deleteHistoricTask(task.getId());</span>
        } else {
<span class="nc" id="L457">            ExecutionEntity execution = null;</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">            if (task.getExecutionId() != null) {</span>
<span class="nc" id="L459">                execution = CommandContextUtil.getExecutionEntityManager(commandContext).findById(task.getExecutionId());</span>
            }
<span class="nc" id="L461">            CommandContextUtil.getHistoryManager(commandContext).recordTaskEnd(task, execution, userId, deleteReason, </span>
<span class="nc" id="L462">                    CommandContextUtil.getProcessEngineConfiguration(commandContext).getClock().getCurrentTime());</span>
        }
<span class="nc" id="L464">    }</span>

    protected static void executeTaskDelete(TaskEntity task, CommandContext commandContext) {
<span class="nc" id="L467">        ProcessEngineConfigurationImpl processEngineConfiguration = CommandContextUtil.getProcessEngineConfiguration(commandContext);</span>
<span class="nc" id="L468">        processEngineConfiguration.getTaskServiceConfiguration().getTaskService().deleteTask(task, false); // false: event will be sent out later</span>
   
<span class="nc bnc" id="L470" title="All 4 branches missed.">        if (task.getExecutionId() != null &amp;&amp; CountingEntityUtil.isExecutionRelatedEntityCountEnabledGlobally()) {</span>
<span class="nc" id="L471">            CountingExecutionEntity countingExecutionEntity = (CountingExecutionEntity) CommandContextUtil</span>
<span class="nc" id="L472">                    .getExecutionEntityManager(commandContext).findById(task.getExecutionId());</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">            if (CountingEntityUtil.isExecutionRelatedEntityCountEnabled(countingExecutionEntity)) {</span>
<span class="nc" id="L474">                countingExecutionEntity.setTaskCount(countingExecutionEntity.getTaskCount() - 1);</span>
            }
        }
<span class="nc" id="L477">    }</span>

    protected static void fireTaskDeletedEvent(TaskEntity task, CommandContext commandContext, FlowableEventDispatcher eventDispatcher) {
<span class="nc bnc" id="L480" title="All 4 branches missed.">        if (eventDispatcher != null &amp;&amp; eventDispatcher.isEnabled()) {</span>
<span class="nc" id="L481">            ProcessEngineConfigurationImpl processEngineConfiguration = CommandContextUtil.getProcessEngineConfiguration(commandContext);</span>
<span class="nc" id="L482">            CommandContextUtil.getEventDispatcher(commandContext).dispatchEvent(</span>
<span class="nc" id="L483">                    FlowableEventBuilder.createEntityEvent(FlowableEngineEventType.ENTITY_DELETED, task),</span>
<span class="nc" id="L484">                    processEngineConfiguration.getEngineCfgKey());</span>
        }
<span class="nc" id="L486">    }</span>

    public static void deleteTask(String taskId, String deleteReason, boolean cascade) {
<span class="nc" id="L489">        CommandContext commandContext = CommandContextUtil.getCommandContext();</span>
<span class="nc" id="L490">        ProcessEngineConfigurationImpl processEngineConfiguration = CommandContextUtil.getProcessEngineConfiguration(commandContext);</span>
<span class="nc" id="L491">        TaskEntity task = processEngineConfiguration.getTaskServiceConfiguration().getTaskService().getTask(taskId);</span>

<span class="nc bnc" id="L493" title="All 2 branches missed.">        if (task != null) {</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">            if (task.getExecutionId() != null) {</span>
<span class="nc" id="L495">                throw new FlowableException(&quot;The &quot; + task + &quot; cannot be deleted because is part of a running process&quot;);</span>
<span class="nc bnc" id="L496" title="All 4 branches missed.">            } else if (task.getScopeId() != null &amp;&amp; ScopeTypes.CMMN.equals(task.getScopeType())) {</span>
<span class="nc" id="L497">                throw new FlowableException(&quot;The &quot; + task + &quot; cannot be deleted because is part of a running case&quot;);</span>
            }

<span class="nc bnc" id="L500" title="All 2 branches missed.">            if (Flowable5Util.isFlowable5ProcessDefinitionId(commandContext, task.getProcessDefinitionId())) {</span>
<span class="nc" id="L501">                Flowable5CompatibilityHandler compatibilityHandler = Flowable5Util.getFlowable5CompatibilityHandler();</span>
<span class="nc" id="L502">                compatibilityHandler.deleteTask(taskId, deleteReason, cascade);</span>
<span class="nc" id="L503">                return;</span>
            }

<span class="nc" id="L506">            deleteTask(task, deleteReason, cascade, true, true);</span>

<span class="nc bnc" id="L508" title="All 2 branches missed.">        } else if (cascade) {</span>
<span class="nc" id="L509">            deleteHistoricTask(taskId);</span>
        }
<span class="nc" id="L511">    }</span>

    public static void deleteTasksByProcessInstanceId(String processInstanceId, String deleteReason, boolean cascade) {
<span class="nc" id="L514">        ProcessEngineConfigurationImpl processEngineConfiguration = CommandContextUtil.getProcessEngineConfiguration();</span>
<span class="nc" id="L515">        List&lt;TaskEntity&gt; tasks = processEngineConfiguration.getTaskServiceConfiguration().getTaskService().findTasksByProcessInstanceId(processInstanceId);</span>

<span class="nc bnc" id="L517" title="All 2 branches missed.">        for (TaskEntity task : tasks) {</span>
<span class="nc" id="L518">            FlowableEventDispatcher eventDispatcher = processEngineConfiguration.getEventDispatcher();</span>
<span class="nc bnc" id="L519" title="All 6 branches missed.">            if (eventDispatcher != null &amp;&amp; eventDispatcher.isEnabled() &amp;&amp; !task.isCanceled()) {</span>
<span class="nc" id="L520">                task.setCanceled(true);</span>

<span class="nc" id="L522">                ExecutionEntity execution = processEngineConfiguration.getExecutionEntityManager().findById(task.getExecutionId());</span>
<span class="nc" id="L523">                eventDispatcher</span>
<span class="nc" id="L524">                        .dispatchEvent(org.flowable.engine.delegate.event.impl.FlowableEventBuilder</span>
<span class="nc" id="L525">                                .createActivityCancelledEvent(execution.getActivityId(), task.getName(),</span>
<span class="nc" id="L526">                                        task.getExecutionId(), task.getProcessInstanceId(),</span>
<span class="nc" id="L527">                                        task.getProcessDefinitionId(), &quot;userTask&quot;, deleteReason),</span>
<span class="nc" id="L528">                                processEngineConfiguration.getEngineCfgKey());</span>
            }

<span class="nc" id="L531">            deleteTask(task, deleteReason, cascade, true, true);</span>
<span class="nc" id="L532">        }</span>
<span class="nc" id="L533">    }</span>

    public static void deleteHistoricTaskInstancesByProcessInstanceId(String processInstanceId) {
<span class="nc" id="L536">        ProcessEngineConfigurationImpl processEngineConfiguration = CommandContextUtil.getProcessEngineConfiguration();</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">        if (processEngineConfiguration.getHistoryManager().isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L538">            HistoricTaskService historicTaskService = processEngineConfiguration.getTaskServiceConfiguration().getHistoricTaskService();</span>
<span class="nc" id="L539">            List&lt;HistoricTaskInstanceEntity&gt; taskInstances = historicTaskService.findHistoricTasksByProcessInstanceId(processInstanceId);</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">            for (HistoricTaskInstanceEntity historicTaskInstanceEntity : taskInstances) {</span>
<span class="nc" id="L541">                deleteHistoricTask(historicTaskInstanceEntity.getId());</span>
<span class="nc" id="L542">            }</span>
        }
<span class="nc" id="L544">    }</span>
    
    public static void bulkDeleteHistoricTaskInstancesForProcessInstanceIds(Collection&lt;String&gt; processInstanceIds) {
<span class="nc" id="L547">        ProcessEngineConfigurationImpl processEngineConfiguration = CommandContextUtil.getProcessEngineConfiguration();</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">        if (processEngineConfiguration.getHistoryManager().isHistoryEnabled()) {</span>
<span class="nc" id="L549">            List&lt;String&gt; taskIds = processEngineConfiguration.getTaskServiceConfiguration().getHistoricTaskInstanceEntityManager()</span>
<span class="nc" id="L550">                    .findHistoricTaskIdsForProcessInstanceIds(processInstanceIds);</span>
            
<span class="nc bnc" id="L552" title="All 4 branches missed.">            if (taskIds != null &amp;&amp; !taskIds.isEmpty()) {</span>
<span class="nc" id="L553">                bulkDeleteHistoricTaskInstances(taskIds, processEngineConfiguration);</span>
            }
        }
<span class="nc" id="L556">    }</span>

    public static void deleteHistoricTask(String taskId) {
<span class="nc" id="L559">        ProcessEngineConfigurationImpl processEngineConfiguration = CommandContextUtil.getProcessEngineConfiguration();</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">        if (processEngineConfiguration.getHistoryManager().isHistoryEnabled()) {</span>
<span class="nc" id="L561">            processEngineConfiguration.getCommentEntityManager().deleteCommentsByTaskId(taskId);</span>
<span class="nc" id="L562">            processEngineConfiguration.getAttachmentEntityManager().deleteAttachmentsByTaskId(taskId);</span>

<span class="nc" id="L564">            HistoricTaskService historicTaskService = processEngineConfiguration.getTaskServiceConfiguration().getHistoricTaskService();</span>
<span class="nc" id="L565">            HistoricTaskInstanceEntity historicTaskInstance = historicTaskService.getHistoricTask(taskId);</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">            if (historicTaskInstance != null) {</span>

<span class="nc bnc" id="L568" title="All 2 branches missed.">                if (historicTaskInstance.getProcessDefinitionId() != null</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">                        &amp;&amp; Flowable5Util.isFlowable5ProcessDefinitionId(CommandContextUtil.getCommandContext(), historicTaskInstance.getProcessDefinitionId())) {</span>
<span class="nc" id="L570">                    Flowable5CompatibilityHandler compatibilityHandler = Flowable5Util.getFlowable5CompatibilityHandler();</span>
<span class="nc" id="L571">                    compatibilityHandler.deleteHistoricTask(taskId);</span>
<span class="nc" id="L572">                    return;</span>
                }

<span class="nc" id="L575">                List&lt;HistoricTaskInstanceEntity&gt; subTasks = historicTaskService.findHistoricTasksByParentTaskId(historicTaskInstance.getId());</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">                for (HistoricTaskInstance subTask : subTasks) {</span>
<span class="nc" id="L577">                    deleteHistoricTask(subTask.getId());</span>
<span class="nc" id="L578">                }</span>

<span class="nc" id="L580">                processEngineConfiguration.getHistoricDetailEntityManager().deleteHistoricDetailsByTaskId(taskId);</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">                if (processEngineConfiguration.getHistoryConfigurationSettings().isHistoryEnabledForVariables(historicTaskInstance)) {</span>
<span class="nc" id="L582">                    processEngineConfiguration.getVariableServiceConfiguration().getHistoricVariableService().deleteHistoricVariableInstancesByTaskId(taskId);</span>
                }
<span class="nc" id="L584">                processEngineConfiguration.getIdentityLinkServiceConfiguration().getHistoricIdentityLinkService().deleteHistoricIdentityLinksByTaskId(taskId);</span>

<span class="nc" id="L586">                historicTaskService.deleteHistoricTask(historicTaskInstance);</span>
            }
        }
<span class="nc" id="L589">        deleteHistoricTaskEventLogEntries(taskId);</span>
<span class="nc" id="L590">    }</span>

    public static void deleteHistoricTaskEventLogEntries(String taskId) {
<span class="nc" id="L593">        ProcessEngineConfigurationImpl processEngineConfiguration = CommandContextUtil.getProcessEngineConfiguration();</span>
<span class="nc" id="L594">        TaskServiceConfiguration taskServiceConfiguration = processEngineConfiguration.getTaskServiceConfiguration();</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">        if (taskServiceConfiguration.isEnableHistoricTaskLogging()) {</span>
<span class="nc" id="L596">            taskServiceConfiguration.getHistoricTaskService().deleteHistoricTaskLogEntriesForTaskId(taskId);</span>
        }
<span class="nc" id="L598">    }</span>

    public static boolean isFormFieldValidationEnabled(VariableContainer variableContainer,
            ProcessEngineConfigurationImpl processEngineConfiguration, String formFieldValidationExpression) {

<span class="nc bnc" id="L603" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(formFieldValidationExpression)) {</span>
<span class="nc" id="L604">            Boolean formFieldValidation = getBoolean(formFieldValidationExpression);</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">            if (formFieldValidation != null) {</span>
<span class="nc" id="L606">                return formFieldValidation;</span>
            }

<span class="nc bnc" id="L609" title="All 2 branches missed.">            if (variableContainer != null) {</span>
<span class="nc" id="L610">                ExpressionManager expressionManager = processEngineConfiguration.getExpressionManager();</span>
<span class="nc" id="L611">                Boolean formFieldValidationValue = getBoolean(</span>
<span class="nc" id="L612">                    expressionManager.createExpression(formFieldValidationExpression).getValue(variableContainer)</span>
                );
<span class="nc bnc" id="L614" title="All 2 branches missed.">                if (formFieldValidationValue == null) {</span>
<span class="nc" id="L615">                    throw new FlowableException(&quot;Unable to resolve formFieldValidationExpression to boolean value for &quot; + variableContainer);</span>
                }
<span class="nc" id="L617">                return formFieldValidationValue;</span>
            }
<span class="nc" id="L619">            throw new FlowableException(&quot;Unable to resolve formFieldValidationExpression without variable container&quot;);</span>
        }
<span class="nc" id="L621">        return true;</span>
    }
    
    protected static void bulkDeleteHistoricTaskInstances(Collection&lt;String&gt; taskIds, ProcessEngineConfigurationImpl processEngineConfiguration) {
<span class="nc" id="L625">        HistoricTaskService historicTaskService = processEngineConfiguration.getTaskServiceConfiguration().getHistoricTaskService();</span>
<span class="nc" id="L626">        List&lt;String&gt; subTaskIds = historicTaskService.findHistoricTaskIdsByParentTaskIds(taskIds);</span>
<span class="nc bnc" id="L627" title="All 4 branches missed.">        if (subTaskIds != null &amp;&amp; !subTaskIds.isEmpty()) {</span>
<span class="nc" id="L628">            bulkDeleteHistoricTaskInstances(subTaskIds, processEngineConfiguration);</span>
        }
        
<span class="nc" id="L631">        processEngineConfiguration.getCommentEntityManager().bulkDeleteCommentsForTaskIds(taskIds);</span>
<span class="nc" id="L632">        processEngineConfiguration.getAttachmentEntityManager().bulkDeleteAttachmentsByTaskId(taskIds);</span>
        
<span class="nc" id="L634">        processEngineConfiguration.getHistoricDetailEntityManager().bulkDeleteHistoricDetailsByTaskIds(taskIds);</span>
<span class="nc" id="L635">        processEngineConfiguration.getVariableServiceConfiguration().getHistoricVariableService().bulkDeleteHistoricVariableInstancesByTaskIds(taskIds);</span>
<span class="nc" id="L636">        processEngineConfiguration.getIdentityLinkServiceConfiguration().getHistoricIdentityLinkService().bulkDeleteHistoricIdentityLinksForTaskIds(taskIds);</span>

<span class="nc" id="L638">        historicTaskService.bulkDeleteHistoricTaskInstances(taskIds);</span>
<span class="nc" id="L639">        historicTaskService.bulkDeleteHistoricTaskLogEntriesForTaskIds(taskIds);</span>
<span class="nc" id="L640">    }</span>

    protected static Boolean getBoolean(Object booleanObject) {
<span class="nc bnc" id="L643" title="All 2 branches missed.">        if (booleanObject instanceof Boolean) {</span>
<span class="nc" id="L644">            return (Boolean) booleanObject;</span>
        }
<span class="nc bnc" id="L646" title="All 2 branches missed.">        if (booleanObject instanceof String) {</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">            if (&quot;true&quot;.equalsIgnoreCase((String) booleanObject)) {</span>
<span class="nc" id="L648">                return Boolean.TRUE;</span>
            }
<span class="nc bnc" id="L650" title="All 2 branches missed.">            if (&quot;false&quot;.equalsIgnoreCase((String) booleanObject)) {</span>
<span class="nc" id="L651">                return Boolean.FALSE;</span>
            }
        }
<span class="nc" id="L654">        return null;</span>
    }

    protected static void fireAssignmentEvents(TaskEntity taskEntity) {
<span class="nc" id="L658">        ProcessEngineConfigurationImpl processEngineConfiguration = CommandContextUtil.getProcessEngineConfiguration();</span>
        try {
<span class="nc" id="L660">            processEngineConfiguration.getListenerNotificationHelper().executeTaskListeners(taskEntity, TaskListener.EVENTNAME_ASSIGNMENT);</span>
<span class="nc" id="L661">        } catch (BpmnError e) {</span>
<span class="nc" id="L662">            ErrorPropagation.propagateError(e, CommandContextUtil.getExecutionEntityManager().findById(taskEntity.getExecutionId()));</span>
<span class="nc" id="L663">        }</span>

<span class="nc" id="L665">        FlowableEventDispatcher eventDispatcher = processEngineConfiguration.getEventDispatcher();</span>
<span class="nc bnc" id="L666" title="All 4 branches missed.">        if (eventDispatcher != null &amp;&amp; eventDispatcher.isEnabled()) {</span>
<span class="nc" id="L667">            eventDispatcher.dispatchEvent(FlowableEventBuilder.createEntityEvent(FlowableEngineEventType.TASK_ASSIGNED, taskEntity),</span>
<span class="nc" id="L668">                    processEngineConfiguration.getEngineCfgKey());</span>
        }
<span class="nc" id="L670">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>