<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CustomEventProcessingPipelineTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.eventregistry.test</a> &gt; <span class="el_source">CustomEventProcessingPipelineTest.java</span></div><h1>CustomEventProcessingPipelineTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.eventregistry.test;

import static org.assertj.core.api.Assertions.assertThat;

import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.atomic.AtomicInteger;

import org.flowable.eventregistry.api.EventRegistry;
import org.flowable.eventregistry.api.EventRegistryEvent;
import org.flowable.eventregistry.api.FlowableEventInfo;
import org.flowable.eventregistry.api.InboundEvent;
import org.flowable.eventregistry.api.InboundEventChannelAdapter;
import org.flowable.eventregistry.api.InboundEventDeserializer;
import org.flowable.eventregistry.api.InboundEventFilter;
import org.flowable.eventregistry.api.InboundEventKeyDetector;
import org.flowable.eventregistry.api.InboundEventPayloadExtractor;
import org.flowable.eventregistry.api.InboundEventProcessingPipeline;
import org.flowable.eventregistry.api.InboundEventTenantDetector;
import org.flowable.eventregistry.api.InboundEventTransformer;
import org.flowable.eventregistry.api.OutboundEventChannelAdapter;
import org.flowable.eventregistry.api.OutboundEventProcessingPipeline;
import org.flowable.eventregistry.api.OutboundEventSerializer;
import org.flowable.eventregistry.api.runtime.EventInstance;
import org.flowable.eventregistry.api.runtime.EventPayloadInstance;
import org.flowable.eventregistry.impl.runtime.EventInstanceImpl;
import org.flowable.eventregistry.model.ChannelModel;
import org.flowable.eventregistry.model.EventModel;
import org.flowable.eventregistry.model.InboundChannelModel;
import org.flowable.eventregistry.model.OutboundChannelModel;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

/**
 * @author Joram Barrez
 * @author Aleksandar Matic
 */
<span class="nc" id="L54">public class CustomEventProcessingPipelineTest extends AbstractFlowableEventTest {</span>

    protected Map&lt;Object, Object&gt; initialBeans;

    @BeforeEach
    void setup() {
<span class="nc" id="L60">        eventEngineConfiguration.setFallbackToDefaultTenant(true);</span>
<span class="nc" id="L61">        initialBeans = eventEngineConfiguration.getExpressionManager().getBeans();</span>
<span class="nc" id="L62">        eventEngineConfiguration.getExpressionManager().setBeans(new HashMap&lt;&gt;());</span>
<span class="nc" id="L63">    }</span>

    @AfterEach
    public void cleanup () {
<span class="nc" id="L67">        eventRegistryEngine.getEventRepositoryService().createDeploymentQuery().list()</span>
<span class="nc" id="L68">            .forEach(eventDeployment -&gt; eventRegistryEngine.getEventRepositoryService().deleteDeployment(eventDeployment.getId()));</span>

<span class="nc" id="L70">        eventEngineConfiguration.getExpressionManager().setBeans(initialBeans);</span>
<span class="nc" id="L71">        eventEngineConfiguration.setFallbackToDefaultTenant(false);</span>
<span class="nc" id="L72">    }</span>

    @Test
    public void testCustomInboundPipelineComponentsInvoked() {

<span class="nc" id="L77">        TestInboundChannelAdapter testInboundChannelAdapter = new TestInboundChannelAdapter();</span>
<span class="nc" id="L78">        TestInboundEventDeserializer testInboundEventDeserializer = new TestInboundEventDeserializer();</span>
<span class="nc" id="L79">        TestInboundEventFilter testInboundEventFilter = new TestInboundEventFilter(true);</span>
<span class="nc" id="L80">        TestInboundEventKeyDetector testInboundEventKeyDetector = new TestInboundEventKeyDetector();</span>
<span class="nc" id="L81">        TestInboundEventTenantDetector testInboundEventTenantDetector = new TestInboundEventTenantDetector();</span>
<span class="nc" id="L82">        TestInboundEventPayloadExtractor testInboundEventPayloadExtractor = new TestInboundEventPayloadExtractor();</span>
<span class="nc" id="L83">        TestInboundEventTransformer testInboundEventTransformer = new TestInboundEventTransformer();</span>

<span class="nc" id="L85">        Map&lt;Object, Object&gt; beans = eventEngineConfiguration.getExpressionManager().getBeans();</span>
<span class="nc" id="L86">        beans.put(&quot;testInboundChannelAdapter&quot;, testInboundChannelAdapter);</span>
<span class="nc" id="L87">        beans.put(&quot;testInboundEventDeserializer&quot;, testInboundEventDeserializer);</span>
<span class="nc" id="L88">        beans.put(&quot;testInboundEventFilter&quot;, testInboundEventFilter);</span>
<span class="nc" id="L89">        beans.put(&quot;testInboundEventKeyDetector&quot;, testInboundEventKeyDetector);</span>
<span class="nc" id="L90">        beans.put(&quot;testInboundEventTenantDetector&quot;, testInboundEventTenantDetector);</span>
<span class="nc" id="L91">        beans.put(&quot;testInboundEventPayloadExtractor&quot;, testInboundEventPayloadExtractor);</span>
<span class="nc" id="L92">        beans.put(&quot;testInboundEventTransformer&quot;, testInboundEventTransformer);</span>

<span class="nc" id="L94">        eventRegistryEngine.getEventRepositoryService().createInboundChannelModelBuilder()</span>
<span class="nc" id="L95">            .key(&quot;customTestChannel&quot;)</span>
<span class="nc" id="L96">            .resourceName(&quot;customTest.channel&quot;)</span>
<span class="nc" id="L97">            .channelAdapter(&quot;${testInboundChannelAdapter}&quot;)</span>
<span class="nc" id="L98">            .delegateExpressionDeserializer(&quot;${testInboundEventDeserializer}&quot;)</span>
<span class="nc" id="L99">            .delegateExpressionKeyDetector(&quot;${testInboundEventKeyDetector}&quot;)</span>
<span class="nc" id="L100">            .delegateExpressionEventFilter(&quot;${testInboundEventFilter}&quot;)</span>
<span class="nc" id="L101">            .delegateExpressionTenantDetector(&quot;${testInboundEventTenantDetector}&quot;)</span>
<span class="nc" id="L102">            .payloadExtractor(&quot;${testInboundEventPayloadExtractor}&quot;)</span>
<span class="nc" id="L103">            .transformer(&quot;${testInboundEventTransformer}&quot;)</span>
<span class="nc" id="L104">            .deploy();</span>

<span class="nc" id="L106">        eventRegistryEngine.getEventRepositoryService().createEventModelBuilder()</span>
<span class="nc" id="L107">            .key(&quot;testKey&quot;)</span>
<span class="nc" id="L108">            .deploymentTenantId(&quot;testTenantId&quot;)</span>
<span class="nc" id="L109">            .resourceName(&quot;myEvent.event&quot;)</span>
<span class="nc" id="L110">            .deploy();</span>

<span class="nc" id="L112">        testInboundChannelAdapter.trigger(&quot;testEvent&quot;);</span>

<span class="nc" id="L114">        assertThat(testInboundEventDeserializer.counter.get()).isEqualTo(1);</span>
<span class="nc" id="L115">        assertThat(testInboundEventFilter.counter.get()).isEqualTo(1);</span>
<span class="nc" id="L116">        assertThat(testInboundEventKeyDetector.counter.get()).isEqualTo(1);</span>
<span class="nc" id="L117">        assertThat(testInboundEventTenantDetector.counter.get()).isEqualTo(1);</span>
<span class="nc" id="L118">        assertThat(testInboundEventPayloadExtractor.payloadCounter.get()).isEqualTo(1);</span>
<span class="nc" id="L119">        assertThat(testInboundEventTransformer.counter.get()).isEqualTo(1);</span>

<span class="nc" id="L121">    }</span>

    @Test
    public void testCustomInboundEventDroppingFilter() {

<span class="nc" id="L126">        TestInboundChannelAdapter testInboundChannelAdapter = new TestInboundChannelAdapter();</span>
<span class="nc" id="L127">        TestInboundEventDeserializer testInboundEventDeserializer = new TestInboundEventDeserializer();</span>
<span class="nc" id="L128">        TestInboundEventFilter testInboundEventFilter = new TestInboundEventFilter(false);</span>
<span class="nc" id="L129">        TestInboundEventKeyDetector testInboundEventKeyDetector = new TestInboundEventKeyDetector();</span>
<span class="nc" id="L130">        TestInboundEventTenantDetector testInboundEventTenantDetector = new TestInboundEventTenantDetector();</span>
<span class="nc" id="L131">        TestInboundEventPayloadExtractor testInboundEventPayloadExtractor = new TestInboundEventPayloadExtractor();</span>
<span class="nc" id="L132">        TestInboundEventTransformer testInboundEventTransformer = new TestInboundEventTransformer();</span>

<span class="nc" id="L134">        Map&lt;Object, Object&gt; beans = eventEngineConfiguration.getExpressionManager().getBeans();</span>
<span class="nc" id="L135">        beans.put(&quot;testInboundChannelAdapter&quot;, testInboundChannelAdapter);</span>
<span class="nc" id="L136">        beans.put(&quot;testInboundEventDeserializer&quot;, testInboundEventDeserializer);</span>
<span class="nc" id="L137">        beans.put(&quot;testInboundEventFilter&quot;, testInboundEventFilter);</span>
<span class="nc" id="L138">        beans.put(&quot;testInboundEventKeyDetector&quot;, testInboundEventKeyDetector);</span>
<span class="nc" id="L139">        beans.put(&quot;testInboundEventTenantDetector&quot;, testInboundEventTenantDetector);</span>
<span class="nc" id="L140">        beans.put(&quot;testInboundEventPayloadExtractor&quot;, testInboundEventPayloadExtractor);</span>
<span class="nc" id="L141">        beans.put(&quot;testInboundEventTransformer&quot;, testInboundEventTransformer);</span>

<span class="nc" id="L143">        eventRegistryEngine.getEventRepositoryService().createInboundChannelModelBuilder()</span>
<span class="nc" id="L144">            .key(&quot;customTestChannel&quot;)</span>
<span class="nc" id="L145">            .resourceName(&quot;customTest.channel&quot;)</span>
<span class="nc" id="L146">            .channelAdapter(&quot;${testInboundChannelAdapter}&quot;)</span>
<span class="nc" id="L147">            .delegateExpressionDeserializer(&quot;${testInboundEventDeserializer}&quot;)</span>
<span class="nc" id="L148">            .delegateExpressionKeyDetector(&quot;${testInboundEventKeyDetector}&quot;)</span>
<span class="nc" id="L149">            .delegateExpressionEventFilter(&quot;${testInboundEventFilter}&quot;)</span>
<span class="nc" id="L150">            .delegateExpressionTenantDetector(&quot;${testInboundEventTenantDetector}&quot;)</span>
<span class="nc" id="L151">            .payloadExtractor(&quot;${testInboundEventPayloadExtractor}&quot;)</span>
<span class="nc" id="L152">            .transformer(&quot;${testInboundEventTransformer}&quot;)</span>
<span class="nc" id="L153">            .deploy();</span>

<span class="nc" id="L155">        eventRegistryEngine.getEventRepositoryService().createEventModelBuilder()</span>
<span class="nc" id="L156">            .key(&quot;testKey&quot;)</span>
<span class="nc" id="L157">            .deploymentTenantId(&quot;testTenantId&quot;)</span>
<span class="nc" id="L158">            .resourceName(&quot;myEvent.event&quot;)</span>
<span class="nc" id="L159">            .deploy();</span>

<span class="nc" id="L161">        testInboundChannelAdapter.trigger(&quot;testEvent&quot;);</span>

<span class="nc" id="L163">        assertThat(testInboundEventDeserializer.counter.get()).isEqualTo(1);</span>
<span class="nc" id="L164">        assertThat(testInboundEventFilter.counter.get()).isEqualTo(1);</span>
<span class="nc" id="L165">        assertThat(testInboundEventKeyDetector.counter.get()).isEqualTo(1);</span>
<span class="nc" id="L166">        assertThat(testInboundEventTenantDetector.counter.get()).isEqualTo(0);</span>
<span class="nc" id="L167">        assertThat(testInboundEventPayloadExtractor.payloadCounter.get()).isEqualTo(0);</span>
<span class="nc" id="L168">        assertThat(testInboundEventTransformer.counter.get()).isEqualTo(0);</span>

<span class="nc" id="L170">    }</span>

    @Test
    public void testCustomInboundPipelineInvoked() {

<span class="nc" id="L175">        TestInboundChannelAdapter testInboundChannelAdapter = new TestInboundChannelAdapter();</span>
<span class="nc" id="L176">        TestInboundEventProcessingPipeline testInboundEventProcessingPipeline = new TestInboundEventProcessingPipeline();</span>

<span class="nc" id="L178">        Map&lt;Object, Object&gt; beans = eventEngineConfiguration.getExpressionManager().getBeans();</span>
<span class="nc" id="L179">        beans.put(&quot;testInboundChannelAdapter&quot;, testInboundChannelAdapter);</span>
<span class="nc" id="L180">        beans.put(&quot;testInboundEventProcessingPipeline&quot;, testInboundEventProcessingPipeline);</span>

<span class="nc" id="L182">        eventRegistryEngine.getEventRepositoryService().createInboundChannelModelBuilder()</span>
<span class="nc" id="L183">            .key(&quot;customTestChannel&quot;)</span>
<span class="nc" id="L184">            .resourceName(&quot;customTest.channel&quot;)</span>
<span class="nc" id="L185">            .channelAdapter(&quot;${testInboundChannelAdapter}&quot;)</span>
<span class="nc" id="L186">            .eventProcessingPipeline(&quot;${testInboundEventProcessingPipeline}&quot;)</span>
<span class="nc" id="L187">            .deploy();</span>

<span class="nc" id="L189">        eventRegistryEngine.getEventRepositoryService().createEventModelBuilder()</span>
<span class="nc" id="L190">            .key(&quot;testKey&quot;)</span>
<span class="nc" id="L191">            .deploymentTenantId(&quot;testTenantId&quot;)</span>
<span class="nc" id="L192">            .resourceName(&quot;myEvent.event&quot;)</span>
<span class="nc" id="L193">            .deploy();</span>

<span class="nc" id="L195">        testInboundChannelAdapter.trigger(&quot;testEvent&quot;);</span>

<span class="nc" id="L197">        assertThat(testInboundEventProcessingPipeline.counter.get()).isEqualTo(1);</span>

<span class="nc" id="L199">    }</span>

    @Test
    public void testCustomInboundPipelineResolvedFromTenantId() {

<span class="nc" id="L204">        TestInboundChannelAdapter testInboundChannelAdapterAcme = new TestInboundChannelAdapter();</span>
<span class="nc" id="L205">        TestInboundChannelAdapter testInboundChannelAdapterMegacorp = new TestInboundChannelAdapter();</span>
<span class="nc" id="L206">        TestInboundEventProcessingPipeline testInboundEventProcessingPipeline = new TestInboundEventProcessingPipeline();</span>

<span class="nc" id="L208">        Map&lt;String, TestInboundChannelAdapter&gt; adapters = new HashMap&lt;&gt;();</span>
<span class="nc" id="L209">        adapters.put(&quot;acme&quot;, testInboundChannelAdapterAcme);</span>
<span class="nc" id="L210">        adapters.put(&quot;megacorp&quot;, testInboundChannelAdapterMegacorp);</span>
<span class="nc" id="L211">        Map&lt;Object, Object&gt; beans = eventEngineConfiguration.getExpressionManager().getBeans();</span>
<span class="nc" id="L212">        beans.put(&quot;adapters&quot;, adapters);</span>
<span class="nc" id="L213">        beans.put(&quot;testInboundEventProcessingPipeline&quot;, testInboundEventProcessingPipeline);</span>

<span class="nc" id="L215">        eventRegistryEngine.getEventRepositoryService().createInboundChannelModelBuilder()</span>
<span class="nc" id="L216">                .key(&quot;customTestChannel&quot;)</span>
<span class="nc" id="L217">                .resourceName(&quot;customTest.channel&quot;)</span>
<span class="nc" id="L218">                .channelAdapter(&quot;${adapters.get(tenantId)}&quot;)</span>
<span class="nc" id="L219">                .eventProcessingPipeline(&quot;${testInboundEventProcessingPipeline}&quot;)</span>
<span class="nc" id="L220">                .deploymentTenantId(&quot;acme&quot;)</span>
<span class="nc" id="L221">                .deploy();</span>

<span class="nc" id="L223">        eventRegistryEngine.getEventRepositoryService().createInboundChannelModelBuilder()</span>
<span class="nc" id="L224">                .key(&quot;customTestChannel&quot;)</span>
<span class="nc" id="L225">                .resourceName(&quot;customTest.channel&quot;)</span>
<span class="nc" id="L226">                .channelAdapter(&quot;${adapters.get(variableContainer.tenantId)}&quot;)</span>
<span class="nc" id="L227">                .eventProcessingPipeline(&quot;${testInboundEventProcessingPipeline}&quot;)</span>
<span class="nc" id="L228">                .deploymentTenantId(&quot;megacorp&quot;)</span>
<span class="nc" id="L229">                .deploy();</span>

<span class="nc" id="L231">        eventRegistryEngine.getEventRepositoryService().createEventModelBuilder()</span>
<span class="nc" id="L232">                .key(&quot;testKey&quot;)</span>
<span class="nc" id="L233">                .resourceName(&quot;myEvent.event&quot;)</span>
<span class="nc" id="L234">                .deploy();</span>

<span class="nc" id="L236">        testInboundChannelAdapterAcme.trigger(&quot;testEvent&quot;);</span>
<span class="nc" id="L237">        assertThat(testInboundEventProcessingPipeline.counter.get()).isEqualTo(1);</span>

<span class="nc" id="L239">        testInboundChannelAdapterMegacorp.trigger(&quot;testEvent&quot;);</span>
<span class="nc" id="L240">        assertThat(testInboundEventProcessingPipeline.counter.get()).isEqualTo(2);</span>

<span class="nc" id="L242">        InboundChannelModel acmeChannel = (InboundChannelModel) eventRegistryEngine</span>
<span class="nc" id="L243">                .getEventRepositoryService()</span>
<span class="nc" id="L244">                .getChannelModelByKey(&quot;customTestChannel&quot;, &quot;acme&quot;);</span>

<span class="nc" id="L246">        InboundChannelModel megacorpChannel = (InboundChannelModel) eventRegistryEngine</span>
<span class="nc" id="L247">                .getEventRepositoryService()</span>
<span class="nc" id="L248">                .getChannelModelByKey(&quot;customTestChannel&quot;, &quot;megacorp&quot;);</span>

<span class="nc" id="L250">        assertThat(acmeChannel.getInboundEventChannelAdapter()).isEqualTo(testInboundChannelAdapterAcme);</span>
<span class="nc" id="L251">        assertThat(megacorpChannel.getInboundEventChannelAdapter()).isEqualTo(testInboundChannelAdapterMegacorp);</span>
<span class="nc" id="L252">    }</span>

    @Test
    public void testCustomOutboundPipelineComponentsInvoked() {

<span class="nc" id="L257">        TestOutboundChannelAdapter testOutboundChannelAdapter = new TestOutboundChannelAdapter();</span>
<span class="nc" id="L258">        TestOutboundEventSerializer testOutboundEventSerializer = new TestOutboundEventSerializer();</span>

<span class="nc" id="L260">        Map&lt;Object, Object&gt; beans = eventEngineConfiguration.getExpressionManager().getBeans();</span>
<span class="nc" id="L261">        beans.put(&quot;testOutboundChannelAdapter&quot;, testOutboundChannelAdapter);</span>
<span class="nc" id="L262">        beans.put(&quot;testOutboundEventSerializer&quot;, testOutboundEventSerializer);</span>

<span class="nc" id="L264">        eventRegistryEngine.getEventRepositoryService().createOutboundChannelModelBuilder()</span>
<span class="nc" id="L265">            .key(&quot;customTestOutboundChannel&quot;)</span>
<span class="nc" id="L266">            .resourceName(&quot;customOutboundTest.channel&quot;)</span>
<span class="nc" id="L267">            .channelAdapter(&quot;${testOutboundChannelAdapter}&quot;)</span>
<span class="nc" id="L268">            .delegateExpressionSerializer(&quot;${testOutboundEventSerializer}&quot;)</span>
<span class="nc" id="L269">            .deploy();</span>

<span class="nc" id="L271">        eventRegistryEngine.getEventRepositoryService().createEventModelBuilder()</span>
<span class="nc" id="L272">            .key(&quot;testKey&quot;)</span>
<span class="nc" id="L273">            .deploymentTenantId(&quot;testTenantId&quot;)</span>
<span class="nc" id="L274">            .resourceName(&quot;myEvent.event&quot;)</span>
<span class="nc" id="L275">            .deploy();</span>
        
<span class="nc" id="L277">        EventModel eventModel = eventRegistryEngine.getEventRepositoryService().getEventModelByKey(&quot;testKey&quot;, &quot;testTenantId&quot;);</span>
<span class="nc" id="L278">        ChannelModel channelModel = eventRegistryEngine.getEventRepositoryService().getChannelModelByKey(&quot;customTestOutboundChannel&quot;);</span>

<span class="nc" id="L280">        EventInstanceImpl eventInstance = new EventInstanceImpl(eventModel.getKey(), Collections.emptyList(), &quot;testTenantId&quot;);</span>
<span class="nc" id="L281">        eventRegistryEngine.getEventRegistry().sendEventOutbound(eventInstance, Collections.singleton(channelModel));</span>

<span class="nc" id="L283">        assertThat(testOutboundChannelAdapter.counter.get()).isEqualTo(1);</span>
<span class="nc" id="L284">        assertThat(testOutboundEventSerializer.counter.get()).isEqualTo(1);</span>
<span class="nc" id="L285">    }</span>

    @Test
    public void testCustomOutboundPipelineInvoked() {

<span class="nc" id="L290">        TestOutboundChannelAdapter testOutboundChannelAdapter = new TestOutboundChannelAdapter();</span>
<span class="nc" id="L291">        TestOutboundEventProcessingPipeline testOutboundEventProcessingPipeline = new TestOutboundEventProcessingPipeline();</span>

<span class="nc" id="L293">        Map&lt;Object, Object&gt; beans = eventEngineConfiguration.getExpressionManager().getBeans();</span>
<span class="nc" id="L294">        beans.put(&quot;testOutboundChannelAdapter&quot;, testOutboundChannelAdapter);</span>
<span class="nc" id="L295">        beans.put(&quot;testOutboundEventProcessingPipeline&quot;, testOutboundEventProcessingPipeline);</span>

<span class="nc" id="L297">        eventRegistryEngine.getEventRepositoryService().createOutboundChannelModelBuilder()</span>
<span class="nc" id="L298">            .key(&quot;customTestOutboundChannel&quot;)</span>
<span class="nc" id="L299">            .resourceName(&quot;customOutboundTest.channel&quot;)</span>
<span class="nc" id="L300">            .channelAdapter(&quot;${testOutboundChannelAdapter}&quot;)</span>
<span class="nc" id="L301">            .eventProcessingPipeline(&quot;${testOutboundEventProcessingPipeline}&quot;)</span>
<span class="nc" id="L302">            .deploy();</span>

<span class="nc" id="L304">        eventRegistryEngine.getEventRepositoryService().createEventModelBuilder()</span>
<span class="nc" id="L305">            .key(&quot;testKey&quot;)</span>
<span class="nc" id="L306">            .deploymentTenantId(&quot;testTenantId&quot;)</span>
<span class="nc" id="L307">            .resourceName(&quot;myEvent.event&quot;)</span>
<span class="nc" id="L308">            .deploy();</span>

<span class="nc" id="L310">        EventModel eventModel = eventRegistryEngine.getEventRepositoryService().getEventModelByKey(&quot;testKey&quot;, &quot;testTenantId&quot;);</span>
<span class="nc" id="L311">        ChannelModel channelModel = eventRegistryEngine.getEventRepositoryService().getChannelModelByKey(&quot;customTestOutboundChannel&quot;);</span>

<span class="nc" id="L313">        EventInstanceImpl eventInstance = new EventInstanceImpl(eventModel.getKey(), Collections.emptyList(), &quot;testTenantId&quot;);</span>
<span class="nc" id="L314">        eventRegistryEngine.getEventRegistry().sendEventOutbound(eventInstance, Collections.singleton(channelModel));</span>

<span class="nc" id="L316">        assertThat(testOutboundChannelAdapter.counter.get()).isEqualTo(1);</span>
<span class="nc" id="L317">        assertThat(testOutboundEventProcessingPipeline.counter.get()).isEqualTo(1);</span>
<span class="nc" id="L318">    }</span>

    @Test
    public void testCustomOutboundPipelineResolvedFromTenantId() {

<span class="nc" id="L323">        TestOutboundChannelAdapter testOutboundChannelAdapterAcme = new TestOutboundChannelAdapter();</span>
<span class="nc" id="L324">        TestOutboundChannelAdapter testOutboundChannelAdapterMegacorp = new TestOutboundChannelAdapter();</span>
<span class="nc" id="L325">        TestOutboundEventProcessingPipeline testOutboundEventProcessingPipeline = new TestOutboundEventProcessingPipeline();</span>

<span class="nc" id="L327">        Map&lt;String, TestOutboundChannelAdapter&gt; adapters = new HashMap&lt;&gt;();</span>
<span class="nc" id="L328">        adapters.put(&quot;acme&quot;, testOutboundChannelAdapterAcme);</span>
<span class="nc" id="L329">        adapters.put(&quot;megacorp&quot;, testOutboundChannelAdapterMegacorp);</span>
<span class="nc" id="L330">        Map&lt;Object, Object&gt; beans = eventEngineConfiguration.getExpressionManager().getBeans();</span>
<span class="nc" id="L331">        beans.put(&quot;adapters&quot;, adapters);</span>
<span class="nc" id="L332">        beans.put(&quot;testOutboundEventProcessingPipeline&quot;, testOutboundEventProcessingPipeline);</span>

<span class="nc" id="L334">        eventRegistryEngine.getEventRepositoryService().createOutboundChannelModelBuilder()</span>
<span class="nc" id="L335">                .key(&quot;customTestOutboundChannel&quot;)</span>
<span class="nc" id="L336">                .resourceName(&quot;customOutboundTest.channel&quot;)</span>
<span class="nc" id="L337">                .channelAdapter(&quot;${adapters.get(tenantId)}&quot;)</span>
<span class="nc" id="L338">                .eventProcessingPipeline(&quot;${testOutboundEventProcessingPipeline}&quot;)</span>
<span class="nc" id="L339">                .deploymentTenantId(&quot;acme&quot;)</span>
<span class="nc" id="L340">                .deploy();</span>

<span class="nc" id="L342">        eventRegistryEngine.getEventRepositoryService().createOutboundChannelModelBuilder()</span>
<span class="nc" id="L343">                .key(&quot;customTestOutboundChannel&quot;)</span>
<span class="nc" id="L344">                .resourceName(&quot;customOutboundTest.channel&quot;)</span>
<span class="nc" id="L345">                .channelAdapter(&quot;${adapters.get(variableContainer.tenantId)}&quot;)</span>
<span class="nc" id="L346">                .eventProcessingPipeline(&quot;${testOutboundEventProcessingPipeline}&quot;)</span>
<span class="nc" id="L347">                .deploymentTenantId(&quot;megacorp&quot;)</span>
<span class="nc" id="L348">                .deploy();</span>

<span class="nc" id="L350">        eventRegistryEngine.getEventRepositoryService().createEventModelBuilder()</span>
<span class="nc" id="L351">                .key(&quot;testKey&quot;)</span>
<span class="nc" id="L352">                .resourceName(&quot;myEvent.event&quot;)</span>
<span class="nc" id="L353">                .deploy();</span>

<span class="nc" id="L355">        OutboundChannelModel acmeChannel = (OutboundChannelModel) eventRegistryEngine.getEventRepositoryService()</span>
<span class="nc" id="L356">                .getChannelModelByKey(&quot;customTestOutboundChannel&quot;, &quot;acme&quot;);</span>
<span class="nc" id="L357">        OutboundChannelModel megacorpChannel = (OutboundChannelModel) eventRegistryEngine.getEventRepositoryService()</span>
<span class="nc" id="L358">                .getChannelModelByKey(&quot;customTestOutboundChannel&quot;, &quot;megacorp&quot;);</span>

<span class="nc" id="L360">        EventInstanceImpl eventInstance = new EventInstanceImpl(&quot;testKey&quot;, Collections.emptyList());</span>
<span class="nc" id="L361">        eventRegistryEngine.getEventRegistry().sendEventOutbound(eventInstance, Arrays.asList(acmeChannel, megacorpChannel));</span>

<span class="nc" id="L363">        assertThat(testOutboundChannelAdapterAcme.counter.get()).isEqualTo(1);</span>
<span class="nc" id="L364">        assertThat(testOutboundChannelAdapterMegacorp.counter.get()).isEqualTo(1);</span>
<span class="nc" id="L365">        assertThat(testOutboundEventProcessingPipeline.counter.get()).isEqualTo(2);</span>

<span class="nc" id="L367">        assertThat(acmeChannel.getOutboundEventChannelAdapter()).isEqualTo(testOutboundChannelAdapterAcme);</span>
<span class="nc" id="L368">        assertThat(megacorpChannel.getOutboundEventChannelAdapter()).isEqualTo(testOutboundChannelAdapterMegacorp);</span>
<span class="nc" id="L369">    }</span>

    private static class TestInboundChannelAdapter implements InboundEventChannelAdapter {

        private InboundChannelModel inboundChannelModel;
        private EventRegistry eventRegistry;

        public void trigger(String event) {
<span class="nc" id="L377">            eventRegistry.eventReceived(inboundChannelModel, event);</span>
<span class="nc" id="L378">        }</span>

        @Override
        public void setInboundChannelModel(InboundChannelModel inboundChannelModel) {
<span class="nc" id="L382">            this.inboundChannelModel = inboundChannelModel;</span>
<span class="nc" id="L383">        }</span>
        @Override
        public void setEventRegistry(EventRegistry eventRegistry) {
<span class="nc" id="L386">            this.eventRegistry = eventRegistry;</span>
<span class="nc" id="L387">        }</span>
    }

<span class="nc" id="L390">    private static class TestInboundEventDeserializer implements InboundEventDeserializer&lt;String&gt; {</span>

<span class="nc" id="L392">        public AtomicInteger counter = new AtomicInteger(0);</span>

        @Override
        public String deserialize(Object rawEvent) {
<span class="nc" id="L396">            counter.incrementAndGet();</span>
<span class="nc" id="L397">            return rawEvent.toString();</span>
        }

    }

    private static class TestInboundEventFilter implements InboundEventFilter&lt;String&gt; {

<span class="nc" id="L404">        public AtomicInteger counter = new AtomicInteger(0);</span>
        protected final boolean filter;

<span class="nc" id="L407">        private TestInboundEventFilter(boolean filter) {</span>
<span class="nc" id="L408">            this.filter = filter;</span>
<span class="nc" id="L409">        }</span>

        @Override
        public boolean retain(String eventDefinitionKey, FlowableEventInfo&lt;String&gt; event) {
<span class="nc" id="L413">            counter.incrementAndGet();</span>
<span class="nc" id="L414">            return filter;</span>
        }
    }


<span class="nc" id="L419">    private static class TestInboundEventKeyDetector implements InboundEventKeyDetector&lt;String&gt; {</span>

<span class="nc" id="L421">        public AtomicInteger counter = new AtomicInteger(0);</span>

        @Override
        public String detectEventDefinitionKey(String payload) {
<span class="nc" id="L425">            counter.incrementAndGet();</span>
<span class="nc" id="L426">            return &quot;testKey&quot;;</span>
        }
    }

<span class="nc" id="L430">    private static class TestInboundEventTenantDetector implements InboundEventTenantDetector&lt;String&gt; {</span>

<span class="nc" id="L432">        public AtomicInteger counter = new AtomicInteger(0);</span>

        @Override
        public String detectTenantId(String payload) {
<span class="nc" id="L436">            counter.incrementAndGet();</span>
<span class="nc" id="L437">            return &quot;testTenantId&quot;;</span>
        }
    }

<span class="nc" id="L441">    private static class TestInboundEventPayloadExtractor implements InboundEventPayloadExtractor&lt;String&gt; {</span>

<span class="nc" id="L443">        public AtomicInteger payloadCounter = new AtomicInteger(0);</span>

        @Override
        public Collection&lt;EventPayloadInstance&gt; extractPayload(EventModel eventModel, String payload) {
<span class="nc" id="L447">            payloadCounter.incrementAndGet();</span>
<span class="nc" id="L448">            return Collections.emptyList();</span>
        }
    }

<span class="nc" id="L452">    private static class TestInboundEventTransformer implements InboundEventTransformer {</span>

<span class="nc" id="L454">        public AtomicInteger counter = new AtomicInteger(0);</span>

        @Override
        public Collection&lt;EventRegistryEvent&gt; transform(EventInstance eventInstance) {
<span class="nc" id="L458">            counter.incrementAndGet();</span>
<span class="nc" id="L459">            EventRegistryEvent eventRegistryEvent = new EventRegistryEvent() {</span>

                @Override
                public String getType() {
<span class="nc" id="L463">                    return &quot;testType&quot;;</span>
                }
                @Override
                public Object getEventObject() {
<span class="nc" id="L467">                    return &quot;test&quot;;</span>
                }
            };
<span class="nc" id="L470">            return Collections.singletonList(eventRegistryEvent);</span>
        }
    }

<span class="nc" id="L474">    private static class TestOutboundChannelAdapter implements OutboundEventChannelAdapter&lt;String&gt; {</span>

<span class="nc" id="L476">        public AtomicInteger counter = new AtomicInteger(0);</span>

        @Override
        public void sendEvent(String rawEvent, Map&lt;String, Object&gt; headerMap) {
<span class="nc" id="L480">            counter.incrementAndGet();</span>
<span class="nc" id="L481">        }</span>

    }

<span class="nc" id="L485">    private static class TestOutboundEventSerializer implements OutboundEventSerializer {</span>

<span class="nc" id="L487">        public AtomicInteger counter = new AtomicInteger(0);</span>

        @Override
        public String serialize(EventInstance eventInstance) {
<span class="nc" id="L491">            counter.incrementAndGet();</span>
<span class="nc" id="L492">            return &quot;test&quot;;</span>
        }

    }

<span class="nc" id="L497">    private static class TestInboundEventProcessingPipeline implements InboundEventProcessingPipeline {</span>

<span class="nc" id="L499">        public AtomicInteger counter = new AtomicInteger(0);</span>

        @Override
        public Collection&lt;EventRegistryEvent&gt; run(InboundChannelModel inboundChannel, InboundEvent rawEvent) {
<span class="nc" id="L503">            counter.incrementAndGet();</span>
<span class="nc" id="L504">            return Collections.emptyList();</span>
        }
    }

<span class="nc" id="L508">    private static class TestOutboundEventProcessingPipeline implements OutboundEventProcessingPipeline&lt;String&gt; {</span>

<span class="nc" id="L510">        public AtomicInteger counter = new AtomicInteger(0);</span>

        @Override
        public String run(EventInstance eventInstance) {
<span class="nc" id="L514">            counter.incrementAndGet();</span>
<span class="nc" id="L515">            return &quot;test&quot;;</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>