<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CallActivityTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.event</a> &gt; <span class="el_source">CallActivityTest.java</span></div><h1>CallActivityTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.engine.test.api.event;

import static org.assertj.core.api.Assertions.assertThat;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;

import org.flowable.common.engine.api.delegate.event.FlowableEngineEntityEvent;
import org.flowable.common.engine.api.delegate.event.FlowableEngineEventType;
import org.flowable.common.engine.api.delegate.event.FlowableEntityEvent;
import org.flowable.common.engine.api.delegate.event.FlowableEvent;
import org.flowable.common.engine.impl.util.CollectionUtil;
import org.flowable.engine.delegate.event.AbstractFlowableEngineEventListener;
import org.flowable.engine.delegate.event.FlowableActivityCancelledEvent;
import org.flowable.engine.delegate.event.FlowableActivityEvent;
import org.flowable.engine.delegate.event.FlowableCancelledEvent;
import org.flowable.engine.delegate.event.FlowableProcessStartedEvent;
import org.flowable.engine.event.EventLogEntry;
import org.flowable.engine.impl.event.logger.EventLogger;
import org.flowable.engine.impl.jobexecutor.AsyncCompleteCallActivityJobHandler;
import org.flowable.engine.impl.persistence.entity.ExecutionEntity;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.repository.ProcessDefinition;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.job.api.Job;
import org.flowable.task.api.Task;
import org.flowable.task.service.impl.persistence.entity.TaskEntity;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.condition.DisabledIfSystemProperty;

<span class="nc" id="L48">public class CallActivityTest extends PluggableFlowableTestCase {</span>

    private CallActivityEventListener listener;

    protected EventLogger databaseEventLogger;

    @BeforeEach
    protected void setUp() throws Exception {
<span class="nc" id="L56">        listener = new CallActivityEventListener();</span>
<span class="nc" id="L57">        processEngineConfiguration.getEventDispatcher().addEventListener(listener);</span>

        // Database event logger setup
<span class="nc" id="L60">        databaseEventLogger = new EventLogger(processEngineConfiguration.getClock(),</span>
<span class="nc" id="L61">                processEngineConfiguration.getObjectMapper());</span>
<span class="nc" id="L62">        runtimeService.addEventListener(databaseEventLogger);</span>
<span class="nc" id="L63">    }</span>

    @AfterEach
    protected void tearDown() throws Exception {

<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (listener != null) {</span>
<span class="nc" id="L69">            listener.clearEventsReceived();</span>
<span class="nc" id="L70">            processEngineConfiguration.getEventDispatcher().removeEventListener(listener);</span>
        }

        // Remove entries
<span class="nc bnc" id="L74" title="All 2 branches missed.">        for (EventLogEntry eventLogEntry : managementService.getEventLogEntries(null, null)) {</span>
<span class="nc" id="L75">            managementService.deleteEventLogEntry(eventLogEntry.getLogNumber());</span>
<span class="nc" id="L76">        }</span>

        // Database event logger teardown
<span class="nc" id="L79">        runtimeService.removeEventListener(databaseEventLogger);</span>

<span class="nc" id="L81">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/event/CallActivityTest.testCallActivity.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/event/CallActivityTest.testCalledActivity.bpmn20.xml&quot; })
    public void testCallActivityCalledHasNoneEndEvent() throws Exception {

<span class="nc" id="L89">        CallActivityEventListener mylistener = new CallActivityEventListener();</span>
<span class="nc" id="L90">        processEngineConfiguration.getEventDispatcher().addEventListener(mylistener);</span>

<span class="nc" id="L92">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;callActivity&quot;);</span>
<span class="nc" id="L93">        assertThat(processInstance).isNotNull();</span>

        // no task should be active in parent process
<span class="nc" id="L96">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L97">        assertThat(task).isNull();</span>

        // only active task should be the one defined in the external subprocess
<span class="nc" id="L100">        task = taskService.createTaskQuery().active().singleResult();</span>
<span class="nc" id="L101">        assertThat(task).isNotNull();</span>
<span class="nc" id="L102">        assertThat(task.getName()).isEqualTo(&quot;User Task2 in External&quot;);</span>

<span class="nc" id="L104">        ExecutionEntity subprocessInstance = (ExecutionEntity) runtimeService.createExecutionQuery()</span>
<span class="nc" id="L105">                .rootProcessInstanceId(processInstance.getId())</span>
<span class="nc" id="L106">                .onlySubProcessExecutions()</span>
<span class="nc" id="L107">                .singleResult();</span>
<span class="nc" id="L108">        assertThat(subprocessInstance).isNotNull();</span>

<span class="nc" id="L110">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;Name&quot;)).isEqualTo(&quot;Default name&quot;);</span>
<span class="nc" id="L111">        assertThat(runtimeService.getVariable(subprocessInstance.getId(), &quot;FullName&quot;)).isEqualTo(&quot;Default name&quot;);</span>

        // set the variable in the subprocess to validate that the new value is returned from callActivity
<span class="nc" id="L114">        runtimeService.setVariable(subprocessInstance.getId(), &quot;FullName&quot;, &quot;Mary Smith&quot;);</span>
<span class="nc" id="L115">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;Name&quot;)).isEqualTo(&quot;Default name&quot;);</span>
<span class="nc" id="L116">        assertThat(runtimeService.getVariable(subprocessInstance.getId(), &quot;FullName&quot;)).isEqualTo(&quot;Mary Smith&quot;);</span>

        // complete user task so that external subprocess will flow to terminate end
<span class="nc" id="L119">        taskService.complete(task.getId());</span>

<span class="nc" id="L121">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L122">        assertThat(task).isNotNull();</span>
<span class="nc" id="L123">        assertThat(task.getName()).isEqualTo(&quot;User Task1&quot;);</span>

        // validate that the variable was copied back when Call Activity finished
<span class="nc" id="L126">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;Name&quot;)).isEqualTo(&quot;Mary Smith&quot;);</span>

        // complete user task so that parent process will terminate normally
<span class="nc" id="L129">        taskService.complete(task.getId());</span>

<span class="nc" id="L131">        FlowableEntityEvent entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(0);</span>
<span class="nc" id="L132">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.ENTITY_CREATED);</span>
<span class="nc" id="L133">        ExecutionEntity executionEntity = (ExecutionEntity) entityEvent.getEntity();</span>

        // this is the root process so parent null
<span class="nc" id="L136">        assertThat(executionEntity.getParentId()).isNull();</span>
<span class="nc" id="L137">        String processExecutionId = executionEntity.getId();</span>

<span class="nc" id="L139">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(1);</span>
<span class="nc" id="L140">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.ENTITY_CREATED);</span>
<span class="nc" id="L141">        executionEntity = (ExecutionEntity) entityEvent.getEntity();</span>
<span class="nc" id="L142">        assertThat(executionEntity.getParentId()).isEqualTo(processExecutionId);</span>

<span class="nc" id="L144">        FlowableEvent flowableEvent = mylistener.getEventsReceived().get(2);</span>
<span class="nc" id="L145">        assertThat(flowableEvent.getType()).isEqualTo(FlowableEngineEventType.PROCESS_STARTED);</span>

<span class="nc" id="L147">        FlowableActivityEvent activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(3);</span>
<span class="nc" id="L148">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L149">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;startEvent&quot;);</span>

<span class="nc" id="L151">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(4);</span>
<span class="nc" id="L152">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_COMPLETED);</span>
<span class="nc" id="L153">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;startEvent&quot;);</span>

<span class="nc" id="L155">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(5);</span>
<span class="nc" id="L156">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L157">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;callActivity1&quot;);</span>

<span class="nc" id="L159">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(6);</span>
<span class="nc" id="L160">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.ENTITY_CREATED);</span>
<span class="nc" id="L161">        executionEntity = (ExecutionEntity) entityEvent.getEntity();</span>
<span class="nc" id="L162">        assertThat(executionEntity.getParentId()).isNull();</span>
<span class="nc" id="L163">        assertThat(executionEntity.getProcessInstanceId()).isEqualTo(executionEntity.getId());</span>

        // user task within the external subprocess
<span class="nc" id="L166">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(7);</span>
<span class="nc" id="L167">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.ENTITY_CREATED);</span>
<span class="nc" id="L168">        executionEntity = (ExecutionEntity) entityEvent.getEntity();</span>
<span class="nc" id="L169">        assertThat(executionEntity.getActivityId()).isEqualTo(&quot;calledtask1&quot;);</span>

        // external subprocess
<span class="nc" id="L172">        flowableEvent = mylistener.getEventsReceived().get(8);</span>
<span class="nc" id="L173">        assertThat(flowableEvent.getType()).isEqualTo(FlowableEngineEventType.PROCESS_STARTED);</span>

        // start event in external subprocess
<span class="nc" id="L176">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(9);</span>
<span class="nc" id="L177">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L178">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;startEvent&quot;);</span>
<span class="nc" id="L179">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;startevent2&quot;);</span>

<span class="nc" id="L181">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(10);</span>
<span class="nc" id="L182">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_COMPLETED);</span>
<span class="nc" id="L183">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;startEvent&quot;);</span>
<span class="nc" id="L184">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;startevent2&quot;);</span>

        // user task within external subprocess
<span class="nc" id="L187">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(11);</span>
<span class="nc" id="L188">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L189">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;calledtask1&quot;);</span>
<span class="nc" id="L190">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;userTask&quot;);</span>

<span class="nc" id="L192">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(12);</span>
<span class="nc" id="L193">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.TASK_CREATED);</span>
<span class="nc" id="L194">        TaskEntity taskEntity = (TaskEntity) entityEvent.getEntity();</span>
<span class="nc" id="L195">        assertThat(taskEntity.getName()).isEqualTo(&quot;User Task2 in External&quot;);</span>

<span class="nc" id="L197">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(13);</span>
<span class="nc" id="L198">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.TASK_COMPLETED);</span>
<span class="nc" id="L199">        taskEntity = (TaskEntity) entityEvent.getEntity();</span>
<span class="nc" id="L200">        assertThat(taskEntity.getName()).isEqualTo(&quot;User Task2 in External&quot;);</span>

        // user task within external subprocess
<span class="nc" id="L203">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(14);</span>
<span class="nc" id="L204">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_COMPLETED);</span>
<span class="nc" id="L205">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;calledtask1&quot;);</span>
<span class="nc" id="L206">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;userTask&quot;);</span>

        // None event in external subprocess
<span class="nc" id="L209">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(15);</span>
<span class="nc" id="L210">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L211">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;noneevent2&quot;);</span>
<span class="nc" id="L212">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;endEvent&quot;);</span>

<span class="nc" id="L214">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(16);</span>
<span class="nc" id="L215">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_COMPLETED);</span>
<span class="nc" id="L216">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;noneevent2&quot;);</span>
<span class="nc" id="L217">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;endEvent&quot;);</span>

        // the external subprocess
<span class="nc" id="L220">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(17);</span>
<span class="nc" id="L221">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.PROCESS_COMPLETED);</span>

        // callActivity
<span class="nc" id="L224">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(18);</span>
<span class="nc" id="L225">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_COMPLETED);</span>
<span class="nc" id="L226">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;callActivity&quot;);</span>

        // user task within parent process
<span class="nc" id="L229">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(19);</span>
<span class="nc" id="L230">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L231">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;task1&quot;);</span>
<span class="nc" id="L232">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;userTask&quot;);</span>

<span class="nc" id="L234">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(20);</span>
<span class="nc" id="L235">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.TASK_CREATED);</span>
<span class="nc" id="L236">        taskEntity = (TaskEntity) entityEvent.getEntity();</span>
<span class="nc" id="L237">        assertThat(taskEntity.getName()).isEqualTo(&quot;User Task1&quot;);</span>

<span class="nc" id="L239">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(21);</span>
<span class="nc" id="L240">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.TASK_COMPLETED);</span>
<span class="nc" id="L241">        taskEntity = (TaskEntity) entityEvent.getEntity();</span>
<span class="nc" id="L242">        assertThat(taskEntity.getName()).isEqualTo(&quot;User Task1&quot;);</span>

<span class="nc" id="L244">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(22);</span>
<span class="nc" id="L245">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_COMPLETED);</span>
<span class="nc" id="L246">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;task1&quot;);</span>
<span class="nc" id="L247">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;userTask&quot;);</span>

<span class="nc" id="L249">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(23);</span>
<span class="nc" id="L250">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L251">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;noneevent1&quot;);</span>
<span class="nc" id="L252">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;endEvent&quot;);</span>

<span class="nc" id="L254">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(24);</span>
<span class="nc" id="L255">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_COMPLETED);</span>
<span class="nc" id="L256">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;noneevent1&quot;);</span>
<span class="nc" id="L257">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;endEvent&quot;);</span>

        // the parent process
<span class="nc" id="L260">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(25);</span>
<span class="nc" id="L261">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.PROCESS_COMPLETED);</span>

<span class="nc" id="L263">        assertThat(mylistener.getEventsReceived()).hasSize(26);</span>
<span class="nc" id="L264">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/event/CallActivityTest.testCallActivity.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/event/CallActivityTest.testCalledActivity.bpmn20.xml&quot; })
    public void testDeleteParentWhenCallActivityCalledHasNoneEndEvent() throws Exception {

<span class="nc" id="L272">        CallActivityEventListener mylistener = new CallActivityEventListener();</span>
<span class="nc" id="L273">        processEngineConfiguration.getEventDispatcher().addEventListener(mylistener);</span>

<span class="nc" id="L275">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;callActivity&quot;);</span>
<span class="nc" id="L276">        assertThat(processInstance).isNotNull();</span>

        // no task should be active in parent process
<span class="nc" id="L279">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L280">        assertThat(task).isNull();</span>

        // only active task should be the one defined in the external subprocess
<span class="nc" id="L283">        task = taskService.createTaskQuery().active().singleResult();</span>
<span class="nc" id="L284">        assertThat(task).isNotNull();</span>
<span class="nc" id="L285">        assertThat(task.getName()).isEqualTo(&quot;User Task2 in External&quot;);</span>

<span class="nc" id="L287">        ExecutionEntity subprocessInstance = (ExecutionEntity) runtimeService.createExecutionQuery()</span>
<span class="nc" id="L288">                .rootProcessInstanceId(processInstance.getId())</span>
<span class="nc" id="L289">                .onlySubProcessExecutions()</span>
<span class="nc" id="L290">                .singleResult();</span>
<span class="nc" id="L291">        assertThat(subprocessInstance).isNotNull();</span>

<span class="nc" id="L293">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;Name&quot;)).isEqualTo(&quot;Default name&quot;);</span>
<span class="nc" id="L294">        assertThat(runtimeService.getVariable(subprocessInstance.getId(), &quot;FullName&quot;)).isEqualTo(&quot;Default name&quot;);</span>

<span class="nc" id="L296">        runtimeService.deleteProcessInstance(processInstance.getId(), null);</span>

<span class="nc" id="L298">        FlowableEntityEvent entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(0);</span>
<span class="nc" id="L299">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.ENTITY_CREATED);</span>
<span class="nc" id="L300">        ExecutionEntity executionEntity = (ExecutionEntity) entityEvent.getEntity();</span>

        // this is the root process so parent null
<span class="nc" id="L303">        assertThat(executionEntity.getParentId()).isNull();</span>
<span class="nc" id="L304">        String processExecutionId = executionEntity.getId();</span>

<span class="nc" id="L306">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(1);</span>
<span class="nc" id="L307">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.ENTITY_CREATED);</span>
<span class="nc" id="L308">        executionEntity = (ExecutionEntity) entityEvent.getEntity();</span>
<span class="nc" id="L309">        assertThat(executionEntity.getParentId()).isEqualTo(processExecutionId);</span>

<span class="nc" id="L311">        FlowableEvent flowableEvent = mylistener.getEventsReceived().get(2);</span>
<span class="nc" id="L312">        assertThat(flowableEvent.getType()).isEqualTo(FlowableEngineEventType.PROCESS_STARTED);</span>

<span class="nc" id="L314">        FlowableActivityEvent activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(3);</span>
<span class="nc" id="L315">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L316">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;startEvent&quot;);</span>

<span class="nc" id="L318">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(4);</span>
<span class="nc" id="L319">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_COMPLETED);</span>
<span class="nc" id="L320">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;startEvent&quot;);</span>

<span class="nc" id="L322">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(5);</span>
<span class="nc" id="L323">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L324">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;callActivity1&quot;);</span>

<span class="nc" id="L326">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(6);</span>
<span class="nc" id="L327">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.ENTITY_CREATED);</span>
<span class="nc" id="L328">        executionEntity = (ExecutionEntity) entityEvent.getEntity();</span>
<span class="nc" id="L329">        assertThat(executionEntity.getParentId()).isNull();</span>
<span class="nc" id="L330">        assertThat(executionEntity.getProcessInstanceId()).isEqualTo(executionEntity.getId());</span>

        // user task within the external subprocess
<span class="nc" id="L333">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(7);</span>
<span class="nc" id="L334">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.ENTITY_CREATED);</span>
<span class="nc" id="L335">        executionEntity = (ExecutionEntity) entityEvent.getEntity();</span>
<span class="nc" id="L336">        assertThat(executionEntity.getActivityId()).isEqualTo(&quot;calledtask1&quot;);</span>

        // external subprocess
<span class="nc" id="L339">        flowableEvent = mylistener.getEventsReceived().get(8);</span>
<span class="nc" id="L340">        assertThat(flowableEvent.getType()).isEqualTo(FlowableEngineEventType.PROCESS_STARTED);</span>

        // start event in external subprocess
<span class="nc" id="L343">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(9);</span>
<span class="nc" id="L344">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L345">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;startEvent&quot;);</span>
<span class="nc" id="L346">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;startevent2&quot;);</span>

<span class="nc" id="L348">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(10);</span>
<span class="nc" id="L349">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_COMPLETED);</span>
<span class="nc" id="L350">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;startEvent&quot;);</span>
<span class="nc" id="L351">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;startevent2&quot;);</span>

        // user task within external subprocess
<span class="nc" id="L354">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(11);</span>
<span class="nc" id="L355">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L356">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;calledtask1&quot;);</span>
<span class="nc" id="L357">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;userTask&quot;);</span>

<span class="nc" id="L359">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(12);</span>
<span class="nc" id="L360">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.TASK_CREATED);</span>
<span class="nc" id="L361">        TaskEntity taskEntity = (TaskEntity) entityEvent.getEntity();</span>
<span class="nc" id="L362">        assertThat(taskEntity.getName()).isEqualTo(&quot;User Task2 in External&quot;);</span>

        // user task within external subprocess cancelled
<span class="nc" id="L365">        FlowableActivityCancelledEvent activityCancelledEvent = (FlowableActivityCancelledEvent) mylistener.getEventsReceived().get(13);</span>
<span class="nc" id="L366">        assertThat(activityCancelledEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L367">        assertThat(activityCancelledEvent.getActivityName()).isEqualTo(&quot;User Task2 in External&quot;);</span>
<span class="nc" id="L368">        assertThat(activityCancelledEvent.getActivityType()).isEqualTo(&quot;userTask&quot;);</span>

        // external subprocess cancelled
<span class="nc" id="L371">        FlowableCancelledEvent processCancelledEvent = (FlowableCancelledEvent) mylistener.getEventsReceived().get(14);</span>
<span class="nc" id="L372">        assertThat(processCancelledEvent.getType()).isEqualTo(FlowableEngineEventType.PROCESS_CANCELLED);</span>
<span class="nc" id="L373">        assertThat(processCancelledEvent.getProcessInstanceId()).isEqualTo(subprocessInstance.getId());</span>

        // expecting cancelled event for Call Activity
<span class="nc" id="L376">        activityCancelledEvent = (FlowableActivityCancelledEvent) mylistener.getEventsReceived().get(15);</span>
<span class="nc" id="L377">        assertThat(activityCancelledEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L378">        assertThat(activityCancelledEvent.getActivityType()).isEqualTo(&quot;callActivity&quot;);</span>

        // parent process cancelled
<span class="nc" id="L381">        processCancelledEvent = (FlowableCancelledEvent) mylistener.getEventsReceived().get(16);</span>
<span class="nc" id="L382">        assertThat(processCancelledEvent.getType()).isEqualTo(FlowableEngineEventType.PROCESS_CANCELLED);</span>
<span class="nc" id="L383">        assertThat(processCancelledEvent.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>

<span class="nc" id="L385">        assertThat(mylistener.getEventsReceived()).hasSize(17);</span>
<span class="nc" id="L386">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/event/CallActivityTest.testCallActivityTerminateEnd.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/event/CallActivityTest.testCalledActivityTerminateEnd.bpmn20.xml&quot; })
    public void testCallActivityCalledHasTerminateEndEvent() throws Exception {

<span class="nc" id="L394">        CallActivityEventListener mylistener = new CallActivityEventListener();</span>
<span class="nc" id="L395">        processEngineConfiguration.getEventDispatcher().addEventListener(mylistener);</span>

<span class="nc" id="L397">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;callActivityTerminateEnd&quot;);</span>
<span class="nc" id="L398">        assertThat(processInstance).isNotNull();</span>

        // no task should be active in parent process
<span class="nc" id="L401">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L402">        assertThat(task).isNull();</span>

        // only active task should be the one defined in the external subprocess
<span class="nc" id="L405">        task = taskService.createTaskQuery().active().singleResult();</span>
<span class="nc" id="L406">        assertThat(task).isNotNull();</span>
<span class="nc" id="L407">        assertThat(task.getName()).isEqualTo(&quot;User Task2 in External with Terminate End Event&quot;);</span>

<span class="nc" id="L409">        ExecutionEntity subprocessInstance = (ExecutionEntity) runtimeService.createExecutionQuery()</span>
<span class="nc" id="L410">                .rootProcessInstanceId(processInstance.getId())</span>
<span class="nc" id="L411">                .onlySubProcessExecutions()</span>
<span class="nc" id="L412">                .singleResult();</span>
<span class="nc" id="L413">        assertThat(subprocessInstance).isNotNull();</span>

<span class="nc" id="L415">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;Name&quot;)).isEqualTo(&quot;Default name&quot;);</span>
<span class="nc" id="L416">        assertThat(runtimeService.getVariable(subprocessInstance.getId(), &quot;FullName&quot;)).isEqualTo(&quot;Default name&quot;);</span>

        // set the variable in the subprocess to validate that the new value is returned from callActivity
<span class="nc" id="L419">        runtimeService.setVariable(subprocessInstance.getId(), &quot;FullName&quot;, &quot;Mary Smith&quot;);</span>
<span class="nc" id="L420">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;Name&quot;)).isEqualTo(&quot;Default name&quot;);</span>
<span class="nc" id="L421">        assertThat(runtimeService.getVariable(subprocessInstance.getId(), &quot;FullName&quot;)).isEqualTo(&quot;Mary Smith&quot;);</span>

        // complete user task so that external subprocess will flow to terminate end
<span class="nc" id="L424">        taskService.complete(task.getId());</span>

<span class="nc" id="L426">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L427">        assertThat(task).isNotNull();</span>
<span class="nc" id="L428">        assertThat(task.getName()).isEqualTo(&quot;User Task1 in Parent&quot;);</span>

        // validate that the variable was copied back when Call Activity finished
<span class="nc" id="L431">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;Name&quot;)).isEqualTo(&quot;Mary Smith&quot;);</span>

        // complete user task so that parent process will terminate normally
<span class="nc" id="L434">        taskService.complete(task.getId());</span>

<span class="nc" id="L436">        FlowableEntityEvent entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(0);</span>
<span class="nc" id="L437">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.ENTITY_CREATED);</span>
<span class="nc" id="L438">        ExecutionEntity executionEntity = (ExecutionEntity) entityEvent.getEntity();</span>

        // this is the root process so parent null
<span class="nc" id="L441">        assertThat(executionEntity.getParentId()).isNull();</span>
<span class="nc" id="L442">        String processExecutionId = executionEntity.getId();</span>

<span class="nc" id="L444">        int idx = 1;</span>
<span class="nc" id="L445">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L446">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.ENTITY_CREATED);</span>
<span class="nc" id="L447">        executionEntity = (ExecutionEntity) entityEvent.getEntity();</span>
<span class="nc" id="L448">        assertThat(executionEntity.getParentId()).isEqualTo(processExecutionId);</span>

<span class="nc" id="L450">        FlowableEvent flowableEvent = mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L451">        assertThat(flowableEvent.getType()).isEqualTo(FlowableEngineEventType.PROCESS_STARTED);</span>

<span class="nc" id="L453">        FlowableActivityEvent activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L454">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L455">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;startEvent&quot;);</span>

<span class="nc" id="L457">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L458">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_COMPLETED);</span>
<span class="nc" id="L459">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;startEvent&quot;);</span>

<span class="nc" id="L461">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L462">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L463">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;callActivityId1&quot;);</span>

<span class="nc" id="L465">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L466">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.ENTITY_CREATED);</span>
<span class="nc" id="L467">        executionEntity = (ExecutionEntity) entityEvent.getEntity();</span>
<span class="nc" id="L468">        assertThat(executionEntity.getParentId()).isNull();</span>
<span class="nc" id="L469">        assertThat(executionEntity.getProcessInstanceId()).isEqualTo(executionEntity.getId());</span>

        // user task within the external subprocess
<span class="nc" id="L472">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L473">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.ENTITY_CREATED);</span>
<span class="nc" id="L474">        executionEntity = (ExecutionEntity) entityEvent.getEntity();</span>
<span class="nc" id="L475">        assertThat(executionEntity.getActivityId()).isEqualTo(&quot;calledtask1&quot;);</span>

        // external subprocess
<span class="nc" id="L478">        flowableEvent = mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L479">        assertThat(flowableEvent.getType()).isEqualTo(FlowableEngineEventType.PROCESS_STARTED);</span>
<span class="nc" id="L480">        executionEntity = (ExecutionEntity) ((FlowableProcessStartedEvent) flowableEvent).getEntity();</span>
<span class="nc" id="L481">        assertThat(executionEntity.getParentId()).isEqualTo(subprocessInstance.getId());</span>

        // start event in external subprocess
<span class="nc" id="L484">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L485">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L486">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;startEvent&quot;);</span>
<span class="nc" id="L487">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;startevent2&quot;);</span>

<span class="nc" id="L489">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L490">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_COMPLETED);</span>
<span class="nc" id="L491">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;startEvent&quot;);</span>
<span class="nc" id="L492">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;startevent2&quot;);</span>

        // user task within external subprocess
<span class="nc" id="L495">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L496">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L497">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;calledtask1&quot;);</span>
<span class="nc" id="L498">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;userTask&quot;);</span>

<span class="nc" id="L500">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L501">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.TASK_CREATED);</span>
<span class="nc" id="L502">        TaskEntity taskEntity = (TaskEntity) entityEvent.getEntity();</span>
<span class="nc" id="L503">        assertThat(taskEntity.getName()).isEqualTo(&quot;User Task2 in External with Terminate End Event&quot;);</span>

<span class="nc" id="L505">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L506">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.TASK_COMPLETED);</span>
<span class="nc" id="L507">        taskEntity = (TaskEntity) entityEvent.getEntity();</span>
<span class="nc" id="L508">        assertThat(taskEntity.getName()).isEqualTo(&quot;User Task2 in External with Terminate End Event&quot;);</span>

        // user task within external subprocess
<span class="nc" id="L511">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L512">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_COMPLETED);</span>
<span class="nc" id="L513">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;calledtask1&quot;);</span>
<span class="nc" id="L514">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;userTask&quot;);</span>

        // None event in external subprocess
<span class="nc" id="L517">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L518">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L519">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;terminateEnd2&quot;);</span>
<span class="nc" id="L520">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;endEvent&quot;);</span>

        // PROCESS_COMPLETED_WITH_TERMINATE_END_EVENT instead of PROCESS_COMPLETED
        // because external subprocess defined with terminate end event
<span class="nc" id="L524">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L525">        assertThat(((FlowableEngineEntityEvent) entityEvent).getExecutionId()).isEqualTo(subprocessInstance.getId());</span>
<span class="nc" id="L526">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.PROCESS_COMPLETED_WITH_TERMINATE_END_EVENT);</span>

        //the external subprocess (callActivity)
<span class="nc" id="L529">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L530">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_COMPLETED);</span>
<span class="nc" id="L531">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;callActivity&quot;);</span>

        // user task within parent process
<span class="nc" id="L534">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L535">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L536">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;task1&quot;);</span>
<span class="nc" id="L537">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;userTask&quot;);</span>

<span class="nc" id="L539">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L540">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.TASK_CREATED);</span>
<span class="nc" id="L541">        taskEntity = (TaskEntity) entityEvent.getEntity();</span>
<span class="nc" id="L542">        assertThat(taskEntity.getName()).isEqualTo(&quot;User Task1 in Parent&quot;);</span>

<span class="nc" id="L544">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L545">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.TASK_COMPLETED);</span>
<span class="nc" id="L546">        taskEntity = (TaskEntity) entityEvent.getEntity();</span>
<span class="nc" id="L547">        assertThat(taskEntity.getName()).isEqualTo(&quot;User Task1 in Parent&quot;);</span>

<span class="nc" id="L549">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L550">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_COMPLETED);</span>
<span class="nc" id="L551">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;task1&quot;);</span>
<span class="nc" id="L552">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;userTask&quot;);</span>

<span class="nc" id="L554">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L555">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L556">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;noneevent1&quot;);</span>
<span class="nc" id="L557">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;endEvent&quot;);</span>

<span class="nc" id="L559">        activityEvent = (FlowableActivityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L560">        assertThat(activityEvent.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_COMPLETED);</span>
<span class="nc" id="L561">        assertThat(activityEvent.getActivityId()).isEqualTo(&quot;noneevent1&quot;);</span>
<span class="nc" id="L562">        assertThat(activityEvent.getActivityType()).isEqualTo(&quot;endEvent&quot;);</span>

        // the parent process
<span class="nc" id="L565">        entityEvent = (FlowableEntityEvent) mylistener.getEventsReceived().get(idx++);</span>
<span class="nc" id="L566">        assertThat(entityEvent.getType()).isEqualTo(FlowableEngineEventType.PROCESS_COMPLETED);</span>

<span class="nc" id="L568">        assertThat(mylistener.getEventsReceived()).hasSize(idx);</span>
<span class="nc" id="L569">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/event/CallActivityTest.testCallActivity.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/event/CallActivityTest.testCalledActivity.bpmn20.xml&quot; })
    public void testDeleteParentProcessWithCallActivity() throws Exception {

<span class="nc" id="L577">        CallActivityEventListener mylistener = new CallActivityEventListener();</span>
<span class="nc" id="L578">        processEngineConfiguration.getEventDispatcher().addEventListener(mylistener);</span>

<span class="nc" id="L580">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;callActivity&quot;);</span>
<span class="nc" id="L581">        assertThat(processInstance).isNotNull();</span>

        // no task should be active in parent process
<span class="nc" id="L584">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L585">        assertThat(task).isNull();</span>

        // only active task should be the one defined in the external subprocess
<span class="nc" id="L588">        task = taskService.createTaskQuery().active().singleResult();</span>
<span class="nc" id="L589">        assertThat(task).isNotNull();</span>
<span class="nc" id="L590">        assertThat(task.getName()).isEqualTo(&quot;User Task2 in External&quot;);</span>

<span class="nc" id="L592">        ExecutionEntity subprocessInstance = (ExecutionEntity) runtimeService.createExecutionQuery()</span>
<span class="nc" id="L593">                .rootProcessInstanceId(processInstance.getId())</span>
<span class="nc" id="L594">                .onlySubProcessExecutions()</span>
<span class="nc" id="L595">                .singleResult();</span>
<span class="nc" id="L596">        assertThat(subprocessInstance).isNotNull();</span>

<span class="nc" id="L598">        runtimeService.deleteProcessInstance(processInstance.getId(), null);</span>

<span class="nc" id="L600">        List&lt;FlowableEvent&gt; entityEvents = mylistener.getEventsReceived();</span>
<span class="nc" id="L601">        int lastIndex = entityEvents.size() - 1;</span>
<span class="nc" id="L602">        assertThat(entityEvents.get(lastIndex - 3).getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L603">        assertThat(entityEvents.get(lastIndex - 2).getType()).isEqualTo(FlowableEngineEventType.PROCESS_CANCELLED);</span>
<span class="nc" id="L604">        FlowableCancelledEvent subProcessCancelledEvent = (FlowableCancelledEvent) entityEvents.get(lastIndex - 2);</span>
<span class="nc" id="L605">        assertThat(subProcessCancelledEvent.getProcessInstanceId()).isEqualTo(subprocessInstance.getId());</span>
<span class="nc" id="L606">        assertThat(entityEvents.get(lastIndex - 1).getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L607">        assertThat(entityEvents.get(lastIndex).getType()).isEqualTo(FlowableEngineEventType.PROCESS_CANCELLED);</span>
<span class="nc" id="L608">        FlowableCancelledEvent processCancelledEvent = (FlowableCancelledEvent) entityEvents.get(lastIndex);</span>
<span class="nc" id="L609">        assertThat(processCancelledEvent.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L610">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/event/CallActivityTest.testCallActivityProcessInstanceName.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/event/CallActivityTest.testCalledActivity.bpmn20.xml&quot;
    })
    public void testCallActivityProcessInstanceName() {
<span class="nc" id="L618">        runtimeService.startProcessInstanceByKey(&quot;testCallActivityProcessInstanceName&quot;,</span>
<span class="nc" id="L619">                CollectionUtil.singletonMap(&quot;theCollection&quot;, Arrays.asList(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;)));</span>

<span class="nc" id="L621">        List&lt;ProcessInstance&gt; childProcessInstances = runtimeService.createProcessInstanceQuery().list().stream()</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">                .filter(processInstance -&gt; (processInstance.getSuperExecutionId() != null))</span>
<span class="nc" id="L623">                .sorted((p1, p2) -&gt; p1.getName().compareTo(p2.getName()))</span>
<span class="nc" id="L624">                .collect(Collectors.toList());</span>

<span class="nc" id="L626">        assertThat(childProcessInstances)</span>
<span class="nc" id="L627">                .extracting(ProcessInstance::getName)</span>
<span class="nc" id="L628">                .containsExactly(</span>
                        &quot;Process instance A&quot;,
                        &quot;Process instance B&quot;,
                        &quot;Process instance C&quot;,
                        &quot;Process instance D&quot;)
        ;
<span class="nc" id="L634">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/event/CallActivityTest.testCallActivityAsyncComplete.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/event/CallActivityTest.testCallActivityAsyncComplete_subprocess.bpmn20.xml&quot;
    })
    public void testCallActivityAsyncComplete() {
<span class="nc" id="L642">        runtimeService.startProcessInstanceByKey(&quot;testAsyncComplete&quot;);</span>

        // 1 async service task
<span class="nc" id="L645">        List&lt;Job&gt; jobs = managementService.createJobQuery().list();</span>
<span class="nc" id="L646">        assertThat(jobs).hasSize(1);</span>
<span class="nc" id="L647">        jobs.forEach(job -&gt; managementService.executeJob(job.getId()));</span>

        // 5 async multi instance call activities after start
<span class="nc" id="L650">        jobs = managementService.createJobQuery().list();</span>
<span class="nc" id="L651">        assertThat(jobs).hasSize(5);</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">        for (Job job : jobs) {</span>
<span class="nc" id="L653">            ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().processDefinitionId(job.getProcessDefinitionId())</span>
<span class="nc" id="L654">                    .singleResult();</span>
<span class="nc" id="L655">            assertThat(processDefinition.getKey()).isEqualTo(&quot;testAsyncComplete&quot;);</span>
<span class="nc" id="L656">        }</span>
<span class="nc" id="L657">        jobs.forEach(job -&gt; managementService.executeJob(job.getId()));</span>

        // 1 job for each step1 in subprocess, so 5 in total
<span class="nc" id="L660">        jobs = managementService.createJobQuery().list();</span>
<span class="nc" id="L661">        assertThat(jobs).hasSize(5);</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">        for (Job job : jobs) {</span>
<span class="nc" id="L663">            ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().processDefinitionId(job.getProcessDefinitionId())</span>
<span class="nc" id="L664">                    .singleResult();</span>
<span class="nc" id="L665">            assertThat(processDefinition.getKey()).isEqualTo(&quot;subProcess&quot;);</span>
<span class="nc" id="L666">        }</span>
<span class="nc" id="L667">        jobs.forEach(job -&gt; managementService.executeJob(job.getId()));</span>

        // Step 2
<span class="nc" id="L670">        jobs = managementService.createJobQuery().list();</span>
<span class="nc" id="L671">        assertThat(jobs).hasSize(5);</span>
<span class="nc" id="L672">        jobs.forEach(job -&gt; managementService.executeJob(job.getId()));</span>

        // Step 3 will trigger the async complete
<span class="nc" id="L675">        jobs = managementService.createJobQuery().list();</span>
<span class="nc" id="L676">        assertThat(jobs).hasSize(5);</span>
<span class="nc" id="L677">        jobs.forEach(job -&gt; managementService.executeJob(job.getId()));</span>

        // Async complete
<span class="nc" id="L680">        jobs = managementService.createJobQuery().list();</span>
<span class="nc" id="L681">        assertThat(jobs).hasSize(5);</span>
<span class="nc bnc" id="L682" title="All 2 branches missed.">        for (Job job : jobs) {</span>
<span class="nc" id="L683">            ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().processDefinitionId(job.getProcessDefinitionId())</span>
<span class="nc" id="L684">                    .singleResult();</span>
<span class="nc" id="L685">            assertThat(processDefinition.getKey())</span>
<span class="nc" id="L686">                    .isEqualTo(&quot;subProcess&quot;); // context is the subprocess, as the EndExecution will be scheduled for that process definition</span>

<span class="nc" id="L688">            assertThat(job.getJobHandlerType()).isEqualTo(AsyncCompleteCallActivityJobHandler.TYPE);</span>
<span class="nc" id="L689">        }</span>

        // Completing ends the process instance
<span class="nc" id="L692">        jobs.forEach(job -&gt; managementService.executeJob(job.getId()));</span>
<span class="nc" id="L693">        assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>
<span class="nc" id="L694">    }</span>

    // Same as testCallActivityAsyncComplete, but now using the real job executor instead of fetching and executing jobs manually
    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/event/CallActivityTest.testCallActivityAsyncComplete.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/event/CallActivityTest.testCallActivityAsyncComplete_subprocess.bpmn20.xml&quot;
    })
    @DisabledIfSystemProperty(named = &quot;disableWhen&quot;, matches = &quot;cockroachdb&quot;)
    public void testCallActivityAsyncCompleteRealExecutor() {
<span class="nc" id="L704">        runtimeService.startProcessInstanceByKey(&quot;testAsyncComplete&quot;);</span>
<span class="nc" id="L705">        waitForJobExecutorToProcessAllJobsAndExecutableTimerJobs(20000L, 200L);</span>
<span class="nc" id="L706">        assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>
<span class="nc" id="L707">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/event/CallActivityTest.testCallActivityWithEventSubprocessParent.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/event/CallActivityTest.testCallActivityWithEventSubprocess.bpmn20.xml&quot;
    })
    public void testCallActivityWithEventSubprocess() {
<span class="nc" id="L715">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;testWithEventSubprocessParent&quot;);</span>
<span class="nc" id="L716">        Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L717">        assertThat(task.getName()).isEqualTo(&quot;One&quot;);</span>

        // Completing the task should trigger the event subprocess
<span class="nc" id="L720">        taskService.complete(task.getId());</span>
<span class="nc" id="L721">        Task subOneTask = taskService.createTaskQuery().taskName(&quot;sub one&quot;).singleResult();</span>
<span class="nc" id="L722">        assertThat(subOneTask).isNotNull();</span>
<span class="nc" id="L723">        taskService.complete(subOneTask.getId());</span>

        // Complete the last task
<span class="nc" id="L726">        task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L727">        assertThat(task.getName()).isEqualTo(&quot;Two&quot;);</span>
<span class="nc" id="L728">        taskService.complete(task.getId());</span>
<span class="nc" id="L729">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L730">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/event/CallActivityTest.testCallActivityWithEventSubprocessParent.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/event/CallActivityTest.testCallActivityWithEventSubprocessInterrupting.bpmn20.xml&quot;
    })
    public void testCallActivityWithEventSubprocessInterrupting() {
<span class="nc" id="L738">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;testWithEventSubprocessParent&quot;);</span>
<span class="nc" id="L739">        Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L740">        assertThat(task.getName()).isEqualTo(&quot;One&quot;);</span>

        // Completing the task should trigger the event subprocess. This interrupts the main flow.
<span class="nc" id="L743">        taskService.complete(task.getId());</span>
<span class="nc" id="L744">        Task subOneTask = taskService.createTaskQuery().taskName(&quot;sub one&quot;).singleResult();</span>
<span class="nc" id="L745">        assertThat(subOneTask).isNotNull();</span>
<span class="nc" id="L746">        taskService.complete(subOneTask.getId());</span>

<span class="nc" id="L748">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L749">    }</span>

    class CallActivityEventListener extends AbstractFlowableEngineEventListener {

        private List&lt;FlowableEvent&gt; eventsReceived;

<span class="nc" id="L755">        public CallActivityEventListener() {</span>
<span class="nc" id="L756">            eventsReceived = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L757">        }</span>

        public List&lt;FlowableEvent&gt; getEventsReceived() {
<span class="nc" id="L760">            return eventsReceived;</span>
        }

        public void clearEventsReceived() {
<span class="nc" id="L764">            eventsReceived.clear();</span>
<span class="nc" id="L765">        }</span>

        @Override
        public void onEvent(FlowableEvent event) {
<span class="nc" id="L769">            FlowableEngineEventType engineEventType = (FlowableEngineEventType) event.getType();</span>
<span class="nc bnc" id="L770" title="All 3 branches missed.">            switch (engineEventType) {</span>
                case ENTITY_CREATED:
<span class="nc" id="L772">                    FlowableEntityEvent entityEvent = (FlowableEntityEvent) event;</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">                    if (entityEvent.getEntity() instanceof ExecutionEntity) {</span>
<span class="nc" id="L774">                        eventsReceived.add(event);</span>
                    }
                    break;
                case ACTIVITY_STARTED:
                case ACTIVITY_COMPLETED:
                case ACTIVITY_CANCELLED:
                case TASK_CREATED:
                case TASK_COMPLETED:
                case PROCESS_STARTED:
                case PROCESS_COMPLETED:
                case PROCESS_CANCELLED:
                case PROCESS_COMPLETED_WITH_TERMINATE_END_EVENT:
<span class="nc" id="L786">                    eventsReceived.add(event);</span>
<span class="nc" id="L787">                    break;</span>
                default:
                    break;

            }
<span class="nc" id="L792">        }</span>

        @Override
        public boolean isFailOnException() {
<span class="nc" id="L796">            return false;</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>