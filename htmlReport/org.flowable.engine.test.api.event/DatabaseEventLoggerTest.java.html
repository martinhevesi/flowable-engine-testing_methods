<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DatabaseEventLoggerTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.event</a> &gt; <span class="el_source">DatabaseEventLoggerTest.java</span></div><h1>DatabaseEventLoggerTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.engine.test.api.event;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.entry;

import java.io.IOException;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import org.flowable.common.engine.api.delegate.event.FlowableEngineEventType;
import org.flowable.common.engine.impl.identity.Authentication;
import org.flowable.common.engine.impl.util.CollectionUtil;
import org.flowable.engine.event.EventLogEntry;
import org.flowable.engine.impl.event.logger.EventLogger;
import org.flowable.engine.impl.event.logger.handler.Fields;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import com.fasterxml.jackson.core.JsonParseException;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.JsonMappingException;
import com.fasterxml.jackson.databind.ObjectMapper;

/**
 * @author Joram Barrez
 */
<span class="nc" id="L45">public class DatabaseEventLoggerTest extends PluggableFlowableTestCase {</span>

    protected EventLogger databaseEventLogger;

<span class="nc" id="L49">    protected ObjectMapper objectMapper = new ObjectMapper();</span>

    @BeforeEach
    protected void setUp() throws Exception {

        // Database event logger setup
<span class="nc" id="L55">        databaseEventLogger = new EventLogger(processEngineConfiguration.getClock(), processEngineConfiguration.getObjectMapper());</span>
<span class="nc" id="L56">        runtimeService.addEventListener(databaseEventLogger);</span>
<span class="nc" id="L57">    }</span>

    @AfterEach
    protected void tearDown() throws Exception {

        // Database event logger teardown
<span class="nc" id="L63">        runtimeService.removeEventListener(databaseEventLogger);</span>

<span class="nc" id="L65">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/event/DatabaseEventLoggerProcess.bpmn20.xml&quot; })
    public void testDatabaseEvents() throws IOException {

<span class="nc" id="L71">        String testTenant = &quot;testTenant&quot;;</span>

<span class="nc" id="L73">        String deploymentId = repositoryService.createDeployment()</span>
<span class="nc" id="L74">                .addClasspathResource(&quot;org/flowable/engine/test/api/event/DatabaseEventLoggerProcess.bpmn20.xml&quot;)</span>
<span class="nc" id="L75">                .tenantId(testTenant)</span>
<span class="nc" id="L76">                .deploy().getId();</span>

        // Run process to gather data
<span class="nc" id="L79">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKeyAndTenantId(&quot;DatabaseEventLoggerProcess&quot;,</span>
<span class="nc" id="L80">                CollectionUtil.singletonMap(&quot;testVar&quot;, &quot;helloWorld&quot;), testTenant);</span>

        // Verify event log entries
<span class="nc" id="L83">        List&lt;EventLogEntry&gt; eventLogEntries = managementService.getEventLogEntries(null, null);</span>

<span class="nc" id="L85">        String processDefinitionId = processInstance.getProcessDefinitionId();</span>
<span class="nc" id="L86">        Iterator&lt;EventLogEntry&gt; iterator = eventLogEntries.iterator();</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">        while (iterator.hasNext()) {</span>
<span class="nc" id="L88">            EventLogEntry entry = iterator.next();</span>
<span class="nc bnc" id="L89" title="All 4 branches missed.">            if (entry.getProcessDefinitionId() != null &amp;&amp; !entry.getProcessDefinitionId().equals(processDefinitionId)) {</span>
<span class="nc" id="L90">                iterator.remove();</span>
            }
<span class="nc" id="L92">        }</span>

<span class="nc" id="L94">        assertThat(eventLogEntries).hasSize(15);</span>

<span class="nc" id="L96">        long lastLogNr = -1;</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">        for (int i = 0; i &lt; eventLogEntries.size(); i++) {</span>

<span class="nc" id="L99">            EventLogEntry entry = eventLogEntries.get(i);</span>

<span class="nc bnc" id="L101" title="All 2 branches missed.">            if (i == 0) {</span>

<span class="nc" id="L103">                assertThat(entry.getType()).isEqualTo(FlowableEngineEventType.VARIABLE_CREATED.name());</span>
<span class="nc" id="L104">                assertThat(entry.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L105">                assertThat(entry.getProcessInstanceId()).isNotNull();</span>
<span class="nc" id="L106">                assertThat(entry.getTimeStamp()).isNotNull();</span>
<span class="nc" id="L107">                assertThat(entry.getTaskId()).isNull();</span>

<span class="nc" id="L109">                Map&lt;String, Object&gt; data = objectMapper.readValue(entry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

                });
<span class="nc" id="L112">                assertThat(data)</span>
<span class="nc" id="L113">                        .containsKeys(</span>
                                Fields.PROCESS_DEFINITION_ID,
                                Fields.PROCESS_INSTANCE_ID,
                                Fields.VALUE_STRING,
                                Fields.TENANT_ID
                        )
<span class="nc" id="L119">                        .containsEntry(Fields.TENANT_ID, testTenant);</span>
            }

            // process instance start
<span class="nc bnc" id="L123" title="All 2 branches missed.">            if (i == 1) {</span>

<span class="nc" id="L125">                assertThat(entry.getType()).isEqualTo(&quot;PROCESSINSTANCE_START&quot;);</span>
<span class="nc" id="L126">                assertThat(entry.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L127">                assertThat(entry.getProcessInstanceId()).isNotNull();</span>
<span class="nc" id="L128">                assertThat(entry.getTimeStamp()).isNotNull();</span>
<span class="nc" id="L129">                assertThat(entry.getExecutionId()).isNull();</span>
<span class="nc" id="L130">                assertThat(entry.getTaskId()).isNull();</span>

<span class="nc" id="L132">                Map&lt;String, Object&gt; data = objectMapper.readValue(entry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

                });
<span class="nc" id="L135">                assertThat(data)</span>
<span class="nc" id="L136">                        .containsKeys(</span>
                                Fields.ID,
                                Fields.PROCESS_DEFINITION_ID,
                                Fields.TENANT_ID
                        )
<span class="nc" id="L141">                        .containsEntry(Fields.TENANT_ID, testTenant);</span>

<span class="nc" id="L143">                Map&lt;String, Object&gt; variableMap = (Map&lt;String, Object&gt;) data.get(Fields.VARIABLES);</span>
<span class="nc" id="L144">                assertThat(variableMap)</span>
<span class="nc" id="L145">                        .containsOnly(entry(&quot;testVar&quot;, &quot;helloWorld&quot;));</span>

<span class="nc" id="L147">                assertThat(data)</span>
<span class="nc" id="L148">                        .doesNotContainKeys(Fields.NAME, Fields.BUSINESS_KEY);</span>
            }

            // Activity started
<span class="nc bnc" id="L152" title="All 8 branches missed.">            if (i == 2 || i == 5 || i == 9 || i == 12) {</span>
<span class="nc" id="L153">                assertThat(entry.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED.name());</span>
<span class="nc" id="L154">                assertThat(entry.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L155">                assertThat(entry.getProcessInstanceId()).isNotNull();</span>
<span class="nc" id="L156">                assertThat(entry.getTimeStamp()).isNotNull();</span>
<span class="nc" id="L157">                assertThat(entry.getExecutionId()).isNotNull();</span>
<span class="nc" id="L158">                assertThat(entry.getTaskId()).isNull();</span>

<span class="nc" id="L160">                Map&lt;String, Object&gt; data = objectMapper.readValue(entry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

                });
<span class="nc" id="L163">                assertThat(data)</span>
<span class="nc" id="L164">                        .containsKeys(</span>
                                Fields.ACTIVITY_ID,
                                Fields.PROCESS_DEFINITION_ID,
                                Fields.PROCESS_INSTANCE_ID,
                                Fields.EXECUTION_ID,
                                Fields.ACTIVITY_TYPE,
                                Fields.TENANT_ID
                        )
<span class="nc" id="L172">                        .containsEntry(Fields.TENANT_ID, testTenant);</span>
            }

            // Leaving start
<span class="nc bnc" id="L176" title="All 2 branches missed.">            if (i == 3) {</span>

<span class="nc" id="L178">                assertThat(entry.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_COMPLETED.name());</span>
<span class="nc" id="L179">                assertThat(entry.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L180">                assertThat(entry.getProcessInstanceId()).isNotNull();</span>
<span class="nc" id="L181">                assertThat(entry.getTimeStamp()).isNotNull();</span>
<span class="nc" id="L182">                assertThat(entry.getExecutionId()).isNotNull();</span>
<span class="nc" id="L183">                assertThat(entry.getTaskId()).isNull();</span>

<span class="nc" id="L185">                Map&lt;String, Object&gt; data = objectMapper.readValue(entry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

                });
<span class="nc" id="L188">                assertThat(data)</span>
<span class="nc" id="L189">                        .containsKeys(</span>
                                Fields.ACTIVITY_ID,
                                Fields.PROCESS_DEFINITION_ID,
                                Fields.PROCESS_INSTANCE_ID,
                                Fields.EXECUTION_ID,
                                Fields.ACTIVITY_TYPE,
                                Fields.TENANT_ID
                        )
<span class="nc" id="L197">                        .contains(</span>
<span class="nc" id="L198">                                entry(Fields.ACTIVITY_ID, &quot;startEvent1&quot;),</span>
<span class="nc" id="L199">                                entry(Fields.TENANT_ID, &quot;testTenant&quot;)</span>
                        );
            }

            // Sequence flow taken
<span class="nc bnc" id="L204" title="All 6 branches missed.">            if (i == 4 || i == 7 || i == 8) {</span>
<span class="nc" id="L205">                assertThat(entry.getType()).isEqualTo(FlowableEngineEventType.SEQUENCEFLOW_TAKEN.name());</span>
<span class="nc" id="L206">                assertThat(entry.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L207">                assertThat(entry.getProcessInstanceId()).isNotNull();</span>
<span class="nc" id="L208">                assertThat(entry.getTimeStamp()).isNotNull();</span>
<span class="nc" id="L209">                assertThat(entry.getExecutionId()).isNotNull();</span>
<span class="nc" id="L210">                assertThat(entry.getTaskId()).isNull();</span>

<span class="nc" id="L212">                Map&lt;String, Object&gt; data = objectMapper.readValue(entry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

                });
<span class="nc" id="L215">                assertThat(data)</span>
<span class="nc" id="L216">                        .containsKeys(</span>
                                Fields.ID,
                                Fields.SOURCE_ACTIVITY_ID,
                                Fields.SOURCE_ACTIVITY_TYPE,
                                Fields.SOURCE_ACTIVITY_TYPE,
                                Fields.TENANT_ID
                        )
<span class="nc" id="L223">                        .containsEntry(Fields.TENANT_ID, testTenant);</span>
            }

            // Leaving parallel gateway
<span class="nc bnc" id="L227" title="All 2 branches missed.">            if (i == 6) {</span>

<span class="nc" id="L229">                assertThat(entry.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_COMPLETED.name());</span>
<span class="nc" id="L230">                assertThat(entry.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L231">                assertThat(entry.getProcessInstanceId()).isNotNull();</span>
<span class="nc" id="L232">                assertThat(entry.getTimeStamp()).isNotNull();</span>
<span class="nc" id="L233">                assertThat(entry.getExecutionId()).isNotNull();</span>
<span class="nc" id="L234">                assertThat(entry.getTaskId()).isNull();</span>

<span class="nc" id="L236">                Map&lt;String, Object&gt; data = objectMapper.readValue(entry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

                });
<span class="nc" id="L239">                assertThat(data)</span>
<span class="nc" id="L240">                        .containsKeys(</span>
                                Fields.ACTIVITY_ID,
                                Fields.PROCESS_DEFINITION_ID,
                                Fields.PROCESS_INSTANCE_ID,
                                Fields.EXECUTION_ID,
                                Fields.ACTIVITY_TYPE,
                                Fields.TENANT_ID
                        );
            }

            // Tasks
<span class="nc bnc" id="L251" title="All 4 branches missed.">            if (i == 11|| i == 14) {</span>

<span class="nc" id="L253">                assertThat(entry.getType()).isEqualTo(FlowableEngineEventType.TASK_CREATED.name());</span>
<span class="nc" id="L254">                assertThat(entry.getTimeStamp()).isNotNull();</span>
<span class="nc" id="L255">                assertThat(entry.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L256">                assertThat(entry.getProcessInstanceId()).isNotNull();</span>
<span class="nc" id="L257">                assertThat(entry.getExecutionId()).isNotNull();</span>
<span class="nc" id="L258">                assertThat(entry.getTaskId()).isNotNull();</span>

<span class="nc" id="L260">                Map&lt;String, Object&gt; data = objectMapper.readValue(entry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

                });
<span class="nc" id="L263">                assertThat(data)</span>
<span class="nc" id="L264">                        .containsKeys(</span>
                                Fields.ID,
                                Fields.NAME,
                                Fields.ASSIGNEE,
                                Fields.CREATE_TIME,
                                Fields.PRIORITY,
                                Fields.PROCESS_DEFINITION_ID,
                                Fields.EXECUTION_ID,
                                Fields.TENANT_ID
                        )
<span class="nc" id="L274">                        .doesNotContainKeys(</span>
                                Fields.DESCRIPTION,
                                Fields.CATEGORY,
                                Fields.OWNER,
                                Fields.DUE_DATE,
                                Fields.FORM_KEY,
                                Fields.USER_ID
                        )

<span class="nc" id="L283">                        .containsEntry(Fields.TENANT_ID, testTenant);</span>

            }

<span class="nc bnc" id="L287" title="All 4 branches missed.">            if (i == 10 || i == 13) {</span>

<span class="nc" id="L289">                assertThat(entry.getType()).isEqualTo(FlowableEngineEventType.TASK_ASSIGNED.name());</span>
<span class="nc" id="L290">                assertThat(entry.getTimeStamp()).isNotNull();</span>
<span class="nc" id="L291">                assertThat(entry.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L292">                assertThat(entry.getProcessInstanceId()).isNotNull();</span>
<span class="nc" id="L293">                assertThat(entry.getExecutionId()).isNotNull();</span>
<span class="nc" id="L294">                assertThat(entry.getTaskId()).isNotNull();</span>

<span class="nc" id="L296">                Map&lt;String, Object&gt; data = objectMapper.readValue(entry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

                });
<span class="nc" id="L299">                assertThat(data)</span>
<span class="nc" id="L300">                        .containsKeys(</span>
                                Fields.ID,
                                Fields.NAME,
                                Fields.ASSIGNEE,
                                Fields.CREATE_TIME,
                                Fields.PRIORITY,
                                Fields.PROCESS_DEFINITION_ID,
                                Fields.EXECUTION_ID,
                                Fields.TENANT_ID
                        )
<span class="nc" id="L310">                        .doesNotContainKeys(</span>
                                Fields.DESCRIPTION,
                                Fields.CATEGORY,
                                Fields.OWNER,
                                Fields.DUE_DATE,
                                Fields.FORM_KEY,
                                Fields.USER_ID
                        )

<span class="nc" id="L319">                        .containsEntry(Fields.TENANT_ID, testTenant);</span>
            }

<span class="nc" id="L322">            lastLogNr = entry.getLogNumber();</span>
        }

        // Completing two tasks
<span class="nc bnc" id="L326" title="All 2 branches missed.">        for (org.flowable.task.api.Task task : taskService.createTaskQuery().list()) {</span>
<span class="nc" id="L327">            Authentication.setAuthenticatedUserId(task.getAssignee());</span>
<span class="nc" id="L328">            Map&lt;String, Object&gt; varMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L329">            varMap.put(&quot;test&quot;, &quot;test&quot;);</span>
<span class="nc" id="L330">            taskService.complete(task.getId(), varMap);</span>
<span class="nc" id="L331">            Authentication.setAuthenticatedUserId(null);</span>
<span class="nc" id="L332">        }</span>

        // Verify events
<span class="nc" id="L335">        eventLogEntries = managementService.getEventLogEntries(lastLogNr, 100L);</span>
<span class="nc" id="L336">        assertThat(eventLogEntries).hasSize(17);</span>

<span class="nc bnc" id="L338" title="All 2 branches missed.">        for (int i = 0; i &lt; eventLogEntries.size(); i++) {</span>

<span class="nc" id="L340">            EventLogEntry entry = eventLogEntries.get(i);</span>

            // org.flowable.task.service.Task completion
<span class="nc bnc" id="L343" title="All 4 branches missed.">            if (i == 1 || i == 6) {</span>
<span class="nc" id="L344">                assertThat(entry.getType()).isEqualTo(FlowableEngineEventType.TASK_COMPLETED.name());</span>
<span class="nc" id="L345">                assertThat(entry.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L346">                assertThat(entry.getProcessInstanceId()).isNotNull();</span>
<span class="nc" id="L347">                assertThat(entry.getExecutionId()).isNotNull();</span>
<span class="nc" id="L348">                assertThat(entry.getTaskId()).isNotNull();</span>

<span class="nc" id="L350">                Map&lt;String, Object&gt; data = objectMapper.readValue(entry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

                });
<span class="nc" id="L353">                assertThat(data)</span>
<span class="nc" id="L354">                        .containsKeys(</span>
                                Fields.ID,
                                Fields.NAME,
                                Fields.ASSIGNEE,
                                Fields.CREATE_TIME,
                                Fields.PRIORITY,
                                Fields.PROCESS_DEFINITION_ID,
                                Fields.EXECUTION_ID,
                                Fields.TENANT_ID,
                                Fields.USER_ID
                        );

<span class="nc" id="L366">                Map&lt;String, Object&gt; variableMap = (Map&lt;String, Object&gt;) data.get(Fields.VARIABLES);</span>
<span class="nc" id="L367">                assertThat(variableMap)</span>
<span class="nc" id="L368">                        .containsOnly(entry(&quot;test&quot;, &quot;test&quot;));</span>

<span class="nc" id="L370">                assertThat(data)</span>
<span class="nc" id="L371">                        .doesNotContainKeys(</span>
                                Fields.DESCRIPTION,
                                Fields.CATEGORY,
                                Fields.OWNER,
                                Fields.DUE_DATE,
                                Fields.FORM_KEY
                        )
<span class="nc" id="L378">                        .containsEntry(Fields.TENANT_ID, testTenant);</span>
            }

            // Activity Completed
<span class="nc bnc" id="L382" title="All 8 branches missed.">            if (i == 2 || i == 7 || i == 10 || i == 13) {</span>
<span class="nc" id="L383">                assertThat(entry.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_COMPLETED.name());</span>
<span class="nc" id="L384">                assertThat(entry.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L385">                assertThat(entry.getProcessInstanceId()).isNotNull();</span>
<span class="nc" id="L386">                assertThat(entry.getTimeStamp()).isNotNull();</span>
<span class="nc" id="L387">                assertThat(entry.getExecutionId()).isNotNull();</span>
<span class="nc" id="L388">                assertThat(entry.getTaskId()).isNull();</span>

<span class="nc" id="L390">                Map&lt;String, Object&gt; data = objectMapper.readValue(entry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

                });
<span class="nc" id="L393">                assertThat(data)</span>
<span class="nc" id="L394">                        .containsKeys(</span>
                                Fields.ACTIVITY_ID,
                                Fields.PROCESS_DEFINITION_ID,
                                Fields.PROCESS_INSTANCE_ID,
                                Fields.EXECUTION_ID,
                                Fields.ACTIVITY_TYPE,
                                Fields.TENANT_ID,
                                Fields.BEHAVIOR_CLASS
                        )
<span class="nc" id="L403">                        .containsEntry(Fields.TENANT_ID, testTenant);</span>

<span class="nc bnc" id="L405" title="All 2 branches missed.">                if (i == 2) {</span>
<span class="nc" id="L406">                    assertThat(data)</span>
<span class="nc" id="L407">                            .containsEntry(Fields.ACTIVITY_TYPE, &quot;userTask&quot;);</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">                } else if (i == 7) {</span>
<span class="nc" id="L409">                    assertThat(data)</span>
<span class="nc" id="L410">                            .containsEntry(Fields.ACTIVITY_TYPE, &quot;userTask&quot;);</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">                } else if (i == 10) {</span>
<span class="nc" id="L412">                    assertThat(data)</span>
<span class="nc" id="L413">                            .containsEntry(Fields.ACTIVITY_TYPE, &quot;parallelGateway&quot;);</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">                } else if (i == 13) {</span>
<span class="nc" id="L415">                    assertThat(data)</span>
<span class="nc" id="L416">                            .containsEntry(Fields.ACTIVITY_TYPE, &quot;endEvent&quot;);</span>
                }

            }

            // Sequence flow taken
<span class="nc bnc" id="L422" title="All 6 branches missed.">            if (i == 3 || i == 8 || i == 11) {</span>
<span class="nc" id="L423">                assertThat(entry.getType()).isNotNull();</span>
<span class="nc" id="L424">                assertThat(FlowableEngineEventType.SEQUENCEFLOW_TAKEN.name()).isEqualTo(entry.getType());</span>
<span class="nc" id="L425">                assertThat(entry.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L426">                assertThat(entry.getProcessInstanceId()).isNotNull();</span>
<span class="nc" id="L427">                assertThat(entry.getTimeStamp()).isNotNull();</span>
<span class="nc" id="L428">                assertThat(entry.getExecutionId()).isNotNull();</span>
<span class="nc" id="L429">                assertThat(entry.getTaskId()).isNull();</span>

<span class="nc" id="L431">                Map&lt;String, Object&gt; data = objectMapper.readValue(entry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

                });
<span class="nc" id="L434">                assertThat(data)</span>
<span class="nc" id="L435">                        .containsKeys(</span>
                                Fields.ID,
                                Fields.SOURCE_ACTIVITY_ID,
                                Fields.SOURCE_ACTIVITY_TYPE,
                                Fields.SOURCE_ACTIVITY_BEHAVIOR_CLASS,
                                Fields.TARGET_ACTIVITY_ID,
                                Fields.TARGET_ACTIVITY_TYPE,
                                Fields.TARGET_ACTIVITY_BEHAVIOR_CLASS
                        )
<span class="nc" id="L444">                        .containsEntry(Fields.TENANT_ID, testTenant);</span>
            }

<span class="nc bnc" id="L447" title="All 4 branches missed.">            if (i == 14 || i == 15) {</span>
<span class="nc" id="L448">                assertThat(entry.getType()).isEqualTo(&quot;VARIABLE_DELETED&quot;);</span>
<span class="nc" id="L449">                assertThat(entry.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L450">                assertThat(entry.getProcessInstanceId()).isNotNull();</span>
<span class="nc" id="L451">                assertThat(entry.getTimeStamp()).isNotNull();</span>
<span class="nc" id="L452">                assertThat(entry.getExecutionId()).isNotNull();</span>
<span class="nc" id="L453">                assertThat(entry.getTaskId()).isNull();</span>
            }

<span class="nc bnc" id="L456" title="All 2 branches missed.">            if (i == 16) {</span>
<span class="nc" id="L457">                assertThat(entry.getType()).isEqualTo(&quot;PROCESSINSTANCE_END&quot;);</span>
<span class="nc" id="L458">                assertThat(entry.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L459">                assertThat(entry.getProcessInstanceId()).isNotNull();</span>
<span class="nc" id="L460">                assertThat(entry.getTimeStamp()).isNotNull();</span>
<span class="nc" id="L461">                assertThat(entry.getExecutionId()).isNull();</span>
<span class="nc" id="L462">                assertThat(entry.getTaskId()).isNull();</span>

<span class="nc" id="L464">                Map&lt;String, Object&gt; data = objectMapper.readValue(entry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

                });
<span class="nc" id="L467">                assertThat(data)</span>
<span class="nc" id="L468">                        .containsKeys(</span>
                                Fields.ID,
                                Fields.PROCESS_DEFINITION_ID,
                                Fields.TENANT_ID
                        )
<span class="nc" id="L473">                        .doesNotContainKeys(</span>
                                Fields.NAME,
                                Fields.BUSINESS_KEY
                        )
<span class="nc" id="L477">                        .containsEntry(Fields.TENANT_ID, testTenant);</span>
            }
        }

        // Cleanup
<span class="nc bnc" id="L482" title="All 2 branches missed.">        for (EventLogEntry eventLogEntry : managementService.getEventLogEntries(null, null)) {</span>
<span class="nc" id="L483">            managementService.deleteEventLogEntry(eventLogEntry.getLogNumber());</span>
<span class="nc" id="L484">        }</span>

<span class="nc" id="L486">        repositoryService.deleteDeployment(deploymentId, true);</span>

<span class="nc" id="L488">    }</span>

    @Test
    public void testDatabaseEventsNoTenant() throws IOException {

<span class="nc" id="L493">        String deploymentId = repositoryService.createDeployment()</span>
<span class="nc" id="L494">                .addClasspathResource(&quot;org/flowable/engine/test/api/event/DatabaseEventLoggerProcess.bpmn20.xml&quot;).deploy().getId();</span>

        // Run process to gather data
<span class="nc" id="L497">        ProcessInstance processInstance = runtimeService</span>
<span class="nc" id="L498">                .startProcessInstanceByKey(&quot;DatabaseEventLoggerProcess&quot;, CollectionUtil.singletonMap(&quot;testVar&quot;, &quot;helloWorld&quot;));</span>

        // Verify event log entries
<span class="nc" id="L501">        List&lt;EventLogEntry&gt; eventLogEntries = managementService.getEventLogEntries(null, null);</span>

<span class="nc" id="L503">        String processDefinitionId = processInstance.getProcessDefinitionId();</span>
<span class="nc" id="L504">        Iterator&lt;EventLogEntry&gt; iterator = eventLogEntries.iterator();</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">        while (iterator.hasNext()) {</span>
<span class="nc" id="L506">            EventLogEntry entry = iterator.next();</span>
<span class="nc bnc" id="L507" title="All 4 branches missed.">            if (entry.getProcessDefinitionId() != null &amp;&amp; !entry.getProcessDefinitionId().equals(processDefinitionId)) {</span>
<span class="nc" id="L508">                iterator.remove();</span>
            }
<span class="nc" id="L510">        }</span>

<span class="nc" id="L512">        assertThat(eventLogEntries).hasSize(15);</span>

<span class="nc bnc" id="L514" title="All 2 branches missed.">        for (int i = 0; i &lt; eventLogEntries.size(); i++) {</span>

<span class="nc" id="L516">            EventLogEntry entry = eventLogEntries.get(i);</span>

<span class="nc bnc" id="L518" title="All 2 branches missed.">            if (i == 0) {</span>
<span class="nc" id="L519">                assertThat(FlowableEngineEventType.VARIABLE_CREATED.name()).isEqualTo(entry.getType());</span>
<span class="nc" id="L520">                Map&lt;String, Object&gt; data = objectMapper.readValue(entry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

                });
<span class="nc" id="L523">                assertThat(data)</span>
<span class="nc" id="L524">                        .doesNotContainKey(Fields.TENANT_ID);</span>
            }

            // process instance start
<span class="nc bnc" id="L528" title="All 2 branches missed.">            if (i == 1) {</span>
<span class="nc" id="L529">                assertThat(entry.getType()).isEqualTo(&quot;PROCESSINSTANCE_START&quot;);</span>
<span class="nc" id="L530">                Map&lt;String, Object&gt; data = objectMapper.readValue(entry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

                });
<span class="nc" id="L533">                assertThat(data)</span>
<span class="nc" id="L534">                        .doesNotContainKey(Fields.TENANT_ID);</span>
            }

            // Activity started
<span class="nc bnc" id="L538" title="All 8 branches missed.">            if (i == 2 || i == 5 || i == 9 || i == 12) {</span>
<span class="nc" id="L539">                assertThat(FlowableEngineEventType.ACTIVITY_STARTED.name()).isEqualTo(entry.getType());</span>
<span class="nc" id="L540">                Map&lt;String, Object&gt; data = objectMapper.readValue(entry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

                });
<span class="nc" id="L543">                assertThat(data)</span>
<span class="nc" id="L544">                        .doesNotContainKey(Fields.TENANT_ID);</span>
            }

            // Leaving start
<span class="nc bnc" id="L548" title="All 2 branches missed.">            if (i == 3) {</span>
<span class="nc" id="L549">                assertThat(FlowableEngineEventType.ACTIVITY_COMPLETED.name()).isEqualTo(entry.getType());</span>
<span class="nc" id="L550">                Map&lt;String, Object&gt; data = objectMapper.readValue(entry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

                });
<span class="nc" id="L553">                assertThat(data)</span>
<span class="nc" id="L554">                        .doesNotContainKey(Fields.TENANT_ID);</span>
            }

            // Sequence flow taken
<span class="nc bnc" id="L558" title="All 6 branches missed.">            if (i == 4 || i == 7 || i == 8) {</span>
<span class="nc" id="L559">                assertThat(FlowableEngineEventType.SEQUENCEFLOW_TAKEN.name()).isEqualTo(entry.getType());</span>
<span class="nc" id="L560">                Map&lt;String, Object&gt; data = objectMapper.readValue(entry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

                });
<span class="nc" id="L563">                assertThat(data)</span>
<span class="nc" id="L564">                        .doesNotContainKey(Fields.TENANT_ID);</span>
            }

            // Leaving parallel gateway
<span class="nc bnc" id="L568" title="All 2 branches missed.">            if (i == 6) {</span>
<span class="nc" id="L569">                assertThat(FlowableEngineEventType.ACTIVITY_COMPLETED.name()).isEqualTo(entry.getType());</span>
<span class="nc" id="L570">                Map&lt;String, Object&gt; data = objectMapper.readValue(entry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

                });
<span class="nc" id="L573">                assertThat(data)</span>
<span class="nc" id="L574">                        .doesNotContainKey(Fields.TENANT_ID);</span>
            }

            // Tasks
<span class="nc bnc" id="L578" title="All 4 branches missed.">            if (i == 11 || i == 14) {</span>
<span class="nc" id="L579">                assertThat(FlowableEngineEventType.TASK_CREATED.name()).isEqualTo(entry.getType());</span>
<span class="nc" id="L580">                Map&lt;String, Object&gt; data = objectMapper.readValue(entry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

                });
<span class="nc" id="L583">                assertThat(data)</span>
<span class="nc" id="L584">                        .doesNotContainKey(Fields.TENANT_ID);</span>
            }

<span class="nc bnc" id="L587" title="All 4 branches missed.">            if (i == 10 || i == 13) {</span>
<span class="nc" id="L588">                assertThat(FlowableEngineEventType.TASK_ASSIGNED.name()).isEqualTo(entry.getType());</span>
<span class="nc" id="L589">                Map&lt;String, Object&gt; data = objectMapper.readValue(entry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

                });
<span class="nc" id="L592">                assertThat(data)</span>
<span class="nc" id="L593">                        .doesNotContainKey(Fields.TENANT_ID);</span>
            }

        }

<span class="nc" id="L598">        repositoryService.deleteDeployment(deploymentId, true);</span>

        // Cleanup
<span class="nc bnc" id="L601" title="All 2 branches missed.">        for (EventLogEntry eventLogEntry : managementService.getEventLogEntries(null, null)) {</span>
<span class="nc" id="L602">            managementService.deleteEventLogEntry(eventLogEntry.getLogNumber());</span>
<span class="nc" id="L603">        }</span>

<span class="nc" id="L605">    }</span>

    @Test
    public void testStandaloneTaskEvents() throws JsonParseException, JsonMappingException, IOException {

<span class="nc" id="L610">        org.flowable.task.api.Task task = taskService.newTask();</span>
<span class="nc" id="L611">        task.setAssignee(&quot;kermit&quot;);</span>
<span class="nc" id="L612">        task.setTenantId(&quot;myTenant&quot;);</span>
<span class="nc" id="L613">        taskService.saveTask(task);</span>

<span class="nc" id="L615">        List&lt;EventLogEntry&gt; events = managementService.getEventLogEntries(null, null);</span>
<span class="nc" id="L616">        assertThat(events).hasSize(2);</span>
<span class="nc" id="L617">        assertThat(events.get(0).getType()).isEqualTo(&quot;TASK_ASSIGNED&quot;);</span>
<span class="nc" id="L618">        assertThat(events.get(1).getType()).isEqualTo(&quot;TASK_CREATED&quot;);</span>

<span class="nc bnc" id="L620" title="All 2 branches missed.">        for (EventLogEntry eventLogEntry : events) {</span>
<span class="nc" id="L621">            Map&lt;String, Object&gt; data = objectMapper.readValue(eventLogEntry.getData(), new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>

            });
<span class="nc" id="L624">            assertThat(data)</span>
<span class="nc" id="L625">                    .containsEntry(Fields.TENANT_ID, &quot;myTenant&quot;);</span>
<span class="nc" id="L626">        }</span>

        // Cleanup
<span class="nc" id="L629">        taskService.deleteTask(task.getId(), true);</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">        for (EventLogEntry eventLogEntry : managementService.getEventLogEntries(null, null)) {</span>
<span class="nc" id="L631">            managementService.deleteEventLogEntry(eventLogEntry.getLogNumber());</span>
<span class="nc" id="L632">        }</span>

<span class="nc" id="L634">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>