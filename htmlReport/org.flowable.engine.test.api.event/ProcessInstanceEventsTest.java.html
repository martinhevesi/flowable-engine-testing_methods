<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProcessInstanceEventsTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.event</a> &gt; <span class="el_source">ProcessInstanceEventsTest.java</span></div><h1>ProcessInstanceEventsTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.engine.test.api.event;

import static org.assertj.core.api.Assertions.assertThat;

import java.util.ArrayList;
import java.util.List;

import org.apache.commons.lang3.builder.EqualsBuilder;
import org.flowable.bpmn.model.FlowNode;
import org.flowable.common.engine.api.delegate.event.FlowableEngineEntityEvent;
import org.flowable.common.engine.api.delegate.event.FlowableEngineEventType;
import org.flowable.common.engine.api.delegate.event.FlowableEntityEvent;
import org.flowable.common.engine.api.delegate.event.FlowableEvent;
import org.flowable.engine.delegate.event.AbstractFlowableEngineEventListener;
import org.flowable.engine.delegate.event.FlowableActivityCancelledEvent;
import org.flowable.engine.delegate.event.FlowableCancelledEvent;
import org.flowable.engine.delegate.event.FlowableProcessStartedEvent;
import org.flowable.engine.delegate.event.impl.FlowableActivityCancelledEventImpl;
import org.flowable.engine.impl.persistence.entity.ExecutionEntity;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.repository.ProcessDefinition;
import org.flowable.engine.runtime.Execution;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

/**
 * Test case for all {@link FlowableEvent}s related to process instances.
 *
 * @author Tijs Rademakers
 */
<span class="nc" id="L46">public class ProcessInstanceEventsTest extends PluggableFlowableTestCase {</span>

    private TestInitializedEntityEventListener listener;

    /**
     * Test create, update and delete events of process instances.
     */
    @Test
    @Deployment
    public void testProcessInstanceEvents() throws Exception {
<span class="nc" id="L56">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L58">        assertThat(processInstance).isNotNull();</span>

        // Check create-event
<span class="nc" id="L61">        assertProcessStartedEvents(processInstance);</span>

        FlowableEngineEntityEvent event;

<span class="nc" id="L65">        listener.clearEventsReceived();</span>
<span class="nc" id="L66">        FilteredStaticTestFlowableEventListener.clearEventsReceived();</span>

        // Check update event when suspended/activated
<span class="nc" id="L69">        runtimeService.suspendProcessInstanceById(processInstance.getId());</span>
<span class="nc" id="L70">        runtimeService.activateProcessInstanceById(processInstance.getId());</span>

<span class="nc" id="L72">        assertThat(listener.getEventsReceived()).hasSize(4);</span>
<span class="nc" id="L73">        assertThat(FilteredStaticTestFlowableEventListener.getEventsReceived()).hasSize(4);</span>

<span class="nc" id="L75">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(0);</span>
<span class="nc" id="L76">        assertThat(((ProcessInstance) event.getEntity()).getId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L77">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_SUSPENDED);</span>
<span class="nc" id="L78">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L79">        assertThat(event.getExecutionId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L80">        assertThat(event.getProcessDefinitionId()).isEqualTo(processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L81">        assertEventsEqual(event, FilteredStaticTestFlowableEventListener.getEventsReceived().get(0));</span>

<span class="nc" id="L83">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(1);</span>
<span class="nc" id="L84">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_SUSPENDED);</span>
<span class="nc" id="L85">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L86">        assertThat(processInstance.getId()).isNotEqualTo(event.getExecutionId());</span>
<span class="nc" id="L87">        assertThat(event.getProcessDefinitionId()).isEqualTo(processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L88">        assertEventsEqual(event, FilteredStaticTestFlowableEventListener.getEventsReceived().get(1));</span>

<span class="nc" id="L90">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(2);</span>
<span class="nc" id="L91">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_ACTIVATED);</span>
<span class="nc" id="L92">        assertThat(((ProcessInstance) event.getEntity()).getId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L93">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L94">        assertThat(event.getExecutionId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L95">        assertThat(event.getProcessDefinitionId()).isEqualTo(processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L96">        assertEventsEqual(event, FilteredStaticTestFlowableEventListener.getEventsReceived().get(2));</span>

<span class="nc" id="L98">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(3);</span>
<span class="nc" id="L99">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_ACTIVATED);</span>
<span class="nc" id="L100">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L101">        assertThat(processInstance.getId()).isNotEqualTo(event.getExecutionId());</span>
<span class="nc" id="L102">        assertThat(event.getProcessDefinitionId()).isEqualTo(processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L103">        assertEventsEqual(event, FilteredStaticTestFlowableEventListener.getEventsReceived().get(3));</span>

<span class="nc" id="L105">        listener.clearEventsReceived();</span>
<span class="nc" id="L106">        FilteredStaticTestFlowableEventListener.clearEventsReceived();</span>

        // Check update event when process-definition is suspended (should
        // cascade suspend/activate all process instances)
<span class="nc" id="L110">        repositoryService.suspendProcessDefinitionById(processInstance.getProcessDefinitionId(), true, null);</span>
<span class="nc" id="L111">        repositoryService.activateProcessDefinitionById(processInstance.getProcessDefinitionId(), true, null);</span>

<span class="nc" id="L113">        assertThat(listener.getEventsReceived()).hasSize(4);</span>
<span class="nc" id="L114">        assertThat(FilteredStaticTestFlowableEventListener.getEventsReceived()).hasSize(4);</span>

<span class="nc" id="L116">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(0);</span>
<span class="nc" id="L117">        assertThat(((ProcessInstance) event.getEntity()).getId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L118">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_SUSPENDED);</span>
<span class="nc" id="L119">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L120">        assertThat(event.getExecutionId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L121">        assertThat(event.getProcessDefinitionId()).isEqualTo(processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L122">        assertEventsEqual(event, FilteredStaticTestFlowableEventListener.getEventsReceived().get(0));</span>

<span class="nc" id="L124">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(1);</span>
<span class="nc" id="L125">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_SUSPENDED);</span>
<span class="nc" id="L126">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L127">        assertThat(processInstance.getId()).isNotEqualTo(event.getExecutionId());</span>
<span class="nc" id="L128">        assertThat(event.getProcessDefinitionId()).isEqualTo(processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L129">        assertEventsEqual(event, FilteredStaticTestFlowableEventListener.getEventsReceived().get(1));</span>

<span class="nc" id="L131">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(2);</span>
<span class="nc" id="L132">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_ACTIVATED);</span>
<span class="nc" id="L133">        assertThat(((ProcessInstance) event.getEntity()).getId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L134">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L135">        assertThat(event.getExecutionId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L136">        assertThat(event.getProcessDefinitionId()).isEqualTo(processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L137">        assertEventsEqual(event, FilteredStaticTestFlowableEventListener.getEventsReceived().get(2));</span>

<span class="nc" id="L139">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(3);</span>
<span class="nc" id="L140">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_ACTIVATED);</span>
<span class="nc" id="L141">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L142">        assertThat(processInstance.getId()).isNotEqualTo(event.getExecutionId());</span>
<span class="nc" id="L143">        assertThat(event.getProcessDefinitionId()).isEqualTo(processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L144">        assertEventsEqual(event, FilteredStaticTestFlowableEventListener.getEventsReceived().get(3));</span>

<span class="nc" id="L146">        listener.clearEventsReceived();</span>
<span class="nc" id="L147">        FilteredStaticTestFlowableEventListener.clearEventsReceived();</span>

        // Check update-event when business-key is updated
<span class="nc" id="L150">        runtimeService.updateBusinessKey(processInstance.getId(), &quot;thekey&quot;);</span>
<span class="nc" id="L151">        assertThat(listener.getEventsReceived()).hasSize(1);</span>
<span class="nc" id="L152">        assertThat(FilteredStaticTestFlowableEventListener.getEventsReceived()).hasSize(1);</span>

<span class="nc" id="L154">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(0);</span>
<span class="nc" id="L155">        assertThat(((ProcessInstance) event.getEntity()).getId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L156">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_UPDATED);</span>
<span class="nc" id="L157">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L158">        assertThat(event.getExecutionId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L159">        assertThat(event.getProcessDefinitionId()).isEqualTo(processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L160">        assertEventsEqual(event, FilteredStaticTestFlowableEventListener.getEventsReceived().get(0));</span>
<span class="nc" id="L161">        listener.clearEventsReceived();</span>
<span class="nc" id="L162">        FilteredStaticTestFlowableEventListener.clearEventsReceived();</span>

<span class="nc" id="L164">        runtimeService.deleteProcessInstance(processInstance.getId(), &quot;Testing events&quot;);</span>

<span class="nc" id="L166">        List&lt;FlowableEvent&gt; processCancelledEvents = listener.filterEvents(FlowableEngineEventType.PROCESS_CANCELLED);</span>
<span class="nc" id="L167">        assertThat(processCancelledEvents).hasSize(1);</span>
<span class="nc" id="L168">        FlowableCancelledEvent cancelledEvent = (FlowableCancelledEvent) processCancelledEvents.get(0);</span>
<span class="nc" id="L169">        assertThat(cancelledEvent.getType()).isEqualTo(FlowableEngineEventType.PROCESS_CANCELLED);</span>
<span class="nc" id="L170">        assertThat(cancelledEvent.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L171">        assertThat(cancelledEvent.getExecutionId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L172">        assertEventsEqual(cancelledEvent, FilteredStaticTestFlowableEventListener.filterEvents(FlowableEngineEventType.PROCESS_CANCELLED).get(0));</span>
<span class="nc" id="L173">        listener.clearEventsReceived();</span>
<span class="nc" id="L174">        FilteredStaticTestFlowableEventListener.clearEventsReceived();</span>
<span class="nc" id="L175">    }</span>

    protected void assertProcessStartedEvents(ProcessInstance processInstance) {
<span class="nc" id="L178">        assertThat(listener.getEventsReceived()).hasSize(6);</span>
<span class="nc" id="L179">        assertThat(FilteredStaticTestFlowableEventListener.getEventsReceived()).hasSize(6);</span>
<span class="nc" id="L180">        assertThat(listener.getEventsReceived().get(0)).isInstanceOf(FlowableEngineEntityEvent.class);</span>

        // process instance create event
<span class="nc" id="L183">        FlowableEngineEntityEvent event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(0);</span>
<span class="nc" id="L184">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_CREATED);</span>
<span class="nc" id="L185">        assertThat(((ProcessInstance) event.getEntity()).getId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L186">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L187">        assertThat(event.getExecutionId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L188">        assertThat(event.getProcessDefinitionId()).isEqualTo(processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L189">        assertEventsEqual(event, FilteredStaticTestFlowableEventListener.getEventsReceived().get(0));</span>

<span class="nc" id="L191">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(1);</span>
<span class="nc" id="L192">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.PROCESS_CREATED);</span>
<span class="nc" id="L193">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L194">        assertThat(event.getExecutionId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L195">        assertThat(event.getProcessDefinitionId()).isEqualTo(processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L196">        assertEventsEqual(event, FilteredStaticTestFlowableEventListener.getEventsReceived().get(1));</span>

<span class="nc" id="L198">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(2);</span>
<span class="nc" id="L199">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_INITIALIZED);</span>
<span class="nc" id="L200">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L201">        assertThat(event.getExecutionId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L202">        assertThat(event.getProcessDefinitionId()).isEqualTo(processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L203">        assertEventsEqual(event, FilteredStaticTestFlowableEventListener.getEventsReceived().get(2));</span>

        // start event create event
<span class="nc" id="L206">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(3);</span>
<span class="nc" id="L207">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_CREATED);</span>
<span class="nc" id="L208">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L209">        assertThat(processInstance.getId()).isNotEqualTo(event.getExecutionId());</span>
<span class="nc" id="L210">        assertThat(event.getProcessDefinitionId()).isEqualTo(processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L211">        assertEventsEqual(event, FilteredStaticTestFlowableEventListener.getEventsReceived().get(3));</span>

        // start event create initialized
<span class="nc" id="L214">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(4);</span>
<span class="nc" id="L215">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_INITIALIZED);</span>
<span class="nc" id="L216">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L217">        assertThat(processInstance.getId()).isNotEqualTo(event.getExecutionId());</span>
<span class="nc" id="L218">        assertThat(event.getProcessDefinitionId()).isEqualTo(processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L219">        assertEventsEqual(event, FilteredStaticTestFlowableEventListener.getEventsReceived().get(4));</span>

<span class="nc" id="L221">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(5);</span>
<span class="nc" id="L222">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.PROCESS_STARTED);</span>
<span class="nc" id="L223">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L224">        assertThat(event.getProcessDefinitionId()).isEqualTo(processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L225">        assertThat(event).isInstanceOf(FlowableProcessStartedEvent.class);</span>
<span class="nc" id="L226">        assertThat(((FlowableProcessStartedEvent) event).getNestedProcessDefinitionId()).isNull();</span>
<span class="nc" id="L227">        assertThat(((FlowableProcessStartedEvent) event).getNestedProcessInstanceId()).isNull();</span>
<span class="nc" id="L228">        assertEventsEqual(event, FilteredStaticTestFlowableEventListener.getEventsReceived().get(5));</span>
<span class="nc" id="L229">    }</span>

    /**
     * Test create, update and delete events of process instances.
     */
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/nestedSubProcess.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/runtime/subProcess.bpmn20.xml&quot; })
    public void testSubProcessInstanceEvents() throws Exception {
<span class="nc" id="L238">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;nestedSimpleSubProcess&quot;);</span>
<span class="nc" id="L239">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L240">        String processDefinitionId = processInstance.getProcessDefinitionId();</span>

        // Check create-event one main process the second one Scope execution, and the third one subprocess
<span class="nc" id="L243">        assertThat(listener.getEventsReceived()).hasSize(12);</span>
<span class="nc" id="L244">        assertThat(listener.getEventsReceived().get(0)).isInstanceOf(FlowableEngineEntityEvent.class);</span>

        // process instance created event
<span class="nc" id="L247">        FlowableEngineEntityEvent event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(0);</span>
<span class="nc" id="L248">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_CREATED);</span>
<span class="nc" id="L249">        assertThat(((ProcessInstance) event.getEntity()).getId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L250">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L251">        assertThat(event.getExecutionId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L252">        assertThat(event.getProcessDefinitionId()).isEqualTo(processDefinitionId);</span>

<span class="nc" id="L254">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(1);</span>
<span class="nc" id="L255">        String processExecutionId = event.getExecutionId();</span>
<span class="nc" id="L256">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.PROCESS_CREATED);</span>
<span class="nc" id="L257">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L258">        assertThat(processExecutionId).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L259">        assertThat(event.getProcessDefinitionId()).isEqualTo(processDefinitionId);</span>

<span class="nc" id="L261">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(2);</span>
<span class="nc" id="L262">        processExecutionId = event.getExecutionId();</span>
<span class="nc" id="L263">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_INITIALIZED);</span>
<span class="nc" id="L264">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L265">        assertThat(processExecutionId).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L266">        assertThat(event.getProcessDefinitionId()).isEqualTo(processDefinitionId);</span>

        // start event created event
<span class="nc" id="L269">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(3);</span>
<span class="nc" id="L270">        processExecutionId = event.getExecutionId();</span>
<span class="nc" id="L271">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_CREATED);</span>
<span class="nc" id="L272">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L273">        assertThat(processInstance.getId()).isNotEqualTo(processExecutionId);</span>
<span class="nc" id="L274">        assertThat(event.getProcessDefinitionId()).isEqualTo(processDefinitionId);</span>

        // start event initialized event
<span class="nc" id="L277">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(4);</span>
<span class="nc" id="L278">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_INITIALIZED);</span>
<span class="nc" id="L279">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L280">        assertThat(processInstance.getId()).isNotEqualTo(((ExecutionEntity) event.getEntity()).getId());</span>

        // Process start
<span class="nc" id="L283">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(5);</span>
<span class="nc" id="L284">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.PROCESS_STARTED);</span>
<span class="nc" id="L285">        assertThat(event.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L286">        assertThat(event.getProcessDefinitionId()).isEqualTo(processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L287">        assertThat(event).isInstanceOf(FlowableProcessStartedEvent.class);</span>
<span class="nc" id="L288">        assertThat(((FlowableProcessStartedEvent) event).getNestedProcessDefinitionId()).isNull();</span>
<span class="nc" id="L289">        assertThat(((FlowableProcessStartedEvent) event).getNestedProcessInstanceId()).isNull();</span>

        // sub process instance created event
<span class="nc" id="L292">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(6);</span>
<span class="nc" id="L293">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_CREATED);</span>
<span class="nc" id="L294">        ExecutionEntity subProcessEntity = (ExecutionEntity) event.getEntity();</span>
<span class="nc" id="L295">        assertThat(subProcessEntity.getSuperExecutionId()).isEqualTo(processExecutionId);</span>
<span class="nc" id="L296">        String subProcessInstanceId = subProcessEntity.getProcessInstanceId();</span>

<span class="nc" id="L298">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(7);</span>
<span class="nc" id="L299">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.PROCESS_CREATED);</span>
<span class="nc" id="L300">        subProcessEntity = (ExecutionEntity) event.getEntity();</span>
<span class="nc" id="L301">        assertThat(subProcessEntity.getSuperExecutionId()).isEqualTo(processExecutionId);</span>

        // sub process instance initialized event
<span class="nc" id="L304">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(8);</span>
<span class="nc" id="L305">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_INITIALIZED);</span>
<span class="nc" id="L306">        assertThat(event.getExecutionId()).isEqualTo(subProcessInstanceId);</span>
<span class="nc" id="L307">        String subProcessDefinitionId = ((ExecutionEntity) event.getEntity()).getProcessDefinitionId();</span>
<span class="nc" id="L308">        assertThat(subProcessDefinitionId).isNotNull();</span>

        // sub process instance child execution created event
<span class="nc" id="L311">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(9);</span>
<span class="nc" id="L312">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_CREATED);</span>
<span class="nc" id="L313">        assertThat(event.getProcessInstanceId()).isEqualTo(subProcessInstanceId);</span>
<span class="nc" id="L314">        assertThat(subProcessInstanceId).isNotEqualTo(event.getExecutionId());</span>
<span class="nc" id="L315">        subProcessDefinitionId = ((ExecutionEntity) event.getEntity()).getProcessDefinitionId();</span>
<span class="nc" id="L316">        assertThat(subProcessDefinitionId).isNotNull();</span>
<span class="nc" id="L317">        ProcessDefinition subProcessDefinition = repositoryService.getProcessDefinition(subProcessDefinitionId);</span>
<span class="nc" id="L318">        assertThat(subProcessDefinition.getKey()).isEqualTo(&quot;simpleSubProcess&quot;);</span>

        // sub process instance child execution initialized event
<span class="nc" id="L321">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(10);</span>
<span class="nc" id="L322">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ENTITY_INITIALIZED);</span>
<span class="nc" id="L323">        assertThat(event.getProcessInstanceId()).isEqualTo(subProcessInstanceId);</span>
<span class="nc" id="L324">        assertThat(subProcessInstanceId).isNotEqualTo(event.getExecutionId());</span>
<span class="nc" id="L325">        subProcessDefinitionId = ((ExecutionEntity) event.getEntity()).getProcessDefinitionId();</span>
<span class="nc" id="L326">        assertThat(subProcessDefinitionId).isNotNull();</span>

<span class="nc" id="L328">        event = (FlowableEngineEntityEvent) listener.getEventsReceived().get(11);</span>
<span class="nc" id="L329">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.PROCESS_STARTED);</span>
<span class="nc" id="L330">        assertThat(event.getProcessInstanceId()).isEqualTo(subProcessInstanceId);</span>
<span class="nc" id="L331">        assertThat(event.getProcessDefinitionId()).isEqualTo(subProcessDefinitionId);</span>
<span class="nc" id="L332">        assertThat(event).isInstanceOf(FlowableProcessStartedEvent.class);</span>
<span class="nc" id="L333">        assertThat(((FlowableProcessStartedEvent) event).getNestedProcessDefinitionId()).isEqualTo(processDefinitionId);</span>
<span class="nc" id="L334">        assertThat(((FlowableProcessStartedEvent) event).getNestedProcessInstanceId()).isEqualTo(processInstance.getId());</span>

<span class="nc" id="L336">        listener.clearEventsReceived();</span>
<span class="nc" id="L337">    }</span>

    /**
     * Test process with signals start.
     */
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTest.testSignalWithGlobalScope.bpmn20.xml&quot; })
    public void testSignalProcessInstanceStart() throws Exception {
<span class="nc" id="L345">        this.runtimeService.startProcessInstanceByKey(&quot;processWithSignalCatch&quot;);</span>
<span class="nc" id="L346">        listener.clearEventsReceived();</span>

<span class="nc" id="L348">        runtimeService.startProcessInstanceByKey(&quot;processWithSignalThrow&quot;);</span>
<span class="nc" id="L349">        listener.clearEventsReceived();</span>
<span class="nc" id="L350">    }</span>

    /**
     * Test Start-&gt;End process on PROCESS_COMPLETED event
     */
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/event/ProcessInstanceEventsTest.noneTaskProcess.bpmn20.xml&quot; })
    public void testProcessCompleted_StartEnd() throws Exception {
<span class="nc" id="L358">        this.runtimeService.startProcessInstanceByKey(&quot;noneTaskProcess&quot;);</span>

<span class="nc" id="L360">        assertThat(listener.filterEvents(FlowableEngineEventType.PROCESS_COMPLETED)).as(&quot;ActivitiEventType.PROCESS_COMPLETED was expected 1 time.&quot;).hasSize(1);</span>
<span class="nc" id="L361">    }</span>

    /**
     * Test Start-&gt;User org.flowable.task.service.Task process on PROCESS_COMPLETED event
     */
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/event/ProcessInstanceEventsTest.noEndProcess.bpmn20.xml&quot; })
    public void testProcessCompleted_NoEnd() throws Exception {
<span class="nc" id="L369">        ProcessInstance noEndProcess = this.runtimeService.startProcessInstanceByKey(&quot;noEndProcess&quot;);</span>
<span class="nc" id="L370">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(noEndProcess.getId()).singleResult();</span>
<span class="nc" id="L371">        taskService.complete(task.getId());</span>

<span class="nc" id="L373">        assertThat(listener.filterEvents(FlowableEngineEventType.PROCESS_COMPLETED)).as(&quot;ActivitiEventType.PROCESS_COMPLETED was expected 1 time.&quot;).hasSize(1);</span>
<span class="nc" id="L374">    }</span>

    /**
     * Test +--&gt;Task1 Start-&lt;&gt; +--&gt;Task1
     * &lt;p&gt;
     * process on PROCESS_COMPLETED event
     */
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/event/ProcessInstanceEventsTest.parallelGatewayNoEndProcess.bpmn20.xml&quot; })
    public void testProcessCompleted_ParallelGatewayNoEnd() throws Exception {
<span class="nc" id="L384">        this.runtimeService.startProcessInstanceByKey(&quot;noEndProcess&quot;);</span>

<span class="nc" id="L386">        assertThat(listener.filterEvents(FlowableEngineEventType.PROCESS_COMPLETED)).as(&quot;ActivitiEventType.PROCESS_COMPLETED was expected 1 time.&quot;).hasSize(1);</span>
<span class="nc" id="L387">    }</span>

    /**
     * &lt;p&gt;
     * Test +--&gt;End1 Start-&lt;&gt; +--&gt;End2
     * &lt;/p&gt;
     * process on PROCESS_COMPLETED event
     */
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/event/ProcessInstanceEventsTest.parallelGatewayTwoEndsProcess.bpmn20.xml&quot; })
    public void testProcessCompleted_ParallelGatewayTwoEnds() throws Exception {
<span class="nc" id="L398">        this.runtimeService.startProcessInstanceByKey(&quot;noEndProcess&quot;);</span>

<span class="nc" id="L400">        List&lt;FlowableEvent&gt; events = listener.filterEvents(FlowableEngineEventType.PROCESS_COMPLETED);</span>
<span class="nc" id="L401">        assertThat(events).as(&quot;ActivitiEventType.PROCESS_COMPLETED was expected 1 time.&quot;).hasSize(1);</span>
<span class="nc" id="L402">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.testTerminateInCallActivityMulitInstance.bpmn&quot;,
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.subProcessTerminateTerminateAll.bpmn20.xml&quot; })
    public void testProcessCompleted_TerminateInCallActivityMultiInstanceTerminateAll() throws Exception {
<span class="nc" id="L409">        runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

<span class="nc" id="L411">        List&lt;FlowableEvent&gt; events = listener.filterEvents(FlowableEngineEventType.PROCESS_COMPLETED_WITH_TERMINATE_END_EVENT);</span>
<span class="nc" id="L412">        assertThat(events).as(&quot;FlowableEventType.PROCESS_COMPLETED_WITH_TERMINATE_END_EVENT was expected 6 times.&quot;).hasSize(6);</span>
<span class="nc" id="L413">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/oneTaskProcess.bpmn20.xml&quot; })
    public void testProcessInstanceCancelledEvents_cancel() throws Exception {
<span class="nc" id="L418">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L419">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L420">        listener.clearEventsReceived();</span>

<span class="nc" id="L422">        runtimeService.deleteProcessInstance(processInstance.getId(), &quot;delete_test&quot;);</span>

<span class="nc" id="L424">        List&lt;FlowableEvent&gt; processCancelledEvents = listener.filterEvents(FlowableEngineEventType.PROCESS_CANCELLED);</span>
<span class="nc" id="L425">        assertThat(processCancelledEvents).as(&quot;ActivitiEventType.PROCESS_CANCELLED was expected 1 time.&quot;).hasSize(1);</span>
<span class="nc" id="L426">        FlowableCancelledEvent processCancelledEvent = (FlowableCancelledEvent) processCancelledEvents.get(0);</span>
<span class="nc" id="L427">        assertThat(processCancelledEvent.getProcessInstanceId()).as(&quot;The process instance has to be the same as in deleteProcessInstance method call&quot;)</span>
<span class="nc" id="L428">                .isEqualTo(processInstance.getId());</span>
<span class="nc" id="L429">        assertThat(processCancelledEvent.getExecutionId()).as(&quot;The execution instance has to be the same as in deleteProcessInstance method call&quot;)</span>
<span class="nc" id="L430">                .isEqualTo(processInstance.getId());</span>
<span class="nc" id="L431">        assertThat(processCancelledEvent.getCause()).as(&quot;The cause has to be the same as in deleteProcessInstance method call&quot;).isEqualTo(&quot;delete_test&quot;);</span>

<span class="nc" id="L433">        List&lt;FlowableEvent&gt; taskCancelledEvents = listener.filterEvents(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L434">        assertThat(taskCancelledEvents).as(&quot;ActivitiEventType.ACTIVITY_CANCELLED was expected 1 time.&quot;).hasSize(1);</span>
<span class="nc" id="L435">        FlowableActivityCancelledEvent activityCancelledEvent = (FlowableActivityCancelledEvent) taskCancelledEvents.get(0);</span>
<span class="nc" id="L436">        assertThat(activityCancelledEvent.getProcessInstanceId()).as(&quot;The process instance has to be the same as in deleteProcessInstance method call&quot;)</span>
<span class="nc" id="L437">                .isEqualTo(processInstance.getId());</span>
<span class="nc" id="L438">        assertThat(activityCancelledEvent.getCause()).as(&quot;The cause has to be the same as in deleteProcessInstance method call&quot;).isEqualTo(&quot;delete_test&quot;);</span>

<span class="nc" id="L440">        listener.clearEventsReceived();</span>
<span class="nc" id="L441">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/nestedSubProcess.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/runtime/subProcess.bpmn20.xml&quot; })
    public void testProcessInstanceCancelledEvents_cancelProcessHierarchy() throws Exception {
<span class="nc" id="L447">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;nestedSimpleSubProcess&quot;);</span>
<span class="nc" id="L448">        ProcessInstance subProcess = runtimeService.createProcessInstanceQuery().superProcessInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L449">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L450">        listener.clearEventsReceived();</span>

<span class="nc" id="L452">        runtimeService.deleteProcessInstance(processInstance.getId(), &quot;delete_test&quot;);</span>

<span class="nc" id="L454">        List&lt;FlowableEvent&gt; processCancelledEvents = listener.filterEvents(FlowableEngineEventType.PROCESS_CANCELLED);</span>
<span class="nc" id="L455">        assertThat(processCancelledEvents).as(&quot;ActivitiEventType.PROCESS_CANCELLED was expected 2 times.&quot;).hasSize(2);</span>
<span class="nc" id="L456">        FlowableCancelledEvent processCancelledEvent = (FlowableCancelledEvent) processCancelledEvents.get(0);</span>
<span class="nc" id="L457">        assertThat(processCancelledEvent.getProcessInstanceId()).as(&quot;The process instance has to be the same as in deleteProcessInstance method call&quot;)</span>
<span class="nc" id="L458">                .isEqualTo(subProcess.getId());</span>
<span class="nc" id="L459">        assertThat(processCancelledEvent.getExecutionId()).as(&quot;The execution instance has to be the same as in deleteProcessInstance method call&quot;)</span>
<span class="nc" id="L460">                .isEqualTo(subProcess.getId());</span>
<span class="nc" id="L461">        assertThat(processCancelledEvent.getCause()).as(&quot;The cause has to be the same as in deleteProcessInstance method call&quot;).isEqualTo(&quot;delete_test&quot;);</span>

<span class="nc" id="L463">        processCancelledEvent = (FlowableCancelledEvent) processCancelledEvents.get(1);</span>
<span class="nc" id="L464">        assertThat(processCancelledEvent.getProcessInstanceId()).as(&quot;The process instance has to be the same as in deleteProcessInstance method call&quot;)</span>
<span class="nc" id="L465">                .isEqualTo(processInstance.getId());</span>
<span class="nc" id="L466">        assertThat(processCancelledEvent.getExecutionId()).as(&quot;The execution instance has to be the same as in deleteProcessInstance method call&quot;)</span>
<span class="nc" id="L467">                .isEqualTo(processInstance.getId());</span>
<span class="nc" id="L468">        assertThat(processCancelledEvent.getCause()).as(&quot;The cause has to be the same as in deleteProcessInstance method call&quot;).isEqualTo(&quot;delete_test&quot;);</span>

<span class="nc" id="L470">        assertThat(this.taskService.createTaskQuery().processInstanceId(processInstance.getId()).count()).as(&quot;No task can be active for deleted process.&quot;)</span>
<span class="nc" id="L471">                .isZero();</span>

<span class="nc" id="L473">        List&lt;FlowableEvent&gt; taskCancelledEvents = listener.filterEvents(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L474">        assertThat(taskCancelledEvents).as(&quot;ActivitiEventType.ACTIVITY_CANCELLED was expected 2 times.&quot;).hasSize(2);</span>

<span class="nc" id="L476">        FlowableActivityCancelledEvent activityCancelledEvent = (FlowableActivityCancelledEvent) taskCancelledEvents.get(0);</span>
<span class="nc" id="L477">        assertThat(activityCancelledEvent.getProcessInstanceId()).as(&quot;The process instance has to point to the subprocess&quot;).isEqualTo(subProcess.getId());</span>
<span class="nc" id="L478">        assertThat(activityCancelledEvent.getCause()).as(&quot;The cause has to be the same as in deleteProcessInstance method call&quot;).isEqualTo(&quot;delete_test&quot;);</span>

<span class="nc" id="L480">        activityCancelledEvent = (FlowableActivityCancelledEvent) taskCancelledEvents.get(1);</span>
<span class="nc" id="L481">        assertThat(activityCancelledEvent.getProcessInstanceId()).as(&quot;The process instance has to point to the main process&quot;)</span>
<span class="nc" id="L482">                .isEqualTo(processInstance.getId());</span>
<span class="nc" id="L483">        assertThat(activityCancelledEvent.getActivityType()).as(&quot;expect callActivity type&quot;).isEqualTo(&quot;callActivity&quot;);</span>
<span class="nc" id="L484">        assertThat(activityCancelledEvent.getCause()).as(&quot;The cause has to be the same as in deleteProcessInstance method call&quot;).isEqualTo(&quot;delete_test&quot;);</span>

<span class="nc" id="L486">        listener.clearEventsReceived();</span>
<span class="nc" id="L487">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/oneTaskProcess.bpmn20.xml&quot; })
    public void testProcessInstanceCancelledEvents_complete() throws Exception {
<span class="nc" id="L492">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L493">        assertThat(processInstance).isNotNull();</span>

<span class="nc" id="L495">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L496">        taskService.complete(task.getId());</span>

<span class="nc" id="L498">        List&lt;FlowableEvent&gt; processCancelledEvents = listener.filterEvents(FlowableEngineEventType.PROCESS_CANCELLED);</span>
<span class="nc" id="L499">        assertThat(processCancelledEvents).as(&quot;There should be no FlowableEventType.PROCESS_CANCELLED event after process complete.&quot;).isEmpty();</span>
<span class="nc" id="L500">        List&lt;FlowableEvent&gt; taskCancelledEvents = listener.filterEvents(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L501">        assertThat(taskCancelledEvents).as(&quot;There should be no FlowableEventType.ACTIVITY_CANCELLED event.&quot;).isEmpty();</span>

<span class="nc" id="L503">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/oneTaskProcess.bpmn20.xml&quot; })
    public void testProcessInstanceTerminatedEvents_complete() throws Exception {
<span class="nc" id="L508">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L509">        assertThat(processInstance).isNotNull();</span>

<span class="nc" id="L511">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L512">        taskService.complete(task.getId());</span>

<span class="nc" id="L514">        List&lt;FlowableEvent&gt; processTerminatedEvents = listener.filterEvents(FlowableEngineEventType.PROCESS_CANCELLED);</span>
<span class="nc" id="L515">        assertThat(processTerminatedEvents).as(&quot;There should be no FlowableEventType.PROCESS_TERMINATED event after process complete.&quot;).isEmpty();</span>
<span class="nc" id="L516">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.testProcessTerminate.bpmn&quot;)
    public void testProcessInstanceTerminatedEvents() throws Exception {
<span class="nc" id="L521">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

<span class="nc" id="L523">        long executionEntities = runtimeService.createExecutionQuery().processInstanceId(pi.getId()).count();</span>
<span class="nc" id="L524">        assertThat(executionEntities).isEqualTo(3);</span>

<span class="nc" id="L526">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preTerminateTask&quot;).singleResult();</span>
<span class="nc" id="L527">        taskService.complete(task.getId());</span>

<span class="nc" id="L529">        List&lt;FlowableEvent&gt; processTerminatedEvents = listener.filterEvents(FlowableEngineEventType.PROCESS_COMPLETED_WITH_TERMINATE_END_EVENT);</span>
<span class="nc" id="L530">        assertThat(processTerminatedEvents)</span>
<span class="nc" id="L531">                .as(&quot;There should be exactly one FlowableEventType.PROCESS_COMPLETED_WITH_TERMINATE_END_EVENT event after the task complete.&quot;)</span>
<span class="nc" id="L532">                .hasSize(1);</span>
<span class="nc" id="L533">        FlowableEngineEntityEvent processCompletedEvent = (FlowableEngineEntityEvent) processTerminatedEvents.get(0);</span>
<span class="nc" id="L534">        assertThat(processCompletedEvent.getProcessInstanceId()).isEqualTo(pi.getProcessInstanceId());</span>

<span class="nc" id="L536">        List&lt;FlowableEvent&gt; activityTerminatedEvents = listener.filterEvents(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L537">        assertThat(activityTerminatedEvents)</span>
<span class="nc" id="L538">                .as(&quot;There should be exactly two FlowableEventType.ACTIVITY_CANCELLED event after the task complete.&quot;)</span>
<span class="nc" id="L539">                .hasSize(1);</span>

<span class="nc bnc" id="L541" title="All 2 branches missed.">        for (FlowableEvent event : activityTerminatedEvents) {</span>

<span class="nc" id="L543">            FlowableActivityCancelledEventImpl activityEvent = (FlowableActivityCancelledEventImpl) event;</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">            if (&quot;preNormalTerminateTask&quot;.equals(activityEvent.getActivityId())) {</span>
<span class="nc" id="L545">                assertThat(activityEvent.getActivityId())</span>
<span class="nc" id="L546">                        .as(&quot;The user task must be terminated&quot;)</span>
<span class="nc" id="L547">                        .isEqualTo(&quot;preNormalTerminateTask&quot;);</span>
<span class="nc" id="L548">                assertThat(((FlowNode) activityEvent.getCause()).getId())</span>
<span class="nc" id="L549">                        .as(&quot;The cause must be terminate end event&quot;)</span>
<span class="nc" id="L550">                        .isEqualTo(&quot;EndEvent_2&quot;);</span>
            }
<span class="nc" id="L552">        }</span>

<span class="nc" id="L554">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.testTerminateInCallActivity.bpmn&quot;,
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.subProcessTerminate.bpmn&quot; })
    public void testProcessInstanceTerminatedEvents_callActivity() throws Exception {
<span class="nc" id="L560">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

<span class="nc" id="L562">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preNormalEnd&quot;).singleResult();</span>
<span class="nc" id="L563">        taskService.complete(task.getId());</span>

<span class="nc" id="L565">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L566">        List&lt;FlowableEvent&gt; processTerminatedEvents = listener.filterEvents(FlowableEngineEventType.PROCESS_COMPLETED_WITH_TERMINATE_END_EVENT);</span>
<span class="nc" id="L567">        assertThat(processTerminatedEvents)</span>
<span class="nc" id="L568">                .as(&quot;There should be exactly one FlowableEventType.PROCESS_COMPLETED_WITH_TERMINATE_END_EVENT event after the task complete.&quot;)</span>
<span class="nc" id="L569">                .hasSize(1);</span>
<span class="nc" id="L570">        FlowableEngineEntityEvent processCompletedEvent = (FlowableEngineEntityEvent) processTerminatedEvents.get(0);</span>
<span class="nc" id="L571">        assertThat(pi.getProcessInstanceId()).isNotEqualTo(processCompletedEvent.getProcessInstanceId());</span>
<span class="nc" id="L572">        assertThat(processCompletedEvent.getProcessDefinitionId()).contains(&quot;terminateEndEventSubprocessExample&quot;);</span>

<span class="nc" id="L574">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.testTerminateInSubProcessWithBoundaryTerminateAll.bpmn20.xml&quot; })
    public void testTerminateAllInSubProcess() throws Exception {
<span class="nc" id="L579">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventWithBoundary&quot;);</span>

<span class="nc" id="L581">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preTermInnerTask&quot;).singleResult();</span>
<span class="nc" id="L582">        taskService.complete(task.getId());</span>

<span class="nc" id="L584">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L585">        List&lt;FlowableEvent&gt; processTerminatedEvents = listener.filterEvents(FlowableEngineEventType.PROCESS_COMPLETED_WITH_TERMINATE_END_EVENT);</span>
<span class="nc" id="L586">        assertThat(processTerminatedEvents)</span>
<span class="nc" id="L587">                .as(&quot;There should be exactly one FlowableEventType.PROCESS_COMPLETED_WITH_TERMINATE_END_EVENT event after the task complete.&quot;)</span>
<span class="nc" id="L588">                .hasSize(1);</span>
<span class="nc" id="L589">        FlowableEngineEntityEvent processCompletedEvent = (FlowableEngineEntityEvent) processTerminatedEvents.get(0);</span>
<span class="nc" id="L590">        assertThat(processCompletedEvent.getProcessInstanceId()).isEqualTo(pi.getProcessInstanceId());</span>

<span class="nc" id="L592">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.testTerminateInParentProcess.bpmn&quot;,
            &quot;org/flowable/engine/test/api/runtime/oneTaskProcess.bpmn20.xml&quot; })
    public void testProcessInstanceTerminatedEvents_terminateInParentProcess() throws Exception {
<span class="nc" id="L598">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateParentProcess&quot;);</span>

        // should terminate the called process and continue the parent
<span class="nc" id="L601">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preTerminateEnd&quot;).singleResult();</span>
<span class="nc" id="L602">        taskService.complete(task.getId());</span>

<span class="nc" id="L604">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L605">        List&lt;FlowableEvent&gt; processTerminatedEvents = listener.filterEvents(FlowableEngineEventType.PROCESS_COMPLETED_WITH_TERMINATE_END_EVENT);</span>
<span class="nc" id="L606">        assertThat(processTerminatedEvents)</span>
<span class="nc" id="L607">                .as(&quot;There should be exactly one FlowableEventType.PROCESS_COMPLETED_WITH_TERMINATE_END_EVENT event after the task complete.&quot;)</span>
<span class="nc" id="L608">                .hasSize(1);</span>
<span class="nc" id="L609">        FlowableEngineEntityEvent processCompletedEvent = (FlowableEngineEntityEvent) processTerminatedEvents.get(0);</span>
<span class="nc" id="L610">        assertThat(processCompletedEvent.getProcessInstanceId()).isEqualTo(pi.getProcessInstanceId());</span>
<span class="nc" id="L611">        assertThat(processCompletedEvent.getProcessDefinitionId()).contains(&quot;terminateParentProcess&quot;);</span>

<span class="nc" id="L613">        List&lt;FlowableEvent&gt; activityTerminatedEvents = listener.filterEvents(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L614">        assertThat(activityTerminatedEvents)</span>
<span class="nc" id="L615">                .as(&quot;Two activities must be cancelled.&quot;)</span>
<span class="nc" id="L616">                .hasSize(2);</span>

<span class="nc bnc" id="L618" title="All 2 branches missed.">        for (FlowableEvent event : activityTerminatedEvents) {</span>

<span class="nc" id="L620">            FlowableActivityCancelledEventImpl activityEvent = (FlowableActivityCancelledEventImpl) event;</span>

<span class="nc bnc" id="L622" title="All 2 branches missed.">            if (&quot;theTask&quot;.equals(activityEvent.getActivityId())) {</span>

<span class="nc" id="L624">                assertThat(activityEvent.getActivityId())</span>
<span class="nc" id="L625">                        .as(&quot;The user task must be terminated in the called sub process.&quot;)</span>
<span class="nc" id="L626">                        .isEqualTo(&quot;theTask&quot;);</span>
<span class="nc" id="L627">                assertThat(((FlowNode) activityEvent.getCause()).getId())</span>
<span class="nc" id="L628">                        .as(&quot;The cause must be terminate end event&quot;)</span>
<span class="nc" id="L629">                        .isEqualTo(&quot;EndEvent_3&quot;);</span>

<span class="nc bnc" id="L631" title="All 2 branches missed.">            } else if (&quot;CallActivity_1&quot;.equals(activityEvent.getActivityId())) {</span>

<span class="nc" id="L633">                assertThat(activityEvent.getActivityId())</span>
<span class="nc" id="L634">                        .as(&quot;The call activity must be terminated&quot;)</span>
<span class="nc" id="L635">                        .isEqualTo(&quot;CallActivity_1&quot;);</span>
<span class="nc" id="L636">                assertThat(((FlowNode) activityEvent.getCause()).getId())</span>
<span class="nc" id="L637">                        .as(&quot;The cause must be terminate end event&quot;)</span>
<span class="nc" id="L638">                        .isEqualTo(&quot;EndEvent_3&quot;);</span>
            }

<span class="nc" id="L641">        }</span>

<span class="nc" id="L643">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/bpmn/event/error/BoundaryErrorEventTest.testCatchErrorOnCallActivity-parent.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/event/error/BoundaryErrorEventTest.subprocess.bpmn20.xml&quot;
    })
    public void testProcessCompletedEvents_callActivityErrorEndEvent() throws Exception {
<span class="nc" id="L651">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;catchErrorOnCallActivity&quot;);</span>

<span class="nc" id="L653">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L654">        assertThat(task.getName()).isEqualTo(&quot;Task in subprocess&quot;);</span>
<span class="nc" id="L655">        List&lt;ProcessInstance&gt; subProcesses = runtimeService.createProcessInstanceQuery().superProcessInstanceId(pi.getId()).list();</span>
<span class="nc" id="L656">        assertThat(subProcesses).hasSize(1);</span>

        // Completing the task will reach the end error event,
        // which is caught on the call activity boundary
<span class="nc" id="L660">        taskService.complete(task.getId());</span>

<span class="nc" id="L662">        List&lt;FlowableEvent&gt; processCompletedEvents = listener.filterEvents(FlowableEngineEventType.PROCESS_COMPLETED_WITH_ERROR_END_EVENT);</span>
<span class="nc" id="L663">        assertThat(processCompletedEvents)</span>
<span class="nc" id="L664">                .as(&quot;There should be exactly an FlowableEventType.PROCESS_COMPLETED_WITH_ERROR_END_EVENT event after the task complete.&quot;)</span>
<span class="nc" id="L665">                .hasSize(1);</span>
<span class="nc" id="L666">        FlowableEngineEntityEvent processCompletedEvent = (FlowableEngineEntityEvent) processCompletedEvents.get(0);</span>
<span class="nc" id="L667">        assertThat(processCompletedEvent.getExecutionId()).isEqualTo(subProcesses.get(0).getId());</span>

<span class="nc" id="L669">        task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L670">        assertThat(task.getName()).isEqualTo(&quot;Escalated Task&quot;);</span>

        // Completing the task will end the process instance
<span class="nc" id="L673">        taskService.complete(task.getId());</span>
<span class="nc" id="L674">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L675">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testParallelCallActivity.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.externalSubProcess.bpmn20.xml&quot; })
    public void testDeleteMultiInstanceCallActivityProcessInstance() {
<span class="nc" id="L682">        assertThat(taskService.createTaskQuery().count()).isZero();</span>
<span class="nc" id="L683">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;miParallelCallActivity&quot;);</span>
<span class="nc" id="L684">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(7);</span>
<span class="nc" id="L685">        assertThat(taskService.createTaskQuery().count()).isEqualTo(12);</span>
<span class="nc" id="L686">        this.listener.clearEventsReceived();</span>

<span class="nc" id="L688">        runtimeService.deleteProcessInstance(processInstance.getId(), &quot;testing instance deletion&quot;);</span>

<span class="nc" id="L690">        assertThat(this.listener.getEventsReceived().get(0).getType()).as(&quot;Task cancelled event has to be fired.&quot;)</span>
<span class="nc" id="L691">                .isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L692">        assertThat(this.listener.getEventsReceived().get(2).getType()).as(&quot;SubProcess cancelled event has to be fired.&quot;)</span>
<span class="nc" id="L693">                .isEqualTo(FlowableEngineEventType.PROCESS_CANCELLED);</span>
<span class="nc" id="L694">        assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>
<span class="nc" id="L695">        assertThat(taskService.createTaskQuery().count()).isZero();</span>
<span class="nc" id="L696">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/runtime/subProcessWithTerminateEnd.bpmn20.xml&quot;)
    public void testProcessInstanceTerminatedEventInSubProcess() throws Exception {
<span class="nc" id="L701">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;subProcessWithTerminateEndTest&quot;);</span>

<span class="nc" id="L703">        long executionEntities = runtimeService.createExecutionQuery().processInstanceId(pi.getId()).count();</span>
<span class="nc" id="L704">        assertThat(executionEntities).isEqualTo(4);</span>

<span class="nc" id="L706">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(pi.getId()).list();</span>
<span class="nc" id="L707">        assertThat(tasks).hasSize(1);</span>

<span class="nc" id="L709">        Execution execution = runtimeService.createExecutionQuery().messageEventSubscriptionName(&quot;cancel&quot;).singleResult();</span>
<span class="nc" id="L710">        assertThat(execution).isNotNull();</span>

        // message received cancels the SubProcess. We expect an event for all flow elements
        // when the process state changes. We expect the activity cancelled event for the task within the
        // Subprocess and the SubProcess itself
<span class="nc" id="L715">        runtimeService.messageEventReceived(&quot;cancel&quot;, execution.getId());</span>

<span class="nc" id="L717">        List&lt;FlowableEvent&gt; activityTerminatedEvents = listener.filterEvents(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L718">        assertThat(activityTerminatedEvents).hasSize(2);</span>

<span class="nc" id="L720">        boolean taskFound = false;</span>
<span class="nc" id="L721">        boolean subProcessFound = false;</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">        for (FlowableEvent terminatedEvent : activityTerminatedEvents) {</span>
<span class="nc" id="L723">            FlowableActivityCancelledEvent activityEvent = (FlowableActivityCancelledEvent) terminatedEvent;</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">            if (&quot;userTask&quot;.equals(activityEvent.getActivityType())) {</span>
<span class="nc" id="L725">                taskFound = true;</span>
<span class="nc" id="L726">                assertThat(activityEvent.getActivityId()).isEqualTo(&quot;task&quot;);</span>

<span class="nc bnc" id="L728" title="All 2 branches missed.">            } else if (&quot;subProcess&quot;.equals(activityEvent.getActivityType())) {</span>
<span class="nc" id="L729">                subProcessFound = true;</span>
<span class="nc" id="L730">                assertThat(activityEvent.getActivityId()).isEqualTo(&quot;embeddedSubprocess&quot;);</span>
            }
<span class="nc" id="L732">        }</span>

<span class="nc" id="L734">        assertThat(taskFound).isTrue();</span>
<span class="nc" id="L735">        assertThat(subProcessFound).isTrue();</span>
<span class="nc" id="L736">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/runtime/multipleSubprocessTerminateEnd.bpmn20.xml&quot;)
    public void testProcessInstanceWithMultipleSubprocessAndTerminateEnd2() throws Exception {
<span class="nc" id="L741">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;multiplesubProcessWithTerminateEndTest&quot;);</span>

<span class="nc" id="L743">        List&lt;Execution&gt; subprocesses = runtimeService.createExecutionQuery().processInstanceId(pi.getId())</span>
<span class="nc" id="L744">                .onlySubProcessExecutions().list();</span>
<span class="nc" id="L745">        assertThat(subprocesses).hasSize(2);</span>

<span class="nc" id="L747">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(pi.getId()).list();</span>
<span class="nc" id="L748">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L750">        org.flowable.task.api.Task task2 = null;</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">        for (org.flowable.task.api.Task task : tasks) {</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">            if (&quot;Task in subprocess2&quot;.equals(task.getName())) {</span>
<span class="nc" id="L753">                task2 = task;</span>
<span class="nc" id="L754">                break;</span>

            }
<span class="nc" id="L757">        }</span>

        // Complete user task in subprocess2. This flows out of subprocess2 to
        // the terminate end event. This will cause subprocess1 to be cancelled along
        // with the user task, boundary event and intermediate catch event defined in or
        // on subprocess1.
<span class="nc" id="L763">        assertThat(task2).isNotNull();</span>
<span class="nc" id="L764">        taskService.complete(task2.getId());</span>

        // Subprocess2 completed and transitioned to terminate end. We expect
        // ACTIVITY_CANCELLED for Subprocess1, task1 defined in subprocess1, boundary event defined on
        // and the timer intermediate catch event defined in subprocess1
<span class="nc" id="L769">        boolean userTaskFound = false;</span>
<span class="nc" id="L770">        boolean subprocessFound = false;</span>
<span class="nc" id="L771">        boolean timerCatchEventFound = false;</span>
<span class="nc" id="L772">        boolean boundaryEventFound = false;</span>
<span class="nc" id="L773">        List&lt;FlowableEvent&gt; activityTerminatedEvents = listener</span>
<span class="nc" id="L774">                .filterEvents(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L775">        assertThat(activityTerminatedEvents).hasSize(4);</span>
<span class="nc bnc" id="L776" title="All 2 branches missed.">        for (FlowableEvent flowableEvent : activityTerminatedEvents) {</span>
<span class="nc" id="L777">            FlowableActivityCancelledEvent activityCancelledEvent = (FlowableActivityCancelledEvent) flowableEvent;</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">            if (&quot;intermediateCatchEvent&quot;.equals(activityCancelledEvent.getActivityType())) {</span>
<span class="nc" id="L779">                assertThat(activityCancelledEvent.getActivityId()).isEqualTo(&quot;timer&quot;);</span>
<span class="nc" id="L780">                timerCatchEventFound = true;</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">            } else if (&quot;boundaryEvent&quot;.equals(activityCancelledEvent.getActivityType())) {</span>
<span class="nc" id="L782">                boundaryEventFound = true;</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">            } else if (&quot;userTask&quot;.equals(activityCancelledEvent.getActivityType())) {</span>
<span class="nc" id="L784">                assertThat(activityCancelledEvent.getActivityName()).isEqualTo(&quot;Task in subprocess1&quot;);</span>
<span class="nc" id="L785">                userTaskFound = true;</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">            } else if (&quot;subProcess&quot;.equals(activityCancelledEvent.getActivityType())) {</span>
<span class="nc" id="L787">                assertThat(activityCancelledEvent.getActivityId()).isEqualTo(&quot;subprocess1&quot;);</span>
<span class="nc" id="L788">                subprocessFound = true;</span>
            }
<span class="nc" id="L790">        }</span>

<span class="nc" id="L792">        assertThat(timerCatchEventFound).isTrue();</span>
<span class="nc" id="L793">        assertThat(boundaryEventFound).isTrue();</span>
<span class="nc" id="L794">        assertThat(userTaskFound).isTrue();</span>
<span class="nc" id="L795">        assertThat(subprocessFound).isTrue();</span>

<span class="nc" id="L797">        List&lt;FlowableEvent&gt; processCompletedEvents = listener.filterEvents(FlowableEngineEventType.PROCESS_COMPLETED);</span>
<span class="nc" id="L798">        assertThat(processCompletedEvents).isEmpty();</span>

<span class="nc" id="L800">        List&lt;FlowableEvent&gt; processCompletedTerminateEndEvents = listener</span>
<span class="nc" id="L801">                .filterEvents(FlowableEngineEventType.PROCESS_COMPLETED_WITH_TERMINATE_END_EVENT);</span>
<span class="nc" id="L802">        assertThat(processCompletedTerminateEndEvents).hasSize(1);</span>

        // Only expect PROCESS_COMPLETED_WITH_TERMINATE_END_EVENT, not
        // PROCESS_CANCELLED.
<span class="nc" id="L806">        List&lt;FlowableEvent&gt; processCanceledEvents = listener.filterEvents(FlowableEngineEventType.PROCESS_CANCELLED);</span>
<span class="nc" id="L807">        assertThat(processCanceledEvents).isEmpty();</span>
<span class="nc" id="L808">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/event/ProcessInstanceEventsTest.testProcessInstanceEvents.bpmn20.xml&quot;)
    public void startAsyncProcessInstanceEvents() {
<span class="nc" id="L813">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;oneTaskProcess&quot;).startAsync();</span>
<span class="nc" id="L814">        assertThat(processInstance).isNotNull();</span>

<span class="nc" id="L816">        assertProcessStartedEvents(processInstance);</span>
<span class="nc" id="L817">        listener.clearEventsReceived();</span>
<span class="nc" id="L818">        FilteredStaticTestFlowableEventListener.clearEventsReceived();</span>
<span class="nc" id="L819">    }</span>

    private void assertEventsEqual(FlowableEvent event1, FlowableEvent event2) {
<span class="nc" id="L822">        assertThat(EqualsBuilder.reflectionEquals(event1, event2)).isTrue();</span>

<span class="nc" id="L824">    }</span>

    @BeforeEach
    protected void setUp() {
<span class="nc" id="L828">        this.listener = new TestInitializedEntityEventListener();</span>
<span class="nc" id="L829">        processEngineConfiguration.getEventDispatcher().addEventListener(this.listener);</span>
<span class="nc" id="L830">        FilteredStaticTestFlowableEventListener.clearEventsReceived();</span>
<span class="nc" id="L831">    }</span>

    @AfterEach
    protected void tearDown() throws Exception {

<span class="nc bnc" id="L836" title="All 2 branches missed.">        if (listener != null) {</span>
<span class="nc" id="L837">            listener.clearEventsReceived();</span>
<span class="nc" id="L838">            processEngineConfiguration.getEventDispatcher().removeEventListener(listener);</span>
        }
<span class="nc" id="L840">    }</span>

    private class TestInitializedEntityEventListener extends AbstractFlowableEngineEventListener {

        private List&lt;FlowableEvent&gt; eventsReceived;

<span class="nc" id="L846">        public TestInitializedEntityEventListener() {</span>

<span class="nc" id="L848">            eventsReceived = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L849">        }</span>

        public List&lt;FlowableEvent&gt; getEventsReceived() {
<span class="nc" id="L852">            return eventsReceived;</span>
        }

        public void clearEventsReceived() {
<span class="nc" id="L856">            eventsReceived.clear();</span>
<span class="nc" id="L857">        }</span>

        @Override
        public void onEvent(FlowableEvent event) {
<span class="nc bnc" id="L861" title="All 4 branches missed.">            if (event instanceof FlowableEntityEvent &amp;&amp; ProcessInstance.class.isAssignableFrom(((FlowableEntityEvent) event).getEntity().getClass())) {</span>
                // check whether entity in the event is initialized before
                // adding to the list.
<span class="nc" id="L864">                assertThat(((ExecutionEntity) ((FlowableEntityEvent) event).getEntity()).getId()).isNotNull();</span>
<span class="nc" id="L865">                eventsReceived.add(event);</span>
<span class="nc bnc" id="L866" title="All 4 branches missed.">            } else if (FlowableEngineEventType.PROCESS_CANCELLED == event.getType() || FlowableEngineEventType.ACTIVITY_CANCELLED == event.getType()) {</span>
<span class="nc" id="L867">                eventsReceived.add(event);</span>
            }
<span class="nc" id="L869">        }</span>

        @Override
        public boolean isFailOnException() {
<span class="nc" id="L873">            return true;</span>
        }

        public List&lt;FlowableEvent&gt; filterEvents(FlowableEngineEventType eventType) {// count
            // timer cancelled events
<span class="nc" id="L878">            List&lt;FlowableEvent&gt; filteredEvents = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L879">            List&lt;FlowableEvent&gt; eventsReceived = listener.getEventsReceived();</span>
<span class="nc bnc" id="L880" title="All 2 branches missed.">            for (FlowableEvent eventReceived : eventsReceived) {</span>
<span class="nc bnc" id="L881" title="All 2 branches missed.">                if (eventType == eventReceived.getType()) {</span>
<span class="nc" id="L882">                    filteredEvents.add(eventReceived);</span>
                }
<span class="nc" id="L884">            }</span>
<span class="nc" id="L885">            return filteredEvents;</span>
        }

    }

<span class="nc" id="L890">    public static class FilteredStaticTestFlowableEventListener extends StaticTestFlowableEventListener {</span>

        @Override
        public void onEvent(FlowableEvent event) {
<span class="nc bnc" id="L894" title="All 4 branches missed.">            if (event instanceof FlowableEntityEvent &amp;&amp; ProcessInstance.class.isAssignableFrom(((FlowableEntityEvent) event).getEntity().getClass())) {</span>
                // check whether entity in the event is initialized before
                // adding to the list.
<span class="nc" id="L897">                assertThat(((ExecutionEntity) ((FlowableEntityEvent) event).getEntity()).getId()).isNotNull();</span>
<span class="nc" id="L898">                super.onEvent(event);</span>
<span class="nc bnc" id="L899" title="All 4 branches missed.">            } else if (FlowableEngineEventType.PROCESS_CANCELLED == event.getType() || FlowableEngineEventType.ACTIVITY_CANCELLED == event.getType()) {</span>
<span class="nc" id="L900">                super.onEvent(event);</span>
            }
<span class="nc" id="L902">        }</span>

        static List&lt;FlowableEvent&gt; filterEvents(FlowableEngineEventType eventType) {
<span class="nc" id="L905">            List&lt;FlowableEvent&gt; filteredEvents = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L906" title="All 2 branches missed.">            for (FlowableEvent eventReceived : FilteredStaticTestFlowableEventListener.getEventsReceived()) {</span>
<span class="nc bnc" id="L907" title="All 2 branches missed.">                if (eventType == eventReceived.getType()) {</span>
<span class="nc" id="L908">                    filteredEvents.add(eventReceived);</span>
                }
<span class="nc" id="L910">            }</span>
<span class="nc" id="L911">            return filteredEvents;</span>
        }

    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>