<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TaskEntityManagerImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.task.service.impl.persistence.entity</a> &gt; <span class="el_source">TaskEntityManagerImpl.java</span></div><h1>TaskEntityManagerImpl.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.task.service.impl.persistence.entity;

import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Objects;

import org.flowable.common.engine.api.delegate.event.FlowableEngineEventType;
import org.flowable.common.engine.impl.identity.Authentication;
import org.flowable.task.api.Task;
import org.flowable.task.api.TaskBuilder;
import org.flowable.task.api.TaskInfo;
import org.flowable.task.api.history.HistoricTaskLogEntryBuilder;
import org.flowable.task.api.history.HistoricTaskLogEntryType;
import org.flowable.task.service.TaskServiceConfiguration;
import org.flowable.task.service.event.impl.FlowableTaskEventBuilder;
import org.flowable.task.service.impl.BaseHistoricTaskLogEntryBuilderImpl;
import org.flowable.task.service.impl.TaskQueryImpl;
import org.flowable.task.service.impl.persistence.CountingTaskEntity;
import org.flowable.task.service.impl.persistence.entity.data.TaskDataManager;

import com.fasterxml.jackson.databind.node.ObjectNode;

/**
 * @author Tom Baeyens
 * @author Joram Barrez
 */
public class TaskEntityManagerImpl extends AbstractTaskServiceEntityManager&lt;TaskEntity, TaskDataManager&gt; implements TaskEntityManager {
    
    public TaskEntityManagerImpl(TaskServiceConfiguration taskServiceConfiguration, TaskDataManager taskDataManager) {
<span class="nc" id="L44">        super(taskServiceConfiguration, taskDataManager);</span>
<span class="nc" id="L45">    }</span>

    @Override
    public TaskEntity create() {
<span class="nc" id="L49">        TaskEntity taskEntity = super.create();</span>
<span class="nc" id="L50">        taskEntity.setCreateTime(getClock().getCurrentTime());</span>
<span class="nc" id="L51">        taskEntity.setState(Task.CREATED);</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">        if (serviceConfiguration.isEnableTaskRelationshipCounts()) {</span>
<span class="nc" id="L53">            ((CountingTaskEntity) taskEntity).setCountEnabled(true);</span>
        }
<span class="nc" id="L55">        return taskEntity;</span>
    }

    @Override
    public TaskEntity createTask(TaskBuilder taskBuilder) {
        // create and insert task
<span class="nc" id="L61">        TaskEntity taskEntity = create();</span>
<span class="nc" id="L62">        taskEntity.setId(taskBuilder.getId());</span>
<span class="nc" id="L63">        taskEntity.setName(taskBuilder.getName());</span>
<span class="nc" id="L64">        taskEntity.setDescription(taskBuilder.getDescription());</span>
<span class="nc" id="L65">        taskEntity.setPriority(taskBuilder.getPriority());</span>
<span class="nc" id="L66">        taskEntity.setOwner(taskBuilder.getOwner());</span>
<span class="nc" id="L67">        taskEntity.setAssignee(taskBuilder.getAssignee());</span>
<span class="nc" id="L68">        taskEntity.setDueDate(taskBuilder.getDueDate());</span>
<span class="nc" id="L69">        taskEntity.setCategory(taskBuilder.getCategory());</span>
<span class="nc" id="L70">        taskEntity.setParentTaskId(taskBuilder.getParentTaskId());</span>
<span class="nc" id="L71">        taskEntity.setTenantId(taskBuilder.getTenantId());</span>
<span class="nc" id="L72">        taskEntity.setFormKey(taskBuilder.getFormKey());</span>
<span class="nc" id="L73">        taskEntity.setTaskDefinitionId(taskBuilder.getTaskDefinitionId());</span>
<span class="nc" id="L74">        taskEntity.setTaskDefinitionKey(taskBuilder.getTaskDefinitionKey());</span>
<span class="nc" id="L75">        taskEntity.setScopeId(taskBuilder.getScopeId());</span>
<span class="nc" id="L76">        taskEntity.setScopeType(taskBuilder.getScopeType());</span>
<span class="nc" id="L77">        insert(taskEntity);</span>

<span class="nc" id="L79">        TaskEntity enrichedTaskEntity = serviceConfiguration.getTaskPostProcessor().enrich(taskEntity);</span>
<span class="nc" id="L80">        update(enrichedTaskEntity, false);</span>
<span class="nc" id="L81">        taskBuilder.getIdentityLinks().forEach(</span>
                identityLink -&gt; {
<span class="nc bnc" id="L83" title="All 2 branches missed.">                    if (identityLink.getGroupId() != null) {</span>
<span class="nc" id="L84">                        enrichedTaskEntity.addGroupIdentityLink(identityLink.getGroupId(), identityLink.getType());</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                    } else if (identityLink.getUserId() != null) {</span>
<span class="nc" id="L86">                        enrichedTaskEntity.addUserIdentityLink(identityLink.getUserId(), identityLink.getType());</span>
                    }
<span class="nc" id="L88">                }</span>
        );

<span class="nc bnc" id="L91" title="All 6 branches missed.">        if (getEventDispatcher() != null &amp;&amp; getEventDispatcher().isEnabled() &amp;&amp; taskEntity.getAssignee() != null) {</span>
<span class="nc" id="L92">            getEventDispatcher().dispatchEvent(FlowableTaskEventBuilder.createEntityEvent(FlowableEngineEventType.TASK_ASSIGNED, taskEntity),</span>
<span class="nc" id="L93">                    serviceConfiguration.getEngineName());</span>
        }

<span class="nc" id="L96">        serviceConfiguration.getInternalHistoryTaskManager().recordTaskCreated(taskEntity);</span>

<span class="nc" id="L98">        return enrichedTaskEntity;</span>
    }

    @Override
    public void insert(TaskEntity taskEntity, boolean fireCreatedEvent) {
<span class="nc" id="L103">        super.insert(taskEntity, fireCreatedEvent);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (fireCreatedEvent) {</span>
<span class="nc" id="L105">            logTaskCreatedEvent(taskEntity);</span>
        }
<span class="nc" id="L107">    }</span>

    @Override
    public TaskEntity update(TaskEntity taskEntity, boolean fireUpdateEvents) {
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (fireUpdateEvents) {</span>
<span class="nc" id="L112">            logTaskUpdateEvents(taskEntity);</span>
        }
<span class="nc" id="L114">        return super.update(taskEntity, fireUpdateEvents);</span>
    }

    @Override
    public void changeTaskAssignee(TaskEntity taskEntity, String assignee) {
<span class="nc bnc" id="L119" title="All 4 branches missed.">        if ((taskEntity.getAssignee() != null &amp;&amp; !taskEntity.getAssignee().equals(assignee))</span>
<span class="nc bnc" id="L120" title="All 4 branches missed.">                || (taskEntity.getAssignee() == null &amp;&amp; assignee != null)) {</span>

<span class="nc" id="L122">            taskEntity.setAssignee(assignee);</span>
            
<span class="nc bnc" id="L124" title="All 2 branches missed.">            if (taskEntity.getId() != null) {</span>
<span class="nc" id="L125">                serviceConfiguration.getInternalHistoryTaskManager().recordTaskInfoChange(taskEntity, getClock().getCurrentTime());</span>
<span class="nc" id="L126">                update(taskEntity);</span>
            }
        }
<span class="nc" id="L129">    }</span>

    @Override
    public void changeTaskOwner(TaskEntity taskEntity, String owner) {
<span class="nc bnc" id="L133" title="All 4 branches missed.">        if ((taskEntity.getOwner() != null &amp;&amp; !taskEntity.getOwner().equals(owner))</span>
<span class="nc bnc" id="L134" title="All 4 branches missed.">                || (taskEntity.getOwner() == null &amp;&amp; owner != null)) {</span>
            
<span class="nc" id="L136">            taskEntity.setOwner(owner);</span>

<span class="nc bnc" id="L138" title="All 2 branches missed.">            if (taskEntity.getId() != null) {</span>
<span class="nc" id="L139">                serviceConfiguration.getInternalHistoryTaskManager().recordTaskInfoChange(taskEntity, getClock().getCurrentTime());</span>
<span class="nc" id="L140">                update(taskEntity);</span>
            }
        }
<span class="nc" id="L143">    }</span>

    @Override
    public List&lt;TaskEntity&gt; findTasksByExecutionId(String executionId) {
<span class="nc" id="L147">        return dataManager.findTasksByExecutionId(executionId);</span>
    }

    @Override
    public List&lt;TaskEntity&gt; findTasksByProcessInstanceId(String processInstanceId) {
<span class="nc" id="L152">        return dataManager.findTasksByProcessInstanceId(processInstanceId);</span>
    }
    
    @Override
    public List&lt;TaskEntity&gt; findTasksByScopeIdAndScopeType(String scopeId, String scopeType) {
<span class="nc" id="L157">        return dataManager.findTasksByScopeIdAndScopeType(scopeId, scopeType);</span>
    }
    
    @Override
    public List&lt;TaskEntity&gt; findTasksBySubScopeIdAndScopeType(String subScopeId, String scopeType) {
<span class="nc" id="L162">        return dataManager.findTasksBySubScopeIdAndScopeType(subScopeId, scopeType);</span>
    }

    @Override
    public List&lt;Task&gt; findTasksByQueryCriteria(TaskQueryImpl taskQuery) {
<span class="nc" id="L167">        return dataManager.findTasksByQueryCriteria(taskQuery);</span>
    }

    @Override
    public List&lt;Task&gt; findTasksWithRelatedEntitiesByQueryCriteria(TaskQueryImpl taskQuery) {
<span class="nc" id="L172">        return dataManager.findTasksWithRelatedEntitiesByQueryCriteria(taskQuery);</span>
    }

    @Override
    public long findTaskCountByQueryCriteria(TaskQueryImpl taskQuery) {
<span class="nc" id="L177">        return dataManager.findTaskCountByQueryCriteria(taskQuery);</span>
    }

    @Override
    public List&lt;Task&gt; findTasksByNativeQuery(Map&lt;String, Object&gt; parameterMap) {
<span class="nc" id="L182">        return dataManager.findTasksByNativeQuery(parameterMap);</span>
    }

    @Override
    public long findTaskCountByNativeQuery(Map&lt;String, Object&gt; parameterMap) {
<span class="nc" id="L187">        return dataManager.findTaskCountByNativeQuery(parameterMap);</span>
    }

    @Override
    public List&lt;Task&gt; findTasksByParentTaskId(String parentTaskId) {
<span class="nc" id="L192">        return dataManager.findTasksByParentTaskId(parentTaskId);</span>
    }

    @Override
    public void updateTaskTenantIdForDeployment(String deploymentId, String newTenantId) {
<span class="nc" id="L197">        dataManager.updateTaskTenantIdForDeployment(deploymentId, newTenantId);</span>
<span class="nc" id="L198">    }</span>
    
    @Override
    public void updateAllTaskRelatedEntityCountFlags(boolean configProperty) {
<span class="nc" id="L202">        dataManager.updateAllTaskRelatedEntityCountFlags(configProperty);</span>
<span class="nc" id="L203">    }</span>
    
    @Override
    public void deleteTasksByExecutionId(String executionId) {
<span class="nc" id="L207">        dataManager.deleteTasksByExecutionId(executionId);</span>
<span class="nc" id="L208">    }</span>

    protected void logAssigneeChanged(TaskEntity taskEntity, String previousAssignee, String newAssignee) {
<span class="nc bnc" id="L211" title="All 2 branches missed.">        if (serviceConfiguration.isEnableHistoricTaskLogging()) {</span>
<span class="nc" id="L212">            ObjectNode dataNode = serviceConfiguration.getObjectMapper().createObjectNode();</span>
<span class="nc" id="L213">            dataNode.put(&quot;newAssigneeId&quot;, newAssignee);</span>
<span class="nc" id="L214">            dataNode.put(&quot;previousAssigneeId&quot;, previousAssignee);</span>
<span class="nc" id="L215">            recordHistoryUserTaskLog(HistoricTaskLogEntryType.USER_TASK_ASSIGNEE_CHANGED, taskEntity, dataNode);</span>
        }
<span class="nc" id="L217">    }</span>

    protected void logOwnerChanged(TaskEntity taskEntity, String previousOwner, String newOwner) {
<span class="nc bnc" id="L220" title="All 2 branches missed.">        if (serviceConfiguration.isEnableHistoricTaskLogging()) {</span>
<span class="nc" id="L221">            ObjectNode dataNode = serviceConfiguration.getObjectMapper().createObjectNode();</span>
<span class="nc" id="L222">            dataNode.put(&quot;newOwnerId&quot;, newOwner);</span>
<span class="nc" id="L223">            dataNode.put(&quot;previousOwnerId&quot;, previousOwner);</span>
<span class="nc" id="L224">            recordHistoryUserTaskLog(HistoricTaskLogEntryType.USER_TASK_OWNER_CHANGED, taskEntity, dataNode);</span>
        }
<span class="nc" id="L226">    }</span>

    protected void logPriorityChanged(TaskEntity taskEntity, Integer previousPriority, int newPriority) {
<span class="nc bnc" id="L229" title="All 2 branches missed.">        if (serviceConfiguration.isEnableHistoricTaskLogging()) {</span>
<span class="nc" id="L230">            ObjectNode dataNode = serviceConfiguration.getObjectMapper().createObjectNode();</span>
<span class="nc" id="L231">            dataNode.put(&quot;newPriority&quot;, newPriority);</span>
<span class="nc" id="L232">            dataNode.put(&quot;previousPriority&quot;, previousPriority);</span>
<span class="nc" id="L233">            recordHistoryUserTaskLog(HistoricTaskLogEntryType.USER_TASK_PRIORITY_CHANGED, taskEntity, dataNode);</span>
        }
<span class="nc" id="L235">    }</span>

    protected void logDueDateChanged(TaskEntity taskEntity, Date previousDueDate, Date newDueDate) {
<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (serviceConfiguration.isEnableHistoricTaskLogging()) {</span>
<span class="nc" id="L239">            ObjectNode dataNode = serviceConfiguration.getObjectMapper().createObjectNode();</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">            dataNode.put(&quot;newDueDate&quot;, newDueDate != null ? newDueDate.getTime() : null);</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">            dataNode.put(&quot;previousDueDate&quot;, previousDueDate != null ? previousDueDate.getTime() : null);</span>
<span class="nc" id="L242">            recordHistoryUserTaskLog(HistoricTaskLogEntryType.USER_TASK_DUEDATE_CHANGED, taskEntity, dataNode);</span>
        }
<span class="nc" id="L244">    }</span>

    protected void logNameChanged(TaskEntity taskEntity, String previousName, String newName) {
<span class="nc bnc" id="L247" title="All 2 branches missed.">        if (serviceConfiguration.isEnableHistoricTaskLogging()) {</span>
<span class="nc" id="L248">            ObjectNode dataNode = serviceConfiguration.getObjectMapper().createObjectNode();</span>
<span class="nc" id="L249">            dataNode.put(&quot;newName&quot;, newName);</span>
<span class="nc" id="L250">            dataNode.put(&quot;previousName&quot;, previousName);</span>
<span class="nc" id="L251">            recordHistoryUserTaskLog(HistoricTaskLogEntryType.USER_TASK_NAME_CHANGED, taskEntity, dataNode);</span>
        }
<span class="nc" id="L253">    }</span>

    protected void logTaskCreatedEvent(TaskInfo task) {
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (serviceConfiguration.isEnableHistoricTaskLogging()) {</span>
<span class="nc" id="L257">            HistoricTaskLogEntryBuilder taskLogEntryBuilder = createHistoricTaskLogEntryBuilder(task, HistoricTaskLogEntryType.USER_TASK_CREATED);</span>
<span class="nc" id="L258">            taskLogEntryBuilder.timeStamp(task.getCreateTime());</span>
<span class="nc" id="L259">            serviceConfiguration.getInternalHistoryTaskManager().recordHistoryUserTaskLog(taskLogEntryBuilder);</span>
        }
<span class="nc" id="L261">    }</span>

    protected HistoricTaskLogEntryBuilder createHistoricTaskLogEntryBuilder(TaskInfo task, HistoricTaskLogEntryType userTaskCreated) {
<span class="nc" id="L264">        HistoricTaskLogEntryBuilder taskLogEntryBuilder = new BaseHistoricTaskLogEntryBuilderImpl(task);</span>
<span class="nc" id="L265">        taskLogEntryBuilder.timeStamp(serviceConfiguration.getClock().getCurrentTime());</span>
<span class="nc" id="L266">        taskLogEntryBuilder.userId(Authentication.getAuthenticatedUserId());</span>
<span class="nc" id="L267">        taskLogEntryBuilder.type(userTaskCreated.name());</span>
<span class="nc" id="L268">        return taskLogEntryBuilder;</span>
    }

    protected void logTaskUpdateEvents(TaskEntity task) {
<span class="nc bnc" id="L272" title="All 2 branches missed.">        if (wasPersisted(task)) {</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">            if (!Objects.equals(task.getAssignee(), getOriginalState(task, &quot;assignee&quot;))) {</span>
<span class="nc" id="L274">                logAssigneeChanged(task, (String) getOriginalState(task, &quot;assignee&quot;), task.getAssignee());</span>
            }
<span class="nc bnc" id="L276" title="All 2 branches missed.">            if (!Objects.equals(task.getOwner(), getOriginalState(task, &quot;owner&quot;))) {</span>
<span class="nc bnc" id="L277" title="All 4 branches missed.">                if (getEventDispatcher() != null &amp;&amp; getEventDispatcher().isEnabled()) {</span>
<span class="nc" id="L278">                    getEventDispatcher().dispatchEvent(FlowableTaskEventBuilder.createEntityEvent(FlowableEngineEventType.TASK_OWNER_CHANGED, task),</span>
<span class="nc" id="L279">                            serviceConfiguration.getEngineName());</span>
                }

<span class="nc" id="L282">                logOwnerChanged(task, (String) getOriginalState(task, &quot;owner&quot;), task.getOwner());</span>
            }
<span class="nc bnc" id="L284" title="All 2 branches missed.">            if (!Objects.equals(task.getPriority(), getOriginalState(task, &quot;priority&quot;))) {</span>
<span class="nc bnc" id="L285" title="All 4 branches missed.">                if (getEventDispatcher() != null &amp;&amp; getEventDispatcher().isEnabled()) {</span>
<span class="nc" id="L286">                    getEventDispatcher().dispatchEvent(FlowableTaskEventBuilder.createEntityEvent(FlowableEngineEventType.TASK_PRIORITY_CHANGED, task),</span>
<span class="nc" id="L287">                            serviceConfiguration.getEngineName());</span>
                }
<span class="nc" id="L289">                logPriorityChanged(task, (Integer) getOriginalState(task, &quot;priority&quot;), task.getPriority());</span>
            }
<span class="nc bnc" id="L291" title="All 2 branches missed.">            if (!Objects.equals(task.getDueDate(), getOriginalState(task, &quot;dueDate&quot;))) {</span>
<span class="nc bnc" id="L292" title="All 4 branches missed.">                if (getEventDispatcher() != null &amp;&amp; getEventDispatcher().isEnabled()) {</span>
<span class="nc" id="L293">                    getEventDispatcher().dispatchEvent(FlowableTaskEventBuilder.createEntityEvent(FlowableEngineEventType.TASK_DUEDATE_CHANGED, task),</span>
<span class="nc" id="L294">                            serviceConfiguration.getEngineName());</span>
                }
<span class="nc" id="L296">                logDueDateChanged(task, (Date) getOriginalState(task, &quot;dueDate&quot;), task.getDueDate());</span>
            }
<span class="nc bnc" id="L298" title="All 2 branches missed.">            if (!Objects.equals(task.getName(), getOriginalState(task, &quot;name&quot;))) {</span>
<span class="nc bnc" id="L299" title="All 4 branches missed.">                if (getEventDispatcher() != null &amp;&amp; getEventDispatcher().isEnabled()) {</span>
<span class="nc" id="L300">                    getEventDispatcher().dispatchEvent(FlowableTaskEventBuilder.createEntityEvent(FlowableEngineEventType.TASK_NAME_CHANGED, task),</span>
<span class="nc" id="L301">                            serviceConfiguration.getEngineName());</span>
                }
<span class="nc" id="L303">                logNameChanged(task, (String) getOriginalState(task, &quot;name&quot;), task.getName());</span>
            }
        }
<span class="nc" id="L306">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    protected boolean wasPersisted(TaskEntity task) {
<span class="nc bnc" id="L310" title="All 4 branches missed.">        if (task.getOriginalPersistentState() != null &amp;&amp; ((Map&lt;String, Object&gt;) task.getOriginalPersistentState()).size() &gt; 0) {</span>
<span class="nc" id="L311">            return true;</span>
        } else {
<span class="nc" id="L313">            return false;</span>
        }
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    protected Object getOriginalState(TaskEntity task, String stateKey) {
<span class="nc bnc" id="L319" title="All 2 branches missed.">        if (task.getOriginalPersistentState() != null) {</span>
<span class="nc" id="L320">            return ((Map&lt;String, Object&gt;) task.getOriginalPersistentState()).get(stateKey);</span>
        }
<span class="nc" id="L322">        return null;</span>
    }

    protected void recordHistoryUserTaskLog(HistoricTaskLogEntryType logEntryType, TaskInfo task, ObjectNode dataNode) {
<span class="nc" id="L326">        HistoricTaskLogEntryBuilder taskLogEntryBuilder = createHistoricTaskLogEntryBuilder(task, logEntryType);</span>
<span class="nc" id="L327">        taskLogEntryBuilder.data(dataNode.toString());</span>
<span class="nc" id="L328">        serviceConfiguration.getInternalHistoryTaskManager().recordHistoryUserTaskLog(taskLogEntryBuilder);</span>
<span class="nc" id="L329">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>