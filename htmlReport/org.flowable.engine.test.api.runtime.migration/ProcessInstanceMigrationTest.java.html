<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProcessInstanceMigrationTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.runtime.migration</a> &gt; <span class="el_source">ProcessInstanceMigrationTest.java</span></div><h1>ProcessInstanceMigrationTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.engine.test.api.runtime.migration;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.assertj.core.api.Assertions.tuple;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;

import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.api.delegate.event.FlowableEngineEntityEvent;
import org.flowable.common.engine.api.delegate.event.FlowableEngineEventType;
import org.flowable.common.engine.api.delegate.event.FlowableEvent;
import org.flowable.common.engine.impl.DefaultTenantProvider;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.common.engine.impl.interceptor.Command;
import org.flowable.common.engine.impl.interceptor.CommandContext;
import org.flowable.engine.delegate.event.FlowableActivityEvent;
import org.flowable.engine.delegate.event.FlowableMessageEvent;
import org.flowable.engine.delegate.event.FlowableSignalEvent;
import org.flowable.engine.history.HistoricActivityInstance;
import org.flowable.engine.history.HistoricDetail;
import org.flowable.engine.history.HistoricProcessInstance;
import org.flowable.engine.impl.event.MessageEventHandler;
import org.flowable.engine.impl.event.SignalEventHandler;
import org.flowable.engine.impl.persistence.entity.ExecutionEntity;
import org.flowable.engine.impl.persistence.entity.HistoricDetailVariableInstanceUpdateEntity;
import org.flowable.engine.impl.test.HistoryTestHelper;
import org.flowable.engine.migration.ActivityMigrationMapping;
import org.flowable.engine.migration.EnableActivityMapping;
import org.flowable.engine.migration.ProcessInstanceMigrationBuilder;
import org.flowable.engine.migration.ProcessInstanceMigrationDocument;
import org.flowable.engine.migration.ProcessInstanceMigrationDocumentConverter;
import org.flowable.engine.migration.ProcessInstanceMigrationValidationResult;
import org.flowable.engine.migration.Script;
import org.flowable.engine.repository.Deployment;
import org.flowable.engine.repository.ProcessDefinition;
import org.flowable.engine.runtime.DataObject;
import org.flowable.engine.runtime.Execution;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.api.runtime.changestate.ChangeStateEventListener;
import org.flowable.eventsubscription.api.EventSubscription;
import org.flowable.eventsubscription.service.impl.persistence.entity.EventSubscriptionEntity;
import org.flowable.job.api.Job;
import org.flowable.task.api.Task;
import org.flowable.task.api.history.HistoricTaskInstance;
import org.flowable.variable.api.history.HistoricVariableInstance;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;

<span class="nc" id="L75">public class ProcessInstanceMigrationTest extends AbstractProcessInstanceMigrationTest {</span>

<span class="nc" id="L77">    private ChangeStateEventListener changeStateEventListener = new ChangeStateEventListener();</span>

    @BeforeEach
    protected void setUp() {
<span class="nc" id="L81">        processEngine.getRuntimeService().addEventListener(changeStateEventListener);</span>
<span class="nc" id="L82">    }</span>

    @AfterEach
    protected void tearDown() {
<span class="nc" id="L86">        processEngine.getRuntimeService().removeEventListener(changeStateEventListener);</span>
<span class="nc" id="L87">        deleteDeployments();</span>
<span class="nc" id="L88">    }</span>

    @Test
    public void testSimpleMigrationWithActivityAutoMapping() {
        //Deploy first version of the process
<span class="nc" id="L93">        ProcessDefinition version1ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L97">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>

        //Deploy second version of the process
<span class="nc" id="L100">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;);

<span class="nc" id="L103">        List&lt;ProcessDefinition&gt; processDefinitions = repositoryService.createProcessDefinitionQuery()</span>
<span class="nc" id="L104">                .processDefinitionKey(&quot;MP&quot;)</span>
<span class="nc" id="L105">                .list();</span>

<span class="nc" id="L107">        assertThat(processDefinitions)</span>
<span class="nc" id="L108">                .extracting(ProcessDefinition::getId)</span>
<span class="nc" id="L109">                .containsExactlyInAnyOrder(version1ProcessDef.getId(), version2ProcessDef.getId());</span>

<span class="nc" id="L111">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L112">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L113">        executions.stream()</span>
<span class="nc" id="L114">                .map(e -&gt; (ExecutionEntity) e)</span>
<span class="nc" id="L115">                .forEach(e -&gt; assertThat(e.getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId()));</span>

<span class="nc" id="L117">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L118">        assertThat(tasks)</span>
<span class="nc" id="L119">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L120">                .containsExactly(tuple(version1ProcessDef.getId(), &quot;userTask1Id&quot;));</span>

<span class="nc" id="L122">        ProcessInstanceMigrationValidationResult validationResult = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L123">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L124">                .validateMigration(processInstance.getId());</span>

<span class="nc" id="L126">        assertThat(validationResult.isMigrationValid()).isTrue();</span>

        // Migrate process
<span class="nc" id="L129">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L130">                .migrateToProcessDefinition(version2ProcessDef.getId());</span>
<span class="nc" id="L131">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L132">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L134">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L136">        executions = runtimeService.createExecutionQuery().list();</span>
<span class="nc" id="L137">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L138">        executions.stream()</span>
<span class="nc" id="L139">                .map(e -&gt; (ExecutionEntity) e)</span>
<span class="nc" id="L140">                .forEach(e -&gt; assertThat(e.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId()));</span>

<span class="nc" id="L142">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L143">        assertThat(tasks)</span>
<span class="nc" id="L144">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L145">                .containsExactly(tuple(version2ProcessDef.getId(), &quot;userTask1Id&quot;)); //AutoMapped by Id</span>

        //The first process version only had one activity, there should be a second activity in the process now
<span class="nc" id="L148">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L149">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L150">        assertThat(tasks)</span>
<span class="nc" id="L151">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L152">                .containsExactly(&quot;userTask2Id&quot;);</span>
<span class="nc" id="L153">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L154">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L155">    }</span>

    @Test
    public void testSimpleMigrationWithTaskMapping() {
        //Deploy first version of the process
<span class="nc" id="L160">        deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;);</span>

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L163">        ProcessInstance processInstanceToMigrate = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>
<span class="nc" id="L164">        taskService.complete(taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult().getId());</span>

<span class="nc" id="L166">        Task beforeMigrationTask = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>

        //Deploy second version of the process
<span class="nc" id="L169">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/three-tasks-simple-process.bpmn20.xml&quot;);

        //Migrate process
<span class="nc" id="L173">        processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L174">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L175">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask2Id&quot;, &quot;intermediateTask&quot;))</span>
<span class="nc" id="L176">                .migrate(processInstanceToMigrate.getId());</span>

<span class="nc" id="L178">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L179">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">        for (Execution execution : executions) {</span>
<span class="nc" id="L181">            assertThat(((ExecutionEntity) execution).getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L182">        }</span>

<span class="nc" id="L184">        Task task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L185">        assertThat(task)</span>
<span class="nc" id="L186">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey, Task::getId)</span>
<span class="nc" id="L187">                .containsExactly(version2ProcessDef.getId(), &quot;intermediateTask&quot;, beforeMigrationTask.getId());</span>

<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L190">            HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L191">                    .processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L192">            assertThat(historicProcessInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>

<span class="nc" id="L194">            List&lt;HistoricTaskInstance&gt; historicTaskInstances = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L195">                    .processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L196">            assertThat(historicTaskInstances).hasSize(2);</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">            for (HistoricTaskInstance historicTaskInstance : historicTaskInstances) {</span>
<span class="nc" id="L198">                assertThat(historicTaskInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L199">            }</span>

<span class="nc" id="L201">            List&lt;HistoricActivityInstance&gt; historicActivityInstances = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L202">                    .processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L203">            assertThat(historicActivityInstances).hasSize(5);</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">            for (HistoricActivityInstance historicActivityInstance : historicActivityInstances) {</span>
<span class="nc" id="L205">                assertThat(historicActivityInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L206">            }</span>
        }

        // complete intermediate task
<span class="nc" id="L210">        taskService.complete(task.getId());</span>

        // complete final task
<span class="nc" id="L213">        task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L214">        taskService.complete(task.getId());</span>

<span class="nc" id="L216">        assertProcessEnded(processInstanceToMigrate.getId());</span>
<span class="nc" id="L217">    }</span>

    @Test
    public void testUserTaskFormKeyMigrationWithTaskMapping() {
        //Deploy first version of the process
<span class="nc" id="L222">        deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/runtime/migration/three-tasks-simple-process-with-form-keys.bpmn20.xml&quot;);</span>

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L225">        ProcessInstance processInstanceToMigrate = runtimeService.startProcessInstanceByKey(&quot;myProcess&quot;);</span>
<span class="nc" id="L226">        taskService.complete(taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult().getId());</span>
<span class="nc" id="L227">        taskService.complete(taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult().getId());</span>

<span class="nc" id="L229">        Task beforeMigrationTask = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L230">        assertThat(beforeMigrationTask.getFormKey()).isEqualTo(&quot;taskCFormKey&quot;);</span>
<span class="nc" id="L231">        assertThat(beforeMigrationTask.getName()).isEqualTo(&quot;C&quot;);</span>

        //Deploy second version of the process
<span class="nc" id="L234">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process-with-form-keys.bpmn20.xml&quot;);

        //Migrate process
<span class="nc" id="L238">        processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L239">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L240">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTaskC&quot;, &quot;userTaskB&quot;))</span>
<span class="nc" id="L241">                .migrate(processInstanceToMigrate.getId());</span>

<span class="nc" id="L243">        Task task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L244">        assertThat(task)</span>
<span class="nc" id="L245">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey, Task::getFormKey)</span>
<span class="nc" id="L246">                .containsExactly(version2ProcessDef.getId(), &quot;userTaskB&quot;, &quot;taskBFormKey&quot;);</span>

<span class="nc" id="L248">        taskService.complete(task.getId());</span>
<span class="nc" id="L249">        assertProcessEnded(processInstanceToMigrate.getId());</span>
<span class="nc" id="L250">    }</span>

    @Test
    public void testUserTaskCategoryMigrationWithTaskMapping() {
        //Deploy first version of the process
<span class="nc" id="L255">        deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/runtime/migration/three-tasks-simple-process-with-category.bpmn20.xml&quot;);</span>

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L258">        ProcessInstance processInstanceToMigrate = runtimeService.startProcessInstanceByKey(&quot;myProcess&quot;);</span>
<span class="nc" id="L259">        taskService.complete(taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult().getId());</span>
<span class="nc" id="L260">        taskService.complete(taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult().getId());</span>

<span class="nc" id="L262">        Task beforeMigrationTask = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L263">        assertThat(beforeMigrationTask.getName()).isEqualTo(&quot;C&quot;);</span>
<span class="nc" id="L264">        assertThat(beforeMigrationTask.getCategory()).isEqualTo(&quot;taskCCategory&quot;);</span>

        //Deploy second version of the process
<span class="nc" id="L267">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process-with-category.bpmn20.xml&quot;);

        //Migrate process
<span class="nc" id="L271">        processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L272">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L273">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTaskC&quot;, &quot;userTaskB&quot;))</span>
<span class="nc" id="L274">                .migrate(processInstanceToMigrate.getId());</span>

<span class="nc" id="L276">        Task task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L277">        assertThat(task)</span>
<span class="nc" id="L278">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey, Task::getCategory)</span>
<span class="nc" id="L279">                .containsExactly(version2ProcessDef.getId(), &quot;userTaskB&quot;, &quot;taskBCategory&quot;);</span>

<span class="nc" id="L281">        taskService.complete(task.getId());</span>
<span class="nc" id="L282">        assertProcessEnded(processInstanceToMigrate.getId());</span>
<span class="nc" id="L283">    }</span>

    @Test
    public void testSimpleMigrationWithTaskJsonMapping() {
        //Deploy first version of the process
<span class="nc" id="L288">        deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;);</span>

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L291">        ProcessInstance processInstanceToMigrate = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>
<span class="nc" id="L292">        taskService.complete(taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult().getId());</span>

<span class="nc" id="L294">        Task beforeMigrationTask = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>

        //Deploy second version of the process
<span class="nc" id="L297">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/three-tasks-simple-process.bpmn20.xml&quot;);

<span class="nc" id="L300">        ObjectMapper objectMapper = processEngineConfiguration.getObjectMapper();</span>
<span class="nc" id="L301">        ObjectNode migrationNode = objectMapper.createObjectNode();</span>
<span class="nc" id="L302">        migrationNode.put(&quot;toProcessDefinitionId&quot;, version2ProcessDef.getId());</span>
<span class="nc" id="L303">        ArrayNode activitiesNode = migrationNode.putArray(&quot;activityMappings&quot;);</span>
<span class="nc" id="L304">        ObjectNode activityNode = activitiesNode.addObject();</span>
<span class="nc" id="L305">        activityNode.put(&quot;fromActivityId&quot;, &quot;userTask2Id&quot;);</span>
<span class="nc" id="L306">        activityNode.put(&quot;toActivityId&quot;, &quot;intermediateTask&quot;);</span>

        //Migrate process
<span class="nc" id="L309">        ProcessInstanceMigrationDocument migrationDocument = ProcessInstanceMigrationDocumentConverter.convertFromJson(migrationNode.toString());</span>
<span class="nc" id="L310">        processMigrationService.migrateProcessInstance(processInstanceToMigrate.getId(), migrationDocument);</span>

<span class="nc" id="L312">        Task task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L313">        assertThat(task)</span>
<span class="nc" id="L314">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey, Task::getId)</span>
<span class="nc" id="L315">                .containsExactly(version2ProcessDef.getId(), &quot;intermediateTask&quot;, beforeMigrationTask.getId());</span>

<span class="nc bnc" id="L317" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L318">            HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L319">                    .processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L320">            assertThat(historicProcessInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>

<span class="nc" id="L322">            List&lt;HistoricTaskInstance&gt; historicTaskInstances = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L323">                    .processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L324">            assertThat(historicTaskInstances).hasSize(2);</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">            for (HistoricTaskInstance historicTaskInstance : historicTaskInstances) {</span>
<span class="nc" id="L326">                assertThat(historicTaskInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L327">            }</span>

<span class="nc" id="L329">            List&lt;HistoricActivityInstance&gt; historicActivityInstances = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L330">                    .processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L331">            assertThat(historicActivityInstances).hasSize(5);</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">            for (HistoricActivityInstance historicActivityInstance : historicActivityInstances) {</span>
<span class="nc" id="L333">                assertThat(historicActivityInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L334">            }</span>
        }

        // complete intermediate task
<span class="nc" id="L338">        taskService.complete(task.getId());</span>

        // complete final task
<span class="nc" id="L341">        task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L342">        taskService.complete(task.getId());</span>

<span class="nc" id="L344">        assertProcessEnded(processInstanceToMigrate.getId());</span>
<span class="nc" id="L345">    }</span>

    @Test
    public void testMigrationWithParallelTaskMapping() {
        //Deploy first version of the process
<span class="nc" id="L350">        deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/runtime/migration/parallel-gateway-two-tasks.bpmn20.xml&quot;);</span>

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L353">        ProcessInstance processInstanceToMigrate = runtimeService.startProcessInstanceByKey(&quot;startParallelProcess&quot;);</span>
<span class="nc" id="L354">        taskService.complete(taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult().getId());</span>

<span class="nc" id="L356">        List&lt;Task&gt; parallelTasks = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L357">        assertThat(parallelTasks).hasSize(2);</span>

        //Deploy second version of the process
<span class="nc" id="L360">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/parallel-gateway-two-tasks-and-before.bpmn20.xml&quot;);

<span class="nc" id="L363">        List&lt;String&gt; fromActivityIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L364">        fromActivityIds.add(&quot;parallelTask1&quot;);</span>
<span class="nc" id="L365">        fromActivityIds.add(&quot;parallelTask2&quot;);</span>
        //Migrate process
<span class="nc" id="L367">        processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L368">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L369">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(fromActivityIds, &quot;beforeTask&quot;))</span>
<span class="nc" id="L370">                .migrate(processInstanceToMigrate.getId());</span>

<span class="nc" id="L372">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L373">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">        for (Execution execution : executions) {</span>
<span class="nc" id="L375">            assertThat(((ExecutionEntity) execution).getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L376">        }</span>

<span class="nc" id="L378">        Task task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L379">        assertThat(task)</span>
<span class="nc" id="L380">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L381">                .containsExactly(version2ProcessDef.getId(), &quot;beforeTask&quot;);</span>
<span class="nc" id="L382">        assertThat(parallelTasks.get(0).getId()).isNotEqualTo(task.getId());</span>
<span class="nc" id="L383">        assertThat(parallelTasks.get(1).getId()).isNotEqualTo(task.getId());</span>

<span class="nc bnc" id="L385" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L386">            HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L387">                    .processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L388">            assertThat(historicProcessInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>

<span class="nc" id="L390">            List&lt;HistoricTaskInstance&gt; historicTaskInstances = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L391">                    .processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L392">            assertThat(historicTaskInstances).hasSize(4);</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">            for (HistoricTaskInstance historicTaskInstance : historicTaskInstances) {</span>
<span class="nc" id="L394">                assertThat(historicTaskInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L395">            }</span>

<span class="nc" id="L397">            List&lt;HistoricActivityInstance&gt; historicActivityInstances = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L398">                    .processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L399">            assertThat(historicActivityInstances).hasSize(10);</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">            for (HistoricActivityInstance historicActivityInstance : historicActivityInstances) {</span>
<span class="nc" id="L401">                assertThat(historicActivityInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L402">            }</span>
        }

        // complete before task
<span class="nc" id="L406">        taskService.complete(task.getId());</span>

        // complete parallel task 1
<span class="nc" id="L409">        task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).list().get(0);</span>
<span class="nc" id="L410">        taskService.complete(task.getId());</span>

        // complete parallel task 2
<span class="nc" id="L413">        task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L414">        taskService.complete(task.getId());</span>

        // complete final task
<span class="nc" id="L417">        task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L418">        taskService.complete(task.getId());</span>

<span class="nc" id="L420">        assertProcessEnded(processInstanceToMigrate.getId());</span>
<span class="nc" id="L421">    }</span>

    @Test
    public void testMigrationWithNewSubProcessScope() {
        //Deploy first version of the process
<span class="nc" id="L426">        deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;);</span>

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L429">        ProcessInstance processInstanceToMigrate = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>
<span class="nc" id="L430">        taskService.complete(taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult().getId());</span>

<span class="nc" id="L432">        Task lastTask = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>

        //Deploy second version of the process
<span class="nc" id="L435">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/three-tasks-with-sub-process.bpmn20.xml&quot;);

        //Migrate process
<span class="nc" id="L439">        processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L440">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L441">                .addActivityMigrationMapping(</span>
<span class="nc" id="L442">                        ActivityMigrationMapping.createMappingFor(&quot;userTask2Id&quot;, &quot;subScriptTask&quot;)</span>
<span class="nc" id="L443">                                .withLocalVariable(&quot;subprocessVariable&quot;, &quot;passedValue&quot;))</span>
<span class="nc" id="L444">                .migrate(processInstanceToMigrate.getId());</span>

<span class="nc" id="L446">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L447">        assertThat(executions).hasSize(3); //includes root execution</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">        for (Execution execution : executions) {</span>
<span class="nc" id="L449">            assertThat(((ExecutionEntity) execution).getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L450">        }</span>

<span class="nc" id="L452">        Execution execution = runtimeService.createExecutionQuery().activityId(&quot;subProcess&quot;).singleResult();</span>
<span class="nc" id="L453">        assertThat(runtimeService.getVariable(execution.getId(), &quot;subprocessVariable&quot;)).isEqualTo(&quot;passedValue&quot;);</span>
<span class="nc" id="L454">        assertThat(runtimeService.hasVariable(execution.getProcessInstanceId(), &quot;subprocessVariable&quot;)).isFalse();</span>
<span class="nc" id="L455">        assertThat(runtimeService.getVariable(execution.getId(), &quot;anotherVar&quot;)).isEqualTo(&quot;hello&quot;);</span>

<span class="nc" id="L457">        assertThat(runtimeService.hasVariable(execution.getProcessInstanceId(), &quot;anotherVar&quot;)).isFalse();</span>

<span class="nc" id="L459">        Task task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L460">        assertThat(task)</span>
<span class="nc" id="L461">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L462">                .containsExactly(version2ProcessDef.getId(), &quot;subTask&quot;);</span>
<span class="nc" id="L463">        assertThat(lastTask.getId()).isNotEqualTo(task.getId());</span>

<span class="nc bnc" id="L465" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L466">            HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L467">                    .processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L468">            assertThat(historicProcessInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>

<span class="nc" id="L470">            List&lt;HistoricTaskInstance&gt; historicTaskInstances = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L471">                    .processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L472">            assertThat(historicTaskInstances).hasSize(3);</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">            for (HistoricTaskInstance historicTaskInstance : historicTaskInstances) {</span>
<span class="nc" id="L474">                assertThat(historicTaskInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L475">            }</span>

<span class="nc" id="L477">            List&lt;HistoricActivityInstance&gt; historicActivityInstances = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L478">                    .processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L479">            assertThat(historicActivityInstances).hasSize(9);</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">            for (HistoricActivityInstance historicActivityInstance : historicActivityInstances) {</span>
<span class="nc" id="L481">                assertThat(historicActivityInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L482">            }</span>
        }

        // complete sub task
<span class="nc" id="L486">        taskService.complete(task.getId());</span>

        // complete final task
<span class="nc" id="L489">        task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L490">        taskService.complete(task.getId());</span>

<span class="nc" id="L492">        assertProcessEnded(processInstanceToMigrate.getId());</span>
<span class="nc" id="L493">    }</span>
    
    @Test
    public void testMigrationWithNewEventSubProcess() {
        //Deploy first version of the process
<span class="nc" id="L498">        deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;);</span>

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L501">        ProcessInstance processInstanceToMigrate = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>
<span class="nc" id="L502">        taskService.complete(taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult().getId());</span>

<span class="nc" id="L504">        Task task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>

        //Deploy second version of the process
<span class="nc" id="L507">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-with-event-subprocess.bpmn20.xml&quot;);

        //Migrate process
<span class="nc" id="L511">        processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L512">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L513">                .addEnableEventSubProcessStartEvent(</span>
<span class="nc" id="L514">                        EnableActivityMapping.enable(&quot;eventSubProcessStart&quot;))</span>
<span class="nc" id="L515">                .migrate(processInstanceToMigrate.getId());</span>

<span class="nc" id="L517">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L518">        assertThat(executions).hasSize(3); //includes root execution</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">        for (Execution execution : executions) {</span>
<span class="nc" id="L520">            assertThat(((ExecutionEntity) execution).getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L521">        }</span>
        
<span class="nc" id="L523">        assertThat(taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).count()).isEqualTo(1);</span>

<span class="nc" id="L525">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().activityId(&quot;eventSubProcessStart&quot;).singleResult();</span>
<span class="nc" id="L526">        assertThat(eventSubscription).isNotNull();</span>
<span class="nc" id="L527">        assertThat(eventSubscription.getEventType()).isEqualTo(SignalEventHandler.EVENT_HANDLER_TYPE);</span>
        
<span class="nc bnc" id="L529" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L530">            HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L531">                    .processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L532">            assertThat(historicProcessInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>

<span class="nc" id="L534">            List&lt;HistoricTaskInstance&gt; historicTaskInstances = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L535">                    .processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L536">            assertThat(historicTaskInstances).hasSize(2);</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">            for (HistoricTaskInstance historicTaskInstance : historicTaskInstances) {</span>
<span class="nc" id="L538">                assertThat(historicTaskInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L539">            }</span>

<span class="nc" id="L541">            List&lt;HistoricActivityInstance&gt; historicActivityInstances = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L542">                    .processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L543">            assertThat(historicActivityInstances).hasSize(5);</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">            for (HistoricActivityInstance historicActivityInstance : historicActivityInstances) {</span>
<span class="nc" id="L545">                assertThat(historicActivityInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L546">            }</span>
        }

        // complete final task
<span class="nc" id="L550">        task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L551">        taskService.complete(task.getId());</span>

<span class="nc" id="L553">        assertProcessEnded(processInstanceToMigrate.getId());</span>
<span class="nc" id="L554">    }</span>
    
    @Test
    public void testMigrationAndTriggerNewEventSubProcess() {
        //Deploy first version of the process
<span class="nc" id="L559">        deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;);</span>

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L562">        ProcessInstance processInstanceToMigrate = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>
<span class="nc" id="L563">        taskService.complete(taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult().getId());</span>

<span class="nc" id="L565">        Task task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>

        //Deploy second version of the process
<span class="nc" id="L568">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-with-event-subprocess.bpmn20.xml&quot;);

        //Migrate process
<span class="nc" id="L572">        processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L573">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L574">                .addEnableEventSubProcessStartEvent(</span>
<span class="nc" id="L575">                        EnableActivityMapping.enable(&quot;eventSubProcessStart&quot;))</span>
<span class="nc" id="L576">                .migrate(processInstanceToMigrate.getId());</span>

<span class="nc" id="L578">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L579">        assertThat(executions).hasSize(3); //includes root execution</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">        for (Execution execution : executions) {</span>
<span class="nc" id="L581">            assertThat(((ExecutionEntity) execution).getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L582">        }</span>
        
<span class="nc" id="L584">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery()</span>
<span class="nc" id="L585">                .processInstanceId(processInstanceToMigrate.getId())</span>
<span class="nc" id="L586">                .activityId(&quot;eventSubProcessStart&quot;)</span>
<span class="nc" id="L587">                .singleResult();</span>
<span class="nc" id="L588">        assertThat(eventSubscription).isNotNull();</span>
<span class="nc" id="L589">        assertThat(eventSubscription.getEventType()).isEqualTo(SignalEventHandler.EVENT_HANDLER_TYPE);</span>
        
<span class="nc" id="L591">        runtimeService.signalEventReceived(&quot;mySignal&quot;);</span>
        
<span class="nc" id="L593">        assertThat(runtimeService.createEventSubscriptionQuery()</span>
<span class="nc" id="L594">                .processInstanceId(processInstanceToMigrate.getId())</span>
<span class="nc" id="L595">                .activityId(&quot;eventSubProcessStart&quot;).count()).isEqualTo(1);</span>
        
<span class="nc" id="L597">        assertThat(taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).count()).isEqualTo(2);</span>
        
<span class="nc bnc" id="L599" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L600">            HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L601">                    .processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L602">            assertThat(historicProcessInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>

<span class="nc" id="L604">            List&lt;HistoricTaskInstance&gt; historicTaskInstances = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L605">                    .processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L606">            assertThat(historicTaskInstances).hasSize(3);</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">            for (HistoricTaskInstance historicTaskInstance : historicTaskInstances) {</span>
<span class="nc" id="L608">                assertThat(historicTaskInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L609">            }</span>

<span class="nc" id="L611">            List&lt;HistoricActivityInstance&gt; historicActivityInstances = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L612">                    .processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L613">            assertThat(historicActivityInstances).hasSize(9);</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">            for (HistoricActivityInstance historicActivityInstance : historicActivityInstances) {</span>
<span class="nc" id="L615">                assertThat(historicActivityInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L616">            }</span>
        }
        
<span class="nc" id="L619">        task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).taskDefinitionKey(&quot;eventSubProcessTask&quot;).singleResult();</span>
<span class="nc" id="L620">        taskService.complete(task.getId());</span>
        
        // complete final task
<span class="nc" id="L623">        task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L624">        taskService.complete(task.getId());</span>

<span class="nc" id="L626">        assertProcessEnded(processInstanceToMigrate.getId());</span>
<span class="nc" id="L627">    }</span>
    
    @Test
    public void testMigrationAndTriggerInterruptingNewEventSubProcess() {
        //Deploy first version of the process
<span class="nc" id="L632">        deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;);</span>

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L635">        ProcessInstance processInstanceToMigrate = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>
<span class="nc" id="L636">        taskService.complete(taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult().getId());</span>

<span class="nc" id="L638">        Task task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>

        //Deploy second version of the process
<span class="nc" id="L641">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-with-interrupting-event-subprocess.bpmn20.xml&quot;);

        //Migrate process
<span class="nc" id="L645">        processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L646">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L647">                .addEnableEventSubProcessStartEvent(</span>
<span class="nc" id="L648">                        EnableActivityMapping.enable(&quot;eventSubProcessStart&quot;))</span>
<span class="nc" id="L649">                .migrate(processInstanceToMigrate.getId());</span>

<span class="nc" id="L651">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L652">        assertThat(executions).hasSize(3); //includes root execution</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">        for (Execution execution : executions) {</span>
<span class="nc" id="L654">            assertThat(((ExecutionEntity) execution).getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L655">        }</span>
        
<span class="nc" id="L657">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery()</span>
<span class="nc" id="L658">                .processInstanceId(processInstanceToMigrate.getId())</span>
<span class="nc" id="L659">                .activityId(&quot;eventSubProcessStart&quot;)</span>
<span class="nc" id="L660">                .singleResult();</span>
<span class="nc" id="L661">        assertThat(eventSubscription).isNotNull();</span>
<span class="nc" id="L662">        assertThat(eventSubscription.getEventType()).isEqualTo(SignalEventHandler.EVENT_HANDLER_TYPE);</span>
        
<span class="nc" id="L664">        runtimeService.signalEventReceived(&quot;mySignal&quot;);</span>
        
<span class="nc" id="L666">        assertThat(runtimeService.createEventSubscriptionQuery()</span>
<span class="nc" id="L667">                .processInstanceId(processInstanceToMigrate.getId())</span>
<span class="nc" id="L668">                .activityId(&quot;eventSubProcessStart&quot;).count()).isEqualTo(0);</span>
        
<span class="nc" id="L670">        assertThat(taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).count()).isEqualTo(1);</span>
        
<span class="nc bnc" id="L672" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L673">            HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L674">                    .processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L675">            assertThat(historicProcessInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>

<span class="nc" id="L677">            List&lt;HistoricTaskInstance&gt; historicTaskInstances = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L678">                    .processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L679">            assertThat(historicTaskInstances).hasSize(3);</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">            for (HistoricTaskInstance historicTaskInstance : historicTaskInstances) {</span>
<span class="nc" id="L681">                assertThat(historicTaskInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L682">            }</span>

<span class="nc" id="L684">            List&lt;HistoricActivityInstance&gt; historicActivityInstances = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L685">                    .processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L686">            assertThat(historicActivityInstances).hasSize(9);</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">            for (HistoricActivityInstance historicActivityInstance : historicActivityInstances) {</span>
<span class="nc" id="L688">                assertThat(historicActivityInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L689">            }</span>
        }
        
<span class="nc" id="L692">        task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).taskDefinitionKey(&quot;eventSubProcessTask&quot;).singleResult();</span>
<span class="nc" id="L693">        taskService.complete(task.getId());</span>

<span class="nc" id="L695">        assertProcessEnded(processInstanceToMigrate.getId());</span>
<span class="nc" id="L696">    }</span>
    
    @Test
    public void testMigrationWithMultipleNewEventSubProcess() {
        //Deploy first version of the process
<span class="nc" id="L701">        deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;);</span>

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L704">        ProcessInstance processInstanceToMigrate = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>
<span class="nc" id="L705">        taskService.complete(taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult().getId());</span>

<span class="nc" id="L707">        Task task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>

        //Deploy second version of the process
<span class="nc" id="L710">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-with-multiple-event-subprocess-events.bpmn20.xml&quot;);

        //Migrate process
<span class="nc" id="L714">        processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L715">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L716">                .addEnableEventSubProcessStartEvent(</span>
<span class="nc" id="L717">                        EnableActivityMapping.enable(&quot;eventSubProcessStart&quot;))</span>
<span class="nc" id="L718">                .addEnableEventSubProcessStartEvent(</span>
<span class="nc" id="L719">                        EnableActivityMapping.enable(&quot;messageEventSubProcessStart&quot;))</span>
<span class="nc" id="L720">                .migrate(processInstanceToMigrate.getId());</span>

<span class="nc" id="L722">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L723">        assertThat(executions).hasSize(4); //includes root execution</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">        for (Execution execution : executions) {</span>
<span class="nc" id="L725">            assertThat(((ExecutionEntity) execution).getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L726">        }</span>
        
<span class="nc" id="L728">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery()</span>
<span class="nc" id="L729">                .processInstanceId(processInstanceToMigrate.getId())</span>
<span class="nc" id="L730">                .activityId(&quot;eventSubProcessStart&quot;)</span>
<span class="nc" id="L731">                .singleResult();</span>
<span class="nc" id="L732">        assertThat(eventSubscription).isNotNull();</span>
<span class="nc" id="L733">        assertThat(eventSubscription.getEventType()).isEqualTo(SignalEventHandler.EVENT_HANDLER_TYPE);</span>
        
<span class="nc" id="L735">        eventSubscription = runtimeService.createEventSubscriptionQuery()</span>
<span class="nc" id="L736">                .processInstanceId(processInstanceToMigrate.getId())</span>
<span class="nc" id="L737">                .activityId(&quot;messageEventSubProcessStart&quot;)</span>
<span class="nc" id="L738">                .singleResult();</span>
<span class="nc" id="L739">        assertThat(eventSubscription).isNotNull();</span>
<span class="nc" id="L740">        assertThat(eventSubscription.getEventType()).isEqualTo(MessageEventHandler.EVENT_HANDLER_TYPE);</span>
        
<span class="nc" id="L742">        runtimeService.signalEventReceived(&quot;mySignal&quot;);</span>
        
<span class="nc" id="L744">        assertThat(runtimeService.createEventSubscriptionQuery()</span>
<span class="nc" id="L745">                .processInstanceId(processInstanceToMigrate.getId()).count()).isEqualTo(2);</span>
        
<span class="nc" id="L747">        assertThat(taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).count()).isEqualTo(2);</span>
        
<span class="nc bnc" id="L749" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L750">            HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L751">                    .processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L752">            assertThat(historicProcessInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>

<span class="nc" id="L754">            List&lt;HistoricTaskInstance&gt; historicTaskInstances = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L755">                    .processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L756">            assertThat(historicTaskInstances).hasSize(3);</span>
<span class="nc bnc" id="L757" title="All 2 branches missed.">            for (HistoricTaskInstance historicTaskInstance : historicTaskInstances) {</span>
<span class="nc" id="L758">                assertThat(historicTaskInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L759">            }</span>

<span class="nc" id="L761">            List&lt;HistoricActivityInstance&gt; historicActivityInstances = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L762">                    .processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L763">            assertThat(historicActivityInstances).hasSize(9);</span>
<span class="nc bnc" id="L764" title="All 2 branches missed.">            for (HistoricActivityInstance historicActivityInstance : historicActivityInstances) {</span>
<span class="nc" id="L765">                assertThat(historicActivityInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L766">            }</span>
        }
        
<span class="nc" id="L769">        task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).taskDefinitionKey(&quot;eventSubProcessTask&quot;).singleResult();</span>
<span class="nc" id="L770">        taskService.complete(task.getId());</span>
        
        // complete final task
<span class="nc" id="L773">        task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L774">        taskService.complete(task.getId());</span>

<span class="nc" id="L776">        assertProcessEnded(processInstanceToMigrate.getId());</span>
<span class="nc" id="L777">    }</span>
    
    @Test
    public void testMigrationWithInterruptingMultipleNewEventSubProcess() {
        //Deploy first version of the process
<span class="nc" id="L782">        deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;);</span>

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L785">        ProcessInstance processInstanceToMigrate = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>
<span class="nc" id="L786">        taskService.complete(taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult().getId());</span>

<span class="nc" id="L788">        Task task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>

        //Deploy second version of the process
<span class="nc" id="L791">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-with-multiple-interrupting-event-subprocess-events.bpmn20.xml&quot;);

        //Migrate process
<span class="nc" id="L795">        processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L796">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L797">                .addEnableEventSubProcessStartEvent(</span>
<span class="nc" id="L798">                        EnableActivityMapping.enable(&quot;eventSubProcessStart&quot;))</span>
<span class="nc" id="L799">                .addEnableEventSubProcessStartEvent(</span>
<span class="nc" id="L800">                        EnableActivityMapping.enable(&quot;messageEventSubProcessStart&quot;))</span>
<span class="nc" id="L801">                .migrate(processInstanceToMigrate.getId());</span>

<span class="nc" id="L803">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L804">        assertThat(executions).hasSize(4); //includes root execution</span>
<span class="nc bnc" id="L805" title="All 2 branches missed.">        for (Execution execution : executions) {</span>
<span class="nc" id="L806">            assertThat(((ExecutionEntity) execution).getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L807">        }</span>
        
<span class="nc" id="L809">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery()</span>
<span class="nc" id="L810">                .processInstanceId(processInstanceToMigrate.getId())</span>
<span class="nc" id="L811">                .activityId(&quot;eventSubProcessStart&quot;)</span>
<span class="nc" id="L812">                .singleResult();</span>
<span class="nc" id="L813">        assertThat(eventSubscription).isNotNull();</span>
<span class="nc" id="L814">        assertThat(eventSubscription.getEventType()).isEqualTo(SignalEventHandler.EVENT_HANDLER_TYPE);</span>
        
<span class="nc" id="L816">        eventSubscription = runtimeService.createEventSubscriptionQuery()</span>
<span class="nc" id="L817">                .processInstanceId(processInstanceToMigrate.getId())</span>
<span class="nc" id="L818">                .activityId(&quot;messageEventSubProcessStart&quot;)</span>
<span class="nc" id="L819">                .singleResult();</span>
<span class="nc" id="L820">        assertThat(eventSubscription).isNotNull();</span>
<span class="nc" id="L821">        assertThat(eventSubscription.getEventType()).isEqualTo(MessageEventHandler.EVENT_HANDLER_TYPE);</span>
        
<span class="nc" id="L823">        runtimeService.signalEventReceived(&quot;mySignal&quot;);</span>
        
<span class="nc" id="L825">        assertThat(runtimeService.createEventSubscriptionQuery()</span>
<span class="nc" id="L826">                .processInstanceId(processInstanceToMigrate.getId()).count()).isEqualTo(0);</span>
        
<span class="nc" id="L828">        assertThat(taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).count()).isEqualTo(1);</span>
        
<span class="nc bnc" id="L830" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L831">            HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L832">                    .processInstanceId(processInstanceToMigrate.getId()).singleResult();</span>
<span class="nc" id="L833">            assertThat(historicProcessInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>

<span class="nc" id="L835">            List&lt;HistoricTaskInstance&gt; historicTaskInstances = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L836">                    .processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L837">            assertThat(historicTaskInstances).hasSize(3);</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">            for (HistoricTaskInstance historicTaskInstance : historicTaskInstances) {</span>
<span class="nc" id="L839">                assertThat(historicTaskInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L840">            }</span>

<span class="nc" id="L842">            List&lt;HistoricActivityInstance&gt; historicActivityInstances = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L843">                    .processInstanceId(processInstanceToMigrate.getId()).list();</span>
<span class="nc" id="L844">            assertThat(historicActivityInstances).hasSize(9);</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">            for (HistoricActivityInstance historicActivityInstance : historicActivityInstances) {</span>
<span class="nc" id="L846">                assertThat(historicActivityInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L847">            }</span>
        }
        
<span class="nc" id="L850">        task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate.getId()).taskDefinitionKey(&quot;eventSubProcessTask&quot;).singleResult();</span>
<span class="nc" id="L851">        taskService.complete(task.getId());</span>

<span class="nc" id="L853">        assertProcessEnded(processInstanceToMigrate.getId());</span>
<span class="nc" id="L854">    }</span>
    
    @Test
    public void testDefinitionMigrationWithNewEventSubProcess() {
        //Deploy first version of the process
<span class="nc" id="L859">        deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;);</span>

<span class="nc" id="L861">        ProcessInstance processInstanceToMigrate1 = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>
<span class="nc" id="L862">        taskService.complete(taskService.createTaskQuery().processInstanceId(processInstanceToMigrate1.getId()).singleResult().getId());</span>

<span class="nc" id="L864">        Task task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate1.getId()).singleResult();</span>
        
<span class="nc" id="L866">        ProcessInstance processInstanceToMigrate2 = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>

        //Deploy second version of the process
<span class="nc" id="L869">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-with-event-subprocess.bpmn20.xml&quot;);

        //Migrate process
<span class="nc" id="L873">        processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L874">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L875">                .addEnableEventSubProcessStartEvent(</span>
<span class="nc" id="L876">                        EnableActivityMapping.enable(&quot;eventSubProcessStart&quot;))</span>
<span class="nc" id="L877">                .migrateProcessInstances(processInstanceToMigrate1.getProcessDefinitionId());</span>

<span class="nc" id="L879">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstanceToMigrate1.getId()).list();</span>
<span class="nc" id="L880">        assertThat(executions).hasSize(3); //includes root execution</span>
<span class="nc bnc" id="L881" title="All 2 branches missed.">        for (Execution execution : executions) {</span>
<span class="nc" id="L882">            assertThat(((ExecutionEntity) execution).getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L883">        }</span>
        
<span class="nc" id="L885">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstanceToMigrate2.getId()).list();</span>
<span class="nc" id="L886">        assertThat(executions).hasSize(3); //includes root execution</span>
<span class="nc bnc" id="L887" title="All 2 branches missed.">        for (Execution execution : executions) {</span>
<span class="nc" id="L888">            assertThat(((ExecutionEntity) execution).getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L889">        }</span>
        
<span class="nc" id="L891">        assertThat(taskService.createTaskQuery().processInstanceId(processInstanceToMigrate1.getId()).count()).isEqualTo(1);</span>

<span class="nc" id="L893">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstanceToMigrate1.getId()).activityId(&quot;eventSubProcessStart&quot;).singleResult();</span>
<span class="nc" id="L894">        assertThat(eventSubscription).isNotNull();</span>
<span class="nc" id="L895">        assertThat(eventSubscription.getEventType()).isEqualTo(SignalEventHandler.EVENT_HANDLER_TYPE);</span>
        
<span class="nc" id="L897">        eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstanceToMigrate2.getId()).activityId(&quot;eventSubProcessStart&quot;).singleResult();</span>
<span class="nc" id="L898">        assertThat(eventSubscription).isNotNull();</span>
<span class="nc" id="L899">        assertThat(eventSubscription.getEventType()).isEqualTo(SignalEventHandler.EVENT_HANDLER_TYPE);</span>
        
<span class="nc" id="L901">        runtimeService.signalEventReceived(&quot;mySignal&quot;);</span>
        
<span class="nc bnc" id="L903" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L904">            HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L905">                    .processInstanceId(processInstanceToMigrate1.getId()).singleResult();</span>
<span class="nc" id="L906">            assertThat(historicProcessInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>

<span class="nc" id="L908">            List&lt;HistoricTaskInstance&gt; historicTaskInstances = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L909">                    .processInstanceId(processInstanceToMigrate1.getId()).list();</span>
<span class="nc" id="L910">            assertThat(historicTaskInstances).hasSize(3);</span>
<span class="nc bnc" id="L911" title="All 2 branches missed.">            for (HistoricTaskInstance historicTaskInstance : historicTaskInstances) {</span>
<span class="nc" id="L912">                assertThat(historicTaskInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L913">            }</span>

<span class="nc" id="L915">            List&lt;HistoricActivityInstance&gt; historicActivityInstances = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L916">                    .processInstanceId(processInstanceToMigrate1.getId()).list();</span>
<span class="nc" id="L917">            assertThat(historicActivityInstances).hasSize(9);</span>
<span class="nc bnc" id="L918" title="All 2 branches missed.">            for (HistoricActivityInstance historicActivityInstance : historicActivityInstances) {</span>
<span class="nc" id="L919">                assertThat(historicActivityInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L920">            }</span>
            
<span class="nc" id="L922">            historicProcessInstance = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L923">                    .processInstanceId(processInstanceToMigrate2.getId()).singleResult();</span>
<span class="nc" id="L924">            assertThat(historicProcessInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>

<span class="nc" id="L926">            historicTaskInstances = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L927">                    .processInstanceId(processInstanceToMigrate2.getId()).list();</span>
<span class="nc" id="L928">            assertThat(historicTaskInstances).hasSize(2);</span>
<span class="nc bnc" id="L929" title="All 2 branches missed.">            for (HistoricTaskInstance historicTaskInstance : historicTaskInstances) {</span>
<span class="nc" id="L930">                assertThat(historicTaskInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L931">            }</span>

<span class="nc" id="L933">            historicActivityInstances = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L934">                    .processInstanceId(processInstanceToMigrate2.getId()).list();</span>
<span class="nc" id="L935">            assertThat(historicActivityInstances).hasSize(7);</span>
<span class="nc bnc" id="L936" title="All 2 branches missed.">            for (HistoricActivityInstance historicActivityInstance : historicActivityInstances) {</span>
<span class="nc" id="L937">                assertThat(historicActivityInstance.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L938">            }</span>
        }

<span class="nc" id="L941">        task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate1.getId()).taskDefinitionKey(&quot;userTask2Id&quot;).singleResult();</span>
<span class="nc" id="L942">        taskService.complete(task.getId());</span>
        
<span class="nc" id="L944">        task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate1.getId()).taskDefinitionKey(&quot;eventSubProcessTask&quot;).singleResult();</span>
<span class="nc" id="L945">        taskService.complete(task.getId());</span>

<span class="nc" id="L947">        assertProcessEnded(processInstanceToMigrate1.getId());</span>
        
<span class="nc" id="L949">        task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate2.getId()).taskDefinitionKey(&quot;userTask1Id&quot;).singleResult();</span>
<span class="nc" id="L950">        taskService.complete(task.getId());</span>
        
<span class="nc" id="L952">        task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate2.getId()).taskDefinitionKey(&quot;userTask2Id&quot;).singleResult();</span>
<span class="nc" id="L953">        taskService.complete(task.getId());</span>
        
<span class="nc" id="L955">        task = taskService.createTaskQuery().processInstanceId(processInstanceToMigrate2.getId()).taskDefinitionKey(&quot;eventSubProcessTask&quot;).singleResult();</span>
<span class="nc" id="L956">        taskService.complete(task.getId());</span>

<span class="nc" id="L958">        assertProcessEnded(processInstanceToMigrate2.getId());</span>
<span class="nc" id="L959">    }</span>

    @Test
    public void testSimpleMigrationOfProcessInstancesById() {
        //Deploy first version of the process
<span class="nc" id="L964">        Deployment oneActivityProcessDeployment = repositoryService.createDeployment()</span>
<span class="nc" id="L965">                .name(&quot;My Process Deployment&quot;)</span>
<span class="nc" id="L966">                .addClasspathResource(&quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;)</span>
<span class="nc" id="L967">                .deploy();</span>

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L970">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>

        //Deploy second version of the process
<span class="nc" id="L973">        Deployment oneActivityProcessDeploymentV2 = repositoryService.createDeployment()</span>
<span class="nc" id="L974">                .name(&quot;My Process Deployment&quot;)</span>
<span class="nc" id="L975">                .addClasspathResource(&quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process-v2.bpmn20.xml&quot;)</span>
<span class="nc" id="L976">                .deploy();</span>

<span class="nc" id="L978">        List&lt;ProcessDefinition&gt; processDefinitions = repositoryService.createProcessDefinitionQuery()</span>
<span class="nc" id="L979">                .processDefinitionKey(&quot;MP&quot;)</span>
<span class="nc" id="L980">                .list();</span>

<span class="nc" id="L982">        assertThat(processDefinitions).hasSize(2);</span>

<span class="nc bnc" id="L984" title="All 2 branches missed.">        ProcessDefinition version1ProcessDef = processDefinitions.stream().filter(d -&gt; d.getVersion() == 1).findFirst().get();</span>
<span class="nc" id="L985">        assertThat(version1ProcessDef.getDeploymentId()).isEqualTo(oneActivityProcessDeployment.getId());</span>
<span class="nc bnc" id="L986" title="All 2 branches missed.">        ProcessDefinition version2ProcessDef = processDefinitions.stream().filter(d -&gt; d.getVersion() == 2).findFirst().get();</span>
<span class="nc" id="L987">        assertThat(version2ProcessDef.getDeploymentId()).isEqualTo(oneActivityProcessDeploymentV2.getId());</span>

<span class="nc" id="L989">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L990">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L991">        executions.stream()</span>
<span class="nc" id="L992">                .map(e -&gt; (ExecutionEntity) e)</span>
<span class="nc" id="L993">                .forEach(e -&gt; assertThat(e.getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId()));</span>

<span class="nc" id="L995">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L996">        assertThat(tasks).hasSize(1);</span>
<span class="nc" id="L997">        assertThat(tasks.get(0).getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId());</span>
<span class="nc" id="L998">        assertThat(tasks.get(0).getTaskDefinitionKey()).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L999">        assertThat(tasks)</span>
<span class="nc" id="L1000">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1001">                .containsExactly(tuple(version1ProcessDef.getId(), &quot;userTask1Id&quot;));</span>

<span class="nc" id="L1003">        ProcessInstanceMigrationValidationResult validationResult = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1004">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L1005">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;theTask&quot;))</span>
<span class="nc" id="L1006">                .validateMigration(processInstance.getId());</span>

<span class="nc" id="L1008">        assertThat(validationResult.isMigrationValid()).isTrue();</span>

        //Migrate process - moving all instances
<span class="nc" id="L1011">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1012">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L1013">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;theTask&quot;));</span>

<span class="nc" id="L1015">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigrationOfProcessInstances(version1ProcessDef.getId());</span>
<span class="nc" id="L1016">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1018">        processInstanceMigrationBuilder.migrateProcessInstances(version1ProcessDef.getId());</span>

<span class="nc" id="L1020">        executions = runtimeService.createExecutionQuery().list();</span>
<span class="nc" id="L1021">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L1022">        executions.stream()</span>
<span class="nc" id="L1023">                .map(e -&gt; (ExecutionEntity) e)</span>
<span class="nc" id="L1024">                .forEach(e -&gt; assertThat(e.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId()));</span>

<span class="nc" id="L1026">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1027">        assertThat(tasks)</span>
<span class="nc" id="L1028">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1029">                .containsExactly(tuple(version2ProcessDef.getId(), &quot;theTask&quot;));</span>

<span class="nc" id="L1031">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L1032">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1033">    }</span>
    
    @Test
    public void testSimpleMigrationOfProcessInstancesByKey() {
        //Deploy first version of the process
<span class="nc" id="L1038">        Deployment oneActivityProcessDeployment = repositoryService.createDeployment()</span>
<span class="nc" id="L1039">                .name(&quot;My Process Deployment&quot;)</span>
<span class="nc" id="L1040">                .addClasspathResource(&quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;)</span>
<span class="nc" id="L1041">                .deploy();</span>

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L1044">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>

        //Deploy second version of the process
<span class="nc" id="L1047">        Deployment oneActivityProcessDeploymentV2 = repositoryService.createDeployment()</span>
<span class="nc" id="L1048">                .name(&quot;My Process Deployment&quot;)</span>
<span class="nc" id="L1049">                .addClasspathResource(&quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process-v2.bpmn20.xml&quot;)</span>
<span class="nc" id="L1050">                .deploy();</span>

<span class="nc" id="L1052">        List&lt;ProcessDefinition&gt; processDefinitions = repositoryService.createProcessDefinitionQuery()</span>
<span class="nc" id="L1053">                .processDefinitionKey(&quot;MP&quot;)</span>
<span class="nc" id="L1054">                .list();</span>

<span class="nc" id="L1056">        assertThat(processDefinitions).hasSize(2);</span>

<span class="nc bnc" id="L1058" title="All 2 branches missed.">        ProcessDefinition version1ProcessDef = processDefinitions.stream().filter(d -&gt; d.getVersion() == 1).findFirst().get();</span>
<span class="nc" id="L1059">        assertThat(version1ProcessDef.getDeploymentId()).isEqualTo(oneActivityProcessDeployment.getId());</span>
<span class="nc bnc" id="L1060" title="All 2 branches missed.">        ProcessDefinition version2ProcessDef = processDefinitions.stream().filter(d -&gt; d.getVersion() == 2).findFirst().get();</span>
<span class="nc" id="L1061">        assertThat(version2ProcessDef.getDeploymentId()).isEqualTo(oneActivityProcessDeploymentV2.getId());</span>

<span class="nc" id="L1063">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1064">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L1065">        executions.stream()</span>
<span class="nc" id="L1066">                .map(e -&gt; (ExecutionEntity) e)</span>
<span class="nc" id="L1067">                .forEach(e -&gt; assertThat(e.getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId()));</span>

<span class="nc" id="L1069">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1070">        assertThat(tasks).hasSize(1);</span>
<span class="nc" id="L1071">        assertThat(tasks.get(0).getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId());</span>
<span class="nc" id="L1072">        assertThat(tasks.get(0).getTaskDefinitionKey()).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1073">        assertThat(tasks)</span>
<span class="nc" id="L1074">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1075">                .containsExactly(tuple(version1ProcessDef.getId(), &quot;userTask1Id&quot;));</span>

<span class="nc" id="L1077">        ProcessInstanceMigrationValidationResult validationResult = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1078">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L1079">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;theTask&quot;))</span>
<span class="nc" id="L1080">                .validateMigration(processInstance.getId());</span>

<span class="nc" id="L1082">        assertThat(validationResult.isMigrationValid()).isTrue();</span>

        //Migrate process - moving all instances
<span class="nc" id="L1085">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1086">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L1087">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;theTask&quot;));</span>

<span class="nc" id="L1089">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigrationOfProcessInstances(&quot;MP&quot;, 1, null);</span>
<span class="nc" id="L1090">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1092">        processInstanceMigrationBuilder.migrateProcessInstances(&quot;MP&quot;, 1, null);</span>

<span class="nc" id="L1094">        executions = runtimeService.createExecutionQuery().list();</span>
<span class="nc" id="L1095">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L1096">        executions.stream()</span>
<span class="nc" id="L1097">                .map(e -&gt; (ExecutionEntity) e)</span>
<span class="nc" id="L1098">                .forEach(e -&gt; assertThat(e.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId()));</span>

<span class="nc" id="L1100">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1101">        assertThat(tasks)</span>
<span class="nc" id="L1102">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1103">                .containsExactly(tuple(version2ProcessDef.getId(), &quot;theTask&quot;));</span>

<span class="nc" id="L1105">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L1106">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1107">    }</span>
    
    @Test
    public void testSimpleMigrationWithExplicitActivityMapping1() {
        //Deploy first version of the process
<span class="nc" id="L1112">        Deployment oneActivityProcessDeployment = repositoryService.createDeployment()</span>
<span class="nc" id="L1113">                .name(&quot;My Process Deployment&quot;)</span>
<span class="nc" id="L1114">                .addClasspathResource(&quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;)</span>
<span class="nc" id="L1115">                .deploy();</span>

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L1118">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>

        //Deploy second version of the process
<span class="nc" id="L1121">        Deployment twoActivitiesProcessDeployment = repositoryService.createDeployment()</span>
<span class="nc" id="L1122">                .name(&quot;My Process Deployment&quot;)</span>
<span class="nc" id="L1123">                .addClasspathResource(&quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;)</span>
<span class="nc" id="L1124">                .deploy();</span>

<span class="nc" id="L1126">        List&lt;ProcessDefinition&gt; processDefinitions = repositoryService.createProcessDefinitionQuery()</span>
<span class="nc" id="L1127">                .processDefinitionKey(&quot;MP&quot;)</span>
<span class="nc" id="L1128">                .list();</span>

<span class="nc" id="L1130">        assertThat(processDefinitions).hasSize(2);</span>

<span class="nc bnc" id="L1132" title="All 2 branches missed.">        ProcessDefinition version1ProcessDef = processDefinitions.stream().filter(d -&gt; d.getVersion() == 1).findFirst().get();</span>
<span class="nc" id="L1133">        assertThat(version1ProcessDef.getDeploymentId()).isEqualTo(oneActivityProcessDeployment.getId());</span>
<span class="nc bnc" id="L1134" title="All 2 branches missed.">        ProcessDefinition version2ProcessDef = processDefinitions.stream().filter(d -&gt; d.getVersion() == 2).findFirst().get();</span>
<span class="nc" id="L1135">        assertThat(version2ProcessDef.getDeploymentId()).isEqualTo(twoActivitiesProcessDeployment.getId());</span>

<span class="nc" id="L1137">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1138">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L1139">        executions.stream()</span>
<span class="nc" id="L1140">                .map(e -&gt; (ExecutionEntity) e)</span>
<span class="nc" id="L1141">                .forEach(e -&gt; assertThat(e.getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId()));</span>

<span class="nc" id="L1143">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1144">        assertThat(tasks).hasSize(1);</span>
<span class="nc" id="L1145">        assertThat(tasks.get(0).getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId());</span>
<span class="nc" id="L1146">        assertThat(tasks.get(0).getTaskDefinitionKey()).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1147">        assertThat(tasks)</span>
<span class="nc" id="L1148">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1149">                .containsExactly(tuple(version1ProcessDef.getId(), &quot;userTask1Id&quot;));</span>

<span class="nc" id="L1151">        ProcessInstanceMigrationValidationResult validationResult = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1152">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L1153">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;userTask1Id&quot;))</span>
<span class="nc" id="L1154">                .validateMigration(processInstance.getId());</span>

<span class="nc" id="L1156">        assertThat(validationResult.isMigrationValid()).isTrue();</span>

        //Migrate process - moving the current execution explicitly
<span class="nc" id="L1159">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1160">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L1161">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;userTask1Id&quot;));</span>

<span class="nc" id="L1163">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L1164">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1166">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L1168">        executions = runtimeService.createExecutionQuery().list();</span>
<span class="nc" id="L1169">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L1170">        executions.stream()</span>
<span class="nc" id="L1171">                .map(e -&gt; (ExecutionEntity) e)</span>
<span class="nc" id="L1172">                .forEach(e -&gt; assertThat(e.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId()));</span>

<span class="nc" id="L1174">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1175">        assertThat(tasks)</span>
<span class="nc" id="L1176">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1177">                .containsExactly(tuple(version2ProcessDef.getId(), &quot;userTask1Id&quot;));</span>

        //This new process definition has two activities
<span class="nc" id="L1180">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L1181">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1182">        assertThat(tasks)</span>
<span class="nc" id="L1183">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1184">                .containsExactly(tuple(version2ProcessDef.getId(), &quot;userTask2Id&quot;));</span>

<span class="nc" id="L1186">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L1187">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1188">    }</span>

    @Test
    public void testSimpleMigrationWithExplicitActivityMapping2() {
        //Deploy first version of the process
<span class="nc" id="L1193">        Deployment oneActivityProcessDeployment = repositoryService.createDeployment()</span>
<span class="nc" id="L1194">                .name(&quot;My Process Deployment&quot;)</span>
<span class="nc" id="L1195">                .addClasspathResource(&quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;)</span>
<span class="nc" id="L1196">                .deploy();</span>

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L1199">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>

        //Deploy second version of the process
<span class="nc" id="L1202">        Deployment twoActivitiesProcessDeployment = repositoryService.createDeployment()</span>
<span class="nc" id="L1203">                .name(&quot;My Process Deployment&quot;)</span>
<span class="nc" id="L1204">                .addClasspathResource(&quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;)</span>
<span class="nc" id="L1205">                .deploy();</span>

<span class="nc" id="L1207">        List&lt;ProcessDefinition&gt; processDefinitions = repositoryService.createProcessDefinitionQuery()</span>
<span class="nc" id="L1208">                .processDefinitionKey(&quot;MP&quot;)</span>
<span class="nc" id="L1209">                .list();</span>

<span class="nc" id="L1211">        assertThat(processDefinitions).hasSize(2);</span>

<span class="nc bnc" id="L1213" title="All 2 branches missed.">        ProcessDefinition version1ProcessDef = processDefinitions.stream().filter(d -&gt; d.getVersion() == 1).findFirst().get();</span>
<span class="nc" id="L1214">        assertThat(version1ProcessDef.getDeploymentId()).isEqualTo(oneActivityProcessDeployment.getId());</span>
<span class="nc bnc" id="L1215" title="All 2 branches missed.">        ProcessDefinition version2ProcessDef = processDefinitions.stream().filter(d -&gt; d.getVersion() == 2).findFirst().get();</span>
<span class="nc" id="L1216">        assertThat(version2ProcessDef.getDeploymentId()).isEqualTo(twoActivitiesProcessDeployment.getId());</span>

<span class="nc" id="L1218">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1219">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L1220">        executions.stream()</span>
<span class="nc" id="L1221">                .map(e -&gt; (ExecutionEntity) e)</span>
<span class="nc" id="L1222">                .forEach(e -&gt; assertThat(e.getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId()));</span>

<span class="nc" id="L1224">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1225">        assertThat(tasks)</span>
<span class="nc" id="L1226">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1227">                .containsExactly(tuple(version1ProcessDef.getId(), &quot;userTask1Id&quot;));</span>

<span class="nc" id="L1229">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1230">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L1231">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;userTask3Id&quot;))</span>
<span class="nc" id="L1232">                .validateMigration(processInstance.getId());</span>

<span class="nc" id="L1234">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isFalse();</span>
<span class="nc" id="L1235">        assertThat(processInstanceMigrationValidationResult.getValidationMessages())</span>
<span class="nc" id="L1236">                .isEqualTo(Collections</span>
<span class="nc" id="L1237">                        .singletonList(&quot;Invalid mapping for 'userTask1Id' to 'userTask3Id', cannot be found in the process definition with id 'MP'&quot;));</span>

<span class="nc" id="L1239">        processInstanceMigrationValidationResult = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1240">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L1241">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;userTask2Id&quot;))</span>
<span class="nc" id="L1242">                .validateMigration(processInstance.getId());</span>

<span class="nc" id="L1244">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

        //Migrate process - moving the current execution explicitly
<span class="nc" id="L1247">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1248">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L1249">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;userTask2Id&quot;));</span>

<span class="nc" id="L1251">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L1252">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1254">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L1256">        executions = runtimeService.createExecutionQuery().list();</span>
<span class="nc" id="L1257">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L1258">        executions.stream()</span>
<span class="nc" id="L1259">                .map(e -&gt; (ExecutionEntity) e)</span>
<span class="nc" id="L1260">                .forEach(e -&gt; assertThat(e.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId()));</span>

<span class="nc" id="L1262">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1263">        assertThat(tasks)</span>
<span class="nc" id="L1264">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1265">                .containsExactly(tuple(version2ProcessDef.getId(), &quot;userTask2Id&quot;));</span>

        //This new process definition has two activities, but we have mapped to the last activity explicitly
<span class="nc" id="L1268">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L1269">        assertProcessEnded(processInstance.getId());</span>

<span class="nc" id="L1271">    }</span>

    @Test
    public void testSimpleMigrationWithExplicitActivityMapping3() {
        //Deploy first version of the process
<span class="nc" id="L1276">        Deployment twoActivitiesProcessDeployment = repositoryService.createDeployment()</span>
<span class="nc" id="L1277">                .name(&quot;My Process Deployment&quot;)</span>
<span class="nc" id="L1278">                .addClasspathResource(&quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;)</span>
<span class="nc" id="L1279">                .deploy();</span>

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L1282">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>

        //Deploy second version of the process
<span class="nc" id="L1285">        Deployment oneActivityProcessDeployment = repositoryService.createDeployment()</span>
<span class="nc" id="L1286">                .name(&quot;My Process Deployment&quot;)</span>
<span class="nc" id="L1287">                .addClasspathResource(&quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;)</span>
<span class="nc" id="L1288">                .deploy();</span>

<span class="nc" id="L1290">        List&lt;ProcessDefinition&gt; processDefinitions = repositoryService.createProcessDefinitionQuery()</span>
<span class="nc" id="L1291">                .processDefinitionKey(&quot;MP&quot;)</span>
<span class="nc" id="L1292">                .list();</span>

<span class="nc" id="L1294">        assertThat(processDefinitions).hasSize(2);</span>

<span class="nc bnc" id="L1296" title="All 2 branches missed.">        ProcessDefinition version1ProcessDef = processDefinitions.stream().filter(d -&gt; d.getVersion() == 1).findFirst().get();</span>
<span class="nc" id="L1297">        assertThat(version1ProcessDef.getDeploymentId()).isEqualTo(twoActivitiesProcessDeployment.getId());</span>
<span class="nc bnc" id="L1298" title="All 2 branches missed.">        ProcessDefinition version2ProcessDef = processDefinitions.stream().filter(d -&gt; d.getVersion() == 2).findFirst().get();</span>
<span class="nc" id="L1299">        assertThat(version2ProcessDef.getDeploymentId()).isEqualTo(oneActivityProcessDeployment.getId());</span>

<span class="nc" id="L1301">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1302">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L1303">        executions.stream()</span>
<span class="nc" id="L1304">                .map(e -&gt; (ExecutionEntity) e)</span>
<span class="nc" id="L1305">                .forEach(e -&gt; assertThat(e.getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId()));</span>

<span class="nc" id="L1307">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1308">        assertThat(tasks)</span>
<span class="nc" id="L1309">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1310">                .containsExactly(tuple(version1ProcessDef.getId(), &quot;userTask1Id&quot;));</span>

        //We want to migrate from the next activity
<span class="nc" id="L1313">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L1314">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1315">        assertThat(tasks)</span>
<span class="nc" id="L1316">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1317">                .containsExactly(tuple(version1ProcessDef.getId(), &quot;userTask2Id&quot;));</span>

        //Migrate process - moving the current execution explicitly
<span class="nc" id="L1320">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1321">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L1322">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask2Id&quot;, &quot;userTask1Id&quot;));</span>

<span class="nc" id="L1324">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L1325">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1327">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L1329">        executions = runtimeService.createExecutionQuery().list();</span>
<span class="nc" id="L1330">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L1331">        executions.stream()</span>
<span class="nc" id="L1332">                .map(e -&gt; (ExecutionEntity) e)</span>
<span class="nc" id="L1333">                .forEach(e -&gt; assertThat(e.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId()));</span>

<span class="nc" id="L1335">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1336">        assertThat(tasks)</span>
<span class="nc" id="L1337">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1338">                .containsExactly(tuple(version2ProcessDef.getId(), &quot;userTask1Id&quot;));</span>

        //This new process version only have one activity
<span class="nc" id="L1341">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L1342">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1343">    }</span>
    
    @Test
    public void testOneSimpleUserTaskDirectMigration() {
        //Almost all tests use UserTask, thus are direct migrations, but this one checks explicitly for changes in History
        //Deploy first version of the process
<span class="nc" id="L1349">        deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L1353">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>

        //Deploy second version of the process
<span class="nc" id="L1356">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);

<span class="nc" id="L1359">        Execution executionBefore = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().singleResult();</span>
<span class="nc" id="L1360">        assertThat(executionBefore).isNotNull();</span>
<span class="nc" id="L1361">        String executionBeforeId = executionBefore.getId();</span>

<span class="nc" id="L1363">        Task taskBefore = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1364">        String taskBeforeId = taskBefore.getId();</span>

        //Migrate process
<span class="nc" id="L1367">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1368">                .migrateToProcessDefinition(version2ProcessDef.getId());</span>

<span class="nc" id="L1370">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L1371">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1373">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L1375">        ExecutionEntity executionAfter = (ExecutionEntity) runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().singleResult();</span>
<span class="nc" id="L1376">        assertThat(executionAfter.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L1377">        assertThat(executionBeforeId).isEqualTo(executionAfter.getId());</span>

<span class="nc" id="L1379">        Task taskAfter = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1380">        assertThat(taskAfter.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L1381">        assertThat(taskBeforeId).isEqualTo(taskAfter.getId());</span>
<span class="nc" id="L1382">    }</span>
    
    @Test
    public void testOneAsyncServiceTaskDirectMigration() {
        //Almost all tests use UserTask, thus are direct migrations, but this one checks explicitly for changes in History
        //Deploy first version of the process
<span class="nc" id="L1388">        ProcessDefinition version1ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/async-service-task.bpmn20.xml&quot;);

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L1392">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>

        //Deploy second version of the process
<span class="nc" id="L1395">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/updated-async-service-task.bpmn20.xml&quot;);

<span class="nc" id="L1398">        Execution executionBefore = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().singleResult();</span>
<span class="nc" id="L1399">        assertThat(executionBefore).isNotNull();</span>
<span class="nc" id="L1400">        String executionBeforeId = executionBefore.getId();</span>

<span class="nc" id="L1402">        Job jobBefore = managementService.createJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1403">        String jobBeforeId = jobBefore.getId();</span>

        //Migrate process
<span class="nc" id="L1406">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1407">                .migrateToProcessDefinition(version2ProcessDef.getId());</span>

<span class="nc" id="L1409">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L1410">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1412">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L1414">        ExecutionEntity executionAfter = (ExecutionEntity) runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().singleResult();</span>
<span class="nc" id="L1415">        assertThat(executionAfter.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L1416">        assertThat(executionBeforeId).isEqualTo(executionAfter.getId());</span>

<span class="nc" id="L1418">        Job jobAfter = managementService.createJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1419">        assertThat(jobAfter.getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId());</span>
<span class="nc" id="L1420">        assertThat(jobBeforeId).isEqualTo(jobAfter.getId());</span>
        
<span class="nc" id="L1422">        managementService.executeJob(jobAfter.getId());</span>
<span class="nc" id="L1423">        assertProcessEnded(processInstance.getId());</span>
        
<span class="nc bnc" id="L1425" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1426">            HistoricVariableInstance historicVariableInstance = historyService.createHistoricVariableInstanceQuery().processInstanceId(processInstance.getId()).variableName(&quot;migrationVar&quot;).singleResult();</span>
<span class="nc" id="L1427">            assertThat(historicVariableInstance).isNotNull();</span>
<span class="nc" id="L1428">            assertThat(historicVariableInstance.getValue()).isEqualTo(&quot;test&quot;);</span>
        }
<span class="nc" id="L1430">    }</span>
    
    @Test
    public void testOneAsyncLeaveServiceTaskDirectMigration() {
        //Almost all tests use UserTask, thus are direct migrations, but this one checks explicitly for changes in History
        //Deploy first version of the process
<span class="nc" id="L1436">        ProcessDefinition version1ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/async-leave-service-task.bpmn20.xml&quot;);

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L1440">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>

        //Deploy second version of the process
<span class="nc" id="L1443">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/updated-async-leave-service-task.bpmn20.xml&quot;);

<span class="nc" id="L1446">        Execution executionBefore = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().singleResult();</span>
<span class="nc" id="L1447">        assertThat(executionBefore).isNotNull();</span>
<span class="nc" id="L1448">        String executionBeforeId = executionBefore.getId();</span>

<span class="nc" id="L1450">        Job jobBefore = managementService.createJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1451">        String jobBeforeId = jobBefore.getId();</span>

        //Migrate process
<span class="nc" id="L1454">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1455">                .migrateToProcessDefinition(version2ProcessDef.getId());</span>

<span class="nc" id="L1457">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L1458">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1460">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L1462">        ExecutionEntity executionAfter = (ExecutionEntity) runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().singleResult();</span>
<span class="nc" id="L1463">        assertThat(executionAfter.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L1464">        assertThat(executionBeforeId).isEqualTo(executionAfter.getId());</span>

<span class="nc" id="L1466">        Job jobAfter = managementService.createJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1467">        assertThat(jobAfter.getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId());</span>
<span class="nc" id="L1468">        assertThat(jobBeforeId).isEqualTo(jobAfter.getId());</span>
        
<span class="nc" id="L1470">        managementService.executeJob(jobAfter.getId());</span>
<span class="nc" id="L1471">        assertProcessEnded(processInstance.getId());</span>
        
<span class="nc bnc" id="L1473" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1474">            HistoricVariableInstance historicVariableInstance = historyService.createHistoricVariableInstanceQuery().processInstanceId(processInstance.getId()).variableName(&quot;migrationVar&quot;).singleResult();</span>
<span class="nc" id="L1475">            assertThat(historicVariableInstance).isNull();</span>
        }
<span class="nc" id="L1477">    }</span>

    @Test
    public void testSimpleUserTaskDirectMigration() {

        //Almost all tests use UserTask, thus are direct migrations, but this one checks explicitly for changes in History
        //Deploy first version of the process
<span class="nc" id="L1484">        ProcessDefinition version1ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L1488">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>

        //Deploy second version of the process
<span class="nc" id="L1491">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;);

<span class="nc" id="L1494">        List&lt;ProcessDefinition&gt; processDefinitions = repositoryService.createProcessDefinitionQuery()</span>
<span class="nc" id="L1495">                .processDefinitionKey(&quot;MP&quot;)</span>
<span class="nc" id="L1496">                .list();</span>

<span class="nc" id="L1498">        assertThat(processDefinitions)</span>
<span class="nc" id="L1499">                .extracting(ProcessDefinition::getId)</span>
<span class="nc" id="L1500">                .containsExactlyInAnyOrder(version1ProcessDef.getId(), version2ProcessDef.getId());</span>

<span class="nc" id="L1502">        List&lt;Execution&gt; executionsBefore = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1503">        assertThat(executionsBefore).hasSize(2); //includes root execution</span>
<span class="nc" id="L1504">        executionsBefore.stream()</span>
<span class="nc" id="L1505">                .map(e -&gt; (ExecutionEntity) e)</span>
<span class="nc" id="L1506">                .forEach(e -&gt; assertThat(e.getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId()));</span>

<span class="nc" id="L1508">        List&lt;Task&gt; tasksBefore = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1509">        assertThat(tasksBefore)</span>
<span class="nc" id="L1510">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1511">                .containsExactly(tuple(version1ProcessDef.getId(), &quot;userTask1Id&quot;));</span>

<span class="nc" id="L1513">        List&lt;HistoricActivityInstance&gt; historicActivityInstancesBefore = null;</span>
<span class="nc" id="L1514">        List&lt;HistoricTaskInstance&gt; historicTaskInstancesBefore = null;</span>
<span class="nc bnc" id="L1515" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L1516">            historicActivityInstancesBefore = historyService.createHistoricActivityInstanceQuery().orderByExecutionId().asc().list();</span>

<span class="nc bnc" id="L1518" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1519">                historicTaskInstancesBefore = historyService.createHistoricTaskInstanceQuery().orderByExecutionId().asc().list();</span>
            }
        }

        //Migrate process
<span class="nc" id="L1524">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1525">                .migrateToProcessDefinition(version2ProcessDef.getId());</span>

<span class="nc" id="L1527">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L1528">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1530">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L1532">        List&lt;Execution&gt; executionsAfter = runtimeService.createExecutionQuery().list();</span>
<span class="nc" id="L1533">        assertThat(executionsAfter).hasSize(2); //includes root execution</span>
<span class="nc" id="L1534">        executionsAfter.stream()</span>
<span class="nc" id="L1535">                .map(e -&gt; (ExecutionEntity) e)</span>
<span class="nc" id="L1536">                .forEach(e -&gt; assertThat(e.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId()));</span>

<span class="nc" id="L1538">        List&lt;Task&gt; tasksAfter = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1539">        assertThat(tasksAfter)</span>
<span class="nc" id="L1540">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1541">                .containsExactly(tuple(version2ProcessDef.getId(), &quot;userTask1Id&quot;)); //AutoMapped by Id</span>

<span class="nc bnc" id="L1543" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L1544">            List&lt;HistoricActivityInstance&gt; historicActivityInstancesAfter = historyService.createHistoricActivityInstanceQuery().orderByExecutionId().asc()</span>
<span class="nc" id="L1545">                    .list();</span>
<span class="nc" id="L1546">            assertThat(historicActivityInstancesAfter).hasSameSizeAs(historicActivityInstancesBefore);</span>
<span class="nc" id="L1547">            assertThat(historicActivityInstancesBefore)</span>
<span class="nc" id="L1548">                    .usingRecursiveFieldByFieldElementComparatorIgnoringFields(&quot;revision&quot;, &quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1549">                    .containsExactlyInAnyOrderElementsOf(historicActivityInstancesAfter);</span>

<span class="nc bnc" id="L1551" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1552">                List&lt;HistoricTaskInstance&gt; historicTaskInstancesAfter = historyService.createHistoricTaskInstanceQuery().orderByExecutionId().asc().list();</span>

<span class="nc" id="L1554">                assertThat(historicTaskInstancesAfter).hasSameSizeAs(historicTaskInstancesBefore);</span>
<span class="nc" id="L1555">                assertThat(historicTaskInstancesBefore)</span>
<span class="nc" id="L1556">                        .usingRecursiveFieldByFieldElementComparatorIgnoringFields(&quot;revision&quot;, &quot;processDefinitionId&quot;, &quot;originalPersistentState&quot;, &quot;lastUpdateTime&quot;)</span>
<span class="nc" id="L1557">                        .containsExactlyInAnyOrderElementsOf(historicTaskInstancesAfter);</span>
            }
        }

        //The first process version only had one activity, there should be a second activity in the process now
<span class="nc" id="L1562">        taskService.complete(tasksAfter.get(0).getId());</span>
<span class="nc" id="L1563">        tasksAfter = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1564">        assertThat(tasksAfter)</span>
<span class="nc" id="L1565">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1566">                .containsExactly(&quot;userTask2Id&quot;);</span>

<span class="nc" id="L1568">        taskService.complete(tasksAfter.get(0).getId());</span>
<span class="nc" id="L1569">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1570">    }</span>

    @Test
    public void testSimpleUserTaskDirectMigrationReAssign() {

        //Almost all tests use UserTask, thus are direct migrations, but this one checks explicitly for changes in History
        //Deploy first version of the process
<span class="nc" id="L1577">        ProcessDefinition version1ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L1581">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>

        //Deploy second version of the process
<span class="nc" id="L1584">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;);

<span class="nc" id="L1587">        List&lt;ProcessDefinition&gt; processDefinitions = repositoryService.createProcessDefinitionQuery()</span>
<span class="nc" id="L1588">                .processDefinitionKey(&quot;MP&quot;)</span>
<span class="nc" id="L1589">                .list();</span>

<span class="nc" id="L1591">        assertThat(processDefinitions)</span>
<span class="nc" id="L1592">                .extracting(ProcessDefinition::getId)</span>
<span class="nc" id="L1593">                .containsExactlyInAnyOrder(version1ProcessDef.getId(), version2ProcessDef.getId());</span>

<span class="nc" id="L1595">        List&lt;Execution&gt; executionsBefore = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1596">        assertThat(executionsBefore).hasSize(2); //includes root execution</span>
<span class="nc" id="L1597">        executionsBefore.stream()</span>
<span class="nc" id="L1598">                .map(e -&gt; (ExecutionEntity) e)</span>
<span class="nc" id="L1599">                .forEach(e -&gt; assertThat(e.getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId()));</span>

<span class="nc" id="L1601">        List&lt;Task&gt; tasksBefore = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1602">        assertThat(tasksBefore)</span>
<span class="nc" id="L1603">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1604">                .containsExactly(tuple(version1ProcessDef.getId(), &quot;userTask1Id&quot;));</span>
<span class="nc" id="L1605">        assertThat(tasksBefore)</span>
<span class="nc" id="L1606">                .extracting(Task::getAssignee)</span>
<span class="nc" id="L1607">                .containsNull();</span>

<span class="nc" id="L1609">        List&lt;HistoricActivityInstance&gt; historicActivityInstancesBefore = null;</span>
<span class="nc" id="L1610">        List&lt;HistoricTaskInstance&gt; historicTaskInstancesBefore = null;</span>
<span class="nc bnc" id="L1611" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L1612">            historicActivityInstancesBefore = historyService.createHistoricActivityInstanceQuery().orderByExecutionId().asc().list();</span>

<span class="nc bnc" id="L1614" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1615">                historicTaskInstancesBefore = historyService.createHistoricTaskInstanceQuery().orderByExecutionId().asc().list();</span>
            }
        }

        //Migrate process
<span class="nc" id="L1620">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1621">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L1622">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;userTask1Id&quot;).withNewAssignee(&quot;kermit&quot;));</span>

<span class="nc" id="L1624">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L1625">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1627">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L1629">        List&lt;Execution&gt; executionsAfter = runtimeService.createExecutionQuery().list();</span>
<span class="nc" id="L1630">        assertThat(executionsAfter).hasSize(2); //includes root execution</span>
<span class="nc" id="L1631">        executionsAfter.stream()</span>
<span class="nc" id="L1632">                .map(e -&gt; (ExecutionEntity) e)</span>
<span class="nc" id="L1633">                .forEach(e -&gt; assertThat(e.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId()));</span>

<span class="nc" id="L1635">        List&lt;Task&gt; tasksAfter = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1636">        assertThat(tasksAfter)</span>
<span class="nc" id="L1637">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey, Task::getAssignee)</span>
<span class="nc" id="L1638">                .containsExactly(tuple(version2ProcessDef.getId(), &quot;userTask1Id&quot;, &quot;kermit&quot;)); //AutoMapped by Id</span>

<span class="nc bnc" id="L1640" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L1641">            List&lt;HistoricActivityInstance&gt; historicActivityInstancesAfter = historyService.createHistoricActivityInstanceQuery().orderByExecutionId().asc()</span>
<span class="nc" id="L1642">                    .list();</span>
<span class="nc" id="L1643">            assertThat(historicActivityInstancesAfter).hasSameSizeAs(historicActivityInstancesBefore);</span>
<span class="nc" id="L1644">            assertThat(historicActivityInstancesBefore)</span>
<span class="nc" id="L1645">                    .usingRecursiveFieldByFieldElementComparatorIgnoringFields(&quot;revision&quot;, &quot;processDefinitionId&quot;, &quot;assignee&quot;, &quot;originalPersistentState&quot;)</span>
<span class="nc" id="L1646">                    .containsExactlyInAnyOrderElementsOf(historicActivityInstancesAfter);</span>

<span class="nc bnc" id="L1648" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1649">                List&lt;HistoricTaskInstance&gt; historicTaskInstancesAfter = historyService.createHistoricTaskInstanceQuery().orderByExecutionId().asc().list();</span>

<span class="nc" id="L1651">                assertThat(historicTaskInstancesAfter).hasSameSizeAs(historicTaskInstancesBefore);</span>
<span class="nc" id="L1652">                assertThat(historicTaskInstancesBefore)</span>
<span class="nc" id="L1653">                        .usingRecursiveFieldByFieldElementComparatorIgnoringFields(&quot;revision&quot;, &quot;processDefinitionId&quot;, &quot;assignee&quot;, &quot;originalPersistentState&quot;, &quot;lastUpdateTime&quot;)</span>
<span class="nc" id="L1654">                        .containsExactlyInAnyOrderElementsOf(historicTaskInstancesAfter);</span>
            }
        }

        //The first process version only had one activity, there should be a second activity in the process now
<span class="nc" id="L1659">        taskService.complete(tasksAfter.get(0).getId());</span>
<span class="nc" id="L1660">        tasksAfter = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1661">        assertThat(tasksAfter)</span>
<span class="nc" id="L1662">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1663">                .containsExactly(tuple(version2ProcessDef.getId(), &quot;userTask2Id&quot;));</span>

<span class="nc" id="L1665">        taskService.complete(tasksAfter.get(0).getId());</span>
<span class="nc" id="L1666">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1667">    }</span>

    @Test
    public void testSimpleUserTaskDirectMigrationChangeOwner() {

<span class="nc" id="L1672">        ProcessDefinition version1ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);

<span class="nc" id="L1675">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>

<span class="nc" id="L1677">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;);

<span class="nc" id="L1680">        List&lt;Task&gt; tasksBefore = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1681">        assertThat(tasksBefore)</span>
<span class="nc" id="L1682">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey, Task::getOwner)</span>
<span class="nc" id="L1683">                .containsExactly(tuple(version1ProcessDef.getId(), &quot;userTask1Id&quot;, null));</span>

        //Migrate process
<span class="nc" id="L1686">        processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1687">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L1688">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;userTask1Id&quot;).withNewOwner(&quot;kermit&quot;))</span>
<span class="nc" id="L1689">                .migrate(processInstance.getId());</span>

<span class="nc" id="L1691">        List&lt;Task&gt; tasksAfter = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1692">        assertThat(tasksAfter)</span>
<span class="nc" id="L1693">                .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey, Task::getOwner)</span>
<span class="nc" id="L1694">                .containsExactly(tuple(version2ProcessDef.getId(), &quot;userTask1Id&quot;, &quot;kermit&quot;));</span>

<span class="nc" id="L1696">    }</span>

    @Test
    public void testSimpleMigrationWithinSimpleSubProcess() {
<span class="nc" id="L1700">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-tasks-inside-subprocess.bpmn20.xml&quot;);
<span class="nc" id="L1702">        ProcessDefinition procDefTwoTasks = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-inside-subprocess.bpmn20.xml&quot;);

        //Start an instance of a process with one task inside a subProcess
<span class="nc" id="L1706">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm and move inside the subProcess
<span class="nc" id="L1709">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1710">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L1711">        assertThat(executions)</span>
<span class="nc" id="L1712">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1713">                .containsOnly(procDefOneTask.getId());</span>

        //Should be only one task
<span class="nc" id="L1716">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1717">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;BeforeSubProcess&quot;);</span>
<span class="nc" id="L1718">        completeTask(task);</span>

<span class="nc" id="L1720">        List&lt;Execution&gt; executionsBeforeMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L1721">                .list();</span>
<span class="nc" id="L1722">        assertThat(executionsBeforeMigration)  //Includes subProcess</span>
<span class="nc" id="L1723">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1724">                .containsExactlyInAnyOrder(&quot;SimpleSubProcess&quot;, &quot;InsideSimpleSubProcess1&quot;);</span>
<span class="nc" id="L1725">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1726">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;InsideSimpleSubProcess1&quot;);</span>

        //Migrate to the other processDefinition
<span class="nc" id="L1729">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1730">                .migrateToProcessDefinition(procDefTwoTasks.getId())</span>
<span class="nc" id="L1731">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;InsideSimpleSubProcess1&quot;, &quot;InsideSimpleSubProcess2&quot;));</span>

<span class="nc" id="L1733">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L1734">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1736">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm and move inside the subProcess
<span class="nc" id="L1739">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L1740">                .list();</span>
<span class="nc" id="L1741">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L1742">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1743">                .containsExactlyInAnyOrder(&quot;SimpleSubProcess&quot;, &quot;InsideSimpleSubProcess2&quot;); //includes subProcess</span>
<span class="nc" id="L1744">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L1745">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1746">                .containsOnly(procDefTwoTasks.getId());</span>

<span class="nc bnc" id="L1748" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L1749">            checkActivityInstances(procDefTwoTasks, processInstance, &quot;subProcess&quot;, &quot;SimpleSubProcess&quot;, &quot;SimpleSubProcess&quot;);</span>
<span class="nc" id="L1750">            checkActivityInstances(procDefTwoTasks, processInstance, &quot;userTask&quot;, &quot;BeforeSubProcess&quot;, &quot;InsideSimpleSubProcess2&quot;);</span>

<span class="nc" id="L1752">            checkTaskInstance(procDefTwoTasks, processInstance, &quot;BeforeSubProcess&quot;, &quot;InsideSimpleSubProcess2&quot;);</span>
        }

<span class="nc" id="L1755">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1757" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L1758">            checkActivityInstances(procDefTwoTasks, processInstance, &quot;subProcess&quot;, &quot;SimpleSubProcess&quot;, &quot;SimpleSubProcess&quot;);</span>
<span class="nc" id="L1759">            checkActivityInstances(procDefTwoTasks, processInstance, &quot;userTask&quot;, &quot;BeforeSubProcess&quot;, &quot;AfterSubProcess&quot;, &quot;InsideSimpleSubProcess2&quot;);</span>

<span class="nc" id="L1761">            checkTaskInstance(procDefTwoTasks, processInstance, &quot;BeforeSubProcess&quot;, &quot;AfterSubProcess&quot;, &quot;InsideSimpleSubProcess2&quot;);</span>
        }

<span class="nc" id="L1764">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1765">    }</span>

    @Test
    public void testSimpleMigrationWithinSimpleSubProcess2() {
<span class="nc" id="L1769">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-tasks-inside-subprocess.bpmn20.xml&quot;);
<span class="nc" id="L1771">        ProcessDefinition procDefTwoTasks = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-inside-subprocess.bpmn20.xml&quot;);

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L1775">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefTwoTasks.getId());</span>

        //Confirm and move inside the subProcess
<span class="nc" id="L1778">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1779">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L1780">        assertThat(executions)</span>
<span class="nc" id="L1781">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1782">                .containsOnly(procDefTwoTasks.getId());</span>

        //Move to the second task inside the SubProcess
<span class="nc" id="L1785">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1786">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;BeforeSubProcess&quot;);</span>
<span class="nc" id="L1787">        completeTask(task);</span>
<span class="nc" id="L1788">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1789">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;InsideSimpleSubProcess1&quot;);</span>
<span class="nc" id="L1790">        completeTask(task);</span>
<span class="nc" id="L1791">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1792">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;InsideSimpleSubProcess2&quot;);</span>

<span class="nc" id="L1794">        List&lt;Execution&gt; executionsBeforeMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L1795">                .list();</span>
<span class="nc" id="L1796">        assertThat(executionsBeforeMigration)</span>
<span class="nc" id="L1797">                .extracting(&quot;activityId&quot;)</span>
<span class="nc" id="L1798">                .containsExactlyInAnyOrder(&quot;SimpleSubProcess&quot;, &quot;InsideSimpleSubProcess2&quot;); // Includes subProcess</span>

        //Migrate to the other processDefinition
<span class="nc" id="L1801">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1802">                .migrateToProcessDefinition(procDefOneTask.getId())</span>
<span class="nc" id="L1803">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;InsideSimpleSubProcess2&quot;, &quot;InsideSimpleSubProcess1&quot;));</span>

<span class="nc" id="L1805">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L1806">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1808">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm and move inside the subProcess
<span class="nc" id="L1811">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L1812">                .list();</span>
<span class="nc" id="L1813">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L1814">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1815">                .containsExactlyInAnyOrder(&quot;SimpleSubProcess&quot;, &quot;InsideSimpleSubProcess1&quot;);  // Includes subProcess</span>
<span class="nc" id="L1816">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L1817">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1818">                .containsOnly(procDefOneTask.getId());</span>

<span class="nc bnc" id="L1820" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L1821">            checkActivityInstances(procDefOneTask, processInstance, &quot;subProcess&quot;, &quot;SimpleSubProcess&quot;, &quot;SimpleSubProcess&quot;);</span>
<span class="nc" id="L1822">            checkActivityInstances(procDefOneTask, processInstance, &quot;userTask&quot;, &quot;BeforeSubProcess&quot;,</span>
                    &quot;InsideSimpleSubProcess1&quot;,
                    &quot;InsideSimpleSubProcess1&quot;);

<span class="nc" id="L1826">            checkTaskInstance(procDefOneTask, processInstance, &quot;BeforeSubProcess&quot;,</span>
                    &quot;InsideSimpleSubProcess1&quot;,
                    &quot;InsideSimpleSubProcess1&quot;);
        }

<span class="nc" id="L1831">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1833" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L1834">            checkActivityInstances(procDefOneTask, processInstance, &quot;subProcess&quot;, &quot;SimpleSubProcess&quot;, &quot;SimpleSubProcess&quot;);</span>
<span class="nc" id="L1835">            checkActivityInstances(procDefOneTask, processInstance, &quot;userTask&quot;, &quot;BeforeSubProcess&quot;,</span>
                    &quot;InsideSimpleSubProcess1&quot;,
                    &quot;InsideSimpleSubProcess1&quot;,
                    &quot;AfterSubProcess&quot;);

<span class="nc" id="L1840">            checkTaskInstance(procDefOneTask, processInstance, &quot;BeforeSubProcess&quot;,</span>
                    &quot;InsideSimpleSubProcess1&quot;,
                    &quot;InsideSimpleSubProcess1&quot;,
                    &quot;AfterSubProcess&quot;);
        }

<span class="nc" id="L1846">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1847">    }</span>

    @Test
    public void testSimpleMigrationIntoEmbeddedSubProcess() {
<span class="nc" id="L1851">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-tasks-inside-subprocess.bpmn20.xml&quot;);
<span class="nc" id="L1853">        ProcessDefinition procDefTwoTasks = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-inside-subprocess.bpmn20.xml&quot;);

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L1857">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

<span class="nc" id="L1859">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1860">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L1861">        assertThat(executions)</span>
<span class="nc" id="L1862">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1863">                .containsOnly(procDefOneTask.getId());</span>

        //Confirm migration point before the subProcess
<span class="nc" id="L1866">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1867">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;BeforeSubProcess&quot;);</span>

        //Migrate to the other processDefinition
<span class="nc" id="L1870">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1871">                .migrateToProcessDefinition(procDefTwoTasks.getId())</span>
<span class="nc" id="L1872">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;BeforeSubProcess&quot;, &quot;InsideSimpleSubProcess2&quot;));</span>

<span class="nc" id="L1874">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L1875">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1877">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm and move inside the subProcess
<span class="nc" id="L1880">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L1881">                .list();</span>
<span class="nc" id="L1882">        assertThat(executionsAfterMigration).hasSize(2);</span>
<span class="nc" id="L1883">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L1884">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1885">                .containsExactlyInAnyOrder(&quot;SimpleSubProcess&quot;, &quot;InsideSimpleSubProcess2&quot;);   //includes subProcess</span>
<span class="nc" id="L1886">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L1887">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1888">                .containsOnly(procDefTwoTasks.getId());</span>

<span class="nc" id="L1890">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1892" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History - should contain one SubProcess and 2 userTask Activities since the migratedUser task moved forward inside the last task of the subProcess
<span class="nc" id="L1894">            HistoricActivityInstance subProcess = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L1895">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1896">                    .activityType(&quot;subProcess&quot;)</span>
<span class="nc" id="L1897">                    .singleResult();</span>
<span class="nc" id="L1898">            assertThat(subProcess).extracting(HistoricActivityInstance::getActivityId).isEqualTo(&quot;SimpleSubProcess&quot;);</span>
<span class="nc" id="L1899">            assertThat(subProcess).extracting(HistoricActivityInstance::getProcessDefinitionId).isEqualTo(procDefTwoTasks.getId());</span>

<span class="nc" id="L1901">            List&lt;HistoricActivityInstance&gt; userTasks = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L1902">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1903">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L1904">                    .list();</span>
<span class="nc" id="L1905">            assertThat(userTasks)</span>
<span class="nc" id="L1906">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L1907">                    .containsExactlyInAnyOrder(&quot;AfterSubProcess&quot;, &quot;InsideSimpleSubProcess2&quot;);</span>
<span class="nc" id="L1908">            assertThat(userTasks)</span>
<span class="nc" id="L1909">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L1910">                    .containsOnly(procDefTwoTasks.getId());</span>
        }

<span class="nc" id="L1913">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1914">    }</span>

    @Test
    public void testSimpleMigrationOutOfEmbeddedSubProcess() {
<span class="nc" id="L1918">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-tasks-inside-subprocess.bpmn20.xml&quot;);
<span class="nc" id="L1920">        ProcessDefinition procDefTwoTasks = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-inside-subprocess.bpmn20.xml&quot;);

        //Start an instance of the definition with two task inside the subProcess
<span class="nc" id="L1924">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefTwoTasks.getId());</span>

        //Confirm and move inside the subProcess
<span class="nc" id="L1927">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1928">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L1929">        assertThat(executions)</span>
<span class="nc" id="L1930">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1931">                .containsOnly(procDefTwoTasks.getId());</span>

<span class="nc" id="L1933">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1934">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;BeforeSubProcess&quot;);</span>
<span class="nc" id="L1935">        completeTask(task);</span>
<span class="nc" id="L1936">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1937">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;InsideSimpleSubProcess1&quot;);</span>
<span class="nc" id="L1938">        completeTask(task);</span>
<span class="nc" id="L1939">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1940">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;InsideSimpleSubProcess2&quot;);</span>

        //Migrate to the other processDefinition
<span class="nc" id="L1943">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1944">                .migrateToProcessDefinition(procDefOneTask.getId())</span>
<span class="nc" id="L1945">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;InsideSimpleSubProcess2&quot;, &quot;BeforeSubProcess&quot;));</span>

<span class="nc" id="L1947">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L1948">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1950">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm and move inside the subProcess
<span class="nc" id="L1953">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L1954">                .list();</span>
<span class="nc" id="L1955">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L1956">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1957">                .containsExactly(&quot;BeforeSubProcess&quot;); //No subProcess</span>
<span class="nc" id="L1958">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L1959">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1960">                .containsOnly(procDefOneTask.getId());</span>

<span class="nc bnc" id="L1962" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L1963">            checkActivityInstances(procDefOneTask, processInstance, &quot;subProcess&quot;, &quot;SimpleSubProcess&quot;);</span>
<span class="nc" id="L1964">            checkActivityInstances(procDefOneTask, processInstance, &quot;userTask&quot;, &quot;BeforeSubProcess&quot;,</span>
                    &quot;InsideSimpleSubProcess1&quot;,
                    &quot;BeforeSubProcess&quot;);

<span class="nc" id="L1968">            checkTaskInstance(procDefOneTask, processInstance, &quot;BeforeSubProcess&quot;,</span>
                    &quot;InsideSimpleSubProcess1&quot;,
                    &quot;BeforeSubProcess&quot;);
        }

<span class="nc" id="L1973">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1975" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L1976">            checkActivityInstances(procDefOneTask, processInstance, &quot;subProcess&quot;, &quot;SimpleSubProcess&quot;, &quot;SimpleSubProcess&quot;);</span>
<span class="nc" id="L1977">            checkActivityInstances(procDefOneTask, processInstance, &quot;userTask&quot;, &quot;BeforeSubProcess&quot;,</span>
                    &quot;InsideSimpleSubProcess1&quot;,
                    &quot;BeforeSubProcess&quot;,
                    &quot;InsideSimpleSubProcess1&quot;,
                    &quot;AfterSubProcess&quot;);

<span class="nc" id="L1983">            checkTaskInstance(procDefOneTask, processInstance, &quot;BeforeSubProcess&quot;,</span>
                    &quot;InsideSimpleSubProcess1&quot;,
                    &quot;BeforeSubProcess&quot;,
                    &quot;InsideSimpleSubProcess1&quot;,
                    &quot;AfterSubProcess&quot;);
        }

<span class="nc" id="L1990">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1991">    }</span>
    
    @Test
    public void testSimpleMigrationWithMultiInstanceTask() {
<span class="nc" id="L1995">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/parallel-multi-instance-task.bpmn20.xml&quot;);
<span class="nc" id="L1997">        ProcessDefinition procDefTwoTasks = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/parallel-multi-instance-task-v2.bpmn20.xml&quot;);

        // Start an instance of a process with one task inside a subProcess
<span class="nc" id="L2001">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId(), Collections.singletonMap(&quot;nrOfLoops&quot;, 2));</span>

        // Confirm and move inside the subProcess
<span class="nc" id="L2004">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2005">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L2006">        assertThat(executions)</span>
<span class="nc" id="L2007">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2008">                .containsOnly(procDefOneTask.getId());</span>

        // Should be only one task
<span class="nc" id="L2011">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2012">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;beforeMultiInstance&quot;);</span>
<span class="nc" id="L2013">        completeTask(task);</span>
<span class="nc" id="L2014">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).list()).hasSize(2);</span>
        
<span class="nc" id="L2016">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2017">        assertThat(executions)</span>
<span class="nc" id="L2018">        		.hasSize(3)</span>
<span class="nc" id="L2019">        		.extracting(Execution::getActivityId)</span>
<span class="nc" id="L2020">        		.contains(&quot;parallelTasks&quot;);</span>
        
        // Migrate to the other processDefinition
<span class="nc" id="L2023">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2024">                .migrateToProcessDefinition(procDefTwoTasks.getId());</span>

<span class="nc" id="L2026">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L2027">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2029">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        // Confirm and move inside the subProcess
<span class="nc" id="L2032">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L2033">                .list();</span>
<span class="nc" id="L2034">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2035">        		.hasSize(3)</span>
<span class="nc" id="L2036">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2037">                .contains(&quot;parallelTasks&quot;);</span>
<span class="nc" id="L2038">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2039">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2040">                .containsOnly(procDefTwoTasks.getId());</span>
<span class="nc" id="L2041">        List&lt;Task&gt; tasksAfterMigration = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2042">        assertThat(tasksAfterMigration)</span>
<span class="nc" id="L2043">			.hasSize(2)</span>
<span class="nc" id="L2044">	        .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2045">	        .contains(&quot;parallelTasks&quot;);</span>

<span class="nc bnc" id="L2047" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2048">            checkActivityInstances(procDefTwoTasks, processInstance, &quot;userTask&quot;, &quot;beforeMultiInstance&quot;, &quot;parallelTasks&quot;, &quot;parallelTasks&quot;);</span>

<span class="nc" id="L2050">            checkTaskInstance(procDefTwoTasks, processInstance, &quot;beforeMultiInstance&quot;, &quot;parallelTasks&quot;, &quot;parallelTasks&quot;, &quot;parallelTasks&quot;, &quot;parallelTasks&quot;);</span>
        }

<span class="nc" id="L2053">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2055" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2056">            checkActivityInstances(procDefTwoTasks, processInstance, &quot;userTask&quot;, &quot;beforeMultiInstance&quot;, &quot;parallelTasks&quot;, &quot;parallelTasks&quot;);</span>

<span class="nc" id="L2058">            checkTaskInstance(procDefTwoTasks, processInstance, &quot;beforeMultiInstance&quot;, &quot;parallelTasks&quot;, &quot;parallelTasks&quot;, &quot;parallelTasks&quot;, &quot;parallelTasks&quot;);</span>
        }

<span class="nc" id="L2061">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2062">    }</span>
    
    @Test
    public void testSimpleMigrationWithMultiInstanceSubProcess() {
<span class="nc" id="L2066">        ProcessDefinition procDefOne = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/parallel-multi-instance-subprocess.bpmn20.xml&quot;);
<span class="nc" id="L2068">        ProcessDefinition procDefTwo = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/parallel-multi-instance-subprocess-v2.bpmn20.xml&quot;);

        // Start an instance of a process with one task inside a subProcess
<span class="nc" id="L2072">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOne.getId(), Collections.singletonMap(&quot;nrOfLoops&quot;, 2));</span>

        // Confirm and move inside the subProcess
<span class="nc" id="L2075">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2076">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L2077">        assertThat(executions)</span>
<span class="nc" id="L2078">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2079">                .containsOnly(procDefOne.getId());</span>

        // Should be only one task
<span class="nc" id="L2082">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2083">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;beforeMultiInstance&quot;);</span>
<span class="nc" id="L2084">        completeTask(task);</span>
<span class="nc" id="L2085">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2086">        assertThat(tasks).hasSize(2);</span>
<span class="nc" id="L2087">        completeTask(tasks.get(0));</span>
        
<span class="nc" id="L2089">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2090">        assertThat(tasks)</span>
<span class="nc" id="L2091">			.hasSize(2)</span>
<span class="nc" id="L2092">	        .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2093">	        .contains(&quot;subTask1&quot;, &quot;subTask2&quot;);</span>
        
<span class="nc" id="L2095">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L2096">                .list();</span>
<span class="nc" id="L2097">        assertThat(executions)</span>
<span class="nc" id="L2098">        		.hasSize(5)</span>
<span class="nc" id="L2099">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2100">                .containsOnly(&quot;parallelMISubProcess&quot;, &quot;subTask1&quot;, &quot;subTask2&quot;);</span>
        
<span class="nc bnc" id="L2102" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2103">            checkActivityInstances(procDefOne, processInstance, &quot;userTask&quot;, &quot;beforeMultiInstance&quot;, &quot;subTask1&quot;, &quot;subTask1&quot;, &quot;subTask2&quot;);</span>
            
<span class="nc" id="L2105">            checkTaskInstance(procDefOne, processInstance, &quot;beforeMultiInstance&quot;, &quot;subTask1&quot;, &quot;subTask1&quot;, &quot;subTask2&quot;);</span>
        }
        
        // Migrate to the other processDefinition
<span class="nc" id="L2109">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2110">                .migrateToProcessDefinition(procDefTwo.getId());</span>

<span class="nc" id="L2112">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L2113">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2115">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        // Confirm and move inside the subProcess
<span class="nc" id="L2118">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L2119">                .list();</span>
<span class="nc" id="L2120">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2121">        		.hasSize(5)</span>
<span class="nc" id="L2122">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2123">                .containsOnly(&quot;parallelMISubProcess&quot;, &quot;subTask1&quot;, &quot;subTask2&quot;);</span>
<span class="nc" id="L2124">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2125">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2126">                .containsOnly(procDefTwo.getId());</span>
<span class="nc" id="L2127">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).list()).hasSize(2);</span>
<span class="nc" id="L2128">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;subTask1&quot;).list()).hasSize(1);</span>
<span class="nc" id="L2129">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;subTask2&quot;).list()).hasSize(1);</span>

<span class="nc bnc" id="L2131" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2132">            checkActivityInstances(procDefTwo, processInstance, &quot;userTask&quot;, &quot;beforeMultiInstance&quot;, &quot;subTask1&quot;, &quot;subTask1&quot;, &quot;subTask2&quot;, &quot;subTask1&quot;, &quot;subTask2&quot;);</span>

<span class="nc" id="L2134">            checkTaskInstance(procDefTwo, processInstance, &quot;beforeMultiInstance&quot;, &quot;subTask1&quot;, &quot;subTask1&quot;, &quot;subTask2&quot;, &quot;subTask1&quot;, &quot;subTask2&quot;);</span>
        }

<span class="nc" id="L2137">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2139" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2140">            checkActivityInstances(procDefTwo, processInstance, &quot;userTask&quot;, &quot;beforeMultiInstance&quot;, &quot;subTask1&quot;, &quot;subTask1&quot;, &quot;subTask2&quot;, &quot;subTask1&quot;, &quot;subTask2&quot;, &quot;subTask2&quot;);</span>

<span class="nc" id="L2142">            checkTaskInstance(procDefTwo, processInstance, &quot;beforeMultiInstance&quot;, &quot;subTask1&quot;, &quot;subTask1&quot;, &quot;subTask2&quot;, &quot;subTask1&quot;, &quot;subTask2&quot;, &quot;subTask2&quot;);</span>
        }

<span class="nc" id="L2145">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2146">    }</span>
    
    @Test
    public void testReceiveTaskToUserTaskMigration() {
<span class="nc" id="L2150">        deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/runtime/migration/receive-task-process.bpmn20.xml&quot;);</span>

        // Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L2153">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>

        // Deploy second version of the process
<span class="nc" id="L2156">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;);

<span class="nc" id="L2159">        List&lt;ProcessDefinition&gt; processDefinitions = repositoryService.createProcessDefinitionQuery()</span>
<span class="nc" id="L2160">                .processDefinitionKey(&quot;MP&quot;)</span>
<span class="nc" id="L2161">                .list();</span>

<span class="nc" id="L2163">        assertThat(processDefinitions).hasSize(2);</span>

        // Migrate process
<span class="nc" id="L2166">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2167">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;receiveTask&quot;, &quot;userTask1Id&quot;).withNewAssignee(&quot;johndoe&quot;))</span>
<span class="nc" id="L2168">                .migrateToProcessDefinition(version2ProcessDef.getId());</span>

<span class="nc" id="L2170">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L2171">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2173">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L2175">        List&lt;Execution&gt; executionsAfter = runtimeService.createExecutionQuery().list();</span>
<span class="nc" id="L2176">        assertThat(executionsAfter).hasSize(2); //includes root execution</span>
<span class="nc bnc" id="L2177" title="All 2 branches missed.">        for (Execution execution : executionsAfter) {</span>
<span class="nc" id="L2178">            assertThat(((ExecutionEntity) execution).getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L2179">        }</span>

<span class="nc" id="L2181">        List&lt;Task&gt; tasksAfter = taskService.createTaskQuery().list();</span>
<span class="nc" id="L2182">        assertThat(tasksAfter).hasSize(1);</span>
<span class="nc" id="L2183">        Task taskAfter = tasksAfter.get(0);</span>
<span class="nc" id="L2184">        assertThat(taskAfter.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L2185">        assertThat(taskAfter.getTaskDefinitionKey()).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L2186">        assertThat(taskAfter.getAssignee()).isEqualTo(&quot;johndoe&quot;);</span>

<span class="nc bnc" id="L2188" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L2189">            List&lt;HistoricTaskInstance&gt; historicTaskInstancesAfter = historyService.createHistoricTaskInstanceQuery().list();</span>
<span class="nc" id="L2190">            assertThat(historicTaskInstancesAfter).hasSize(1);</span>
<span class="nc" id="L2191">            HistoricTaskInstance historicTaskAfter = historicTaskInstancesAfter.get(0);</span>
<span class="nc" id="L2192">            assertThat(historicTaskAfter.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L2193">            assertThat(historicTaskAfter.getTaskDefinitionKey()).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L2194">            assertThat(historicTaskAfter.getAssignee()).isEqualTo(&quot;johndoe&quot;);</span>
        }

        //The first process version only had one activity, there should be a second activity in the process now
<span class="nc" id="L2198">        taskService.complete(tasksAfter.get(0).getId());</span>
<span class="nc" id="L2199">        tasksAfter = taskService.createTaskQuery().list();</span>
<span class="nc" id="L2200">        assertThat(tasksAfter)</span>
<span class="nc" id="L2201">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2202">                .containsExactly(&quot;userTask2Id&quot;);</span>

<span class="nc" id="L2204">        taskService.complete(tasksAfter.get(0).getId());</span>
<span class="nc" id="L2205">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2206">    }</span>

    @Test
    public void testMigrateActivityFromProcessRootIntoNestedEmbeddedSubProcess() {
<span class="nc" id="L2210">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-tasks-inside-subprocess.bpmn20.xml&quot;);
<span class="nc" id="L2212">        ProcessDefinition procDefNested = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-tasks-nested-subprocess.bpmn20.xml&quot;);

        //Start an instance of the definition with two task inside the subProcess
<span class="nc" id="L2216">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm
<span class="nc" id="L2219">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2220">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L2221">        assertThat(executions)</span>
<span class="nc" id="L2222">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2223">                .containsOnly(procDefOneTask.getId());</span>

<span class="nc" id="L2225">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2226">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;BeforeSubProcess&quot;);</span>

        //Migrate to the other processDefinition
<span class="nc" id="L2229">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2230">                .migrateToProcessDefinition(procDefNested.getId())</span>
<span class="nc" id="L2231">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;BeforeSubProcess&quot;, &quot;InsideNestedSubProcess&quot;));</span>

<span class="nc" id="L2233">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L2234">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2236">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L2239">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L2240">                .list();</span>
<span class="nc" id="L2241">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2242">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2243">                .containsExactlyInAnyOrder(&quot;OuterSubProcess&quot;, &quot;SimpleSubProcess&quot;, &quot;InsideNestedSubProcess&quot;);</span>
<span class="nc" id="L2244">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2245">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2246">                .containsOnly(procDefNested.getId());</span>

<span class="nc bnc" id="L2248" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2249">            checkActivityInstances(procDefNested, processInstance, &quot;subProcess&quot;, &quot;OuterSubProcess&quot;, &quot;SimpleSubProcess&quot;);</span>
<span class="nc" id="L2250">            checkActivityInstances(procDefNested, processInstance, &quot;userTask&quot;, &quot;InsideNestedSubProcess&quot;);</span>

<span class="nc" id="L2252">            checkTaskInstance(procDefNested, processInstance, &quot;InsideNestedSubProcess&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L2256">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2258" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2259">            checkActivityInstances(procDefNested, processInstance, &quot;subProcess&quot;, &quot;OuterSubProcess&quot;, &quot;SimpleSubProcess&quot;);</span>
<span class="nc" id="L2260">            checkActivityInstances(procDefNested, processInstance, &quot;userTask&quot;, &quot;InsideNestedSubProcess&quot;, &quot;AfterSubProcess&quot;);</span>

<span class="nc" id="L2262">            checkTaskInstance(procDefNested, processInstance, &quot;InsideNestedSubProcess&quot;, &quot;AfterSubProcess&quot;);</span>
        }

<span class="nc" id="L2265">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2266">    }</span>

    @Test
    public void testMigrateActivityFromProcessRootIntoNestedEmbeddedSubProcessWithDataObject() {
<span class="nc" id="L2270">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-tasks-inside-subprocess-with-data-object.bpmn20.xml&quot;);
<span class="nc" id="L2272">        ProcessDefinition procDefNested = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-tasks-nested-subprocess-with-data-object.bpmn20.xml&quot;);

        //Start an instance of the definition with two task inside the subProcess
<span class="nc" id="L2276">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm
<span class="nc" id="L2279">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2280">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L2281">        assertThat(executions)</span>
<span class="nc" id="L2282">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2283">                .containsOnly(procDefOneTask.getId());</span>

<span class="nc" id="L2285">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2286">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;BeforeSubProcess&quot;);</span>

        //Migrate to the other processDefinition
<span class="nc" id="L2289">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2290">                .migrateToProcessDefinition(procDefNested.getId())</span>
<span class="nc" id="L2291">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;BeforeSubProcess&quot;, &quot;InsideNestedSubProcess&quot;));</span>

<span class="nc" id="L2293">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L2294">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2296">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L2299">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L2300">                .list();</span>
<span class="nc" id="L2301">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2302">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2303">                .containsExactlyInAnyOrder(&quot;OuterSubProcess&quot;, &quot;SimpleSubProcess&quot;, &quot;InsideNestedSubProcess&quot;);</span>
<span class="nc" id="L2304">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2305">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2306">                .containsOnly(procDefNested.getId());</span>

        //Should contain the dataObject of the new embedded process definition
<span class="nc" id="L2309">        Execution nestedSubProcess = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).activityId(&quot;SimpleSubProcess&quot;)</span>
<span class="nc" id="L2310">                .singleResult();</span>
<span class="nc" id="L2311">        assertThat(runtimeService.getVariableLocal(nestedSubProcess.getId(), &quot;dataScopeNested&quot;, String.class)).isNotNull();</span>
<span class="nc" id="L2312">        DataObject nameDataObject = runtimeService.getDataObjectLocal(nestedSubProcess.getId(), &quot;dataScopeNested&quot;);</span>
<span class="nc" id="L2313">        assertThat(nameDataObject).isNotNull();</span>
<span class="nc" id="L2314">        assertThat(nameDataObject.getValue()).isEqualTo(&quot;nestedSubProcess&quot;);</span>

<span class="nc bnc" id="L2316" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2317">            checkActivityInstances(procDefNested, processInstance, &quot;subProcess&quot;, &quot;OuterSubProcess&quot;, &quot;SimpleSubProcess&quot;);</span>
<span class="nc" id="L2318">            checkActivityInstances(procDefNested, processInstance, &quot;userTask&quot;, &quot;InsideNestedSubProcess&quot;);</span>

<span class="nc" id="L2320">            checkTaskInstance(procDefNested, processInstance, &quot;InsideNestedSubProcess&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L2324">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2326" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2327">            checkActivityInstances(procDefNested, processInstance, &quot;subProcess&quot;, &quot;OuterSubProcess&quot;, &quot;SimpleSubProcess&quot;);</span>
<span class="nc" id="L2328">            checkActivityInstances(procDefNested, processInstance, &quot;userTask&quot;, &quot;InsideNestedSubProcess&quot;, &quot;AfterSubProcess&quot;);</span>

<span class="nc" id="L2330">            checkTaskInstance(procDefNested, processInstance, &quot;InsideNestedSubProcess&quot;, &quot;AfterSubProcess&quot;);</span>
        }

<span class="nc" id="L2333">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2334">    }</span>

    @Test
    public void testMigrateActivityFromEmbeddedSubProcessIntoNestedEmbeddedSubProcess() {
<span class="nc" id="L2338">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-tasks-inside-subprocess.bpmn20.xml&quot;);
<span class="nc" id="L2340">        ProcessDefinition procDefNested = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-tasks-nested-subprocess.bpmn20.xml&quot;);

        //Start an instance of the definition with two task inside the subProcess
<span class="nc" id="L2344">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm and move inside the subProcess
<span class="nc" id="L2347">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2348">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L2349">        assertThat(executions)</span>
<span class="nc" id="L2350">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2351">                .containsOnly(procDefOneTask.getId());</span>

<span class="nc" id="L2353">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2354">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;BeforeSubProcess&quot;);</span>
<span class="nc" id="L2355">        taskService.complete(task.getId());</span>

<span class="nc" id="L2357">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2358">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;InsideSimpleSubProcess1&quot;);</span>

        //Migrate to the other processDefinition
<span class="nc" id="L2361">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2362">                .migrateToProcessDefinition(procDefNested.getId())</span>
<span class="nc" id="L2363">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;InsideSimpleSubProcess1&quot;, &quot;InsideNestedSubProcess&quot;));</span>

<span class="nc" id="L2365">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L2366">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2368">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm - we move from a subProcess to a nestedSubProcess with the same name (SimpleSubProcess), the original is not created, but cancelled and created from the new model
<span class="nc" id="L2371">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L2372">                .list();</span>
<span class="nc" id="L2373">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2374">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2375">                .containsExactlyInAnyOrder(&quot;OuterSubProcess&quot;, &quot;SimpleSubProcess&quot;, &quot;InsideNestedSubProcess&quot;); //2 subProcesses and 1 userTask</span>
<span class="nc" id="L2376">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2377">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2378">                .containsOnly(procDefNested.getId());</span>

<span class="nc bnc" id="L2380" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2381">            checkActivityInstances(procDefNested, processInstance, &quot;subProcess&quot;, &quot;SimpleSubProcess&quot;, &quot;OuterSubProcess&quot;, &quot;SimpleSubProcess&quot;);</span>
<span class="nc" id="L2382">            checkActivityInstances(procDefNested, processInstance, &quot;userTask&quot;, &quot;BeforeSubProcess&quot;, &quot;InsideNestedSubProcess&quot;);</span>

<span class="nc" id="L2384">            checkTaskInstance(procDefNested, processInstance, &quot;BeforeSubProcess&quot;, &quot;InsideNestedSubProcess&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L2388">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2390" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2391">            checkActivityInstances(procDefNested, processInstance, &quot;subProcess&quot;, &quot;SimpleSubProcess&quot;, &quot;OuterSubProcess&quot;, &quot;SimpleSubProcess&quot;);</span>
<span class="nc" id="L2392">            checkActivityInstances(procDefNested, processInstance, &quot;userTask&quot;, &quot;BeforeSubProcess&quot;, &quot;InsideNestedSubProcess&quot;, &quot;AfterSubProcess&quot;);</span>

<span class="nc" id="L2394">            checkTaskInstance(procDefNested, processInstance, &quot;BeforeSubProcess&quot;, &quot;InsideNestedSubProcess&quot;, &quot;AfterSubProcess&quot;);</span>
        }

<span class="nc" id="L2397">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2398">    }</span>

    @Test
    public void testMigrateActivityFromEmbeddedSubProcessIntoNestedEmbeddedSubProcessWithDataObject() {
<span class="nc" id="L2402">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-tasks-inside-subprocess-with-data-object.bpmn20.xml&quot;);
<span class="nc" id="L2404">        ProcessDefinition procDefNested = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-tasks-nested-subprocess-with-data-object.bpmn20.xml&quot;);

        //Start an instance of the definition with two task inside the subProcess
<span class="nc" id="L2408">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm and move inside the subProcess
<span class="nc" id="L2411">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2412">        assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L2413">        assertThat(executions)</span>
<span class="nc" id="L2414">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2415">                .containsOnly(procDefOneTask.getId());</span>

<span class="nc" id="L2417">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2418">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;BeforeSubProcess&quot;);</span>
<span class="nc" id="L2419">        taskService.complete(task.getId());</span>

<span class="nc" id="L2421">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2422">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;InsideSimpleSubProcess1&quot;);</span>

<span class="nc" id="L2424">        Execution subProcessExecution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).activityId(&quot;SimpleSubProcess&quot;)</span>
<span class="nc" id="L2425">                .singleResult();</span>
<span class="nc" id="L2426">        assertThat(runtimeService.getVariableLocal(subProcessExecution.getId(), &quot;dataScope&quot;, String.class)).isNotNull();</span>
<span class="nc" id="L2427">        DataObject nameDataObject = runtimeService.getDataObjectLocal(subProcessExecution.getId(), &quot;dataScope&quot;);</span>
<span class="nc" id="L2428">        assertThat(nameDataObject).isNotNull();</span>
<span class="nc" id="L2429">        assertThat(nameDataObject.getValue()).isEqualTo(&quot;subProcess&quot;);</span>

        //Migrate to the other processDefinition
<span class="nc" id="L2432">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2433">                .migrateToProcessDefinition(procDefNested.getId())</span>
<span class="nc" id="L2434">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;InsideSimpleSubProcess1&quot;, &quot;InsideNestedSubProcess&quot;));</span>

<span class="nc" id="L2436">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L2437">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2439">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm - we move from a subProcess to a nestedSubProcess with the same name (SimpleSubProcess), the original is not created, but cancelled and created from the new model
<span class="nc" id="L2442">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L2443">                .list();</span>
<span class="nc" id="L2444">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2445">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2446">                .containsExactlyInAnyOrder(&quot;OuterSubProcess&quot;, &quot;SimpleSubProcess&quot;, &quot;InsideNestedSubProcess&quot;); //2 subProcesses and 1 userTask</span>
<span class="nc" id="L2447">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2448">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2449">                .containsOnly(procDefNested.getId());</span>

        //Confirm we have the dataObject of the subProcess in the new definition (its a new SubProcess execution nonetheless)
<span class="nc" id="L2452">        subProcessExecution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).activityId(&quot;SimpleSubProcess&quot;).singleResult();</span>
<span class="nc" id="L2453">        assertThat(runtimeService.getVariablesLocal(subProcessExecution.getId())).containsOnlyKeys(&quot;dataScopeNested&quot;);</span>
<span class="nc" id="L2454">        assertThat(runtimeService.getDataObjectsLocal(subProcessExecution.getId())).containsOnlyKeys(&quot;dataScopeNested&quot;);</span>
<span class="nc" id="L2455">        nameDataObject = runtimeService.getDataObjectLocal(subProcessExecution.getId(), &quot;dataScopeNested&quot;);</span>
<span class="nc" id="L2456">        assertThat(nameDataObject).isNotNull();</span>
<span class="nc" id="L2457">        assertThat(nameDataObject.getValue()).isEqualTo(&quot;nestedSubProcess&quot;);</span>

<span class="nc bnc" id="L2459" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2460">            checkActivityInstances(procDefNested, processInstance, &quot;subProcess&quot;, &quot;SimpleSubProcess&quot;, &quot;OuterSubProcess&quot;, &quot;SimpleSubProcess&quot;);</span>
<span class="nc" id="L2461">            checkActivityInstances(procDefNested, processInstance, &quot;userTask&quot;, &quot;BeforeSubProcess&quot;, &quot;InsideNestedSubProcess&quot;);</span>

<span class="nc" id="L2463">            checkTaskInstance(procDefNested, processInstance, &quot;BeforeSubProcess&quot;, &quot;InsideNestedSubProcess&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L2467">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2469" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2470">            checkActivityInstances(procDefNested, processInstance, &quot;subProcess&quot;, &quot;SimpleSubProcess&quot;, &quot;OuterSubProcess&quot;, &quot;SimpleSubProcess&quot;);</span>
<span class="nc" id="L2471">            checkActivityInstances(procDefNested, processInstance, &quot;userTask&quot;, &quot;BeforeSubProcess&quot;, &quot;InsideNestedSubProcess&quot;, &quot;AfterSubProcess&quot;);</span>

<span class="nc" id="L2473">            checkTaskInstance(procDefNested, processInstance, &quot;BeforeSubProcess&quot;, &quot;InsideNestedSubProcess&quot;, &quot;AfterSubProcess&quot;);</span>
        }

<span class="nc" id="L2476">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2477">    }</span>

    //-- Timers
    @Test
    public void testMigrateActivityToActivityWithTimerInNewDefinition() {
<span class="nc" id="L2482">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L2484">        ProcessDefinition procDefOWithTimer = deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/twoTasksProcessWithTimer.bpmn20.xml&quot;);</span>

        //Start the processInstance without timer
<span class="nc" id="L2487">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L2490">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2491">        assertThat(executions)</span>
<span class="nc" id="L2492">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2493">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L2494">        assertThat(executions)</span>
<span class="nc" id="L2495">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2496">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2497">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2498">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>

<span class="nc" id="L2500">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2501">        assertThat(timerJob).isNull();</span>

<span class="nc" id="L2503">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L2506">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2507">                .migrateToProcessDefinition(procDefOWithTimer.getId())</span>
<span class="nc" id="L2508">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;firstTask&quot;));</span>

<span class="nc" id="L2510">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L2511">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2513">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L2516">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L2517">                .list();</span>
<span class="nc" id="L2518">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2519">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2520">                .containsExactlyInAnyOrder(&quot;firstTask&quot;, &quot;boundaryTimerEvent&quot;);</span>
<span class="nc" id="L2521">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2522">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2523">                .containsOnly(procDefOWithTimer.getId());</span>

<span class="nc" id="L2525">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2526">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;firstTask&quot;);</span>
<span class="nc" id="L2527">        timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2528">        assertThat(timerJob).isNotNull();</span>
<span class="nc" id="L2529">        Execution execution = runtimeService.createExecutionQuery().parentId(task.getExecutionId()).singleResult();</span>
<span class="nc" id="L2530">        Job job = managementService.createTimerJobQuery().executionId(execution.getId()).singleResult();</span>
<span class="nc" id="L2531">        assertThat(job)</span>
<span class="nc" id="L2532">                .usingRecursiveComparison()</span>
<span class="nc" id="L2533">                .ignoringFields(&quot;originalPersistentState&quot;, &quot;customValuesByteArrayRef&quot;, &quot;exceptionByteArrayRef&quot;)</span>
<span class="nc" id="L2534">                .isEqualTo(timerJob);</span>

        // Verify events
<span class="nc" id="L2537">        assertThat(changeStateEventListener.hasEvents()).isTrue();</span>
<span class="nc" id="L2538">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L2539">                .extracting(FlowableEvent::getType)</span>
<span class="nc" id="L2540">                .containsExactly(FlowableEngineEventType.TIMER_SCHEDULED);</span>
<span class="nc" id="L2541">        Optional&lt;FlowableEvent&gt; timerEvent = changeStateEventListener.getEvents().stream()</span>
<span class="nc" id="L2542">                .filter(event -&gt; event.getType().equals(FlowableEngineEventType.TIMER_SCHEDULED)).findFirst();</span>
<span class="nc" id="L2543">        assertThat(timerEvent).isPresent();</span>
<span class="nc" id="L2544">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) timerEvent.get();</span>
<span class="nc" id="L2545">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L2546">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc bnc" id="L2548" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2549">            checkActivityInstances(procDefOWithTimer, processInstance, &quot;userTask&quot;, &quot;firstTask&quot;);</span>

<span class="nc" id="L2551">            checkTaskInstance(procDefOWithTimer, processInstance, &quot;firstTask&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L2555">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2557" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2559">            List&lt;HistoricActivityInstance&gt; taskExecutions = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L2560">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2561">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L2562">                    .list();</span>
<span class="nc" id="L2563">            assertThat(taskExecutions)</span>
<span class="nc" id="L2564">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L2565">                    .containsExactlyInAnyOrder(&quot;firstTask&quot;, &quot;secondTask&quot;);</span>
<span class="nc" id="L2566">            assertThat(taskExecutions)</span>
<span class="nc" id="L2567">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L2568">                    .containsOnly(procDefOWithTimer.getId());</span>

<span class="nc" id="L2570">            checkTaskInstance(procDefOWithTimer, processInstance, &quot;firstTask&quot;, &quot;secondTask&quot;);</span>
        }

<span class="nc" id="L2573">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2574">    }</span>

    @Test
    public void testMigrateActivityWithTimerToActivityWithoutTimerInNewDefinition() {
<span class="nc" id="L2578">        ProcessDefinition procDefOWithTimer = deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/twoTasksProcessWithTimer.bpmn20.xml&quot;);</span>
<span class="nc" id="L2579">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);

        //Start the processInstance with timer
<span class="nc" id="L2583">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOWithTimer.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L2586">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2587">        assertThat(executions)</span>
<span class="nc" id="L2588">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2589">                .containsExactlyInAnyOrder(&quot;firstTask&quot;, &quot;boundaryTimerEvent&quot;);</span>
<span class="nc" id="L2590">        assertThat(executions)</span>
<span class="nc" id="L2591">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2592">                .containsOnly(procDefOWithTimer.getId());</span>
<span class="nc" id="L2593">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2594">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;firstTask&quot;);</span>

<span class="nc" id="L2596">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2597">        assertThat(timerJob).isNotNull();</span>
<span class="nc" id="L2598">        Execution execution = runtimeService.createExecutionQuery().parentId(task.getExecutionId()).singleResult();</span>
<span class="nc" id="L2599">        Job job = managementService.createTimerJobQuery().executionId(execution.getId()).singleResult();</span>
<span class="nc" id="L2600">        assertThat(job)</span>
<span class="nc" id="L2601">                .usingRecursiveComparison()</span>
<span class="nc" id="L2602">                .ignoringFields(&quot;originalPersistentState&quot;, &quot;customValuesByteArrayRef&quot;, &quot;exceptionByteArrayRef&quot;)</span>
<span class="nc" id="L2603">                .isEqualTo(timerJob);</span>

<span class="nc" id="L2605">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L2608">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2609">                .migrateToProcessDefinition(procDefOneTask.getId())</span>
<span class="nc" id="L2610">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;firstTask&quot;, &quot;userTask1Id&quot;));</span>

<span class="nc" id="L2612">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L2613">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2615">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L2618">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L2619">                .list();</span>
<span class="nc" id="L2620">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2621">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2622">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L2623">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2624">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2625">                .containsOnly(procDefOneTask.getId());</span>

<span class="nc bnc" id="L2627" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2628">            checkActivityInstances(procDefOneTask, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;);</span>

<span class="nc" id="L2630">            checkTaskInstance(procDefOneTask, processInstance, &quot;userTask1Id&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L2634">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2636" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2637">            checkActivityInstances(procDefOneTask, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;);</span>

<span class="nc" id="L2639">            checkTaskInstance(procDefOneTask, processInstance, &quot;userTask1Id&quot;);</span>
        }

        // Verify JOB cancellation event
<span class="nc" id="L2643">        assertThat(changeStateEventListener.hasEvents()).isTrue();</span>
<span class="nc" id="L2644">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L2645">                .extracting(FlowableEvent::getType)</span>
<span class="nc" id="L2646">                .containsExactly(FlowableEngineEventType.JOB_CANCELED);</span>
<span class="nc" id="L2647">        Optional&lt;FlowableEvent&gt; jobCancelEvent = changeStateEventListener.getEvents().stream()</span>
<span class="nc" id="L2648">                .filter(event -&gt; event.getType().equals(FlowableEngineEventType.JOB_CANCELED)).findFirst();</span>
<span class="nc" id="L2649">        assertThat(jobCancelEvent).isPresent();</span>
<span class="nc" id="L2650">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) jobCancelEvent.get();</span>
<span class="nc" id="L2651">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L2652">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc" id="L2654">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2655">    }</span>

    @Test
    public void testMigrateActivityWithTimerToActivityWithTimerInNewDefinition() {
<span class="nc" id="L2659">        ProcessDefinition procDefOneTimer = deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/twoTasksProcessWithTimer.bpmn20.xml&quot;);</span>
<span class="nc" id="L2660">        ProcessDefinition procDefTwoTimers = deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/twoTasksProcessWithTimers.bpmn20.xml&quot;);</span>

        //Start the processInstance without timer
<span class="nc" id="L2663">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTimer.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L2666">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2667">        assertThat(executions)</span>
<span class="nc" id="L2668">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2669">                .containsExactlyInAnyOrder(&quot;firstTask&quot;, &quot;boundaryTimerEvent&quot;);</span>
<span class="nc" id="L2670">        assertThat(executions)</span>
<span class="nc" id="L2671">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2672">                .containsOnly(procDefOneTimer.getId());</span>
<span class="nc" id="L2673">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2674">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;firstTask&quot;);</span>
<span class="nc" id="L2675">        Job timerJob1 = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2676">        assertThat(timerJob1).isNotNull();</span>

<span class="nc" id="L2678">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L2681">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2682">                .migrateToProcessDefinition(procDefTwoTimers.getId())</span>
<span class="nc" id="L2683">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;firstTask&quot;, &quot;secondTask&quot;));</span>

<span class="nc" id="L2685">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L2686">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2688">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L2691">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L2692">                .list();</span>
<span class="nc" id="L2693">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2694">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2695">                .containsExactlyInAnyOrder(&quot;secondTask&quot;, &quot;secondTimerEvent&quot;);</span>
<span class="nc" id="L2696">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2697">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2698">                .containsOnly(procDefTwoTimers.getId());</span>

<span class="nc" id="L2700">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2701">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;secondTask&quot;);</span>
<span class="nc" id="L2702">        Job timerJob2 = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2703">        assertThat(timerJob2).isNotNull();</span>
<span class="nc" id="L2704">        Execution execution = runtimeService.createExecutionQuery().parentId(task.getExecutionId()).singleResult();</span>
<span class="nc" id="L2705">        Job job = managementService.createTimerJobQuery().executionId(execution.getId()).singleResult();</span>
<span class="nc" id="L2706">        assertThat(job)</span>
<span class="nc" id="L2707">                .usingRecursiveComparison()</span>
<span class="nc" id="L2708">                .ignoringFields(&quot;originalPersistentState&quot;, &quot;customValuesByteArrayRef&quot;, &quot;exceptionByteArrayRef&quot;)</span>
<span class="nc" id="L2709">                .isEqualTo(timerJob2);</span>
<span class="nc" id="L2710">        assertThat(timerJob1)</span>
<span class="nc" id="L2711">                .extracting(Job::getExecutionId)</span>
<span class="nc" id="L2712">                .isNotEqualTo(timerJob2);</span>

        // Verify events
<span class="nc" id="L2715">        assertThat(changeStateEventListener.hasEvents()).isTrue();</span>
<span class="nc" id="L2716">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L2717">                .extracting(FlowableEvent::getType)</span>
<span class="nc" id="L2718">                .containsExactly(FlowableEngineEventType.JOB_CANCELED, FlowableEngineEventType.TIMER_SCHEDULED);</span>

<span class="nc" id="L2720">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L2721">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) iterator.next();</span>
<span class="nc" id="L2722">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L2723">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>
<span class="nc" id="L2724">        entityEvent = (FlowableEngineEntityEvent) iterator.next();</span>
<span class="nc" id="L2725">        timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L2726">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;secondTimerEvent&quot;);</span>

        //Complete the process
<span class="nc" id="L2729">        job = managementService.moveTimerToExecutableJob(timerJob2.getId());</span>
<span class="nc" id="L2730">        managementService.executeJob(job.getId());</span>

<span class="nc bnc" id="L2732" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2733">            checkActivityInstances(procDefTwoTimers, processInstance, &quot;userTask&quot;, &quot;secondTask&quot;, &quot;thirdTask&quot;);</span>

<span class="nc" id="L2735">            checkTaskInstance(procDefTwoTimers, processInstance, &quot;secondTask&quot;, &quot;thirdTask&quot;);</span>
        }

<span class="nc" id="L2738">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2740" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2741">            checkActivityInstances(procDefTwoTimers, processInstance, &quot;userTask&quot;, &quot;secondTask&quot;, &quot;thirdTask&quot;);</span>

<span class="nc" id="L2743">            checkTaskInstance(procDefTwoTimers, processInstance, &quot;secondTask&quot;, &quot;thirdTask&quot;);</span>
        }

<span class="nc" id="L2746">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2747">    }</span>

    @Test
    public void testMigrateActivityInsideEmbeddedSubProcessWithTimerToActivityOutsideEmbeddedSubProcessWithoutTimerInNewDefinition() {
<span class="nc" id="L2751">        ProcessDefinition procDefSubProcWithTimer = deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/oneTaskSubProcessWithTimer.bpmn20.xml&quot;);</span>
<span class="nc" id="L2752">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);

        //Start the processInstance without timer
<span class="nc" id="L2756">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefSubProcWithTimer.getId());</span>

<span class="nc" id="L2758">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2759">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;taskBefore&quot;);</span>
<span class="nc" id="L2760">        taskService.complete(task.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L2763">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2764">        assertThat(executions)</span>
<span class="nc" id="L2765">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2766">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subTask&quot;, &quot;boundaryTimerEvent&quot;);</span>
<span class="nc" id="L2767">        assertThat(executions)</span>
<span class="nc" id="L2768">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2769">                .containsOnly(procDefSubProcWithTimer.getId());</span>
<span class="nc" id="L2770">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2771">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;subTask&quot;);</span>
<span class="nc" id="L2772">        Job timerJob1 = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2773">        assertThat(timerJob1).isNotNull();</span>
<span class="nc" id="L2774">        assertThat(timerJob1).extracting(Job::getProcessDefinitionId).isEqualTo(procDefSubProcWithTimer.getId());</span>
<span class="nc" id="L2775">        assertThat(timerJob1.getJobHandlerConfiguration()).contains(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc" id="L2777">        changeStateEventListener.clear();</span>
        //Migrate to the other processDefinition
<span class="nc" id="L2779">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2780">                .migrateToProcessDefinition(procDefOneTask.getId())</span>
<span class="nc" id="L2781">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;subTask&quot;, &quot;userTask1Id&quot;));</span>

<span class="nc" id="L2783">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L2784">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2786">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L2789">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L2790">                .list();</span>
<span class="nc" id="L2791">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2792">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2793">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L2794">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2795">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2796">                .containsOnly(procDefOneTask.getId());</span>

<span class="nc" id="L2798">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2799">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>

<span class="nc" id="L2801">        Job timerJob2 = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2802">        assertThat(timerJob2).isNull();</span>

        // Verify events
<span class="nc" id="L2805">        assertThat(changeStateEventListener.hasEvents()).isTrue();</span>
<span class="nc" id="L2806">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L2807">                .extracting(FlowableEvent::getType)</span>
<span class="nc" id="L2808">                .containsExactly(FlowableEngineEventType.JOB_CANCELED, FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L2809">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L2810">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) iterator.next();</span>
<span class="nc" id="L2811">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L2812">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>
<span class="nc" id="L2813">        FlowableActivityEvent activityEvent = (FlowableActivityEvent) iterator.next();</span>
<span class="nc" id="L2814">        assertThat(activityEvent).extracting(FlowableActivityEvent::getActivityId).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc bnc" id="L2816" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2817">            checkActivityInstances(procDefOneTask, processInstance, &quot;userTask&quot;, &quot;taskBefore&quot;, &quot;userTask1Id&quot;);</span>

<span class="nc" id="L2819">            checkTaskInstance(procDefOneTask, processInstance, &quot;taskBefore&quot;, &quot;userTask1Id&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L2823">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2825" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2826">            checkActivityInstances(procDefOneTask, processInstance, &quot;userTask&quot;, &quot;taskBefore&quot;, &quot;userTask1Id&quot;);</span>

<span class="nc" id="L2828">            checkTaskInstance(procDefOneTask, processInstance, &quot;taskBefore&quot;, &quot;userTask1Id&quot;);</span>
        }

<span class="nc" id="L2831">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2832">    }</span>

    @Test
    public void testMigrateActivityToActivityInsideEmbeddedSubProcessWithTimerInNewDefinition() {
<span class="nc" id="L2836">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L2838">        ProcessDefinition procDefSubProcWithTimer = deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/oneTaskSubProcessWithTimer.bpmn20.xml&quot;);</span>

        //Start the processInstance without timer
<span class="nc" id="L2841">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L2844">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2845">        assertThat(executions)</span>
<span class="nc" id="L2846">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2847">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L2848">        assertThat(executions)</span>
<span class="nc" id="L2849">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2850">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2851">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2852">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L2853">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefOneTask.getId());</span>

<span class="nc" id="L2855">        changeStateEventListener.clear();</span>
        //Migrate to the other processDefinition
<span class="nc" id="L2857">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2858">                .migrateToProcessDefinition(procDefSubProcWithTimer.getId())</span>
<span class="nc" id="L2859">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;subTask&quot;));</span>

<span class="nc" id="L2861">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L2862">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2864">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L2867">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L2868">                .list();</span>
<span class="nc" id="L2869">        assertThat(executionsAfterMigration).</span>
<span class="nc" id="L2870">                extracting(Execution::getActivityId)</span>
<span class="nc" id="L2871">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subTask&quot;, &quot;boundaryTimerEvent&quot;);</span>
<span class="nc" id="L2872">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2873">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2874">                .containsOnly(procDefSubProcWithTimer.getId());</span>

<span class="nc" id="L2876">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2877">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;subTask&quot;);</span>
<span class="nc" id="L2878">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefSubProcWithTimer.getId());</span>

<span class="nc" id="L2880">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2881">        assertThat(timerJob).isNotNull();</span>
<span class="nc" id="L2882">        assertThat(timerJob).extracting(Job::getProcessDefinitionId).isEqualTo(procDefSubProcWithTimer.getId());</span>
<span class="nc" id="L2883">        assertThat(timerJob.getJobHandlerConfiguration()).contains(&quot;boundaryTimerEvent&quot;);</span>

        // Verify events
<span class="nc" id="L2886">        assertThat(changeStateEventListener.hasEvents()).isTrue();</span>
<span class="nc" id="L2887">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L2888">                .extracting(FlowableEvent::getType)</span>
<span class="nc" id="L2889">                .containsExactly(FlowableEngineEventType.ACTIVITY_STARTED, FlowableEngineEventType.TIMER_SCHEDULED);</span>

<span class="nc" id="L2891">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L2892">        FlowableActivityEvent activityEvent = (FlowableActivityEvent) iterator.next();</span>
<span class="nc" id="L2893">        assertThat(activityEvent).extracting(FlowableActivityEvent::getActivityId).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L2895">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) iterator.next();</span>
<span class="nc" id="L2896">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L2897">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc bnc" id="L2899" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2900">            checkActivityInstances(procDefSubProcWithTimer, processInstance, &quot;userTask&quot;, &quot;subTask&quot;);</span>

<span class="nc" id="L2902">            checkTaskInstance(procDefSubProcWithTimer, processInstance, &quot;subTask&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L2906">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2908" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2909">            checkActivityInstances(procDefSubProcWithTimer, processInstance, &quot;userTask&quot;, &quot;subTask&quot;, &quot;taskAfter&quot;);</span>

<span class="nc" id="L2911">            checkTaskInstance(procDefSubProcWithTimer, processInstance, &quot;subTask&quot;, &quot;taskAfter&quot;);</span>
        }

<span class="nc" id="L2914">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2915">    }</span>

    @Test
    public void testMigrateActivityToActivityInsideEmbeddedSubProcessWithTimerInNewDefinitionAndExecuteTimer() {
<span class="nc" id="L2919">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L2921">        ProcessDefinition procDefSubProcWithTimer = deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/oneTaskSubProcessWithTimer.bpmn20.xml&quot;);</span>

        //Start the processInstance without timer
<span class="nc" id="L2924">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L2927">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2928">        assertThat(executions)</span>
<span class="nc" id="L2929">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2930">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L2931">        assertThat(executions)</span>
<span class="nc" id="L2932">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2933">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2934">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2935">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L2936">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefOneTask.getId());</span>

<span class="nc" id="L2938">        changeStateEventListener.clear();</span>
        //Migrate to the other processDefinition
<span class="nc" id="L2940">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2941">                .migrateToProcessDefinition(procDefSubProcWithTimer.getId())</span>
<span class="nc" id="L2942">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;subTask&quot;));</span>

<span class="nc" id="L2944">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L2945">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2947">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L2950">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L2951">                .list();</span>
<span class="nc" id="L2952">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2953">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2954">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subTask&quot;, &quot;boundaryTimerEvent&quot;);</span>
<span class="nc" id="L2955">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L2956">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2957">                .containsOnly(procDefSubProcWithTimer.getId());</span>

<span class="nc" id="L2959">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2960">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;subTask&quot;);</span>
<span class="nc" id="L2961">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefSubProcWithTimer.getId());</span>

<span class="nc" id="L2963">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2964">        assertThat(timerJob).isNotNull();</span>
<span class="nc" id="L2965">        assertThat(timerJob).extracting(Job::getProcessDefinitionId).isEqualTo(procDefSubProcWithTimer.getId());</span>
<span class="nc" id="L2966">        assertThat(timerJob.getJobHandlerConfiguration()).contains(&quot;boundaryTimerEvent&quot;);</span>

        // Verify events
<span class="nc" id="L2969">        assertThat(changeStateEventListener.hasEvents()).isTrue();</span>
<span class="nc" id="L2970">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L2971">                .extracting(FlowableEvent::getType)</span>
<span class="nc" id="L2972">                .containsExactly(FlowableEngineEventType.ACTIVITY_STARTED, FlowableEngineEventType.TIMER_SCHEDULED);</span>

<span class="nc" id="L2974">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L2975">        FlowableActivityEvent activityEvent = (FlowableActivityEvent) iterator.next();</span>
<span class="nc" id="L2976">        assertThat(activityEvent).extracting(FlowableActivityEvent::getActivityId).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L2978">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) iterator.next();</span>
<span class="nc" id="L2979">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L2980">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

        //We will trigger the timer instead of the completing the task, it goes straight to the end

        //Complete the process
<span class="nc" id="L2985">        Job executableJob = managementService.moveTimerToExecutableJob(timerJob.getId());</span>
<span class="nc" id="L2986">        managementService.executeJob(executableJob.getId());</span>

<span class="nc bnc" id="L2988" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2989">            checkActivityInstances(procDefSubProcWithTimer, processInstance, &quot;userTask&quot;, &quot;subTask&quot;);</span>

<span class="nc" id="L2991">            checkTaskInstance(procDefSubProcWithTimer, processInstance, &quot;subTask&quot;);</span>
        }

<span class="nc" id="L2994">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2995">    }</span>

    @Test
    public void testMigrateActivityWithTimerInsideEmbeddedSubProcessToActivityWithoutTimerInsideEmbeddedSubProcessInNewDefinition() {
<span class="nc" id="L2999">        ProcessDefinition procVersion1 = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-with-timer-inside-embedded-subprocess.bpmn20.xml&quot;);
<span class="nc" id="L3001">        ProcessDefinition procVersion2 = deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/oneTaskWithTimerInSubProcess.bpmn20.xml&quot;);</span>

        //Start the processInstance without timer
<span class="nc" id="L3004">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procVersion1.getId());</span>
<span class="nc" id="L3005">        completeTask(taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult());</span>

        //Confirm the state to migrate
<span class="nc" id="L3008">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3009">        assertThat(executions)</span>
<span class="nc" id="L3010">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3011">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subTask&quot;, &quot;boundaryTimerEvent&quot;);</span>
<span class="nc" id="L3012">        assertThat(executions)</span>
<span class="nc" id="L3013">                .extracting(&quot;processDefinitionId&quot;).</span>
<span class="nc" id="L3014">                containsOnly(procVersion1.getId());</span>
<span class="nc" id="L3015">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3016">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;subTask&quot;);</span>
<span class="nc" id="L3017">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procVersion1.getId());</span>
<span class="nc" id="L3018">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3019">        assertThat(timerJob).isNotNull();</span>
<span class="nc" id="L3020">        assertThat(timerJob).extracting(Job::getProcessDefinitionId).isEqualTo(procVersion1.getId());</span>
<span class="nc" id="L3021">        assertThat(timerJob.getJobHandlerConfiguration()).contains(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc" id="L3023">        changeStateEventListener.clear();</span>
        //Migrate to the other processDefinition
<span class="nc" id="L3025">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L3026">                .migrateToProcessDefinition(procVersion2.getId())</span>
<span class="nc" id="L3027">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;subTask&quot;, &quot;subTask2&quot;));</span>

<span class="nc" id="L3029">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L3030">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L3032">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L3035">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L3036">                .list();</span>
<span class="nc" id="L3037">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3038">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3039">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subTask2&quot;);</span>
<span class="nc" id="L3040">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3041">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3042">                .containsOnly(procVersion2.getId());</span>

<span class="nc" id="L3044">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3045">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;subTask2&quot;);</span>
<span class="nc" id="L3046">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procVersion2.getId());</span>

<span class="nc" id="L3048">        timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3049">        assertThat(timerJob).isNull();</span>

        // Verify events
<span class="nc" id="L3052">        assertThat(changeStateEventListener.hasEvents()).isTrue();</span>
<span class="nc" id="L3053">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L3054">                .extracting(FlowableEvent::getType)</span>
<span class="nc" id="L3055">                .containsExactly(FlowableEngineEventType.JOB_CANCELED, FlowableEngineEventType.ACTIVITY_CANCELLED, FlowableEngineEventType.ACTIVITY_STARTED);</span>

<span class="nc" id="L3057">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L3058">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) iterator.next();</span>
<span class="nc" id="L3059">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L3060">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc" id="L3062">        FlowableActivityEvent activityEvent = (FlowableActivityEvent) iterator.next();</span>
<span class="nc" id="L3063">        assertThat(activityEvent).extracting(FlowableActivityEvent::getActivityId).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L3065">        activityEvent = (FlowableActivityEvent) iterator.next();</span>
<span class="nc" id="L3066">        assertThat(activityEvent).extracting(FlowableActivityEvent::getActivityId).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L3068">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc bnc" id="L3070" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3071">            checkActivityInstances(procVersion2, processInstance, &quot;userTask&quot;, &quot;taskBefore&quot;, &quot;subTask2&quot;);</span>

<span class="nc" id="L3073">            checkTaskInstance(procVersion2, processInstance, &quot;taskBefore&quot;, &quot;subTask2&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L3077">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L3079" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3080">            checkActivityInstances(procVersion2, processInstance, &quot;userTask&quot;, &quot;taskBefore&quot;, &quot;subTask2&quot;, &quot;taskAfter&quot;);</span>

<span class="nc" id="L3082">            checkTaskInstance(procVersion2, processInstance, &quot;taskBefore&quot;, &quot;subTask2&quot;, &quot;taskAfter&quot;);</span>
        }

<span class="nc" id="L3085">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3086">    }</span>

    @Test
    public void testMigrateActivityToActivityWithTimerInsideEmbeddedSubProcessInNewDefinition() {
<span class="nc" id="L3090">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L3092">        ProcessDefinition procDefTimerTaskInSubProcess = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/oneTaskWithTimerInSubProcess.bpmn20.xml&quot;);

        //Start the processInstance without timer
<span class="nc" id="L3096">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L3099">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3100">        assertThat(executions)</span>
<span class="nc" id="L3101">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3102">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L3103">        assertThat(executions)</span>
<span class="nc" id="L3104">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3105">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L3106">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3107">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L3108">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefOneTask.getId());</span>

<span class="nc" id="L3110">        changeStateEventListener.clear();</span>
        //Migrate to the other processDefinition
<span class="nc" id="L3112">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L3113">                .migrateToProcessDefinition(procDefTimerTaskInSubProcess.getId())</span>
<span class="nc" id="L3114">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;subTask&quot;));</span>

<span class="nc" id="L3116">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L3117">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L3119">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L3122">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L3123">                .list();</span>
<span class="nc" id="L3124">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3125">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3126">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subTask&quot;, &quot;boundaryTimerEvent&quot;);</span>
<span class="nc" id="L3127">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3128">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3129">                .containsOnly(procDefTimerTaskInSubProcess.getId());</span>

<span class="nc" id="L3131">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3132">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;subTask&quot;);</span>
<span class="nc" id="L3133">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefTimerTaskInSubProcess.getId());</span>

<span class="nc" id="L3135">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3136">        assertThat(timerJob).isNotNull();</span>
<span class="nc" id="L3137">        assertThat(timerJob).extracting(Job::getProcessDefinitionId).isEqualTo(procDefTimerTaskInSubProcess.getId());</span>
<span class="nc" id="L3138">        assertThat(timerJob.getJobHandlerConfiguration()).contains(&quot;boundaryTimerEvent&quot;);</span>
        //Job is attached to the activity
<span class="nc" id="L3140">        Execution timerExecution = runtimeService.createExecutionQuery().parentId(task.getExecutionId()).singleResult();</span>
<span class="nc" id="L3141">        Job timerFromTask = managementService.createTimerJobQuery().executionId(timerExecution.getId()).singleResult();</span>
<span class="nc" id="L3142">        assertThat(timerJob)</span>
<span class="nc" id="L3143">                .usingRecursiveComparison()</span>
<span class="nc" id="L3144">                .ignoringFields(&quot;originalPersistentState&quot;, &quot;customValuesByteArrayRef&quot;, &quot;exceptionByteArrayRef&quot;)</span>
<span class="nc" id="L3145">                .isEqualTo(timerFromTask);</span>

        // Verify events
<span class="nc" id="L3148">        assertThat(changeStateEventListener.hasEvents()).isTrue();</span>
<span class="nc" id="L3149">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L3150">                .extracting(FlowableEvent::getType)</span>
<span class="nc" id="L3151">                .containsExactly(FlowableEngineEventType.ACTIVITY_STARTED, FlowableEngineEventType.TIMER_SCHEDULED);</span>

<span class="nc" id="L3153">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L3154">        FlowableActivityEvent activityEvent = (FlowableActivityEvent) iterator.next();</span>
<span class="nc" id="L3155">        assertThat(activityEvent).extracting(FlowableActivityEvent::getActivityId).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L3157">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) iterator.next();</span>
<span class="nc" id="L3158">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L3159">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc bnc" id="L3161" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3162">            checkActivityInstances(procDefTimerTaskInSubProcess, processInstance, &quot;userTask&quot;, &quot;subTask&quot;);</span>

<span class="nc" id="L3164">            checkTaskInstance(procDefTimerTaskInSubProcess, processInstance, &quot;subTask&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L3168">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L3170" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3171">            checkActivityInstances(procDefTimerTaskInSubProcess, processInstance, &quot;userTask&quot;, &quot;subTask&quot;, &quot;subTask2&quot;, &quot;taskAfter&quot;);</span>

<span class="nc" id="L3173">            checkTaskInstance(procDefTimerTaskInSubProcess, processInstance, &quot;subTask&quot;, &quot;subTask2&quot;, &quot;taskAfter&quot;);</span>
        }

<span class="nc" id="L3176">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3177">    }</span>

    @Test
    public void testMigrateActivityToActivityWithTimerInsideEmbeddedSubProcessInNewDefinitionAndExecuteTimer() {
<span class="nc" id="L3181">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L3183">        ProcessDefinition procDefTimerTaskInSubProcess = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/oneTaskWithTimerInSubProcess.bpmn20.xml&quot;);

        //Start the processInstance without timer
<span class="nc" id="L3187">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L3190">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3191">        assertThat(executions)</span>
<span class="nc" id="L3192">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3193">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L3194">        assertThat(executions)</span>
<span class="nc" id="L3195">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3196">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L3197">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3198">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L3199">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefOneTask.getId());</span>

<span class="nc" id="L3201">        changeStateEventListener.clear();</span>
        //Migrate to the other processDefinition
<span class="nc" id="L3203">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L3204">                .migrateToProcessDefinition(procDefTimerTaskInSubProcess.getId())</span>
<span class="nc" id="L3205">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;subTask&quot;));</span>

<span class="nc" id="L3207">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L3208">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L3210">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L3213">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L3214">                .list();</span>
<span class="nc" id="L3215">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3216">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3217">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subTask&quot;, &quot;boundaryTimerEvent&quot;);</span>
<span class="nc" id="L3218">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3219">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3220">                .containsOnly(procDefTimerTaskInSubProcess.getId());</span>

<span class="nc" id="L3222">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3223">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;subTask&quot;);</span>
<span class="nc" id="L3224">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefTimerTaskInSubProcess.getId());</span>

<span class="nc" id="L3226">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3227">        assertThat(timerJob).isNotNull();</span>
<span class="nc" id="L3228">        assertThat(timerJob).extracting(Job::getProcessDefinitionId).isEqualTo(procDefTimerTaskInSubProcess.getId());</span>
<span class="nc" id="L3229">        assertThat(timerJob.getJobHandlerConfiguration()).contains(&quot;boundaryTimerEvent&quot;);</span>
        //Job is attached to the activity
<span class="nc" id="L3231">        Execution timerExecution = runtimeService.createExecutionQuery().parentId(task.getExecutionId()).singleResult();</span>
<span class="nc" id="L3232">        Job timerFromTask = managementService.createTimerJobQuery().executionId(timerExecution.getId()).singleResult();</span>
<span class="nc" id="L3233">        assertThat(timerJob)</span>
<span class="nc" id="L3234">                .usingRecursiveComparison()</span>
<span class="nc" id="L3235">                .ignoringFields(&quot;originalPersistentState&quot;, &quot;customValuesByteArrayRef&quot;, &quot;exceptionByteArrayRef&quot;)</span>
<span class="nc" id="L3236">                .isEqualTo(timerFromTask);</span>

        // Verify events
<span class="nc" id="L3239">        assertThat(changeStateEventListener.hasEvents()).isTrue();</span>
<span class="nc" id="L3240">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L3241">                .extracting(FlowableEvent::getType)</span>
<span class="nc" id="L3242">                .containsExactly(FlowableEngineEventType.ACTIVITY_STARTED, FlowableEngineEventType.TIMER_SCHEDULED);</span>

<span class="nc" id="L3244">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L3245">        FlowableActivityEvent activityEvent = (FlowableActivityEvent) iterator.next();</span>
<span class="nc" id="L3246">        assertThat(activityEvent).extracting(FlowableActivityEvent::getActivityId).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L3248">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) iterator.next();</span>
<span class="nc" id="L3249">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L3250">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

        //We will trigger the timer instead of the completing the task, it goes straight to the end of the subProcess, skipping one task
<span class="nc" id="L3253">        Job executableJob = managementService.moveTimerToExecutableJob(timerJob.getId());</span>
<span class="nc" id="L3254">        managementService.executeJob(executableJob.getId());</span>
<span class="nc" id="L3255">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L3257" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3258">            checkActivityInstances(procDefTimerTaskInSubProcess, processInstance, &quot;userTask&quot;, &quot;subTask&quot;, &quot;taskAfter&quot;);</span>

<span class="nc" id="L3260">            checkTaskInstance(procDefTimerTaskInSubProcess, processInstance, &quot;subTask&quot;, &quot;taskAfter&quot;);</span>
        }

<span class="nc" id="L3263">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3264">    }</span>
    
    @Test
    public void testMigrateActivityToActivityWithEventRegistryBoundaryEventInNewDefinition() {
<span class="nc" id="L3268">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L3270">        ProcessDefinition procDefOWithEventRegistry = deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/twoTasksProcessWithEventRegistry.bpmn20.xml&quot;);</span>

        //Start the processInstance without event registry event
<span class="nc" id="L3273">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L3276">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3277">        assertThat(executions)</span>
<span class="nc" id="L3278">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3279">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L3280">        assertThat(executions)</span>
<span class="nc" id="L3281">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3282">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L3283">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3284">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>

<span class="nc" id="L3286">        assertThat(runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(0);</span>

        //Migrate to the other processDefinition
<span class="nc" id="L3289">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L3290">                .migrateToProcessDefinition(procDefOWithEventRegistry.getId())</span>
<span class="nc" id="L3291">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;firstTask&quot;));</span>

<span class="nc" id="L3293">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L3294">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L3296">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L3299">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L3300">                .list();</span>
<span class="nc" id="L3301">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3302">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3303">                .containsExactlyInAnyOrder(&quot;firstTask&quot;, &quot;boundaryEvent&quot;);</span>
<span class="nc" id="L3304">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3305">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3306">                .containsOnly(procDefOWithEventRegistry.getId());</span>

<span class="nc" id="L3308">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3309">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;firstTask&quot;);</span>
        
<span class="nc" id="L3311">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3312">        assertThat(eventSubscription).isNotNull();</span>

<span class="nc bnc" id="L3314" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3315">            checkActivityInstances(procDefOWithEventRegistry, processInstance, &quot;userTask&quot;, &quot;firstTask&quot;);</span>
<span class="nc" id="L3316">            checkTaskInstance(procDefOWithEventRegistry, processInstance, &quot;firstTask&quot;);</span>
        }

        // Complete the process
<span class="nc" id="L3320">        completeProcessInstanceTasks(processInstance.getId());</span>
        
<span class="nc" id="L3322">        assertThat(runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(0);</span>

<span class="nc bnc" id="L3324" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L3326">            List&lt;HistoricActivityInstance&gt; taskExecutions = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L3327">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L3328">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L3329">                    .list();</span>
<span class="nc" id="L3330">            assertThat(taskExecutions)</span>
<span class="nc" id="L3331">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L3332">                    .containsExactlyInAnyOrder(&quot;firstTask&quot;, &quot;secondTask&quot;);</span>
<span class="nc" id="L3333">            assertThat(taskExecutions)</span>
<span class="nc" id="L3334">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L3335">                    .containsOnly(procDefOWithEventRegistry.getId());</span>

<span class="nc" id="L3337">            checkTaskInstance(procDefOWithEventRegistry, processInstance, &quot;firstTask&quot;, &quot;secondTask&quot;);</span>
        }

<span class="nc" id="L3340">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3341">    }</span>
    
    @Test
    public void testMigrateActivityWithEventRegistryBoundaryEventInBothDefinitions() {
<span class="nc" id="L3345">        ProcessDefinition procDefOWithEventRegistry = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/twoTasksProcessWithEventRegistry.bpmn20.xml&quot;);
<span class="nc" id="L3347">        ProcessDefinition procDefOWithEventRegistry2 = deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/twoTasksProcessWithEventRegistry.bpmn20.xml&quot;);</span>

        //Start the processInstance without event registry event
<span class="nc" id="L3350">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOWithEventRegistry.getId());</span>

<span class="nc" id="L3352">        assertThat(runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L3353">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3354">        assertThat(eventSubscription.getEventType()).isEqualTo(&quot;myEvent&quot;);</span>

        //Migrate to the other processDefinition
<span class="nc" id="L3357">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L3358">                .migrateToProcessDefinition(procDefOWithEventRegistry2.getId());</span>

<span class="nc" id="L3360">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L3361">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L3363">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L3366">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L3367">                .list();</span>
<span class="nc" id="L3368">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3369">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3370">                .containsExactlyInAnyOrder(&quot;firstTask&quot;, &quot;boundaryEvent&quot;);</span>
<span class="nc" id="L3371">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3372">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3373">                .containsOnly(procDefOWithEventRegistry2.getId());</span>

<span class="nc" id="L3375">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3376">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;firstTask&quot;);</span>
        
<span class="nc" id="L3378">        EventSubscription eventSubscription2 = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3379">        assertThat(eventSubscription2).isNotNull();</span>
<span class="nc" id="L3380">        assertThat(eventSubscription.getId()).isNotEqualTo(eventSubscription2.getId());</span>

        // Complete the process
<span class="nc" id="L3383">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L3384">        assertThat(runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(0);</span>

<span class="nc" id="L3386">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3387">    }</span>
    
    @Test
    public void testMigrateActivityWithEventRegistryBoundaryEventInBothDefinitionsWithEventSubscriptionDeleted() {
<span class="nc" id="L3391">        ProcessDefinition procDefOWithEventRegistry = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/twoTasksProcessWithEventRegistry.bpmn20.xml&quot;);
<span class="nc" id="L3393">        ProcessDefinition procDefOWithEventRegistry2 = deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/twoTasksProcessWithEventRegistry.bpmn20.xml&quot;);</span>

        //Start the processInstance without event registry event
<span class="nc" id="L3396">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOWithEventRegistry.getId());</span>

<span class="nc" id="L3398">        assertThat(runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L3399">        final EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3400">        assertThat(eventSubscription.getEventType()).isEqualTo(&quot;myEvent&quot;);</span>
<span class="nc" id="L3401">        managementService.executeCommand(new Command&lt;Void&gt;() {</span>

            @Override
            public Void execute(CommandContext commandContext) {
<span class="nc" id="L3405">                processEngineConfiguration.getEventSubscriptionServiceConfiguration().getEventSubscriptionService()</span>
<span class="nc" id="L3406">                    .deleteEventSubscription((EventSubscriptionEntity) eventSubscription);</span>
<span class="nc" id="L3407">                return null;</span>
            }
        });
        
<span class="nc" id="L3411">        assertThat(runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(0);</span>

        //Migrate to the other processDefinition
<span class="nc" id="L3414">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L3415">                .migrateToProcessDefinition(procDefOWithEventRegistry2.getId());</span>

<span class="nc" id="L3417">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L3418">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L3420">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>
        
<span class="nc" id="L3422">        EventSubscription eventSubscription2 = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3423">        assertThat(eventSubscription2).isNotNull();</span>

        // Complete the process
<span class="nc" id="L3426">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L3427">        assertThat(runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(0);</span>

<span class="nc" id="L3429">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3430">    }</span>

    //-- Intermediate Signal Catch Events
    @Test
    public void testMigrateSimpleActivityToIntermediateSignalCatchingEventInNewDefinition() {
<span class="nc" id="L3435">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L3437">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleIntermediateSignalCatchEvent.bpmn20.xml&quot;);

        //Start the processInstance without timer
<span class="nc" id="L3441">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L3444">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3445">        assertThat(executions)</span>
<span class="nc" id="L3446">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3447">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L3448">        assertThat(executions)</span>
<span class="nc" id="L3449">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3450">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L3451">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3452">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L3453">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefOneTask.getId());</span>
<span class="nc" id="L3454">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3455">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L3457">        changeStateEventListener.clear();</span>
        //Migrate to the other processDefinition
<span class="nc" id="L3459">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L3460">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L3461">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;intermediateCatchEvent&quot;));</span>

<span class="nc" id="L3463">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L3464">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L3466">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L3469">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L3470">                .list();</span>
<span class="nc" id="L3471">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3472">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3473">                .containsExactly(&quot;intermediateCatchEvent&quot;);</span>
<span class="nc" id="L3474">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3475">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3476">                .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L3478">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3479">        assertThat(tasks).isEmpty();</span>

<span class="nc" id="L3481">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3482">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3483">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType)</span>
<span class="nc" id="L3484">                .containsExactly(tuple(&quot;intermediateCatchEvent&quot;, &quot;signal&quot;));</span>

        // Verify events
<span class="nc" id="L3487">        assertThat(changeStateEventListener.hasEvents()).isTrue();</span>
<span class="nc" id="L3488">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L3489">                .extracting(FlowableEvent::getType)</span>
<span class="nc" id="L3490">                .containsExactly(FlowableEngineEventType.ACTIVITY_CANCELLED, FlowableEngineEventType.ACTIVITY_SIGNAL_WAITING);</span>

<span class="nc" id="L3492">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L3493">        FlowableActivityEvent activityEvent = (FlowableActivityEvent) iterator.next();</span>
<span class="nc" id="L3494">        assertThat(activityEvent).extracting(FlowableActivityEvent::getType).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L3495">        assertThat(activityEvent).extracting(FlowableActivityEvent::getActivityId).isEqualTo(&quot;userTask1Id&quot;);</span>

<span class="nc" id="L3497">        FlowableSignalEvent signalEvent = (FlowableSignalEvent) iterator.next();</span>
<span class="nc" id="L3498">        assertThat(signalEvent).extracting(FlowableSignalEvent::getType).isEqualTo(FlowableEngineEventType.ACTIVITY_SIGNAL_WAITING);</span>
<span class="nc" id="L3499">        assertThat(signalEvent).extracting(FlowableSignalEvent::getActivityId).isEqualTo(&quot;intermediateCatchEvent&quot;);</span>
<span class="nc" id="L3500">        assertThat(signalEvent).extracting(FlowableSignalEvent::getSignalName).isEqualTo(&quot;someSignal&quot;);</span>

        //Trigger the event
<span class="nc" id="L3503">        runtimeService.signalEventReceived(&quot;someSignal&quot;);</span>

<span class="nc" id="L3505">        executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3506">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3507">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3508">                .containsExactly(&quot;afterCatchEvent&quot;);</span>
<span class="nc" id="L3509">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3510">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3511">                .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L3513">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3514">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;afterCatchEvent&quot;);</span>
<span class="nc" id="L3515">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignal.getId());</span>
<span class="nc" id="L3516">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3517">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc bnc" id="L3519" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3520">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;afterCatchEvent&quot;);</span>
<span class="nc" id="L3521">            checkActivityInstances(procWithSignal, processInstance, &quot;intermediateCatchEvent&quot;, &quot;intermediateCatchEvent&quot;);</span>

<span class="nc" id="L3523">            checkTaskInstance(procWithSignal, processInstance, &quot;userTask1Id&quot;, &quot;afterCatchEvent&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L3527">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L3529" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3530">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;afterCatchEvent&quot;);</span>
<span class="nc" id="L3531">            checkActivityInstances(procWithSignal, processInstance, &quot;intermediateCatchEvent&quot;, &quot;intermediateCatchEvent&quot;);</span>

<span class="nc" id="L3533">            checkTaskInstance(procWithSignal, processInstance, &quot;userTask1Id&quot;, &quot;afterCatchEvent&quot;);</span>
        }

<span class="nc" id="L3536">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3537">    }</span>

    @Test
    public void testMigrateIntermediateSignalCatchingEventToSimpleActivityInNewDefinition() {
<span class="nc" id="L3541">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleIntermediateSignalCatchEvent.bpmn20.xml&quot;);
<span class="nc" id="L3543">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);

        //Start the processInstance without timer
<span class="nc" id="L3547">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procWithSignal.getId());</span>

<span class="nc" id="L3549">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3550">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;beforeCatchEvent&quot;);</span>
<span class="nc" id="L3551">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignal.getId());</span>
<span class="nc" id="L3552">        completeTask(task);</span>

        //Confirm the state to migrate
<span class="nc" id="L3555">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3556">        assertThat(executions)</span>
<span class="nc" id="L3557">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3558">                .containsExactly(&quot;intermediateCatchEvent&quot;);</span>
<span class="nc" id="L3559">        assertThat(executions)</span>
<span class="nc" id="L3560">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3561">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L3562">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3563">        assertThat(tasks).isEmpty();</span>
<span class="nc" id="L3564">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3565">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3566">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType)</span>
<span class="nc" id="L3567">                .containsExactly(tuple(&quot;intermediateCatchEvent&quot;, &quot;signal&quot;));</span>

<span class="nc" id="L3569">        changeStateEventListener.clear();</span>
        //Migrate to the other processDefinition
<span class="nc" id="L3571">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L3572">                .migrateToProcessDefinition(procDefOneTask.getId())</span>
<span class="nc" id="L3573">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;intermediateCatchEvent&quot;, &quot;userTask1Id&quot;));</span>

<span class="nc" id="L3575">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L3576">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L3578">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L3581">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L3582">                .list();</span>
<span class="nc" id="L3583">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3584">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3585">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L3586">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3587">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3588">                .containsOnly(procDefOneTask.getId());</span>

<span class="nc" id="L3590">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3591">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L3592">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefOneTask.getId());</span>

<span class="nc" id="L3594">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3595">        assertThat(eventSubscriptions).isEmpty();</span>

        // Verify events
<span class="nc" id="L3598">        assertThat(changeStateEventListener.hasEvents()).isTrue();</span>
<span class="nc" id="L3599">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L3600">                .extracting(FlowableEvent::getType)</span>
<span class="nc" id="L3601">                .containsExactly(FlowableEngineEventType.ACTIVITY_STARTED);</span>

<span class="nc" id="L3603">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L3604">        FlowableActivityEvent activityEvent = (FlowableActivityEvent) iterator.next();</span>
<span class="nc" id="L3605">        assertThat(activityEvent).extracting(FlowableActivityEvent::getType).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L3606">        assertThat(activityEvent).extracting(FlowableActivityEvent::getActivityId).isEqualTo(&quot;userTask1Id&quot;);</span>

<span class="nc bnc" id="L3608" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3609">            checkActivityInstances(procDefOneTask, processInstance, &quot;userTask&quot;, &quot;beforeCatchEvent&quot;, &quot;userTask1Id&quot;);</span>
<span class="nc" id="L3610">            checkActivityInstances(procDefOneTask, processInstance, &quot;intermediateCatchEvent&quot;, &quot;intermediateCatchEvent&quot;);</span>

<span class="nc" id="L3612">            checkTaskInstance(procDefOneTask, processInstance, &quot;beforeCatchEvent&quot;, &quot;userTask1Id&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L3616">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L3618" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3619">            checkActivityInstances(procDefOneTask, processInstance, &quot;userTask&quot;, &quot;beforeCatchEvent&quot;, &quot;userTask1Id&quot;);</span>
<span class="nc" id="L3620">            checkActivityInstances(procDefOneTask, processInstance, &quot;intermediateCatchEvent&quot;, &quot;intermediateCatchEvent&quot;);</span>

<span class="nc" id="L3622">            checkTaskInstance(procDefOneTask, processInstance, &quot;beforeCatchEvent&quot;, &quot;userTask1Id&quot;);</span>
        }

<span class="nc" id="L3625">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3626">    }</span>

    @Test
    public void testMigrateIntermediateSignalCatchingEventToIntermediateSignalCatchingEventInNewDefinition() {
<span class="nc" id="L3630">        ProcessDefinition procWithSignalVer1 = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleIntermediateSignalCatchEvent.bpmn20.xml&quot;);
<span class="nc" id="L3632">        ProcessDefinition procWithSignalVer2 = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/simple-intermediate-signal-catch-event.bpmn20.xml&quot;);

        //Start the processInstance without timer
<span class="nc" id="L3636">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procWithSignalVer1.getId());</span>

<span class="nc" id="L3638">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3639">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;beforeCatchEvent&quot;);</span>
<span class="nc" id="L3640">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignalVer1.getId());</span>
<span class="nc" id="L3641">        completeTask(task);</span>

        //Confirm the state to migrate
<span class="nc" id="L3644">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3645">        assertThat(executions)</span>
<span class="nc" id="L3646">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3647">                .containsExactly(&quot;intermediateCatchEvent&quot;);</span>
<span class="nc" id="L3648">        assertThat(executions)</span>
<span class="nc" id="L3649">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3650">                .containsOnly(procWithSignalVer1.getId());</span>
<span class="nc" id="L3651">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3652">        assertThat(tasks).isEmpty();</span>
<span class="nc" id="L3653">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3654">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3655">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType)</span>
<span class="nc" id="L3656">                .containsExactly(tuple(&quot;intermediateCatchEvent&quot;, &quot;signal&quot;));</span>
<span class="nc" id="L3657">        changeStateEventListener.clear();</span>
        //Migrate to the other processDefinition
<span class="nc" id="L3659">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L3660">                .migrateToProcessDefinition(procWithSignalVer2.getId())</span>
<span class="nc" id="L3661">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;intermediateCatchEvent&quot;, &quot;newIntermediateCatchEvent&quot;));</span>

<span class="nc" id="L3663">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L3664">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L3666">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L3669">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L3670">                .list();</span>
<span class="nc" id="L3671">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3672">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3673">                .containsExactly(&quot;newIntermediateCatchEvent&quot;);</span>
<span class="nc" id="L3674">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3675">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3676">                .containsOnly(procWithSignalVer2.getId());</span>

<span class="nc" id="L3678">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3679">        assertThat(tasks).isEmpty();</span>

<span class="nc" id="L3681">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3682">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3683">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType)</span>
<span class="nc" id="L3684">                .containsExactly(tuple(&quot;newIntermediateCatchEvent&quot;, &quot;signal&quot;));</span>

        // Verify events
<span class="nc" id="L3687">        assertThat(changeStateEventListener.hasEvents()).isTrue();</span>
<span class="nc" id="L3688">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L3689">                .extracting(FlowableEvent::getType)</span>
<span class="nc" id="L3690">                .containsExactly(FlowableEngineEventType.ACTIVITY_SIGNAL_WAITING);</span>

<span class="nc" id="L3692">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L3693">        FlowableSignalEvent signalEvent = (FlowableSignalEvent) iterator.next();</span>
<span class="nc" id="L3694">        assertThat(signalEvent).extracting(FlowableSignalEvent::getType).isEqualTo(FlowableEngineEventType.ACTIVITY_SIGNAL_WAITING);</span>
<span class="nc" id="L3695">        assertThat(signalEvent).extracting(FlowableSignalEvent::getActivityId).isEqualTo(&quot;newIntermediateCatchEvent&quot;);</span>
<span class="nc" id="L3696">        assertThat(signalEvent).extracting(FlowableSignalEvent::getSignalName).isEqualTo(&quot;someNewSignal&quot;);</span>

        //Trigger the event
<span class="nc" id="L3699">        runtimeService.signalEventReceived(&quot;someNewSignal&quot;);</span>

<span class="nc" id="L3701">        executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3702">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3703">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3704">                .containsExactly(&quot;afterNewCatchEvent&quot;);</span>
<span class="nc" id="L3705">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3706">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3707">                .containsOnly(procWithSignalVer2.getId());</span>

<span class="nc" id="L3709">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3710">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;afterNewCatchEvent&quot;);</span>
<span class="nc" id="L3711">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignalVer2.getId());</span>
<span class="nc" id="L3712">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3713">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc bnc" id="L3715" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3716">            checkActivityInstances(procWithSignalVer2, processInstance, &quot;userTask&quot;, &quot;beforeCatchEvent&quot;, &quot;afterNewCatchEvent&quot;);</span>
<span class="nc" id="L3717">            checkActivityInstances(procWithSignalVer2, processInstance, &quot;intermediateCatchEvent&quot;, &quot;intermediateCatchEvent&quot;, &quot;newIntermediateCatchEvent&quot;);</span>

<span class="nc" id="L3719">            checkTaskInstance(procWithSignalVer2, processInstance, &quot;beforeCatchEvent&quot;, &quot;afterNewCatchEvent&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L3723">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L3725" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3726">            checkActivityInstances(procWithSignalVer2, processInstance, &quot;userTask&quot;, &quot;beforeCatchEvent&quot;, &quot;afterNewCatchEvent&quot;);</span>
<span class="nc" id="L3727">            checkActivityInstances(procWithSignalVer2, processInstance, &quot;intermediateCatchEvent&quot;, &quot;intermediateCatchEvent&quot;, &quot;newIntermediateCatchEvent&quot;);</span>

<span class="nc" id="L3729">            checkTaskInstance(procWithSignalVer2, processInstance, &quot;beforeCatchEvent&quot;, &quot;afterNewCatchEvent&quot;);</span>
        }

<span class="nc" id="L3732">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3733">    }</span>

    //-- Intermediate Message Catch Events
    @Test
    public void testMigrateSimpleActivityToIntermediateMessageCatchingEventInNewDefinition() {
<span class="nc" id="L3738">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L3740">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleIntermediateMessageCatchEvent.bpmn20.xml&quot;);

        //Start the processInstance without timer
<span class="nc" id="L3744">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L3747">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3748">        assertThat(executions).</span>
<span class="nc" id="L3749">                extracting(Execution::getActivityId)</span>
<span class="nc" id="L3750">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L3751">        assertThat(executions)</span>
<span class="nc" id="L3752">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3753">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L3754">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3755">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L3756">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefOneTask.getId());</span>
<span class="nc" id="L3757">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3758">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L3760">        changeStateEventListener.clear();</span>
        //Migrate to the other processDefinition
<span class="nc" id="L3762">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L3763">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L3764">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;intermediateCatchEvent&quot;));</span>

<span class="nc" id="L3766">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L3767">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L3769">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L3772">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L3773">                .list();</span>
<span class="nc" id="L3774">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3775">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3776">                .containsExactly(&quot;intermediateCatchEvent&quot;);</span>
<span class="nc" id="L3777">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3778">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3779">                .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L3781">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3782">        assertThat(tasks).isEmpty();</span>

<span class="nc" id="L3784">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3785">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3786">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType)</span>
<span class="nc" id="L3787">                .containsExactly(tuple(&quot;intermediateCatchEvent&quot;, &quot;message&quot;));</span>

        // Verify events
<span class="nc" id="L3790">        assertThat(changeStateEventListener.hasEvents()).isTrue();</span>
<span class="nc" id="L3791">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L3792">                .extracting(FlowableEvent::getType)</span>
<span class="nc" id="L3793">                .containsExactly(FlowableEngineEventType.ACTIVITY_CANCELLED, FlowableEngineEventType.ACTIVITY_MESSAGE_WAITING);</span>

<span class="nc" id="L3795">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L3796">        FlowableActivityEvent activityEvent = (FlowableActivityEvent) iterator.next();</span>
<span class="nc" id="L3797">        assertThat(activityEvent).extracting(FlowableActivityEvent::getType).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L3798">        assertThat(activityEvent).extracting(FlowableActivityEvent::getActivityId).isEqualTo(&quot;userTask1Id&quot;);</span>

<span class="nc" id="L3800">        FlowableMessageEvent signalEvent = (FlowableMessageEvent) iterator.next();</span>
<span class="nc" id="L3801">        assertThat(signalEvent).extracting(FlowableMessageEvent::getType).isEqualTo(FlowableEngineEventType.ACTIVITY_MESSAGE_WAITING);</span>
<span class="nc" id="L3802">        assertThat(signalEvent).extracting(FlowableMessageEvent::getActivityId).isEqualTo(&quot;intermediateCatchEvent&quot;);</span>
<span class="nc" id="L3803">        assertThat(signalEvent).extracting(FlowableMessageEvent::getMessageName).isEqualTo(&quot;someMessage&quot;);</span>

        //Trigger the event
<span class="nc" id="L3806">        Execution messageCatchExecution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).activityId(&quot;intermediateCatchEvent&quot;)</span>
<span class="nc" id="L3807">                .singleResult();</span>
<span class="nc" id="L3808">        runtimeService.messageEventReceived(&quot;someMessage&quot;, messageCatchExecution.getId());</span>

<span class="nc" id="L3810">        executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3811">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3812">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3813">                .containsExactly(&quot;afterCatchEvent&quot;);</span>
<span class="nc" id="L3814">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3815">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3816">                .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L3818">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3819">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;afterCatchEvent&quot;);</span>
<span class="nc" id="L3820">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignal.getId());</span>
<span class="nc" id="L3821">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3822">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc bnc" id="L3824" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3825">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;afterCatchEvent&quot;);</span>
<span class="nc" id="L3826">            checkActivityInstances(procWithSignal, processInstance, &quot;intermediateCatchEvent&quot;, &quot;intermediateCatchEvent&quot;);</span>

<span class="nc" id="L3828">            checkTaskInstance(procWithSignal, processInstance, &quot;userTask1Id&quot;, &quot;afterCatchEvent&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L3832">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L3834" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3835">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;afterCatchEvent&quot;);</span>
<span class="nc" id="L3836">            checkActivityInstances(procWithSignal, processInstance, &quot;intermediateCatchEvent&quot;, &quot;intermediateCatchEvent&quot;);</span>

<span class="nc" id="L3838">            checkTaskInstance(procWithSignal, processInstance, &quot;userTask1Id&quot;, &quot;afterCatchEvent&quot;);</span>
        }

<span class="nc" id="L3841">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3842">    }</span>

    @Test
    public void testMigrateIntermediateMessageCatchingEventToSimpleActivityInNewDefinition() {
<span class="nc" id="L3846">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleIntermediateMessageCatchEvent.bpmn20.xml&quot;);
<span class="nc" id="L3848">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);

        //Start the processInstance without timer
<span class="nc" id="L3852">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procWithSignal.getId());</span>

<span class="nc" id="L3854">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3855">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;beforeCatchEvent&quot;);</span>
<span class="nc" id="L3856">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignal.getId());</span>
<span class="nc" id="L3857">        completeTask(task);</span>

        //Confirm the state to migrate
<span class="nc" id="L3860">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3861">        assertThat(executions)</span>
<span class="nc" id="L3862">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3863">                .containsExactly(&quot;intermediateCatchEvent&quot;);</span>
<span class="nc" id="L3864">        assertThat(executions)</span>
<span class="nc" id="L3865">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3866">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L3867">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3868">        assertThat(tasks).isEmpty();</span>
<span class="nc" id="L3869">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3870">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3871">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType)</span>
<span class="nc" id="L3872">                .containsExactly(tuple(&quot;intermediateCatchEvent&quot;, &quot;message&quot;));</span>

<span class="nc" id="L3874">        changeStateEventListener.clear();</span>
        //Migrate to the other processDefinition
<span class="nc" id="L3876">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L3877">                .migrateToProcessDefinition(procDefOneTask.getId())</span>
<span class="nc" id="L3878">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;intermediateCatchEvent&quot;, &quot;userTask1Id&quot;));</span>

<span class="nc" id="L3880">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L3881">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L3883">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L3886">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L3887">                .list();</span>
<span class="nc" id="L3888">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3889">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3890">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L3891">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3892">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3893">                .containsOnly(procDefOneTask.getId());</span>

<span class="nc" id="L3895">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3896">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L3897">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefOneTask.getId());</span>

<span class="nc" id="L3899">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3900">        assertThat(eventSubscriptions).isEmpty();</span>

        // Verify events
<span class="nc" id="L3903">        assertThat(changeStateEventListener.hasEvents()).isTrue();</span>
<span class="nc" id="L3904">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L3905">                .extracting(FlowableEvent::getType)</span>
<span class="nc" id="L3906">                .containsExactly(FlowableEngineEventType.ACTIVITY_MESSAGE_CANCELLED, FlowableEngineEventType.ACTIVITY_STARTED);</span>

<span class="nc" id="L3908">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L3909">        FlowableActivityEvent signalEvent = (FlowableMessageEvent) iterator.next();</span>
<span class="nc" id="L3910">        assertThat(signalEvent).extracting(FlowableActivityEvent::getType).isEqualTo(FlowableEngineEventType.ACTIVITY_MESSAGE_CANCELLED);</span>
<span class="nc" id="L3911">        assertThat(signalEvent).extracting(FlowableActivityEvent::getActivityId).isEqualTo(&quot;intermediateCatchEvent&quot;);</span>
<span class="nc" id="L3912">        assertThat((FlowableMessageEvent) signalEvent).extracting(FlowableMessageEvent::getMessageName).isEqualTo(&quot;someMessage&quot;);</span>

<span class="nc" id="L3914">        FlowableActivityEvent activityEvent = (FlowableActivityEvent) iterator.next();</span>
<span class="nc" id="L3915">        assertThat(activityEvent).extracting(FlowableActivityEvent::getType).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L3916">        assertThat(activityEvent).extracting(FlowableActivityEvent::getActivityId).isEqualTo(&quot;userTask1Id&quot;);</span>

<span class="nc bnc" id="L3918" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3919">            checkActivityInstances(procDefOneTask, processInstance, &quot;userTask&quot;, &quot;beforeCatchEvent&quot;, &quot;userTask1Id&quot;);</span>
<span class="nc" id="L3920">            checkActivityInstances(procDefOneTask, processInstance, &quot;intermediateCatchEvent&quot;, &quot;intermediateCatchEvent&quot;);</span>

<span class="nc" id="L3922">            checkTaskInstance(procDefOneTask, processInstance, &quot;beforeCatchEvent&quot;, &quot;userTask1Id&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L3926">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L3928" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3929">            checkActivityInstances(procDefOneTask, processInstance, &quot;userTask&quot;, &quot;beforeCatchEvent&quot;, &quot;userTask1Id&quot;);</span>
<span class="nc" id="L3930">            checkActivityInstances(procDefOneTask, processInstance, &quot;intermediateCatchEvent&quot;, &quot;intermediateCatchEvent&quot;);</span>

<span class="nc" id="L3932">            checkTaskInstance(procDefOneTask, processInstance, &quot;beforeCatchEvent&quot;, &quot;userTask1Id&quot;);</span>
        }

<span class="nc" id="L3935">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3936">    }</span>

    @Test
    public void testMigrateIntermediateMessageCatchingEventToIntermediateMessageCatchingEventInNewDefinition() {
<span class="nc" id="L3940">        ProcessDefinition procWithSignalVer1 = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleIntermediateMessageCatchEvent.bpmn20.xml&quot;);
<span class="nc" id="L3942">        ProcessDefinition procWithSignalVer2 = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/simple-intermediate-message-catch-event.bpmn20.xml&quot;);

        //Start the processInstance without timer
<span class="nc" id="L3946">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procWithSignalVer1.getId());</span>

<span class="nc" id="L3948">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3949">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;beforeCatchEvent&quot;);</span>
<span class="nc" id="L3950">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignalVer1.getId());</span>
<span class="nc" id="L3951">        completeTask(task);</span>

        //Confirm the state to migrate
<span class="nc" id="L3954">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3955">        assertThat(executions)</span>
<span class="nc" id="L3956">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3957">                .containsExactly(&quot;intermediateCatchEvent&quot;);</span>
<span class="nc" id="L3958">        assertThat(executions)</span>
<span class="nc" id="L3959">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3960">                .containsOnly(procWithSignalVer1.getId());</span>
<span class="nc" id="L3961">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3962">        assertThat(tasks).isEmpty();</span>
<span class="nc" id="L3963">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3964">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3965">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType)</span>
<span class="nc" id="L3966">                .containsExactly(tuple(&quot;intermediateCatchEvent&quot;, &quot;message&quot;));</span>

<span class="nc" id="L3968">        changeStateEventListener.clear();</span>
        //Migrate to the other processDefinition
<span class="nc" id="L3970">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L3971">                .migrateToProcessDefinition(procWithSignalVer2.getId())</span>
<span class="nc" id="L3972">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;intermediateCatchEvent&quot;, &quot;intermediateNewCatchEvent&quot;));</span>

<span class="nc" id="L3974">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L3975">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L3977">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L3980">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L3981">                .list();</span>
<span class="nc" id="L3982">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3983">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3984">                .containsExactly(&quot;intermediateNewCatchEvent&quot;);</span>
<span class="nc" id="L3985">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L3986">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3987">                .containsOnly(procWithSignalVer2.getId());</span>

<span class="nc" id="L3989">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3990">        assertThat(tasks).isEmpty();</span>

<span class="nc" id="L3992">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3993">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3994">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType)</span>
<span class="nc" id="L3995">                .containsExactly(tuple(&quot;intermediateNewCatchEvent&quot;, &quot;message&quot;));</span>

        // Verify events
<span class="nc" id="L3998">        assertThat(changeStateEventListener.hasEvents()).isTrue();</span>
<span class="nc" id="L3999">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L4000">                .extracting(FlowableEvent::getType)</span>
<span class="nc" id="L4001">                .containsExactly(FlowableEngineEventType.ACTIVITY_MESSAGE_CANCELLED, FlowableEngineEventType.ACTIVITY_MESSAGE_WAITING);</span>

<span class="nc" id="L4003">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L4004">        FlowableMessageEvent signalEvent = (FlowableMessageEvent) iterator.next();</span>
<span class="nc" id="L4005">        assertThat(signalEvent).extracting(FlowableMessageEvent::getType).isEqualTo(FlowableEngineEventType.ACTIVITY_MESSAGE_CANCELLED);</span>
<span class="nc" id="L4006">        assertThat(signalEvent).extracting(FlowableMessageEvent::getActivityId).isEqualTo(&quot;intermediateCatchEvent&quot;);</span>
<span class="nc" id="L4007">        assertThat(signalEvent).extracting(FlowableMessageEvent::getMessageName).isEqualTo(&quot;someMessage&quot;);</span>

<span class="nc" id="L4009">        signalEvent = (FlowableMessageEvent) iterator.next();</span>
<span class="nc" id="L4010">        assertThat(signalEvent).extracting(FlowableMessageEvent::getType).isEqualTo(FlowableEngineEventType.ACTIVITY_MESSAGE_WAITING);</span>
<span class="nc" id="L4011">        assertThat(signalEvent).extracting(FlowableMessageEvent::getActivityId).isEqualTo(&quot;intermediateNewCatchEvent&quot;);</span>
<span class="nc" id="L4012">        assertThat(signalEvent).extracting(FlowableMessageEvent::getMessageName).isEqualTo(&quot;someNewMessage&quot;);</span>

        //Trigger the event
<span class="nc" id="L4015">        Execution messageCatchExecution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L4016">                .activityId(&quot;intermediateNewCatchEvent&quot;).singleResult();</span>
<span class="nc" id="L4017">        runtimeService.messageEventReceived(&quot;someNewMessage&quot;, messageCatchExecution.getId());</span>

<span class="nc" id="L4019">        executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L4020">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L4021">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L4022">                .containsExactly(&quot;afterNewCatchEvent&quot;);</span>
<span class="nc" id="L4023">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L4024">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L4025">                .containsOnly(procWithSignalVer2.getId());</span>

<span class="nc" id="L4027">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L4028">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;afterNewCatchEvent&quot;);</span>
<span class="nc" id="L4029">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignalVer2.getId());</span>
<span class="nc" id="L4030">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L4031">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc bnc" id="L4033" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L4034">            checkActivityInstances(procWithSignalVer2, processInstance, &quot;userTask&quot;, &quot;beforeCatchEvent&quot;, &quot;afterNewCatchEvent&quot;);</span>
<span class="nc" id="L4035">            checkActivityInstances(procWithSignalVer2, processInstance, &quot;intermediateCatchEvent&quot;, &quot;intermediateCatchEvent&quot;, &quot;intermediateNewCatchEvent&quot;);</span>

<span class="nc" id="L4037">            checkTaskInstance(procWithSignalVer2, processInstance, &quot;beforeCatchEvent&quot;, &quot;afterNewCatchEvent&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L4041">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L4043" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L4044">            checkActivityInstances(procWithSignalVer2, processInstance, &quot;userTask&quot;, &quot;beforeCatchEvent&quot;, &quot;afterNewCatchEvent&quot;);</span>
<span class="nc" id="L4045">            checkActivityInstances(procWithSignalVer2, processInstance, &quot;intermediateCatchEvent&quot;, &quot;intermediateCatchEvent&quot;, &quot;intermediateNewCatchEvent&quot;);</span>

<span class="nc" id="L4047">            checkTaskInstance(procWithSignalVer2, processInstance, &quot;beforeCatchEvent&quot;, &quot;afterNewCatchEvent&quot;);</span>
        }

<span class="nc" id="L4050">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L4051">    }</span>
    
    @Test
    public void testMigrateSimpleActivityToIntermediateEventRegistryCatchingEventInNewDefinition() {
<span class="nc" id="L4055">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L4057">        ProcessDefinition procWithEventRegistry = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleIntermediateEventRegistryCatchEvent.bpmn20.xml&quot;);

        //Start the processInstance without timer
<span class="nc" id="L4061">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Migrate to the other processDefinition
<span class="nc" id="L4064">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L4065">                .migrateToProcessDefinition(procWithEventRegistry.getId())</span>
<span class="nc" id="L4066">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;intermediateCatchEvent&quot;));</span>

<span class="nc" id="L4068">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L4069">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L4071">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L4074">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L4075">                .list();</span>
<span class="nc" id="L4076">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L4077">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L4078">                .containsExactly(&quot;intermediateCatchEvent&quot;);</span>
<span class="nc" id="L4079">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L4080">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L4081">                .containsOnly(procWithEventRegistry.getId());</span>

<span class="nc" id="L4083">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L4084">        assertThat(tasks).isEmpty();</span>

<span class="nc" id="L4086">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L4087">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L4088">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType)</span>
<span class="nc" id="L4089">                .containsExactly(tuple(&quot;intermediateCatchEvent&quot;, &quot;myEvent&quot;));</span>

        //Trigger the event
<span class="nc" id="L4092">        runtimeService.trigger(runtimeService.createExecutionQuery().activityId(&quot;intermediateCatchEvent&quot;).singleResult().getId());</span>

<span class="nc" id="L4094">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L4095">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;afterCatchEvent&quot;);</span>
<span class="nc" id="L4096">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithEventRegistry.getId());</span>
<span class="nc" id="L4097">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L4098">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc bnc" id="L4100" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L4101">            checkActivityInstances(procWithEventRegistry, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;afterCatchEvent&quot;);</span>
<span class="nc" id="L4102">            checkActivityInstances(procWithEventRegistry, processInstance, &quot;intermediateCatchEvent&quot;, &quot;intermediateCatchEvent&quot;);</span>

<span class="nc" id="L4104">            checkTaskInstance(procWithEventRegistry, processInstance, &quot;userTask1Id&quot;, &quot;afterCatchEvent&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L4108">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L4110" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L4111">            checkActivityInstances(procWithEventRegistry, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;afterCatchEvent&quot;);</span>
<span class="nc" id="L4112">            checkActivityInstances(procWithEventRegistry, processInstance, &quot;intermediateCatchEvent&quot;, &quot;intermediateCatchEvent&quot;);</span>

<span class="nc" id="L4114">            checkTaskInstance(procWithEventRegistry, processInstance, &quot;userTask1Id&quot;, &quot;afterCatchEvent&quot;);</span>
        }

<span class="nc" id="L4117">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L4118">    }</span>
    
    @Test
    public void testMigrateIntermediateEventRegistryCatchingEventToSimpleActivityInNewDefinition() {
<span class="nc" id="L4122">        ProcessDefinition procWithEventRegistry = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleIntermediateEventRegistryCatchEvent.bpmn20.xml&quot;);
<span class="nc" id="L4124">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);

        //Start the processInstance with event registry catch event
<span class="nc" id="L4128">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procWithEventRegistry.getId());</span>

<span class="nc" id="L4130">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L4131">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;beforeCatchEvent&quot;);</span>
<span class="nc" id="L4132">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithEventRegistry.getId());</span>
<span class="nc" id="L4133">        completeTask(task);</span>

        //Confirm the state to migrate
<span class="nc" id="L4136">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L4137">        assertThat(executions)</span>
<span class="nc" id="L4138">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L4139">                .containsExactly(&quot;intermediateCatchEvent&quot;);</span>
<span class="nc" id="L4140">        assertThat(executions)</span>
<span class="nc" id="L4141">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L4142">                .containsOnly(procWithEventRegistry.getId());</span>
<span class="nc" id="L4143">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L4144">        assertThat(tasks).isEmpty();</span>
<span class="nc" id="L4145">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L4146">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L4147">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType)</span>
<span class="nc" id="L4148">                .containsExactly(tuple(&quot;intermediateCatchEvent&quot;, &quot;myEvent&quot;));</span>

        //Migrate to the other processDefinition
<span class="nc" id="L4151">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L4152">                .migrateToProcessDefinition(procDefOneTask.getId())</span>
<span class="nc" id="L4153">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;intermediateCatchEvent&quot;, &quot;userTask1Id&quot;));</span>

<span class="nc" id="L4155">        ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L4156">        assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L4158">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L4161">        List&lt;Execution&gt; executionsAfterMigration = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions()</span>
<span class="nc" id="L4162">                .list();</span>
<span class="nc" id="L4163">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L4164">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L4165">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L4166">        assertThat(executionsAfterMigration)</span>
<span class="nc" id="L4167">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L4168">                .containsOnly(procDefOneTask.getId());</span>

<span class="nc" id="L4170">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L4171">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L4172">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefOneTask.getId());</span>

<span class="nc" id="L4174">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L4175">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc bnc" id="L4177" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L4178">            checkActivityInstances(procDefOneTask, processInstance, &quot;userTask&quot;, &quot;beforeCatchEvent&quot;, &quot;userTask1Id&quot;);</span>
<span class="nc" id="L4179">            checkActivityInstances(procDefOneTask, processInstance, &quot;intermediateCatchEvent&quot;, &quot;intermediateCatchEvent&quot;);</span>

<span class="nc" id="L4181">            checkTaskInstance(procDefOneTask, processInstance, &quot;beforeCatchEvent&quot;, &quot;userTask1Id&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L4185">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L4187" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L4188">            checkActivityInstances(procDefOneTask, processInstance, &quot;userTask&quot;, &quot;beforeCatchEvent&quot;, &quot;userTask1Id&quot;);</span>
<span class="nc" id="L4189">            checkActivityInstances(procDefOneTask, processInstance, &quot;intermediateCatchEvent&quot;, &quot;intermediateCatchEvent&quot;);</span>

<span class="nc" id="L4191">            checkTaskInstance(procDefOneTask, processInstance, &quot;beforeCatchEvent&quot;, &quot;userTask1Id&quot;);</span>
        }

<span class="nc" id="L4194">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L4195">    }</span>
    
    @Test
    public void testMultiTenantProcessInstanceMigrationWithDefaultTenantDefinition() {
<span class="nc" id="L4199">        DefaultTenantProvider originalDefaultTenantValue = processEngineConfiguration.getDefaultTenantProvider();</span>
<span class="nc" id="L4200">        processEngineConfiguration.setDefaultTenantValue(&quot;default&quot;);</span>
<span class="nc" id="L4201">        processEngineConfiguration.setFallbackToDefaultTenant(true);</span>
        
        try {
            // Deploy first version of the process
<span class="nc" id="L4205">            Deployment deployment = repositoryService.createDeployment()</span>
<span class="nc" id="L4206">                    .name(&quot;my deploy&quot;)</span>
<span class="nc" id="L4207">                    .addClasspathResource(&quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;)</span>
<span class="nc" id="L4208">                    .tenantId(&quot;default&quot;)</span>
<span class="nc" id="L4209">                    .deploy();</span>
            
<span class="nc" id="L4211">            ProcessDefinition version1ProcessDef = repositoryService.createProcessDefinitionQuery()</span>
<span class="nc" id="L4212">                    .deploymentId(deployment.getId()).singleResult();</span>
    
            // Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L4215">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKeyAndTenantId(&quot;MP&quot;, &quot;tenant1&quot;);</span>
    
            // Deploy second version of the process in default tenant
<span class="nc" id="L4218">            deployment = repositoryService.createDeployment()</span>
<span class="nc" id="L4219">                    .name(&quot;my deploy&quot;)</span>
<span class="nc" id="L4220">                    .addClasspathResource(&quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;)</span>
<span class="nc" id="L4221">                    .tenantId(&quot;default&quot;)</span>
<span class="nc" id="L4222">                    .deploy();</span>
                
<span class="nc" id="L4224">            ProcessDefinition version2ProcessDef = repositoryService.createProcessDefinitionQuery()</span>
<span class="nc" id="L4225">                    .deploymentId(deployment.getId()).singleResult();</span>
    
<span class="nc" id="L4227">            List&lt;ProcessDefinition&gt; processDefinitions = repositoryService.createProcessDefinitionQuery()</span>
<span class="nc" id="L4228">                    .processDefinitionKey(&quot;MP&quot;)</span>
<span class="nc" id="L4229">                    .list();</span>
    
<span class="nc" id="L4231">            assertThat(processDefinitions)</span>
<span class="nc" id="L4232">                    .extracting(ProcessDefinition::getId)</span>
<span class="nc" id="L4233">                    .containsExactlyInAnyOrder(version1ProcessDef.getId(), version2ProcessDef.getId());</span>
    
<span class="nc" id="L4235">            ProcessInstanceMigrationValidationResult validationResult = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L4236">                    .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L4237">                    .validateMigration(processInstance.getId());</span>
    
<span class="nc" id="L4239">            assertThat(validationResult.isMigrationValid()).isTrue();</span>
    
            // Migrate process
<span class="nc" id="L4242">            ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L4243">                    .migrateToProcessDefinition(version2ProcessDef.getId());</span>
<span class="nc" id="L4244">            ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L4245">            assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>
    
<span class="nc" id="L4247">            processInstanceMigrationBuilder.migrate(processInstance.getId());</span>
    
<span class="nc" id="L4249">            List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().list();</span>
<span class="nc" id="L4250">            assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L4251">            executions.stream()</span>
<span class="nc" id="L4252">                    .map(e -&gt; (ExecutionEntity) e)</span>
<span class="nc" id="L4253">                    .forEach(e -&gt; assertThat(e.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId()));</span>
    
<span class="nc" id="L4255">            List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L4256">            assertThat(tasks)</span>
<span class="nc" id="L4257">                    .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L4258">                    .containsExactly(tuple(version2ProcessDef.getId(), &quot;userTask1Id&quot;)); //AutoMapped by Id</span>
    
            // The first process version only had one activity, there should be a second activity in the process now
<span class="nc" id="L4261">            taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L4262">            tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L4263">            assertThat(tasks)</span>
<span class="nc" id="L4264">                    .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L4265">                    .containsExactly(&quot;userTask2Id&quot;);</span>
<span class="nc" id="L4266">            taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L4267">            assertProcessEnded(processInstance.getId());</span>
            
        } finally {
<span class="nc" id="L4270">            processEngineConfiguration.setFallbackToDefaultTenant(false);</span>
<span class="nc" id="L4271">            processEngineConfiguration.setDefaultTenantProvider(originalDefaultTenantValue);</span>
        }
<span class="nc" id="L4273">    }</span>
    
    @Test
    public void testMultiTenantProcessInstanceMigrationWithTargetDefaultTenantDefinition() {
<span class="nc" id="L4277">        DefaultTenantProvider originalDefaultTenantValue = processEngineConfiguration.getDefaultTenantProvider();</span>
<span class="nc" id="L4278">        processEngineConfiguration.setDefaultTenantValue(&quot;default&quot;);</span>
<span class="nc" id="L4279">        processEngineConfiguration.setFallbackToDefaultTenant(true);</span>
        
        try {
            // Deploy first version of the process
<span class="nc" id="L4283">            Deployment deployment = repositoryService.createDeployment()</span>
<span class="nc" id="L4284">                    .name(&quot;my deploy&quot;)</span>
<span class="nc" id="L4285">                    .addClasspathResource(&quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;)</span>
<span class="nc" id="L4286">                    .tenantId(&quot;tenant1&quot;)</span>
<span class="nc" id="L4287">                    .deploy();</span>
            
<span class="nc" id="L4289">            ProcessDefinition version1ProcessDef = repositoryService.createProcessDefinitionQuery()</span>
<span class="nc" id="L4290">                    .deploymentId(deployment.getId()).singleResult();</span>
    
            // Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L4293">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKeyAndTenantId(&quot;MP&quot;, &quot;tenant1&quot;);</span>
    
            // Deploy second version of the process in default tenant
<span class="nc" id="L4296">            deployment = repositoryService.createDeployment()</span>
<span class="nc" id="L4297">                    .name(&quot;my deploy&quot;)</span>
<span class="nc" id="L4298">                    .addClasspathResource(&quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;)</span>
<span class="nc" id="L4299">                    .tenantId(&quot;default&quot;)</span>
<span class="nc" id="L4300">                    .deploy();</span>
                
<span class="nc" id="L4302">            ProcessDefinition version2ProcessDef = repositoryService.createProcessDefinitionQuery()</span>
<span class="nc" id="L4303">                    .deploymentId(deployment.getId()).singleResult();</span>
    
<span class="nc" id="L4305">            List&lt;ProcessDefinition&gt; processDefinitions = repositoryService.createProcessDefinitionQuery()</span>
<span class="nc" id="L4306">                    .processDefinitionKey(&quot;MP&quot;)</span>
<span class="nc" id="L4307">                    .list();</span>
    
<span class="nc" id="L4309">            assertThat(processDefinitions)</span>
<span class="nc" id="L4310">                    .extracting(ProcessDefinition::getId)</span>
<span class="nc" id="L4311">                    .containsExactlyInAnyOrder(version1ProcessDef.getId(), version2ProcessDef.getId());</span>
    
<span class="nc" id="L4313">            ProcessInstanceMigrationValidationResult validationResult = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L4314">                    .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L4315">                    .validateMigration(processInstance.getId());</span>
    
<span class="nc" id="L4317">            assertThat(validationResult.isMigrationValid()).isTrue();</span>
    
            // Migrate process
<span class="nc" id="L4320">            ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L4321">                    .migrateToProcessDefinition(version2ProcessDef.getId());</span>
<span class="nc" id="L4322">            ProcessInstanceMigrationValidationResult processInstanceMigrationResult = processInstanceMigrationBuilder.validateMigration(processInstance.getId());</span>
<span class="nc" id="L4323">            assertThat(processInstanceMigrationResult.isMigrationValid()).isTrue();</span>
    
<span class="nc" id="L4325">            processInstanceMigrationBuilder.migrate(processInstance.getId());</span>
    
<span class="nc" id="L4327">            List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().list();</span>
<span class="nc" id="L4328">            assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L4329">            executions.stream()</span>
<span class="nc" id="L4330">                    .map(e -&gt; (ExecutionEntity) e)</span>
<span class="nc" id="L4331">                    .forEach(e -&gt; assertThat(e.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId()));</span>
    
<span class="nc" id="L4333">            List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L4334">            assertThat(tasks)</span>
<span class="nc" id="L4335">                    .extracting(Task::getProcessDefinitionId, Task::getTaskDefinitionKey)</span>
<span class="nc" id="L4336">                    .containsExactly(tuple(version2ProcessDef.getId(), &quot;userTask1Id&quot;)); //AutoMapped by Id</span>
    
            // The first process version only had one activity, there should be a second activity in the process now
<span class="nc" id="L4339">            taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L4340">            tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L4341">            assertThat(tasks)</span>
<span class="nc" id="L4342">                    .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L4343">                    .containsExactly(&quot;userTask2Id&quot;);</span>
<span class="nc" id="L4344">            taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L4345">            assertProcessEnded(processInstance.getId());</span>
            
        } finally {
<span class="nc" id="L4348">            processEngineConfiguration.setFallbackToDefaultTenant(false);</span>
<span class="nc" id="L4349">            processEngineConfiguration.setDefaultTenantProvider(originalDefaultTenantValue);</span>
        }
<span class="nc" id="L4351">    }</span>
    
    @Test
    public void testMultiTenantProcessInstanceMigrationWithDefaultTenantDefinitionFailsWithNoFallback() {
<span class="nc" id="L4355">        DefaultTenantProvider originalDefaultTenantValue = processEngineConfiguration.getDefaultTenantProvider();</span>
<span class="nc" id="L4356">        processEngineConfiguration.setDefaultTenantValue(&quot;default&quot;);</span>
        
        try {
            // Deploy first version of the process
<span class="nc" id="L4360">            Deployment deployment = repositoryService.createDeployment()</span>
<span class="nc" id="L4361">                    .name(&quot;my deploy&quot;)</span>
<span class="nc" id="L4362">                    .addClasspathResource(&quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;)</span>
<span class="nc" id="L4363">                    .tenantId(&quot;tenant1&quot;)</span>
<span class="nc" id="L4364">                    .deploy();</span>
            
<span class="nc" id="L4366">            ProcessDefinition version1ProcessDef = repositoryService.createProcessDefinitionQuery()</span>
<span class="nc" id="L4367">                    .deploymentId(deployment.getId()).singleResult();</span>
    
            // Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L4370">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKeyAndTenantId(&quot;MP&quot;, &quot;tenant1&quot;);</span>
    
            // Deploy second version of the process in default tenant
<span class="nc" id="L4373">            deployment = repositoryService.createDeployment()</span>
<span class="nc" id="L4374">                    .name(&quot;my deploy&quot;)</span>
<span class="nc" id="L4375">                    .addClasspathResource(&quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;)</span>
<span class="nc" id="L4376">                    .tenantId(&quot;default&quot;)</span>
<span class="nc" id="L4377">                    .deploy();</span>
                
<span class="nc" id="L4379">            ProcessDefinition version2ProcessDef = repositoryService.createProcessDefinitionQuery()</span>
<span class="nc" id="L4380">                    .deploymentId(deployment.getId()).singleResult();</span>
    
<span class="nc" id="L4382">            ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L4383">                    .migrateToProcessDefinition(version2ProcessDef.getId());</span>
            
<span class="nc" id="L4385">            assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L4386">                processInstanceMigrationBuilder.migrate(processInstance.getId());</span>
<span class="nc" id="L4387">            }).isInstanceOf(FlowableException.class).hasMessage(&quot;Tenant mismatch between Process Instance ('tenant1') and Process Definition ('default') to migrate to&quot;);</span>
    
<span class="nc" id="L4389">            List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().list();</span>
<span class="nc" id="L4390">            assertThat(executions).hasSize(2); //includes root execution</span>
<span class="nc" id="L4391">            executions.stream()</span>
<span class="nc" id="L4392">                    .map(e -&gt; (ExecutionEntity) e)</span>
<span class="nc" id="L4393">                    .forEach(e -&gt; assertThat(e.getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId()));</span>
            
        } finally {
<span class="nc" id="L4396">            processEngineConfiguration.setDefaultTenantProvider(originalDefaultTenantValue);</span>
        }
<span class="nc" id="L4398">    }</span>

    @Test
    public void testTaskNameExpression() {
<span class="nc" id="L4402">        ProcessDefinition version1ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-rename.bpmn20.xml&quot;);
<span class="nc" id="L4404">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-rename-v2.bpmn20.xml&quot;);
<span class="nc" id="L4406">        ProcessDefinition version3ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-rename-v3.bpmn20.xml&quot;);

<span class="nc" id="L4409">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L4410">        variables.put(&quot;myVar1&quot;, &quot;foo&quot;);</span>
<span class="nc" id="L4411">        variables.put(&quot;myVar2&quot;, &quot;bar&quot;);</span>

        // Task name and description contains a variable (myVar1)
<span class="nc" id="L4414">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(version1ProcessDef.getId(), variables);</span>
<span class="nc" id="L4415">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L4416">        assertThat(task.getName()).isEqualTo(&quot;User Task: foo&quot;);</span>
<span class="nc" id="L4417">        assertThat(task.getDescription()).isEqualTo(&quot;Description: foo&quot;);</span>

        // Task name and description contains a variable (myVar2)
<span class="nc" id="L4420">        processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L4421">                .migrateToProcessDefinition(version2ProcessDef.getId())</span>
<span class="nc" id="L4422">                .migrate(processInstance.getId());</span>

<span class="nc" id="L4424">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L4425">        assertThat(task.getName()).isEqualTo(&quot;User Task: bar&quot;);</span>
<span class="nc" id="L4426">        assertThat(task.getDescription()).isEqualTo(&quot;Description: bar&quot;);</span>

        // Task name and description is null
<span class="nc" id="L4429">        processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L4430">                .migrateToProcessDefinition(version3ProcessDef.getId())</span>
<span class="nc" id="L4431">                .migrate(processInstance.getId());</span>

<span class="nc" id="L4433">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L4434">        assertThat(task.getName()).isNull();</span>
<span class="nc" id="L4435">        assertThat(task.getDescription()).isNull();</span>
<span class="nc" id="L4436">    }</span>

    @Test
    public void preUpgradeScriptMigration() {
        //Deploy first version of the process
<span class="nc" id="L4441">        deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/runtime/migration/serializable-variable-process.bpmn20.xml&quot;);</span>

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L4444">        ProcessInstance processInstanceToMigrate = runtimeService.startProcessInstanceByKey(&quot;MP&quot;, Collections.singletonMap(&quot;listVariable&quot;, new ArrayList()));</span>
<span class="nc" id="L4445">        Execution execution = runtimeService.createExecutionQuery().processInstanceId(processInstanceToMigrate.getId()).onlyChildExecutions().singleResult();</span>
<span class="nc" id="L4446">        runtimeService.trigger(execution.getId());</span>

<span class="nc" id="L4448">        assertThat((List) runtimeService.getVariable(processInstanceToMigrate.getId(), &quot;listVariable&quot;)).contains(&quot;new value&quot;);</span>

<span class="nc" id="L4450">        ProcessDefinition targetProcessDefinition = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/json-variable-process.bpmn20.xml&quot;);

<span class="nc" id="L4453">        processMigrationService.createProcessInstanceMigrationBuilder().preUpgradeScript(new Script(&quot;groovy&quot;,</span>
                        &quot;&quot;&quot;
                                import com.fasterxml.jackson.databind.ObjectMapper
                                import com.fasterxml.jackson.databind.node.ArrayNode
                                import org.flowable.engine.impl.context.Context

                                List&lt;String&gt; list  = execution.getVariable('listVariable')

                                ObjectMapper mapper = Context.getProcessEngineConfiguration().getObjectMapper()

                                ArrayNode jsonArray = mapper.createArrayNode()
                                list.each {jsonArray.add(it)}

                                execution.setVariable(&quot;listVariable&quot;, jsonArray)&quot;&quot;&quot;))
<span class="nc" id="L4467">                .migrateToProcessDefinition(targetProcessDefinition.getId())</span>
<span class="nc" id="L4468">                .migrate(processInstanceToMigrate.getId());</span>

<span class="nc" id="L4470">        assertThatProcessVariableConverted(processInstanceToMigrate, execution);</span>

<span class="nc bnc" id="L4472" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>
            // serializable - when starting the process instance
            // serializable - when triggering the received task (the value is updated so new detail is created)
            // json - when doing the migration new variable is set
            // json - when triggering the received task (the value is updated so new details is created 
<span class="nc" id="L4477">            assertThatVariablesTypeHistoryIs(processInstanceToMigrate, &quot;serializable&quot;, &quot;serializable&quot;, &quot;json&quot;, &quot;json&quot;);</span>
        }
<span class="nc" id="L4479">    }</span>

    @Test
    public void preUpgradeJavaDelegate() {
        //Deploy first version of the process
<span class="nc" id="L4484">        deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/runtime/migration/serializable-variable-process.bpmn20.xml&quot;);</span>

<span class="nc" id="L4486">        ProcessInstance processInstanceToMigrate = runtimeService.startProcessInstanceByKey(&quot;MP&quot;, Collections.singletonMap(&quot;listVariable&quot;, new ArrayList()));</span>
<span class="nc" id="L4487">        Execution execution = runtimeService.createExecutionQuery().processInstanceId(processInstanceToMigrate.getId()).onlyChildExecutions().singleResult();</span>
<span class="nc" id="L4488">        runtimeService.trigger(execution.getId());</span>

<span class="nc" id="L4490">        assertThat((List) runtimeService.getVariable(processInstanceToMigrate.getId(), &quot;listVariable&quot;)).contains(&quot;new value&quot;);</span>

<span class="nc" id="L4492">        ProcessDefinition targetProcessDefinition = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/json-variable-process.bpmn20.xml&quot;);

<span class="nc" id="L4495">        processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L4496">                .preUpgradeJavaDelegate(&quot;org.flowable.engine.test.api.runtime.migration.ConvertProcessVariable&quot;)</span>
<span class="nc" id="L4497">                .migrateToProcessDefinition(targetProcessDefinition.getId())</span>
<span class="nc" id="L4498">                .migrate(processInstanceToMigrate.getId());</span>

<span class="nc" id="L4500">        assertThatProcessVariableConverted(processInstanceToMigrate, execution);</span>

<span class="nc bnc" id="L4502" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>
            // serializable - when starting the process instance
            // serializable - when triggering the received task (the value is updated so new detail is created)
            // json - when doing the migration new variable is set
            // json - when triggering the received task (the value is updated so new details is created
<span class="nc" id="L4507">            assertThatVariablesTypeHistoryIs(processInstanceToMigrate, &quot;serializable&quot;, &quot;serializable&quot;, &quot;json&quot;, &quot;json&quot;);</span>
        }
<span class="nc" id="L4509">    }</span>

    @Test
    public void preUpgradeJavaDelegateExpression() {
        //Deploy first version of the process
<span class="nc" id="L4514">        deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/runtime/migration/serializable-variable-process.bpmn20.xml&quot;);</span>

<span class="nc" id="L4516">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L4517">        variables.put(&quot;listVariable&quot;, new ArrayList());</span>
<span class="nc" id="L4518">        variables.put(&quot;convertProcessVariable&quot;, new ConvertProcessVariable()); // using instead of beans. Not nice, but it uses similar resolver as beans</span>
<span class="nc" id="L4519">        ProcessInstance processInstanceToMigrate = runtimeService</span>
<span class="nc" id="L4520">                .startProcessInstanceByKey(&quot;MP&quot;, variables);</span>
<span class="nc" id="L4521">        Execution execution = runtimeService.createExecutionQuery().processInstanceId(processInstanceToMigrate.getId()).onlyChildExecutions()</span>
<span class="nc" id="L4522">                .singleResult();</span>
<span class="nc" id="L4523">        runtimeService.trigger(execution.getId());</span>

<span class="nc" id="L4525">        assertThat((List) runtimeService.getVariable(processInstanceToMigrate.getId(), &quot;listVariable&quot;)).contains(&quot;new value&quot;);</span>

<span class="nc" id="L4527">        ProcessDefinition targetProcessDefinition = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/json-variable-process.bpmn20.xml&quot;);

<span class="nc" id="L4530">        processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L4531">                .preUpgradeJavaDelegateExpression(&quot;${convertProcessVariable}&quot;)</span>
<span class="nc" id="L4532">                .migrateToProcessDefinition(targetProcessDefinition.getId())</span>
<span class="nc" id="L4533">                .migrate(processInstanceToMigrate.getId());</span>

<span class="nc" id="L4535">        assertThatProcessVariableConverted(processInstanceToMigrate, execution);</span>

<span class="nc bnc" id="L4537" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>
            // serializable - when starting the process instance (listVariable)
            // serializable - when starting the process instance (convertProcessVariable)
            // serializable - when triggering the received task (the value is updated so new detail is created)
            // json - when doing the migration new variable is set
            // json - when triggering the received task (the value is updated so new details is created
<span class="nc" id="L4543">            assertThatVariablesTypeHistoryIs(processInstanceToMigrate, &quot;serializable&quot;, &quot;serializable&quot;, &quot;serializable&quot;, &quot;json&quot;, &quot;json&quot;);</span>
        }
<span class="nc" id="L4545">    }</span>

    @Test
    public void postUpgradeScriptMigration() {
        //Deploy first version of the process
<span class="nc" id="L4550">        deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/runtime/migration/serializable-variable-process.bpmn20.xml&quot;);</span>

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L4553">        ProcessInstance processInstanceToMigrate = runtimeService.startProcessInstanceByKey(&quot;MP&quot;, Collections.singletonMap(&quot;listVariable&quot;, new ArrayList()));</span>
<span class="nc" id="L4554">        Execution execution = runtimeService.createExecutionQuery().processInstanceId(processInstanceToMigrate.getId()).onlyChildExecutions().singleResult();</span>
<span class="nc" id="L4555">        runtimeService.trigger(execution.getId());</span>

<span class="nc" id="L4557">        assertThat((List) runtimeService.getVariable(processInstanceToMigrate.getId(), &quot;listVariable&quot;)).contains(&quot;new value&quot;);</span>

<span class="nc" id="L4559">        ProcessDefinition targetProcessDefinition = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/json-variable-process.bpmn20.xml&quot;);

<span class="nc" id="L4562">        processMigrationService.createProcessInstanceMigrationBuilder().postUpgradeScript(new Script(&quot;groovy&quot;,</span>
                        &quot;&quot;&quot;
                                import com.fasterxml.jackson.databind.ObjectMapper
                                import com.fasterxml.jackson.databind.node.ArrayNode
                                import org.flowable.engine.impl.context.Context

                                List&lt;String&gt; list  = execution.getVariable('listVariable')

                                ObjectMapper mapper = Context.getProcessEngineConfiguration().getObjectMapper()

                                ArrayNode jsonArray = mapper.createArrayNode()
                                list.each {jsonArray.add(it)}

                                execution.setVariable(&quot;listVariable&quot;, jsonArray)&quot;&quot;&quot;))
<span class="nc" id="L4576">                .migrateToProcessDefinition(targetProcessDefinition.getId())</span>
<span class="nc" id="L4577">                .migrate(processInstanceToMigrate.getId());</span>

<span class="nc" id="L4579">        assertThatProcessVariableConverted(processInstanceToMigrate, execution);</span>

<span class="nc bnc" id="L4581" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>
            // serializable - when starting the process instance
            // serializable - when triggering the received task (the value is updated so new detail is created)
            // json - when doing the migration new variable is set
            // json - when triggering the received task (the value is updated so new details is created
<span class="nc" id="L4586">            assertThatVariablesTypeHistoryIs(processInstanceToMigrate, &quot;serializable&quot;, &quot;serializable&quot;, &quot;json&quot;, &quot;json&quot;);</span>
        }
<span class="nc" id="L4588">    }</span>

    @Test
    public void postUpgradeJavaDelegate() {
        //Deploy first version of the process
<span class="nc" id="L4593">        deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/runtime/migration/serializable-variable-process.bpmn20.xml&quot;);</span>

<span class="nc" id="L4595">        ProcessInstance processInstanceToMigrate = runtimeService.startProcessInstanceByKey(&quot;MP&quot;, Collections.singletonMap(&quot;listVariable&quot;, new ArrayList()));</span>
<span class="nc" id="L4596">        Execution execution = runtimeService.createExecutionQuery().processInstanceId(processInstanceToMigrate.getId()).onlyChildExecutions().singleResult();</span>
<span class="nc" id="L4597">        runtimeService.trigger(execution.getId());</span>

<span class="nc" id="L4599">        assertThat((List) runtimeService.getVariable(processInstanceToMigrate.getId(), &quot;listVariable&quot;)).contains(&quot;new value&quot;);</span>

<span class="nc" id="L4601">        ProcessDefinition targetProcessDefinition = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/json-variable-process.bpmn20.xml&quot;);

<span class="nc" id="L4604">        processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L4605">                .postUpgradeJavaDelegate(&quot;org.flowable.engine.test.api.runtime.migration.ConvertProcessVariable&quot;)</span>
<span class="nc" id="L4606">                .migrateToProcessDefinition(targetProcessDefinition.getId())</span>
<span class="nc" id="L4607">                .migrate(processInstanceToMigrate.getId());</span>

<span class="nc" id="L4609">        assertThatProcessVariableConverted(processInstanceToMigrate, execution);</span>

<span class="nc bnc" id="L4611" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>
            // serializable - when starting the process instance
            // serializable - when triggering the received task (the value is updated so new detail is created)
            // json - when doing the migration new variable is set
            // json - when triggering the received task (the value is updated so new details is created
<span class="nc" id="L4616">            assertThatVariablesTypeHistoryIs(processInstanceToMigrate, &quot;serializable&quot;, &quot;serializable&quot;, &quot;json&quot;, &quot;json&quot;);</span>
        }
<span class="nc" id="L4618">    }</span>

    @Test
    public void postUpgradeJavaDelegateExpression() {
        //Deploy first version of the process
<span class="nc" id="L4623">        deployProcessDefinition(&quot;my deploy&quot;, &quot;org/flowable/engine/test/api/runtime/migration/serializable-variable-process.bpmn20.xml&quot;);</span>

<span class="nc" id="L4625">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L4626">        variables.put(&quot;listVariable&quot;, new ArrayList());</span>
<span class="nc" id="L4627">        variables.put(&quot;convertProcessVariable&quot;, new ConvertProcessVariable()); // using instead of beans. Not nice, but it uses similar resolver as beans</span>
<span class="nc" id="L4628">        ProcessInstance processInstanceToMigrate = runtimeService</span>
<span class="nc" id="L4629">                .startProcessInstanceByKey(&quot;MP&quot;, variables);</span>
<span class="nc" id="L4630">        Execution execution = runtimeService.createExecutionQuery().processInstanceId(processInstanceToMigrate.getId()).onlyChildExecutions()</span>
<span class="nc" id="L4631">                .singleResult();</span>
<span class="nc" id="L4632">        runtimeService.trigger(execution.getId());</span>

<span class="nc" id="L4634">        assertThat((List) runtimeService.getVariable(processInstanceToMigrate.getId(), &quot;listVariable&quot;)).contains(&quot;new value&quot;);</span>

<span class="nc" id="L4636">        ProcessDefinition targetProcessDefinition = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/json-variable-process.bpmn20.xml&quot;);

<span class="nc" id="L4639">        processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L4640">                .postUpgradeJavaDelegateExpression(&quot;${convertProcessVariable}&quot;)</span>
<span class="nc" id="L4641">                .migrateToProcessDefinition(targetProcessDefinition.getId())</span>
<span class="nc" id="L4642">                .migrate(processInstanceToMigrate.getId());</span>

<span class="nc" id="L4644">        assertThatProcessVariableConverted(processInstanceToMigrate, execution);</span>

<span class="nc bnc" id="L4646" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>
<span class="nc" id="L4647">            assertThatVariablesTypeHistoryIs(processInstanceToMigrate, &quot;serializable&quot;, &quot;serializable&quot;, &quot;serializable&quot;, &quot;json&quot;, &quot;json&quot;);</span>
        }

<span class="nc" id="L4650">    }</span>

    private void assertThatVariablesTypeHistoryIs(ProcessInstance processInstanceToMigrate, String... values) {
<span class="nc" id="L4653">        List&lt;HistoricDetail&gt; updateList = historyService.createHistoricDetailQuery().processInstanceId(processInstanceToMigrate.getId()).variableUpdates()</span>
<span class="nc" id="L4654">                .list();</span>

<span class="nc" id="L4656">        updateList.sort(Comparator.comparingInt(histDetail -&gt; Integer.parseInt(histDetail.getId())));</span>
<span class="nc" id="L4657">        assertThat(updateList)</span>
<span class="nc" id="L4658">                .extracting(historicDetail -&gt; ((HistoricDetailVariableInstanceUpdateEntity) historicDetail).getVariableType().getTypeName())</span>
<span class="nc" id="L4659">                .containsExactly(values);</span>
<span class="nc" id="L4660">    }</span>

    private void assertThatProcessVariableConverted(ProcessInstance processInstanceToMigrate, Execution execution) {
<span class="nc" id="L4663">        assertThat((ArrayNode) runtimeService.getVariable(processInstanceToMigrate.getId(), &quot;listVariable&quot;))</span>
<span class="nc" id="L4664">                .extracting(jsonNode -&gt; jsonNode.asText())</span>
<span class="nc" id="L4665">                .containsExactly(&quot;new value&quot;);</span>

<span class="nc" id="L4667">        runtimeService.trigger(execution.getId());</span>

<span class="nc" id="L4669">        assertThat((ArrayNode) runtimeService.getVariable(processInstanceToMigrate.getId(), &quot;listVariable&quot;))</span>
<span class="nc" id="L4670">                .extracting(jsonNode -&gt; jsonNode.asText())</span>
<span class="nc" id="L4671">                .containsExactly(&quot;new value&quot;, &quot;new value 2&quot;);</span>

<span class="nc" id="L4673">        runtimeService.trigger(execution.getId());</span>

<span class="nc" id="L4675">        assertProcessEnded(processInstanceToMigrate.getId());</span>
<span class="nc" id="L4676">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>