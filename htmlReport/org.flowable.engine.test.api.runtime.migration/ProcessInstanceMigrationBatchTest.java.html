<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProcessInstanceMigrationBatchTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.runtime.migration</a> &gt; <span class="el_source">ProcessInstanceMigrationBatchTest.java</span></div><h1>ProcessInstanceMigrationBatchTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.engine.test.api.runtime.migration;

import static org.assertj.core.api.Assertions.assertThat;

import java.util.ArrayList;
import java.util.Comparator;
import java.util.Date;
import java.util.List;

import org.flowable.batch.api.Batch;
import org.flowable.batch.api.BatchPart;
import org.flowable.common.engine.api.scope.ScopeTypes;
import org.flowable.engine.impl.jobexecutor.ProcessInstanceMigrationStatusJobHandler;
import org.flowable.engine.impl.persistence.entity.ExecutionEntity;
import org.flowable.engine.impl.test.JobTestHelper;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.migration.ProcessInstanceBatchMigrationPartResult;
import org.flowable.engine.migration.ProcessInstanceBatchMigrationResult;
import org.flowable.engine.migration.ProcessInstanceMigrationBuilder;
import org.flowable.engine.repository.ProcessDefinition;
import org.flowable.engine.runtime.Execution;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.api.runtime.changestate.ChangeStateEventListener;
import org.flowable.job.api.Job;
import org.flowable.task.api.Task;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

<span class="nc" id="L55">public class ProcessInstanceMigrationBatchTest extends PluggableFlowableTestCase {</span>

<span class="nc" id="L57">    private ChangeStateEventListener changeStateEventListener = new ChangeStateEventListener();</span>

    @BeforeEach
    protected void setUp() {
<span class="nc" id="L61">        processEngine.getRuntimeService().addEventListener(changeStateEventListener);</span>
<span class="nc" id="L62">    }</span>

    @AfterEach
    protected void tearDown() {
<span class="nc" id="L66">        processEngine.getRuntimeService().removeEventListener(changeStateEventListener);</span>
<span class="nc" id="L67">        List&lt;Batch&gt; batches = processEngine.getManagementService().getAllBatches();</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">        for (Batch batch : batches) {</span>
<span class="nc" id="L69">            processEngine.getManagementService().deleteBatch(batch.getId());</span>
<span class="nc" id="L70">        }</span>
<span class="nc" id="L71">        deleteDeployments();</span>
<span class="nc" id="L72">    }</span>

    @Test
    public void testProcessMigrationBatchMissingMapping() {
        // Deploy first version of the process
<span class="nc" id="L77">        ProcessDefinition version1ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;);

        // Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L81">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>
<span class="nc" id="L82">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>

<span class="nc" id="L84">        Task task = taskService.createTaskQuery().processInstanceId(processInstance1.getId()).singleResult();</span>
<span class="nc" id="L85">        completeTask(task);</span>
<span class="nc" id="L86">        task = taskService.createTaskQuery().processInstanceId(processInstance2.getId()).singleResult();</span>
<span class="nc" id="L87">        completeTask(task);</span>

<span class="nc" id="L89">        task = taskService.createTaskQuery().processInstanceId(processInstance1.getId()).singleResult();</span>
<span class="nc" id="L90">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;userTask2Id&quot;);</span>
<span class="nc" id="L91">        assertThat(task.getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId());</span>
<span class="nc" id="L92">        task = taskService.createTaskQuery().processInstanceId(processInstance2.getId()).singleResult();</span>
<span class="nc" id="L93">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;userTask2Id&quot;);</span>
<span class="nc" id="L94">        assertThat(task.getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId());</span>

        // Deploy second version of the process
<span class="nc" id="L97">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);

<span class="nc" id="L100">        List&lt;ProcessDefinition&gt; processDefinitions = repositoryService.createProcessDefinitionQuery()</span>
<span class="nc" id="L101">                .processDefinitionKey(&quot;MP&quot;)</span>
<span class="nc" id="L102">                .list();</span>

<span class="nc" id="L104">        processDefinitions.sort(Comparator.comparingInt(ProcessDefinition::getVersion));</span>
<span class="nc" id="L105">        assertThat(processDefinitions)</span>
<span class="nc" id="L106">                .extracting(ProcessDefinition::getId)</span>
<span class="nc" id="L107">                .containsExactly(version1ProcessDef.getId(), version2ProcessDef.getId());</span>

        // Prepare the process Instance migration builder as usual
<span class="nc" id="L110">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L111">                .migrateToProcessDefinition(version2ProcessDef.getId());</span>

        // Try batch migrate the process instances
<span class="nc" id="L114">        Batch migrationBatch = processInstanceMigrationBuilder.batchMigrateProcessInstances(version1ProcessDef.getId());</span>
<span class="nc" id="L115">        assertThat(JobTestHelper.areJobsAvailable(managementService)).isTrue();</span>

        // Confirm the batch is not finished
<span class="nc" id="L118">        ProcessInstanceBatchMigrationResult migrationResult = processMigrationService.getResultsOfBatchProcessInstanceMigration(migrationBatch.getId());</span>

        // Partial Results
<span class="nc" id="L121">        assertThat(migrationResult).isNotNull();</span>
<span class="nc" id="L122">        assertThat(migrationResult.getBatchId()).isEqualTo(migrationBatch.getId());</span>
<span class="nc" id="L123">        assertThat(migrationResult.getStatus()).isEqualTo(ProcessInstanceBatchMigrationResult.STATUS_IN_PROGRESS);</span>
<span class="nc" id="L124">        assertThat(migrationResult.getCompleteTime()).isNull();</span>
<span class="nc" id="L125">        assertThat(migrationResult.getAllMigrationParts()).hasSize(2);</span>
<span class="nc" id="L126">        assertThat(migrationResult.getWaitingMigrationParts()).hasSize(2);</span>
<span class="nc" id="L127">        assertThat(migrationResult.getSuccessfulMigrationParts()).isEmpty();</span>
<span class="nc" id="L128">        assertThat(migrationResult.getFailedMigrationParts()).isEmpty();</span>

<span class="nc bnc" id="L130" title="All 2 branches missed.">        for (ProcessInstanceBatchMigrationPartResult part : migrationResult.getAllMigrationParts()) {</span>
<span class="nc" id="L131">            assertThat(part.getStatus()).isEqualTo(ProcessInstanceBatchMigrationResult.STATUS_WAITING);</span>
<span class="nc" id="L132">            assertThat(part.getResult()).isEqualTo(ProcessInstanceBatchMigrationResult.STATUS_WAITING);</span>
<span class="nc" id="L133">        }</span>

        // Start async executor to process the batches
<span class="nc" id="L136">        JobTestHelper.waitForJobExecutorToProcessAllJobs(processEngineConfiguration, managementService, 1000L, 500L, true);</span>
<span class="nc" id="L137">        assertThat(JobTestHelper.areJobsAvailable(managementService)).isFalse();</span>

<span class="nc" id="L139">        List&lt;Job&gt; timerJobs = managementService.createTimerJobQuery().handlerType(ProcessInstanceMigrationStatusJobHandler.TYPE).list();</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">        for (Job timerJob : timerJobs) {</span>
<span class="nc" id="L141">            Job executableJob = managementService.moveTimerToExecutableJob(timerJob.getId());</span>
<span class="nc" id="L142">            managementService.executeJob(executableJob.getId());</span>
<span class="nc" id="L143">        }</span>

        // Confirm the batches have ended
<span class="nc" id="L146">        migrationResult = processMigrationService.getResultsOfBatchProcessInstanceMigration(migrationBatch.getId());</span>
<span class="nc" id="L147">        assertThat(migrationResult).isNotNull();</span>

<span class="nc" id="L149">        assertThat(migrationResult.getBatchId()).isEqualTo(migrationBatch.getId());</span>
<span class="nc" id="L150">        assertThat(migrationResult.getStatus()).isEqualTo(ProcessInstanceBatchMigrationResult.STATUS_COMPLETED);</span>
<span class="nc" id="L151">        assertThat(migrationResult.getCompleteTime()).isNotNull();</span>
<span class="nc" id="L152">        assertThat(migrationResult.getAllMigrationParts()).hasSize(2);</span>
<span class="nc" id="L153">        assertThat(migrationResult.getWaitingMigrationParts()).isEmpty();</span>
<span class="nc" id="L154">        assertThat(migrationResult.getSuccessfulMigrationParts()).isEmpty();</span>
<span class="nc" id="L155">        assertThat(migrationResult.getFailedMigrationParts()).hasSize(2);</span>

<span class="nc bnc" id="L157" title="All 2 branches missed.">        for (ProcessInstanceBatchMigrationPartResult part : migrationResult.getAllMigrationParts()) {</span>
<span class="nc" id="L158">            assertThat(part.getStatus()).isEqualTo(ProcessInstanceBatchMigrationResult.STATUS_COMPLETED);</span>
<span class="nc" id="L159">            assertThat(part.getResult()).isEqualTo(ProcessInstanceBatchMigrationResult.RESULT_FAIL);</span>
<span class="nc" id="L160">            assertThat(part.getMigrationMessage()).isEqualTo(&quot;Migration Activity mapping missing for activity definition Id:'userTask2Id' or its MI Parent&quot;);</span>
<span class="nc" id="L161">        }</span>

        // Confirm no migration happened
<span class="nc" id="L164">        task = taskService.createTaskQuery().processInstanceId(processInstance1.getId()).singleResult();</span>
<span class="nc" id="L165">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;userTask2Id&quot;);</span>
<span class="nc" id="L166">        assertThat(task.getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId());</span>
<span class="nc" id="L167">        List&lt;Execution&gt; childExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance1.getId()).list();</span>
<span class="nc" id="L168">        assertThat(childExecutions).hasSize(2);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">        for (Execution childExecution : childExecutions) {</span>
<span class="nc" id="L170">            assertThat(((ExecutionEntity) childExecution).getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId());</span>
<span class="nc" id="L171">        }</span>
        
<span class="nc" id="L173">        task = taskService.createTaskQuery().processInstanceId(processInstance2.getId()).singleResult();</span>
<span class="nc" id="L174">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;userTask2Id&quot;);</span>
<span class="nc" id="L175">        assertThat(task.getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId());</span>
<span class="nc" id="L176">        childExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance2.getId()).list();</span>
<span class="nc" id="L177">        assertThat(childExecutions).hasSize(2);</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">        for (Execution childExecution : childExecutions) {</span>
<span class="nc" id="L179">            assertThat(((ExecutionEntity) childExecution).getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId());</span>
<span class="nc" id="L180">        }</span>
        
<span class="nc" id="L182">        assertThat(managementService.createJobQuery().processInstanceId(processInstance1.getId()).list()).hasSize(0);</span>
<span class="nc" id="L183">        assertThat(managementService.createTimerJobQuery().processInstanceId(processInstance1.getId()).list()).hasSize(0);</span>
<span class="nc" id="L184">        assertThat(managementService.createDeadLetterJobQuery().processInstanceId(processInstance1.getId()).list()).hasSize(0);</span>
        
<span class="nc" id="L186">        assertThat(managementService.createJobQuery().processInstanceId(processInstance2.getId()).list()).hasSize(0);</span>
<span class="nc" id="L187">        assertThat(managementService.createTimerJobQuery().processInstanceId(processInstance2.getId()).list()).hasSize(0);</span>
<span class="nc" id="L188">        assertThat(managementService.createDeadLetterJobQuery().processInstanceId(processInstance2.getId()).list()).hasSize(0);</span>

<span class="nc" id="L190">        completeProcessInstanceTasks(processInstance1.getId());</span>
<span class="nc" id="L191">        completeProcessInstanceTasks(processInstance2.getId());</span>
<span class="nc" id="L192">        assertProcessEnded(processInstance1.getId());</span>
<span class="nc" id="L193">        assertProcessEnded(processInstance2.getId());</span>

<span class="nc" id="L195">        managementService.deleteBatch(migrationBatch.getId());</span>
<span class="nc" id="L196">    }</span>

    @Test
    public void testProcessMigrationBatchPartialMissingMapping() {
        // Deploy first version of the process
<span class="nc" id="L201">        ProcessDefinition version1ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;);

        //Start and instance of the recent first version of the process for migration and one for reference
<span class="nc" id="L205">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>
<span class="nc" id="L206">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;MP&quot;);</span>

<span class="nc" id="L208">        Task task = taskService.createTaskQuery().processInstanceId(processInstance1.getId()).singleResult();</span>
<span class="nc" id="L209">        completeTask(task);</span>

<span class="nc" id="L211">        task = taskService.createTaskQuery().processInstanceId(processInstance1.getId()).singleResult();</span>
<span class="nc" id="L212">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;userTask2Id&quot;);</span>
<span class="nc" id="L213">        assertThat(task.getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId());</span>
<span class="nc" id="L214">        task = taskService.createTaskQuery().processInstanceId(processInstance2.getId()).singleResult();</span>
<span class="nc" id="L215">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L216">        assertThat(task.getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId());</span>

        // Deploy second version of the process
<span class="nc" id="L219">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);

<span class="nc" id="L222">        List&lt;ProcessDefinition&gt; processDefinitions = repositoryService.createProcessDefinitionQuery()</span>
<span class="nc" id="L223">                .processDefinitionKey(&quot;MP&quot;)</span>
<span class="nc" id="L224">                .list();</span>

<span class="nc" id="L226">        assertThat(processDefinitions).hasSize(2);</span>
<span class="nc" id="L227">        processDefinitions.sort(Comparator.comparingInt(ProcessDefinition::getVersion));</span>

<span class="nc" id="L229">        assertThat(version1ProcessDef.getId()).isEqualTo(processDefinitions.get(0).getId());</span>
<span class="nc" id="L230">        assertThat(version2ProcessDef.getId()).isEqualTo(processDefinitions.get(1).getId());</span>

        // Prepare the process Instance migration builder as usual
<span class="nc" id="L233">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L234">                .migrateToProcessDefinition(version2ProcessDef.getId());</span>

        // Try batch migrate the process instances
<span class="nc" id="L237">        Batch migrationBatch = processInstanceMigrationBuilder.batchMigrateProcessInstances(version1ProcessDef.getId());</span>
<span class="nc" id="L238">        assertThat(JobTestHelper.areJobsAvailable(managementService)).isTrue();</span>

        //Confirm the batch is not finished
<span class="nc" id="L241">        ProcessInstanceBatchMigrationResult migrationResult = processMigrationService.getResultsOfBatchProcessInstanceMigration(migrationBatch.getId());</span>

        //Partial Results
<span class="nc" id="L244">        assertThat(migrationResult).isNotNull();</span>
<span class="nc" id="L245">        assertThat(migrationResult.getBatchId()).isEqualTo(migrationBatch.getId());</span>
<span class="nc" id="L246">        assertThat(migrationResult.getStatus()).isEqualTo(ProcessInstanceBatchMigrationResult.STATUS_IN_PROGRESS);</span>
<span class="nc" id="L247">        assertThat(migrationResult.getCompleteTime()).isNull();</span>
<span class="nc" id="L248">        assertThat(migrationResult.getAllMigrationParts()).hasSize(2);</span>
<span class="nc" id="L249">        assertThat(migrationResult.getWaitingMigrationParts()).hasSize(2);</span>
<span class="nc" id="L250">        assertThat(migrationResult.getSuccessfulMigrationParts()).isEmpty();</span>
<span class="nc" id="L251">        assertThat(migrationResult.getFailedMigrationParts()).isEmpty();</span>

<span class="nc bnc" id="L253" title="All 2 branches missed.">        for (ProcessInstanceBatchMigrationPartResult part : migrationResult.getAllMigrationParts()) {</span>
<span class="nc" id="L254">            assertThat(part.getStatus()).isEqualTo(ProcessInstanceBatchMigrationResult.STATUS_WAITING);</span>
<span class="nc" id="L255">            assertThat(part.getResult()).isEqualTo(ProcessInstanceBatchMigrationResult.STATUS_WAITING);</span>
<span class="nc" id="L256">        }</span>

        // Start async executor to process the batches
<span class="nc" id="L259">        JobTestHelper.waitForJobExecutorToProcessAllJobs(processEngineConfiguration, managementService, 5000L, 500L, true);</span>
<span class="nc" id="L260">        assertThat(JobTestHelper.areJobsAvailable(managementService)).isFalse();</span>

<span class="nc" id="L262">        List&lt;Job&gt; timerJobs = managementService.createTimerJobQuery().handlerType(ProcessInstanceMigrationStatusJobHandler.TYPE).list();</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">        for (Job timerJob : timerJobs) {</span>
<span class="nc" id="L264">            Job executableJob = managementService.moveTimerToExecutableJob(timerJob.getId());</span>
<span class="nc" id="L265">            managementService.executeJob(executableJob.getId());</span>
<span class="nc" id="L266">        }</span>

<span class="nc" id="L268">        migrationResult = processMigrationService.getResultsOfBatchProcessInstanceMigration(migrationBatch.getId());</span>
<span class="nc" id="L269">        assertThat(migrationResult).isNotNull();</span>

<span class="nc" id="L271">        assertThat(migrationResult.getBatchId()).isEqualTo(migrationBatch.getId());</span>
<span class="nc" id="L272">        assertThat(migrationResult.getStatus()).isEqualTo(ProcessInstanceBatchMigrationResult.STATUS_COMPLETED);</span>
<span class="nc" id="L273">        assertThat(migrationResult.getCompleteTime()).isNotNull();</span>
<span class="nc" id="L274">        assertThat(migrationResult.getAllMigrationParts()).hasSize(2);</span>
<span class="nc" id="L275">        assertThat(migrationResult.getWaitingMigrationParts()).isEmpty();</span>
<span class="nc" id="L276">        assertThat(migrationResult.getSuccessfulMigrationParts()).hasSize(1);</span>
<span class="nc" id="L277">        assertThat(migrationResult.getFailedMigrationParts()).hasSize(1);</span>

<span class="nc bnc" id="L279" title="All 2 branches missed.">        for (ProcessInstanceBatchMigrationPartResult part : migrationResult.getSuccessfulMigrationParts()) {</span>
<span class="nc" id="L280">            assertThat(part.getStatus()).isEqualTo(ProcessInstanceBatchMigrationResult.STATUS_COMPLETED);</span>
<span class="nc" id="L281">            assertThat(part.getResult()).isEqualTo(ProcessInstanceBatchMigrationResult.RESULT_SUCCESS);</span>
<span class="nc" id="L282">            assertThat(part.getMigrationMessage()).isNull();</span>
<span class="nc" id="L283">            assertThat(part.getMigrationStacktrace()).isNull();</span>
<span class="nc" id="L284">        }</span>

<span class="nc bnc" id="L286" title="All 2 branches missed.">        for (ProcessInstanceBatchMigrationPartResult part : migrationResult.getFailedMigrationParts()) {</span>
<span class="nc" id="L287">            assertThat(part.getStatus()).isEqualTo(ProcessInstanceBatchMigrationResult.STATUS_COMPLETED);</span>
<span class="nc" id="L288">            assertThat(part.getResult()).isEqualTo(ProcessInstanceBatchMigrationResult.RESULT_FAIL);</span>
<span class="nc" id="L289">            assertThat(part.getMigrationMessage()).isEqualTo(&quot;Migration Activity mapping missing for activity definition Id:'userTask2Id' or its MI Parent&quot;);</span>
<span class="nc" id="L290">            assertThat(part.getMigrationStacktrace()).contains(&quot;Migration Activity mapping missing&quot;);</span>
<span class="nc" id="L291">        }</span>

        // Confirm the migration
<span class="nc" id="L294">        task = taskService.createTaskQuery().processInstanceId(processInstance1.getId()).singleResult();</span>
<span class="nc" id="L295">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;userTask2Id&quot;);</span>
<span class="nc" id="L296">        assertThat(task.getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId());</span>
<span class="nc" id="L297">        task = taskService.createTaskQuery().processInstanceId(processInstance2.getId()).singleResult();</span>
<span class="nc" id="L298">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;userTask1Id&quot;);</span>

        // This task migrated
<span class="nc" id="L301">        assertThat(task.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
        
<span class="nc" id="L303">        assertThat(managementService.createJobQuery().processInstanceId(processInstance1.getId()).list()).hasSize(0);</span>
<span class="nc" id="L304">        assertThat(managementService.createTimerJobQuery().processInstanceId(processInstance1.getId()).list()).hasSize(0);</span>
<span class="nc" id="L305">        assertThat(managementService.createDeadLetterJobQuery().processInstanceId(processInstance1.getId()).list()).hasSize(0);</span>
        
<span class="nc" id="L307">        assertThat(managementService.createJobQuery().processInstanceId(processInstance2.getId()).list()).hasSize(0);</span>
<span class="nc" id="L308">        assertThat(managementService.createTimerJobQuery().processInstanceId(processInstance2.getId()).list()).hasSize(0);</span>
<span class="nc" id="L309">        assertThat(managementService.createDeadLetterJobQuery().processInstanceId(processInstance2.getId()).list()).hasSize(0);</span>

<span class="nc" id="L311">        completeProcessInstanceTasks(processInstance1.getId());</span>
<span class="nc" id="L312">        completeProcessInstanceTasks(processInstance2.getId());</span>
<span class="nc" id="L313">        assertProcessEnded(processInstance1.getId());</span>
<span class="nc" id="L314">        assertProcessEnded(processInstance2.getId());</span>

<span class="nc" id="L316">        managementService.deleteBatch(migrationBatch.getId());</span>
<span class="nc" id="L317">    }</span>

    @Test
    public void testProcessMigrationBatchTwentyMixedSuccessAndFails() {
        // Deploy first version of the process
<span class="nc" id="L322">        ProcessDefinition version1ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/two-tasks-simple-process.bpmn20.xml&quot;);

        // Instances that will validate and migrate properly
<span class="nc" id="L326">        List&lt;String&gt; successInstances = new ArrayList&lt;&gt;();</span>

        // Instances that will fail validation and migration
<span class="nc" id="L329">        List&lt;String&gt; failedInstances = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L331" title="All 2 branches missed.">        for (int i = 0; i &lt; 12; i++) {</span>
<span class="nc" id="L332">            successInstances.add(runtimeService.startProcessInstanceByKey(&quot;MP&quot;).getId());</span>
        }

<span class="nc bnc" id="L335" title="All 2 branches missed.">        for (int i = 0; i &lt; 8; i++) {</span>
<span class="nc" id="L336">            failedInstances.add(runtimeService.startProcessInstanceByKey(&quot;MP&quot;).getId());</span>
        }

<span class="nc" id="L339">        List&lt;String&gt; allInstances = new ArrayList&lt;&gt;(successInstances);</span>
<span class="nc" id="L340">        allInstances.addAll(failedInstances);</span>

        // Set the instances to fail in a state where they won't map properly during validation and migration
<span class="nc bnc" id="L343" title="All 2 branches missed.">        for (String processInstanceId : failedInstances) {</span>
<span class="nc" id="L344">            Task task = taskService.createTaskQuery().processInstanceId(processInstanceId).singleResult();</span>
<span class="nc" id="L345">            taskService.complete(task.getId());</span>
<span class="nc" id="L346">        }</span>

        // Deploy second version of the process
<span class="nc" id="L349">        ProcessDefinition version2ProcessDef = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);

        // Prepare the process instance migration builder
<span class="nc" id="L353">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService</span>
<span class="nc" id="L354">                .createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L355">                .migrateToProcessDefinition(version2ProcessDef.getId());</span>

        // Migrate the processes
<span class="nc" id="L358">        Batch migrationBatch = processInstanceMigrationBuilder.batchMigrateProcessInstances(version1ProcessDef.getId());</span>
<span class="nc" id="L359">        assertThat(JobTestHelper.areJobsAvailable(managementService)).isTrue();</span>

        // Partial Results - migration inProgress
<span class="nc" id="L362">        ProcessInstanceBatchMigrationResult migrationResult = processMigrationService.getResultsOfBatchProcessInstanceMigration(migrationBatch.getId());</span>
<span class="nc" id="L363">        assertThat(migrationResult).isNotNull();</span>
<span class="nc" id="L364">        assertThat(migrationResult.getBatchId()).isEqualTo(migrationBatch.getId());</span>
<span class="nc" id="L365">        assertThat(migrationResult.getStatus()).isEqualTo(ProcessInstanceBatchMigrationResult.STATUS_IN_PROGRESS);</span>
<span class="nc" id="L366">        assertThat(migrationResult.getCompleteTime()).isNull();</span>
<span class="nc" id="L367">        assertThat(migrationResult.getAllMigrationParts()).hasSize(successInstances.size() + failedInstances.size());</span>
<span class="nc" id="L368">        assertThat(migrationResult.getWaitingMigrationParts()).hasSize(successInstances.size() + failedInstances.size());</span>
<span class="nc" id="L369">        assertThat(migrationResult.getSuccessfulMigrationParts()).isEmpty();</span>
<span class="nc" id="L370">        assertThat(migrationResult.getFailedMigrationParts()).isEmpty();</span>

        // Each batch part is inProgress
<span class="nc bnc" id="L373" title="All 2 branches missed.">        for (ProcessInstanceBatchMigrationPartResult part : migrationResult.getAllMigrationParts()) {</span>
<span class="nc" id="L374">            assertThat(part.getStatus()).isEqualTo(ProcessInstanceBatchMigrationResult.STATUS_WAITING);</span>
<span class="nc" id="L375">            assertThat(part.getMigrationMessage()).isNull();</span>
<span class="nc" id="L376">        }</span>

        // Start async executor to process the batches
<span class="nc" id="L379">        JobTestHelper.waitForJobExecutorToProcessAllJobs(processEngineConfiguration, managementService, 10000L, 500L, true);</span>
<span class="nc" id="L380">        assertThat(JobTestHelper.areJobsAvailable(managementService)).isFalse();</span>

<span class="nc" id="L382">        List&lt;Job&gt; timerJobs = managementService.createTimerJobQuery().handlerType(ProcessInstanceMigrationStatusJobHandler.TYPE).list();</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">        for (Job timerJob : timerJobs) {</span>
<span class="nc" id="L384">            Job executableJob = managementService.moveTimerToExecutableJob(timerJob.getId());</span>
<span class="nc" id="L385">            managementService.executeJob(executableJob.getId());</span>
<span class="nc" id="L386">        }</span>

        //Confirm the batches have ended
<span class="nc" id="L389">        migrationResult = processMigrationService.getResultsOfBatchProcessInstanceMigration(migrationBatch.getId());</span>
<span class="nc" id="L390">        assertThat(migrationResult).isNotNull();</span>
<span class="nc" id="L391">        assertThat(migrationResult.getBatchId()).isEqualTo(migrationBatch.getId());</span>
<span class="nc" id="L392">        assertThat(migrationResult.getStatus()).isEqualTo(ProcessInstanceBatchMigrationResult.STATUS_COMPLETED);</span>
<span class="nc" id="L393">        assertThat(migrationResult.getCompleteTime()).isNotNull();</span>
<span class="nc" id="L394">        assertThat(migrationResult.getAllMigrationParts()).hasSize(successInstances.size() + failedInstances.size());</span>
<span class="nc" id="L395">        assertThat(migrationResult.getWaitingMigrationParts()).isEmpty();</span>
<span class="nc" id="L396">        assertThat(migrationResult.getSuccessfulMigrationParts()).hasSameSizeAs(successInstances);</span>
<span class="nc" id="L397">        assertThat(migrationResult.getFailedMigrationParts()).hasSameSizeAs(failedInstances);</span>

<span class="nc bnc" id="L399" title="All 2 branches missed.">        for (ProcessInstanceBatchMigrationPartResult part : migrationResult.getSuccessfulMigrationParts()) {</span>
<span class="nc" id="L400">            assertThat(part.getStatus()).isEqualTo(ProcessInstanceBatchMigrationResult.STATUS_COMPLETED);</span>
<span class="nc" id="L401">            assertThat(part.getResult()).isEqualTo(ProcessInstanceBatchMigrationResult.RESULT_SUCCESS);</span>
<span class="nc" id="L402">            assertThat(part.getMigrationMessage()).isNull();</span>
<span class="nc" id="L403">        }</span>

<span class="nc bnc" id="L405" title="All 2 branches missed.">        for (ProcessInstanceBatchMigrationPartResult part : migrationResult.getFailedMigrationParts()) {</span>
<span class="nc" id="L406">            assertThat(part.getStatus()).isEqualTo(ProcessInstanceBatchMigrationResult.STATUS_COMPLETED);</span>
<span class="nc" id="L407">            assertThat(part.getResult()).isEqualTo(ProcessInstanceBatchMigrationResult.RESULT_FAIL);</span>
<span class="nc" id="L408">            assertThat(part.getMigrationMessage()).isEqualTo(&quot;Migration Activity mapping missing for activity definition Id:'userTask2Id' or its MI Parent&quot;);</span>
<span class="nc" id="L409">        }</span>

<span class="nc" id="L411">        List&lt;Batch&gt; searchBatches = managementService.findBatchesBySearchKey(version1ProcessDef.getId());</span>
<span class="nc" id="L412">        assertThat(searchBatches).hasSize(1);</span>
<span class="nc" id="L413">        assertThat(searchBatches.get(0).getId()).isEqualTo(migrationBatch.getId());</span>
<span class="nc" id="L414">        assertThat(searchBatches.get(0).getBatchSearchKey()).isEqualTo(version1ProcessDef.getId());</span>
<span class="nc" id="L415">        assertThat(searchBatches.get(0).getBatchSearchKey2()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L416">        assertThat(searchBatches.get(0).getBatchType()).isEqualTo(Batch.PROCESS_MIGRATION_TYPE);</span>
<span class="nc" id="L417">        assertThat(searchBatches.get(0).getCreateTime()).isNotNull();</span>

<span class="nc" id="L419">        assertThat(managementService.createBatchQuery().searchKey(version1ProcessDef.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L420">        assertThat(managementService.createBatchQuery().searchKey(version2ProcessDef.getId()).count()).isZero();</span>
<span class="nc" id="L421">        assertThat(managementService.createBatchQuery().searchKey2(version1ProcessDef.getId()).count()).isZero();</span>
<span class="nc" id="L422">        assertThat(managementService.createBatchQuery().searchKey2(version2ProcessDef.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L423">        assertThat(managementService.createBatchQuery().createTimeLowerThan(new Date()).count()).isEqualTo(1);</span>
<span class="nc" id="L424">        assertThat(managementService.createBatchQuery().createTimeHigherThan(new Date()).count()).isZero();</span>

<span class="nc" id="L426">        assertThat(managementService.createBatchPartQuery().batchId(migrationBatch.getId()).count()).isEqualTo(20);</span>
<span class="nc" id="L427">        assertThat(managementService.createBatchPartQuery().batchId(migrationBatch.getId()).list()).hasSize(20);</span>
<span class="nc" id="L428">        assertThat(managementService.createBatchPartQuery().searchKey(version1ProcessDef.getId()).count()).isEqualTo(20);</span>
<span class="nc" id="L429">        assertThat(managementService.createBatchPartQuery().searchKey(version1ProcessDef.getId()).list()).hasSize(20);</span>
<span class="nc" id="L430">        assertThat(managementService.createBatchPartQuery().searchKey(version2ProcessDef.getId()).count()).isZero();</span>
<span class="nc" id="L431">        assertThat(managementService.createBatchPartQuery().searchKey(version2ProcessDef.getId()).list()).isEmpty();</span>
<span class="nc" id="L432">        assertThat(managementService.createBatchPartQuery().searchKey2(version1ProcessDef.getId()).count()).isZero();</span>
<span class="nc" id="L433">        assertThat(managementService.createBatchPartQuery().searchKey2(version1ProcessDef.getId()).list()).isEmpty();</span>
<span class="nc" id="L434">        assertThat(managementService.createBatchPartQuery().searchKey2(version2ProcessDef.getId()).count()).isEqualTo(20);</span>
<span class="nc" id="L435">        assertThat(managementService.createBatchPartQuery().searchKey2(version2ProcessDef.getId()).list()).hasSize(20);</span>
<span class="nc" id="L436">        assertThat(managementService.createBatchPartQuery().type(Batch.PROCESS_MIGRATION_TYPE).count()).isEqualTo(20);</span>
<span class="nc" id="L437">        assertThat(managementService.createBatchPartQuery().type(Batch.PROCESS_MIGRATION_TYPE).list()).hasSize(20);</span>
<span class="nc" id="L438">        assertThat(managementService.createBatchPartQuery().type(&quot;unknown&quot;).count()).isZero();</span>
<span class="nc" id="L439">        assertThat(managementService.createBatchPartQuery().type(&quot;unknown&quot;).list()).isEmpty();</span>
<span class="nc" id="L440">        assertThat(managementService.createBatchPartQuery().batchSearchKey(version1ProcessDef.getId()).count()).isEqualTo(20);</span>
<span class="nc" id="L441">        assertThat(managementService.createBatchPartQuery().batchSearchKey(version1ProcessDef.getId()).list()).hasSize(20);</span>
<span class="nc" id="L442">        assertThat(managementService.createBatchPartQuery().batchSearchKey(version2ProcessDef.getId()).count()).isZero();</span>
<span class="nc" id="L443">        assertThat(managementService.createBatchPartQuery().batchSearchKey(version2ProcessDef.getId()).list()).isEmpty();</span>
<span class="nc" id="L444">        assertThat(managementService.createBatchPartQuery().batchSearchKey2(version1ProcessDef.getId()).count()).isZero();</span>
<span class="nc" id="L445">        assertThat(managementService.createBatchPartQuery().batchSearchKey2(version1ProcessDef.getId()).list()).isEmpty();</span>
<span class="nc" id="L446">        assertThat(managementService.createBatchPartQuery().batchSearchKey2(version2ProcessDef.getId()).count()).isEqualTo(20);</span>
<span class="nc" id="L447">        assertThat(managementService.createBatchPartQuery().batchSearchKey2(version2ProcessDef.getId()).list()).hasSize(20);</span>
<span class="nc" id="L448">        assertThat(managementService.createBatchPartQuery().batchType(Batch.PROCESS_MIGRATION_TYPE).count()).isEqualTo(20);</span>
<span class="nc" id="L449">        assertThat(managementService.createBatchPartQuery().batchType(Batch.PROCESS_MIGRATION_TYPE).list()).hasSize(20);</span>
<span class="nc" id="L450">        assertThat(managementService.createBatchPartQuery().batchType(&quot;unknown&quot;).count()).isZero();</span>
<span class="nc" id="L451">        assertThat(managementService.createBatchPartQuery().batchType(&quot;unknown&quot;).list()).isEmpty();</span>
<span class="nc" id="L452">        assertThat(managementService.createBatchPartQuery().scopeType(ScopeTypes.CMMN).count()).isZero();</span>
<span class="nc" id="L453">        assertThat(managementService.createBatchPartQuery().scopeType(ScopeTypes.CMMN).list()).isEmpty();</span>
<span class="nc" id="L454">        assertThat(managementService.createBatchPartQuery().scopeType(ScopeTypes.BPMN).count()).isEqualTo(20);</span>
<span class="nc" id="L455">        assertThat(managementService.createBatchPartQuery().scopeType(ScopeTypes.BPMN).list()).hasSize(20);</span>
<span class="nc" id="L456">        assertThat(managementService.createBatchPartQuery().scopeId(allInstances.get(0)).scopeType(ScopeTypes.BPMN).count()).isEqualTo(1);</span>
<span class="nc" id="L457">        assertThat(managementService.createBatchPartQuery().scopeId(allInstances.get(0)).scopeType(ScopeTypes.BPMN).singleResult()).isNotNull();</span>

<span class="nc" id="L459">        List&lt;BatchPart&gt; searchBatchParts = managementService.findBatchPartsByBatchId(migrationBatch.getId());</span>
<span class="nc" id="L460">        assertThat(searchBatchParts).hasSize(20);</span>

<span class="nc" id="L462">        searchBatchParts = managementService.createBatchPartQuery().batchId(migrationBatch.getId()).list();</span>
<span class="nc" id="L463">        assertThat(searchBatchParts).hasSize(20);</span>
<span class="nc bnc" id="L464" title="All 2 branches missed.">        for (BatchPart batchPart : searchBatchParts) {</span>
<span class="nc" id="L465">            assertThat(batchPart.getBatchId()).isEqualTo(migrationBatch.getId());</span>
<span class="nc" id="L466">            assertThat(batchPart.getType()).isEqualTo(Batch.PROCESS_MIGRATION_TYPE);</span>
<span class="nc" id="L467">            assertThat(batchPart.getSearchKey()).isEqualTo(version1ProcessDef.getId());</span>
<span class="nc" id="L468">            assertThat(batchPart.getSearchKey2()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L469">            assertThat(batchPart.getBatchSearchKey()).isEqualTo(version1ProcessDef.getId());</span>
<span class="nc" id="L470">            assertThat(batchPart.getBatchSearchKey2()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L471">            assertThat(batchPart.getBatchType()).isEqualTo(Batch.PROCESS_MIGRATION_TYPE);</span>
<span class="nc" id="L472">            assertThat(batchPart.getCreateTime()).isNotNull();</span>
<span class="nc" id="L473">            assertThat(batchPart.getCompleteTime()).isNotNull();</span>
<span class="nc" id="L474">            assertThat(batchPart.getScopeId()).isIn(allInstances);</span>
<span class="nc" id="L475">            assertThat(batchPart.getScopeType()).isEqualTo(ScopeTypes.BPMN);</span>
<span class="nc" id="L476">            assertThat(batchPart.getSubScopeId()).isNull();</span>
<span class="nc" id="L477">        }</span>

        // Confirm the migration of successfulParts
<span class="nc bnc" id="L480" title="All 2 branches missed.">        for (String processInstanceId : successInstances) {</span>
<span class="nc" id="L481">            Task task = taskService.createTaskQuery().processInstanceId(processInstanceId).singleResult();</span>
<span class="nc" id="L482">            assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L483">            assertThat(task.getProcessDefinitionId()).isEqualTo(version2ProcessDef.getId());</span>
<span class="nc" id="L484">        }</span>

        // Confirm the migration of failedParts
<span class="nc bnc" id="L487" title="All 2 branches missed.">        for (String processInstanceId : failedInstances) {</span>
<span class="nc" id="L488">            Task task = taskService.createTaskQuery().processInstanceId(processInstanceId).singleResult();</span>
<span class="nc" id="L489">            assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;userTask2Id&quot;);</span>
<span class="nc" id="L490">            assertThat(task.getProcessDefinitionId()).isEqualTo(version1ProcessDef.getId());</span>
<span class="nc" id="L491">        }</span>
        
<span class="nc bnc" id="L493" title="All 2 branches missed.">        for (String processInstanceId : successInstances) {</span>
<span class="nc" id="L494">            assertThat(managementService.createJobQuery().processInstanceId(processInstanceId).list()).hasSize(0);</span>
<span class="nc" id="L495">            assertThat(managementService.createTimerJobQuery().processInstanceId(processInstanceId).list()).hasSize(0);</span>
<span class="nc" id="L496">            assertThat(managementService.createDeadLetterJobQuery().processInstanceId(processInstanceId).list()).hasSize(0);</span>
<span class="nc" id="L497">        }</span>
        
<span class="nc bnc" id="L499" title="All 2 branches missed.">        for (String processInstanceId : failedInstances) {</span>
<span class="nc" id="L500">            assertThat(managementService.createJobQuery().processInstanceId(processInstanceId).list()).hasSize(0);</span>
<span class="nc" id="L501">            assertThat(managementService.createTimerJobQuery().processInstanceId(processInstanceId).list()).hasSize(0);</span>
<span class="nc" id="L502">            assertThat(managementService.createDeadLetterJobQuery().processInstanceId(processInstanceId).list()).hasSize(0);</span>
<span class="nc" id="L503">        }</span>

        // Complete the processes
<span class="nc bnc" id="L506" title="All 2 branches missed.">        for (String processInstanceId : successInstances) {</span>
<span class="nc" id="L507">            completeProcessInstanceTasks(processInstanceId);</span>
<span class="nc" id="L508">            assertProcessEnded(processInstanceId);</span>
<span class="nc" id="L509">        }</span>

<span class="nc bnc" id="L511" title="All 2 branches missed.">        for (String processInstanceId : failedInstances) {</span>
<span class="nc" id="L512">            completeProcessInstanceTasks(processInstanceId);</span>
<span class="nc" id="L513">            assertProcessEnded(processInstanceId);</span>
<span class="nc" id="L514">        }</span>

<span class="nc" id="L516">        managementService.deleteBatch(migrationBatch.getId());</span>
<span class="nc" id="L517">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>