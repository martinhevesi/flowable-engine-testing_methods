<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProcessInstanceMigrationGatewaysTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.runtime.migration</a> &gt; <span class="el_source">ProcessInstanceMigrationGatewaysTest.java</span></div><h1>ProcessInstanceMigrationGatewaysTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.engine.test.api.runtime.migration;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.assertj.core.api.Assertions.tuple;

import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.Map;

import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.engine.history.HistoricActivityInstance;
import org.flowable.engine.impl.test.HistoryTestHelper;
import org.flowable.engine.migration.ActivityMigrationMapping;
import org.flowable.engine.migration.ProcessInstanceMigrationBuilder;
import org.flowable.engine.migration.ProcessInstanceMigrationValidationResult;
import org.flowable.engine.repository.ProcessDefinition;
import org.flowable.engine.runtime.Execution;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.job.api.Job;
import org.flowable.task.api.Task;
import org.flowable.task.api.history.HistoricTaskInstance;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.Test;

/**
 * @author Dennis Federico
 */
<span class="nc" id="L44">public class ProcessInstanceMigrationGatewaysTest extends AbstractProcessInstanceMigrationTest {</span>

    @AfterEach
    protected void tearDown() {
<span class="nc" id="L48">        deleteDeployments();</span>
<span class="nc" id="L49">    }</span>

    //-- Exclusive Gateway
    @Test
    public void testMigrateActivityToExclusiveGatewayStartWithDefaultFlow() {
<span class="nc" id="L54">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L56">        ProcessDefinition procWithExcGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/exclusive-gateway-with-default-sequence.bpmn20.xml&quot;);

        //Start the processInstance without timer
<span class="nc" id="L60">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L63">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L64">        assertThat(executions)</span>
<span class="nc" id="L65">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L66">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L67">        assertThat(executions)</span>
<span class="nc" id="L68">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L69">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L70">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L71">        assertThat(task)</span>
<span class="nc" id="L72">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L73">                .containsOnly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

        //Migrate to the other processDefinition
<span class="nc" id="L76">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L77">                .migrateToProcessDefinition(procWithExcGtw.getId())</span>
<span class="nc" id="L78">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;exclusiveGw&quot;));</span>

<span class="nc" id="L80">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L81">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L82">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>
<span class="nc" id="L83">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L86">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L87">        assertThat(executions)</span>
<span class="nc" id="L88">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L89">                .containsExactly(&quot;defaultFlowTask&quot;);</span>
<span class="nc" id="L90">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L91">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;defaultFlowTask&quot;);</span>

<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L95">            checkActivityInstances(procWithExcGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;defaultFlowTask&quot;);</span>
<span class="nc" id="L96">            checkActivityInstances(procWithExcGtw, processInstance, &quot;exclusiveGateway&quot;, &quot;exclusiveGw&quot;);</span>
<span class="nc" id="L97">            checkTaskInstance(procWithExcGtw, processInstance, &quot;userTask1Id&quot;, &quot;defaultFlowTask&quot;);</span>
        }

<span class="nc" id="L100">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L101">        assertProcessEnded(processInstance.getId());</span>

<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L105">            checkActivityInstances(procWithExcGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;defaultFlowTask&quot;);</span>
<span class="nc" id="L106">            checkActivityInstances(procWithExcGtw, processInstance, &quot;exclusiveGateway&quot;, &quot;exclusiveGw&quot;);</span>
<span class="nc" id="L107">            checkTaskInstance(procWithExcGtw, processInstance, &quot;userTask1Id&quot;, &quot;defaultFlowTask&quot;);</span>
        }
<span class="nc" id="L109">    }</span>

    @Test
    public void testMigrateActivityToExclusiveGatewayStartWithConditionSpecifiedBeforeMigration() {
<span class="nc" id="L113">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L115">        ProcessDefinition procWithExcGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/exclusive-gateway-with-default-sequence.bpmn20.xml&quot;);

        //Start the processInstance without timer
<span class="nc" id="L119">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L122">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L123">        assertThat(executions)</span>
<span class="nc" id="L124">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L125">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L126">        assertThat(executions)</span>
<span class="nc" id="L127">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L128">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L129">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L130">        assertThat(task)</span>
<span class="nc" id="L131">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L132">                .containsOnly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

<span class="nc" id="L134">        runtimeService.setVariable(executions.get(0).getId(), &quot;input&quot;, 1);</span>

        //Migrate to the other processDefinition
<span class="nc" id="L137">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L138">                .migrateToProcessDefinition(procWithExcGtw.getId())</span>
<span class="nc" id="L139">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;exclusiveGw&quot;));</span>

<span class="nc" id="L141">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L142">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L143">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L145">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L148">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L149">        assertThat(executions)</span>
<span class="nc" id="L150">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L151">                .containsExactly(&quot;theTask1&quot;);</span>
<span class="nc" id="L152">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L153">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;theTask1&quot;);</span>

<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L157">            checkActivityInstances(procWithExcGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;theTask1&quot;);</span>
<span class="nc" id="L158">            checkActivityInstances(procWithExcGtw, processInstance, &quot;exclusiveGateway&quot;, &quot;exclusiveGw&quot;);</span>

<span class="nc" id="L160">            checkTaskInstance(procWithExcGtw, processInstance, &quot;userTask1Id&quot;, &quot;theTask1&quot;);</span>
        }

<span class="nc" id="L163">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L164">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L165">    }</span>

    @Test
    public void testMigrateActivityToExclusiveGatewayStartWithConditionSpecifiedDuringMigration() {
<span class="nc" id="L169">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L171">        ProcessDefinition procWithExcGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/exclusive-gateway-with-default-sequence.bpmn20.xml&quot;);

        //Start the processInstance without timer
<span class="nc" id="L175">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L178">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L179">        assertThat(executions)</span>
<span class="nc" id="L180">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L181">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L182">        assertThat(executions)</span>
<span class="nc" id="L183">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L184">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L185">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L186">        assertThat(task)</span>
<span class="nc" id="L187">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L188">                .containsOnly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

        //Migrate to the other processDefinition
<span class="nc" id="L191">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L192">                .migrateToProcessDefinition(procWithExcGtw.getId())</span>
<span class="nc" id="L193">                .addActivityMigrationMapping(</span>
<span class="nc" id="L194">                        ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;exclusiveGw&quot;).withLocalVariable(&quot;input&quot;, Integer.valueOf(1)));</span>

<span class="nc" id="L196">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L197">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L198">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L200">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L203">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L204">        assertThat(executions)</span>
<span class="nc" id="L205">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L206">                .containsExactly(&quot;theTask1&quot;);</span>
<span class="nc" id="L207">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L208">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;theTask1&quot;);</span>

<span class="nc bnc" id="L210" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L212">            checkActivityInstances(procWithExcGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;theTask1&quot;);</span>
<span class="nc" id="L213">            checkActivityInstances(procWithExcGtw, processInstance, &quot;exclusiveGateway&quot;, &quot;exclusiveGw&quot;);</span>

<span class="nc" id="L215">            checkTaskInstance(procWithExcGtw, processInstance, &quot;userTask1Id&quot;, &quot;theTask1&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L219">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L220">        assertProcessEnded(processInstance.getId());</span>

<span class="nc bnc" id="L222" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L224">            checkActivityInstances(procWithExcGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;theTask1&quot;);</span>
<span class="nc" id="L225">            checkActivityInstances(procWithExcGtw, processInstance, &quot;exclusiveGateway&quot;, &quot;exclusiveGw&quot;);</span>

<span class="nc" id="L227">            checkTaskInstance(procWithExcGtw, processInstance, &quot;userTask1Id&quot;, &quot;theTask1&quot;);</span>
        }

<span class="nc" id="L230">    }</span>

    @Test
    public void testMigrateActivityToExclusiveGatewayStartWithConditionSpecifiedAsProcessVariableDuringMigration() {
<span class="nc" id="L234">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L236">        ProcessDefinition procWithExcGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/exclusive-gateway-with-default-sequence.bpmn20.xml&quot;);

        //Start the processInstance without timer
<span class="nc" id="L240">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L243">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L244">        assertThat(executions)</span>
<span class="nc" id="L245">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L246">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L247">        assertThat(executions)</span>
<span class="nc" id="L248">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L249">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L250">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L251">        assertThat(task)</span>
<span class="nc" id="L252">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L253">                .containsOnly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

        //Migrate to the other processDefinition
<span class="nc" id="L256">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L257">                .migrateToProcessDefinition(procWithExcGtw.getId())</span>
<span class="nc" id="L258">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;exclusiveGw&quot;))</span>
<span class="nc" id="L259">                .withProcessInstanceVariable(&quot;input&quot;, 1);</span>

<span class="nc" id="L261">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L262">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L263">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L265">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L268">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L269">        assertThat(executions)</span>
<span class="nc" id="L270">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L271">                .containsExactly(&quot;theTask1&quot;);</span>
<span class="nc" id="L272">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L273">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;theTask1&quot;);</span>

<span class="nc bnc" id="L275" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L277">            checkActivityInstances(procWithExcGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;theTask1&quot;);</span>
<span class="nc" id="L278">            checkActivityInstances(procWithExcGtw, processInstance, &quot;exclusiveGateway&quot;, &quot;exclusiveGw&quot;);</span>

<span class="nc" id="L280">            checkTaskInstance(procWithExcGtw, processInstance, &quot;userTask1Id&quot;, &quot;theTask1&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L284">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L288">            checkActivityInstances(procWithExcGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;theTask1&quot;);</span>
<span class="nc" id="L289">            checkActivityInstances(procWithExcGtw, processInstance, &quot;exclusiveGateway&quot;, &quot;exclusiveGw&quot;);</span>

<span class="nc" id="L291">            checkTaskInstance(procWithExcGtw, processInstance, &quot;userTask1Id&quot;, &quot;theTask1&quot;);</span>
        }

<span class="nc" id="L294">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L295">    }</span>

    @Test
    public void testMigrateActivityToActivityInsideExclusiveGateway() {
<span class="nc" id="L299">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L301">        ProcessDefinition procWithExcGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/exclusive-gateway-with-default-sequence.bpmn20.xml&quot;);

        //Start the processInstance without timer
<span class="nc" id="L305">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L308">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L309">        assertThat(executions)</span>
<span class="nc" id="L310">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L311">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L312">        assertThat(executions)</span>
<span class="nc" id="L313">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L314">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L315">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L316">        assertThat(task)</span>
<span class="nc" id="L317">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L318">                .containsOnly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

        //Migrate to the other processDefinition
<span class="nc" id="L321">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L322">                .migrateToProcessDefinition(procWithExcGtw.getId())</span>
<span class="nc" id="L323">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;theTask2&quot;));</span>

<span class="nc" id="L325">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L326">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L327">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L329">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L332">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L333">        assertThat(executions)</span>
<span class="nc" id="L334">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L335">                .containsExactly(&quot;theTask2&quot;);</span>
<span class="nc" id="L336">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L337">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;theTask2&quot;);</span>

<span class="nc bnc" id="L339" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L341">            checkActivityInstances(procWithExcGtw, processInstance, &quot;userTask&quot;, &quot;theTask2&quot;);</span>

<span class="nc" id="L343">            List&lt;HistoricActivityInstance&gt; gtwExecution = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L344">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L345">                    .activityType(&quot;exclusiveGateway&quot;)</span>
<span class="nc" id="L346">                    .list();</span>
<span class="nc" id="L347">            assertThat(gtwExecution).isEmpty();</span>

<span class="nc" id="L349">            checkTaskInstance(procWithExcGtw, processInstance, &quot;theTask2&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L353">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L355" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L357">            checkActivityInstances(procWithExcGtw, processInstance, &quot;userTask&quot;, &quot;theTask2&quot;);</span>

<span class="nc" id="L359">            List&lt;HistoricActivityInstance&gt; gtwExecution = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L360">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L361">                    .activityType(&quot;exclusiveGateway&quot;)</span>
<span class="nc" id="L362">                    .list();</span>
<span class="nc" id="L363">            assertThat(gtwExecution).isEmpty();</span>

<span class="nc" id="L365">            checkTaskInstance(procWithExcGtw, processInstance, &quot;theTask2&quot;);</span>
        }

<span class="nc" id="L368">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L369">    }</span>

    @Test
    public void testMigrateActivityInsideExclusiveGatewayToActivityOutside() {
<span class="nc" id="L373">        ProcessDefinition procWithExcGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/exclusive-gateway-with-default-sequence.bpmn20.xml&quot;);
<span class="nc" id="L375">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);

        //Start the processInstance without timer
<span class="nc" id="L379">        Map&lt;String, Object&gt; gtwCondition = Collections.singletonMap(&quot;input&quot;, Integer.valueOf(2));</span>
<span class="nc" id="L380">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procWithExcGtw.getId(), gtwCondition);</span>

        //Confirm the state to migrate
<span class="nc" id="L383">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L384">        assertThat(executions)</span>
<span class="nc" id="L385">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L386">                .containsExactly(&quot;theTask2&quot;);</span>
<span class="nc" id="L387">        assertThat(executions)</span>
<span class="nc" id="L388">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L389">                .containsOnly(procWithExcGtw.getId());</span>
<span class="nc" id="L390">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L391">        assertThat(task)</span>
<span class="nc" id="L392">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L393">                .containsOnly(&quot;theTask2&quot;, procWithExcGtw.getId());</span>

        //Migrate to the other processDefinition
<span class="nc" id="L396">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L397">                .migrateToProcessDefinition(procDefOneTask.getId())</span>
<span class="nc" id="L398">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;theTask2&quot;, &quot;userTask1Id&quot;));</span>

<span class="nc" id="L400">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L401">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L402">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L404">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L407">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L408">        assertThat(executions)</span>
<span class="nc" id="L409">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L410">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L411">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L412">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>

<span class="nc bnc" id="L414" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L416">            checkActivityInstances(procDefOneTask, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;);</span>
<span class="nc" id="L417">            checkActivityInstances(procDefOneTask, processInstance, &quot;exclusiveGateway&quot;, &quot;exclusiveGw&quot;);</span>

<span class="nc" id="L419">            checkTaskInstance(procDefOneTask, processInstance, &quot;userTask1Id&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L423">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L425" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L427">            checkActivityInstances(procDefOneTask, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;);</span>
<span class="nc" id="L428">            checkActivityInstances(procDefOneTask, processInstance, &quot;exclusiveGateway&quot;, &quot;exclusiveGw&quot;);</span>

<span class="nc" id="L430">            checkTaskInstance(procDefOneTask, processInstance, &quot;userTask1Id&quot;);</span>
        }

<span class="nc" id="L433">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L434">    }</span>

    @Test
    public void testMigrateActivityToExclusiveGatewayStartInsideEmbeddedSubProcessDefaultFlow() {
<span class="nc" id="L438">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L440">        ProcessDefinition procWithExcGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/exclusive-gateway-with-default-sequence-inside-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance without timer
<span class="nc" id="L444">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L447">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L448">        assertThat(executions)</span>
<span class="nc" id="L449">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L450">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L451">        assertThat(executions)</span>
<span class="nc" id="L452">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L453">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L454">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L455">        assertThat(task)</span>
<span class="nc" id="L456">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L457">                .containsOnly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

        //Migrate to the other processDefinition
<span class="nc" id="L460">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L461">                .migrateToProcessDefinition(procWithExcGtw.getId())</span>
<span class="nc" id="L462">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;exclusiveGw&quot;));</span>

<span class="nc" id="L464">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L465">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L466">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L468">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L471">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L472">        assertThat(executions)</span>
<span class="nc" id="L473">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L474">                .containsExactly(&quot;theSubProcess&quot;, &quot;defaultFlowTask&quot;);</span>
<span class="nc" id="L475">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L476">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;defaultFlowTask&quot;);</span>

<span class="nc bnc" id="L478" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L480">            checkActivityInstances(procWithExcGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;defaultFlowTask&quot;);</span>
<span class="nc" id="L481">            checkActivityInstances(procWithExcGtw, processInstance, &quot;subProcess&quot;, &quot;theSubProcess&quot;);</span>
<span class="nc" id="L482">            checkActivityInstances(procWithExcGtw, processInstance, &quot;exclusiveGateway&quot;, &quot;exclusiveGw&quot;);</span>

<span class="nc" id="L484">            checkTaskInstance(procWithExcGtw, processInstance, &quot;userTask1Id&quot;, &quot;defaultFlowTask&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L488">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L490" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L492">            checkActivityInstances(procWithExcGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;defaultFlowTask&quot;, &quot;afterSubProcessTask&quot;);</span>
<span class="nc" id="L493">            checkActivityInstances(procWithExcGtw, processInstance, &quot;subProcess&quot;, &quot;theSubProcess&quot;);</span>
<span class="nc" id="L494">            checkActivityInstances(procWithExcGtw, processInstance, &quot;exclusiveGateway&quot;, &quot;exclusiveGw&quot;);</span>

<span class="nc" id="L496">            checkTaskInstance(procWithExcGtw, processInstance, &quot;userTask1Id&quot;, &quot;defaultFlowTask&quot;, &quot;afterSubProcessTask&quot;);</span>
        }

<span class="nc" id="L499">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L500">    }</span>

    @Test
    public void testMigrateActivityToExclusiveGatewayStartInsideEmbeddedSubProcess() {
<span class="nc" id="L504">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L506">        ProcessDefinition procWithExcGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/exclusive-gateway-with-default-sequence-inside-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance without timer
<span class="nc" id="L510">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L513">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L514">        assertThat(executions)</span>
<span class="nc" id="L515">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L516">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L517">        assertThat(executions)</span>
<span class="nc" id="L518">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L519">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L520">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L521">        assertThat(task)</span>
<span class="nc" id="L522">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L523">                .containsOnly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

        //Migrate to the other processDefinition
<span class="nc" id="L526">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L527">                .migrateToProcessDefinition(procWithExcGtw.getId())</span>
<span class="nc" id="L528">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;exclusiveGw&quot;)</span>
<span class="nc" id="L529">                        .withLocalVariables(Collections.singletonMap(&quot;input&quot;, Integer.valueOf(1))));</span>

<span class="nc" id="L531">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L532">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L533">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L535">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L538">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L539">        assertThat(executions)</span>
<span class="nc" id="L540">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L541">                .containsExactly(&quot;theSubProcess&quot;, &quot;theTask1&quot;);</span>
<span class="nc" id="L542">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L543">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;theTask1&quot;);</span>

<span class="nc bnc" id="L545" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L547">            checkActivityInstances(procWithExcGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;theTask1&quot;);</span>
<span class="nc" id="L548">            checkActivityInstances(procWithExcGtw, processInstance, &quot;subProcess&quot;, &quot;theSubProcess&quot;);</span>
<span class="nc" id="L549">            checkActivityInstances(procWithExcGtw, processInstance, &quot;exclusiveGateway&quot;, &quot;exclusiveGw&quot;);</span>

<span class="nc" id="L551">            checkTaskInstance(procWithExcGtw, processInstance, &quot;userTask1Id&quot;, &quot;theTask1&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L555">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L557" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L559">            checkActivityInstances(procWithExcGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;theTask1&quot;, &quot;afterSubProcessTask&quot;);</span>
<span class="nc" id="L560">            checkActivityInstances(procWithExcGtw, processInstance, &quot;subProcess&quot;, &quot;theSubProcess&quot;);</span>
<span class="nc" id="L561">            checkActivityInstances(procWithExcGtw, processInstance, &quot;exclusiveGateway&quot;, &quot;exclusiveGw&quot;);</span>

<span class="nc" id="L563">            checkTaskInstance(procWithExcGtw, processInstance, &quot;userTask1Id&quot;, &quot;theTask1&quot;, &quot;afterSubProcessTask&quot;);</span>
        }

<span class="nc" id="L566">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L567">    }</span>

    @Test
    public void testMigrateActivityToActivityInsideExclusiveGatewayInsideEmbeddedSubProcess() {
<span class="nc" id="L571">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L573">        ProcessDefinition procWithExcGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/exclusive-gateway-with-default-sequence-inside-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance without timer
<span class="nc" id="L577">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L580">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L581">        assertThat(executions)</span>
<span class="nc" id="L582">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L583">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L584">        assertThat(executions)</span>
<span class="nc" id="L585">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L586">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L587">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L588">        assertThat(task)</span>
<span class="nc" id="L589">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L590">                .containsOnly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

        //Migrate to the other processDefinition
<span class="nc" id="L593">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L594">                .migrateToProcessDefinition(procWithExcGtw.getId())</span>
<span class="nc" id="L595">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;theTask2&quot;));</span>

<span class="nc" id="L597">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L598">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L599">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L601">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L604">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L605">        assertThat(executions)</span>
<span class="nc" id="L606">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L607">                .containsExactlyInAnyOrder(&quot;theSubProcess&quot;, &quot;theTask2&quot;);</span>
<span class="nc" id="L608">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L609">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;theTask2&quot;);</span>

<span class="nc bnc" id="L611" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L613">            checkActivityInstances(procWithExcGtw, processInstance, &quot;userTask&quot;, &quot;theTask2&quot;);</span>
<span class="nc" id="L614">            checkActivityInstances(procWithExcGtw, processInstance, &quot;subProcess&quot;, &quot;theSubProcess&quot;);</span>
<span class="nc" id="L615">            List&lt;HistoricActivityInstance&gt; gtwExecution = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L616">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L617">                    .activityType(&quot;exclusiveGateway&quot;)</span>
<span class="nc" id="L618">                    .list();</span>
<span class="nc" id="L619">            assertThat(gtwExecution).isEmpty();</span>

<span class="nc" id="L621">            checkTaskInstance(procWithExcGtw, processInstance, &quot;theTask2&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L625">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L627" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L629">            checkActivityInstances(procWithExcGtw, processInstance, &quot;userTask&quot;, &quot;theTask2&quot;, &quot;afterSubProcessTask&quot;);</span>
<span class="nc" id="L630">            checkActivityInstances(procWithExcGtw, processInstance, &quot;subProcess&quot;, &quot;theSubProcess&quot;);</span>
<span class="nc" id="L631">            List&lt;HistoricActivityInstance&gt; gtwExecution = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L632">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L633">                    .activityType(&quot;exclusiveGateway&quot;)</span>
<span class="nc" id="L634">                    .list();</span>
<span class="nc" id="L635">            assertThat(gtwExecution).isEmpty();</span>

<span class="nc" id="L637">            checkTaskInstance(procWithExcGtw, processInstance, &quot;theTask2&quot;, &quot;afterSubProcessTask&quot;);</span>
        }

<span class="nc" id="L640">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L641">    }</span>

    //-- Parallel Gateway
    @Test
    public void testMigrateActivityToParallelGatewayFork() {
<span class="nc" id="L646">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L648">        ProcessDefinition procParallelGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/parallel-gateway-two-splits-four-tasks.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L652">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L655">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L656">        assertThat(executions)</span>
<span class="nc" id="L657">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L658">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L659">        assertThat(executions)</span>
<span class="nc" id="L660">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L661">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L662">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L663">        assertThat(task)</span>
<span class="nc" id="L664">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L665">                .containsOnly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

        //Migrate each of the parallel task to a task in the parallel gateway
<span class="nc" id="L668">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L669">                .migrateToProcessDefinition(procParallelGtw.getId())</span>
<span class="nc" id="L670">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;parallelFork&quot;));</span>

<span class="nc" id="L672">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L673">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L674">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L676">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L679">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L680">        assertThat(executions)</span>
<span class="nc" id="L681">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L682">                .containsExactlyInAnyOrder(&quot;oddFlowTask1&quot;, &quot;evenFlowTask2&quot;);</span>
<span class="nc" id="L683">        assertThat(executions)</span>
<span class="nc" id="L684">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L685">                .containsOnly(procParallelGtw.getId());</span>
<span class="nc" id="L686">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L687">        assertThat(tasks)</span>
<span class="nc" id="L688">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L689">                .containsExactlyInAnyOrder(&quot;oddFlowTask1&quot;, &quot;evenFlowTask2&quot;);</span>
<span class="nc" id="L690">        assertThat(tasks)</span>
<span class="nc" id="L691">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L692">                .containsOnly(procParallelGtw.getId());</span>

<span class="nc bnc" id="L694" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L696">            checkActivityInstances(procParallelGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;oddFlowTask1&quot;, &quot;evenFlowTask2&quot;);</span>
<span class="nc" id="L697">            checkActivityInstances(procParallelGtw, processInstance, &quot;parallelGateway&quot;, &quot;parallelFork&quot;);</span>

<span class="nc" id="L699">            checkTaskInstance(procParallelGtw, processInstance, &quot;userTask1Id&quot;, &quot;oddFlowTask1&quot;, &quot;evenFlowTask2&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L703">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L705" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L707">            checkActivityInstances(procParallelGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;oddFlowTask1&quot;, &quot;oddFlowTask3&quot;, &quot;evenFlowTask2&quot;,</span>
                    &quot;evenFlowTask4&quot;, &quot;taskAfter&quot;);
<span class="nc" id="L709">            checkActivityInstances(procParallelGtw, processInstance, &quot;parallelGateway&quot;, &quot;parallelFork&quot;, &quot;parallelJoin&quot;, &quot;parallelJoin&quot;);</span>

<span class="nc" id="L711">            checkTaskInstance(procParallelGtw, processInstance, &quot;userTask1Id&quot;, &quot;oddFlowTask1&quot;, &quot;oddFlowTask3&quot;, &quot;evenFlowTask2&quot;, &quot;evenFlowTask4&quot;, &quot;taskAfter&quot;);</span>
        }

<span class="nc" id="L714">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L715">    }</span>

    @Test
    public void testMigrateParallelActivitiesToParallelGatewayActivities() {
<span class="nc" id="L719">        ProcessDefinition procParallelTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L721">        ProcessDefinition procParallelGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/parallel-gateway-two-splits-four-tasks.bpmn20.xml&quot;);

        //Start the processInstance and spawn the parallel task
<span class="nc" id="L725">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procParallelTask.getId());</span>

<span class="nc" id="L727">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L728">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L729">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L732">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L733">        assertThat(executions)</span>
<span class="nc" id="L734">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L735">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L736">        assertThat(executions)</span>
<span class="nc" id="L737">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L738">                .containsOnly(procParallelTask.getId());</span>
<span class="nc" id="L739">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L740">        assertThat(tasks)</span>
<span class="nc" id="L741">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L742">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L743">        assertThat(tasks).</span>
<span class="nc" id="L744">                extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L745">                .containsOnly(procParallelTask.getId());</span>

        //Migrate each of the parallel task to a task in the parallel gateway
<span class="nc" id="L748">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L749">                .migrateToProcessDefinition(procParallelGtw.getId())</span>
<span class="nc" id="L750">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;processTask&quot;, &quot;oddFlowTask1&quot;))</span>
<span class="nc" id="L751">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;evenFlowTask4&quot;));</span>

<span class="nc" id="L753">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L754">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L755">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L757">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L760">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L761">        assertThat(executions)</span>
<span class="nc" id="L762">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L763">                .containsExactlyInAnyOrder(&quot;oddFlowTask1&quot;, &quot;evenFlowTask4&quot;);</span>
<span class="nc" id="L764">        assertThat(executions)</span>
<span class="nc" id="L765">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L766">                .containsOnly(procParallelGtw.getId());</span>
<span class="nc" id="L767">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L768">        assertThat(tasks)</span>
<span class="nc" id="L769">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L770">                .containsExactlyInAnyOrder(&quot;oddFlowTask1&quot;, &quot;evenFlowTask4&quot;);</span>
<span class="nc" id="L771">        assertThat(tasks)</span>
<span class="nc" id="L772">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L773">                .containsOnly(procParallelGtw.getId());</span>

        //Complete the process
<span class="nc" id="L776">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L778" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L779">            List&lt;HistoricActivityInstance&gt; subProcesses = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L780">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L781">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L782">                    .list();</span>
            //Direct Migration
<span class="nc" id="L784">            assertThat(subProcesses)</span>
<span class="nc" id="L785">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L786">                    .containsExactlyInAnyOrder(&quot;oddFlowTask1&quot;, &quot;oddFlowTask3&quot;, &quot;evenFlowTask4&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L787">            assertThat(subProcesses)</span>
<span class="nc" id="L788">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L789">                    .containsOnly(procParallelGtw.getId());</span>

<span class="nc" id="L791">            List&lt;HistoricActivityInstance&gt; gtwExecution = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L792">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L793">                    .activityType(&quot;parallelGateway&quot;)</span>
<span class="nc" id="L794">                    .list();</span>
            //Two flows to join in, fork was not executed
<span class="nc" id="L796">            assertThat(gtwExecution)</span>
<span class="nc" id="L797">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L798">                    .containsExactlyInAnyOrder(&quot;parallelJoin&quot;, &quot;parallelJoin&quot;);</span>
<span class="nc" id="L799">            assertThat(gtwExecution)</span>
<span class="nc" id="L800">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L801">                    .containsOnly(procParallelGtw.getId());</span>

<span class="nc bnc" id="L803" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L804">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L805">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L806">                        .list();</span>
<span class="nc" id="L807">                assertThat(historicTasks)</span>
<span class="nc" id="L808">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L809">                        .containsExactlyInAnyOrder(&quot;oddFlowTask1&quot;, &quot;oddFlowTask3&quot;, &quot;evenFlowTask4&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L810">                assertThat(historicTasks)</span>
<span class="nc" id="L811">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L812">                        .containsOnly(procParallelGtw.getId());</span>
            }
        }

<span class="nc" id="L816">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L817">    }</span>

    @Test
    public void testMigrateActivityToParallelGatewayActivities() {
<span class="nc" id="L821">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L823">        ProcessDefinition procParallelGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/parallel-gateway-two-splits-four-tasks.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L827">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L830">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L831">        assertThat(executions)</span>
<span class="nc" id="L832">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L833">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L834">        assertThat(executions)</span>
<span class="nc" id="L835">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L836">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L837">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L838">        assertThat(task)</span>
<span class="nc" id="L839">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L840">                .containsOnly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

        //Migrate each of the parallel task to a task in the parallel gateway
<span class="nc" id="L843">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L844">                .migrateToProcessDefinition(procParallelGtw.getId())</span>
<span class="nc" id="L845">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, Arrays.asList(&quot;oddFlowTask3&quot;, &quot;evenFlowTask2&quot;)));</span>

<span class="nc" id="L847">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L848">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L849">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L851">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L854">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L855">        assertThat(executions)</span>
<span class="nc" id="L856">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L857">                .containsExactlyInAnyOrder(&quot;oddFlowTask3&quot;, &quot;evenFlowTask2&quot;);</span>
<span class="nc" id="L858">        assertThat(executions)</span>
<span class="nc" id="L859">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L860">                .containsOnly(procParallelGtw.getId());</span>
<span class="nc" id="L861">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L862">        assertThat(tasks)</span>
<span class="nc" id="L863">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L864">                .containsExactlyInAnyOrder(&quot;oddFlowTask3&quot;, &quot;evenFlowTask2&quot;);</span>
<span class="nc" id="L865">        assertThat(tasks)</span>
<span class="nc" id="L866">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L867">                .containsOnly(procParallelGtw.getId());</span>

        //Complete the process
<span class="nc" id="L870">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L872" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L873">            List&lt;HistoricActivityInstance&gt; subProcesses = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L874">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L875">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L876">                    .list();</span>
<span class="nc" id="L877">            assertThat(subProcesses)</span>
<span class="nc" id="L878">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L879">                    .containsExactlyInAnyOrder(&quot;userTask1Id&quot;, &quot;oddFlowTask3&quot;, &quot;evenFlowTask2&quot;, &quot;evenFlowTask4&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L880">            assertThat(subProcesses)</span>
<span class="nc" id="L881">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L882">                    .containsOnly(procParallelGtw.getId());</span>

<span class="nc" id="L884">            List&lt;HistoricActivityInstance&gt; gtwExecution = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L885">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L886">                    .activityType(&quot;parallelGateway&quot;)</span>
<span class="nc" id="L887">                    .list();</span>
            //Two flows to join in, fork was not executed
<span class="nc" id="L889">            assertThat(gtwExecution)</span>
<span class="nc" id="L890">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L891">                    .containsExactlyInAnyOrder(&quot;parallelJoin&quot;, &quot;parallelJoin&quot;);</span>
<span class="nc" id="L892">            assertThat(gtwExecution)</span>
<span class="nc" id="L893">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L894">                    .containsOnly(procParallelGtw.getId());</span>

<span class="nc bnc" id="L896" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L897">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L898">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L899">                        .list();</span>
<span class="nc" id="L900">                assertThat(historicTasks)</span>
<span class="nc" id="L901">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L902">                        .containsExactlyInAnyOrder(&quot;userTask1Id&quot;, &quot;oddFlowTask3&quot;, &quot;evenFlowTask2&quot;, &quot;evenFlowTask4&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L903">                assertThat(historicTasks)</span>
<span class="nc" id="L904">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L905">                        .containsOnly(procParallelGtw.getId());</span>
            }
        }

<span class="nc" id="L909">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L910">    }</span>

    @Test
    public void testMigrateActivityToParallelGatewayActivitiesIncompleteActivityMapping() {
<span class="nc" id="L914">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L916">        ProcessDefinition procParallelGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/parallel-gateway-three-splits.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L920">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L923">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L924">        assertThat(executions)</span>
<span class="nc" id="L925">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L926">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L927">        assertThat(executions)</span>
<span class="nc" id="L928">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L929">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L930">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L931">        assertThat(task)</span>
<span class="nc" id="L932">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L933">                .containsOnly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

        //Migrate each of the parallel task to a task in the parallel gateway
<span class="nc" id="L936">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L937">                .migrateToProcessDefinition(procParallelGtw.getId())</span>
<span class="nc" id="L938">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, Arrays.asList(&quot;task1&quot;, &quot;task3&quot;)));</span>

<span class="nc" id="L940">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L941">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L942">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L944">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L947">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L948">        assertThat(executions)</span>
<span class="nc" id="L949">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L950">                .containsExactlyInAnyOrder(&quot;task1&quot;, &quot;task3&quot;);</span>
<span class="nc" id="L951">        assertThat(executions)</span>
<span class="nc" id="L952">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L953">                .containsOnly(procParallelGtw.getId());</span>
<span class="nc" id="L954">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L955">        assertThat(tasks)</span>
<span class="nc" id="L956">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L957">                .containsExactlyInAnyOrder(&quot;task1&quot;, &quot;task3&quot;);</span>
<span class="nc" id="L958">        assertThat(tasks)</span>
<span class="nc" id="L959">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L960">                .containsOnly(procParallelGtw.getId());</span>

        //Try to complete the process
<span class="nc" id="L963">        completeProcessInstanceTasks(processInstance.getId());</span>

        //Parallel Gateway join is not satisfied since there is a missing sequence flow
<span class="nc" id="L966">        List&lt;Execution&gt; parallelJoinExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L967">        assertThat(parallelJoinExecutions)</span>
<span class="nc" id="L968">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L969">                .containsOnly(&quot;parallelJoin&quot;);</span>
<span class="nc" id="L970">    }</span>

    @Test
    public void testMigrateActivityToParallelGatewayForkInsideEmbeddedSubProcess() {
<span class="nc" id="L974">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L976">        ProcessDefinition procParallelGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/parallel-gateway-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L980">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L983">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L984">        assertThat(executions)</span>
<span class="nc" id="L985">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L986">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L987">        assertThat(executions)</span>
<span class="nc" id="L988">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L989">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L990">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L991">        assertThat(task)</span>
<span class="nc" id="L992">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L993">                .containsOnly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

        //Migrate each of the parallel task to a task in the parallel gateway
<span class="nc" id="L996">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L997">                .migrateToProcessDefinition(procParallelGtw.getId())</span>
<span class="nc" id="L998">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;parallelFork&quot;));</span>

<span class="nc" id="L1000">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L1001">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L1002">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1004">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L1007">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1008">        assertThat(executions)</span>
<span class="nc" id="L1009">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1010">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;oddFlowTask1&quot;, &quot;evenFlowTask2&quot;);</span>
<span class="nc" id="L1011">        assertThat(executions)</span>
<span class="nc" id="L1012">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1013">                .containsOnly(procParallelGtw.getId());</span>
<span class="nc" id="L1014">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1015">        assertThat(tasks)</span>
<span class="nc" id="L1016">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1017">                .containsExactlyInAnyOrder(&quot;oddFlowTask1&quot;, &quot;evenFlowTask2&quot;);</span>
<span class="nc" id="L1018">        assertThat(tasks)</span>
<span class="nc" id="L1019">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L1020">                .containsOnly(procParallelGtw.getId());</span>

<span class="nc bnc" id="L1022" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1024">            checkActivityInstances(procParallelGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;oddFlowTask1&quot;, &quot;evenFlowTask2&quot;);</span>
<span class="nc" id="L1025">            checkActivityInstances(procParallelGtw, processInstance, &quot;subProcess&quot;, &quot;subProcess&quot;);</span>
<span class="nc" id="L1026">            checkActivityInstances(procParallelGtw, processInstance, &quot;parallelGateway&quot;, &quot;parallelFork&quot;);</span>

<span class="nc" id="L1028">            checkTaskInstance(procParallelGtw, processInstance, &quot;userTask1Id&quot;, &quot;oddFlowTask1&quot;, &quot;evenFlowTask2&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L1032">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1034" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1036">            checkActivityInstances(procParallelGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;oddFlowTask1&quot;, &quot;oddFlowTask3&quot;, &quot;evenFlowTask2&quot;,</span>
                    &quot;evenFlowTask4&quot;, &quot;taskAfter&quot;);
<span class="nc" id="L1038">            checkActivityInstances(procParallelGtw, processInstance, &quot;subProcess&quot;, &quot;subProcess&quot;);</span>
<span class="nc" id="L1039">            checkActivityInstances(procParallelGtw, processInstance, &quot;parallelGateway&quot;, &quot;parallelFork&quot;, &quot;parallelJoin&quot;, &quot;parallelJoin&quot;);</span>

<span class="nc" id="L1041">            List&lt;HistoricActivityInstance&gt; subProcExecution = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L1042">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1043">                    .activityType(&quot;subProcess&quot;)</span>
<span class="nc" id="L1044">                    .list();</span>
<span class="nc" id="L1045">            assertThat(subProcExecution)</span>
<span class="nc" id="L1046">                    .extracting(HistoricActivityInstance::getActivityId, HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L1047">                    .containsExactly(tuple(&quot;subProcess&quot;, procParallelGtw.getId()));</span>

<span class="nc" id="L1049">            List&lt;HistoricActivityInstance&gt; gtwExecution = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L1050">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1051">                    .activityType(&quot;parallelGateway&quot;)</span>
<span class="nc" id="L1052">                    .list();</span>
            //Two flows to join in
<span class="nc" id="L1054">            assertThat(gtwExecution)</span>
<span class="nc" id="L1055">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L1056">                    .containsExactlyInAnyOrder(&quot;parallelFork&quot;, &quot;parallelJoin&quot;, &quot;parallelJoin&quot;);</span>
<span class="nc" id="L1057">            assertThat(gtwExecution)</span>
<span class="nc" id="L1058">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L1059">                    .containsOnly(procParallelGtw.getId());</span>

<span class="nc bnc" id="L1061" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1062">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1063">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1064">                        .list();</span>
<span class="nc" id="L1065">                assertThat(historicTasks)</span>
<span class="nc" id="L1066">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L1067">                        .containsExactlyInAnyOrder(&quot;userTask1Id&quot;, &quot;oddFlowTask1&quot;, &quot;oddFlowTask3&quot;, &quot;evenFlowTask2&quot;, &quot;evenFlowTask4&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L1068">                assertThat(historicTasks)</span>
<span class="nc" id="L1069">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L1070">                        .containsOnly(procParallelGtw.getId());</span>
            }
        }

<span class="nc" id="L1074">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1075">    }</span>

    @Test
    public void testMigrateParallelActivitiesToParallelGatewayActivitiesInsideEmbeddedSubProcess() {
<span class="nc" id="L1079">        ProcessDefinition procParallelTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L1081">        ProcessDefinition procParallelGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/parallel-gateway-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance and spawn the parallel task
<span class="nc" id="L1085">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procParallelTask.getId());</span>

<span class="nc" id="L1087">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1088">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1089">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L1092">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1093">        assertThat(executions)</span>
<span class="nc" id="L1094">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1095">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L1096">        assertThat(executions)</span>
<span class="nc" id="L1097">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1098">                .containsOnly(procParallelTask.getId());</span>
<span class="nc" id="L1099">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1100">        assertThat(tasks)</span>
<span class="nc" id="L1101">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1102">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L1103">        assertThat(tasks)</span>
<span class="nc" id="L1104">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L1105">                .containsOnly(procParallelTask.getId());</span>

        //Migrate each of the parallel task to a task in the parallel gateway
<span class="nc" id="L1108">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1109">                .migrateToProcessDefinition(procParallelGtw.getId())</span>
<span class="nc" id="L1110">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;processTask&quot;, &quot;oddFlowTask1&quot;))</span>
<span class="nc" id="L1111">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;evenFlowTask4&quot;));</span>

<span class="nc" id="L1113">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L1114">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L1115">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1117">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L1120">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1121">        assertThat(executions)</span>
<span class="nc" id="L1122">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1123">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;oddFlowTask1&quot;, &quot;evenFlowTask4&quot;);</span>
<span class="nc" id="L1124">        assertThat(executions)</span>
<span class="nc" id="L1125">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1126">                .containsOnly(procParallelGtw.getId());</span>
<span class="nc" id="L1127">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1128">        assertThat(tasks)</span>
<span class="nc" id="L1129">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1130">                .containsExactlyInAnyOrder(&quot;oddFlowTask1&quot;, &quot;evenFlowTask4&quot;);</span>
<span class="nc" id="L1131">        assertThat(tasks)</span>
<span class="nc" id="L1132">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L1133">                .containsOnly(procParallelGtw.getId());</span>

<span class="nc bnc" id="L1135" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L1136">            checkActivityInstances(procParallelGtw, processInstance, &quot;userTask&quot;, &quot;oddFlowTask1&quot;, &quot;evenFlowTask4&quot;);</span>
<span class="nc" id="L1137">            checkActivityInstances(procParallelGtw, processInstance, &quot;subProcess&quot;, &quot;subProcess&quot;);</span>

<span class="nc" id="L1139">            checkTaskInstance(procParallelGtw, processInstance, &quot;oddFlowTask1&quot;, &quot;evenFlowTask4&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L1143">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1145" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L1146">            checkActivityInstances(procParallelGtw, processInstance, &quot;userTask&quot;, &quot;oddFlowTask1&quot;, &quot;oddFlowTask3&quot;, &quot;evenFlowTask4&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L1147">            checkActivityInstances(procParallelGtw, processInstance, &quot;subProcess&quot;, &quot;subProcess&quot;);</span>
<span class="nc" id="L1148">            checkActivityInstances(procParallelGtw, processInstance, &quot;parallelGateway&quot;, &quot;parallelJoin&quot;, &quot;parallelJoin&quot;);</span>

<span class="nc" id="L1150">            checkTaskInstance(procParallelGtw, processInstance, &quot;oddFlowTask1&quot;, &quot;oddFlowTask3&quot;, &quot;evenFlowTask4&quot;, &quot;taskAfter&quot;);</span>

<span class="nc" id="L1152">            List&lt;HistoricActivityInstance&gt; subProcExecution = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L1153">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1154">                    .activityType(&quot;subProcess&quot;)</span>
<span class="nc" id="L1155">                    .list();</span>
<span class="nc" id="L1156">            assertThat(subProcExecution)</span>
<span class="nc" id="L1157">                    .extracting(HistoricActivityInstance::getActivityId, HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L1158">                    .containsExactly(tuple(&quot;subProcess&quot;, procParallelGtw.getId()));</span>

<span class="nc" id="L1160">            List&lt;HistoricActivityInstance&gt; gtwExecution = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L1161">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1162">                    .activityType(&quot;parallelGateway&quot;)</span>
<span class="nc" id="L1163">                    .list();</span>
            //Two flows to join in, fork was not executed
<span class="nc" id="L1165">            assertThat(gtwExecution)</span>
<span class="nc" id="L1166">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L1167">                    .containsExactlyInAnyOrder(&quot;parallelJoin&quot;, &quot;parallelJoin&quot;);</span>
<span class="nc" id="L1168">            assertThat(gtwExecution)</span>
<span class="nc" id="L1169">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L1170">                    .containsOnly(procParallelGtw.getId());</span>

<span class="nc bnc" id="L1172" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1173">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1174">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1175">                        .list();</span>
<span class="nc" id="L1176">                assertThat(historicTasks)</span>
<span class="nc" id="L1177">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L1178">                        .containsExactlyInAnyOrder(&quot;oddFlowTask1&quot;, &quot;oddFlowTask3&quot;, &quot;evenFlowTask4&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L1179">                assertThat(historicTasks)</span>
<span class="nc" id="L1180">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L1181">                        .containsOnly(procParallelGtw.getId());</span>
            }
        }

<span class="nc" id="L1185">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1186">    }</span>

    @Test
    public void testMigrateActivityToParallelGatewayActivitiesInsideEmbeddedSubProcess() {
<span class="nc" id="L1190">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L1192">        ProcessDefinition procParallelGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/parallel-gateway-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L1196">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L1199">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1200">        assertThat(executions)</span>
<span class="nc" id="L1201">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1202">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1203">        assertThat(executions)</span>
<span class="nc" id="L1204">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1205">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L1206">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1207">        assertThat(task)</span>
<span class="nc" id="L1208">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1209">                .containsOnly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

        //Migrate each of the parallel task to a task in the parallel gateway
<span class="nc" id="L1212">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1213">                .migrateToProcessDefinition(procParallelGtw.getId())</span>
<span class="nc" id="L1214">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, Arrays.asList(&quot;oddFlowTask3&quot;, &quot;evenFlowTask2&quot;)));</span>

<span class="nc" id="L1216">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L1217">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L1218">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1220">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L1223">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1224">        assertThat(executions)</span>
<span class="nc" id="L1225">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1226">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;oddFlowTask3&quot;, &quot;evenFlowTask2&quot;);</span>
<span class="nc" id="L1227">        assertThat(executions)</span>
<span class="nc" id="L1228">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1229">                .containsOnly(procParallelGtw.getId());</span>
<span class="nc" id="L1230">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1231">        assertThat(tasks)</span>
<span class="nc" id="L1232">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1233">                .containsExactlyInAnyOrder(&quot;oddFlowTask3&quot;, &quot;evenFlowTask2&quot;);</span>
<span class="nc" id="L1234">        assertThat(tasks)</span>
<span class="nc" id="L1235">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L1236">                .containsOnly(procParallelGtw.getId());</span>

<span class="nc bnc" id="L1238" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L1239">            checkActivityInstances(procParallelGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;evenFlowTask2&quot;, &quot;oddFlowTask3&quot;);</span>
<span class="nc" id="L1240">            checkActivityInstances(procParallelGtw, processInstance, &quot;subProcess&quot;, &quot;subProcess&quot;);</span>

<span class="nc" id="L1242">            checkTaskInstance(procParallelGtw, processInstance, &quot;userTask1Id&quot;, &quot;evenFlowTask2&quot;, &quot;oddFlowTask3&quot;);</span>
        }

        //Complete the process
<span class="nc" id="L1246">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1248" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L1249">            checkActivityInstances(procParallelGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;oddFlowTask3&quot;, &quot;evenFlowTask2&quot;, &quot;evenFlowTask4&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L1250">            checkActivityInstances(procParallelGtw, processInstance, &quot;subProcess&quot;, &quot;subProcess&quot;);</span>
<span class="nc" id="L1251">            checkActivityInstances(procParallelGtw, processInstance, &quot;parallelGateway&quot;, &quot;parallelJoin&quot;, &quot;parallelJoin&quot;);</span>

<span class="nc" id="L1253">            List&lt;HistoricActivityInstance&gt; subProcExecution = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L1254">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1255">                    .activityType(&quot;subProcess&quot;)</span>
<span class="nc" id="L1256">                    .list();</span>
<span class="nc" id="L1257">            assertThat(subProcExecution)</span>
<span class="nc" id="L1258">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L1259">                    .containsExactly(&quot;subProcess&quot;);</span>
<span class="nc" id="L1260">            assertThat(subProcExecution)</span>
<span class="nc" id="L1261">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L1262">                    .containsOnly(procParallelGtw.getId());</span>

<span class="nc" id="L1264">            List&lt;HistoricActivityInstance&gt; gtwExecution = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L1265">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1266">                    .activityType(&quot;parallelGateway&quot;)</span>
<span class="nc" id="L1267">                    .list();</span>
            //Two flows to join in, fork was not executed
<span class="nc" id="L1269">            assertThat(gtwExecution)</span>
<span class="nc" id="L1270">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L1271">                    .containsExactlyInAnyOrder(&quot;parallelJoin&quot;, &quot;parallelJoin&quot;);</span>
<span class="nc" id="L1272">            assertThat(gtwExecution)</span>
<span class="nc" id="L1273">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L1274">                    .containsOnly(procParallelGtw.getId());</span>

<span class="nc bnc" id="L1276" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1277">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1278">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1279">                        .list();</span>
<span class="nc" id="L1280">                assertThat(historicTasks)</span>
<span class="nc" id="L1281">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L1282">                        .containsExactlyInAnyOrder(&quot;userTask1Id&quot;, &quot;oddFlowTask3&quot;, &quot;evenFlowTask2&quot;, &quot;evenFlowTask4&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L1283">                assertThat(historicTasks)</span>
<span class="nc" id="L1284">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L1285">                        .containsOnly(procParallelGtw.getId());</span>
            }
        }

<span class="nc" id="L1289">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1290">    }</span>

    //-- Inclusive Gateway
    @Test
    public void testMigrateActivityToInclusiveGatewaySplitWithDefault() {
<span class="nc" id="L1295">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L1297">        ProcessDefinition procInclusiveGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/inclusive-gateway-fork-and-join-with-default.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L1301">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L1304">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1305">        assertThat(executions)</span>
<span class="nc" id="L1306">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1307">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1308">        assertThat(executions)</span>
<span class="nc" id="L1309">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1310">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L1311">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1312">        assertThat(task)</span>
<span class="nc" id="L1313">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1314">                .containsOnly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

<span class="nc" id="L1316">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1317">                .migrateToProcessDefinition(procInclusiveGtw.getId())</span>
<span class="nc" id="L1318">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, Arrays.asList(&quot;gwFork&quot;)));</span>

<span class="nc" id="L1320">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L1321">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L1322">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1324">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L1326">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1327">        assertThat(executions)</span>
<span class="nc" id="L1328">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1329">                .containsExactlyInAnyOrder(&quot;taskEquals&quot;);</span>
<span class="nc" id="L1330">        assertThat(executions)</span>
<span class="nc" id="L1331">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1332">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L1334">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1335">        assertThat(tasks)</span>
<span class="nc" id="L1336">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1337">                .containsOnly(tuple(&quot;taskEquals&quot;, procInclusiveGtw.getId()));</span>

        //Complete gateway tasks
<span class="nc" id="L1340">        tasks.forEach(this::completeTask);</span>

<span class="nc" id="L1342">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1343">        assertThat(executions)</span>
<span class="nc" id="L1344">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1345">                .containsExactly(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1346">        assertThat(executions)</span>
<span class="nc" id="L1347">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1348">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L1350">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1351">        assertThat(tasks).extracting(Task::getTaskDefinitionKey).containsExactly(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1352">        assertThat(tasks).extracting(Task::getProcessDefinitionId).containsOnly(procInclusiveGtw.getId());</span>
<span class="nc" id="L1353">        assertThat(tasks)</span>
<span class="nc" id="L1354">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1355">                .containsOnly(tuple(&quot;taskAfter&quot;, procInclusiveGtw.getId()));</span>

<span class="nc bnc" id="L1357" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1359">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;inclusiveGateway&quot;, &quot;gwFork&quot;, &quot;gwJoin&quot;);</span>

<span class="nc" id="L1361">            checkTaskInstance(procInclusiveGtw, processInstance, &quot;userTask1Id&quot;, &quot;taskEquals&quot;, &quot;taskAfter&quot;);</span>
        }

<span class="nc" id="L1364">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1366" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1368">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;taskEquals&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L1369">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;inclusiveGateway&quot;, &quot;gwJoin&quot;, &quot;gwFork&quot;);</span>

<span class="nc" id="L1371">            checkTaskInstance(procInclusiveGtw, processInstance, &quot;userTask1Id&quot;, &quot;taskEquals&quot;, &quot;taskAfter&quot;);</span>
        }

<span class="nc" id="L1374">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1375">    }</span>

    @Test
    public void testMigrateActivityToInclusiveGatewaySplitNoOutgoingSequenceSelectionException() {
<span class="nc" id="L1379">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L1381">        ProcessDefinition procInclusiveGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/inclusive-gateway-fork-and-join.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L1385">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L1388">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1389">        assertThat(executions)</span>
<span class="nc" id="L1390">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1391">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1392">        assertThat(executions)</span>
<span class="nc" id="L1393">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1394">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L1395">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1396">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1397">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefOneTask.getId());</span>
<span class="nc" id="L1398">        assertThat(task)</span>
<span class="nc" id="L1399">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1400">                .containsOnly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

<span class="nc" id="L1402">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L1403">            ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1404">                    .migrateToProcessDefinition(procInclusiveGtw.getId())</span>
<span class="nc" id="L1405">                    .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, Arrays.asList(&quot;gwFork&quot;))</span>
<span class="nc" id="L1406">                            .withLocalVariableForAllActivities(&quot;myConditionVar&quot;, 10));</span>

<span class="nc" id="L1408">            ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L1409">                    .validateMigration(processInstance.getId());</span>
<span class="nc" id="L1410">            assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1412">            processInstanceMigrationBuilder.migrate(processInstance.getId());</span>
<span class="nc" id="L1413">        })</span>
<span class="nc" id="L1414">                .isExactlyInstanceOf(FlowableException.class)</span>
<span class="nc" id="L1415">                .hasMessageStartingWith(&quot;No outgoing sequence flow of element 'gwFork' could be selected for continuing the process for Execution[ id '&quot;)</span>
<span class="nc" id="L1416">                .hasMessageContainingAll(&quot; - definition 'startInclusiveGwProcess:1:&quot;, &quot; - activity 'gwFork'&quot;);</span>
<span class="nc" id="L1417">    }</span>

    @Test
    public void testMigrateActivityToInclusiveGatewaySplitWithConditionSpecifiedBeforeMigration() {
<span class="nc" id="L1421">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L1423">        ProcessDefinition procInclusiveGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/inclusive-gateway-fork-and-join.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L1427">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L1430">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1431">        assertThat(executions)</span>
<span class="nc" id="L1432">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1433">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1434">        assertThat(executions)</span>
<span class="nc" id="L1435">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1436">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L1437">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1438">        assertThat(task)</span>
<span class="nc" id="L1439">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1440">                .containsOnly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

<span class="nc" id="L1442">        runtimeService.setVariable(executions.get(0).getId(), &quot;myConditionVar&quot;, 11);</span>

<span class="nc" id="L1444">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1445">                .migrateToProcessDefinition(procInclusiveGtw.getId())</span>
<span class="nc" id="L1446">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, Arrays.asList(&quot;gwFork&quot;)));</span>

<span class="nc" id="L1448">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L1449">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L1450">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1452">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L1454">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1455">        assertThat(executions)</span>
<span class="nc" id="L1456">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1457">                .containsExactlyInAnyOrder(&quot;taskMore&quot;);</span>
<span class="nc" id="L1458">        assertThat(executions)</span>
<span class="nc" id="L1459">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1460">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L1462">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1463">        assertThat(tasks)</span>
<span class="nc" id="L1464">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1465">                .containsExactly(tuple(&quot;taskMore&quot;, procInclusiveGtw.getId()));</span>

        //Complete gateway tasks
<span class="nc" id="L1468">        tasks.forEach(this::completeTask);</span>

<span class="nc" id="L1470">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1471">        assertThat(executions)</span>
<span class="nc" id="L1472">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1473">                .containsExactly(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1474">        assertThat(executions)</span>
<span class="nc" id="L1475">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1476">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L1478">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1479">        assertThat(tasks)</span>
<span class="nc" id="L1480">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1481">                .containsExactly(tuple(&quot;taskAfter&quot;, procInclusiveGtw.getId()));</span>

<span class="nc bnc" id="L1483" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L1484">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;taskMore&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L1485">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;inclusiveGateway&quot;, &quot;gwJoin&quot;, &quot;gwFork&quot;);</span>

<span class="nc" id="L1487">            checkTaskInstance(procInclusiveGtw, processInstance, &quot;userTask1Id&quot;, &quot;taskMore&quot;, &quot;taskAfter&quot;);</span>

        }

<span class="nc" id="L1491">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1493" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1495">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;taskMore&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L1496">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;inclusiveGateway&quot;, &quot;gwJoin&quot;, &quot;gwFork&quot;);</span>

<span class="nc" id="L1498">            checkTaskInstance(procInclusiveGtw, processInstance, &quot;userTask1Id&quot;, &quot;taskMore&quot;, &quot;taskAfter&quot;);</span>

        }

<span class="nc" id="L1502">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1503">    }</span>

    @Test
    public void testMigrateActivityToInclusiveGatewaySplitWithConditionSpecifiedDuringMigration() {
<span class="nc" id="L1507">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L1509">        ProcessDefinition procInclusiveGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/inclusive-gateway-fork-and-join.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L1513">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L1516">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1517">        assertThat(executions)</span>
<span class="nc" id="L1518">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1519">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1520">        assertThat(executions)</span>
<span class="nc" id="L1521">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1522">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L1523">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1524">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1525">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefOneTask.getId());</span>
<span class="nc" id="L1526">        assertThat(task)</span>
<span class="nc" id="L1527">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1528">                .containsExactly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

<span class="nc" id="L1530">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1531">                .migrateToProcessDefinition(procInclusiveGtw.getId())</span>
<span class="nc" id="L1532">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, Arrays.asList(&quot;gwFork&quot;))</span>
<span class="nc" id="L1533">                        .withLocalVariableForAllActivities(&quot;myConditionVar&quot;, 11));</span>

<span class="nc" id="L1535">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L1536">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L1537">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1539">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L1541">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1542">        assertThat(executions)</span>
<span class="nc" id="L1543">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1544">                .containsExactlyInAnyOrder(&quot;taskMore&quot;);</span>
<span class="nc" id="L1545">        assertThat(executions)</span>
<span class="nc" id="L1546">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1547">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L1549">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1550">        assertThat(tasks)</span>
<span class="nc" id="L1551">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1552">                .containsExactly(tuple(&quot;taskMore&quot;, procInclusiveGtw.getId()));</span>

        //Complete gateway tasks
<span class="nc" id="L1555">        tasks.forEach(this::completeTask);</span>

<span class="nc" id="L1557">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1558">        assertThat(executions)</span>
<span class="nc" id="L1559">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1560">                .containsExactly(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1561">        assertThat(executions)</span>
<span class="nc" id="L1562">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1563">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L1565">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1566">        assertThat(tasks)</span>
<span class="nc" id="L1567">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1568">                .containsExactly(tuple(&quot;taskAfter&quot;, procInclusiveGtw.getId()));</span>

<span class="nc bnc" id="L1570" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1572">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;taskMore&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L1573">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;inclusiveGateway&quot;, &quot;gwJoin&quot;, &quot;gwFork&quot;);</span>

<span class="nc" id="L1575">            checkTaskInstance(procInclusiveGtw, processInstance, &quot;taskMore&quot;, &quot;userTask1Id&quot;, &quot;taskAfter&quot;);</span>

        }

<span class="nc" id="L1579">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1581" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1583">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;taskMore&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L1584">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;inclusiveGateway&quot;, &quot;gwJoin&quot;, &quot;gwFork&quot;);</span>

<span class="nc" id="L1586">            checkTaskInstance(procInclusiveGtw, processInstance, &quot;taskMore&quot;, &quot;userTask1Id&quot;, &quot;taskAfter&quot;);</span>

        }

<span class="nc" id="L1590">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1591">    }</span>

    @Test
    public void testMigrateActivityToInclusiveGatewaySplitWithConditionSpecifiedAsProcessVariableDuringMigration() {
<span class="nc" id="L1595">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L1597">        ProcessDefinition procInclusiveGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/inclusive-gateway-fork-and-join.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L1601">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L1604">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1605">        assertThat(executions)</span>
<span class="nc" id="L1606">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1607">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1608">        assertThat(executions)</span>
<span class="nc" id="L1609">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1610">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L1611">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1612">        assertThat(task)</span>
<span class="nc" id="L1613">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1614">                .containsExactly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

<span class="nc" id="L1616">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1617">                .migrateToProcessDefinition(procInclusiveGtw.getId())</span>
<span class="nc" id="L1618">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, Arrays.asList(&quot;gwFork&quot;)))</span>
<span class="nc" id="L1619">                .withProcessInstanceVariable(&quot;myConditionVar&quot;, 11);</span>

<span class="nc" id="L1621">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L1622">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L1623">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1625">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L1627">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1628">        assertThat(executions)</span>
<span class="nc" id="L1629">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1630">                .containsExactlyInAnyOrder(&quot;taskMore&quot;);</span>
<span class="nc" id="L1631">        assertThat(executions)</span>
<span class="nc" id="L1632">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1633">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L1635">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1636">        assertThat(tasks)</span>
<span class="nc" id="L1637">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1638">                .containsExactly(tuple(&quot;taskMore&quot;, procInclusiveGtw.getId()));</span>

        //Complete gateway tasks
<span class="nc" id="L1641">        tasks.forEach(this::completeTask);</span>

<span class="nc" id="L1643">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1644">        assertThat(executions)</span>
<span class="nc" id="L1645">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1646">                .containsExactly(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1647">        assertThat(executions)</span>
<span class="nc" id="L1648">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1649">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L1651">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1652">        assertThat(tasks)</span>
<span class="nc" id="L1653">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1654">                .containsExactly(tuple(&quot;taskAfter&quot;, procInclusiveGtw.getId()));</span>

<span class="nc bnc" id="L1656" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1658">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;taskMore&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L1659">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;inclusiveGateway&quot;, &quot;gwJoin&quot;, &quot;gwFork&quot;);</span>

<span class="nc" id="L1661">            checkTaskInstance(procInclusiveGtw, processInstance, &quot;taskMore&quot;, &quot;userTask1Id&quot;, &quot;taskAfter&quot;);</span>

        }

<span class="nc" id="L1665">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1667" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1669">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;taskMore&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L1670">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;inclusiveGateway&quot;, &quot;gwJoin&quot;, &quot;gwFork&quot;);</span>

<span class="nc" id="L1672">            checkTaskInstance(procInclusiveGtw, processInstance, &quot;taskMore&quot;, &quot;userTask1Id&quot;, &quot;taskAfter&quot;);</span>

        }
<span class="nc" id="L1675">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1676">    }</span>

    @Test
    public void testMigrateActivityToOneActivityInsideInclusiveGateway() {
<span class="nc" id="L1680">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L1682">        ProcessDefinition procInclusiveGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/inclusive-gateway-fork-and-join-with-default.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L1686">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L1689">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1690">        assertThat(executions)</span>
<span class="nc" id="L1691">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1692">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1693">        assertThat(executions)</span>
<span class="nc" id="L1694">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1695">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L1696">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1697">        assertThat(task)</span>
<span class="nc" id="L1698">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1699">                .containsExactly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

<span class="nc" id="L1701">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1702">                .migrateToProcessDefinition(procInclusiveGtw.getId())</span>
<span class="nc" id="L1703">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, Arrays.asList(&quot;taskLess&quot;)));</span>

<span class="nc" id="L1705">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L1706">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L1707">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1709">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L1711">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1712">        assertThat(executions)</span>
<span class="nc" id="L1713">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1714">                .containsExactlyInAnyOrder(&quot;taskLess&quot;);</span>
<span class="nc" id="L1715">        assertThat(executions)</span>
<span class="nc" id="L1716">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1717">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L1719">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1720">        assertThat(tasks)</span>
<span class="nc" id="L1721">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1722">                .containsExactly(tuple(&quot;taskLess&quot;, procInclusiveGtw.getId()));</span>

        //Complete the task
<span class="nc" id="L1725">        completeTask(tasks.get(0));</span>

<span class="nc" id="L1727">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1728">        assertThat(executions)</span>
<span class="nc" id="L1729">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1730">                .containsExactly(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1731">        assertThat(executions)</span>
<span class="nc" id="L1732">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1733">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L1735">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1736">        assertThat(tasks)</span>
<span class="nc" id="L1737">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1738">                .containsExactly(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1739">        assertThat(tasks)</span>
<span class="nc" id="L1740">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L1741">                .containsOnly(procInclusiveGtw.getId());</span>
<span class="nc" id="L1742">        assertThat(tasks)</span>
<span class="nc" id="L1743">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1744">                .containsExactly(tuple(&quot;taskAfter&quot;, procInclusiveGtw.getId()));</span>

<span class="nc bnc" id="L1746" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1748">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;userTask&quot;, &quot;taskLess&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L1749">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;inclusiveGateway&quot;, &quot;gwJoin&quot;);</span>

<span class="nc" id="L1751">            checkTaskInstance(procInclusiveGtw, processInstance, &quot;taskAfter&quot;, &quot;taskLess&quot;);</span>
        }

<span class="nc" id="L1754">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1756" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1758">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;userTask&quot;, &quot;taskLess&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L1759">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;inclusiveGateway&quot;, &quot;gwJoin&quot;);</span>

<span class="nc" id="L1761">            checkTaskInstance(procInclusiveGtw, processInstance, &quot;taskAfter&quot;, &quot;taskLess&quot;);</span>
        }

<span class="nc" id="L1764">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1765">    }</span>

    @Test
    public void testMigrateActivityToParallelActivitiesInsideInclusiveGateway() {
<span class="nc" id="L1769">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L1771">        ProcessDefinition procInclusiveGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/inclusive-gateway-fork-and-join.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L1775">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L1778">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1779">        assertThat(executions)</span>
<span class="nc" id="L1780">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1781">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1782">        assertThat(executions)</span>
<span class="nc" id="L1783">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1784">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L1785">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1786">        assertThat(task)</span>
<span class="nc" id="L1787">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1788">                .containsExactly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

<span class="nc" id="L1790">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1791">                .migrateToProcessDefinition(procInclusiveGtw.getId())</span>
<span class="nc" id="L1792">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, Arrays.asList(&quot;taskMore&quot;, &quot;taskLess&quot;)));</span>

<span class="nc" id="L1794">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L1795">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L1796">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1798">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L1800">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1801">        assertThat(executions)</span>
<span class="nc" id="L1802">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1803">                .containsExactlyInAnyOrder(&quot;taskMore&quot;, &quot;taskLess&quot;);</span>
<span class="nc" id="L1804">        assertThat(executions)</span>
<span class="nc" id="L1805">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1806">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L1808">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1809">        assertThat(tasks)</span>
<span class="nc" id="L1810">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1811">                .containsExactlyInAnyOrder(&quot;taskMore&quot;, &quot;taskLess&quot;);</span>
<span class="nc" id="L1812">        assertThat(tasks)</span>
<span class="nc" id="L1813">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L1814">                .containsOnly(procInclusiveGtw.getId());</span>

        //Complete one sequence
<span class="nc" id="L1817">        task = tasks.stream().filter(t -&gt; &quot;taskMore&quot;.equals(t.getTaskDefinitionKey())).findFirst().get();</span>
<span class="nc" id="L1818">        completeTask(task);</span>

<span class="nc" id="L1820">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1821">        assertThat(executions)</span>
<span class="nc" id="L1822">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1823">                .containsExactlyInAnyOrder(&quot;gwJoin&quot;, &quot;taskLess&quot;);</span>
<span class="nc" id="L1824">        assertThat(executions)</span>
<span class="nc" id="L1825">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1826">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L1828">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1829">        assertThat(tasks)</span>
<span class="nc" id="L1830">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1831">                .containsExactly(tuple(&quot;taskLess&quot;, procInclusiveGtw.getId()));</span>

        //Complete the rest
<span class="nc" id="L1834">        tasks.forEach(this::completeTask);</span>

<span class="nc" id="L1836">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1837">        assertThat(executions)</span>
<span class="nc" id="L1838">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1839">                .containsExactly(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1840">        assertThat(executions)</span>
<span class="nc" id="L1841">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1842">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L1844">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1845">        assertThat(tasks)</span>
<span class="nc" id="L1846">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1847">                .containsExactly(tuple(&quot;taskAfter&quot;, procInclusiveGtw.getId()));</span>

<span class="nc bnc" id="L1849" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1851">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;taskLess&quot;, &quot;taskMore&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L1852">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;inclusiveGateway&quot;, &quot;gwJoin&quot;, &quot;gwJoin&quot;);</span>

<span class="nc" id="L1854">            checkTaskInstance(procInclusiveGtw, processInstance, &quot;userTask1Id&quot;, &quot;taskLess&quot;, &quot;taskMore&quot;, &quot;taskAfter&quot;);</span>
        }

<span class="nc" id="L1857">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1859" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1861">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;taskLess&quot;, &quot;taskMore&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L1862">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;inclusiveGateway&quot;, &quot;gwJoin&quot;, &quot;gwJoin&quot;);</span>

<span class="nc" id="L1864">            checkTaskInstance(procInclusiveGtw, processInstance, &quot;userTask1Id&quot;, &quot;taskLess&quot;, &quot;taskMore&quot;, &quot;taskAfter&quot;);</span>
        }

<span class="nc" id="L1867">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1868">    }</span>

    @Test
    public void testMigrateParallelActivitiesToParallelActivitiesInsideInclusiveGateway() {
<span class="nc" id="L1872">        ProcessDefinition procParallelTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L1874">        ProcessDefinition procInclusiveGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/inclusive-gateway-fork-multiple-outgoing-sequences.bpmn20.xml&quot;);

        //Start the processInstance
        //Start the processInstance and spawn the parallel task
<span class="nc" id="L1879">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procParallelTask.getId());</span>

<span class="nc" id="L1881">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1882">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1883">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L1886">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1887">        assertThat(executions)</span>
<span class="nc" id="L1888">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1889">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L1890">        assertThat(executions)</span>
<span class="nc" id="L1891">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1892">                .containsOnly(procParallelTask.getId());</span>
<span class="nc" id="L1893">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1894">        assertThat(tasks)</span>
<span class="nc" id="L1895">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1896">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L1897">        assertThat(tasks)</span>
<span class="nc" id="L1898">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L1899">                .containsOnly(procParallelTask.getId());</span>

        //Migrate each of the parallel task to a task in the parallel gateway
<span class="nc" id="L1902">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1903">                .migrateToProcessDefinition(procInclusiveGtw.getId())</span>
<span class="nc" id="L1904">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;processTask&quot;, &quot;taskMore&quot;))</span>
<span class="nc" id="L1905">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;taskLess&quot;));</span>

<span class="nc" id="L1907">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L1908">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L1909">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1911">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L1913">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1914">        assertThat(executions)</span>
<span class="nc" id="L1915">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1916">                .containsExactlyInAnyOrder(&quot;taskMore&quot;, &quot;taskLess&quot;);</span>
<span class="nc" id="L1917">        assertThat(executions)</span>
<span class="nc" id="L1918">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1919">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L1921">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1922">        assertThat(tasks)</span>
<span class="nc" id="L1923">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1924">                .containsExactlyInAnyOrder(&quot;taskMore&quot;, &quot;taskLess&quot;);</span>
<span class="nc" id="L1925">        assertThat(tasks)</span>
<span class="nc" id="L1926">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L1927">                .containsOnly(procInclusiveGtw.getId());</span>

        //Complete one sequence
<span class="nc" id="L1930">        Task task = tasks.stream().filter(t -&gt; &quot;taskMore&quot;.equals(t.getTaskDefinitionKey())).findFirst().get();</span>
<span class="nc" id="L1931">        completeTask(task);</span>

<span class="nc" id="L1933">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1934">        assertThat(executions)</span>
<span class="nc" id="L1935">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1936">                .containsExactlyInAnyOrder(&quot;gwJoin&quot;, &quot;taskLess&quot;);</span>
<span class="nc" id="L1937">        assertThat(executions)</span>
<span class="nc" id="L1938">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1939">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L1941">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1942">        assertThat(tasks)</span>
<span class="nc" id="L1943">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1944">                .containsExactly(tuple(&quot;taskLess&quot;, procInclusiveGtw.getId()));</span>

        //Complete the rest
<span class="nc" id="L1947">        tasks.forEach(this::completeTask);</span>

<span class="nc" id="L1949">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1950">        assertThat(executions)</span>
<span class="nc" id="L1951">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1952">                .containsExactly(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1953">        assertThat(executions)</span>
<span class="nc" id="L1954">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1955">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L1957">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1958">        assertThat(tasks)</span>
<span class="nc" id="L1959">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L1960">                .containsExactly(tuple(&quot;taskAfter&quot;, procInclusiveGtw.getId()));</span>

<span class="nc bnc" id="L1962" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1964">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;userTask&quot;, &quot;taskMore&quot;, &quot;taskLess&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L1965">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;inclusiveGateway&quot;, &quot;gwJoin&quot;, &quot;gwJoin&quot;);</span>

<span class="nc" id="L1967">            checkTaskInstance(procInclusiveGtw, processInstance, &quot;taskMore&quot;, &quot;taskLess&quot;, &quot;taskAfter&quot;);</span>
        }

<span class="nc" id="L1970">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc bnc" id="L1971" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1973">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;userTask&quot;, &quot;taskMore&quot;, &quot;taskLess&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L1974">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;inclusiveGateway&quot;, &quot;gwJoin&quot;, &quot;gwJoin&quot;);</span>

<span class="nc" id="L1976">            checkTaskInstance(procInclusiveGtw, processInstance, &quot;taskMore&quot;, &quot;taskLess&quot;, &quot;taskAfter&quot;);</span>
        }
<span class="nc" id="L1978">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1979">    }</span>

    @Test
    public void testMigrateInclusiveGatewayParallelActivitiesToSingleActivity() {
<span class="nc" id="L1983">        ProcessDefinition procInclusiveGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/inclusive-gateway-fork-multiple-outgoing-sequences.bpmn20.xml&quot;);
<span class="nc" id="L1985">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L1989">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procInclusiveGtw.getId(), Collections.singletonMap(&quot;myConditionVar&quot;, 10));</span>
<span class="nc" id="L1990">        completeTask(taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult());</span>

        //Confirm the state to migrate
<span class="nc" id="L1993">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1994">        assertThat(executions)</span>
<span class="nc" id="L1995">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1996">                .containsExactlyInAnyOrder(&quot;taskMore&quot;, &quot;taskLess&quot;);</span>
<span class="nc" id="L1997">        assertThat(executions)</span>
<span class="nc" id="L1998">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1999">                .containsOnly(procInclusiveGtw.getId());</span>
<span class="nc" id="L2000">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2001">        assertThat(tasks)</span>
<span class="nc" id="L2002">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2003">                .containsExactlyInAnyOrder(&quot;taskMore&quot;, &quot;taskLess&quot;);</span>
<span class="nc" id="L2004">        assertThat(tasks)</span>
<span class="nc" id="L2005">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2006">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L2008">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2009">                .migrateToProcessDefinition(procDefOneTask.getId())</span>
<span class="nc" id="L2010">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(Arrays.asList(&quot;taskMore&quot;, &quot;taskLess&quot;), &quot;userTask1Id&quot;));</span>

<span class="nc" id="L2012">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L2013">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L2014">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2016">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L2018">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2019">        assertThat(executions)</span>
<span class="nc" id="L2020">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2021">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L2022">        assertThat(executions)</span>
<span class="nc" id="L2023">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2024">                .containsOnly(procDefOneTask.getId());</span>

<span class="nc" id="L2026">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2027">        assertThat(tasks)</span>
<span class="nc" id="L2028">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2029">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L2030">        assertThat(tasks)</span>
<span class="nc" id="L2031">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2032">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2033">        assertThat(tasks)</span>
<span class="nc" id="L2034">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L2035">                .containsExactly(tuple(&quot;userTask1Id&quot;, procDefOneTask.getId()));</span>

<span class="nc bnc" id="L2037" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2039">            checkActivityInstances(procDefOneTask, processInstance, &quot;userTask&quot;, &quot;taskBefore&quot;, &quot;taskMore&quot;, &quot;taskLess&quot;, &quot;userTask1Id&quot;);</span>
<span class="nc" id="L2040">            checkActivityInstances(procDefOneTask, processInstance, &quot;inclusiveGateway&quot;, &quot;gwFork&quot;);</span>

<span class="nc" id="L2042">            checkTaskInstance(procDefOneTask, processInstance, &quot;taskBefore&quot;, &quot;taskMore&quot;, &quot;taskLess&quot;, &quot;userTask1Id&quot;);</span>
        }

<span class="nc" id="L2045">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2047" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2049">            checkActivityInstances(procDefOneTask, processInstance, &quot;userTask&quot;, &quot;taskBefore&quot;, &quot;taskMore&quot;, &quot;taskLess&quot;, &quot;userTask1Id&quot;);</span>
<span class="nc" id="L2050">            checkActivityInstances(procDefOneTask, processInstance, &quot;inclusiveGateway&quot;, &quot;gwFork&quot;);</span>

<span class="nc" id="L2052">            checkTaskInstance(procDefOneTask, processInstance, &quot;taskBefore&quot;, &quot;taskMore&quot;, &quot;taskLess&quot;, &quot;userTask1Id&quot;);</span>
        }

<span class="nc" id="L2055">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2056">    }</span>

    @Test
    public void testMigrateActivityToInclusiveGatewaySplitWithDefaultInsideEmbeddedSubProcess() {
<span class="nc" id="L2060">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L2062">        ProcessDefinition procInclusiveGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/inclusive-gateway-fork-and-join-with-default-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L2066">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L2069">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2070">        assertThat(executions)</span>
<span class="nc" id="L2071">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2072">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L2073">        assertThat(executions)</span>
<span class="nc" id="L2074">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2075">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2076">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2077">        assertThat(task)</span>
<span class="nc" id="L2078">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L2079">                .containsExactly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

<span class="nc" id="L2081">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2082">                .migrateToProcessDefinition(procInclusiveGtw.getId())</span>
<span class="nc" id="L2083">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, Arrays.asList(&quot;gwFork&quot;)));</span>

<span class="nc" id="L2085">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L2086">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L2087">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2089">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L2091">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2092">        assertThat(executions)</span>
<span class="nc" id="L2093">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2094">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;taskEquals&quot;);</span>
<span class="nc" id="L2095">        assertThat(executions)</span>
<span class="nc" id="L2096">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2097">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L2099">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2100">        assertThat(tasks)</span>
<span class="nc" id="L2101">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L2102">                .containsExactly(tuple(&quot;taskEquals&quot;, procInclusiveGtw.getId()));</span>

        //Complete gateway tasks
<span class="nc" id="L2105">        tasks.forEach(this::completeTask);</span>

<span class="nc" id="L2107">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2108">        assertThat(executions)</span>
<span class="nc" id="L2109">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2110">                .containsExactly(&quot;taskAfter&quot;);</span>
<span class="nc" id="L2111">        assertThat(executions)</span>
<span class="nc" id="L2112">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2113">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L2115">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2116">        assertThat(tasks)</span>
<span class="nc" id="L2117">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L2118">                .containsExactly(tuple(&quot;taskAfter&quot;, procInclusiveGtw.getId()));</span>

<span class="nc bnc" id="L2120" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2122">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;taskEquals&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L2123">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;subProcess&quot;, &quot;subProcess&quot;);</span>
<span class="nc" id="L2124">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;inclusiveGateway&quot;, &quot;gwJoin&quot;, &quot;gwFork&quot;);</span>

<span class="nc" id="L2126">            checkTaskInstance(procInclusiveGtw, processInstance, &quot;userTask1Id&quot;, &quot;taskEquals&quot;, &quot;taskAfter&quot;);</span>
        }

<span class="nc" id="L2129">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2131" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2133">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;taskEquals&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L2134">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;subProcess&quot;, &quot;subProcess&quot;);</span>
<span class="nc" id="L2135">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;inclusiveGateway&quot;, &quot;gwJoin&quot;, &quot;gwFork&quot;);</span>

<span class="nc" id="L2137">            checkTaskInstance(procInclusiveGtw, processInstance, &quot;userTask1Id&quot;, &quot;taskEquals&quot;, &quot;taskAfter&quot;);</span>
        }

<span class="nc" id="L2140">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2141">    }</span>

    @Test
    public void testMigrateActivityToOneActivityInsideInclusiveGatewayInsideEmbeddedSubProcess() {
<span class="nc" id="L2145">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L2147">        ProcessDefinition procInclusiveGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/inclusive-gateway-fork-and-join-with-default-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L2151">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L2154">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2155">        assertThat(executions)</span>
<span class="nc" id="L2156">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2157">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L2158">        assertThat(executions)</span>
<span class="nc" id="L2159">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2160">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2161">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2162">        assertThat(task)</span>
<span class="nc" id="L2163">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L2164">                .containsExactly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

<span class="nc" id="L2166">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2167">                .migrateToProcessDefinition(procInclusiveGtw.getId())</span>
<span class="nc" id="L2168">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, Arrays.asList(&quot;taskLess&quot;)));</span>

<span class="nc" id="L2170">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L2171">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L2172">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2174">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L2176">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2177">        assertThat(executions)</span>
<span class="nc" id="L2178">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2179">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;taskLess&quot;);</span>
<span class="nc" id="L2180">        assertThat(executions)</span>
<span class="nc" id="L2181">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2182">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L2184">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2185">        assertThat(tasks)</span>
<span class="nc" id="L2186">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L2187">                .containsExactly(tuple(&quot;taskLess&quot;, procInclusiveGtw.getId()));</span>

        //Complete the task
<span class="nc" id="L2190">        completeTask(tasks.get(0));</span>

<span class="nc" id="L2192">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2193">        assertThat(executions)</span>
<span class="nc" id="L2194">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2195">                .containsExactly(&quot;taskAfter&quot;);</span>
<span class="nc" id="L2196">        assertThat(executions)</span>
<span class="nc" id="L2197">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2198">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L2200">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2201">        assertThat(tasks)</span>
<span class="nc" id="L2202">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L2203">                .containsExactly(tuple(&quot;taskAfter&quot;, procInclusiveGtw.getId()));</span>

<span class="nc bnc" id="L2205" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2207">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;userTask&quot;, &quot;taskLess&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L2208">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;subProcess&quot;, &quot;subProcess&quot;);</span>
<span class="nc" id="L2209">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;inclusiveGateway&quot;, &quot;gwJoin&quot;);</span>

<span class="nc" id="L2211">            checkTaskInstance(procInclusiveGtw, processInstance, &quot;taskAfter&quot;, &quot;taskLess&quot;);</span>

<span class="nc" id="L2213">            List&lt;HistoricActivityInstance&gt; gtwExecution = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L2214">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2215">                    .activityType(&quot;inclusiveGateway&quot;)</span>
<span class="nc" id="L2216">                    .list();</span>
            //Join gateway only
<span class="nc" id="L2218">            assertThat(gtwExecution)</span>
<span class="nc" id="L2219">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L2220">                    .containsExactly(&quot;gwJoin&quot;);</span>
<span class="nc" id="L2221">            assertThat(gtwExecution)</span>
<span class="nc" id="L2222">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L2223">                    .containsOnly(procInclusiveGtw.getId());</span>
        }

<span class="nc" id="L2226">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2228" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2230">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;userTask&quot;, &quot;taskLess&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L2231">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;subProcess&quot;, &quot;subProcess&quot;);</span>
<span class="nc" id="L2232">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;inclusiveGateway&quot;, &quot;gwJoin&quot;);</span>

<span class="nc" id="L2234">            checkTaskInstance(procInclusiveGtw, processInstance, &quot;taskAfter&quot;, &quot;taskLess&quot;);</span>
        }

<span class="nc" id="L2237">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2238">    }</span>

    @Test
    public void testMigrateActivityToParallelActivitiesInsideInclusiveGatewayInsideEmbeddedSubProcess() {
<span class="nc" id="L2242">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L2244">        ProcessDefinition procInclusiveGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/inclusive-gateway-fork-and-join-with-default-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L2248">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L2251">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2252">        assertThat(executions)</span>
<span class="nc" id="L2253">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2254">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L2255">        assertThat(executions)</span>
<span class="nc" id="L2256">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2257">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2258">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2259">        assertThat(task)</span>
<span class="nc" id="L2260">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L2261">                .containsExactly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>

<span class="nc" id="L2263">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2264">                .migrateToProcessDefinition(procInclusiveGtw.getId())</span>
<span class="nc" id="L2265">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, Arrays.asList(&quot;taskMore&quot;, &quot;taskLess&quot;)));</span>

<span class="nc" id="L2267">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L2268">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L2269">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2271">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L2273">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2274">        assertThat(executions)</span>
<span class="nc" id="L2275">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2276">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;taskMore&quot;, &quot;taskLess&quot;);</span>
<span class="nc" id="L2277">        assertThat(executions)</span>
<span class="nc" id="L2278">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2279">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L2281">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2282">        assertThat(tasks)</span>
<span class="nc" id="L2283">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2284">                .containsExactlyInAnyOrder(&quot;taskMore&quot;, &quot;taskLess&quot;);</span>
<span class="nc" id="L2285">        assertThat(tasks)</span>
<span class="nc" id="L2286">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2287">                .containsOnly(procInclusiveGtw.getId());</span>

        //Complete one sequence
<span class="nc" id="L2290">        task = tasks.stream().filter(t -&gt; &quot;taskMore&quot;.equals(t.getTaskDefinitionKey())).findFirst().get();</span>
<span class="nc" id="L2291">        completeTask(task);</span>

<span class="nc" id="L2293">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2294">        assertThat(executions)</span>
<span class="nc" id="L2295">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2296">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;gwJoin&quot;, &quot;taskLess&quot;);</span>
<span class="nc" id="L2297">        assertThat(executions)</span>
<span class="nc" id="L2298">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2299">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L2301">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2302">        assertThat(tasks)</span>
<span class="nc" id="L2303">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L2304">                .containsExactly(tuple(&quot;taskLess&quot;, procInclusiveGtw.getId()));</span>

        //Complete the rest
<span class="nc" id="L2307">        tasks.forEach(this::completeTask);</span>

<span class="nc" id="L2309">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2310">        assertThat(executions)</span>
<span class="nc" id="L2311">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2312">                .containsExactly(&quot;taskAfter&quot;);</span>
<span class="nc" id="L2313">        assertThat(executions)</span>
<span class="nc" id="L2314">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2315">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L2317">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2318">        assertThat(tasks)</span>
<span class="nc" id="L2319">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L2320">                .containsExactly(tuple(&quot;taskAfter&quot;, procInclusiveGtw.getId()));</span>

<span class="nc bnc" id="L2322" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2324">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;taskLess&quot;, &quot;taskMore&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L2325">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;subProcess&quot;, &quot;subProcess&quot;);</span>
<span class="nc" id="L2326">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;inclusiveGateway&quot;, &quot;gwJoin&quot;, &quot;gwJoin&quot;);</span>

<span class="nc" id="L2328">            checkTaskInstance(procInclusiveGtw, processInstance, &quot;userTask1Id&quot;, &quot;taskLess&quot;, &quot;taskMore&quot;, &quot;taskAfter&quot;);</span>
        }

<span class="nc" id="L2331">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2333" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2335">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;userTask&quot;, &quot;userTask1Id&quot;, &quot;taskLess&quot;, &quot;taskMore&quot;, &quot;taskAfter&quot;);</span>
<span class="nc" id="L2336">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;subProcess&quot;, &quot;subProcess&quot;);</span>
<span class="nc" id="L2337">            checkActivityInstances(procInclusiveGtw, processInstance, &quot;inclusiveGateway&quot;, &quot;gwJoin&quot;, &quot;gwJoin&quot;);</span>

<span class="nc" id="L2339">            checkTaskInstance(procInclusiveGtw, processInstance, &quot;userTask1Id&quot;, &quot;taskLess&quot;, &quot;taskMore&quot;, &quot;taskAfter&quot;);</span>
        }

<span class="nc" id="L2342">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2343">    }</span>

    @Test
    public void testMigrateInclusiveGatewayParallelActivitiesInsideEmbeddedSubProcessToSingleActivity() {
<span class="nc" id="L2347">        ProcessDefinition procInclusiveGtw = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/inclusive-gateway-fork-multiple-outgoing-sequences-nested-in-embedded-subprocess.bpmn20.xml&quot;);
<span class="nc" id="L2349">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L2353">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procInclusiveGtw.getId(), Collections.singletonMap(&quot;myConditionVar&quot;, 10));</span>
<span class="nc" id="L2354">        completeTask(taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult());</span>

        //Confirm the state to migrate
<span class="nc" id="L2357">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2358">        assertThat(executions)</span>
<span class="nc" id="L2359">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2360">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;taskMore&quot;, &quot;taskLess&quot;);</span>
<span class="nc" id="L2361">        assertThat(executions)</span>
<span class="nc" id="L2362">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2363">                .containsOnly(procInclusiveGtw.getId());</span>
<span class="nc" id="L2364">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2365">        assertThat(tasks)</span>
<span class="nc" id="L2366">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2367">                .containsExactlyInAnyOrder(&quot;taskMore&quot;, &quot;taskLess&quot;);</span>
<span class="nc" id="L2368">        assertThat(tasks)</span>
<span class="nc" id="L2369">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2370">                .containsOnly(procInclusiveGtw.getId());</span>

<span class="nc" id="L2372">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2373">                .migrateToProcessDefinition(procDefOneTask.getId())</span>
<span class="nc" id="L2374">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(Arrays.asList(&quot;taskMore&quot;, &quot;taskLess&quot;), &quot;userTask1Id&quot;));</span>

<span class="nc" id="L2376">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L2377">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L2378">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2380">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

<span class="nc" id="L2382">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2383">        assertThat(executions)</span>
<span class="nc" id="L2384">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2385">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L2386">        assertThat(executions)</span>
<span class="nc" id="L2387">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2388">                .containsOnly(procDefOneTask.getId());</span>

<span class="nc" id="L2390">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2391">        assertThat(tasks)</span>
<span class="nc" id="L2392">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L2393">                .containsExactly(tuple(&quot;userTask1Id&quot;, procDefOneTask.getId()));</span>

<span class="nc bnc" id="L2395" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2397">            checkActivityInstances(procDefOneTask, processInstance, &quot;userTask&quot;, &quot;taskBefore&quot;, &quot;taskMore&quot;, &quot;taskLess&quot;, &quot;userTask1Id&quot;);</span>
<span class="nc" id="L2398">            checkActivityInstances(procDefOneTask, processInstance, &quot;subProcess&quot;, &quot;subProcess&quot;);</span>
<span class="nc" id="L2399">            checkActivityInstances(procDefOneTask, processInstance, &quot;inclusiveGateway&quot;, &quot;gwFork&quot;);</span>

<span class="nc" id="L2401">            checkTaskInstance(procDefOneTask, processInstance, &quot;taskBefore&quot;, &quot;taskMore&quot;, &quot;taskLess&quot;, &quot;userTask1Id&quot;);</span>
        }

<span class="nc" id="L2404">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2406" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2408">            checkActivityInstances(procDefOneTask, processInstance, &quot;userTask&quot;, &quot;taskBefore&quot;, &quot;taskMore&quot;, &quot;taskLess&quot;, &quot;userTask1Id&quot;);</span>
<span class="nc" id="L2409">            checkActivityInstances(procDefOneTask, processInstance, &quot;subProcess&quot;, &quot;subProcess&quot;);</span>
<span class="nc" id="L2410">            checkActivityInstances(procDefOneTask, processInstance, &quot;inclusiveGateway&quot;, &quot;gwFork&quot;);</span>

<span class="nc" id="L2412">            checkTaskInstance(procDefOneTask, processInstance, &quot;taskBefore&quot;, &quot;taskMore&quot;, &quot;taskLess&quot;, &quot;userTask1Id&quot;);</span>
        }
<span class="nc" id="L2414">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>