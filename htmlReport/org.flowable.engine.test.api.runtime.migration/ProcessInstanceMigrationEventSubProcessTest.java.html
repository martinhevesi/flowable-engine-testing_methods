<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProcessInstanceMigrationEventSubProcessTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.runtime.migration</a> &gt; <span class="el_source">ProcessInstanceMigrationEventSubProcessTest.java</span></div><h1>ProcessInstanceMigrationEventSubProcessTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.engine.test.api.runtime.migration;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.tuple;

import java.util.Arrays;
import java.util.List;

import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.engine.history.HistoricActivityInstance;
import org.flowable.engine.impl.test.HistoryTestHelper;
import org.flowable.engine.migration.ActivityMigrationMapping;
import org.flowable.engine.migration.ProcessInstanceMigrationBuilder;
import org.flowable.engine.migration.ProcessInstanceMigrationValidationResult;
import org.flowable.engine.repository.ProcessDefinition;
import org.flowable.engine.runtime.ActivityInstance;
import org.flowable.engine.runtime.Execution;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.api.runtime.changestate.ChangeStateEventListener;
import org.flowable.eventsubscription.api.EventSubscription;
import org.flowable.job.api.Job;
import org.flowable.task.api.Task;
import org.flowable.task.api.history.HistoricTaskInstance;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Disabled;
import org.junit.jupiter.api.Test;

/**
 * @author Dennis Federico
 */
<span class="nc" id="L45">public class ProcessInstanceMigrationEventSubProcessTest extends AbstractProcessInstanceMigrationTest {</span>

<span class="nc" id="L47">    private ChangeStateEventListener changeStateEventListener = new ChangeStateEventListener();</span>

    @BeforeEach
    protected void setUp() {
<span class="nc" id="L51">        processEngine.getRuntimeService().addEventListener(changeStateEventListener);</span>
<span class="nc" id="L52">    }</span>

    @AfterEach
    protected void tearDown() {
<span class="nc" id="L56">        processEngine.getRuntimeService().removeEventListener(changeStateEventListener);</span>
<span class="nc" id="L57">        deleteDeployments();</span>
<span class="nc" id="L58">    }</span>

    @Test
    public void testMigrateSimpleActivityToActivityInsideSignalEventSubProcessInNewDefinition() {
<span class="nc" id="L62">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L64">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-signal-event-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L68">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L71">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L72">        assertThat(executions)</span>
<span class="nc" id="L73">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L74">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L75">        assertThat(executions)</span>
<span class="nc" id="L76">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L77">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L78">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L79">        assertThat(task)</span>
<span class="nc" id="L80">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L81">                .containsExactly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>
<span class="nc" id="L82">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L83">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L85">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L88">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L89">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L90">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;eventSubProcessTask&quot;));</span>

<span class="nc" id="L92">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L93">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L94">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L96">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L99">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L100">        assertThat(executions)</span>
<span class="nc" id="L101">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L102">                .containsExactlyInAnyOrder(&quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L103">        assertThat(executions)</span>
<span class="nc" id="L104">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L105">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L106">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L107">        assertThat(task)</span>
<span class="nc" id="L108">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L109">                .containsExactly(&quot;eventSubProcessTask&quot;, procWithSignal.getId());</span>
<span class="nc" id="L110">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L111">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L113">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L117">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L118">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;);</span>

<span class="nc" id="L120">            checkTaskInstance(procWithSignal, processInstance, &quot;eventSubProcessTask&quot;);</span>
        }

<span class="nc" id="L123">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L124">    }</span>
    
    @Test
    public void testMigrateSimpleActivityToActivityInsideMessageEventSubProcessInNewDefinition() {
<span class="nc" id="L128">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L130">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-message-event-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L134">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L137">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L138">        assertThat(executions)</span>
<span class="nc" id="L139">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L140">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L141">        assertThat(executions)</span>
<span class="nc" id="L142">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L143">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L144">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L145">        assertThat(task)</span>
<span class="nc" id="L146">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L147">                .containsExactly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>
<span class="nc" id="L148">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L149">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L151">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L154">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L155">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L156">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;eventSubProcessTask&quot;));</span>

<span class="nc" id="L158">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L159">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L160">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L162">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L165">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L166">        assertThat(executions)</span>
<span class="nc" id="L167">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L168">                .containsExactlyInAnyOrder(&quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L169">        assertThat(executions)</span>
<span class="nc" id="L170">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L171">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L172">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L173">        assertThat(task)</span>
<span class="nc" id="L174">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L175">                .isEqualTo(&quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L176">        assertThat(task)</span>
<span class="nc" id="L177">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L178">                .isEqualTo(procWithSignal.getId());</span>
<span class="nc" id="L179">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L180">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L184">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L185">            List&lt;ActivityInstance&gt; taskExecutions = runtimeService.createActivityInstanceQuery()</span>
<span class="nc" id="L186">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L187">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L188">                    .list();</span>
<span class="nc" id="L189">            assertThat(taskExecutions)</span>
<span class="nc" id="L190">                    .extracting(ActivityInstance::getActivityId, ActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L191">                    .containsExactly(tuple(&quot;eventSubProcessTask&quot;, procWithSignal.getId()));</span>

<span class="nc" id="L193">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;);</span>
<span class="nc" id="L194">            List&lt;ActivityInstance&gt; eventSubProcExecution = runtimeService.createActivityInstanceQuery()</span>
<span class="nc" id="L195">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L196">                    .activityType(&quot;eventSubProcess&quot;)</span>
<span class="nc" id="L197">                    .list();</span>
<span class="nc" id="L198">            assertThat(eventSubProcExecution)</span>
<span class="nc" id="L199">                    .extracting(ActivityInstance::getActivityId, ActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L200">                    .containsExactly(tuple(&quot;eventSubProcess&quot;, procWithSignal.getId()));</span>

<span class="nc" id="L202">            checkTaskInstance(procWithSignal, processInstance, &quot;eventSubProcessTask&quot;);</span>
        }

<span class="nc" id="L205">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L206">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L207">    }</span>

    @Test
    public void testMigrateSimpleActivityToActivityInsideTimerEventSubProcessInNewDefinition() {
<span class="nc" id="L211">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L213">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-timer-event-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L217">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L220">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L221">        assertThat(executions)</span>
<span class="nc" id="L222">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L223">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L224">        assertThat(executions)</span>
<span class="nc" id="L225">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L226">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L227">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L228">        assertThat(task)</span>
<span class="nc" id="L229">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L230">                .containsExactly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>
<span class="nc" id="L231">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L232">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L234">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L237">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L238">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L239">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;eventSubProcessTask&quot;));</span>

<span class="nc" id="L241">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L242">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L243">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L245">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L248">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L249">        assertThat(executions)</span>
<span class="nc" id="L250">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L251">                .containsExactlyInAnyOrder(&quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L252">        assertThat(executions)</span>
<span class="nc" id="L253">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L254">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L255">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L256">        assertThat(task)</span>
<span class="nc" id="L257">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L258">                .containsExactly(&quot;eventSubProcessTask&quot;, procWithSignal.getId());</span>
<span class="nc" id="L259">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L260">        assertThat(job).isNull();</span>

<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L264">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L265">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;);</span>

<span class="nc" id="L267">            checkTaskInstance(procWithSignal, processInstance, &quot;eventSubProcessTask&quot;);</span>
        }

<span class="nc" id="L270">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L271">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L272">    }</span>

    @Test
    public void testMigrateSimpleActivityToActivityInsideNonInterruptingSignalEventSubProcessInNewDefinition() {
<span class="nc" id="L276">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L278">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/non-interrupting-signal-event-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L282">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L285">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L286">        assertThat(executions)</span>
<span class="nc" id="L287">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L288">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L289">        assertThat(executions)</span>
<span class="nc" id="L290">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L291">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L292">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L293">        assertThat(task)</span>
<span class="nc" id="L294">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L295">                .containsExactly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>
<span class="nc" id="L296">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L297">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L299">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L302">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L303">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L304">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;eventSubProcessTask&quot;));</span>

<span class="nc" id="L306">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L307">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L308">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L310">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L313">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L314">        assertThat(executions)</span>
<span class="nc" id="L315">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L316">                .containsExactlyInAnyOrder(&quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L317">        assertThat(executions)</span>
<span class="nc" id="L318">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L319">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L320">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L321">        assertThat(task)</span>
<span class="nc" id="L322">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L323">                .containsExactly(&quot;eventSubProcessTask&quot;, procWithSignal.getId());</span>

        //Since the only task in the parent scope was moved, it behaves as a interrupting eventSubProcess
<span class="nc" id="L326">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L327">        assertThat(eventSubscriptions).isEmpty();</span>
<span class="nc" id="L328">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L330" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L332">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L333">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;);</span>

<span class="nc" id="L335">            checkTaskInstance(procWithSignal, processInstance, &quot;eventSubProcessTask&quot;);</span>
        }

<span class="nc" id="L338">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L339">    }</span>

    @Test
    public void testMigrateSimpleActivityToActivityInsideNonInterruptingMessageEventSubProcessInNewDefinition() {
<span class="nc" id="L343">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L345">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/non-interrupting-message-event-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L349">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L352">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L353">        assertThat(executions)</span>
<span class="nc" id="L354">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L355">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L356">        assertThat(executions)</span>
<span class="nc" id="L357">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L358">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L359">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L360">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L361">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefOneTask.getId());</span>
<span class="nc" id="L362">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L363">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L365">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L368">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L369">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L370">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;eventSubProcessTask&quot;));</span>

<span class="nc" id="L372">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L373">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L374">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L376">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L379">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L380">        assertThat(executions)</span>
<span class="nc" id="L381">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L382">                .containsExactlyInAnyOrder(&quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L383">        assertThat(executions)</span>
<span class="nc" id="L384">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L385">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L386">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L387">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L388">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignal.getId());</span>

        //Since the only task in the parent scope was moved, it behaves as a interrupting eventSubProcess
<span class="nc" id="L391">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L392">        assertThat(eventSubscriptions).isEmpty();</span>
<span class="nc" id="L393">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L395" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L397">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L398">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;);</span>

<span class="nc" id="L400">            checkTaskInstance(procWithSignal, processInstance, &quot;eventSubProcessTask&quot;);</span>
        }

<span class="nc" id="L403">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L404">    }</span>

    @Test
    public void testMigrateSimpleActivityToActivityInsideNonInterruptingTimerEventSubProcessInNewDefinition() {
<span class="nc" id="L408">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L410">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/non-interrupting-timer-event-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L414">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L417">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L418">        assertThat(executions)</span>
<span class="nc" id="L419">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L420">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L421">        assertThat(executions)</span>
<span class="nc" id="L422">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L423">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L424">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L425">        assertThat(task)</span>
<span class="nc" id="L426">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L427">                .containsExactly(&quot;userTask1Id&quot;, procDefOneTask.getId());</span>
<span class="nc" id="L428">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L429">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L431">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L434">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L435">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L436">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;eventSubProcessTask&quot;));</span>

<span class="nc" id="L438">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L439">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L440">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L442">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L445">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L446">        assertThat(executions)</span>
<span class="nc" id="L447">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L448">                .containsExactlyInAnyOrder(&quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L449">        assertThat(executions)</span>
<span class="nc" id="L450">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L451">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L452">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L453">        assertThat(task)</span>
<span class="nc" id="L454">                .extracting(Task::getTaskDefinitionKey, Task::getProcessDefinitionId)</span>
<span class="nc" id="L455">                .containsExactly(&quot;eventSubProcessTask&quot;, procWithSignal.getId());</span>

        //Since the only task in the parent scope was moved, it behaves as a interrupting eventSubProcess
<span class="nc" id="L458">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L459">        assertThat(job).isNull();</span>

<span class="nc" id="L461">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L463" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L465">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L466">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;);</span>

<span class="nc" id="L468">            checkTaskInstance(procWithSignal, processInstance, &quot;eventSubProcessTask&quot;);</span>
        }

<span class="nc" id="L471">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L472">    }</span>

    @Test
    public void testMigrateParallelActivityToActivityInsideSignalEventSubProcessInNewDefinition() {
<span class="nc" id="L476">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L478">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-signal-event-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L482">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Spawn the parallel task
<span class="nc" id="L485">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L486">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L487">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L490">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L491">        assertThat(executions)</span>
<span class="nc" id="L492">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L493">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L494">        assertThat(executions)</span>
<span class="nc" id="L495">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L496">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L497">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L498">        assertThat(tasks)</span>
<span class="nc" id="L499">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L500">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L501">        assertThat(tasks)</span>
<span class="nc" id="L502">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L503">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L504">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L505">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L507">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L510">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L511">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L512">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;eventSubProcessTask&quot;));</span>

<span class="nc" id="L514">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L515">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L516">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L518">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L521">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L522">        assertThat(executions)</span>
<span class="nc" id="L523">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L524">                .containsExactlyInAnyOrder(&quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L525">        assertThat(executions)</span>
<span class="nc" id="L526">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L527">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L528">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L529">        assertThat(tasks)</span>
<span class="nc" id="L530">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L531">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L532">        assertThat(tasks)</span>
<span class="nc" id="L533">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L534">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L535">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L536">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L538">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L540" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L542">            List&lt;HistoricActivityInstance&gt; taskExecutions = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L543">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L544">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L545">                    .list();</span>
<span class="nc" id="L546">            assertThat(taskExecutions)</span>
<span class="nc" id="L547">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L548">                    .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L549">            assertThat(taskExecutions)</span>
<span class="nc" id="L550">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L551">                    .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L553">            List&lt;HistoricActivityInstance&gt; eventSubProcExecution = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L554">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L555">                    .activityType(&quot;eventSubProcess&quot;)</span>
<span class="nc" id="L556">                    .list();</span>
<span class="nc" id="L557">            assertThat(eventSubProcExecution)</span>
<span class="nc" id="L558">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L559">                    .containsExactly(&quot;eventSubProcess&quot;);</span>
<span class="nc" id="L560">            assertThat(eventSubProcExecution)</span>
<span class="nc" id="L561">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L562">                    .containsOnly(procWithSignal.getId());</span>

<span class="nc bnc" id="L564" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L565">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L566">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L567">                        .list();</span>
<span class="nc" id="L568">                assertThat(historicTasks)</span>
<span class="nc" id="L569">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L570">                        .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L571">                assertThat(historicTasks)</span>
<span class="nc" id="L572">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L573">                        .containsOnly(procWithSignal.getId());</span>
            }
        }

<span class="nc" id="L577">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L578">    }</span>

    @Test
    public void testMigrateParallelActivityToActivityInsideMessageEventSubProcessInNewDefinition() {
<span class="nc" id="L582">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L584">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-message-event-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L588">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Spawn the parallel task
<span class="nc" id="L591">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L592">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L593">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L596">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L597">        assertThat(executions)</span>
<span class="nc" id="L598">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L599">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L600">        assertThat(executions)</span>
<span class="nc" id="L601">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L602">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L603">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L604">        assertThat(tasks)</span>
<span class="nc" id="L605">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L606">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L607">        assertThat(tasks)</span>
<span class="nc" id="L608">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L609">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L610">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L611">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L613">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L616">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L617">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L618">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;eventSubProcessTask&quot;));</span>

<span class="nc" id="L620">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L621">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L622">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L624">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L627">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L628">        assertThat(executions)</span>
<span class="nc" id="L629">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L630">                .containsExactlyInAnyOrder(&quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L631">        assertThat(executions)</span>
<span class="nc" id="L632">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L633">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L634">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L635">        assertThat(tasks)</span>
<span class="nc" id="L636">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L637">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L638">        assertThat(tasks)</span>
<span class="nc" id="L639">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L640">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L641">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L642">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L644">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L646" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L648">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;, &quot;processTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L649">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;);</span>

<span class="nc" id="L651">            checkTaskInstance(procWithSignal, processInstance, &quot;eventSubProcessTask&quot;, &quot;processTask&quot;);</span>
        }

<span class="nc" id="L654">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L655">    }</span>

    @Test
    public void testMigrateParallelActivityToActivityInsideTimerEventSubProcessInNewDefinition() {
<span class="nc" id="L659">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L661">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-timer-event-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L665">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Spawn the parallel task
<span class="nc" id="L668">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L669">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L670">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L673">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L674">        assertThat(executions)</span>
<span class="nc" id="L675">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L676">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L677">        assertThat(executions)</span>
<span class="nc" id="L678">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L679">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L680">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L681">        assertThat(tasks)</span>
<span class="nc" id="L682">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L683">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L684">        assertThat(tasks)</span>
<span class="nc" id="L685">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L686">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L687">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L688">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L690">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L693">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L694">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L695">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;eventSubProcessTask&quot;));</span>

<span class="nc" id="L697">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L698">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L699">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L701">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L704">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L705">        assertThat(executions)</span>
<span class="nc" id="L706">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L707">                .containsExactlyInAnyOrder(&quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L708">        assertThat(executions)</span>
<span class="nc" id="L709">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L710">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L711">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L712">        assertThat(tasks)</span>
<span class="nc" id="L713">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L714">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L715">        assertThat(tasks)</span>
<span class="nc" id="L716">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L717">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L718">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L719">        assertThat(job).isNull();</span>

<span class="nc" id="L721">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L723" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L725">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;, &quot;processTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L726">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;);</span>

<span class="nc" id="L728">            checkTaskInstance(procWithSignal, processInstance, &quot;eventSubProcessTask&quot;, &quot;processTask&quot;);</span>
        }

<span class="nc" id="L731">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L732">    }</span>

    @Test
    public void testMigrateParallelActivityToActivityInsideNonInterruptingSignalEventSubProcessInNewDefinition() {
<span class="nc" id="L736">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L738">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/non-interrupting-signal-event-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L742">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Spawn the parallel task
<span class="nc" id="L745">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L746">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L747">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L750">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L751">        assertThat(executions)</span>
<span class="nc" id="L752">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L753">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L754">        assertThat(executions)</span>
<span class="nc" id="L755">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L756">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L757">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L758">        assertThat(tasks)</span>
<span class="nc" id="L759">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L760">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L761">        assertThat(tasks)</span>
<span class="nc" id="L762">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L763">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L764">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L765">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L767">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L770">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L771">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L772">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;eventSubProcessTask&quot;));</span>

<span class="nc" id="L774">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L775">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L776">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L778">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L781">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L782">        assertThat(executions)</span>
<span class="nc" id="L783">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L784">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;, &quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L785">        assertThat(executions)</span>
<span class="nc" id="L786">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L787">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L788">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L789">        assertThat(tasks)</span>
<span class="nc" id="L790">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L791">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L792">        assertThat(tasks)</span>
<span class="nc" id="L793">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L794">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L795">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L796">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L797">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L798">                .containsExactly(tuple(&quot;eventSubProcessStart&quot;, &quot;signal&quot;, &quot;eventSignal&quot;));</span>

        //Fire the signal
<span class="nc" id="L801">        runtimeService.signalEventReceived(&quot;eventSignal&quot;);</span>

<span class="nc" id="L803">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L804">        assertThat(executions)</span>
<span class="nc" id="L805">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L806">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessStart&quot;, &quot;eventSubProcessTask&quot;,</span>
                        &quot;eventSubProcessTask&quot;);
<span class="nc" id="L808">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L809">        assertThat(tasks)</span>
<span class="nc" id="L810">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L811">                .containsExactlyInAnyOrder(&quot;eventSubProcessTask&quot;, &quot;eventSubProcessTask&quot;, &quot;processTask&quot;);</span>
<span class="nc" id="L812">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().list();</span>
<span class="nc" id="L813">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L814">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L815">                .containsExactly(tuple(&quot;eventSubProcessStart&quot;, &quot;signal&quot;, &quot;eventSignal&quot;));</span>

<span class="nc" id="L817">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L819" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L821">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;, &quot;processTask&quot;, &quot;eventSubProcessTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L822">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;);</span>

<span class="nc" id="L824">            checkTaskInstance(procWithSignal, processInstance, &quot;processTask&quot;, &quot;eventSubProcessTask&quot;, &quot;eventSubProcessTask&quot;);</span>
        }

<span class="nc" id="L827">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L828">    }</span>

    @Test
    public void testMigrateParallelActivityToActivityInsideNonInterruptingMessageEventSubProcessInNewDefinition() {
<span class="nc" id="L832">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L834">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/non-interrupting-message-event-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L838">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Spawn the parallel task
<span class="nc" id="L841">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L842">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L843">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L846">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L847">        assertThat(executions)</span>
<span class="nc" id="L848">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L849">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L850">        assertThat(executions)</span>
<span class="nc" id="L851">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L852">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L853">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L854">        assertThat(tasks)</span>
<span class="nc" id="L855">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L856">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L857">        assertThat(tasks)</span>
<span class="nc" id="L858">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L859">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L860">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L861">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L863">        changeStateEventListener.clear();</span>

<span class="nc" id="L865">        assertThat(runtimeService.createActivityInstanceQuery().list())</span>
<span class="nc" id="L866">                .extracting(ActivityInstance::getActivityType, ActivityInstance::getActivityId)</span>
<span class="nc" id="L867">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L868">                        tuple(&quot;startEvent&quot;, &quot;processStart&quot;),</span>
<span class="nc" id="L869">                        tuple(&quot;sequenceFlow&quot;, &quot;flow1&quot;),</span>
<span class="nc" id="L870">                        tuple(&quot;userTask&quot;, &quot;processTask&quot;),</span>
<span class="nc" id="L871">                        tuple(&quot;boundaryEvent&quot;, &quot;timerBound&quot;),</span>
<span class="nc" id="L872">                        tuple(&quot;boundaryEvent&quot;, &quot;timerBound&quot;),</span>
<span class="nc" id="L873">                        tuple(&quot;sequenceFlow&quot;, &quot;flow3&quot;),</span>
<span class="nc" id="L874">                        tuple(&quot;userTask&quot;, &quot;parallelTask&quot;)</span>
                );

        //Migrate to the other processDefinition
<span class="nc" id="L878">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L879">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L880">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;eventSubProcessTask&quot;));</span>

<span class="nc" id="L882">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L883">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L884">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L886">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L889">        assertThat(runtimeService.createActivityInstanceQuery().list())</span>
<span class="nc" id="L890">                .extracting(ActivityInstance::getActivityType, ActivityInstance::getActivityId)</span>
<span class="nc" id="L891">                .containsExactlyInAnyOrder(</span>
                        // old activities
<span class="nc" id="L893">                        tuple(&quot;startEvent&quot;, &quot;processStart&quot;),</span>
<span class="nc" id="L894">                        tuple(&quot;sequenceFlow&quot;, &quot;flow1&quot;),</span>
<span class="nc" id="L895">                        tuple(&quot;userTask&quot;, &quot;processTask&quot;),</span>
<span class="nc" id="L896">                        tuple(&quot;boundaryEvent&quot;, &quot;timerBound&quot;),</span>
<span class="nc" id="L897">                        tuple(&quot;boundaryEvent&quot;, &quot;timerBound&quot;),</span>
<span class="nc" id="L898">                        tuple(&quot;sequenceFlow&quot;, &quot;flow3&quot;),</span>

                        // new activities
<span class="nc" id="L901">                        tuple(&quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;),</span>
<span class="nc" id="L902">                        tuple(&quot;userTask&quot;, &quot;eventSubProcessTask&quot;)</span>
                );

<span class="nc" id="L905">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L906">        assertThat(executions)</span>
<span class="nc" id="L907">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L908">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;, &quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L909">        assertThat(executions)</span>
<span class="nc" id="L910">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L911">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L912">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L913">        assertThat(tasks)</span>
<span class="nc" id="L914">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L915">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L916">        assertThat(tasks)</span>
<span class="nc" id="L917">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L918">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L919">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L920">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L921">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L922">                .containsExactly(tuple(&quot;eventSubProcessStart&quot;, &quot;message&quot;, &quot;someMessage&quot;));</span>

        //Trigger the event
<span class="nc" id="L925">        Execution messageSubscriptionExecution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L926">                .messageEventSubscriptionName(&quot;someMessage&quot;).singleResult();</span>
<span class="nc" id="L927">        runtimeService.messageEventReceived(&quot;someMessage&quot;, messageSubscriptionExecution.getId());</span>

<span class="nc" id="L929">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L930">        assertThat(executions)</span>
<span class="nc" id="L931">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L932">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessStart&quot;, &quot;eventSubProcessTask&quot;,</span>
                        &quot;eventSubProcessTask&quot;);
<span class="nc" id="L934">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L935">        assertThat(tasks)</span>
<span class="nc" id="L936">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L937">                .containsExactlyInAnyOrder(&quot;eventSubProcessTask&quot;, &quot;eventSubProcessTask&quot;, &quot;processTask&quot;);</span>
<span class="nc" id="L938">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().list();</span>
<span class="nc" id="L939">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L940">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L941">                .containsExactly(tuple(&quot;eventSubProcessStart&quot;, &quot;message&quot;, &quot;someMessage&quot;));</span>

<span class="nc" id="L943">        assertThat(runtimeService.createActivityInstanceQuery().list())</span>
<span class="nc" id="L944">                .extracting(ActivityInstance::getActivityType, ActivityInstance::getActivityId)</span>
<span class="nc" id="L945">                .containsExactlyInAnyOrder(</span>
                        // old activities
<span class="nc" id="L947">                        tuple(&quot;startEvent&quot;, &quot;processStart&quot;),</span>
<span class="nc" id="L948">                        tuple(&quot;sequenceFlow&quot;, &quot;flow1&quot;),</span>
<span class="nc" id="L949">                        tuple(&quot;userTask&quot;, &quot;processTask&quot;),</span>
<span class="nc" id="L950">                        tuple(&quot;boundaryEvent&quot;, &quot;timerBound&quot;),</span>
<span class="nc" id="L951">                        tuple(&quot;boundaryEvent&quot;, &quot;timerBound&quot;),</span>
<span class="nc" id="L952">                        tuple(&quot;sequenceFlow&quot;, &quot;flow3&quot;),</span>

                        // After migration
<span class="nc" id="L955">                        tuple(&quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;),</span>
<span class="nc" id="L956">                        tuple(&quot;userTask&quot;, &quot;eventSubProcessTask&quot;),</span>

                        // After message received
<span class="nc" id="L959">                        tuple(&quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;),</span>
<span class="nc" id="L960">                        tuple(&quot;startEvent&quot;, &quot;eventSubProcessStart&quot;),</span>
<span class="nc" id="L961">                        tuple(&quot;sequenceFlow&quot;, &quot;subProcessFlow1&quot;),</span>
<span class="nc" id="L962">                        tuple(&quot;userTask&quot;, &quot;eventSubProcessTask&quot;)</span>
                );

<span class="nc" id="L965">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L967" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L969">            assertThat(historyService.createHistoricActivityInstanceQuery().list())</span>
<span class="nc" id="L970">                    .extracting(HistoricActivityInstance::getActivityType, HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L971">                    .containsExactlyInAnyOrder(</span>
                            // old activities
<span class="nc" id="L973">                            tuple(&quot;startEvent&quot;, &quot;processStart&quot;),</span>
<span class="nc" id="L974">                            tuple(&quot;sequenceFlow&quot;, &quot;flow1&quot;),</span>
<span class="nc" id="L975">                            tuple(&quot;userTask&quot;, &quot;processTask&quot;),</span>
<span class="nc" id="L976">                            tuple(&quot;boundaryEvent&quot;, &quot;timerBound&quot;),</span>
<span class="nc" id="L977">                            tuple(&quot;boundaryEvent&quot;, &quot;timerBound&quot;),</span>
<span class="nc" id="L978">                            tuple(&quot;sequenceFlow&quot;, &quot;flow3&quot;),</span>

                            // After migration
<span class="nc" id="L981">                            tuple(&quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;),</span>
<span class="nc" id="L982">                            tuple(&quot;userTask&quot;, &quot;eventSubProcessTask&quot;),</span>

                            // After message received
<span class="nc" id="L985">                            tuple(&quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;),</span>
<span class="nc" id="L986">                            tuple(&quot;startEvent&quot;, &quot;eventSubProcessStart&quot;),</span>
<span class="nc" id="L987">                            tuple(&quot;sequenceFlow&quot;, &quot;subProcessFlow1&quot;),</span>
<span class="nc" id="L988">                            tuple(&quot;userTask&quot;, &quot;eventSubProcessTask&quot;),</span>

                            // After tasks completion
<span class="nc" id="L991">                            tuple(&quot;sequenceFlow&quot;, &quot;subProcessFlow2&quot;),</span>
<span class="nc" id="L992">                            tuple(&quot;endEvent&quot;, &quot;eventSubProcessEnd&quot;),</span>
<span class="nc" id="L993">                            tuple(&quot;sequenceFlow&quot;, &quot;subProcessFlow2&quot;),</span>
<span class="nc" id="L994">                            tuple(&quot;endEvent&quot;, &quot;eventSubProcessEnd&quot;),</span>
<span class="nc" id="L995">                            tuple(&quot;sequenceFlow&quot;, &quot;flow2&quot;),</span>
<span class="nc" id="L996">                            tuple(&quot;endEvent&quot;, &quot;theEnd&quot;)</span>
                    );

<span class="nc" id="L999">            checkTaskInstance(procWithSignal, processInstance, &quot;processTask&quot;, &quot;eventSubProcessTask&quot;, &quot;eventSubProcessTask&quot;);</span>
        }

<span class="nc" id="L1002">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1003">    }</span>

    @Test
    public void testMigrateParallelActivityToActivityInsideNonInterruptingTimerEventSubProcessInNewDefinition() {
<span class="nc" id="L1007">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L1009">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/non-interrupting-timer-event-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L1013">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Spawn the parallel task
<span class="nc" id="L1016">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1017">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1018">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L1021">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1022">        assertThat(executions)</span>
<span class="nc" id="L1023">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1024">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L1025">        assertThat(executions)</span>
<span class="nc" id="L1026">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1027">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L1028">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1029">        assertThat(tasks)</span>
<span class="nc" id="L1030">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1031">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L1032">        assertThat(tasks)</span>
<span class="nc" id="L1033">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L1034">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L1035">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1036">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L1038">        changeStateEventListener.clear();</span>

<span class="nc" id="L1040">        assertThat(runtimeService.createActivityInstanceQuery().list())</span>
<span class="nc" id="L1041">                .extracting(ActivityInstance::getActivityType, ActivityInstance::getActivityId)</span>
<span class="nc" id="L1042">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1043">                        tuple(&quot;startEvent&quot;, &quot;processStart&quot;),</span>
<span class="nc" id="L1044">                        tuple(&quot;sequenceFlow&quot;, &quot;flow1&quot;),</span>
<span class="nc" id="L1045">                        tuple(&quot;userTask&quot;, &quot;processTask&quot;),</span>
<span class="nc" id="L1046">                        tuple(&quot;boundaryEvent&quot;, &quot;timerBound&quot;),</span>
<span class="nc" id="L1047">                        tuple(&quot;boundaryEvent&quot;, &quot;timerBound&quot;),</span>
<span class="nc" id="L1048">                        tuple(&quot;sequenceFlow&quot;, &quot;flow3&quot;),</span>
<span class="nc" id="L1049">                        tuple(&quot;userTask&quot;, &quot;parallelTask&quot;)</span>
                );

        //Migrate to the other processDefinition
<span class="nc" id="L1053">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1054">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L1055">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;eventSubProcessTask&quot;));</span>

<span class="nc" id="L1057">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L1058">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L1059">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1061">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L1064">        assertThat(runtimeService.createActivityInstanceQuery().list())</span>
<span class="nc" id="L1065">                .extracting(ActivityInstance::getActivityType, ActivityInstance::getActivityId)</span>
<span class="nc" id="L1066">                .containsExactlyInAnyOrder(</span>
                        // old activities
<span class="nc" id="L1068">                        tuple(&quot;startEvent&quot;, &quot;processStart&quot;),</span>
<span class="nc" id="L1069">                        tuple(&quot;sequenceFlow&quot;, &quot;flow1&quot;),</span>
<span class="nc" id="L1070">                        tuple(&quot;userTask&quot;, &quot;processTask&quot;),</span>
<span class="nc" id="L1071">                        tuple(&quot;boundaryEvent&quot;, &quot;timerBound&quot;),</span>
<span class="nc" id="L1072">                        tuple(&quot;boundaryEvent&quot;, &quot;timerBound&quot;),</span>
<span class="nc" id="L1073">                        tuple(&quot;sequenceFlow&quot;, &quot;flow3&quot;),</span>

                        // new activities
<span class="nc" id="L1076">                        tuple(&quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;),</span>
<span class="nc" id="L1077">                        tuple(&quot;userTask&quot;, &quot;eventSubProcessTask&quot;)</span>
                );

<span class="nc" id="L1080">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1081">        assertThat(executions)</span>
<span class="nc" id="L1082">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1083">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;, &quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L1084">        assertThat(executions)</span>
<span class="nc" id="L1085">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1086">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L1087">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1088">        assertThat(tasks)</span>
<span class="nc" id="L1089">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1090">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L1091">        assertThat(tasks)</span>
<span class="nc" id="L1092">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L1093">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L1094">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1095">        assertThat(job).extracting(this::getJobActivityId).isEqualTo(&quot;eventSubProcessStart&quot;);</span>

        //Fire the signal
<span class="nc" id="L1098">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1099">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L1101">        assertThat(runtimeService.createActivityInstanceQuery().list())</span>
<span class="nc" id="L1102">                .extracting(ActivityInstance::getActivityType, ActivityInstance::getActivityId)</span>
<span class="nc" id="L1103">                .containsExactlyInAnyOrder(</span>
                        // old activities
<span class="nc" id="L1105">                        tuple(&quot;startEvent&quot;, &quot;processStart&quot;),</span>
<span class="nc" id="L1106">                        tuple(&quot;sequenceFlow&quot;, &quot;flow1&quot;),</span>
<span class="nc" id="L1107">                        tuple(&quot;userTask&quot;, &quot;processTask&quot;),</span>
<span class="nc" id="L1108">                        tuple(&quot;boundaryEvent&quot;, &quot;timerBound&quot;),</span>
<span class="nc" id="L1109">                        tuple(&quot;boundaryEvent&quot;, &quot;timerBound&quot;),</span>
<span class="nc" id="L1110">                        tuple(&quot;sequenceFlow&quot;, &quot;flow3&quot;),</span>

                        // After migration
<span class="nc" id="L1113">                        tuple(&quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;),</span>
<span class="nc" id="L1114">                        tuple(&quot;userTask&quot;, &quot;eventSubProcessTask&quot;),</span>

                        // After timer executed
<span class="nc" id="L1117">                        tuple(&quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;),</span>
<span class="nc" id="L1118">                        tuple(&quot;startEvent&quot;, &quot;eventSubProcessStart&quot;),</span>
<span class="nc" id="L1119">                        tuple(&quot;sequenceFlow&quot;, &quot;eventSubProcessFlow1&quot;),</span>
<span class="nc" id="L1120">                        tuple(&quot;userTask&quot;, &quot;eventSubProcessTask&quot;)</span>
                );

<span class="nc" id="L1123">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L1124">        assertThat(executions)</span>
<span class="nc" id="L1125">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1126">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessStart&quot;, &quot;eventSubProcessTask&quot;,</span>
                        &quot;eventSubProcessTask&quot;);
<span class="nc" id="L1128">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1129">        assertThat(tasks)</span>
<span class="nc" id="L1130">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1131">                .containsExactlyInAnyOrder(&quot;eventSubProcessTask&quot;, &quot;eventSubProcessTask&quot;, &quot;processTask&quot;);</span>
<span class="nc" id="L1132">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1133">        assertThat(job).extracting(this::getJobActivityId).isEqualTo(&quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L1135">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1137" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1139">            assertThat(historyService.createHistoricActivityInstanceQuery().list())</span>
<span class="nc" id="L1140">                    .extracting(HistoricActivityInstance::getActivityType, HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L1141">                    .containsExactlyInAnyOrder(</span>
                            // old activities
<span class="nc" id="L1143">                            tuple(&quot;startEvent&quot;, &quot;processStart&quot;),</span>
<span class="nc" id="L1144">                            tuple(&quot;sequenceFlow&quot;, &quot;flow1&quot;),</span>
<span class="nc" id="L1145">                            tuple(&quot;userTask&quot;, &quot;processTask&quot;),</span>
<span class="nc" id="L1146">                            tuple(&quot;boundaryEvent&quot;, &quot;timerBound&quot;),</span>
<span class="nc" id="L1147">                            tuple(&quot;boundaryEvent&quot;, &quot;timerBound&quot;),</span>
<span class="nc" id="L1148">                            tuple(&quot;sequenceFlow&quot;, &quot;flow3&quot;),</span>

                            // new activities
<span class="nc" id="L1151">                            tuple(&quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;),</span>
<span class="nc" id="L1152">                            tuple(&quot;userTask&quot;, &quot;eventSubProcessTask&quot;),</span>

                            // After timer executed
<span class="nc" id="L1155">                            tuple(&quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;),</span>
<span class="nc" id="L1156">                            tuple(&quot;startEvent&quot;, &quot;eventSubProcessStart&quot;),</span>
<span class="nc" id="L1157">                            tuple(&quot;sequenceFlow&quot;, &quot;eventSubProcessFlow1&quot;),</span>
<span class="nc" id="L1158">                            tuple(&quot;userTask&quot;, &quot;eventSubProcessTask&quot;),</span>

                            // After complete all tasks
<span class="nc" id="L1161">                            tuple(&quot;sequenceFlow&quot;, &quot;eventSubProcessFlow2&quot;),</span>
<span class="nc" id="L1162">                            tuple(&quot;endEvent&quot;, &quot;eventSubProcessEnd&quot;),</span>
<span class="nc" id="L1163">                            tuple(&quot;sequenceFlow&quot;, &quot;eventSubProcessFlow2&quot;),</span>
<span class="nc" id="L1164">                            tuple(&quot;endEvent&quot;, &quot;eventSubProcessEnd&quot;),</span>
<span class="nc" id="L1165">                            tuple(&quot;sequenceFlow&quot;, &quot;flow2&quot;),</span>
<span class="nc" id="L1166">                            tuple(&quot;endEvent&quot;, &quot;theEnd&quot;)</span>
                    );

<span class="nc" id="L1169">            checkTaskInstance(procWithSignal, processInstance, &quot;processTask&quot;, &quot;eventSubProcessTask&quot;, &quot;eventSubProcessTask&quot;);</span>
        }

<span class="nc" id="L1172">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1173">    }</span>

    @Test
    public void testMigrateSimpleActivityToActivityInsideSubProcessInNewDefinitionWithNestedSignalEventSubProcess() {
<span class="nc" id="L1177">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L1179">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-signal-event-subprocess-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L1183">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L1186">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1187">        assertThat(executions)</span>
<span class="nc" id="L1188">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1189">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1190">        assertThat(executions)</span>
<span class="nc" id="L1191">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1192">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L1193">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1194">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1195">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefOneTask.getId());</span>
<span class="nc" id="L1196">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1197">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L1199">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L1202">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1203">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L1204">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;subProcessTask&quot;));</span>

<span class="nc" id="L1206">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L1207">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L1208">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1210">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L1213">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1214">        assertThat(executions)</span>
<span class="nc" id="L1215">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1216">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;nestedSignalEventSubProcessStart&quot;);</span>
<span class="nc" id="L1217">        assertThat(executions)</span>
<span class="nc" id="L1218">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1219">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L1220">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1221">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;subProcessTask&quot;);</span>
<span class="nc" id="L1222">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignal.getId());</span>
<span class="nc" id="L1223">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1224">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L1225">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L1226">                .containsExactly(tuple(&quot;nestedSignalEventSubProcessStart&quot;, &quot;signal&quot;, &quot;someSignal&quot;));</span>

        //Fire the signal
<span class="nc" id="L1229">        runtimeService.signalEventReceived(&quot;someSignal&quot;);</span>

<span class="nc" id="L1231">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1232">        assertThat(executions)</span>
<span class="nc" id="L1233">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1234">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;nestedSignalEventSubProcess&quot;, &quot;nestedSignalEventSubProcessTask&quot;, &quot;nestedSignalEventSubProcessStart&quot;);</span>
<span class="nc" id="L1235">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1236">        assertThat(tasks)</span>
<span class="nc" id="L1237">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1238">                .containsExactlyInAnyOrder(&quot;nestedSignalEventSubProcessTask&quot;);</span>
<span class="nc" id="L1239">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().list();</span>
<span class="nc" id="L1240">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L1242">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1244" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1246">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;, &quot;subProcessTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>

<span class="nc" id="L1248">            checkTaskInstance(procWithSignal, processInstance, &quot;subProcessTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>

        }

<span class="nc" id="L1252">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1253">    }</span>

    @Test
    public void testMigrateSimpleActivityToActivityInsideSubProcessInNewDefinitionWithNestedMessageEventSubProcess() {
<span class="nc" id="L1257">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L1259">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-message-event-subprocess-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L1263">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L1266">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1267">        assertThat(executions)</span>
<span class="nc" id="L1268">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1269">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1270">        assertThat(executions)</span>
<span class="nc" id="L1271">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1272">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L1273">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1274">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1275">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefOneTask.getId());</span>
<span class="nc" id="L1276">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1277">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L1279">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L1282">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1283">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L1284">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;subProcessTask&quot;));</span>

<span class="nc" id="L1286">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L1287">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L1288">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1290">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L1293">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1294">        assertThat(executions)</span>
<span class="nc" id="L1295">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1296">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;nestedMessageEventSubProcessStart&quot;);</span>
<span class="nc" id="L1297">        assertThat(executions)</span>
<span class="nc" id="L1298">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1299">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L1300">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1301">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;subProcessTask&quot;);</span>
<span class="nc" id="L1302">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignal.getId());</span>
<span class="nc" id="L1303">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1304">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L1305">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L1306">                .containsExactly(tuple(&quot;nestedMessageEventSubProcessStart&quot;, &quot;message&quot;, &quot;someMessage&quot;));</span>

        //Trigger the event
<span class="nc" id="L1309">        Execution messageSubscriptionExecution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1310">                .messageEventSubscriptionName(&quot;someMessage&quot;).singleResult();</span>
<span class="nc" id="L1311">        runtimeService.messageEventReceived(&quot;someMessage&quot;, messageSubscriptionExecution.getId());</span>

<span class="nc" id="L1313">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L1314">        assertThat(executions)</span>
<span class="nc" id="L1315">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1316">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;nestedMessageEventSubProcess&quot;, &quot;nestedMessageEventSubProcessTask&quot;,</span>
                        &quot;nestedMessageEventSubProcessStart&quot;);
<span class="nc" id="L1318">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1319">        assertThat(tasks)</span>
<span class="nc" id="L1320">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1321">                .containsExactlyInAnyOrder(&quot;nestedMessageEventSubProcessTask&quot;);</span>
<span class="nc" id="L1322">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().list();</span>
<span class="nc" id="L1323">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L1325">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1327" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1329">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;, &quot;subProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>

<span class="nc" id="L1331">            checkTaskInstance(procWithSignal, processInstance, &quot;subProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>

        }

<span class="nc" id="L1335">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1336">    }</span>

    @Test
    public void testMigrateSimpleActivityToActivityInsideSubProcessInNewDefinitionWithNestedTimerEventSubProcess() {
<span class="nc" id="L1340">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L1342">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-timer-event-subprocess-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L1346">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L1349">        assertThat(runtimeService.createActivityInstanceQuery().list())</span>
<span class="nc" id="L1350">                .extracting(ActivityInstance::getActivityType, ActivityInstance::getActivityId)</span>
<span class="nc" id="L1351">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1352">                        tuple(&quot;startEvent&quot;, &quot;startEvent1&quot;),</span>
<span class="nc" id="L1353">                        tuple(&quot;sequenceFlow&quot;, &quot;seqFlow1Id&quot;),</span>
<span class="nc" id="L1354">                        tuple(&quot;userTask&quot;, &quot;userTask1Id&quot;)</span>
                );

<span class="nc" id="L1357">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1358">        assertThat(executions)</span>
<span class="nc" id="L1359">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1360">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1361">        assertThat(executions)</span>
<span class="nc" id="L1362">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1363">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L1364">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1365">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1366">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefOneTask.getId());</span>
<span class="nc" id="L1367">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1368">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L1370">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L1373">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1374">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L1375">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;subProcessTask&quot;));</span>

<span class="nc" id="L1377">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L1378">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L1379">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1381">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L1384">        assertThat(runtimeService.createActivityInstanceQuery().list())</span>
<span class="nc" id="L1385">                .extracting(ActivityInstance::getActivityType, ActivityInstance::getActivityId)</span>
<span class="nc" id="L1386">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1387">                        tuple(&quot;startEvent&quot;, &quot;startEvent1&quot;),</span>
<span class="nc" id="L1388">                        tuple(&quot;sequenceFlow&quot;, &quot;seqFlow1Id&quot;),</span>

                        // After migration
<span class="nc" id="L1391">                        tuple(&quot;subProcess&quot;, &quot;subProcess&quot;),</span>
<span class="nc" id="L1392">                        tuple(&quot;userTask&quot;, &quot;subProcessTask&quot;)</span>
                );

<span class="nc" id="L1395">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1396">        assertThat(executions)</span>
<span class="nc" id="L1397">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1398">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;nestedTimerEventSubProcessStart&quot;);</span>
<span class="nc" id="L1399">        assertThat(executions)</span>
<span class="nc" id="L1400">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1401">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L1402">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1403">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;subProcessTask&quot;);</span>
<span class="nc" id="L1404">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignal.getId());</span>
<span class="nc" id="L1405">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1406">        assertThat(job).extracting(this::getJobActivityId).isEqualTo(&quot;nestedTimerEventSubProcessStart&quot;);</span>

        //Fire the signal
<span class="nc" id="L1409">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1410">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L1412">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L1413">        assertThat(executions)</span>
<span class="nc" id="L1414">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1415">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;nestedTimerEventSubProcess&quot;, &quot;nestedTimerEventSubProcessTask&quot;, &quot;nestedTimerEventSubProcessStart&quot;);</span>
<span class="nc" id="L1416">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1417">        assertThat(tasks)</span>
<span class="nc" id="L1418">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1419">                .containsExactlyInAnyOrder(&quot;nestedTimerEventSubProcessTask&quot;);</span>
<span class="nc" id="L1420">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1421">        assertThat(job).isNull();</span>

<span class="nc" id="L1423">        assertThat(runtimeService.createActivityInstanceQuery().list())</span>
<span class="nc" id="L1424">                .extracting(ActivityInstance::getActivityType, ActivityInstance::getActivityId)</span>
<span class="nc" id="L1425">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1426">                        tuple(&quot;startEvent&quot;, &quot;startEvent1&quot;),</span>
<span class="nc" id="L1427">                        tuple(&quot;sequenceFlow&quot;, &quot;seqFlow1Id&quot;),</span>

                        // After migration
<span class="nc" id="L1430">                        tuple(&quot;subProcess&quot;, &quot;subProcess&quot;),</span>
<span class="nc" id="L1431">                        tuple(&quot;userTask&quot;, &quot;subProcessTask&quot;),</span>

                        // After timer fire
<span class="nc" id="L1434">                        tuple(&quot;eventSubProcess&quot;, &quot;nestedTimerEventSubProcess&quot;),</span>
<span class="nc" id="L1435">                        tuple(&quot;startEvent&quot;, &quot;nestedTimerEventSubProcessStart&quot;),</span>
<span class="nc" id="L1436">                        tuple(&quot;sequenceFlow&quot;, &quot;subSeqFlow1&quot;),</span>
<span class="nc" id="L1437">                        tuple(&quot;userTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;)</span>
                );

<span class="nc" id="L1440">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1442" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1444">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;, &quot;subProcessTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>

<span class="nc" id="L1446">            checkTaskInstance(procWithSignal, processInstance, &quot;subProcessTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>

<span class="nc" id="L1448">            assertThat(historyService.createHistoricActivityInstanceQuery().list())</span>
<span class="nc" id="L1449">                    .extracting(HistoricActivityInstance::getActivityType, HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L1450">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1451">                            tuple(&quot;startEvent&quot;, &quot;startEvent1&quot;),</span>
<span class="nc" id="L1452">                            tuple(&quot;sequenceFlow&quot;, &quot;seqFlow1Id&quot;),</span>

                            // After migration
<span class="nc" id="L1455">                            tuple(&quot;subProcess&quot;, &quot;subProcess&quot;),</span>
<span class="nc" id="L1456">                            tuple(&quot;userTask&quot;, &quot;subProcessTask&quot;),</span>

                            // After timer fire
<span class="nc" id="L1459">                            tuple(&quot;eventSubProcess&quot;, &quot;nestedTimerEventSubProcess&quot;),</span>
<span class="nc" id="L1460">                            tuple(&quot;startEvent&quot;, &quot;nestedTimerEventSubProcessStart&quot;),</span>
<span class="nc" id="L1461">                            tuple(&quot;sequenceFlow&quot;, &quot;subSeqFlow1&quot;),</span>
<span class="nc" id="L1462">                            tuple(&quot;userTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;),</span>

                            // After tasks complete
<span class="nc" id="L1465">                            tuple(&quot;sequenceFlow&quot;, &quot;subSeqFlow2&quot;),</span>
<span class="nc" id="L1466">                            tuple(&quot;endEvent&quot;, &quot;nestedEventSubProcEnd&quot;),</span>
<span class="nc" id="L1467">                            tuple(&quot;sequenceFlow&quot;, &quot;seqFlow3&quot;),</span>
<span class="nc" id="L1468">                            tuple(&quot;userTask&quot;, &quot;afterSubProcessTask&quot;),</span>
<span class="nc" id="L1469">                            tuple(&quot;sequenceFlow&quot;, &quot;seqFlow4&quot;),</span>
<span class="nc" id="L1470">                            tuple(&quot;endEvent&quot;, &quot;procEnd&quot;)</span>
                    );
        }

<span class="nc" id="L1474">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1475">    }</span>

    @Test
    public void testMigrateSimpleActivityToActivityInsideSubProcessInNewDefinitionWithNestedNonInterruptingSignalEventSubProcess() {
<span class="nc" id="L1479">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L1481">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/non-interrupting-signal-event-subprocess-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L1485">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L1488">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1489">        assertThat(executions)</span>
<span class="nc" id="L1490">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1491">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1492">        assertThat(executions)</span>
<span class="nc" id="L1493">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1494">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L1495">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1496">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1497">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefOneTask.getId());</span>
<span class="nc" id="L1498">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1499">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L1501">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L1504">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1505">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L1506">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;subProcessTask&quot;));</span>

<span class="nc" id="L1508">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L1509">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L1510">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1512">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L1515">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1516">        assertThat(executions)</span>
<span class="nc" id="L1517">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1518">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;nestedSignalEventSubProcessStart&quot;, &quot;subProcessTask&quot;);</span>
<span class="nc" id="L1519">        assertThat(executions)</span>
<span class="nc" id="L1520">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1521">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L1522">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1523">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;subProcessTask&quot;);</span>
<span class="nc" id="L1524">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignal.getId());</span>
<span class="nc" id="L1525">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1526">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L1527">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L1528">                .containsExactly(tuple(&quot;nestedSignalEventSubProcessStart&quot;, &quot;signal&quot;, &quot;someSignal&quot;));</span>

        //Check that the trigger works
<span class="nc" id="L1531">        runtimeService.signalEventReceived(&quot;someSignal&quot;);</span>

        //Confirm
<span class="nc" id="L1534">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1535">        assertThat(executions)</span>
<span class="nc" id="L1536">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1537">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;nestedSignalEventSubProcessStart&quot;, &quot;nestedSignalEventSubProcess&quot;, &quot;nestedSignalEventSubProcessTask&quot;,</span>
                        &quot;subProcessTask&quot;);
<span class="nc" id="L1539">        assertThat(executions)</span>
<span class="nc" id="L1540">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1541">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L1542">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1543">        assertThat(tasks)</span>
<span class="nc" id="L1544">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1545">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;);</span>
<span class="nc" id="L1546">        assertThat(tasks)</span>
<span class="nc" id="L1547">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L1548">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L1549">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1550">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L1551">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L1552">                .containsExactly(tuple(&quot;nestedSignalEventSubProcessStart&quot;, &quot;signal&quot;, &quot;someSignal&quot;));</span>

<span class="nc" id="L1554">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1556" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1558">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;, &quot;subProcessTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>

<span class="nc" id="L1560">            checkTaskInstance(procWithSignal, processInstance, &quot;subProcessTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>

        }

<span class="nc" id="L1564">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1565">    }</span>

    @Test
    public void testMigrateSimpleActivityToActivityInsideSubProcessInNewDefinitionWithNestedNonInterruptingMessageEventSubProcess() {
<span class="nc" id="L1569">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L1571">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/non-interrupting-message-event-subprocess-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L1575">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L1578">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1579">        assertThat(executions)</span>
<span class="nc" id="L1580">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1581">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1582">        assertThat(executions)</span>
<span class="nc" id="L1583">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1584">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L1585">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1586">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1587">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefOneTask.getId());</span>
<span class="nc" id="L1588">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1589">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L1591">        assertThat(runtimeService.createActivityInstanceQuery().list())</span>
<span class="nc" id="L1592">                .extracting(ActivityInstance::getActivityType, ActivityInstance::getActivityId)</span>
<span class="nc" id="L1593">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1594">                        tuple(&quot;startEvent&quot;, &quot;startEvent1&quot;),</span>
<span class="nc" id="L1595">                        tuple(&quot;sequenceFlow&quot;, &quot;seqFlow1Id&quot;),</span>
<span class="nc" id="L1596">                        tuple(&quot;userTask&quot;, &quot;userTask1Id&quot;)</span>
                );

<span class="nc" id="L1599">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L1602">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1603">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L1604">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;subProcessTask&quot;));</span>

<span class="nc" id="L1606">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L1607">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L1608">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1610">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L1613">        assertThat(runtimeService.createActivityInstanceQuery().list())</span>
<span class="nc" id="L1614">                .extracting(ActivityInstance::getActivityType, ActivityInstance::getActivityId)</span>
<span class="nc" id="L1615">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1616">                        tuple(&quot;startEvent&quot;, &quot;startEvent1&quot;),</span>
<span class="nc" id="L1617">                        tuple(&quot;sequenceFlow&quot;, &quot;seqFlow1Id&quot;),</span>

                        // After migration

<span class="nc" id="L1621">                        tuple(&quot;subProcess&quot;, &quot;subProcess&quot;),</span>
<span class="nc" id="L1622">                        tuple(&quot;userTask&quot;, &quot;subProcessTask&quot;)</span>
                );

<span class="nc" id="L1625">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1626">        assertThat(executions)</span>
<span class="nc" id="L1627">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1628">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;nestedMessageEventSubProcessStart&quot;, &quot;subProcessTask&quot;);</span>
<span class="nc" id="L1629">        assertThat(executions)</span>
<span class="nc" id="L1630">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1631">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L1632">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1633">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;subProcessTask&quot;);</span>
<span class="nc" id="L1634">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignal.getId());</span>
<span class="nc" id="L1635">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1636">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L1637">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L1638">                .containsExactly(tuple(&quot;nestedMessageEventSubProcessStart&quot;, &quot;message&quot;, &quot;someMessage&quot;));</span>

        //Trigger the event
<span class="nc" id="L1641">        Execution messageCatchExecution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1642">                .messageEventSubscriptionName(&quot;someMessage&quot;).singleResult();</span>
<span class="nc" id="L1643">        runtimeService.messageEventReceived(&quot;someMessage&quot;, messageCatchExecution.getId());</span>

<span class="nc" id="L1645">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1646">        assertThat(executions)</span>
<span class="nc" id="L1647">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1648">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;nestedMessageEventSubProcess&quot;, &quot;nestedMessageEventSubProcessStart&quot;,</span>
                        &quot;nestedMessageEventSubProcessTask&quot;);
<span class="nc" id="L1650">        assertThat(executions)</span>
<span class="nc" id="L1651">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1652">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L1653">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1654">        assertThat(tasks)</span>
<span class="nc" id="L1655">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1656">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;);</span>
<span class="nc" id="L1657">        assertThat(tasks)</span>
<span class="nc" id="L1658">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L1659">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L1660">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1661">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L1662">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L1663">                .containsExactly(tuple(&quot;nestedMessageEventSubProcessStart&quot;, &quot;message&quot;, &quot;someMessage&quot;));</span>

<span class="nc" id="L1665">        assertThat(runtimeService.createActivityInstanceQuery().list())</span>
<span class="nc" id="L1666">                .extracting(ActivityInstance::getActivityType, ActivityInstance::getActivityId)</span>
<span class="nc" id="L1667">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1668">                        tuple(&quot;startEvent&quot;, &quot;startEvent1&quot;),</span>
<span class="nc" id="L1669">                        tuple(&quot;sequenceFlow&quot;, &quot;seqFlow1Id&quot;),</span>

                        // After migration
<span class="nc" id="L1672">                        tuple(&quot;subProcess&quot;, &quot;subProcess&quot;),</span>
<span class="nc" id="L1673">                        tuple(&quot;userTask&quot;, &quot;subProcessTask&quot;),</span>

                        //  After message received
<span class="nc" id="L1676">                        tuple(&quot;eventSubProcess&quot;, &quot;nestedMessageEventSubProcess&quot;),</span>
<span class="nc" id="L1677">                        tuple(&quot;startEvent&quot;, &quot;nestedMessageEventSubProcessStart&quot;),</span>
<span class="nc" id="L1678">                        tuple(&quot;sequenceFlow&quot;, &quot;subSeqFlow1&quot;),</span>
<span class="nc" id="L1679">                        tuple(&quot;userTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;)</span>
                );

<span class="nc" id="L1682">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1684" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1686">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;, &quot;subProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>

<span class="nc" id="L1688">            checkTaskInstance(procWithSignal, processInstance, &quot;subProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>

<span class="nc" id="L1690">            assertThat(historyService.createHistoricActivityInstanceQuery().list())</span>
<span class="nc" id="L1691">                    .extracting(HistoricActivityInstance::getActivityType, HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L1692">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1693">                            tuple(&quot;startEvent&quot;, &quot;startEvent1&quot;),</span>
<span class="nc" id="L1694">                            tuple(&quot;sequenceFlow&quot;, &quot;seqFlow1Id&quot;),</span>

                            // After migration
<span class="nc" id="L1697">                            tuple(&quot;subProcess&quot;, &quot;subProcess&quot;),</span>
<span class="nc" id="L1698">                            tuple(&quot;userTask&quot;, &quot;subProcessTask&quot;),</span>

                            //  After message received
<span class="nc" id="L1701">                            tuple(&quot;eventSubProcess&quot;, &quot;nestedMessageEventSubProcess&quot;),</span>
<span class="nc" id="L1702">                            tuple(&quot;startEvent&quot;, &quot;nestedMessageEventSubProcessStart&quot;),</span>
<span class="nc" id="L1703">                            tuple(&quot;sequenceFlow&quot;, &quot;subSeqFlow1&quot;),</span>
<span class="nc" id="L1704">                            tuple(&quot;userTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;),</span>

                            // After tasks completion
<span class="nc" id="L1707">                            tuple(&quot;sequenceFlow&quot;, &quot;outerSubSeqFlow2&quot;),</span>
<span class="nc" id="L1708">                            tuple(&quot;endEvent&quot;, &quot;subProcEnd&quot;),</span>
<span class="nc" id="L1709">                            tuple(&quot;sequenceFlow&quot;, &quot;subSeqFlow2&quot;),</span>
<span class="nc" id="L1710">                            tuple(&quot;endEvent&quot;, &quot;nestedEventSubProcEnd&quot;),</span>
<span class="nc" id="L1711">                            tuple(&quot;sequenceFlow&quot;, &quot;seqFlow3&quot;),</span>
<span class="nc" id="L1712">                            tuple(&quot;userTask&quot;, &quot;afterSubProcessTask&quot;),</span>
<span class="nc" id="L1713">                            tuple(&quot;sequenceFlow&quot;, &quot;seqFlow4&quot;),</span>
<span class="nc" id="L1714">                            tuple(&quot;endEvent&quot;, &quot;procEnd&quot;)</span>
                    );
        }

<span class="nc" id="L1718">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1719">    }</span>

    @Test
    public void testMigrateSimpleActivityToActivityInsideSubProcessInNewDefinitionWithNestedNonInterruptingTimerEventSubProcess() {
<span class="nc" id="L1723">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);
<span class="nc" id="L1725">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/non-interrupting-timer-event-subprocess-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L1729">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L1732">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1733">        assertThat(executions)</span>
<span class="nc" id="L1734">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1735">                .containsExactly(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1736">        assertThat(executions)</span>
<span class="nc" id="L1737">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1738">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L1739">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1740">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L1741">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefOneTask.getId());</span>
<span class="nc" id="L1742">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1743">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L1745">        assertThat(runtimeService.createActivityInstanceQuery().list())</span>
<span class="nc" id="L1746">                .extracting(ActivityInstance::getActivityType, ActivityInstance::getActivityId)</span>
<span class="nc" id="L1747">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1748">                        tuple(&quot;startEvent&quot;, &quot;startEvent1&quot;),</span>
<span class="nc" id="L1749">                        tuple(&quot;sequenceFlow&quot;, &quot;seqFlow1Id&quot;),</span>
<span class="nc" id="L1750">                        tuple(&quot;userTask&quot;, &quot;userTask1Id&quot;)</span>
                );

<span class="nc" id="L1753">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L1756">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1757">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L1758">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;userTask1Id&quot;, &quot;subProcessTask&quot;));</span>

<span class="nc" id="L1760">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L1761">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L1762">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1764">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L1767">        assertThat(runtimeService.createActivityInstanceQuery().list())</span>
<span class="nc" id="L1768">                .extracting(ActivityInstance::getActivityType, ActivityInstance::getActivityId)</span>
<span class="nc" id="L1769">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1770">                        tuple(&quot;startEvent&quot;, &quot;startEvent1&quot;),</span>
<span class="nc" id="L1771">                        tuple(&quot;sequenceFlow&quot;, &quot;seqFlow1Id&quot;),</span>

                        // After migration
<span class="nc" id="L1774">                        tuple(&quot;subProcess&quot;, &quot;subProcess&quot;),</span>
<span class="nc" id="L1775">                        tuple(&quot;userTask&quot;, &quot;subProcessTask&quot;)</span>
                );

<span class="nc" id="L1778">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1779">        assertThat(executions)</span>
<span class="nc" id="L1780">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1781">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;nestedTimerEventSubProcessStart&quot;, &quot;subProcessTask&quot;);</span>
<span class="nc" id="L1782">        assertThat(executions)</span>
<span class="nc" id="L1783">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1784">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L1785">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1786">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;subProcessTask&quot;);</span>
<span class="nc" id="L1787">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignal.getId());</span>
<span class="nc" id="L1788">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1789">        assertThat(job).extracting(this::getJobActivityId).isEqualTo(&quot;nestedTimerEventSubProcessStart&quot;);</span>

        //Check that the trigger works
<span class="nc" id="L1792">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1793">        managementService.executeJob(job.getId());</span>

        //Confirm
<span class="nc" id="L1796">        assertThat(runtimeService.createActivityInstanceQuery().list())</span>
<span class="nc" id="L1797">                .extracting(ActivityInstance::getActivityType, ActivityInstance::getActivityId)</span>
<span class="nc" id="L1798">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1799">                        tuple(&quot;startEvent&quot;, &quot;startEvent1&quot;),</span>
<span class="nc" id="L1800">                        tuple(&quot;sequenceFlow&quot;, &quot;seqFlow1Id&quot;),</span>

                        // After migration
<span class="nc" id="L1803">                        tuple(&quot;subProcess&quot;, &quot;subProcess&quot;),</span>
<span class="nc" id="L1804">                        tuple(&quot;userTask&quot;, &quot;subProcessTask&quot;),</span>

                        // After timer fire
<span class="nc" id="L1807">                        tuple(&quot;eventSubProcess&quot;, &quot;nestedTimerEventSubProcess&quot;),</span>
<span class="nc" id="L1808">                        tuple(&quot;startEvent&quot;, &quot;nestedTimerEventSubProcessStart&quot;),</span>
<span class="nc" id="L1809">                        tuple(&quot;sequenceFlow&quot;, &quot;subSeqFlow1&quot;),</span>
<span class="nc" id="L1810">                        tuple(&quot;userTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;)</span>
                );

<span class="nc" id="L1813">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1814">        assertThat(executions)</span>
<span class="nc" id="L1815">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1816">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;nestedTimerEventSubProcessStart&quot;, &quot;nestedTimerEventSubProcess&quot;, &quot;subProcessTask&quot;,</span>
                        &quot;nestedTimerEventSubProcessTask&quot;);
<span class="nc" id="L1818">        assertThat(executions)</span>
<span class="nc" id="L1819">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1820">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L1821">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1822">        assertThat(tasks)</span>
<span class="nc" id="L1823">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1824">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;);</span>
<span class="nc" id="L1825">        assertThat(tasks)</span>
<span class="nc" id="L1826">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L1827">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L1828">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1829">        assertThat(job).extracting(this::getJobActivityId).isEqualTo(&quot;nestedTimerEventSubProcessStart&quot;);</span>

<span class="nc" id="L1831">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1833" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1835">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;, &quot;subProcessTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>

<span class="nc" id="L1837">            checkTaskInstance(procWithSignal, processInstance, &quot;subProcessTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>

<span class="nc" id="L1839">            assertThat(historyService.createHistoricActivityInstanceQuery().list())</span>
<span class="nc" id="L1840">                    .extracting(HistoricActivityInstance::getActivityType, HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L1841">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1842">                            tuple(&quot;startEvent&quot;, &quot;startEvent1&quot;),</span>
<span class="nc" id="L1843">                            tuple(&quot;sequenceFlow&quot;, &quot;seqFlow1Id&quot;),</span>

                            // After migration
<span class="nc" id="L1846">                            tuple(&quot;subProcess&quot;, &quot;subProcess&quot;),</span>
<span class="nc" id="L1847">                            tuple(&quot;userTask&quot;, &quot;subProcessTask&quot;),</span>

                            //  After message received
<span class="nc" id="L1850">                            tuple(&quot;eventSubProcess&quot;, &quot;nestedTimerEventSubProcess&quot;),</span>
<span class="nc" id="L1851">                            tuple(&quot;startEvent&quot;, &quot;nestedTimerEventSubProcessStart&quot;),</span>
<span class="nc" id="L1852">                            tuple(&quot;sequenceFlow&quot;, &quot;subSeqFlow1&quot;),</span>
<span class="nc" id="L1853">                            tuple(&quot;userTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;),</span>

                            // After tasks completion
<span class="nc" id="L1856">                            tuple(&quot;sequenceFlow&quot;, &quot;outerSubSeqFlow2&quot;),</span>
<span class="nc" id="L1857">                            tuple(&quot;endEvent&quot;, &quot;subProcEnd&quot;),</span>
<span class="nc" id="L1858">                            tuple(&quot;sequenceFlow&quot;, &quot;subSeqFlow2&quot;),</span>
<span class="nc" id="L1859">                            tuple(&quot;endEvent&quot;, &quot;nestedEventSubProcEnd&quot;),</span>
<span class="nc" id="L1860">                            tuple(&quot;sequenceFlow&quot;, &quot;seqFlow3&quot;),</span>
<span class="nc" id="L1861">                            tuple(&quot;userTask&quot;, &quot;afterSubProcessTask&quot;),</span>
<span class="nc" id="L1862">                            tuple(&quot;sequenceFlow&quot;, &quot;seqFlow4&quot;),</span>
<span class="nc" id="L1863">                            tuple(&quot;endEvent&quot;, &quot;procEnd&quot;)</span>
                    );

        }

<span class="nc" id="L1868">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1869">    }</span>

    @Test
    public void testMigrateParallelActivityToActivityInsideNestedSignalEventSubProcessInNewDefinitionAndActivityToRootScope() {
<span class="nc" id="L1873">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L1875">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-signal-event-subprocess-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L1879">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Spawn the parallel task
<span class="nc" id="L1882">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1883">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1884">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L1887">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1888">        assertThat(executions)</span>
<span class="nc" id="L1889">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1890">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L1891">        assertThat(executions)</span>
<span class="nc" id="L1892">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1893">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L1894">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1895">        assertThat(tasks)</span>
<span class="nc" id="L1896">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1897">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L1898">        assertThat(tasks)</span>
<span class="nc" id="L1899">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L1900">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L1901">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1902">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L1904">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L1907">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L1908">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L1909">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;processTask&quot;, &quot;beforeSubProcessTask&quot;))</span>
<span class="nc" id="L1910">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;));</span>

<span class="nc" id="L1912">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L1913">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L1914">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L1916">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L1919">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1920">        assertThat(executions)</span>
<span class="nc" id="L1921">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1922">                .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;subProcess&quot;, &quot;nestedSignalEventSubProcess&quot;, &quot;nestedSignalEventSubProcessTask&quot;);</span>
<span class="nc" id="L1923">        assertThat(executions)</span>
<span class="nc" id="L1924">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1925">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L1926">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1927">        assertThat(tasks)</span>
<span class="nc" id="L1928">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1929">                .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;);</span>
<span class="nc" id="L1930">        assertThat(tasks)</span>
<span class="nc" id="L1931">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L1932">                .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L1934">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1935">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L1937">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L1939" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L1941">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;,</span>
                    &quot;beforeSubProcessTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;, &quot;subProcessTask&quot;, &quot;afterSubProcessTask&quot;, &quot;afterSubProcessTask&quot;
            );
<span class="nc" id="L1944">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;nestedSignalEventSubProcess&quot;);</span>

<span class="nc bnc" id="L1946" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1947">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1948">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1949">                        .list();</span>
<span class="nc" id="L1950">                assertThat(historicTasks)</span>
<span class="nc" id="L1951">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L1952">                        .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;, &quot;subProcessTask&quot;, &quot;afterSubProcessTask&quot;,</span>
                                &quot;afterSubProcessTask&quot;);
<span class="nc" id="L1954">                assertThat(historicTasks)</span>
<span class="nc" id="L1955">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L1956">                        .containsOnly(procWithSignal.getId());</span>
            }
        }

<span class="nc" id="L1960">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1961">    }</span>

    @Test
    public void testMigrateParallelActivityToActivityInsideNestedSignalEventSubProcessInNewDefinitionAndActivityToParentScope() {
<span class="nc" id="L1965">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L1967">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-signal-event-subprocess-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L1971">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Spawn the parallel task
<span class="nc" id="L1974">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1975">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1976">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L1979">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1980">        assertThat(executions)</span>
<span class="nc" id="L1981">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1982">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L1983">        assertThat(executions)</span>
<span class="nc" id="L1984">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L1985">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L1986">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1987">        assertThat(tasks)</span>
<span class="nc" id="L1988">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1989">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L1990">        assertThat(tasks)</span>
<span class="nc" id="L1991">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L1992">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L1993">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1994">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L1996">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L1999">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2000">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L2001">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;processTask&quot;, &quot;subProcessTask&quot;))</span>
<span class="nc" id="L2002">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;));</span>

<span class="nc" id="L2004">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L2005">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L2006">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2008">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L2011">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2012">        assertThat(executions)</span>
<span class="nc" id="L2013">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2014">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;nestedSignalEventSubProcess&quot;, &quot;nestedSignalEventSubProcessTask&quot;);</span>
<span class="nc" id="L2015">        assertThat(executions)</span>
<span class="nc" id="L2016">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2017">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L2018">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2019">        assertThat(tasks)</span>
<span class="nc" id="L2020">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2021">                .containsExactlyInAnyOrder(&quot;nestedSignalEventSubProcessTask&quot;);</span>
<span class="nc" id="L2022">        assertThat(tasks)</span>
<span class="nc" id="L2023">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2024">                .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L2026">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2027">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L2029">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2031" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2033">            checkActivityInstances(procWithSignal, processInstance, &quot;userTask&quot;, &quot;subProcessTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>
<span class="nc" id="L2034">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;nestedSignalEventSubProcess&quot;);</span>

<span class="nc bnc" id="L2036" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L2037">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L2038">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2039">                        .list();</span>
<span class="nc" id="L2040">                assertThat(historicTasks)</span>
<span class="nc" id="L2041">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L2042">                        .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>
<span class="nc" id="L2043">                assertThat(historicTasks)</span>
<span class="nc" id="L2044">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L2045">                        .containsOnly(procWithSignal.getId());</span>
            }
        }

<span class="nc" id="L2049">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2050">    }</span>

    @Test
    public void testMigrateParallelActivityToActivityInsideNestedMessageEventSubProcessInNewDefinitionAndActivityToRootScope() {
<span class="nc" id="L2054">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L2056">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-message-event-subprocess-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L2060">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Spawn the parallel task
<span class="nc" id="L2063">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2064">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L2065">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L2068">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2069">        assertThat(executions)</span>
<span class="nc" id="L2070">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2071">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L2072">        assertThat(executions)</span>
<span class="nc" id="L2073">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2074">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2075">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2076">        assertThat(tasks)</span>
<span class="nc" id="L2077">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2078">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L2079">        assertThat(tasks)</span>
<span class="nc" id="L2080">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2081">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2082">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2083">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L2085">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L2088">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2089">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L2090">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;processTask&quot;, &quot;beforeSubProcessTask&quot;))</span>
<span class="nc" id="L2091">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;));</span>

<span class="nc" id="L2093">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L2094">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L2095">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2097">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L2100">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2101">        assertThat(executions)</span>
<span class="nc" id="L2102">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2103">                .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;subProcess&quot;, &quot;nestedMessageEventSubProcess&quot;, &quot;nestedMessageEventSubProcessTask&quot;);</span>
<span class="nc" id="L2104">        assertThat(executions)</span>
<span class="nc" id="L2105">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2106">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L2107">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2108">        assertThat(tasks)</span>
<span class="nc" id="L2109">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2110">                .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;);</span>
<span class="nc" id="L2111">        assertThat(tasks)</span>
<span class="nc" id="L2112">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2113">                .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L2115">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2116">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L2118">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2120" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2122">            List&lt;HistoricActivityInstance&gt; taskExecutions = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L2123">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2124">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L2125">                    .list();</span>
<span class="nc" id="L2126">            assertThat(taskExecutions)</span>
<span class="nc" id="L2127">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L2128">                    .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;, &quot;subProcessTask&quot;, &quot;afterSubProcessTask&quot;,</span>
                            &quot;afterSubProcessTask&quot;);
<span class="nc" id="L2130">            assertThat(taskExecutions)</span>
<span class="nc" id="L2131">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L2132">                    .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L2134">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;nestedMessageEventSubProcess&quot;);</span>

<span class="nc bnc" id="L2136" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L2137">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L2138">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2139">                        .list();</span>
<span class="nc" id="L2140">                assertThat(historicTasks)</span>
<span class="nc" id="L2141">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L2142">                        .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;, &quot;subProcessTask&quot;, &quot;afterSubProcessTask&quot;,</span>
                                &quot;afterSubProcessTask&quot;);
<span class="nc" id="L2144">                assertThat(historicTasks)</span>
<span class="nc" id="L2145">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L2146">                        .containsOnly(procWithSignal.getId());</span>
            }
        }

<span class="nc" id="L2150">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2151">    }</span>

    @Test
    public void testMigrateParallelActivityToActivityInsideNestedMessageEventSubProcessInNewDefinitionAndActivityToParentScope() {
<span class="nc" id="L2155">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L2157">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-message-event-subprocess-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L2161">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Spawn the parallel task
<span class="nc" id="L2164">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2165">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L2166">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L2169">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2170">        assertThat(executions)</span>
<span class="nc" id="L2171">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2172">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L2173">        assertThat(executions)</span>
<span class="nc" id="L2174">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2175">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2176">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2177">        assertThat(tasks)</span>
<span class="nc" id="L2178">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2179">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L2180">        assertThat(tasks)</span>
<span class="nc" id="L2181">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2182">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2183">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2184">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L2186">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L2189">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2190">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L2191">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;processTask&quot;, &quot;subProcessTask&quot;))</span>
<span class="nc" id="L2192">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;));</span>

<span class="nc" id="L2194">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L2195">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L2196">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2198">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L2201">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2202">        assertThat(executions)</span>
<span class="nc" id="L2203">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2204">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;nestedMessageEventSubProcess&quot;, &quot;nestedMessageEventSubProcessTask&quot;);</span>
<span class="nc" id="L2205">        assertThat(executions)</span>
<span class="nc" id="L2206">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2207">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L2208">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2209">        assertThat(tasks)</span>
<span class="nc" id="L2210">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2211">                .containsExactlyInAnyOrder(&quot;nestedMessageEventSubProcessTask&quot;);</span>
<span class="nc" id="L2212">        assertThat(tasks)</span>
<span class="nc" id="L2213">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2214">                .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L2216">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2217">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L2219">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2221" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2223">            List&lt;HistoricActivityInstance&gt; taskExecutions = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L2224">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2225">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L2226">                    .list();</span>
<span class="nc" id="L2227">            assertThat(taskExecutions)</span>
<span class="nc" id="L2228">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L2229">                    .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>
<span class="nc" id="L2230">            assertThat(taskExecutions)</span>
<span class="nc" id="L2231">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L2232">                    .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L2234">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;nestedMessageEventSubProcess&quot;);</span>

<span class="nc bnc" id="L2236" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L2237">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L2238">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2239">                        .list();</span>
<span class="nc" id="L2240">                assertThat(historicTasks)</span>
<span class="nc" id="L2241">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L2242">                        .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>
<span class="nc" id="L2243">                assertThat(historicTasks)</span>
<span class="nc" id="L2244">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L2245">                        .containsOnly(procWithSignal.getId());</span>
            }
        }

<span class="nc" id="L2249">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2250">    }</span>

    @Test
    public void testMigrateParallelActivityToActivityInsideNestedTimerEventSubProcessInNewDefinitionAndActivityToRootScope() {
<span class="nc" id="L2254">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L2256">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-timer-event-subprocess-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L2260">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Spawn the parallel task
<span class="nc" id="L2263">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2264">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L2265">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L2268">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2269">        assertThat(executions)</span>
<span class="nc" id="L2270">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2271">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L2272">        assertThat(executions)</span>
<span class="nc" id="L2273">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2274">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2275">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2276">        assertThat(tasks)</span>
<span class="nc" id="L2277">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2278">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L2279">        assertThat(tasks)</span>
<span class="nc" id="L2280">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2281">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2282">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2283">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L2285">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L2288">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2289">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L2290">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;processTask&quot;, &quot;beforeSubProcessTask&quot;))</span>
<span class="nc" id="L2291">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;));</span>

<span class="nc" id="L2293">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L2294">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L2295">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2297">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L2300">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2301">        assertThat(executions)</span>
<span class="nc" id="L2302">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2303">                .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;subProcess&quot;, &quot;nestedTimerEventSubProcess&quot;, &quot;nestedTimerEventSubProcessTask&quot;);</span>
<span class="nc" id="L2304">        assertThat(executions)</span>
<span class="nc" id="L2305">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2306">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L2307">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2308">        assertThat(tasks)</span>
<span class="nc" id="L2309">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2310">                .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;);</span>
<span class="nc" id="L2311">        assertThat(tasks)</span>
<span class="nc" id="L2312">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2313">                .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L2315">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2316">        assertThat(job).isNull();</span>

<span class="nc" id="L2318">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2320" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2322">            List&lt;HistoricActivityInstance&gt; taskExecutions = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L2323">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2324">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L2325">                    .list();</span>
<span class="nc" id="L2326">            assertThat(taskExecutions)</span>
<span class="nc" id="L2327">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L2328">                    .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;, &quot;subProcessTask&quot;, &quot;afterSubProcessTask&quot;,</span>
                            &quot;afterSubProcessTask&quot;);
<span class="nc" id="L2330">            assertThat(taskExecutions)</span>
<span class="nc" id="L2331">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L2332">                    .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L2334">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;nestedTimerEventSubProcess&quot;);</span>

<span class="nc bnc" id="L2336" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L2337">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L2338">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2339">                        .list();</span>
<span class="nc" id="L2340">                assertThat(historicTasks)</span>
<span class="nc" id="L2341">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L2342">                        .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;, &quot;subProcessTask&quot;, &quot;afterSubProcessTask&quot;,</span>
                                &quot;afterSubProcessTask&quot;);
<span class="nc" id="L2344">                assertThat(historicTasks)</span>
<span class="nc" id="L2345">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L2346">                        .containsOnly(procWithSignal.getId());</span>
            }
        }

<span class="nc" id="L2350">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2351">    }</span>

    @Test
    public void testMigrateParallelActivityToActivityInsideNestedTimerEventSubProcessInNewDefinitionAndActivityToParentScope() {
<span class="nc" id="L2355">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L2357">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-timer-event-subprocess-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L2361">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Spawn the parallel task
<span class="nc" id="L2364">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2365">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L2366">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L2369">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2370">        assertThat(executions)</span>
<span class="nc" id="L2371">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2372">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L2373">        assertThat(executions)</span>
<span class="nc" id="L2374">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2375">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2376">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2377">        assertThat(tasks)</span>
<span class="nc" id="L2378">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2379">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L2380">        assertThat(tasks)</span>
<span class="nc" id="L2381">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2382">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2383">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2384">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L2386">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L2389">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2390">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L2391">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;processTask&quot;, &quot;subProcessTask&quot;))</span>
<span class="nc" id="L2392">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;));</span>

<span class="nc" id="L2394">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L2395">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L2396">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2398">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L2401">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2402">        assertThat(executions)</span>
<span class="nc" id="L2403">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2404">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;nestedTimerEventSubProcess&quot;, &quot;nestedTimerEventSubProcessTask&quot;);</span>
<span class="nc" id="L2405">        assertThat(executions)</span>
<span class="nc" id="L2406">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2407">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L2408">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2409">        assertThat(tasks)</span>
<span class="nc" id="L2410">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2411">                .containsExactlyInAnyOrder(&quot;nestedTimerEventSubProcessTask&quot;);</span>
<span class="nc" id="L2412">        assertThat(tasks)</span>
<span class="nc" id="L2413">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2414">                .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L2416">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2417">        assertThat(job).isNull();</span>

<span class="nc" id="L2419">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2421" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2423">            List&lt;HistoricActivityInstance&gt; taskExecutions = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L2424">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2425">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L2426">                    .list();</span>
<span class="nc" id="L2427">            assertThat(taskExecutions)</span>
<span class="nc" id="L2428">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L2429">                    .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>
<span class="nc" id="L2430">            assertThat(taskExecutions)</span>
<span class="nc" id="L2431">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L2432">                    .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L2434">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;nestedTimerEventSubProcess&quot;);</span>

<span class="nc bnc" id="L2436" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L2437">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L2438">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2439">                        .list();</span>
<span class="nc" id="L2440">                assertThat(historicTasks)</span>
<span class="nc" id="L2441">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L2442">                        .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>
<span class="nc" id="L2443">                assertThat(historicTasks)</span>
<span class="nc" id="L2444">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L2445">                        .containsOnly(procWithSignal.getId());</span>
            }
        }

<span class="nc" id="L2449">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2450">    }</span>

    @Test
    public void testMigrateParallelActivityToActivityInsideNestedNonInterruptingSignalEventSubProcessInNewDefinitionAndActivityToRootScope() {
<span class="nc" id="L2454">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L2456">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/non-interrupting-signal-event-subprocess-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L2460">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Spawn the parallel task
<span class="nc" id="L2463">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2464">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L2465">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L2468">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2469">        assertThat(executions)</span>
<span class="nc" id="L2470">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2471">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L2472">        assertThat(executions)</span>
<span class="nc" id="L2473">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2474">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2475">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2476">        assertThat(tasks)</span>
<span class="nc" id="L2477">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2478">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L2479">        assertThat(tasks)</span>
<span class="nc" id="L2480">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2481">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2482">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2483">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L2485">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L2488">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2489">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L2490">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;processTask&quot;, &quot;beforeSubProcessTask&quot;))</span>
<span class="nc" id="L2491">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;));</span>

<span class="nc" id="L2493">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L2494">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L2495">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2497">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L2500">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2501">        assertThat(executions)</span>
<span class="nc" id="L2502">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2503">                .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;subProcess&quot;, &quot;nestedSignalEventSubProcess&quot;, &quot;nestedSignalEventSubProcessTask&quot;);</span>
<span class="nc" id="L2504">        assertThat(executions)</span>
<span class="nc" id="L2505">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2506">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L2507">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2508">        assertThat(tasks)</span>
<span class="nc" id="L2509">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2510">                .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;);</span>
<span class="nc" id="L2511">        assertThat(tasks)</span>
<span class="nc" id="L2512">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2513">                .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L2515">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2516">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L2518">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2520" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2522">            List&lt;HistoricActivityInstance&gt; taskExecutions = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L2523">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2524">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L2525">                    .list();</span>
<span class="nc" id="L2526">            assertThat(taskExecutions)</span>
<span class="nc" id="L2527">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L2528">                    .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;, &quot;subProcessTask&quot;, &quot;afterSubProcessTask&quot;,</span>
                            &quot;afterSubProcessTask&quot;);
<span class="nc" id="L2530">            assertThat(taskExecutions)</span>
<span class="nc" id="L2531">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L2532">                    .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L2534">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;nestedSignalEventSubProcess&quot;);</span>

<span class="nc bnc" id="L2536" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L2537">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L2538">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2539">                        .list();</span>
<span class="nc" id="L2540">                assertThat(historicTasks)</span>
<span class="nc" id="L2541">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L2542">                        .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;, &quot;subProcessTask&quot;, &quot;afterSubProcessTask&quot;,</span>
                                &quot;afterSubProcessTask&quot;);
<span class="nc" id="L2544">                assertThat(historicTasks)</span>
<span class="nc" id="L2545">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L2546">                        .containsOnly(procWithSignal.getId());</span>
            }
        }

<span class="nc" id="L2550">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2551">    }</span>

    @Test
    public void testMigrateParallelActivityToActivityInsideNestedNonInterruptingSignalEventSubProcessInNewDefinitionAndActivityToParentScope() {
<span class="nc" id="L2555">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L2557">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/non-interrupting-signal-event-subprocess-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L2561">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Spawn the parallel task
<span class="nc" id="L2564">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2565">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L2566">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L2569">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2570">        assertThat(executions)</span>
<span class="nc" id="L2571">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2572">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L2573">        assertThat(executions)</span>
<span class="nc" id="L2574">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2575">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2576">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2577">        assertThat(tasks)</span>
<span class="nc" id="L2578">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2579">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L2580">        assertThat(tasks)</span>
<span class="nc" id="L2581">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2582">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2583">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2584">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L2586">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L2589">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2590">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L2591">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;processTask&quot;, &quot;subProcessTask&quot;))</span>
<span class="nc" id="L2592">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;));</span>

<span class="nc" id="L2594">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L2595">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L2596">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2598">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L2601">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2602">        assertThat(executions)</span>
<span class="nc" id="L2603">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2604">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;nestedSignalEventSubProcess&quot;, &quot;nestedSignalEventSubProcessTask&quot;,</span>
                        &quot;nestedSignalEventSubProcessStart&quot;);
<span class="nc" id="L2606">        assertThat(executions)</span>
<span class="nc" id="L2607">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2608">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L2609">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2610">        assertThat(tasks)</span>
<span class="nc" id="L2611">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2612">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;);</span>
<span class="nc" id="L2613">        assertThat(tasks)</span>
<span class="nc" id="L2614">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2615">                .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L2617">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2618">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L2619">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L2620">                .containsExactly(tuple(&quot;nestedSignalEventSubProcessStart&quot;, &quot;signal&quot;, &quot;someSignal&quot;));</span>

        //Trigger the event
<span class="nc" id="L2623">        runtimeService.signalEventReceived(&quot;someSignal&quot;);</span>

<span class="nc" id="L2625">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2626">        assertThat(executions)</span>
<span class="nc" id="L2627">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2628">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;nestedSignalEventSubProcess&quot;, &quot;nestedSignalEventSubProcessTask&quot;,</span>
                        &quot;nestedSignalEventSubProcess&quot;, &quot;nestedSignalEventSubProcessTask&quot;, &quot;nestedSignalEventSubProcessStart&quot;);
<span class="nc" id="L2630">        assertThat(executions)</span>
<span class="nc" id="L2631">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2632">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L2633">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2634">        assertThat(tasks)</span>
<span class="nc" id="L2635">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2636">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;);</span>
<span class="nc" id="L2637">        assertThat(tasks)</span>
<span class="nc" id="L2638">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2639">                .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L2641">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2642">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L2643">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L2644">                .containsExactly(tuple(&quot;nestedSignalEventSubProcessStart&quot;, &quot;signal&quot;, &quot;someSignal&quot;));</span>

<span class="nc" id="L2646">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2648" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2650">            List&lt;HistoricActivityInstance&gt; taskExecutions = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L2651">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2652">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L2653">                    .list();</span>
<span class="nc" id="L2654">            assertThat(taskExecutions)</span>
<span class="nc" id="L2655">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L2656">                    .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>
<span class="nc" id="L2657">            assertThat(taskExecutions)</span>
<span class="nc" id="L2658">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L2659">                    .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L2661">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;nestedSignalEventSubProcess&quot;, &quot;nestedSignalEventSubProcess&quot;);</span>

<span class="nc bnc" id="L2663" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L2664">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L2665">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2666">                        .list();</span>
<span class="nc" id="L2667">                assertThat(historicTasks)</span>
<span class="nc" id="L2668">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L2669">                        .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;, &quot;nestedSignalEventSubProcessTask&quot;,</span>
                                &quot;afterSubProcessTask&quot;);
<span class="nc" id="L2671">                assertThat(historicTasks)</span>
<span class="nc" id="L2672">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L2673">                        .containsOnly(procWithSignal.getId());</span>
            }
        }

<span class="nc" id="L2677">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2678">    }</span>

    @Test
    public void testMigrateParallelActivityToActivityInsideNestedNonInterruptingMessageEventSubProcessInNewDefinitionAndActivityToRootScope() {
<span class="nc" id="L2682">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L2684">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/non-interrupting-message-event-subprocess-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L2688">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Spawn the parallel task
<span class="nc" id="L2691">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2692">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L2693">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L2696">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2697">        assertThat(executions)</span>
<span class="nc" id="L2698">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2699">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L2700">        assertThat(executions)</span>
<span class="nc" id="L2701">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2702">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2703">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2704">        assertThat(tasks)</span>
<span class="nc" id="L2705">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2706">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L2707">        assertThat(tasks)</span>
<span class="nc" id="L2708">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2709">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2710">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2711">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L2713">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L2716">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2717">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L2718">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;processTask&quot;, &quot;beforeSubProcessTask&quot;))</span>
<span class="nc" id="L2719">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;));</span>

<span class="nc" id="L2721">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L2722">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L2723">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2725">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L2728">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2729">        assertThat(executions)</span>
<span class="nc" id="L2730">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2731">                .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;subProcess&quot;, &quot;nestedMessageEventSubProcess&quot;, &quot;nestedMessageEventSubProcessTask&quot;);</span>
<span class="nc" id="L2732">        assertThat(executions)</span>
<span class="nc" id="L2733">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2734">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L2735">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2736">        assertThat(tasks)</span>
<span class="nc" id="L2737">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2738">                .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;);</span>
<span class="nc" id="L2739">        assertThat(tasks)</span>
<span class="nc" id="L2740">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2741">                .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L2743">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2744">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L2746">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2748" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2750">            List&lt;HistoricActivityInstance&gt; taskExecutions = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L2751">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2752">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L2753">                    .list();</span>
<span class="nc" id="L2754">            assertThat(taskExecutions)</span>
<span class="nc" id="L2755">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L2756">                    .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;, &quot;subProcessTask&quot;, &quot;afterSubProcessTask&quot;,</span>
                            &quot;afterSubProcessTask&quot;);
<span class="nc" id="L2758">            assertThat(taskExecutions)</span>
<span class="nc" id="L2759">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L2760">                    .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L2762">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;nestedMessageEventSubProcess&quot;);</span>

<span class="nc bnc" id="L2764" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L2765">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L2766">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2767">                        .list();</span>
<span class="nc" id="L2768">                assertThat(historicTasks)</span>
<span class="nc" id="L2769">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L2770">                        .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;, &quot;subProcessTask&quot;, &quot;afterSubProcessTask&quot;,</span>
                                &quot;afterSubProcessTask&quot;);
<span class="nc" id="L2772">                assertThat(historicTasks)</span>
<span class="nc" id="L2773">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L2774">                        .containsOnly(procWithSignal.getId());</span>
            }
        }

<span class="nc" id="L2778">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2779">    }</span>

    @Test
    public void testMigrateParallelActivityToActivityInsideNestedNonInterruptingMessageEventSubProcessInNewDefinitionAndActivityToParentScope() {
<span class="nc" id="L2783">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L2785">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/non-interrupting-message-event-subprocess-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L2789">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Spawn the parallel task
<span class="nc" id="L2792">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2793">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L2794">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L2797">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2798">        assertThat(executions)</span>
<span class="nc" id="L2799">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2800">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L2801">        assertThat(executions)</span>
<span class="nc" id="L2802">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2803">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2804">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2805">        assertThat(tasks)</span>
<span class="nc" id="L2806">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2807">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L2808">        assertThat(tasks)</span>
<span class="nc" id="L2809">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2810">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2811">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2812">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L2814">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L2817">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2818">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L2819">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;processTask&quot;, &quot;subProcessTask&quot;))</span>
<span class="nc" id="L2820">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;));</span>

<span class="nc" id="L2822">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L2823">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L2824">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2826">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L2829">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2830">        assertThat(executions)</span>
<span class="nc" id="L2831">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2832">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;nestedMessageEventSubProcess&quot;, &quot;subProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;,</span>
                        &quot;nestedMessageEventSubProcessStart&quot;);
<span class="nc" id="L2834">        assertThat(executions)</span>
<span class="nc" id="L2835">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2836">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L2837">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2838">        assertThat(tasks)</span>
<span class="nc" id="L2839">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2840">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;);</span>
<span class="nc" id="L2841">        assertThat(tasks)</span>
<span class="nc" id="L2842">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2843">                .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L2845">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2846">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L2847">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L2848">                .containsExactly(tuple(&quot;nestedMessageEventSubProcessStart&quot;, &quot;message&quot;, &quot;someMessage&quot;));</span>

        //Trigger the event
<span class="nc" id="L2851">        EventSubscription eventExecution = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).eventName(&quot;someMessage&quot;)</span>
<span class="nc" id="L2852">                .singleResult();</span>
<span class="nc" id="L2853">        runtimeService.messageEventReceived(&quot;someMessage&quot;, eventExecution.getExecutionId());</span>

<span class="nc" id="L2855">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2856">        assertThat(executions)</span>
<span class="nc" id="L2857">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2858">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;nestedMessageEventSubProcess&quot;, &quot;nestedMessageEventSubProcessTask&quot;,</span>
                        &quot;nestedMessageEventSubProcess&quot;, &quot;nestedMessageEventSubProcessTask&quot;,
                        &quot;nestedMessageEventSubProcessStart&quot;);
<span class="nc" id="L2861">        assertThat(executions)</span>
<span class="nc" id="L2862">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2863">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L2864">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2865">        assertThat(tasks)</span>
<span class="nc" id="L2866">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2867">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;);</span>
<span class="nc" id="L2868">        assertThat(tasks)</span>
<span class="nc" id="L2869">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2870">                .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L2872">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2873">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L2874">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L2875">                .containsExactly(tuple(&quot;nestedMessageEventSubProcessStart&quot;, &quot;message&quot;, &quot;someMessage&quot;));</span>

<span class="nc" id="L2877">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2879" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2881">            List&lt;HistoricActivityInstance&gt; taskExecutions = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L2882">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2883">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L2884">                    .list();</span>
<span class="nc" id="L2885">            assertThat(taskExecutions)</span>
<span class="nc" id="L2886">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L2887">                    .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>
<span class="nc" id="L2888">            assertThat(taskExecutions)</span>
<span class="nc" id="L2889">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L2890">                    .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L2892">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;nestedMessageEventSubProcess&quot;, &quot;nestedMessageEventSubProcess&quot;);</span>

<span class="nc bnc" id="L2894" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L2895">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L2896">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2897">                        .list();</span>
<span class="nc" id="L2898">                assertThat(historicTasks)</span>
<span class="nc" id="L2899">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L2900">                        .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;, &quot;nestedMessageEventSubProcessTask&quot;,</span>
                                &quot;afterSubProcessTask&quot;);
<span class="nc" id="L2902">                assertThat(historicTasks)</span>
<span class="nc" id="L2903">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L2904">                        .containsOnly(procWithSignal.getId());</span>
            }
        }

<span class="nc" id="L2908">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2909">    }</span>

    @Test
    public void testMigrateParallelActivityToActivityInsideNestedNonInterruptingTimerEventSubProcessInNewDefinitionAndActivityToRootScope() {
<span class="nc" id="L2913">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L2915">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/non-interrupting-timer-event-subprocess-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L2919">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Spawn the parallel task
<span class="nc" id="L2922">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2923">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L2924">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L2927">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2928">        assertThat(executions)</span>
<span class="nc" id="L2929">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2930">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L2931">        assertThat(executions)</span>
<span class="nc" id="L2932">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2933">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2934">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2935">        assertThat(tasks)</span>
<span class="nc" id="L2936">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2937">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L2938">        assertThat(tasks)</span>
<span class="nc" id="L2939">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2940">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L2941">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2942">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L2944">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L2947">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L2948">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L2949">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;processTask&quot;, &quot;beforeSubProcessTask&quot;))</span>
<span class="nc" id="L2950">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;));</span>

<span class="nc" id="L2952">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L2953">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L2954">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L2956">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L2959">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2960">        assertThat(executions)</span>
<span class="nc" id="L2961">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L2962">                .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;subProcess&quot;, &quot;nestedTimerEventSubProcess&quot;, &quot;nestedTimerEventSubProcessTask&quot;);</span>
<span class="nc" id="L2963">        assertThat(executions)</span>
<span class="nc" id="L2964">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L2965">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L2966">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2967">        assertThat(tasks)</span>
<span class="nc" id="L2968">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2969">                .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;);</span>
<span class="nc" id="L2970">        assertThat(tasks)</span>
<span class="nc" id="L2971">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L2972">                .containsOnly(procWithSignal.getId());</span>

        //Behaves like interrupting since theres no execution in the parentScope
<span class="nc" id="L2975">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2976">        assertThat(job).isNull();</span>

<span class="nc" id="L2978">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L2980" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L2982">            List&lt;HistoricActivityInstance&gt; taskExecutions = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L2983">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2984">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L2985">                    .list();</span>
<span class="nc" id="L2986">            assertThat(taskExecutions)</span>
<span class="nc" id="L2987">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L2988">                    .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;, &quot;subProcessTask&quot;, &quot;afterSubProcessTask&quot;,</span>
                            &quot;afterSubProcessTask&quot;);
<span class="nc" id="L2990">            assertThat(taskExecutions)</span>
<span class="nc" id="L2991">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L2992">                    .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L2994">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;nestedTimerEventSubProcess&quot;);</span>

<span class="nc bnc" id="L2996" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L2997">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L2998">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2999">                        .list();</span>
<span class="nc" id="L3000">                assertThat(historicTasks)</span>
<span class="nc" id="L3001">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L3002">                        .containsExactlyInAnyOrder(&quot;beforeSubProcessTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;, &quot;subProcessTask&quot;, &quot;afterSubProcessTask&quot;,</span>
                                &quot;afterSubProcessTask&quot;);
<span class="nc" id="L3004">                assertThat(historicTasks)</span>
<span class="nc" id="L3005">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L3006">                        .containsOnly(procWithSignal.getId());</span>
            }
        }

<span class="nc" id="L3010">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3011">    }</span>

    @Test
    public void testMigrateParallelActivityToActivityInsideNestedNonInterruptingTimerEventSubProcessInNewDefinitionAndActivityToParentScope() {
<span class="nc" id="L3015">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/timer-parallel-task.bpmn20.xml&quot;);
<span class="nc" id="L3017">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/non-interrupting-timer-event-subprocess-nested-in-embedded-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L3021">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procDefOneTask.getId());</span>

        //Spawn the parallel task
<span class="nc" id="L3024">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3025">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L3026">        managementService.executeJob(job.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L3029">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3030">        assertThat(executions)</span>
<span class="nc" id="L3031">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3032">                .containsExactlyInAnyOrder(&quot;timerBound&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L3033">        assertThat(executions)</span>
<span class="nc" id="L3034">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3035">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L3036">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3037">        assertThat(tasks)</span>
<span class="nc" id="L3038">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L3039">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>
<span class="nc" id="L3040">        assertThat(tasks)</span>
<span class="nc" id="L3041">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L3042">                .containsOnly(procDefOneTask.getId());</span>

<span class="nc" id="L3044">        List&lt;Job&gt; jobs = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3045">        assertThat(jobs)</span>
<span class="nc" id="L3046">                .extracting(this::getJobActivityId)</span>
<span class="nc" id="L3047">                .doesNotContain(&quot;nestedTimerEventSubProcessStart&quot;);</span>

<span class="nc" id="L3049">        changeStateEventListener.clear();</span>

        //Migrate to the other processDefinition
<span class="nc" id="L3052">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L3053">                .migrateToProcessDefinition(procWithSignal.getId())</span>
<span class="nc" id="L3054">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;processTask&quot;, &quot;subProcessTask&quot;))</span>
<span class="nc" id="L3055">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;parallelTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;));</span>

<span class="nc" id="L3057">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L3058">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L3059">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L3061">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L3064">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3065">        assertThat(executions)</span>
<span class="nc" id="L3066">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3067">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;nestedTimerEventSubProcess&quot;, &quot;nestedTimerEventSubProcessTask&quot;,</span>
                        &quot;nestedTimerEventSubProcessStart&quot;);
<span class="nc" id="L3069">        assertThat(executions)</span>
<span class="nc" id="L3070">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3071">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L3072">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3073">        assertThat(tasks)</span>
<span class="nc" id="L3074">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L3075">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;);</span>
<span class="nc" id="L3076">        assertThat(tasks)</span>
<span class="nc" id="L3077">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L3078">                .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L3080">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3081">        assertThat(job).extracting(this::getJobActivityId).isEqualTo(&quot;nestedTimerEventSubProcessStart&quot;);</span>

        //Fire the timer
<span class="nc" id="L3084">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L3085">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L3087">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3088">        assertThat(executions)</span>
<span class="nc" id="L3089">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3090">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;nestedTimerEventSubProcess&quot;, &quot;nestedTimerEventSubProcessTask&quot;,</span>
                        &quot;nestedTimerEventSubProcess&quot;, &quot;nestedTimerEventSubProcessTask&quot;, &quot;nestedTimerEventSubProcessStart&quot;);
<span class="nc" id="L3092">        assertThat(executions)</span>
<span class="nc" id="L3093">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3094">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L3095">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3096">        assertThat(tasks)</span>
<span class="nc" id="L3097">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L3098">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;);</span>
<span class="nc" id="L3099">        assertThat(tasks)</span>
<span class="nc" id="L3100">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L3101">                .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L3103">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3104">        assertThat(job).extracting(this::getJobActivityId).isEqualTo(&quot;nestedTimerEventSubProcessStart&quot;);</span>

<span class="nc" id="L3106">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L3108" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L3110">            List&lt;HistoricActivityInstance&gt; taskExecutions = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L3111">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L3112">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L3113">                    .list();</span>
<span class="nc" id="L3114">            assertThat(taskExecutions)</span>
<span class="nc" id="L3115">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L3116">                    .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>
<span class="nc" id="L3117">            assertThat(taskExecutions)</span>
<span class="nc" id="L3118">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L3119">                    .containsOnly(procWithSignal.getId());</span>

<span class="nc" id="L3121">            checkActivityInstances(procWithSignal, processInstance, &quot;eventSubProcess&quot;, &quot;nestedTimerEventSubProcess&quot;, &quot;nestedTimerEventSubProcess&quot;);</span>

<span class="nc bnc" id="L3123" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L3124">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L3125">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L3126">                        .list();</span>
<span class="nc" id="L3127">                assertThat(historicTasks)</span>
<span class="nc" id="L3128">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L3129">                        .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;, &quot;nestedTimerEventSubProcessTask&quot;, &quot;afterSubProcessTask&quot;);</span>
<span class="nc" id="L3130">                assertThat(historicTasks)</span>
<span class="nc" id="L3131">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L3132">                        .containsOnly(procWithSignal.getId());</span>
            }
        }

<span class="nc" id="L3136">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3137">    }</span>

    @Test
    public void testMigrateInterruptingEventSubProcessToInterruptingEventSubProcessOfDifferentEventType() {
<span class="nc" id="L3141">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-signal-event-subprocess.bpmn20.xml&quot;);
<span class="nc" id="L3143">        ProcessDefinition procWithMessage = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-message-event-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L3147">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procWithSignal.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L3150">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3151">        assertThat(executions)</span>
<span class="nc" id="L3152">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3153">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L3154">        assertThat(executions)</span>
<span class="nc" id="L3155">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3156">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L3157">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3158">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;processTask&quot;);</span>
<span class="nc" id="L3159">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignal.getId());</span>
<span class="nc" id="L3160">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3161">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3162">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L3163">                .containsExactly(tuple(&quot;eventSubProcessStart&quot;, &quot;signal&quot;, &quot;eventSignal&quot;));</span>

        //Migrate only with autoMapping
<span class="nc" id="L3166">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L3167">                .migrateToProcessDefinition(procWithMessage.getId());</span>

<span class="nc" id="L3169">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L3170">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L3171">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L3173">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm migration
<span class="nc" id="L3176">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3177">        assertThat(executions)</span>
<span class="nc" id="L3178">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3179">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L3180">        assertThat(executions)</span>
<span class="nc" id="L3181">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3182">                .containsOnly(procWithMessage.getId());</span>
<span class="nc" id="L3183">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3184">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;processTask&quot;);</span>
<span class="nc" id="L3185">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithMessage.getId());</span>
<span class="nc" id="L3186">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3187">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3188">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L3189">                .containsExactly(tuple(&quot;eventSubProcessStart&quot;, &quot;message&quot;, &quot;someMessage&quot;));</span>

        //Trigger the event
<span class="nc" id="L3192">        EventSubscription eventExecution = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).eventName(&quot;someMessage&quot;)</span>
<span class="nc" id="L3193">                .singleResult();</span>
<span class="nc" id="L3194">        runtimeService.messageEventReceived(&quot;someMessage&quot;, eventExecution.getExecutionId());</span>

<span class="nc" id="L3196">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3197">        assertThat(executions)</span>
<span class="nc" id="L3198">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3199">                .containsExactlyInAnyOrder(&quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;, &quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L3200">        assertThat(executions)</span>
<span class="nc" id="L3201">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3202">                .containsOnly(procWithMessage.getId());</span>
<span class="nc" id="L3203">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3204">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L3205">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithMessage.getId());</span>
<span class="nc" id="L3206">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3207">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L3209">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L3211" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L3213">            List&lt;HistoricActivityInstance&gt; taskExecutions = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L3214">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L3215">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L3216">                    .list();</span>
<span class="nc" id="L3217">            assertThat(taskExecutions)</span>
<span class="nc" id="L3218">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L3219">                    .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L3220">            assertThat(taskExecutions)</span>
<span class="nc" id="L3221">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L3222">                    .containsOnly(procWithMessage.getId());</span>

<span class="nc bnc" id="L3224" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L3225">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L3226">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L3227">                        .list();</span>
<span class="nc" id="L3228">                assertThat(historicTasks)</span>
<span class="nc" id="L3229">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L3230">                        .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L3231">                assertThat(historicTasks)</span>
<span class="nc" id="L3232">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L3233">                        .containsOnly(procWithMessage.getId());</span>
            }
        }
<span class="nc" id="L3236">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3237">    }</span>

    @Test
    public void testMigrateNonInterruptingEventSubProcessToNonInterruptingEventSubProcessOfDifferentEventType() {
<span class="nc" id="L3241">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/non-interrupting-signal-event-subprocess.bpmn20.xml&quot;);
<span class="nc" id="L3243">        ProcessDefinition procWithMessage = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/non-interrupting-message-event-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L3247">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procWithSignal.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L3250">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3251">        assertThat(executions)</span>
<span class="nc" id="L3252">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3253">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L3254">        assertThat(executions)</span>
<span class="nc" id="L3255">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3256">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L3257">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3258">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;processTask&quot;);</span>
<span class="nc" id="L3259">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignal.getId());</span>
<span class="nc" id="L3260">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3261">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3262">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L3263">                .containsExactly(tuple(&quot;eventSubProcessStart&quot;, &quot;signal&quot;, &quot;eventSignal&quot;));</span>

<span class="nc" id="L3265">        assertThat(runtimeService.createActivityInstanceQuery().list())</span>
<span class="nc" id="L3266">                .extracting(ActivityInstance::getActivityType, ActivityInstance::getActivityId)</span>
<span class="nc" id="L3267">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L3268">                        tuple(&quot;startEvent&quot;, &quot;theStart&quot;),</span>
<span class="nc" id="L3269">                        tuple(&quot;sequenceFlow&quot;, &quot;flow1&quot;),</span>
<span class="nc" id="L3270">                        tuple(&quot;userTask&quot;, &quot;processTask&quot;)</span>
                );

        //Migrate only with autoMapping
<span class="nc" id="L3274">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L3275">                .migrateToProcessDefinition(procWithMessage.getId());</span>
<span class="nc" id="L3276">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L3277">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L3278">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L3280">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm migration
<span class="nc" id="L3283">        assertThat(runtimeService.createActivityInstanceQuery().list())</span>
<span class="nc" id="L3284">                .extracting(ActivityInstance::getActivityType, ActivityInstance::getActivityId)</span>
<span class="nc" id="L3285">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L3286">                        tuple(&quot;startEvent&quot;, &quot;theStart&quot;),</span>
<span class="nc" id="L3287">                        tuple(&quot;sequenceFlow&quot;, &quot;flow1&quot;),</span>
<span class="nc" id="L3288">                        tuple(&quot;userTask&quot;, &quot;processTask&quot;)</span>
                );
<span class="nc" id="L3290">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3291">        assertThat(executions)</span>
<span class="nc" id="L3292">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3293">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L3294">        assertThat(executions)</span>
<span class="nc" id="L3295">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3296">                .containsOnly(procWithMessage.getId());</span>
<span class="nc" id="L3297">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3298">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;processTask&quot;);</span>
<span class="nc" id="L3299">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithMessage.getId());</span>
<span class="nc" id="L3300">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3301">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3302">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L3303">                .containsExactly(tuple(&quot;eventSubProcessStart&quot;, &quot;message&quot;, &quot;someMessage&quot;));</span>

        //Trigger the event
<span class="nc" id="L3306">        EventSubscription eventExecution = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).eventName(&quot;someMessage&quot;)</span>
<span class="nc" id="L3307">                .singleResult();</span>
<span class="nc" id="L3308">        runtimeService.messageEventReceived(&quot;someMessage&quot;, eventExecution.getExecutionId());</span>

<span class="nc" id="L3310">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3311">        assertThat(executions)</span>
<span class="nc" id="L3312">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3313">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;, &quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L3314">        assertThat(executions)</span>
<span class="nc" id="L3315">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3316">                .containsOnly(procWithMessage.getId());</span>
<span class="nc" id="L3317">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3318">        assertThat(tasks)</span>
<span class="nc" id="L3319">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L3320">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L3321">        assertThat(tasks)</span>
<span class="nc" id="L3322">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L3323">                .containsOnly(procWithMessage.getId());</span>
<span class="nc" id="L3324">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3325">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3326">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L3327">                .containsExactly(tuple(&quot;eventSubProcessStart&quot;, &quot;message&quot;, &quot;someMessage&quot;));</span>

<span class="nc" id="L3329">        assertThat(runtimeService.createActivityInstanceQuery().list())</span>
<span class="nc" id="L3330">                .extracting(ActivityInstance::getActivityType, ActivityInstance::getActivityId)</span>
<span class="nc" id="L3331">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L3332">                        tuple(&quot;startEvent&quot;, &quot;theStart&quot;),</span>
<span class="nc" id="L3333">                        tuple(&quot;sequenceFlow&quot;, &quot;flow1&quot;),</span>
<span class="nc" id="L3334">                        tuple(&quot;userTask&quot;, &quot;processTask&quot;),</span>

                        // After message trigger
<span class="nc" id="L3337">                        tuple(&quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;),</span>
<span class="nc" id="L3338">                        tuple(&quot;startEvent&quot;, &quot;eventSubProcessStart&quot;),</span>
<span class="nc" id="L3339">                        tuple(&quot;sequenceFlow&quot;, &quot;subProcessFlow1&quot;),</span>
<span class="nc" id="L3340">                        tuple(&quot;userTask&quot;, &quot;eventSubProcessTask&quot;)</span>
                );

        //Trigger the event again
<span class="nc" id="L3344">        eventExecution = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).eventName(&quot;someMessage&quot;).singleResult();</span>
<span class="nc" id="L3345">        runtimeService.messageEventReceived(&quot;someMessage&quot;, eventExecution.getExecutionId());</span>

<span class="nc" id="L3347">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3348">        assertThat(executions)</span>
<span class="nc" id="L3349">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3350">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;, &quot;eventSubProcessStart&quot;,</span>
                        &quot;eventSubProcessTask&quot;);
<span class="nc" id="L3352">        assertThat(executions)</span>
<span class="nc" id="L3353">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3354">                .containsOnly(procWithMessage.getId());</span>
<span class="nc" id="L3355">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3356">        assertThat(tasks)</span>
<span class="nc" id="L3357">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L3358">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L3359">        assertThat(tasks)</span>
<span class="nc" id="L3360">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L3361">                .containsOnly(procWithMessage.getId());</span>
<span class="nc" id="L3362">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3363">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3364">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L3365">                .containsExactly(tuple(&quot;eventSubProcessStart&quot;, &quot;message&quot;, &quot;someMessage&quot;));</span>

<span class="nc" id="L3367">        assertThat(runtimeService.createActivityInstanceQuery().list())</span>
<span class="nc" id="L3368">                .extracting(ActivityInstance::getActivityType, ActivityInstance::getActivityId)</span>
<span class="nc" id="L3369">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L3370">                        tuple(&quot;startEvent&quot;, &quot;theStart&quot;),</span>
<span class="nc" id="L3371">                        tuple(&quot;sequenceFlow&quot;, &quot;flow1&quot;),</span>
<span class="nc" id="L3372">                        tuple(&quot;userTask&quot;, &quot;processTask&quot;),</span>

                        // After message trigger
<span class="nc" id="L3375">                        tuple(&quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;),</span>
<span class="nc" id="L3376">                        tuple(&quot;startEvent&quot;, &quot;eventSubProcessStart&quot;),</span>
<span class="nc" id="L3377">                        tuple(&quot;sequenceFlow&quot;, &quot;subProcessFlow1&quot;),</span>
<span class="nc" id="L3378">                        tuple(&quot;userTask&quot;, &quot;eventSubProcessTask&quot;),</span>

                        // After message second trigger
<span class="nc" id="L3381">                        tuple(&quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;),</span>
<span class="nc" id="L3382">                        tuple(&quot;startEvent&quot;, &quot;eventSubProcessStart&quot;),</span>
<span class="nc" id="L3383">                        tuple(&quot;sequenceFlow&quot;, &quot;subProcessFlow1&quot;),</span>
<span class="nc" id="L3384">                        tuple(&quot;userTask&quot;, &quot;eventSubProcessTask&quot;)</span>
                );

<span class="nc" id="L3387">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L3389" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L3391">            List&lt;HistoricActivityInstance&gt; taskExecutions = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L3392">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L3393">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L3394">                    .list();</span>
<span class="nc" id="L3395">            assertThat(taskExecutions)</span>
<span class="nc" id="L3396">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L3397">                    .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L3398">            assertThat(taskExecutions)</span>
<span class="nc" id="L3399">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L3400">                    .containsOnly(procWithMessage.getId());</span>

<span class="nc" id="L3402">            assertThat(historyService.createHistoricActivityInstanceQuery().list())</span>
<span class="nc" id="L3403">                    .extracting(HistoricActivityInstance::getActivityType, HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L3404">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L3405">                            tuple(&quot;startEvent&quot;, &quot;theStart&quot;),</span>
<span class="nc" id="L3406">                            tuple(&quot;sequenceFlow&quot;, &quot;flow1&quot;),</span>
<span class="nc" id="L3407">                            tuple(&quot;userTask&quot;, &quot;processTask&quot;),</span>

                            // After message trigger
<span class="nc" id="L3410">                            tuple(&quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;),</span>
<span class="nc" id="L3411">                            tuple(&quot;startEvent&quot;, &quot;eventSubProcessStart&quot;),</span>
<span class="nc" id="L3412">                            tuple(&quot;sequenceFlow&quot;, &quot;subProcessFlow1&quot;),</span>
<span class="nc" id="L3413">                            tuple(&quot;userTask&quot;, &quot;eventSubProcessTask&quot;),</span>

                            // After message second trigger
<span class="nc" id="L3416">                            tuple(&quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;),</span>
<span class="nc" id="L3417">                            tuple(&quot;startEvent&quot;, &quot;eventSubProcessStart&quot;),</span>
<span class="nc" id="L3418">                            tuple(&quot;sequenceFlow&quot;, &quot;subProcessFlow1&quot;),</span>
<span class="nc" id="L3419">                            tuple(&quot;userTask&quot;, &quot;eventSubProcessTask&quot;),</span>

                            // After tasks completion

<span class="nc" id="L3423">                            tuple(&quot;sequenceFlow&quot;, &quot;flow2&quot;),</span>
<span class="nc" id="L3424">                            tuple(&quot;endEvent&quot;, &quot;theEnd&quot;),</span>
<span class="nc" id="L3425">                            tuple(&quot;sequenceFlow&quot;, &quot;subProcessFlow2&quot;),</span>
<span class="nc" id="L3426">                            tuple(&quot;endEvent&quot;, &quot;eventSubProcessEnd&quot;),</span>
<span class="nc" id="L3427">                            tuple(&quot;sequenceFlow&quot;, &quot;subProcessFlow2&quot;),</span>
<span class="nc" id="L3428">                            tuple(&quot;endEvent&quot;, &quot;eventSubProcessEnd&quot;)</span>
                    );

<span class="nc bnc" id="L3431" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L3432">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L3433">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L3434">                        .list();</span>
<span class="nc" id="L3435">                assertThat(historicTasks)</span>
<span class="nc" id="L3436">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L3437">                        .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L3438">                assertThat(historicTasks)</span>
<span class="nc" id="L3439">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L3440">                        .containsOnly(procWithMessage.getId());</span>
            }
        }
<span class="nc" id="L3443">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3444">    }</span>

    @Test
    public void testMigrateInterruptingEventSubProcessToNonInterruptingEventSubProcessOfDifferentEventType() {
<span class="nc" id="L3448">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-signal-event-subprocess.bpmn20.xml&quot;);
<span class="nc" id="L3450">        ProcessDefinition procWithMessage = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/non-interrupting-message-event-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L3454">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procWithSignal.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L3457">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3458">        assertThat(executions)</span>
<span class="nc" id="L3459">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3460">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L3461">        assertThat(executions)</span>
<span class="nc" id="L3462">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3463">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L3464">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3465">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;processTask&quot;);</span>
<span class="nc" id="L3466">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignal.getId());</span>
<span class="nc" id="L3467">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3468">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3469">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L3470">                .containsExactly(tuple(&quot;eventSubProcessStart&quot;, &quot;signal&quot;, &quot;eventSignal&quot;));</span>

        //Migrate only with autoMapping
<span class="nc" id="L3473">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L3474">                .migrateToProcessDefinition(procWithMessage.getId());</span>

<span class="nc" id="L3476">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L3477">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L3478">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L3480">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm migration
<span class="nc" id="L3483">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3484">        assertThat(executions)</span>
<span class="nc" id="L3485">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3486">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L3487">        assertThat(executions)</span>
<span class="nc" id="L3488">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3489">                .containsOnly(procWithMessage.getId());</span>
<span class="nc" id="L3490">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3491">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;processTask&quot;);</span>
<span class="nc" id="L3492">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithMessage.getId());</span>
<span class="nc" id="L3493">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3494">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3495">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L3496">                .containsExactly(tuple(&quot;eventSubProcessStart&quot;, &quot;message&quot;, &quot;someMessage&quot;));</span>

        //Trigger the event
<span class="nc" id="L3499">        EventSubscription eventExecution = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).eventName(&quot;someMessage&quot;)</span>
<span class="nc" id="L3500">                .singleResult();</span>
<span class="nc" id="L3501">        runtimeService.messageEventReceived(&quot;someMessage&quot;, eventExecution.getExecutionId());</span>

<span class="nc" id="L3503">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3504">        assertThat(executions)</span>
<span class="nc" id="L3505">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3506">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;, &quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L3507">        assertThat(executions)</span>
<span class="nc" id="L3508">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3509">                .containsOnly(procWithMessage.getId());</span>
<span class="nc" id="L3510">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3511">        assertThat(tasks)</span>
<span class="nc" id="L3512">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L3513">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L3514">        assertThat(tasks)</span>
<span class="nc" id="L3515">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L3516">                .containsOnly(procWithMessage.getId());</span>
<span class="nc" id="L3517">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3518">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3519">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L3520">                .containsExactly(tuple(&quot;eventSubProcessStart&quot;, &quot;message&quot;, &quot;someMessage&quot;));</span>

        //Trigger the event again
<span class="nc" id="L3523">        eventExecution = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).eventName(&quot;someMessage&quot;).singleResult();</span>
<span class="nc" id="L3524">        runtimeService.messageEventReceived(&quot;someMessage&quot;, eventExecution.getExecutionId());</span>

<span class="nc" id="L3526">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3527">        assertThat(executions)</span>
<span class="nc" id="L3528">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3529">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;, &quot;eventSubProcessStart&quot;,</span>
                        &quot;eventSubProcessTask&quot;);
<span class="nc" id="L3531">        assertThat(executions)</span>
<span class="nc" id="L3532">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3533">                .containsOnly(procWithMessage.getId());</span>
<span class="nc" id="L3534">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3535">        assertThat(tasks)</span>
<span class="nc" id="L3536">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L3537">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L3538">        assertThat(tasks)</span>
<span class="nc" id="L3539">                .extracting(Task::getProcessDefinitionId)</span>
<span class="nc" id="L3540">                .containsOnly(procWithMessage.getId());</span>
<span class="nc" id="L3541">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3542">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3543">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L3544">                .containsExactly(tuple(&quot;eventSubProcessStart&quot;, &quot;message&quot;, &quot;someMessage&quot;));</span>

<span class="nc" id="L3546">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L3548" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L3550">            List&lt;HistoricActivityInstance&gt; taskExecutions = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L3551">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L3552">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L3553">                    .list();</span>
<span class="nc" id="L3554">            assertThat(taskExecutions)</span>
<span class="nc" id="L3555">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L3556">                    .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L3557">            assertThat(taskExecutions)</span>
<span class="nc" id="L3558">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L3559">                    .containsOnly(procWithMessage.getId());</span>

<span class="nc bnc" id="L3561" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L3562">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L3563">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L3564">                        .list();</span>
<span class="nc" id="L3565">                assertThat(historicTasks)</span>
<span class="nc" id="L3566">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L3567">                        .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L3568">                assertThat(historicTasks)</span>
<span class="nc" id="L3569">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L3570">                        .containsOnly(procWithMessage.getId());</span>
            }
        }
<span class="nc" id="L3573">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3574">    }</span>

    @Test
    public void testMigrateNonInterruptingEventSubProcessToInterruptingEventSubProcessOfDifferentEventType() {
<span class="nc" id="L3578">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/non-interrupting-signal-event-subprocess.bpmn20.xml&quot;);
<span class="nc" id="L3580">        ProcessDefinition procWithMessage = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-message-event-subprocess.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L3584">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procWithSignal.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L3587">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3588">        assertThat(executions)</span>
<span class="nc" id="L3589">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3590">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L3591">        assertThat(executions)</span>
<span class="nc" id="L3592">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3593">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L3594">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3595">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;processTask&quot;);</span>
<span class="nc" id="L3596">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignal.getId());</span>
<span class="nc" id="L3597">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3598">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3599">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L3600">                .containsExactly(tuple(&quot;eventSubProcessStart&quot;, &quot;signal&quot;, &quot;eventSignal&quot;));</span>

        //Migrate only with autoMapping
<span class="nc" id="L3603">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L3604">                .migrateToProcessDefinition(procWithMessage.getId());</span>

<span class="nc" id="L3606">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L3607">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L3608">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L3610">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm migration
<span class="nc" id="L3613">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3614">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L3615">        assertThat(executions)</span>
<span class="nc" id="L3616">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3617">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L3618">        assertThat(executions)</span>
<span class="nc" id="L3619">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3620">                .containsOnly(procWithMessage.getId());</span>
<span class="nc" id="L3621">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3622">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;processTask&quot;);</span>
<span class="nc" id="L3623">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithMessage.getId());</span>
<span class="nc" id="L3624">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3625">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3626">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L3627">                .containsExactly(tuple(&quot;eventSubProcessStart&quot;, &quot;message&quot;, &quot;someMessage&quot;));</span>

        //Trigger the event
<span class="nc" id="L3630">        EventSubscription eventExecution = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).eventName(&quot;someMessage&quot;)</span>
<span class="nc" id="L3631">                .singleResult();</span>
<span class="nc" id="L3632">        runtimeService.messageEventReceived(&quot;someMessage&quot;, eventExecution.getExecutionId());</span>

<span class="nc" id="L3634">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3635">        assertThat(executions)</span>
<span class="nc" id="L3636">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3637">                .containsExactlyInAnyOrder(&quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;, &quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L3638">        assertThat(executions)</span>
<span class="nc" id="L3639">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3640">                .containsOnly(procWithMessage.getId());</span>
<span class="nc" id="L3641">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3642">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L3643">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithMessage.getId());</span>
<span class="nc" id="L3644">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3645">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L3647">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc bnc" id="L3649" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L3651">            List&lt;HistoricActivityInstance&gt; taskExecutions = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L3652">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L3653">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L3654">                    .list();</span>
<span class="nc" id="L3655">            assertThat(taskExecutions)</span>
<span class="nc" id="L3656">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L3657">                    .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L3658">            assertThat(taskExecutions)</span>
<span class="nc" id="L3659">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L3660">                    .containsOnly(procWithMessage.getId());</span>

<span class="nc bnc" id="L3662" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L3663">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L3664">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L3665">                        .list();</span>
<span class="nc" id="L3666">                assertThat(historicTasks)</span>
<span class="nc" id="L3667">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L3668">                        .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;);</span>
<span class="nc" id="L3669">                assertThat(historicTasks)</span>
<span class="nc" id="L3670">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L3671">                        .containsOnly(procWithMessage.getId());</span>
            }
        }
<span class="nc" id="L3674">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3675">    }</span>

    @Test
    public void testMigrateProcessActivityWithActiveEventSubProcessStart() {
<span class="nc" id="L3679">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-signal-event-subprocess.bpmn20.xml&quot;);
<span class="nc" id="L3681">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L3685">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procWithSignal.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L3688">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3689">        assertThat(executions)</span>
<span class="nc" id="L3690">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3691">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L3692">        assertThat(executions)</span>
<span class="nc" id="L3693">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3694">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L3695">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3696">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;processTask&quot;);</span>
<span class="nc" id="L3697">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignal.getId());</span>
<span class="nc" id="L3698">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3699">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3700">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L3701">                .containsExactly(tuple(&quot;eventSubProcessStart&quot;, &quot;signal&quot;, &quot;eventSignal&quot;));</span>

<span class="nc" id="L3703">        changeStateEventListener.clear();</span>

        //Migrate only the user task
<span class="nc" id="L3706">        ProcessInstanceMigrationBuilder processInstanceMigrationBuilder = processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L3707">                .migrateToProcessDefinition(procDefOneTask.getId())</span>
                //This is still a &quot;valid&quot; migration of the Event SubProcess Start execution, doing it along with the task activity execution that requires migration, but is not a &quot;direct&quot; migration of the task
<span class="nc" id="L3709">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(Arrays.asList(&quot;processTask&quot;, &quot;eventSubProcessStart&quot;), &quot;userTask1Id&quot;));</span>

<span class="nc" id="L3711">        ProcessInstanceMigrationValidationResult processInstanceMigrationValidationResult = processInstanceMigrationBuilder</span>
<span class="nc" id="L3712">                .validateMigration(processInstance.getId());</span>
<span class="nc" id="L3713">        assertThat(processInstanceMigrationValidationResult.isMigrationValid()).isTrue();</span>

<span class="nc" id="L3715">        processInstanceMigrationBuilder.migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L3718">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3719">        assertThat(executions)</span>
<span class="nc" id="L3720">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3721">                .containsExactlyInAnyOrder(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L3722">        assertThat(executions)</span>
<span class="nc" id="L3723">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3724">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L3725">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3726">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L3727">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefOneTask.getId());</span>
<span class="nc" id="L3728">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3729">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L3731">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc bnc" id="L3732" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            //Check History
<span class="nc" id="L3734">            List&lt;HistoricActivityInstance&gt; taskExecutions = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L3735">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L3736">                    .activityType(&quot;userTask&quot;)</span>
<span class="nc" id="L3737">                    .list();</span>
<span class="nc" id="L3738">            assertThat(taskExecutions)</span>
<span class="nc" id="L3739">                    .extracting(HistoricActivityInstance::getActivityId)</span>
<span class="nc" id="L3740">                    .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;userTask1Id&quot;);</span>
<span class="nc" id="L3741">            assertThat(taskExecutions)</span>
<span class="nc" id="L3742">                    .extracting(HistoricActivityInstance::getProcessDefinitionId)</span>
<span class="nc" id="L3743">                    .containsOnly(procDefOneTask.getId());</span>

<span class="nc" id="L3745">            List&lt;HistoricActivityInstance&gt; eventSubProcExecution = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L3746">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L3747">                    .activityType(&quot;eventSubProcess&quot;)</span>
<span class="nc" id="L3748">                    .list();</span>
<span class="nc" id="L3749">            assertThat(eventSubProcExecution).isEmpty();</span>

<span class="nc bnc" id="L3751" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L3752">                List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L3753">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L3754">                        .list();</span>
<span class="nc" id="L3755">                assertThat(historicTasks)</span>
<span class="nc" id="L3756">                        .extracting(HistoricTaskInstance::getTaskDefinitionKey)</span>
<span class="nc" id="L3757">                        .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;userTask1Id&quot;);</span>
<span class="nc" id="L3758">                assertThat(historicTasks)</span>
<span class="nc" id="L3759">                        .extracting(HistoricTaskInstance::getProcessDefinitionId)</span>
<span class="nc" id="L3760">                        .containsOnly(procDefOneTask.getId());</span>
            }
        }
<span class="nc" id="L3763">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3764">    }</span>

    @Test
    @Disabled(&quot;Will work when manual and auto-cancelling of activities is implemented. To cancel SubProcessStartEvent when there's no counter-part in the new definition and allow direct migration og processTask&quot;)
    public void testMigrateProcessActivityWithActiveEventSubProcessStartUsingCancel() {
<span class="nc" id="L3769">        ProcessDefinition procWithSignal = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/interrupting-signal-event-subprocess.bpmn20.xml&quot;);
<span class="nc" id="L3771">        ProcessDefinition procDefOneTask = deployProcessDefinition(&quot;my deploy&quot;,</span>
                &quot;org/flowable/engine/test/api/runtime/migration/one-task-simple-process.bpmn20.xml&quot;);

        //Start the processInstance
<span class="nc" id="L3775">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(procWithSignal.getId());</span>

        //Confirm the state to migrate
<span class="nc" id="L3778">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3779">        assertThat(executions)</span>
<span class="nc" id="L3780">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3781">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L3782">        assertThat(executions)</span>
<span class="nc" id="L3783">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3784">                .containsOnly(procWithSignal.getId());</span>
<span class="nc" id="L3785">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3786">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;processTask&quot;);</span>
<span class="nc" id="L3787">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procWithSignal.getId());</span>
<span class="nc" id="L3788">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3789">        assertThat(eventSubscriptions)</span>
<span class="nc" id="L3790">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L3791">                .containsExactly(tuple(&quot;eventSubProcessStart&quot;, &quot;signal&quot;, &quot;eventSignal&quot;));</span>

<span class="nc" id="L3793">        changeStateEventListener.clear();</span>

        //Migrate only the user task
<span class="nc" id="L3796">        processMigrationService.createProcessInstanceMigrationBuilder()</span>
<span class="nc" id="L3797">                .migrateToProcessDefinition(procDefOneTask.getId())</span>
<span class="nc" id="L3798">                .addActivityMigrationMapping(ActivityMigrationMapping.createMappingFor(&quot;processTask&quot;, &quot;userTask1Id&quot;))</span>
                //.deleteActivityExcution(&quot;eventSubProcessStart&quot;)
<span class="nc" id="L3800">                .migrate(processInstance.getId());</span>

        //Confirm
<span class="nc" id="L3803">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3804">        assertThat(executions)</span>
<span class="nc" id="L3805">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L3806">                .containsExactlyInAnyOrder(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L3807">        assertThat(executions)</span>
<span class="nc" id="L3808">                .extracting(&quot;processDefinitionId&quot;)</span>
<span class="nc" id="L3809">                .containsOnly(procDefOneTask.getId());</span>
<span class="nc" id="L3810">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3811">        assertThat(task).extracting(Task::getTaskDefinitionKey).isEqualTo(&quot;userTask1Id&quot;);</span>
<span class="nc" id="L3812">        assertThat(task).extracting(Task::getProcessDefinitionId).isEqualTo(procDefOneTask.getId());</span>
<span class="nc" id="L3813">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3814">        assertThat(eventSubscriptions).isEmpty();</span>

<span class="nc" id="L3816">        completeProcessInstanceTasks(processInstance.getId());</span>

<span class="nc" id="L3818">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3819">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>