<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BaseDynamicSubProcessInjectUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.impl.dynamic</a> &gt; <span class="el_source">BaseDynamicSubProcessInjectUtil.java</span></div><h1>BaseDynamicSubProcessInjectUtil.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.engine.impl.dynamic;

import java.io.InputStream;
import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.Map;
import java.util.UUID;

import org.apache.commons.lang3.StringUtils;
import org.flowable.bpmn.model.BoundaryEvent;
import org.flowable.bpmn.model.BpmnModel;
import org.flowable.bpmn.model.CompensateEventDefinition;
import org.flowable.bpmn.model.FieldExtension;
import org.flowable.bpmn.model.FlowElement;
import org.flowable.bpmn.model.FlowElementsContainer;
import org.flowable.bpmn.model.GraphicInfo;
import org.flowable.bpmn.model.Process;
import org.flowable.bpmn.model.SequenceFlow;
import org.flowable.bpmn.model.ServiceTask;
import org.flowable.bpmn.model.SubProcess;
import org.flowable.bpmn.model.UserTask;
import org.flowable.common.engine.impl.interceptor.CommandContext;
import org.flowable.common.engine.impl.util.IoUtil;
import org.flowable.dmn.api.DmnDecision;
import org.flowable.dmn.api.DmnDeployment;
import org.flowable.dmn.api.DmnRepositoryService;
import org.flowable.engine.impl.cfg.ProcessEngineConfigurationImpl;
import org.flowable.engine.impl.persistence.entity.DeploymentEntity;
import org.flowable.engine.impl.persistence.entity.ProcessDefinitionEntity;
import org.flowable.engine.impl.persistence.entity.ResourceEntity;
import org.flowable.engine.impl.persistence.entity.ResourceEntityManager;
import org.flowable.engine.impl.util.CommandContextUtil;
import org.flowable.engine.repository.Deployment;
import org.flowable.engine.repository.ProcessDefinition;
import org.flowable.form.api.FormDefinition;
import org.flowable.form.api.FormDeployment;
import org.flowable.form.api.FormRepositoryService;

/**
 * @author Tijs Rademakers
 */
<span class="nc" id="L55">public class BaseDynamicSubProcessInjectUtil {</span>
    
    public static void processFlowElements(CommandContext commandContext, FlowElementsContainer process, BpmnModel bpmnModel, 
                    ProcessDefinitionEntity originalProcessDefinitionEntity, DeploymentEntity newDeploymentEntity) {
        
<span class="nc bnc" id="L60" title="All 2 branches missed.">        for (FlowElement flowElement : process.getFlowElements()) {</span>

<span class="nc" id="L62">            processUserTask(flowElement, originalProcessDefinitionEntity, newDeploymentEntity, commandContext);</span>
<span class="nc" id="L63">            processDecisionTask(flowElement, originalProcessDefinitionEntity, newDeploymentEntity, commandContext);</span>
                
<span class="nc bnc" id="L65" title="All 2 branches missed.">            if (flowElement instanceof SubProcess) {</span>
<span class="nc" id="L66">                processFlowElements(commandContext, ((SubProcess) flowElement), bpmnModel, originalProcessDefinitionEntity, newDeploymentEntity);</span>
            }
<span class="nc" id="L68">        }</span>
<span class="nc" id="L69">    }</span>
    
    protected static void processSubProcessFlowElements(CommandContext commandContext, String prefix, Process process, BpmnModel bpmnModel, 
                    SubProcess subProcess, BpmnModel subProcessBpmnModel, ProcessDefinition originalProcessDefinition, 
                    DeploymentEntity newDeploymentEntity, Map&lt;String, FlowElement&gt; generatedIds, boolean includeDiInfo) {
        
<span class="nc" id="L75">        Collection&lt;FlowElement&gt; flowElementsOfSubProcess = subProcess.getFlowElementMap().values(); </span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">        for (FlowElement flowElement : flowElementsOfSubProcess) {</span>

<span class="nc bnc" id="L78" title="All 2 branches missed.">            if (process.getFlowElement(flowElement.getId(), true) != null) {</span>
<span class="nc" id="L79">                generateIdForDuplicateFlowElement(prefix, process, bpmnModel, subProcessBpmnModel, flowElement, generatedIds, includeDiInfo);</span>
            } else {
<span class="nc bnc" id="L81" title="All 2 branches missed.">                if (includeDiInfo) {</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">                    if (flowElement instanceof SequenceFlow) {</span>
<span class="nc" id="L83">                        List&lt;GraphicInfo&gt; wayPoints = subProcessBpmnModel.getFlowLocationGraphicInfo(flowElement.getId());</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">                        if (wayPoints != null) {</span>
<span class="nc" id="L85">                            bpmnModel.addFlowGraphicInfoList(flowElement.getId(), wayPoints);</span>
                        }
                        
<span class="nc" id="L88">                    } else {</span>
<span class="nc" id="L89">                        GraphicInfo graphicInfo = subProcessBpmnModel.getGraphicInfo(flowElement.getId());</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">                        if (graphicInfo != null) {</span>
<span class="nc" id="L91">                            bpmnModel.addGraphicInfo(flowElement.getId(), subProcessBpmnModel.getGraphicInfo(flowElement.getId()));</span>
                        }
                    }
                }
            }
            
<span class="nc" id="L97">            processUserTask(flowElement, originalProcessDefinition, newDeploymentEntity, commandContext);</span>
<span class="nc" id="L98">            processDecisionTask(flowElement, originalProcessDefinition, newDeploymentEntity, commandContext);</span>

<span class="nc bnc" id="L100" title="All 2 branches missed.">            if (flowElement instanceof SubProcess) {</span>
<span class="nc" id="L101">                processSubProcessFlowElements(commandContext, prefix, process, bpmnModel, (SubProcess) flowElement, </span>
                        subProcessBpmnModel, originalProcessDefinition, newDeploymentEntity, generatedIds, includeDiInfo);
            }
<span class="nc" id="L104">        }</span>
<span class="nc" id="L105">    }</span>
    
    protected static void generateIdForDuplicateFlowElement(String prefix, org.flowable.bpmn.model.Process process, BpmnModel bpmnModel, 
                    BpmnModel subProcessBpmnModel, FlowElement duplicateFlowElement, Map&lt;String, FlowElement&gt; generatedIds, boolean includeDiInfo) {
        
<span class="nc" id="L110">        String originalFlowElementId = duplicateFlowElement.getId();</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (process.getFlowElement(originalFlowElementId, true) != null) {</span>
<span class="nc" id="L112">            String newFlowElementId = prefix + &quot;-&quot; + originalFlowElementId;</span>
<span class="nc" id="L113">            int counter = 0;</span>
<span class="nc" id="L114">            boolean maxLengthReached = false;</span>
<span class="nc bnc" id="L115" title="All 4 branches missed.">            while (!maxLengthReached &amp;&amp; process.getFlowElement(newFlowElementId, true) != null) {</span>
<span class="nc" id="L116">                newFlowElementId = prefix + counter++ + &quot;-&quot; + originalFlowElementId;</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">                if (newFlowElementId.length() &gt; 255) {</span>
<span class="nc" id="L118">                    maxLengthReached = true;</span>
                }
            }

<span class="nc bnc" id="L122" title="All 2 branches missed.">            if (maxLengthReached) {</span>
<span class="nc" id="L123">                newFlowElementId = prefix + &quot;-&quot; + UUID.randomUUID();</span>
            }

<span class="nc" id="L126">            duplicateFlowElement.setId(newFlowElementId);</span>
<span class="nc" id="L127">            generatedIds.put(originalFlowElementId, duplicateFlowElement);</span>
            
<span class="nc bnc" id="L129" title="All 2 branches missed.">            if (includeDiInfo) {</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">                if (duplicateFlowElement instanceof SequenceFlow) {</span>
<span class="nc" id="L131">                    bpmnModel.addFlowGraphicInfoList(newFlowElementId, subProcessBpmnModel.getFlowLocationGraphicInfo(originalFlowElementId));</span>
                    
                } else {
<span class="nc" id="L134">                    bpmnModel.addGraphicInfo(newFlowElementId, subProcessBpmnModel.getGraphicInfo(originalFlowElementId));</span>
                }
            }

<span class="nc bnc" id="L138" title="All 2 branches missed.">            for (FlowElement flowElement : duplicateFlowElement.getParentContainer().getFlowElements()) {</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">                if (flowElement instanceof SequenceFlow) {</span>
<span class="nc" id="L140">                    SequenceFlow sequenceFlow = (SequenceFlow) flowElement; </span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">                    if (sequenceFlow.getSourceRef().equals(originalFlowElementId)) {</span>
<span class="nc" id="L142">                        sequenceFlow.setSourceRef(newFlowElementId);</span>
                    }
<span class="nc bnc" id="L144" title="All 2 branches missed.">                    if (sequenceFlow.getTargetRef().equals(originalFlowElementId)) {</span>
<span class="nc" id="L145">                        sequenceFlow.setTargetRef(newFlowElementId);</span>
                    }

<span class="nc bnc" id="L148" title="All 2 branches missed.">                } else if (flowElement instanceof BoundaryEvent) {</span>
<span class="nc" id="L149">                    BoundaryEvent boundaryEvent = (BoundaryEvent) flowElement;</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">                    if (boundaryEvent.getAttachedToRefId().equals(originalFlowElementId)) {</span>
<span class="nc" id="L151">                        boundaryEvent.setAttachedToRefId(newFlowElementId);</span>
                    }
<span class="nc bnc" id="L153" title="All 2 branches missed.">                    if (boundaryEvent.getEventDefinitions() != null </span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">                            &amp;&amp; boundaryEvent.getEventDefinitions().size() &gt; 0</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                            &amp;&amp; (boundaryEvent.getEventDefinitions().get(0) instanceof CompensateEventDefinition)) {</span>
                        
<span class="nc" id="L157">                        CompensateEventDefinition compensateEventDefinition = (CompensateEventDefinition) boundaryEvent.getEventDefinitions().get(0);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">                        if (compensateEventDefinition.getActivityRef().equals(originalFlowElementId)) {</span>
<span class="nc" id="L159">                            compensateEventDefinition.setActivityRef(newFlowElementId);</span>
                        }
                    }
                } 
<span class="nc" id="L163">            }</span>
            
            
        }

<span class="nc bnc" id="L168" title="All 2 branches missed.">        if (duplicateFlowElement instanceof FlowElementsContainer) {</span>
<span class="nc" id="L169">            FlowElementsContainer flowElementsContainer = (FlowElementsContainer) duplicateFlowElement;</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">            for (FlowElement childFlowElement : flowElementsContainer.getFlowElements()) {</span>
<span class="nc" id="L171">                generateIdForDuplicateFlowElement(prefix, process, bpmnModel, subProcessBpmnModel, childFlowElement, generatedIds, includeDiInfo);</span>
<span class="nc" id="L172">            }</span>
        }
<span class="nc" id="L174">    }</span>
    
    protected static void processUserTask(FlowElement flowElement, ProcessDefinition originalProcessDefinitionEntity, 
                    DeploymentEntity newDeploymentEntity, CommandContext commandContext) {
        
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (flowElement instanceof UserTask) {</span>
<span class="nc" id="L180">            FormRepositoryService formRepositoryService = CommandContextUtil.getFormRepositoryService();</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">            if (formRepositoryService != null) {</span>
<span class="nc" id="L182">                UserTask userTask = (UserTask) flowElement;</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">                if (StringUtils.isNotEmpty(userTask.getFormKey())) {</span>
<span class="nc" id="L184">                    Deployment deployment = CommandContextUtil.getDeploymentEntityManager().findById(originalProcessDefinitionEntity.getDeploymentId());</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">                    if (deployment.getParentDeploymentId() != null) {</span>
<span class="nc" id="L186">                        List&lt;FormDeployment&gt; formDeployments = formRepositoryService.createDeploymentQuery().parentDeploymentId(deployment.getParentDeploymentId()).list();</span>
                        
<span class="nc bnc" id="L188" title="All 4 branches missed.">                        if (formDeployments != null &amp;&amp; formDeployments.size() &gt; 0) {</span>
                        
<span class="nc" id="L190">                            FormDefinition formDefinition = formRepositoryService.createFormDefinitionQuery()</span>
<span class="nc" id="L191">                                    .formDefinitionKey(userTask.getFormKey()).deploymentId(formDeployments.get(0).getId()).latestVersion().singleResult();</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">                            if (formDefinition != null) {</span>
<span class="nc" id="L193">                                String name = formDefinition.getResourceName();</span>
<span class="nc" id="L194">                                InputStream inputStream = formRepositoryService.getFormDefinitionResource(formDefinition.getId());</span>
<span class="nc" id="L195">                                addResource(commandContext, newDeploymentEntity, name, IoUtil.readInputStream(inputStream, name));</span>
<span class="nc" id="L196">                                IoUtil.closeSilently(inputStream);</span>
                            }
                        }
                    }
                }
            }
        }
<span class="nc" id="L203">    }</span>
    
    protected static void processDecisionTask(FlowElement flowElement, ProcessDefinition originalProcessDefinitionEntity, 
                    DeploymentEntity newDeploymentEntity, CommandContext commandContext) {
        
<span class="nc bnc" id="L208" title="All 4 branches missed.">        if (flowElement instanceof ServiceTask &amp;&amp; ServiceTask.DMN_TASK.equals(((ServiceTask) flowElement).getType())) {</span>
                    
<span class="nc" id="L210">            DmnRepositoryService dmnRepositoryService = CommandContextUtil.getDmnRepositoryService();</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">            if (dmnRepositoryService != null) {</span>
<span class="nc" id="L212">                ServiceTask serviceTask = (ServiceTask) flowElement;</span>
<span class="nc bnc" id="L213" title="All 4 branches missed.">                if (serviceTask.getFieldExtensions() != null &amp;&amp; serviceTask.getFieldExtensions().size() &gt; 0) {</span>
<span class="nc" id="L214">                    String decisionTableReferenceKey = null;</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">                    for (FieldExtension fieldExtension : serviceTask.getFieldExtensions()) {</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">                        if (&quot;decisionTableReferenceKey&quot;.equals(fieldExtension.getFieldName())) {</span>
<span class="nc" id="L217">                            decisionTableReferenceKey = fieldExtension.getStringValue();</span>
<span class="nc" id="L218">                            break;</span>
                        }
<span class="nc" id="L220">                    }</span>
    
<span class="nc bnc" id="L222" title="All 2 branches missed.">                    if (decisionTableReferenceKey != null) {</span>
<span class="nc" id="L223">                        Deployment deployment = CommandContextUtil.getDeploymentEntityManager().findById(originalProcessDefinitionEntity.getDeploymentId());</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">                        if (deployment.getParentDeploymentId() != null) {</span>
<span class="nc" id="L225">                            List&lt;DmnDeployment&gt; dmnDeployments = dmnRepositoryService.createDeploymentQuery().parentDeploymentId(deployment.getParentDeploymentId()).list();</span>
                            
<span class="nc bnc" id="L227" title="All 4 branches missed.">                            if (dmnDeployments != null &amp;&amp; dmnDeployments.size() &gt; 0) {</span>
<span class="nc" id="L228">                                DmnDecision definition = dmnRepositoryService.createDecisionQuery()</span>
<span class="nc" id="L229">                                        .decisionKey(decisionTableReferenceKey).deploymentId(dmnDeployments.get(0).getId()).latestVersion().singleResult();</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">                                if (definition != null) {</span>
<span class="nc" id="L231">                                    String name = definition.getResourceName();</span>
<span class="nc" id="L232">                                    InputStream inputStream = dmnRepositoryService.getDmnResource(definition.getId());</span>
<span class="nc" id="L233">                                    addResource(commandContext, newDeploymentEntity, name, IoUtil.readInputStream(inputStream, name));</span>
<span class="nc" id="L234">                                    IoUtil.closeSilently(inputStream);</span>
                                }
                            }
                        }
                    }
                }
            }
        }
<span class="nc" id="L242">    }</span>
    
    public static void addResource(CommandContext commandContext, DeploymentEntity deploymentEntity, String resourceName, byte[] bytes) {
<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (!deploymentEntity.getResources().containsKey(resourceName)) { </span>
<span class="nc" id="L246">            ProcessEngineConfigurationImpl processEngineConfiguration = CommandContextUtil.getProcessEngineConfiguration(commandContext);</span>
<span class="nc" id="L247">            ResourceEntityManager resourceEntityManager = processEngineConfiguration.getResourceEntityManager();</span>
<span class="nc" id="L248">            ResourceEntity resourceEntity = resourceEntityManager.create();</span>
<span class="nc" id="L249">            resourceEntity.setDeploymentId(deploymentEntity.getId());</span>
<span class="nc" id="L250">            resourceEntity.setName(resourceName);</span>
<span class="nc" id="L251">            resourceEntity.setBytes(bytes);</span>
<span class="nc" id="L252">            resourceEntityManager.insert(resourceEntity);</span>
<span class="nc" id="L253">            deploymentEntity.addResource(resourceEntity);</span>
        }
<span class="nc" id="L255">    }</span>
    
    protected static List&lt;GraphicInfo&gt; createWayPoints(double x1, double y1, double x2, double y2) {
<span class="nc" id="L258">        List&lt;GraphicInfo&gt; wayPoints = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L259">        wayPoints.add(new GraphicInfo(x1, y1));</span>
<span class="nc" id="L260">        wayPoints.add(new GraphicInfo(x2, y2));</span>
        
<span class="nc" id="L262">        return wayPoints;</span>
    }
    
    protected static List&lt;GraphicInfo&gt; createWayPoints(double x1, double y1, double x2, double y2, double x3, double y3) {
<span class="nc" id="L266">        List&lt;GraphicInfo&gt; wayPoints = createWayPoints(x1, y1, x2, y2);</span>
<span class="nc" id="L267">        wayPoints.add(new GraphicInfo(x3, y3));</span>
        
<span class="nc" id="L269">        return wayPoints;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>