<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HistoricActivityInstanceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.history</a> &gt; <span class="el_source">HistoricActivityInstanceTest.java</span></div><h1>HistoricActivityInstanceTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.engine.test.history;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collections;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

import org.flowable.common.engine.api.FlowableIllegalArgumentException;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.common.engine.impl.util.CollectionUtil;
import org.flowable.engine.history.HistoricActivityInstance;
import org.flowable.engine.history.HistoricActivityInstanceQuery;
import org.flowable.engine.history.HistoricProcessInstance;
import org.flowable.engine.impl.test.HistoryTestHelper;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.runtime.Execution;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.junit.jupiter.api.Test;

/**
 * @author Tom Baeyens
 * @author Joram Barrez
 */
<span class="nc" id="L43">public class HistoricActivityInstanceTest extends PluggableFlowableTestCase {</span>

    @Test
    @Deployment
    public void testHistoricActivityInstanceNoop() {
<span class="nc" id="L48">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;noopProcess&quot;);</span>
        
<span class="nc" id="L50">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L52">        HistoricActivityInstance historicActivityInstance = historyService.createHistoricActivityInstanceQuery().activityId(&quot;noop&quot;).singleResult();</span>

<span class="nc" id="L54">        assertThat(historicActivityInstance.getActivityId()).isEqualTo(&quot;noop&quot;);</span>
<span class="nc" id="L55">        assertThat(historicActivityInstance.getActivityType()).isEqualTo(&quot;serviceTask&quot;);</span>
<span class="nc" id="L56">        assertThat(historicActivityInstance.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L57">        assertThat(historicActivityInstance.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L58">        assertThat(historicActivityInstance.getStartTime()).isNotNull();</span>
<span class="nc" id="L59">        assertThat(historicActivityInstance.getEndTime()).isNotNull();</span>
<span class="nc" id="L60">        assertThat(historicActivityInstance.getDurationInMillis()).isGreaterThanOrEqualTo(0);</span>
<span class="nc" id="L61">    }</span>
    
    @Test
    @Deployment
    public void testOneTaskProcessActivityTypes() {
<span class="nc" id="L66">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L67">                        .processDefinitionKey(&quot;oneTaskProcessActivityTypesProcess&quot;)</span>
<span class="nc" id="L68">                        .overrideProcessDefinitionTenantId(&quot;tenant1&quot;)</span>
<span class="nc" id="L69">                        .start();</span>
    
<span class="nc" id="L71">        Set&lt;String&gt; activityTypes = new HashSet&lt;&gt;();</span>
<span class="nc" id="L72">        activityTypes.add(&quot;startEvent&quot;);</span>

<span class="nc bnc" id="L74" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L75">            List&lt;HistoricActivityInstance&gt; historicActivityInstance = historyService.createHistoricActivityInstanceQuery().processInstanceId(processInstance.getId()).activityTypes(activityTypes).list();</span>
<span class="nc" id="L76">            assertThat(historicActivityInstance).hasSize(1);</span>
    
<span class="nc" id="L78">            activityTypes.add(&quot;userTask&quot;);</span>
<span class="nc" id="L79">            List&lt;HistoricActivityInstance&gt; historicActivityInstance2 = historyService.createHistoricActivityInstanceQuery().processInstanceId(processInstance.getId()).activityTypes(activityTypes).list();</span>
<span class="nc" id="L80">            assertThat(historicActivityInstance2).hasSize(2);</span>

<span class="nc" id="L82">            Calendar hourAgo = Calendar.getInstance();</span>
<span class="nc" id="L83">            hourAgo.add(Calendar.HOUR_OF_DAY, -1);</span>
<span class="nc" id="L84">            Calendar hourFromNow = Calendar.getInstance();</span>
<span class="nc" id="L85">            hourFromNow.add(Calendar.HOUR_OF_DAY, 1);</span>
    
            // Start/end dates
<span class="nc" id="L88">            assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).finishedBefore(hourAgo.getTime()).count()).isZero();</span>
<span class="nc" id="L89">            assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).finishedBefore(hourFromNow.getTime()).count()).isZero();</span>
<span class="nc" id="L90">            assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).finishedAfter(hourAgo.getTime()).count()).isZero();</span>
<span class="nc" id="L91">            assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).finishedAfter(hourFromNow.getTime()).count()).isZero();</span>
<span class="nc" id="L92">            assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).startedBefore(hourFromNow.getTime()).count()).isEqualTo(1);</span>
<span class="nc" id="L93">            assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).startedBefore(hourAgo.getTime()).count()).isZero();</span>
<span class="nc" id="L94">            assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).startedAfter(hourAgo.getTime()).count()).isEqualTo(1);</span>
<span class="nc" id="L95">            assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).startedAfter(hourFromNow.getTime()).count()).isZero();</span>
<span class="nc" id="L96">            assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).startedAfter(hourFromNow.getTime()).startedBefore(hourAgo.getTime()).count()).isZero();</span>
            
            // After finishing process
<span class="nc" id="L99">            taskService.complete(taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult().getId());</span>
            
<span class="nc" id="L101">            HistoryTestHelper.waitForJobExecutorToProcessAllHistoryJobs(processEngineConfiguration, managementService, 5000, 200);</span>
            
<span class="nc" id="L103">            assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).finished().count()).isEqualTo(1);</span>
<span class="nc" id="L104">            assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).finishedBefore(hourAgo.getTime()).count()).isZero();</span>
<span class="nc" id="L105">            assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).finishedBefore(hourFromNow.getTime()).count()).isEqualTo(1);</span>
<span class="nc" id="L106">            assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).finishedAfter(hourAgo.getTime()).count()).isEqualTo(1);</span>
<span class="nc" id="L107">            assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).finishedAfter(hourFromNow.getTime()).count()).isZero();</span>
<span class="nc" id="L108">            assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).finishedBefore(hourAgo.getTime()).finishedAfter(hourFromNow.getTime()).count()).isZero();</span>
        }
    
<span class="nc" id="L111">        ProcessInstance processInstance2 = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L112">                        .processDefinitionKey(&quot;oneTaskProcessActivityTypesProcess&quot;)</span>
<span class="nc" id="L113">                        .overrideProcessDefinitionTenantId(&quot;tenant1&quot;)</span>
<span class="nc" id="L114">                        .start();</span>
        
<span class="nc" id="L116">        taskService.complete(taskService.createTaskQuery().processInstanceId(processInstance2.getId()).singleResult().getId());</span>
        
<span class="nc" id="L118">        ProcessInstance otherTenantProcessInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L119">                        .processDefinitionKey(&quot;oneTaskProcessActivityTypesProcess&quot;)</span>
<span class="nc" id="L120">                        .overrideProcessDefinitionTenantId(&quot;tenant2&quot;)</span>
<span class="nc" id="L121">                        .start();</span>
        
<span class="nc" id="L123">        taskService.complete(taskService.createTaskQuery().processInstanceId(otherTenantProcessInstance.getId()).singleResult().getId());</span>
        
<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L126">            assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).finished().count()).isEqualTo(3);</span>
            
<span class="nc" id="L128">            List&lt;String&gt; tenantIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L129">            tenantIds.add(&quot;tenant1&quot;);</span>
<span class="nc" id="L130">            tenantIds.add(&quot;tenant2&quot;);</span>
<span class="nc" id="L131">            assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).finished().tenantIdIn(tenantIds).count()).isEqualTo(3);</span>
            
<span class="nc" id="L133">            assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).finished().tenantIdIn(Collections.singletonList(&quot;tenant1&quot;)).count()).isEqualTo(2);</span>
            
<span class="nc" id="L135">            assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).finished().tenantIdIn(Collections.singletonList(&quot;tenant2&quot;)).count()).isEqualTo(1);</span>
            
<span class="nc" id="L137">            assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).finished().tenantIdIn(Collections.singletonList(&quot;unexisting&quot;)).count()).isZero();</span>
        }
<span class="nc" id="L139">    }</span>

    @Test
    @Deployment
    public void testHistoricActivityInstanceReceive() {
<span class="nc" id="L144">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;receiveProcess&quot;);</span>
        
<span class="nc" id="L146">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L148">        HistoricActivityInstance historicActivityInstance = historyService.createHistoricActivityInstanceQuery().activityId(&quot;receive&quot;).singleResult();</span>
<span class="nc" id="L149">        assertActivityInstancesAreSame(historicActivityInstance, runtimeService.createActivityInstanceQuery().activityInstanceId(historicActivityInstance.getId()).singleResult());</span>

<span class="nc" id="L151">        assertThat(historicActivityInstance.getActivityId()).isEqualTo(&quot;receive&quot;);</span>
<span class="nc" id="L152">        assertThat(historicActivityInstance.getActivityType()).isEqualTo(&quot;receiveTask&quot;);</span>
<span class="nc" id="L153">        assertThat(historicActivityInstance.getEndTime()).isNull();</span>
<span class="nc" id="L154">        assertThat(historicActivityInstance.getDurationInMillis()).isNull();</span>
<span class="nc" id="L155">        assertThat(historicActivityInstance.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L156">        assertThat(historicActivityInstance.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L157">        assertThat(historicActivityInstance.getStartTime()).isNotNull();</span>

<span class="nc" id="L159">        Execution execution = runtimeService.createExecutionQuery().onlyChildExecutions().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L160">        runtimeService.trigger(execution.getId());</span>
        
<span class="nc" id="L162">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L164">        historicActivityInstance = historyService.createHistoricActivityInstanceQuery().activityId(&quot;receive&quot;).singleResult();</span>

<span class="nc" id="L166">        assertThat(historicActivityInstance.getActivityId()).isEqualTo(&quot;receive&quot;);</span>
<span class="nc" id="L167">        assertThat(historicActivityInstance.getActivityType()).isEqualTo(&quot;receiveTask&quot;);</span>
<span class="nc" id="L168">        assertThat(historicActivityInstance.getEndTime()).isNotNull();</span>
<span class="nc" id="L169">        assertThat(historicActivityInstance.getDurationInMillis()).isGreaterThanOrEqualTo(0);</span>
<span class="nc" id="L170">        assertThat(historicActivityInstance.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L171">        assertThat(historicActivityInstance.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L172">        assertThat(historicActivityInstance.getStartTime()).isNotNull();</span>
<span class="nc" id="L173">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/history/oneTaskProcess.bpmn20.xml&quot;)
    public void testHistoricActivityInstanceUnfinished() {
<span class="nc" id="L178">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L179">        assertThat(processInstance).isNotNull();</span>
        
<span class="nc" id="L181">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L183">        HistoricActivityInstanceQuery historicActivityInstanceQuery = historyService.createHistoricActivityInstanceQuery();</span>

<span class="nc" id="L185">        long finishedActivityInstanceCount = historicActivityInstanceQuery.finished().count();</span>
<span class="nc" id="L186">        assertThat(finishedActivityInstanceCount).as(&quot;The Start event and sequence flow are completed&quot;).isEqualTo(2);</span>

<span class="nc" id="L188">        long unfinishedActivityInstanceCount = historicActivityInstanceQuery.unfinished().count();</span>
<span class="nc" id="L189">        assertThat(unfinishedActivityInstanceCount).as(&quot;One active (unfinished) User org.flowable.task.service.Task&quot;).isEqualTo(1);</span>
<span class="nc" id="L190">    }</span>

    @Test
    @Deployment
    public void testHistoricActivityInstanceQuery() {
<span class="nc" id="L195">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;noopProcess&quot;);</span>
        
<span class="nc" id="L197">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L199">        assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;nonExistingActivityId&quot;).list()).isEmpty();</span>
<span class="nc" id="L200">        assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;noop&quot;).list()).hasSize(1);</span>

<span class="nc" id="L202">        assertThat(historyService.createHistoricActivityInstanceQuery().activityType(&quot;nonExistingActivityType&quot;).list()).isEmpty();</span>
<span class="nc" id="L203">        assertThat(historyService.createHistoricActivityInstanceQuery().activityType(&quot;serviceTask&quot;).list()).hasSize(1);</span>

<span class="nc" id="L205">        assertThat(historyService.createHistoricActivityInstanceQuery().activityName(&quot;nonExistingActivityName&quot;).list()).isEmpty();</span>
<span class="nc" id="L206">        assertThat(historyService.createHistoricActivityInstanceQuery().activityName(&quot;No operation&quot;).list()).hasSize(1);</span>

<span class="nc" id="L208">        assertThat(historyService.createHistoricActivityInstanceQuery().taskAssignee(&quot;nonExistingAssignee&quot;).list()).isEmpty();</span>

<span class="nc" id="L210">        assertThat(historyService.createHistoricActivityInstanceQuery().executionId(&quot;nonExistingExecutionId&quot;).list()).isEmpty();</span>

<span class="nc bnc" id="L212" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L213">            assertThat(historyService.createHistoricActivityInstanceQuery().processInstanceId(processInstance.getId()).list()).hasSize(5);</span>
        } else {
<span class="nc" id="L215">            assertThat(historyService.createHistoricActivityInstanceQuery().executionId(processInstance.getId()).list()).isEmpty();</span>
        }

<span class="nc" id="L218">        assertThat(historyService.createHistoricActivityInstanceQuery().processInstanceId(&quot;nonExistingProcessInstanceId&quot;).list()).isEmpty();</span>

<span class="nc bnc" id="L220" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L221">            assertThat(historyService.createHistoricActivityInstanceQuery().processInstanceId(processInstance.getId()).list()).hasSize(5);</span>
        } else {
<span class="nc" id="L223">            assertThat(historyService.createHistoricActivityInstanceQuery().processInstanceId(processInstance.getId()).list()).isEmpty();</span>
        }

<span class="nc" id="L226">        assertThat(historyService.createHistoricActivityInstanceQuery().processDefinitionId(&quot;nonExistingProcessDefinitionId&quot;).list()).isEmpty();</span>

<span class="nc bnc" id="L228" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L229">            assertThat(historyService.createHistoricActivityInstanceQuery().processDefinitionId(processInstance.getProcessDefinitionId()).list()).hasSize(5);</span>
        } else {
<span class="nc" id="L231">            assertThat(historyService.createHistoricActivityInstanceQuery().processDefinitionId(processInstance.getProcessDefinitionId()).list()).isEmpty();</span>
        }

<span class="nc" id="L234">        assertThat(historyService.createHistoricActivityInstanceQuery().unfinished().list()).isEmpty();</span>

<span class="nc bnc" id="L236" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L237">            assertThat(historyService.createHistoricActivityInstanceQuery().finished().list()).hasSize(5);</span>
        } else {
<span class="nc" id="L239">            assertThat(historyService.createHistoricActivityInstanceQuery().finished().list()).isEmpty();</span>
        }

<span class="nc bnc" id="L242" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L243">            HistoricActivityInstance historicActivityInstance = historyService.createHistoricActivityInstanceQuery().list().get(0);</span>
<span class="nc" id="L244">            assertThat(historyService.createHistoricActivityInstanceQuery().activityInstanceId(historicActivityInstance.getId()).list()).hasSize(1);</span>
        }
<span class="nc" id="L246">    }</span>

    @Test
    @Deployment
    public void testHistoricActivityInstanceForEventsQuery() {
<span class="nc" id="L251">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;eventProcess&quot;);</span>
<span class="nc" id="L252">        assertThat(taskService.createTaskQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L253">        runtimeService.signalEventReceived(&quot;signal&quot;);</span>
<span class="nc" id="L254">        assertProcessEnded(pi.getId());</span>
        
<span class="nc" id="L256">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L258">        assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;noop&quot;).list()).hasSize(1);</span>
<span class="nc" id="L259">        assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;userTask&quot;).list()).hasSize(1);</span>
<span class="nc" id="L260">        assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;intermediate-event&quot;).list()).hasSize(1);</span>
<span class="nc" id="L261">        assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;start&quot;).list()).hasSize(1);</span>
<span class="nc" id="L262">        assertThat(historyService.createHistoricActivityInstanceQuery().activityId(&quot;end&quot;).list()).hasSize(1);</span>

        // TODO: Discuss if boundary events will occur in the log! 
        // assertThat(
        // historyService.createHistoricActivityInstanceQuery().activityId(&quot;boundaryEvent&quot;).list()).hasSize(1);

<span class="nc" id="L268">        HistoricActivityInstance intermediateEvent = historyService.createHistoricActivityInstanceQuery().activityId(&quot;intermediate-event&quot;).singleResult();</span>
<span class="nc" id="L269">        assertThat(intermediateEvent.getStartTime()).isNotNull();</span>
<span class="nc" id="L270">        assertThat(intermediateEvent.getEndTime()).isNotNull();</span>

<span class="nc" id="L272">        HistoricActivityInstance startEvent = historyService.createHistoricActivityInstanceQuery().activityId(&quot;start&quot;).singleResult();</span>
<span class="nc" id="L273">        assertThat(startEvent.getStartTime()).isNotNull();</span>
<span class="nc" id="L274">        assertThat(startEvent.getEndTime()).isNotNull();</span>

<span class="nc" id="L276">        HistoricActivityInstance endEvent = historyService.createHistoricActivityInstanceQuery().activityId(&quot;end&quot;).singleResult();</span>
<span class="nc" id="L277">        assertThat(endEvent.getStartTime()).isNotNull();</span>
<span class="nc" id="L278">        assertThat(endEvent.getEndTime()).isNotNull();</span>
<span class="nc" id="L279">    }</span>

    @Test
    @Deployment
    public void testHistoricActivityInstanceProperties() {
        // Start process instance
<span class="nc" id="L285">        runtimeService.startProcessInstanceByKey(&quot;taskAssigneeProcess&quot;);</span>
        
<span class="nc" id="L287">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

        // Get task list
<span class="nc" id="L290">        HistoricActivityInstance historicActivityInstance = historyService.createHistoricActivityInstanceQuery().activityId(&quot;theTask&quot;).singleResult();</span>
<span class="nc" id="L291">        assertActivityInstancesAreSame(historicActivityInstance, runtimeService.createActivityInstanceQuery().activityInstanceId(historicActivityInstance.getId()).singleResult());</span>

<span class="nc" id="L293">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L294">        assertThat(historicActivityInstance.getTaskId()).isEqualTo(task.getId());</span>
<span class="nc" id="L295">        assertThat(historicActivityInstance.getAssignee()).isEqualTo(&quot;kermit&quot;);</span>
<span class="nc" id="L296">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/history/calledProcess.bpmn20.xml&quot;, &quot;org/flowable/engine/test/history/HistoricActivityInstanceTest.testCallSimpleSubProcess.bpmn20.xml&quot; })
    public void testHistoricActivityInstanceCalledProcessId() {
<span class="nc" id="L301">        runtimeService.startProcessInstanceByKey(&quot;callSimpleSubProcess&quot;);</span>
        
<span class="nc" id="L303">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L305">        HistoricActivityInstance historicActivityInstance = historyService.createHistoricActivityInstanceQuery().activityId(&quot;callSubProcess&quot;).singleResult();</span>

<span class="nc" id="L307">        HistoricProcessInstance oldInstance = historyService.createHistoricProcessInstanceQuery().processDefinitionKey(&quot;calledProcess&quot;).singleResult();</span>

<span class="nc" id="L309">        assertThat(historicActivityInstance.getCalledProcessInstanceId()).isEqualTo(oldInstance.getId());</span>
<span class="nc" id="L310">    }</span>

    @Test
    @Deployment
    public void testSorting() {
<span class="nc" id="L315">        runtimeService.startProcessInstanceByKey(&quot;process&quot;);</span>

        int expectedActivityInstances;
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration, 20000)) {</span>
<span class="nc" id="L319">            expectedActivityInstances = 3;</span>
        } else {
<span class="nc" id="L321">            expectedActivityInstances = 0;</span>
        }

<span class="nc" id="L324">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByHistoricActivityInstanceId().asc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L325">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByHistoricActivityInstanceStartTime().asc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L326">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByHistoricActivityInstanceEndTime().asc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L327">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByHistoricActivityInstanceDuration().asc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L328">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByExecutionId().asc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L329">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByProcessDefinitionId().asc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L330">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByProcessInstanceId().asc().list()).hasSize(expectedActivityInstances);</span>

<span class="nc" id="L332">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByHistoricActivityInstanceId().desc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L333">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByHistoricActivityInstanceStartTime().desc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L334">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByHistoricActivityInstanceEndTime().desc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L335">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByHistoricActivityInstanceDuration().desc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L336">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByExecutionId().desc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L337">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByProcessDefinitionId().desc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L338">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByProcessInstanceId().desc().list()).hasSize(expectedActivityInstances);</span>

<span class="nc" id="L340">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByHistoricActivityInstanceId().asc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L341">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByHistoricActivityInstanceStartTime().asc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L342">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByHistoricActivityInstanceEndTime().asc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L343">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByHistoricActivityInstanceDuration().asc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L344">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByExecutionId().asc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L345">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByProcessDefinitionId().asc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L346">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByProcessInstanceId().asc().count()).isEqualTo(expectedActivityInstances);</span>

<span class="nc" id="L348">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByHistoricActivityInstanceId().desc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L349">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByHistoricActivityInstanceStartTime().desc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L350">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByHistoricActivityInstanceEndTime().desc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L351">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByHistoricActivityInstanceDuration().desc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L352">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByExecutionId().desc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L353">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByProcessDefinitionId().desc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L354">        assertThat(historyService.createHistoricActivityInstanceQuery().orderByProcessInstanceId().desc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L355">    }</span>

    @Test
    public void testInvalidSorting() {
<span class="nc" id="L359">        assertThatThrownBy(() -&gt; historyService.createHistoricActivityInstanceQuery().asc().list())</span>
<span class="nc" id="L360">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>

<span class="nc" id="L362">        assertThatThrownBy(() -&gt; historyService.createHistoricActivityInstanceQuery().desc().list())</span>
<span class="nc" id="L363">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>

<span class="nc" id="L365">        assertThatThrownBy(() -&gt; historyService.createHistoricActivityInstanceQuery().orderByHistoricActivityInstanceDuration().list())</span>
<span class="nc" id="L366">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L367">    }</span>

    /**
     * Test to validate fix for ACT-1399: Boundary-event and event-based auditing
     */
    @Test
    @Deployment
    public void testBoundaryEvent() {
<span class="nc" id="L375">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;boundaryEventProcess&quot;);</span>
        // Complete the task with the boundary-event on it
<span class="nc" id="L377">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L378">        assertThat(task).isNotNull();</span>
<span class="nc" id="L379">        taskService.complete(task.getId());</span>

<span class="nc" id="L381">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).count()).isZero();</span>
        
<span class="nc" id="L383">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L385">        HistoricActivityInstance historicActivityInstance = historyService.createHistoricActivityInstanceQuery().activityId(&quot;boundary&quot;).processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L386">        assertThat(historicActivityInstance).isNotNull();</span>

        // Now check the history when the boundary-event is fired
<span class="nc" id="L389">        processInstance = runtimeService.startProcessInstanceByKey(&quot;boundaryEventProcess&quot;);</span>

<span class="nc" id="L391">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

<span class="nc" id="L393">        Execution signalExecution = runtimeService.createExecutionQuery().signalEventSubscriptionName(&quot;alert&quot;).singleResult();</span>
<span class="nc" id="L394">        runtimeService.signalEventReceived(&quot;alert&quot;, signalExecution.getId());</span>
<span class="nc" id="L395">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).count()).isZero();</span>
        
<span class="nc" id="L397">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L399">        historicActivityInstance = historyService.createHistoricActivityInstanceQuery().activityId(&quot;boundary&quot;).processInstanceId(processInstance.getId()).singleResult();</span>

<span class="nc" id="L401">        assertThat(historicActivityInstance).isNotNull();</span>
<span class="nc" id="L402">        assertThat(historicActivityInstance.getStartTime()).isNotNull();</span>
<span class="nc" id="L403">        assertThat(historicActivityInstance.getEndTime()).isNotNull();</span>
<span class="nc" id="L404">    }</span>

    /**
     * Test to validate fix for ACT-1399: Boundary-event and event-based auditing
     */
    @Test
    @Deployment
    public void testEventBasedGateway() {
<span class="nc" id="L412">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;catchSignal&quot;);</span>
<span class="nc" id="L413">        Execution waitingExecution = runtimeService.createExecutionQuery().signalEventSubscriptionName(&quot;alert&quot;).singleResult();</span>
<span class="nc" id="L414">        assertThat(waitingExecution).isNotNull();</span>
<span class="nc" id="L415">        runtimeService.signalEventReceived(&quot;alert&quot;, waitingExecution.getId());</span>

<span class="nc" id="L417">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).count()).isZero();</span>
        
<span class="nc" id="L419">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L421">        HistoricActivityInstance historicActivityInstance = historyService.createHistoricActivityInstanceQuery().activityId(&quot;eventBasedgateway&quot;).processInstanceId(processInstance.getId()).singleResult();</span>

<span class="nc" id="L423">        assertThat(historicActivityInstance).isNotNull();</span>
<span class="nc" id="L424">    }</span>

    /**
     * Test to validate fix for ACT-1549: endTime of joining parallel gateway is not set
     */
    @Test
    @Deployment
    public void testParallelJoinEndTime() {
<span class="nc" id="L432">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;forkJoin&quot;);</span>

<span class="nc" id="L434">        List&lt;org.flowable.task.api.Task&gt; tasksToComplete = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L435">        assertThat(tasksToComplete).hasSize(2);</span>

        // Complete both tasks, second task-complete should end the fork-gateway and set time
<span class="nc" id="L438">        taskService.complete(tasksToComplete.get(0).getId());</span>
<span class="nc" id="L439">        taskService.complete(tasksToComplete.get(1).getId());</span>
        
<span class="nc" id="L441">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L443">        List&lt;HistoricActivityInstance&gt; historicActivityInstance = historyService.createHistoricActivityInstanceQuery().activityId(&quot;join&quot;).processInstanceId(processInstance.getId()).list();</span>

        // History contains 2 entries for parallel join (one for each path
        // arriving in the join), should contain end-time
<span class="nc" id="L447">        assertThat(historicActivityInstance).hasSize(2);</span>
<span class="nc" id="L448">        assertThat(historicActivityInstance.get(0).getEndTime()).isNotNull();</span>
<span class="nc" id="L449">        assertThat(historicActivityInstance.get(1).getEndTime()).isNotNull();</span>
<span class="nc" id="L450">    }</span>

    @Test
    @Deployment
    public void testLoop() {
<span class="nc" id="L455">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;historic-activity-loops&quot;, CollectionUtil.singletonMap(&quot;input&quot;, 0));</span>

        // completing 10 user tasks
        // 15 service tasks should have passed

<span class="nc bnc" id="L460" title="All 2 branches missed.">        for (int i = 0; i &lt; 10; i++) {</span>
<span class="nc" id="L461">            org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L462">            Number inputNumber = (Number) taskService.getVariable(task.getId(), &quot;input&quot;);</span>
<span class="nc" id="L463">            int input = inputNumber.intValue();</span>
<span class="nc" id="L464">            assertThat(input).isEqualTo(i);</span>
<span class="nc" id="L465">            taskService.complete(task.getId(), CollectionUtil.singletonMap(&quot;input&quot;, input + 1));</span>
<span class="nc" id="L466">            task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
        }
        
<span class="nc" id="L469">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

        // Verify history
<span class="nc" id="L472">        List&lt;HistoricActivityInstance&gt; taskActivityInstances = historyService.createHistoricActivityInstanceQuery().activityType(&quot;userTask&quot;).list();</span>
<span class="nc" id="L473">        assertThat(taskActivityInstances).hasSize(10);</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">        for (HistoricActivityInstance historicActivityInstance : taskActivityInstances) {</span>
<span class="nc" id="L475">            assertThat(historicActivityInstance.getStartTime()).isNotNull();</span>
<span class="nc" id="L476">            assertThat(historicActivityInstance.getEndTime()).isNotNull();</span>
<span class="nc" id="L477">        }</span>

<span class="nc" id="L479">        List&lt;HistoricActivityInstance&gt; serviceTaskInstances = historyService.createHistoricActivityInstanceQuery().activityType(&quot;serviceTask&quot;).list();</span>
<span class="nc" id="L480">        assertThat(serviceTaskInstances).hasSize(15);</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">        for (HistoricActivityInstance historicActivityInstance : serviceTaskInstances) {</span>
<span class="nc" id="L482">            assertThat(historicActivityInstance.getStartTime()).isNotNull();</span>
<span class="nc" id="L483">            assertThat(historicActivityInstance.getEndTime()).isNotNull();</span>
<span class="nc" id="L484">        }</span>
<span class="nc" id="L485">    }</span>

    @Test
    @Deployment(
        resources = {
            &quot;org/flowable/engine/test/api/runtime/callActivity.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/runtime/calledActivity.bpmn20.xml&quot;
        }
    )
    public void callSubProcess() {
<span class="nc" id="L495">        ProcessInstance pi = this.runtimeService.startProcessInstanceByKey(&quot;callActivity&quot;);</span>

<span class="nc bnc" id="L497" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L498">            HistoricActivityInstance callSubProcessActivityInstance = historyService.createHistoricActivityInstanceQuery().processInstanceId(pi.getId())</span>
<span class="nc" id="L499">                .activityId(&quot;callSubProcess&quot;).singleResult();</span>
<span class="nc" id="L500">            assertThat(callSubProcessActivityInstance.getCalledProcessInstanceId()).isEqualTo(</span>
<span class="nc" id="L501">                runtimeService.createProcessInstanceQuery().superProcessInstanceId(pi.getId()).singleResult().getId());</span>
        }
<span class="nc" id="L503">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>