<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HistoricVariableInstanceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.history</a> &gt; <span class="el_source">HistoricVariableInstanceTest.java</span></div><h1>HistoricVariableInstanceTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.engine.test.history;

import static org.assertj.core.api.Assertions.assertThat;

import java.util.Arrays;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.common.engine.impl.util.CollectionUtil;
import org.flowable.engine.history.HistoricActivityInstance;
import org.flowable.engine.history.HistoricDetail;
import org.flowable.engine.history.HistoricVariableUpdate;
import org.flowable.engine.impl.test.HistoryTestHelper;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.runtime.Execution;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.task.api.Task;
import org.flowable.task.api.TaskQuery;
import org.flowable.variable.api.history.HistoricVariableInstance;
import org.flowable.variable.service.impl.persistence.entity.HistoricVariableInstanceEntity;
import org.junit.jupiter.api.Test;

/**
 * @author Joram Barrez
 */
<span class="nc" id="L44">public class HistoricVariableInstanceTest extends PluggableFlowableTestCase {</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/examples/bpmn/callactivity/orderProcess.bpmn20.xml&quot;, &quot;org/flowable/examples/bpmn/callactivity/checkCreditProcess.bpmn20.xml&quot; })
    public void testOrderProcessWithCallActivity() {
<span class="nc bnc" id="L49" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>
            // After the process has started, the 'verify credit history' task should be active
<span class="nc" id="L51">            ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;orderProcess&quot;);</span>
<span class="nc" id="L52">            TaskQuery taskQuery = taskService.createTaskQuery();</span>
<span class="nc" id="L53">            org.flowable.task.api.Task verifyCreditTask = taskQuery.singleResult();</span>
<span class="nc" id="L54">            assertThat(verifyCreditTask.getName()).isEqualTo(&quot;Verify credit history&quot;);</span>

            // Verify with Query API
<span class="nc" id="L57">            ProcessInstance subProcessInstance = runtimeService.createProcessInstanceQuery().superProcessInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L58">            assertThat(subProcessInstance).isNotNull();</span>
<span class="nc" id="L59">            assertThat(runtimeService.createProcessInstanceQuery().subProcessInstanceId(subProcessInstance.getId()).singleResult().getId()).isEqualTo(pi.getId());</span>

            // Completing the task with approval, will end the subprocess and continue the original process
<span class="nc" id="L62">            taskService.complete(verifyCreditTask.getId(), CollectionUtil.singletonMap(&quot;creditApproved&quot;, true));</span>
<span class="nc" id="L63">            org.flowable.task.api.Task prepareAndShipTask = taskQuery.singleResult();</span>
<span class="nc" id="L64">            assertThat(prepareAndShipTask.getName()).isEqualTo(&quot;Prepare and Ship&quot;);</span>
        }
<span class="nc" id="L66">    }</span>

    @Test
    @Deployment
    public void testSimple() {
<span class="nc bnc" id="L71" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>
<span class="nc" id="L72">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;myProc&quot;);</span>
<span class="nc" id="L73">            TaskQuery taskQuery = taskService.createTaskQuery();</span>
<span class="nc" id="L74">            org.flowable.task.api.Task userTask = taskQuery.singleResult();</span>
<span class="nc" id="L75">            assertThat(userTask.getName()).isEqualTo(&quot;userTask1&quot;);</span>

<span class="nc" id="L77">            taskService.complete(userTask.getId(), CollectionUtil.singletonMap(&quot;myVar&quot;, &quot;test789&quot;));</span>

<span class="nc" id="L79">            assertProcessEnded(processInstance.getId());</span>
            
<span class="nc" id="L81">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L83">            List&lt;HistoricVariableInstance&gt; variables = historyService.createHistoricVariableInstanceQuery().list();</span>
<span class="nc" id="L84">            assertThat(variables).hasSize(1);</span>

<span class="nc" id="L86">            HistoricVariableInstanceEntity historicVariable = (HistoricVariableInstanceEntity) variables.get(0);</span>
<span class="nc" id="L87">            assertThat(historicVariable.getTextValue()).isEqualTo(&quot;test456&quot;);</span>

<span class="nc" id="L89">            assertThat(historyService.createHistoricActivityInstanceQuery().count()).isEqualTo(9);</span>
<span class="nc" id="L90">            assertThat(historyService.createHistoricDetailQuery().count()).isEqualTo(3);</span>
        }
<span class="nc" id="L92">    }</span>

    @Test
    @Deployment
    public void testSimpleNoWaitState() {
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>
<span class="nc" id="L98">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;myProc&quot;);</span>
<span class="nc" id="L99">            assertProcessEnded(processInstance.getId());</span>
            
<span class="nc" id="L101">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L103">            List&lt;HistoricVariableInstance&gt; variables = historyService.createHistoricVariableInstanceQuery().list();</span>
<span class="nc" id="L104">            assertThat(variables).hasSize(1);</span>

<span class="nc" id="L106">            HistoricVariableInstanceEntity historicVariable = (HistoricVariableInstanceEntity) variables.get(0);</span>
<span class="nc" id="L107">            assertThat(historicVariable.getTextValue()).isEqualTo(&quot;test456&quot;);</span>

<span class="nc" id="L109">            assertThat(historyService.createHistoricActivityInstanceQuery().count()).isEqualTo(7);</span>
<span class="nc" id="L110">            assertThat(historyService.createHistoricDetailQuery().count()).isEqualTo(2);</span>
        }
<span class="nc" id="L112">    }</span>

    @Test
    @Deployment
    public void testParallel() {
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>
<span class="nc" id="L118">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;myProc&quot;);</span>
<span class="nc" id="L119">            TaskQuery taskQuery = taskService.createTaskQuery();</span>
<span class="nc" id="L120">            org.flowable.task.api.Task userTask = taskQuery.singleResult();</span>
<span class="nc" id="L121">            assertThat(userTask.getName()).isEqualTo(&quot;userTask1&quot;);</span>

<span class="nc" id="L123">            taskService.complete(userTask.getId(), CollectionUtil.singletonMap(&quot;myVar&quot;, &quot;test789&quot;));</span>

<span class="nc" id="L125">            assertProcessEnded(processInstance.getId());</span>
            
<span class="nc" id="L127">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L129">            List&lt;HistoricVariableInstance&gt; variables = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L130">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L131">                    .orderByVariableName().asc()</span>
<span class="nc" id="L132">                    .list();</span>
<span class="nc" id="L133">            assertThat(variables).hasSize(2);</span>

<span class="nc" id="L135">            HistoricVariableInstanceEntity historicVariable = (HistoricVariableInstanceEntity) variables.get(0);</span>
<span class="nc" id="L136">            assertThat(historicVariable.getName()).isEqualTo(&quot;myVar&quot;);</span>
<span class="nc" id="L137">            assertThat(historicVariable.getTextValue()).isEqualTo(&quot;test789&quot;);</span>

<span class="nc" id="L139">            HistoricVariableInstanceEntity historicVariable1 = (HistoricVariableInstanceEntity) variables.get(1);</span>
<span class="nc" id="L140">            assertThat(historicVariable1.getName()).isEqualTo(&quot;myVar1&quot;);</span>
<span class="nc" id="L141">            assertThat(historicVariable1.getTextValue()).isEqualTo(&quot;test456&quot;);</span>

<span class="nc" id="L143">            assertThat(historyService.createHistoricActivityInstanceQuery().count()).isEqualTo(15);</span>
<span class="nc" id="L144">            assertThat(historyService.createHistoricDetailQuery().count()).isEqualTo(5);</span>
        }
<span class="nc" id="L146">    }</span>

    @Test
    @Deployment
    public void testParallelNoWaitState() {
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>
<span class="nc" id="L152">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;myProc&quot;);</span>
<span class="nc" id="L153">            assertProcessEnded(processInstance.getId());</span>
            
<span class="nc" id="L155">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L157">            List&lt;HistoricVariableInstance&gt; variables = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L158">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L159">                    .list();</span>
<span class="nc" id="L160">            assertThat(variables).hasSize(1);</span>

<span class="nc" id="L162">            HistoricVariableInstanceEntity historicVariable = (HistoricVariableInstanceEntity) variables.get(0);</span>
<span class="nc" id="L163">            assertThat(historicVariable.getTextValue()).isEqualTo(&quot;test456&quot;);</span>

<span class="nc" id="L165">            assertThat(historyService.createHistoricActivityInstanceQuery().count()).isEqualTo(13);</span>
<span class="nc" id="L166">            assertThat(historyService.createHistoricDetailQuery().count()).isEqualTo(2);</span>
        }
<span class="nc" id="L168">    }</span>

    @Test
    @Deployment
    public void testTwoSubProcessInParallelWithinSubProcess() {
<span class="nc bnc" id="L173" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>
<span class="nc" id="L174">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;twoSubProcessInParallelWithinSubProcess&quot;);</span>
<span class="nc" id="L175">            assertProcessEnded(processInstance.getId());</span>
            
<span class="nc" id="L177">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L179">            List&lt;HistoricVariableInstance&gt; variables = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L180">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L181">                    .orderByVariableName().asc().list();</span>
<span class="nc" id="L182">            assertThat(variables).hasSize(2);</span>

<span class="nc" id="L184">            HistoricVariableInstanceEntity historicVariable = (HistoricVariableInstanceEntity) variables.get(0);</span>
<span class="nc" id="L185">            assertThat(historicVariable.getName()).isEqualTo(&quot;myVar&quot;);</span>
<span class="nc" id="L186">            assertThat(historicVariable.getTextValue()).isEqualTo(&quot;test101112&quot;);</span>

<span class="nc" id="L188">            HistoricVariableInstanceEntity historicVariable1 = (HistoricVariableInstanceEntity) variables.get(1);</span>
<span class="nc" id="L189">            assertThat(historicVariable1.getName()).isEqualTo(&quot;myVar1&quot;);</span>
<span class="nc" id="L190">            assertThat(historicVariable1.getTextValue()).isEqualTo(&quot;test789&quot;);</span>

<span class="nc" id="L192">            assertThat(historyService.createHistoricActivityInstanceQuery().count()).isEqualTo(32);</span>
<span class="nc" id="L193">            assertThat(historyService.createHistoricDetailQuery().count()).isEqualTo(7);</span>
        }
<span class="nc" id="L195">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/history/HistoricVariableInstanceTest.testCallSimpleSubProcess.bpmn20.xml&quot;, &quot;org/flowable/engine/test/history/simpleSubProcess.bpmn20.xml&quot; })
    public void testHistoricVariableInstanceQuery() {
<span class="nc bnc" id="L200" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>
<span class="nc" id="L201">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;callSimpleSubProcess&quot;);</span>
<span class="nc" id="L202">            assertProcessEnded(processInstance.getId());</span>
            
<span class="nc" id="L204">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L206">            assertThat(historyService.createHistoricVariableInstanceQuery().count()).isEqualTo(4);</span>
<span class="nc" id="L207">            assertThat(historyService.createHistoricVariableInstanceQuery().list()).hasSize(4);</span>
<span class="nc" id="L208">            assertThat(historyService.createHistoricVariableInstanceQuery().orderByProcessInstanceId().asc().count()).isEqualTo(4);</span>
<span class="nc" id="L209">            assertThat(historyService.createHistoricVariableInstanceQuery().orderByProcessInstanceId().asc().list()).hasSize(4);</span>
<span class="nc" id="L210">            assertThat(historyService.createHistoricVariableInstanceQuery().orderByVariableName().asc().count()).isEqualTo(4);</span>
<span class="nc" id="L211">            assertThat(historyService.createHistoricVariableInstanceQuery().orderByVariableName().asc().list()).hasSize(4);</span>

<span class="nc" id="L213">            assertThat(historyService.createHistoricVariableInstanceQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(2);</span>
<span class="nc" id="L214">            assertThat(historyService.createHistoricVariableInstanceQuery().processInstanceId(processInstance.getId()).list()).hasSize(2);</span>
<span class="nc" id="L215">            assertThat(historyService.createHistoricVariableInstanceQuery().variableName(&quot;myVar&quot;).count()).isEqualTo(2);</span>
<span class="nc" id="L216">            assertThat(historyService.createHistoricVariableInstanceQuery().variableName(&quot;myVar&quot;).list()).hasSize(2);</span>
<span class="nc" id="L217">            assertThat(historyService.createHistoricVariableInstanceQuery().variableNameLike(&quot;myVar1&quot;).count()).isEqualTo(2);</span>
<span class="nc" id="L218">            assertThat(historyService.createHistoricVariableInstanceQuery().variableNameLike(&quot;myVar1&quot;).list()).hasSize(2);</span>

<span class="nc" id="L220">            List&lt;HistoricVariableInstance&gt; variables = historyService.createHistoricVariableInstanceQuery().list();</span>
<span class="nc" id="L221">            assertThat(variables).hasSize(4);</span>

<span class="nc" id="L223">            assertThat(historyService.createHistoricVariableInstanceQuery().variableValueEquals(&quot;myVar&quot;, &quot;test123&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L224">            assertThat(historyService.createHistoricVariableInstanceQuery().variableValueEquals(&quot;myVar&quot;, &quot;test123&quot;).list()).hasSize(1);</span>
<span class="nc" id="L225">            assertThat(historyService.createHistoricVariableInstanceQuery().variableValueEquals(&quot;myVar1&quot;, &quot;test456&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L226">            assertThat(historyService.createHistoricVariableInstanceQuery().variableValueEquals(&quot;myVar1&quot;, &quot;test456&quot;).list()).hasSize(1);</span>
<span class="nc" id="L227">            assertThat(historyService.createHistoricVariableInstanceQuery().variableValueEquals(&quot;myVar&quot;, &quot;test666&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L228">            assertThat(historyService.createHistoricVariableInstanceQuery().variableValueEquals(&quot;myVar&quot;, &quot;test666&quot;).list()).hasSize(1);</span>
<span class="nc" id="L229">            assertThat(historyService.createHistoricVariableInstanceQuery().variableValueEquals(&quot;myVar1&quot;, &quot;test666&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L230">            assertThat(historyService.createHistoricVariableInstanceQuery().variableValueEquals(&quot;myVar1&quot;, &quot;test666&quot;).list()).hasSize(1);</span>

<span class="nc" id="L232">            assertThat(historyService.createHistoricActivityInstanceQuery().count()).isEqualTo(14);</span>
<span class="nc" id="L233">            assertThat(historyService.createHistoricDetailQuery().count()).isEqualTo(5);</span>
        }
<span class="nc" id="L235">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/history/HistoricVariableInstanceTest.testCallActivityAndTask.bpmn20.xml&quot; })
    public void testVariableInstanceQueryExcludeLocalVariables() {
<span class="nc" id="L240">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;callActivityAndTask&quot;);</span>

<span class="nc" id="L242">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L243">        taskService.setVariable(task.getId(), &quot;var1&quot;, &quot;test1&quot;);</span>
<span class="nc" id="L244">        taskService.setVariableLocal(task.getId(), &quot;varLocal1&quot;, &quot;test2&quot;);</span>

<span class="nc" id="L246">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L248">        List&lt;HistoricVariableInstance&gt; vars = historyService.createHistoricVariableInstanceQuery().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L249">                .excludeLocalVariables().list();</span>

<span class="nc" id="L251">        assertThat(vars.size()).isEqualTo(1);</span>
<span class="nc" id="L252">        assertThat(vars.get(0).getValue()).isEqualTo(&quot;test1&quot;);</span>

<span class="nc" id="L254">        taskService.complete(task.getId());</span>

<span class="nc" id="L256">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L258">        Execution subProcessExecution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).activityId(&quot;mySubProcess&quot;)</span>
<span class="nc" id="L259">                .singleResult();</span>

<span class="nc" id="L261">        runtimeService.setVariable(subProcessExecution.getId(), &quot;var2&quot;, &quot;test3&quot;);</span>
<span class="nc" id="L262">        runtimeService.setVariableLocal(subProcessExecution.getId(), &quot;varLocal2&quot;, &quot;test4&quot;);</span>

<span class="nc" id="L264">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L265">        taskService.setVariable(task.getId(), &quot;var3&quot;, &quot;test5&quot;);</span>
<span class="nc" id="L266">        taskService.setVariableLocal(task.getId(), &quot;varLocal3&quot;, &quot;test6&quot;);</span>

<span class="nc" id="L268">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L270">        vars = historyService.createHistoricVariableInstanceQuery().processInstanceId(processInstance.getId()).excludeLocalVariables().list();</span>

<span class="nc" id="L272">        assertThat(vars.size()).isEqualTo(3);</span>
<span class="nc" id="L273">        assertThat(vars).extracting(HistoricVariableInstance::getValue).containsExactlyInAnyOrder(&quot;test1&quot;, &quot;test3&quot;, &quot;test5&quot;);</span>
<span class="nc" id="L274">    }</span>

    @Test
    public void testHistoricVariableQuery2() {
<span class="nc" id="L278">        deployTwoTasksTestProcess();</span>
        
        // Generate data
<span class="nc" id="L281">        Map&lt;String, Object&gt; startVars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L282">        startVars.put(&quot;startVar&quot;, &quot;hello&quot;);</span>
<span class="nc" id="L283">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;twoTasksProcess&quot;, startVars).getId();</span>
<span class="nc" id="L284">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstanceId).list();</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">        for (int i = 0; i &lt; tasks.size(); i++) {</span>
<span class="nc" id="L286">            runtimeService.setVariableLocal(tasks.get(i).getExecutionId(), &quot;executionVar&quot; + i, i);</span>
<span class="nc" id="L287">            taskService.setVariableLocal(tasks.get(i).getId(), &quot;taskVar&quot; + i, i);</span>
        }
        
<span class="nc" id="L290">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

        // Verify historic variable instance queries
<span class="nc" id="L293">        List&lt;HistoricVariableInstance&gt; historicVariableInstances = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L294">                .processInstanceId(processInstanceId).orderByVariableName().asc().list();</span>
<span class="nc" id="L295">        assertThat(historicVariableInstances).hasSize(5);</span>

<span class="nc" id="L297">        List&lt;String&gt; expectedVariableNames = Arrays.asList(&quot;executionVar0&quot;, &quot;executionVar1&quot;, &quot;startVar&quot;, &quot;taskVar0&quot;, &quot;taskVar1&quot;);</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">        for (int i = 0; i &lt; expectedVariableNames.size(); i++) {</span>
<span class="nc" id="L299">            assertThat(historicVariableInstances.get(i).getVariableName()).isEqualTo(expectedVariableNames.get(i));</span>
        }

        // by execution id
<span class="nc" id="L303">        historicVariableInstances = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L304">                .executionId(tasks.get(0).getExecutionId()).orderByVariableName().asc().list();</span>
<span class="nc" id="L305">        assertThat(historicVariableInstances).hasSize(2);</span>
<span class="nc" id="L306">        assertThat(historicVariableInstances.get(0).getVariableName()).isEqualTo(&quot;executionVar0&quot;);</span>
<span class="nc" id="L307">        assertThat(historicVariableInstances.get(1).getVariableName()).isEqualTo(&quot;taskVar0&quot;);</span>
<span class="nc" id="L308">        historicVariableInstances = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L309">                .executionId(tasks.get(1).getExecutionId()).orderByVariableName().asc().list();</span>
<span class="nc" id="L310">        assertThat(historicVariableInstances).hasSize(2);</span>
<span class="nc" id="L311">        assertThat(historicVariableInstances.get(0).getVariableName()).isEqualTo(&quot;executionVar1&quot;);</span>
<span class="nc" id="L312">        assertThat(historicVariableInstances.get(1).getVariableName()).isEqualTo(&quot;taskVar1&quot;);</span>

        // By process instance id and execution id
<span class="nc" id="L315">        historicVariableInstances = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L316">                .processInstanceId(processInstanceId).executionId(tasks.get(0).getExecutionId()).orderByVariableName().asc().list();</span>
<span class="nc" id="L317">        assertThat(historicVariableInstances).hasSize(2);</span>
<span class="nc" id="L318">        assertThat(historicVariableInstances.get(0).getVariableName()).isEqualTo(&quot;executionVar0&quot;);</span>
<span class="nc" id="L319">        assertThat(historicVariableInstances.get(1).getVariableName()).isEqualTo(&quot;taskVar0&quot;);</span>
<span class="nc" id="L320">        historicVariableInstances = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L321">                .processInstanceId(processInstanceId).executionId(tasks.get(1).getExecutionId()).orderByVariableName().asc().list();</span>
<span class="nc" id="L322">        assertThat(historicVariableInstances).hasSize(2);</span>
<span class="nc" id="L323">        assertThat(historicVariableInstances.get(0).getVariableName()).isEqualTo(&quot;executionVar1&quot;);</span>
<span class="nc" id="L324">        assertThat(historicVariableInstances.get(1).getVariableName()).isEqualTo(&quot;taskVar1&quot;);</span>

        // By task id
<span class="nc" id="L327">        historicVariableInstances = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L328">                .taskId(tasks.get(0).getId()).list();</span>
<span class="nc" id="L329">        assertThat(historicVariableInstances).hasSize(1);</span>
<span class="nc" id="L330">        assertThat(historicVariableInstances.get(0).getVariableName()).isEqualTo(&quot;taskVar0&quot;);</span>
<span class="nc" id="L331">        historicVariableInstances = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L332">                .taskId(tasks.get(1).getId()).list();</span>
<span class="nc" id="L333">        assertThat(historicVariableInstances).hasSize(1);</span>
<span class="nc" id="L334">        assertThat(historicVariableInstances.get(0).getVariableName()).isEqualTo(&quot;taskVar1&quot;);</span>

        // By task id and process instance id
<span class="nc" id="L337">        historicVariableInstances = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L338">                .processInstanceId(processInstanceId).taskId(tasks.get(0).getId()).list();</span>
<span class="nc" id="L339">        assertThat(historicVariableInstances).hasSize(1);</span>
<span class="nc" id="L340">        assertThat(historicVariableInstances.get(0).getVariableName()).isEqualTo(&quot;taskVar0&quot;);</span>
<span class="nc" id="L341">        historicVariableInstances = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L342">                .processInstanceId(processInstanceId).taskId(tasks.get(1).getId()).list();</span>
<span class="nc" id="L343">        assertThat(historicVariableInstances).hasSize(1);</span>
<span class="nc" id="L344">        assertThat(historicVariableInstances.get(0).getVariableName()).isEqualTo(&quot;taskVar1&quot;);</span>

<span class="nc" id="L346">    }</span>

    @Test
    public void testHistoricVariableQueryByExecutionIds() {
<span class="nc" id="L350">        deployTwoTasksTestProcess();</span>

<span class="nc" id="L352">        Set&lt;String&gt; processInstanceIds = new HashSet&lt;&gt;();</span>
<span class="nc" id="L353">        Set&lt;String&gt; testProcessInstanceIds = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">        for (int i = 0; i &lt; 3; i++) {</span>
            // Generate data
<span class="nc" id="L356">            Map&lt;String, Object&gt; startVars = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">            if (i == 1) {</span>
<span class="nc" id="L358">                startVars.put(&quot;startVar2&quot;, &quot;hello2&quot;);</span>
            } else {
<span class="nc" id="L360">                startVars.put(&quot;startVar&quot;, &quot;hello&quot;);</span>
            }
<span class="nc" id="L362">            String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;twoTasksProcess&quot;, startVars).getId();</span>
<span class="nc" id="L363">            processInstanceIds.add(processInstanceId);</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">            if (i != 1) {</span>
<span class="nc" id="L365">                testProcessInstanceIds.add(processInstanceId);</span>
            }
        }
        
<span class="nc" id="L369">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L371">        assertThat(historyService.createHistoricVariableInstanceQuery().executionIds(testProcessInstanceIds).count()).isEqualTo(2);</span>
<span class="nc" id="L372">        assertThat(historyService.createHistoricVariableInstanceQuery().executionIds(testProcessInstanceIds).list()).hasSize(2);</span>

<span class="nc" id="L374">        List&lt;HistoricVariableInstance&gt; historicVariableInstances = historyService.createHistoricVariableInstanceQuery().executionIds(testProcessInstanceIds).list();</span>
<span class="nc" id="L375">        assertThat(historicVariableInstances.get(0).getVariableName()).isEqualTo(&quot;startVar&quot;);</span>
<span class="nc" id="L376">        assertThat(historicVariableInstances.get(0).getValue()).isEqualTo(&quot;hello&quot;);</span>

<span class="nc" id="L378">        historicVariableInstances = historyService.createHistoricVariableInstanceQuery().executionIds(processInstanceIds).list();</span>
<span class="nc" id="L379">        int startVarCount = 0;</span>
<span class="nc" id="L380">        int startVar2Count = 0;</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">        for (HistoricVariableInstance historicVariableInstance : historicVariableInstances) {</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">            if (&quot;startVar&quot;.equals(historicVariableInstance.getVariableName())) {</span>
<span class="nc" id="L383">                startVarCount++;</span>
<span class="nc" id="L384">                assertThat(historicVariableInstance.getValue()).isEqualTo(&quot;hello&quot;);</span>
            
<span class="nc bnc" id="L386" title="All 2 branches missed.">            } else if (&quot;startVar2&quot;.equals(historicVariableInstance.getVariableName())) {</span>
<span class="nc" id="L387">                startVar2Count++;</span>
<span class="nc" id="L388">                assertThat(historicVariableInstance.getValue()).isEqualTo(&quot;hello2&quot;);</span>
            }
<span class="nc" id="L390">        }</span>
        
<span class="nc" id="L392">        assertThat(startVarCount).isEqualTo(2);</span>
<span class="nc" id="L393">        assertThat(startVar2Count).isEqualTo(1);</span>
<span class="nc" id="L394">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/variableScope.bpmn20.xml&quot;
    })
    public void testHistoricVariableQueryByExecutionIdsForScope() {
<span class="nc" id="L401">        Map&lt;String, Object&gt; processVars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L402">        processVars.put(&quot;processVar&quot;, &quot;processVar&quot;);</span>
<span class="nc" id="L403">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;variableScopeProcess&quot;, processVars);</span>

<span class="nc" id="L405">        Set&lt;String&gt; executionIds = new HashSet&lt;&gt;();</span>
<span class="nc" id="L406">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">        for (Execution execution : executions) {</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">            if (!processInstance.getId().equals(execution.getId())) {</span>
<span class="nc" id="L409">                executionIds.add(execution.getId());</span>
<span class="nc" id="L410">                runtimeService.setVariableLocal(execution.getId(), &quot;executionVar&quot;, &quot;executionVar&quot;);</span>
            }
<span class="nc" id="L412">        }</span>

<span class="nc" id="L414">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">        for (org.flowable.task.api.Task task : tasks) {</span>
<span class="nc" id="L416">            taskService.setVariableLocal(task.getId(), &quot;taskVar&quot;, &quot;taskVar&quot;);</span>
<span class="nc" id="L417">        }</span>
        
<span class="nc" id="L419">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L421">        Set&lt;String&gt; processInstanceIds = new HashSet&lt;&gt;();</span>
<span class="nc" id="L422">        processInstanceIds.add(processInstance.getId());</span>
<span class="nc" id="L423">        List&lt;HistoricVariableInstance&gt; historicVariableInstances = historyService.createHistoricVariableInstanceQuery().executionIds(processInstanceIds).list();</span>
<span class="nc" id="L424">        assertThat(historicVariableInstances).hasSize(1);</span>
<span class="nc" id="L425">        assertThat(historicVariableInstances.get(0).getVariableName()).isEqualTo(&quot;processVar&quot;);</span>
<span class="nc" id="L426">        assertThat(historicVariableInstances.get(0).getValue()).isEqualTo(&quot;processVar&quot;);</span>

<span class="nc" id="L428">        historicVariableInstances = historyService.createHistoricVariableInstanceQuery().executionIds(executionIds).excludeTaskVariables().list();</span>
<span class="nc" id="L429">        assertThat(historicVariableInstances).hasSize(2);</span>
<span class="nc" id="L430">        assertThat(historicVariableInstances.get(0).getVariableName()).isEqualTo(&quot;executionVar&quot;);</span>
<span class="nc" id="L431">        assertThat(historicVariableInstances.get(0).getValue()).isEqualTo(&quot;executionVar&quot;);</span>
<span class="nc" id="L432">        assertThat(historicVariableInstances.get(1).getVariableName()).isEqualTo(&quot;executionVar&quot;);</span>
<span class="nc" id="L433">        assertThat(historicVariableInstances.get(1).getValue()).isEqualTo(&quot;executionVar&quot;);</span>
<span class="nc" id="L434">    }</span>

    @Test
    public void testHistoricVariableQueryByTaskIds() {
<span class="nc" id="L438">        deployTwoTasksTestProcess();</span>
        // Generate data
<span class="nc" id="L440">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;twoTasksProcess&quot;).getId();</span>
<span class="nc" id="L441">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstanceId).list();</span>
<span class="nc" id="L442">        taskService.setVariableLocal(tasks.get(0).getId(), &quot;taskVar1&quot;, &quot;hello1&quot;);</span>
<span class="nc" id="L443">        taskService.setVariableLocal(tasks.get(1).getId(), &quot;taskVar2&quot;, &quot;hello2&quot;);</span>
        
<span class="nc" id="L445">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L447">        Set&lt;String&gt; taskIds = new HashSet&lt;&gt;();</span>
<span class="nc" id="L448">        taskIds.add(tasks.get(0).getId());</span>
<span class="nc" id="L449">        taskIds.add(tasks.get(1).getId());</span>
<span class="nc" id="L450">        List&lt;HistoricVariableInstance&gt; historicVariableInstances = historyService.createHistoricVariableInstanceQuery().taskIds(taskIds).list();</span>
<span class="nc" id="L451">        assertThat(historyService.createHistoricVariableInstanceQuery().taskIds(taskIds).count()).isEqualTo(2);</span>
<span class="nc" id="L452">        assertThat(historicVariableInstances).hasSize(2);</span>
<span class="nc" id="L453">        assertThat(historicVariableInstances.get(0).getVariableName()).isEqualTo(&quot;taskVar1&quot;);</span>
<span class="nc" id="L454">        assertThat(historicVariableInstances.get(0).getValue()).isEqualTo(&quot;hello1&quot;);</span>
<span class="nc" id="L455">        assertThat(historicVariableInstances.get(1).getVariableName()).isEqualTo(&quot;taskVar2&quot;);</span>
<span class="nc" id="L456">        assertThat(historicVariableInstances.get(1).getValue()).isEqualTo(&quot;hello2&quot;);</span>

<span class="nc" id="L458">        taskIds = new HashSet&lt;&gt;();</span>
<span class="nc" id="L459">        taskIds.add(tasks.get(0).getId());</span>
<span class="nc" id="L460">        historicVariableInstances = historyService.createHistoricVariableInstanceQuery().taskIds(taskIds).list();</span>
<span class="nc" id="L461">        assertThat(historyService.createHistoricVariableInstanceQuery().taskIds(taskIds).count()).isEqualTo(1);</span>
<span class="nc" id="L462">        assertThat(historicVariableInstances).hasSize(1);</span>
<span class="nc" id="L463">        assertThat(historicVariableInstances.get(0).getVariableName()).isEqualTo(&quot;taskVar1&quot;);</span>
<span class="nc" id="L464">        assertThat(historicVariableInstances.get(0).getValue()).isEqualTo(&quot;hello1&quot;);</span>
<span class="nc" id="L465">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/variableScope.bpmn20.xml&quot;
    })
    public void testHistoricVariableQueryByTaskIdsForScope() {
<span class="nc" id="L472">        Map&lt;String, Object&gt; processVars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L473">        processVars.put(&quot;processVar&quot;, &quot;processVar&quot;);</span>
<span class="nc" id="L474">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;variableScopeProcess&quot;, processVars);</span>

<span class="nc" id="L476">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">        for (Execution execution : executions) {</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">            if (!processInstance.getId().equals(execution.getId())) {</span>
<span class="nc" id="L479">                runtimeService.setVariableLocal(execution.getId(), &quot;executionVar&quot;, &quot;executionVar&quot;);</span>
            }
<span class="nc" id="L481">        }</span>

<span class="nc" id="L483">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L484">        Set&lt;String&gt; taskIds = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">        for (org.flowable.task.api.Task task : tasks) {</span>
<span class="nc" id="L486">            taskService.setVariableLocal(task.getId(), &quot;taskVar&quot;, &quot;taskVar&quot;);</span>
<span class="nc" id="L487">            taskIds.add(task.getId());</span>
<span class="nc" id="L488">        }</span>
        
<span class="nc" id="L490">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L492">        List&lt;HistoricVariableInstance&gt; historicVariableInstances = historyService.createHistoricVariableInstanceQuery().taskIds(taskIds).list();</span>
<span class="nc" id="L493">        assertThat(historicVariableInstances).hasSize(2);</span>
<span class="nc" id="L494">        assertThat(historicVariableInstances.get(0).getVariableName()).isEqualTo(&quot;taskVar&quot;);</span>
<span class="nc" id="L495">        assertThat(historicVariableInstances.get(0).getValue()).isEqualTo(&quot;taskVar&quot;);</span>
<span class="nc" id="L496">        assertThat(historicVariableInstances.get(1).getVariableName()).isEqualTo(&quot;taskVar&quot;);</span>
<span class="nc" id="L497">        assertThat(historicVariableInstances.get(1).getValue()).isEqualTo(&quot;taskVar&quot;);</span>
<span class="nc" id="L498">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testHistoricProcessVariableOnDeletion() {
<span class="nc bnc" id="L503" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>
<span class="nc" id="L504">            HashMap&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L505">            variables.put(&quot;testVar&quot;, &quot;Hallo Christian&quot;);</span>
<span class="nc" id="L506">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, variables);</span>
<span class="nc" id="L507">            runtimeService.deleteProcessInstance(processInstance.getId(), &quot;deleted&quot;);</span>
<span class="nc" id="L508">            assertProcessEnded(processInstance.getId());</span>

            // check that process variable is set even if the process is canceled and not ended normally
<span class="nc" id="L511">            assertThat(historyService.createHistoricVariableInstanceQuery().processInstanceId(processInstance.getId()).variableValueEquals(&quot;testVar&quot;, &quot;Hallo Christian&quot;).count()).isEqualTo(1);</span>
        }
<span class="nc" id="L513">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/standalone/history/FullHistoryTest.testVariableUpdatesAreLinkedToActivity.bpmn20.xml&quot; })
    public void testVariableUpdatesLinkedToActivity() throws Exception {
<span class="nc bnc" id="L518" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>
<span class="nc" id="L519">            ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;ProcessWithSubProcess&quot;);</span>

<span class="nc" id="L521">            org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L522">            Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L523">            variables.put(&quot;test&quot;, &quot;1&quot;);</span>
<span class="nc" id="L524">            taskService.complete(task.getId(), variables);</span>

            // now we are in the subprocess
<span class="nc" id="L527">            task = taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L528">            variables.clear();</span>
<span class="nc" id="L529">            variables.put(&quot;test&quot;, &quot;2&quot;);</span>
<span class="nc" id="L530">            taskService.complete(task.getId(), variables);</span>

            // now we are ended
<span class="nc" id="L533">            assertProcessEnded(pi.getId());</span>
            
<span class="nc" id="L535">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

            // check history
<span class="nc" id="L538">            List&lt;HistoricDetail&gt; updates = historyService.createHistoricDetailQuery().processInstanceId(pi.getId()).variableUpdates().list();</span>
<span class="nc" id="L539">            assertThat(updates).hasSize(2);</span>

<span class="nc" id="L541">            Map&lt;String, HistoricVariableUpdate&gt; updatesMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L542">            HistoricVariableUpdate update = (HistoricVariableUpdate) updates.get(0);</span>
<span class="nc" id="L543">            updatesMap.put((String) update.getValue(), update);</span>
<span class="nc" id="L544">            update = (HistoricVariableUpdate) updates.get(1);</span>
<span class="nc" id="L545">            updatesMap.put((String) update.getValue(), update);</span>

<span class="nc" id="L547">            HistoricVariableUpdate update1 = updatesMap.get(&quot;1&quot;);</span>
<span class="nc" id="L548">            HistoricVariableUpdate update2 = updatesMap.get(&quot;2&quot;);</span>

<span class="nc" id="L550">            assertThat(update1.getActivityInstanceId()).isNotNull();</span>
<span class="nc" id="L551">            assertThat(update1.getExecutionId()).isNotNull();</span>
<span class="nc" id="L552">            HistoricActivityInstance historicActivityInstance1 = historyService.createHistoricActivityInstanceQuery().activityInstanceId(update1.getActivityInstanceId()).singleResult();</span>
<span class="nc" id="L553">            assertThat(historicActivityInstance1.getActivityId()).isEqualTo(&quot;usertask1&quot;);</span>

            // TODO https://activiti.atlassian.net/browse/ACT-1083
<span class="nc" id="L556">            assertThat(update2.getActivityInstanceId()).isNotNull();</span>
<span class="nc" id="L557">            HistoricActivityInstance historicActivityInstance2 = historyService.createHistoricActivityInstanceQuery().activityInstanceId(update2.getActivityInstanceId()).singleResult();</span>
<span class="nc" id="L558">            assertThat(historicActivityInstance2.getActivityId()).isEqualTo(&quot;usertask2&quot;);</span>

            /*
             * This is OK! The variable is set on the root execution, on a execution never run through the activity, where the process instances stands when calling the set Variable. But the
             * ActivityId of this flow node is used. So the execution id's doesn't have to be equal.
             * 
             * execution id: On which execution it was set activity id: in which activity was the process instance when setting the variable
             */
<span class="nc" id="L566">            assertThat(historicActivityInstance2).isNotEqualTo(update2.getExecutionId());</span>
        }
<span class="nc" id="L568">    }</span>

    // Test for ACT-1528, which (correctly) reported that deleting any
    // historic process instance would remove ALL historic variables.
    // Yes. Real serious bug.
    @Test
    @Deployment
    public void testHistoricProcessInstanceDeleteCascadesCorrectly() {

<span class="nc bnc" id="L577" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>

<span class="nc" id="L579">            Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L580">            variables.put(&quot;var1&quot;, &quot;value1&quot;);</span>
<span class="nc" id="L581">            variables.put(&quot;var2&quot;, &quot;value2&quot;);</span>
<span class="nc" id="L582">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;myProcess&quot;, variables);</span>
<span class="nc" id="L583">            assertThat(processInstance).isNotNull();</span>

<span class="nc" id="L585">            variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L586">            variables.put(&quot;var3&quot;, &quot;value3&quot;);</span>
<span class="nc" id="L587">            variables.put(&quot;var4&quot;, &quot;value4&quot;);</span>
<span class="nc" id="L588">            ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;myProcess&quot;, variables);</span>
<span class="nc" id="L589">            assertThat(processInstance2).isNotNull();</span>
            
<span class="nc" id="L591">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

            // check variables
<span class="nc" id="L594">            long count = historyService.createHistoricVariableInstanceQuery().count();</span>
<span class="nc" id="L595">            assertThat(count).isEqualTo(4);</span>

            // delete runtime execution of ONE process instance
<span class="nc" id="L598">            runtimeService.deleteProcessInstance(processInstance.getId(), &quot;reason 1&quot;);</span>
            
<span class="nc" id="L600">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>
            
<span class="nc" id="L602">            historyService.deleteHistoricProcessInstance(processInstance.getId());</span>
            
<span class="nc" id="L604">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

            // recheck variables
            // this is a bug: all variables was deleted after delete a history process instance
<span class="nc" id="L608">            count = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L609">                    .processInstanceId(processInstance2.getId())</span>
<span class="nc" id="L610">                    .count();</span>
<span class="nc" id="L611">            assertThat(count).isEqualTo(2);</span>
            
<span class="nc" id="L613">            count = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L614">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L615">                    .count();</span>
<span class="nc" id="L616">            assertThat(count).isZero();</span>
        }

<span class="nc" id="L619">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/history/HistoricVariableInstanceTest.testSimple.bpmn20.xml&quot;)
    public void testNativeHistoricVariableInstanceQuery() {

<span class="nc bnc" id="L625" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>

<span class="nc" id="L627">            assertThat(managementService.getTableName(HistoricVariableInstance.class, false)).isEqualTo(&quot;ACT_HI_VARINST&quot;);</span>
<span class="nc" id="L628">            assertThat(managementService.getTableName(HistoricVariableInstanceEntity.class, false)).isEqualTo(&quot;ACT_HI_VARINST&quot;);</span>

<span class="nc" id="L630">            String tableName = managementService.getTableName(HistoricVariableInstance.class);</span>
<span class="nc" id="L631">            String baseQuerySql = &quot;SELECT * FROM &quot; + tableName;</span>

<span class="nc" id="L633">            Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L634">            variables.put(&quot;var1&quot;, &quot;value1&quot;);</span>
<span class="nc" id="L635">            variables.put(&quot;var2&quot;, &quot;value2&quot;);</span>
<span class="nc" id="L636">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;myProc&quot;, variables);</span>
<span class="nc" id="L637">            assertThat(processInstance).isNotNull();</span>
            
<span class="nc" id="L639">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L641">            assertThat(historyService.createNativeHistoricVariableInstanceQuery().sql(baseQuerySql).list()).hasSize(3);</span>

<span class="nc" id="L643">            String sqlWithConditions = baseQuerySql + &quot; where NAME_ = #{name}&quot;;</span>
<span class="nc" id="L644">            assertThat(historyService.createNativeHistoricVariableInstanceQuery().sql(sqlWithConditions).parameter(&quot;name&quot;, &quot;myVar&quot;).singleResult().getValue()).isEqualTo(&quot;test123&quot;);</span>

<span class="nc" id="L646">            sqlWithConditions = baseQuerySql + &quot; where NAME_ like #{name}&quot;;</span>
<span class="nc" id="L647">            assertThat(historyService.createNativeHistoricVariableInstanceQuery().sql(sqlWithConditions).parameter(&quot;name&quot;, &quot;var%&quot;).list()).hasSize(2);</span>

            // paging
<span class="nc" id="L650">            assertThat(historyService.createNativeHistoricVariableInstanceQuery().sql(baseQuerySql).listPage(0, 3)).hasSize(3);</span>
<span class="nc" id="L651">            assertThat(historyService.createNativeHistoricVariableInstanceQuery().sql(baseQuerySql).listPage(1, 3)).hasSize(2);</span>
<span class="nc" id="L652">            assertThat(historyService.createNativeHistoricVariableInstanceQuery().sql(sqlWithConditions).parameter(&quot;name&quot;, &quot;var%&quot;).listPage(0, 2)).hasSize(2);</span>
        }

<span class="nc" id="L655">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/history/HistoricVariableInstanceTest.testSimple.bpmn20.xml&quot;)
    public void testNativeHistoricDetailQuery() {
<span class="nc bnc" id="L660" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>
<span class="nc" id="L661">            assertThat(managementService.getTableName(HistoricDetail.class, false)).isEqualTo(&quot;ACT_HI_DETAIL&quot;);</span>
<span class="nc" id="L662">            assertThat(managementService.getTableName(HistoricVariableUpdate.class, false)).isEqualTo(&quot;ACT_HI_DETAIL&quot;);</span>

<span class="nc" id="L664">            String tableName = managementService.getTableName(HistoricDetail.class);</span>
<span class="nc" id="L665">            String baseQuerySql = &quot;SELECT * FROM &quot; + tableName;</span>

<span class="nc" id="L667">            Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L668">            variables.put(&quot;var1&quot;, &quot;value1&quot;);</span>
<span class="nc" id="L669">            variables.put(&quot;var2&quot;, &quot;value2&quot;);</span>
<span class="nc" id="L670">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;myProc&quot;, variables);</span>
<span class="nc" id="L671">            assertThat(processInstance).isNotNull();</span>
            
<span class="nc" id="L673">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L675">            assertThat(historyService.createNativeHistoricDetailQuery().sql(baseQuerySql).list()).hasSize(3);</span>

<span class="nc" id="L677">            String sqlWithConditions = baseQuerySql + &quot; where NAME_ = #{name} and TYPE_ = #{type}&quot;;</span>
<span class="nc" id="L678">            assertThat(historyService.createNativeHistoricDetailQuery().sql(sqlWithConditions).parameter(&quot;name&quot;, &quot;myVar&quot;).parameter(&quot;type&quot;, &quot;VariableUpdate&quot;).singleResult()).isNotNull();</span>

<span class="nc" id="L680">            sqlWithConditions = baseQuerySql + &quot; where NAME_ like #{name}&quot;;</span>
<span class="nc" id="L681">            assertThat(historyService.createNativeHistoricDetailQuery().sql(sqlWithConditions).parameter(&quot;name&quot;, &quot;var%&quot;).list()).hasSize(2);</span>

<span class="nc" id="L683">            org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L684">            Map&lt;String, String&gt; formDatas = new HashMap&lt;&gt;();</span>
<span class="nc" id="L685">            formDatas.put(&quot;field1&quot;, &quot;field value 1&quot;);</span>
<span class="nc" id="L686">            formDatas.put(&quot;field2&quot;, &quot;field value 2&quot;);</span>
<span class="nc" id="L687">            formService.submitTaskFormData(task.getId(), formDatas);</span>
            
<span class="nc" id="L689">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L691">            String countSql = &quot;select count(*) from &quot; + tableName + &quot; where TYPE_ = #{type} and PROC_INST_ID_ = #{pid}&quot;;</span>
<span class="nc" id="L692">            assertThat(historyService.createNativeHistoricDetailQuery().sql(countSql).parameter(&quot;type&quot;, &quot;FormProperty&quot;).parameter(&quot;pid&quot;, processInstance.getId()).count()).isEqualTo(2);</span>

            // paging
<span class="nc" id="L695">            assertThat(historyService.createNativeHistoricDetailQuery().sql(baseQuerySql).listPage(0, 3)).hasSize(3);</span>
<span class="nc" id="L696">            assertThat(historyService.createNativeHistoricDetailQuery().sql(baseQuerySql).listPage(1, 3)).hasSize(3);</span>
<span class="nc" id="L697">            sqlWithConditions = baseQuerySql + &quot; where TYPE_ = #{type} and PROC_INST_ID_ = #{pid}&quot;;</span>
<span class="nc" id="L698">            assertThat(historyService.createNativeHistoricDetailQuery().sql(sqlWithConditions).parameter(&quot;type&quot;, &quot;FormProperty&quot;).parameter(&quot;pid&quot;, processInstance.getId()).listPage(0, 2)).hasSize(2);</span>
        }
<span class="nc" id="L700">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/history/oneTaskProcess.bpmn20.xml&quot; })
    public void testChangeType() {
<span class="nc bnc" id="L705" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>
<span class="nc" id="L706">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L707">            TaskQuery taskQuery = taskService.createTaskQuery();</span>
<span class="nc" id="L708">            org.flowable.task.api.Task task = taskQuery.singleResult();</span>
<span class="nc" id="L709">            assertThat(task.getName()).isEqualTo(&quot;my task&quot;);</span>

            // no type change
<span class="nc" id="L712">            runtimeService.setVariable(processInstance.getId(), &quot;firstVar&quot;, &quot;123&quot;);</span>
<span class="nc" id="L713">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>
<span class="nc" id="L714">            assertThat(getHistoricVariable(&quot;firstVar&quot;).getValue()).isEqualTo(&quot;123&quot;);</span>
            
<span class="nc" id="L716">            runtimeService.setVariable(processInstance.getId(), &quot;firstVar&quot;, &quot;456&quot;);</span>
<span class="nc" id="L717">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>
<span class="nc" id="L718">            assertThat(getHistoricVariable(&quot;firstVar&quot;).getValue()).isEqualTo(&quot;456&quot;);</span>
            
<span class="nc" id="L720">            runtimeService.setVariable(processInstance.getId(), &quot;firstVar&quot;, &quot;789&quot;);</span>
<span class="nc" id="L721">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>
<span class="nc" id="L722">            assertThat(getHistoricVariable(&quot;firstVar&quot;).getValue()).isEqualTo(&quot;789&quot;);</span>

            // type is changed from text to integer and back again. same result expected(?)
<span class="nc" id="L725">            runtimeService.setVariable(processInstance.getId(), &quot;secondVar&quot;, &quot;123&quot;);</span>
<span class="nc" id="L726">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>
<span class="nc" id="L727">            assertThat(getHistoricVariable(&quot;secondVar&quot;).getValue()).isEqualTo(&quot;123&quot;);</span>
            
<span class="nc" id="L729">            runtimeService.setVariable(processInstance.getId(), &quot;secondVar&quot;, 456);</span>
<span class="nc" id="L730">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>
            // there are now 2 historic variables, so the following does not work
<span class="nc" id="L732">            assertThat(getHistoricVariable(&quot;secondVar&quot;).getValue()).isEqualTo(456);</span>
            
<span class="nc" id="L734">            runtimeService.setVariable(processInstance.getId(), &quot;secondVar&quot;, &quot;789&quot;);</span>
<span class="nc" id="L735">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>
            // there are now 3 historic variables, so the following does not work
<span class="nc" id="L737">            assertThat(getHistoricVariable(&quot;secondVar&quot;).getValue()).isEqualTo(&quot;789&quot;);</span>

<span class="nc" id="L739">            taskService.complete(task.getId());</span>

<span class="nc" id="L741">            assertProcessEnded(processInstance.getId());</span>
        }
<span class="nc" id="L743">    }</span>

    private HistoricVariableInstance getHistoricVariable(String variableName) {
<span class="nc" id="L746">        return historyService.createHistoricVariableInstanceQuery().variableName(variableName).singleResult();</span>
    }

    @Test
    @Deployment
    public void testRestrictByExecutionId() {
<span class="nc bnc" id="L752" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>
<span class="nc" id="L753">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;myProc&quot;);</span>
<span class="nc" id="L754">            TaskQuery taskQuery = taskService.createTaskQuery();</span>
<span class="nc" id="L755">            org.flowable.task.api.Task userTask = taskQuery.singleResult();</span>
<span class="nc" id="L756">            assertThat(userTask.getName()).isEqualTo(&quot;userTask1&quot;);</span>

<span class="nc" id="L758">            taskService.complete(userTask.getId(), CollectionUtil.singletonMap(&quot;myVar&quot;, &quot;test789&quot;));</span>

<span class="nc" id="L760">            assertProcessEnded(processInstance.getId());</span>
            
<span class="nc" id="L762">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L764">            List&lt;HistoricVariableInstance&gt; variables = historyService.createHistoricVariableInstanceQuery().executionId(processInstance.getId()).list();</span>
<span class="nc" id="L765">            assertThat(variables).hasSize(1);</span>

<span class="nc" id="L767">            HistoricVariableInstanceEntity historicVariable = (HistoricVariableInstanceEntity) variables.get(0);</span>
<span class="nc" id="L768">            assertThat(historicVariable.getTextValue()).isEqualTo(&quot;test456&quot;);</span>

<span class="nc" id="L770">            assertThat(historyService.createHistoricActivityInstanceQuery().count()).isEqualTo(9);</span>
<span class="nc" id="L771">            assertThat(historyService.createHistoricDetailQuery().count()).isEqualTo(3);</span>
        }
<span class="nc" id="L773">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryVariableValueEqualsAndNotEquals() {
<span class="nc" id="L778">        ProcessInstance processWithStringValue = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L779">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L780">                .name(&quot;With string value&quot;)</span>
<span class="nc" id="L781">                .variable(&quot;var&quot;, &quot;TEST&quot;)</span>
<span class="nc" id="L782">                .start();</span>

<span class="nc" id="L784">        ProcessInstance processWithNullValue = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L785">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L786">                .name(&quot;With null value&quot;)</span>
<span class="nc" id="L787">                .variable(&quot;var&quot;, null)</span>
<span class="nc" id="L788">                .start();</span>

<span class="nc" id="L790">        ProcessInstance processWithLongValue = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L791">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L792">                .name(&quot;With long value&quot;)</span>
<span class="nc" id="L793">                .variable(&quot;var&quot;, 100L)</span>
<span class="nc" id="L794">                .start();</span>

<span class="nc" id="L796">        ProcessInstance processWithDoubleValue = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L797">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L798">                .name(&quot;With double value&quot;)</span>
<span class="nc" id="L799">                .variable(&quot;var&quot;, 45.55)</span>
<span class="nc" id="L800">                .start();</span>

<span class="nc" id="L802">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L804">        assertThat(historyService.createHistoricVariableInstanceQuery().variableValueNotEquals(&quot;var&quot;, &quot;TEST&quot;).list())</span>
<span class="nc" id="L805">                .extracting(HistoricVariableInstance::getProcessInstanceId)</span>
<span class="nc" id="L806">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L807">                        processWithNullValue.getId(),</span>
<span class="nc" id="L808">                        processWithLongValue.getId(),</span>
<span class="nc" id="L809">                        processWithDoubleValue.getId()</span>
                );

<span class="nc" id="L812">        assertThat(historyService.createHistoricVariableInstanceQuery().variableValueEquals(&quot;var&quot;, &quot;TEST&quot;).list())</span>
<span class="nc" id="L813">                .extracting(HistoricVariableInstance::getProcessInstanceId)</span>
<span class="nc" id="L814">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L815">                        processWithStringValue.getId()</span>
                );

<span class="nc" id="L818">        assertThat(historyService.createHistoricVariableInstanceQuery().variableValueNotEquals(&quot;var&quot;, 100L).list())</span>
<span class="nc" id="L819">                .extracting(HistoricVariableInstance::getProcessInstanceId)</span>
<span class="nc" id="L820">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L821">                        processWithStringValue.getId(),</span>
<span class="nc" id="L822">                        processWithNullValue.getId(),</span>
<span class="nc" id="L823">                        processWithDoubleValue.getId()</span>
                );

<span class="nc" id="L826">        assertThat(historyService.createHistoricVariableInstanceQuery().variableValueEquals(&quot;var&quot;, 100L).list())</span>
<span class="nc" id="L827">                .extracting(HistoricVariableInstance::getProcessInstanceId)</span>
<span class="nc" id="L828">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L829">                        processWithLongValue.getId()</span>
                );

<span class="nc" id="L832">        assertThat(historyService.createHistoricVariableInstanceQuery().variableValueNotEquals(&quot;var&quot;, 45.55).list())</span>
<span class="nc" id="L833">                .extracting(HistoricVariableInstance::getProcessInstanceId)</span>
<span class="nc" id="L834">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L835">                        processWithStringValue.getId(),</span>
<span class="nc" id="L836">                        processWithNullValue.getId(),</span>
<span class="nc" id="L837">                        processWithLongValue.getId()</span>
                );

<span class="nc" id="L840">        assertThat(historyService.createHistoricVariableInstanceQuery().variableValueEquals(&quot;var&quot;, 45.55).list())</span>
<span class="nc" id="L841">                .extracting(HistoricVariableInstance::getProcessInstanceId)</span>
<span class="nc" id="L842">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L843">                        processWithDoubleValue.getId()</span>
                );

<span class="nc" id="L846">        assertThat(historyService.createHistoricVariableInstanceQuery().variableValueNotEquals(&quot;var&quot;, &quot;test&quot;).list())</span>
<span class="nc" id="L847">                .extracting(HistoricVariableInstance::getProcessInstanceId)</span>
<span class="nc" id="L848">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L849">                        processWithStringValue.getId(),</span>
<span class="nc" id="L850">                        processWithNullValue.getId(),</span>
<span class="nc" id="L851">                        processWithLongValue.getId(),</span>
<span class="nc" id="L852">                        processWithDoubleValue.getId()</span>
                );

<span class="nc" id="L855">        assertThat(historyService.createHistoricVariableInstanceQuery().variableValueEquals(&quot;var&quot;, &quot;test&quot;).list())</span>
<span class="nc" id="L856">                .extracting(HistoricVariableInstance::getProcessInstanceId)</span>
<span class="nc" id="L857">                .isEmpty();</span>
<span class="nc" id="L858">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>