<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProcessInstanceMigrationDocumentConverter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.migration</a> &gt; <span class="el_source">ProcessInstanceMigrationDocumentConverter.java</span></div><h1>ProcessInstanceMigrationDocumentConverter.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.engine.migration;

import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.function.Predicate;

import org.flowable.common.engine.api.FlowableException;
import org.flowable.engine.impl.migration.ProcessInstanceMigrationDocumentBuilderImpl;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.ObjectWriter;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;

/**
 * @author Dennis
 * @author martin.grofcik
 */
<span class="nc" id="L37">public class ProcessInstanceMigrationDocumentConverter {</span>

<span class="nc bnc" id="L39" title="All 4 branches missed.">    protected static Predicate&lt;JsonNode&gt; isNotNullNode = jsonNode -&gt; jsonNode != null &amp;&amp; !jsonNode.isNull();</span>
<span class="nc bnc" id="L40" title="All 4 branches missed.">    protected static Predicate&lt;JsonNode&gt; isSingleTextValue = jsonNode -&gt; isNotNullNode.test(jsonNode) &amp;&amp; jsonNode.isTextual();</span>
<span class="nc bnc" id="L41" title="All 4 branches missed.">    protected static Predicate&lt;JsonNode&gt; isMultiValue = jsonNode -&gt; isNotNullNode.test(jsonNode) &amp;&amp; jsonNode.isArray();</span>

<span class="nc" id="L43">    protected static ObjectMapper objectMapper = new ObjectMapper();</span>

<span class="nc" id="L45">    protected static Map&lt;Class&lt;? extends ActivityMigrationMapping&gt;, BaseActivityMigrationMappingConverter&gt; activityMigrationMappingConverters = new HashMap&lt;&gt;();</span>

    static {
<span class="nc" id="L48">        activityMigrationMappingConverters.put(ActivityMigrationMapping.OneToOneMapping.class, new OneToOneMappingConverter());</span>
<span class="nc" id="L49">        activityMigrationMappingConverters.put(ActivityMigrationMapping.OneToManyMapping.class, new OneToManyMappingConverter());</span>
<span class="nc" id="L50">        activityMigrationMappingConverters.put(ActivityMigrationMapping.ManyToOneMapping.class, new ManyToOneMappingConverter());</span>
<span class="nc" id="L51">    }</span>

    protected static &lt;T&gt; T convertFromJsonNodeToObject(JsonNode jsonNode, ObjectMapper objectMapper) {
<span class="nc" id="L54">        return objectMapper.convertValue(jsonNode, new TypeReference&lt;&gt;() {</span>

        });
    }

    public static JsonNode convertToJson(ProcessInstanceMigrationDocument processInstanceMigrationDocument) {

<span class="nc" id="L61">        ObjectNode documentNode = objectMapper.createObjectNode();</span>

<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (processInstanceMigrationDocument.getMigrateToProcessDefinitionId() != null) {</span>
<span class="nc" id="L64">            documentNode.put(ProcessInstanceMigrationDocumentConstants.TO_PROCESS_DEFINITION_ID_JSON_PROPERTY, processInstanceMigrationDocument.getMigrateToProcessDefinitionId());</span>
        }

<span class="nc bnc" id="L67" title="All 2 branches missed.">        if (processInstanceMigrationDocument.getMigrateToProcessDefinitionKey() != null) {</span>
<span class="nc" id="L68">            documentNode.put(ProcessInstanceMigrationDocumentConstants.TO_PROCESS_DEFINITION_KEY_JSON_PROPERTY, processInstanceMigrationDocument.getMigrateToProcessDefinitionKey());</span>
        }

<span class="nc bnc" id="L71" title="All 2 branches missed.">        if (processInstanceMigrationDocument.getMigrateToProcessDefinitionVersion() != null) {</span>
<span class="nc" id="L72">            documentNode.put(ProcessInstanceMigrationDocumentConstants.TO_PROCESS_DEFINITION_VERSION_JSON_PROPERTY, processInstanceMigrationDocument.getMigrateToProcessDefinitionVersion());</span>
        }

<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (processInstanceMigrationDocument.getMigrateToProcessDefinitionTenantId() != null) {</span>
<span class="nc" id="L76">            documentNode.put(ProcessInstanceMigrationDocumentConstants.TO_PROCESS_DEFINITION_TENANT_ID_JSON_PROPERTY, processInstanceMigrationDocument.getMigrateToProcessDefinitionTenantId());</span>
        }

<span class="nc" id="L79">        JsonNode preUpgradeScriptNode = convertToJsonUpgradeScript(processInstanceMigrationDocument.getPreUpgradeScript(), objectMapper);</span>
<span class="nc bnc" id="L80" title="All 4 branches missed.">        if (preUpgradeScriptNode != null &amp;&amp; !preUpgradeScriptNode.isNull()) {</span>
<span class="nc" id="L81">            documentNode.set(ProcessInstanceMigrationDocumentConstants.PRE_UPGRADE_SCRIPT, preUpgradeScriptNode);</span>
        }

<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (processInstanceMigrationDocument.getPreUpgradeJavaDelegate() != null) {</span>
<span class="nc" id="L85">            documentNode.put(ProcessInstanceMigrationDocumentConstants.PRE_UPGRADE_JAVA_DELEGATE, processInstanceMigrationDocument.getPreUpgradeJavaDelegate());</span>
        }

<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (processInstanceMigrationDocument.getPreUpgradeJavaDelegateExpression() != null) {</span>
<span class="nc" id="L89">            documentNode.put(ProcessInstanceMigrationDocumentConstants.PRE_UPGRADE_JAVA_DELEGATE_EXPRESSION, processInstanceMigrationDocument.getPreUpgradeJavaDelegateExpression());</span>
        }

<span class="nc" id="L92">        JsonNode postUpgradeScriptNode = convertToJsonUpgradeScript(processInstanceMigrationDocument.getPostUpgradeScript(), objectMapper);</span>
<span class="nc bnc" id="L93" title="All 4 branches missed.">        if (postUpgradeScriptNode != null &amp;&amp; !postUpgradeScriptNode.isNull()) {</span>
<span class="nc" id="L94">            documentNode.set(ProcessInstanceMigrationDocumentConstants.POST_UPGRADE_SCRIPT, postUpgradeScriptNode);</span>
        }

<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (processInstanceMigrationDocument.getPostUpgradeJavaDelegate() != null) {</span>
<span class="nc" id="L98">            documentNode.put(ProcessInstanceMigrationDocumentConstants.POST_UPGRADE_JAVA_DELEGATE, processInstanceMigrationDocument.getPostUpgradeJavaDelegate());</span>
        }

<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (processInstanceMigrationDocument.getPostUpgradeJavaDelegateExpression() != null) {</span>
<span class="nc" id="L102">            documentNode.put(ProcessInstanceMigrationDocumentConstants.POST_UPGRADE_JAVA_DELEGATE_EXPRESSION, processInstanceMigrationDocument.getPostUpgradeJavaDelegateExpression());</span>
        }

<span class="nc" id="L105">        ArrayNode mappingNodes = convertToJsonActivityMigrationMappings(processInstanceMigrationDocument.getActivityMigrationMappings());</span>
<span class="nc bnc" id="L106" title="All 4 branches missed.">        if (mappingNodes != null &amp;&amp; !mappingNodes.isNull()) {</span>
<span class="nc" id="L107">            documentNode.set(ProcessInstanceMigrationDocumentConstants.ACTIVITY_MAPPINGS_JSON_SECTION, mappingNodes);</span>
        }
        
<span class="nc" id="L110">        ArrayNode enableActivityNodes = convertToJsonEnableActivityMappings(processInstanceMigrationDocument.getEnableActivityMappings());</span>
<span class="nc bnc" id="L111" title="All 4 branches missed.">        if (enableActivityNodes != null &amp;&amp; !enableActivityNodes.isNull()) {</span>
<span class="nc" id="L112">            documentNode.set(ProcessInstanceMigrationDocumentConstants.ENABLE_ACTIVITY_MAPPINGS_JSON_SECTION, enableActivityNodes);</span>
        }

<span class="nc" id="L115">        JsonNode processInstanceVariablesNode = convertToJsonProcessInstanceVariables(processInstanceMigrationDocument, objectMapper);</span>
<span class="nc bnc" id="L116" title="All 4 branches missed.">        if (processInstanceVariablesNode != null &amp;&amp; !processInstanceVariablesNode.isNull()) {</span>
<span class="nc" id="L117">            documentNode.set(ProcessInstanceMigrationDocumentConstants.PROCESS_INSTANCE_VARIABLES_JSON_SECTION, processInstanceVariablesNode);</span>
        }

<span class="nc" id="L120">        return documentNode;</span>
    }

    public static String convertToJsonString(ProcessInstanceMigrationDocument processInstanceMigrationDocument) {
<span class="nc" id="L124">        JsonNode jsonNode = convertToJson(processInstanceMigrationDocument);</span>
<span class="nc" id="L125">        ObjectWriter objectWriter = objectMapper.writerWithDefaultPrettyPrinter();</span>
        try {
<span class="nc" id="L127">            return objectWriter.writeValueAsString(jsonNode);</span>
<span class="nc" id="L128">        } catch (JsonProcessingException e) {</span>
<span class="nc" id="L129">            return jsonNode.toString();</span>
        }
    }

    protected static ArrayNode convertToJsonActivityMigrationMappings(List&lt;? extends ActivityMigrationMapping&gt; activityMigrationMappings) {
<span class="nc" id="L134">        ArrayNode mappingsArray = objectMapper.createArrayNode();</span>

<span class="nc bnc" id="L136" title="All 2 branches missed.">        for (ActivityMigrationMapping mapping : activityMigrationMappings) {</span>
<span class="nc" id="L137">            BaseActivityMigrationMappingConverter mappingConverter = activityMigrationMappingConverters.get(mapping.getClass());</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">            if (mappingConverter == null) {</span>
<span class="nc" id="L139">                throw new FlowableException(&quot;Cannot convert mapping of type '&quot; + mapping.getClass() + &quot;'&quot;);</span>
            }
<span class="nc" id="L141">            ObjectNode mappingNode = mappingConverter.convertToJson(mapping, objectMapper);</span>
<span class="nc" id="L142">            mappingsArray.add(mappingNode);</span>
<span class="nc" id="L143">        }</span>

<span class="nc" id="L145">        return mappingsArray;</span>
    }
    
    protected static ArrayNode convertToJsonEnableActivityMappings(List&lt;? extends EnableActivityMapping&gt; enableActivityMappings) {
<span class="nc" id="L149">        ArrayNode mappingsArray = objectMapper.createArrayNode();</span>

<span class="nc bnc" id="L151" title="All 2 branches missed.">        for (EnableActivityMapping mapping : enableActivityMappings) {</span>
<span class="nc" id="L152">            ObjectNode mappingNode = mappingsArray.addObject();</span>
<span class="nc" id="L153">            mappingNode.put(ProcessInstanceMigrationDocumentConstants.ACTIVITY_ID_JSON_PROPERTY, mapping.getActivityId());</span>
<span class="nc" id="L154">        }</span>

<span class="nc" id="L156">        return mappingsArray;</span>
    }

    public static ProcessInstanceMigrationDocument convertFromJson(String jsonProcessInstanceMigrationDocument) {

        try {
<span class="nc" id="L162">            JsonNode rootNode = objectMapper.readTree(jsonProcessInstanceMigrationDocument);</span>
<span class="nc" id="L163">            ProcessInstanceMigrationDocumentBuilderImpl documentBuilder = new ProcessInstanceMigrationDocumentBuilderImpl();</span>

<span class="nc" id="L165">            String processDefinitionId = Optional.ofNullable(rootNode.get(ProcessInstanceMigrationDocumentConstants.TO_PROCESS_DEFINITION_ID_JSON_PROPERTY))</span>
<span class="nc" id="L166">                .map(JsonNode::textValue).orElse(null);</span>
<span class="nc" id="L167">            documentBuilder.setProcessDefinitionToMigrateTo(processDefinitionId);</span>

<span class="nc" id="L169">            String processDefinitionKey = Optional.ofNullable(rootNode.get(ProcessInstanceMigrationDocumentConstants.TO_PROCESS_DEFINITION_KEY_JSON_PROPERTY))</span>
<span class="nc" id="L170">                .map(JsonNode::textValue).orElse(null);</span>
<span class="nc" id="L171">            Integer processDefinitionVersion = (Integer) Optional.ofNullable(rootNode.get(ProcessInstanceMigrationDocumentConstants.TO_PROCESS_DEFINITION_VERSION_JSON_PROPERTY))</span>
<span class="nc" id="L172">                .map(JsonNode::numberValue).orElse(null);</span>
<span class="nc" id="L173">            documentBuilder.setProcessDefinitionToMigrateTo(processDefinitionKey, processDefinitionVersion);</span>

<span class="nc" id="L175">            String processDefinitionTenantId = Optional.ofNullable(rootNode.get(ProcessInstanceMigrationDocumentConstants.TO_PROCESS_DEFINITION_TENANT_ID_JSON_PROPERTY))</span>
<span class="nc" id="L176">                .map(JsonNode::textValue).orElse(null);</span>
<span class="nc" id="L177">            documentBuilder.setTenantId(processDefinitionTenantId);</span>

<span class="nc" id="L179">            JsonNode preUpgradeScriptNode = rootNode.get(ProcessInstanceMigrationDocumentConstants.PRE_UPGRADE_SCRIPT);</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">            if (preUpgradeScriptNode != null) {</span>
<span class="nc" id="L181">                String language = Optional.ofNullable(preUpgradeScriptNode.get(ProcessInstanceMigrationDocumentConstants.LANGUAGE)).map(JsonNode::asText).orElse(&quot;javascript&quot;);</span>
<span class="nc" id="L182">                String script = Optional.ofNullable(preUpgradeScriptNode.get(ProcessInstanceMigrationDocumentConstants.SCRIPT)).map(JsonNode::asText).orElse(&quot;javascript&quot;);</span>
<span class="nc" id="L183">                documentBuilder.setPreUpgradeScript(new Script(language, script));</span>
            }

<span class="nc" id="L186">            String javaDelegateClassName = Optional.ofNullable(rootNode.get(ProcessInstanceMigrationDocumentConstants.PRE_UPGRADE_JAVA_DELEGATE))</span>
<span class="nc" id="L187">                .map(JsonNode::textValue).orElse(null);</span>
<span class="nc" id="L188">            documentBuilder.setPreUpgradeJavaDelegate(javaDelegateClassName);</span>

<span class="nc" id="L190">            String expression = Optional.ofNullable(rootNode.get(ProcessInstanceMigrationDocumentConstants.PRE_UPGRADE_JAVA_DELEGATE_EXPRESSION))</span>
<span class="nc" id="L191">                .map(JsonNode::textValue).orElse(null);</span>
<span class="nc" id="L192">            documentBuilder.setPreUpgradeJavaDelegateExpression(expression);</span>

<span class="nc" id="L194">            JsonNode postUpgradeScriptNode = rootNode.get(ProcessInstanceMigrationDocumentConstants.POST_UPGRADE_SCRIPT);</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">            if (postUpgradeScriptNode != null) {</span>
<span class="nc" id="L196">                String language = Optional.ofNullable(postUpgradeScriptNode.get(ProcessInstanceMigrationDocumentConstants.LANGUAGE)).map(JsonNode::asText).orElse(&quot;javascript&quot;);</span>
<span class="nc" id="L197">                String script = Optional.ofNullable(postUpgradeScriptNode.get(ProcessInstanceMigrationDocumentConstants.SCRIPT)).map(JsonNode::asText).orElse(&quot;javascript&quot;);</span>
<span class="nc" id="L198">                documentBuilder.setPostUpgradeScript(new Script(language, script));</span>
            }

<span class="nc" id="L201">            String postJavaDelegateClassName = Optional.ofNullable(rootNode.get(ProcessInstanceMigrationDocumentConstants.POST_UPGRADE_JAVA_DELEGATE))</span>
<span class="nc" id="L202">                .map(JsonNode::textValue).orElse(null);</span>
<span class="nc" id="L203">            documentBuilder.setPostUpgradeJavaDelegate(postJavaDelegateClassName);</span>

<span class="nc" id="L205">            String postExpression = Optional.ofNullable(rootNode.get(ProcessInstanceMigrationDocumentConstants.POST_UPGRADE_JAVA_DELEGATE_EXPRESSION))</span>
<span class="nc" id="L206">                .map(JsonNode::textValue).orElse(null);</span>
<span class="nc" id="L207">            documentBuilder.setPostUpgradeJavaDelegateExpression(postExpression);</span>

<span class="nc" id="L209">            JsonNode activityMigrationMappings = rootNode.get(ProcessInstanceMigrationDocumentConstants.ACTIVITY_MAPPINGS_JSON_SECTION);</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">            if (activityMigrationMappings != null) {</span>

<span class="nc bnc" id="L212" title="All 2 branches missed.">                for (JsonNode mappingNode : activityMigrationMappings) {</span>
<span class="nc" id="L213">                    Class&lt;? extends ActivityMigrationMapping&gt; mappingClass = null;</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                    if (isSingleTextValue.test(mappingNode.get(ProcessInstanceMigrationDocumentConstants.FROM_ACTIVITY_ID_JSON_PROPERTY)) &amp;&amp; </span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">                            isSingleTextValue.test(mappingNode.get(ProcessInstanceMigrationDocumentConstants.TO_ACTIVITY_ID_JSON_PROPERTY))) {</span>
<span class="nc" id="L216">                        mappingClass = ActivityMigrationMapping.OneToOneMapping.class;</span>
                    }
<span class="nc bnc" id="L218" title="All 2 branches missed.">                    if (isSingleTextValue.test(mappingNode.get(ProcessInstanceMigrationDocumentConstants.FROM_ACTIVITY_ID_JSON_PROPERTY)) &amp;&amp; </span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">                            isMultiValue.test(mappingNode.get(ProcessInstanceMigrationDocumentConstants.TO_ACTIVITY_IDS_JSON_PROPERTY))) {</span>
<span class="nc" id="L220">                        mappingClass = ActivityMigrationMapping.OneToManyMapping.class;</span>
                    }
<span class="nc bnc" id="L222" title="All 2 branches missed.">                    if (isMultiValue.test(mappingNode.get(ProcessInstanceMigrationDocumentConstants.FROM_ACTIVITY_IDS_JSON_PROPERTY)) &amp;&amp; </span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">                            isSingleTextValue.test(mappingNode.get(ProcessInstanceMigrationDocumentConstants.TO_ACTIVITY_ID_JSON_PROPERTY))) {</span>
<span class="nc" id="L224">                        mappingClass = ActivityMigrationMapping.ManyToOneMapping.class;</span>
                    }

<span class="nc" id="L227">                    BaseActivityMigrationMappingConverter mappingConverter = activityMigrationMappingConverters.get(mappingClass);</span>
<span class="nc" id="L228">                    ActivityMigrationMapping mapping = mappingConverter.convertFromJson(mappingNode, objectMapper);</span>
<span class="nc" id="L229">                    documentBuilder.addActivityMigrationMapping(mapping);</span>
<span class="nc" id="L230">                }</span>
            }
            
<span class="nc" id="L233">            JsonNode enableActivityMappings = rootNode.get(ProcessInstanceMigrationDocumentConstants.ENABLE_ACTIVITY_MAPPINGS_JSON_SECTION);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">            if (enableActivityMappings != null) {</span>

<span class="nc bnc" id="L236" title="All 2 branches missed.">                for (JsonNode mappingNode : enableActivityMappings) {</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">                    if (mappingNode.hasNonNull(ProcessInstanceMigrationDocumentConstants.ACTIVITY_ID_JSON_PROPERTY)) {</span>
<span class="nc" id="L238">                        EnableActivityMapping.EnableMapping enableMapping = new EnableActivityMapping.EnableMapping(</span>
<span class="nc" id="L239">                                mappingNode.get(ProcessInstanceMigrationDocumentConstants.ACTIVITY_ID_JSON_PROPERTY).asText());</span>
<span class="nc" id="L240">                        documentBuilder.addEnableActivityMapping(enableMapping);</span>
                    }
<span class="nc" id="L242">                }</span>
            }

<span class="nc" id="L245">            JsonNode processInstanceVariablesNode = rootNode.get(ProcessInstanceMigrationDocumentConstants.PROCESS_INSTANCE_VARIABLES_JSON_SECTION);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">            if (processInstanceVariablesNode != null) {</span>
<span class="nc" id="L247">                Map&lt;String, Object&gt; processInstanceVariables = ProcessInstanceMigrationDocumentConverter.convertFromJsonNodeToObject(processInstanceVariablesNode, objectMapper);</span>
<span class="nc" id="L248">                documentBuilder.addProcessInstanceVariables(processInstanceVariables);</span>
            }
<span class="nc" id="L250">            return documentBuilder.build();</span>

<span class="nc" id="L252">        } catch (IOException e) {</span>
<span class="nc" id="L253">            throw new FlowableException(&quot;Error parsing Process Instance Migration Document&quot;, e);</span>
        }

    }

    protected static JsonNode convertToJsonProcessInstanceVariables(ProcessInstanceMigrationDocument processInstanceMigrationDocument, ObjectMapper objectMapper) {
<span class="nc" id="L259">        Map&lt;String, Object&gt; processInstanceVariables = processInstanceMigrationDocument.getProcessInstanceVariables();</span>
<span class="nc bnc" id="L260" title="All 4 branches missed.">        if (processInstanceVariables != null &amp;&amp; !processInstanceVariables.isEmpty()) {</span>
<span class="nc" id="L261">            return objectMapper.valueToTree(processInstanceVariables);</span>
        }
<span class="nc" id="L263">        return null;</span>
    }

    protected static JsonNode convertToJsonUpgradeScript(Script script, ObjectMapper objectMapper) {
<span class="nc bnc" id="L267" title="All 2 branches missed.">        if (script != null) {</span>
<span class="nc" id="L268">            return objectMapper.valueToTree(script);</span>
        }
<span class="nc" id="L270">        return null;</span>
    }

<span class="nc" id="L273">    public abstract static class BaseActivityMigrationMappingConverter&lt;T extends ActivityMigrationMapping&gt; {</span>

        public ObjectNode convertToJson(T mapping, ObjectMapper objectMapper) {
<span class="nc" id="L276">            ObjectNode mappingNode = convertMappingInfoToJson(mapping, objectMapper);</span>

<span class="nc" id="L278">            JsonNode newAssigneeToJsonNode = convertNewAssigneeToJson(mapping, objectMapper);</span>
<span class="nc bnc" id="L279" title="All 4 branches missed.">            if (newAssigneeToJsonNode != null &amp;&amp; !newAssigneeToJsonNode.isNull()) {</span>
<span class="nc" id="L280">                mappingNode.set(ProcessInstanceMigrationDocumentConstants.NEW_ASSIGNEE_JSON_PROPERTY, newAssigneeToJsonNode);</span>
            }

<span class="nc" id="L283">            JsonNode variablesToJsonNode = convertLocalVariablesToJson(mapping, objectMapper);</span>
<span class="nc bnc" id="L284" title="All 4 branches missed.">            if (variablesToJsonNode != null &amp;&amp; !variablesToJsonNode.isNull()) {</span>
<span class="nc" id="L285">                mappingNode.set(ProcessInstanceMigrationDocumentConstants.LOCAL_VARIABLES_JSON_SECTION, variablesToJsonNode);</span>
            }

<span class="nc" id="L288">            return mappingNode;</span>
        }

        protected abstract ObjectNode convertMappingInfoToJson(T mapping, ObjectMapper objectMapper);

        protected ObjectNode convertAdditionalMappingInfoToJson(T mapping, ObjectMapper objectMapper) {
<span class="nc" id="L294">            ObjectNode mappingNode = objectMapper.createObjectNode();</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">            if (mapping.isToParentProcess()) {</span>
<span class="nc" id="L296">                mappingNode.put(ProcessInstanceMigrationDocumentConstants.IN_PARENT_PROCESS_OF_CALL_ACTIVITY_JSON_PROPERTY, mapping.getFromCallActivityId());</span>
            }
<span class="nc bnc" id="L298" title="All 2 branches missed.">            if (mapping.isToCallActivity()) {</span>
<span class="nc" id="L299">                mappingNode.put(ProcessInstanceMigrationDocumentConstants.IN_SUB_PROCESS_OF_CALL_ACTIVITY_ID_JSON_PROPERTY, mapping.getToCallActivityId());</span>
<span class="nc" id="L300">                mappingNode.put(ProcessInstanceMigrationDocumentConstants.CALL_ACTIVITY_PROCESS_DEFINITION_VERSION_JSON_PROPERTY, mapping.getCallActivityProcessDefinitionVersion());</span>
            }
<span class="nc" id="L302">            return mappingNode;</span>
        }

        protected abstract JsonNode convertLocalVariablesToJson(T mapping, ObjectMapper objectMapper);

        protected abstract JsonNode convertNewAssigneeToJson(T mapping, ObjectMapper objectMapper);

        public abstract T convertFromJson(JsonNode jsonNode, ObjectMapper objectMapper);

        protected &lt;M extends ActivityMigrationMappingOptions&lt;T&gt;&gt; void convertAdditionalMappingInfoFromJson(M mapping, JsonNode jsonNode) {
<span class="nc" id="L312">            Optional&lt;JsonNode&gt; callActivityOfParentProcess = Optional.ofNullable(jsonNode.get(ProcessInstanceMigrationDocumentConstants.IN_PARENT_PROCESS_OF_CALL_ACTIVITY_JSON_PROPERTY));</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">            if (callActivityOfParentProcess.isPresent()) {</span>
<span class="nc" id="L314">                callActivityOfParentProcess.map(JsonNode::textValue).ifPresent(mapping::inParentProcessOfCallActivityId);</span>
<span class="nc" id="L315">                return; //if its a move to parent, it cannot be also a move to subProcess</span>
            }

<span class="nc" id="L318">            Optional&lt;JsonNode&gt; ofCallActivityId = Optional.ofNullable(jsonNode.get(ProcessInstanceMigrationDocumentConstants.IN_SUB_PROCESS_OF_CALL_ACTIVITY_ID_JSON_PROPERTY));</span>
<span class="nc" id="L319">            Optional&lt;JsonNode&gt; subProcDefVer = Optional.ofNullable(jsonNode.get(ProcessInstanceMigrationDocumentConstants.CALL_ACTIVITY_PROCESS_DEFINITION_VERSION_JSON_PROPERTY));</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">            if (ofCallActivityId.isPresent()) {</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">                if (subProcDefVer.isPresent()) {</span>
<span class="nc" id="L322">                    mapping.inSubProcessOfCallActivityId(ofCallActivityId.get().textValue(), subProcDefVer.get().intValue());</span>
                } else {
<span class="nc" id="L324">                    mapping.inSubProcessOfCallActivityId(ofCallActivityId.get().textValue());</span>
                }
            }

<span class="nc" id="L328">        }</span>

        protected &lt;V&gt; V getLocalVariablesFromJson(JsonNode jsonNode, ObjectMapper objectMapper) {
<span class="nc" id="L331">            JsonNode localVariablesNode = jsonNode.get(ProcessInstanceMigrationDocumentConstants.LOCAL_VARIABLES_JSON_SECTION);</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">            if (localVariablesNode != null) {</span>
<span class="nc" id="L333">                return ProcessInstanceMigrationDocumentConverter.convertFromJsonNodeToObject(localVariablesNode, objectMapper);</span>
            }
<span class="nc" id="L335">            return null;</span>
        }

        protected String getNewAssigneeFromJson(JsonNode jsonNode) {
<span class="nc bnc" id="L339" title="All 2 branches missed.">            if (isSingleTextValue.test(jsonNode.get(ProcessInstanceMigrationDocumentConstants.NEW_ASSIGNEE_JSON_PROPERTY))) {</span>
<span class="nc" id="L340">                return jsonNode.get(ProcessInstanceMigrationDocumentConstants.NEW_ASSIGNEE_JSON_PROPERTY).textValue();</span>
            }
<span class="nc" id="L342">            return null;</span>
        }

    }

<span class="nc" id="L347">    public static class OneToOneMappingConverter extends BaseActivityMigrationMappingConverter&lt;ActivityMigrationMapping.OneToOneMapping&gt; {</span>

        @Override
        protected ObjectNode convertMappingInfoToJson(ActivityMigrationMapping.OneToOneMapping mapping, ObjectMapper objectMapper) {
<span class="nc" id="L351">            ObjectNode mappingNode = objectMapper.createObjectNode();</span>
<span class="nc" id="L352">            mappingNode.put(ProcessInstanceMigrationDocumentConstants.FROM_ACTIVITY_ID_JSON_PROPERTY, mapping.getFromActivityId());</span>
<span class="nc" id="L353">            mappingNode.put(ProcessInstanceMigrationDocumentConstants.TO_ACTIVITY_ID_JSON_PROPERTY, mapping.getToActivityId());</span>
<span class="nc" id="L354">            mappingNode.setAll(convertAdditionalMappingInfoToJson(mapping, objectMapper));</span>
<span class="nc" id="L355">            return mappingNode;</span>
        }

        @Override
        public JsonNode convertLocalVariablesToJson(ActivityMigrationMapping.OneToOneMapping mapping, ObjectMapper objectMapper) {
<span class="nc" id="L360">            Map&lt;String, Object&gt; activityLocalVariables = mapping.getActivityLocalVariables();</span>
<span class="nc bnc" id="L361" title="All 4 branches missed.">            if (activityLocalVariables != null &amp;&amp; !activityLocalVariables.isEmpty()) {</span>
<span class="nc" id="L362">                return objectMapper.valueToTree(activityLocalVariables);</span>
            }
<span class="nc" id="L364">            return null;</span>
        }

        @Override
        protected JsonNode convertNewAssigneeToJson(ActivityMigrationMapping.OneToOneMapping mapping, ObjectMapper objectMapper) {
<span class="nc" id="L369">            return objectMapper.valueToTree(mapping.getWithNewAssignee());</span>
        }

        @Override
        public ActivityMigrationMapping.OneToOneMapping convertFromJson(JsonNode jsonNode, ObjectMapper objectMapper) {
<span class="nc" id="L374">            String fromActivityId = jsonNode.get(ProcessInstanceMigrationDocumentConstants.FROM_ACTIVITY_ID_JSON_PROPERTY).textValue();</span>
<span class="nc" id="L375">            String toActivityId = jsonNode.get(ProcessInstanceMigrationDocumentConstants.TO_ACTIVITY_ID_JSON_PROPERTY).textValue();</span>

<span class="nc" id="L377">            ActivityMigrationMapping.OneToOneMapping oneToOneMapping = ActivityMigrationMapping.createMappingFor(fromActivityId, toActivityId);</span>
<span class="nc" id="L378">            convertAdditionalMappingInfoFromJson(oneToOneMapping, jsonNode);</span>

<span class="nc" id="L380">            Optional.ofNullable(getNewAssigneeFromJson(jsonNode))</span>
<span class="nc" id="L381">                .ifPresent(oneToOneMapping::withNewAssignee);</span>

<span class="nc" id="L383">            Map&lt;String, Object&gt; localVariables = getLocalVariablesFromJson(jsonNode, objectMapper);</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">            if (localVariables != null) {</span>
<span class="nc" id="L385">                oneToOneMapping.withLocalVariables(localVariables);</span>
            }

<span class="nc" id="L388">            return oneToOneMapping;</span>
        }

    }

<span class="nc" id="L393">    public static class ManyToOneMappingConverter extends BaseActivityMigrationMappingConverter&lt;ActivityMigrationMapping.ManyToOneMapping&gt; {</span>

        @Override
        protected ObjectNode convertMappingInfoToJson(ActivityMigrationMapping.ManyToOneMapping mapping, ObjectMapper objectMapper) {
<span class="nc" id="L397">            ObjectNode mappingNode = objectMapper.createObjectNode();</span>
<span class="nc" id="L398">            JsonNode fromActivityIdsNode = objectMapper.valueToTree(mapping.getFromActivityIds());</span>
<span class="nc" id="L399">            mappingNode.set(ProcessInstanceMigrationDocumentConstants.FROM_ACTIVITY_IDS_JSON_PROPERTY, fromActivityIdsNode);</span>
<span class="nc" id="L400">            mappingNode.put(ProcessInstanceMigrationDocumentConstants.TO_ACTIVITY_ID_JSON_PROPERTY, mapping.getToActivityId());</span>
<span class="nc" id="L401">            mappingNode.setAll(convertAdditionalMappingInfoToJson(mapping, objectMapper));</span>
<span class="nc" id="L402">            return mappingNode;</span>
        }

        @Override
        public JsonNode convertLocalVariablesToJson(ActivityMigrationMapping.ManyToOneMapping mapping, ObjectMapper objectMapper) {
<span class="nc" id="L407">            Map&lt;String, Object&gt; activityLocalVariables = mapping.getActivityLocalVariables();</span>
<span class="nc bnc" id="L408" title="All 4 branches missed.">            if (activityLocalVariables != null &amp;&amp; !activityLocalVariables.isEmpty()) {</span>
<span class="nc" id="L409">                return objectMapper.valueToTree(activityLocalVariables);</span>
            }
<span class="nc" id="L411">            return null;</span>
        }

        @Override
        protected JsonNode convertNewAssigneeToJson(ActivityMigrationMapping.ManyToOneMapping mapping, ObjectMapper objectMapper) {
<span class="nc" id="L416">            return objectMapper.valueToTree(mapping.getWithNewAssignee());</span>
        }

        @Override
        public ActivityMigrationMapping.ManyToOneMapping convertFromJson(JsonNode jsonNode, ObjectMapper objectMapper) {
<span class="nc" id="L421">            JsonNode fromActivityIdsNode = jsonNode.get(ProcessInstanceMigrationDocumentConstants.FROM_ACTIVITY_IDS_JSON_PROPERTY);</span>
<span class="nc" id="L422">            List&lt;String&gt; fromActivityIds = objectMapper.convertValue(fromActivityIdsNode, new TypeReference&lt;&gt;() {</span>

            });
<span class="nc" id="L425">            String toActivityId = jsonNode.get(ProcessInstanceMigrationDocumentConstants.TO_ACTIVITY_ID_JSON_PROPERTY).textValue();</span>

<span class="nc" id="L427">            ActivityMigrationMapping.ManyToOneMapping manyToOneMapping = ActivityMigrationMapping.createMappingFor(fromActivityIds, toActivityId);</span>
<span class="nc" id="L428">            convertAdditionalMappingInfoFromJson(manyToOneMapping, jsonNode);</span>

<span class="nc" id="L430">            Optional.ofNullable(getNewAssigneeFromJson(jsonNode))</span>
<span class="nc" id="L431">                .ifPresent(manyToOneMapping::withNewAssignee);</span>

<span class="nc" id="L433">            Map&lt;String, Object&gt; localVariables = getLocalVariablesFromJson(jsonNode, objectMapper);</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">            if (localVariables != null) {</span>
<span class="nc" id="L435">                manyToOneMapping.withLocalVariables(localVariables);</span>
            }

<span class="nc" id="L438">            return manyToOneMapping;</span>
        }
    }

<span class="nc" id="L442">    public static class OneToManyMappingConverter extends BaseActivityMigrationMappingConverter&lt;ActivityMigrationMapping.OneToManyMapping&gt; {</span>

        @Override
        protected ObjectNode convertMappingInfoToJson(ActivityMigrationMapping.OneToManyMapping mapping, ObjectMapper objectMapper) {
<span class="nc" id="L446">            ObjectNode mappingNode = objectMapper.createObjectNode();</span>
<span class="nc" id="L447">            mappingNode.put(ProcessInstanceMigrationDocumentConstants.FROM_ACTIVITY_ID_JSON_PROPERTY, mapping.getFromActivityId());</span>
<span class="nc" id="L448">            JsonNode toActivityIdsNode = objectMapper.valueToTree(mapping.getToActivityIds());</span>
<span class="nc" id="L449">            mappingNode.set(ProcessInstanceMigrationDocumentConstants.TO_ACTIVITY_IDS_JSON_PROPERTY, toActivityIdsNode);</span>
<span class="nc" id="L450">            mappingNode.setAll(convertAdditionalMappingInfoToJson(mapping, objectMapper));</span>
<span class="nc" id="L451">            return mappingNode;</span>
        }

        @Override
        public JsonNode convertLocalVariablesToJson(ActivityMigrationMapping.OneToManyMapping mapping, ObjectMapper objectMapper) {
<span class="nc" id="L456">            Map&lt;String, Map&lt;String, Object&gt;&gt; activitiesLocalVariables = mapping.getActivitiesLocalVariables();</span>
<span class="nc bnc" id="L457" title="All 4 branches missed.">            if (activitiesLocalVariables != null &amp;&amp; !activitiesLocalVariables.isEmpty()) {</span>
<span class="nc" id="L458">                return objectMapper.valueToTree(activitiesLocalVariables);</span>
            }
<span class="nc" id="L460">            return null;</span>
        }

        @Override
        protected JsonNode convertNewAssigneeToJson(ActivityMigrationMapping.OneToManyMapping mapping, ObjectMapper objectMapper) {
<span class="nc" id="L465">            return null;</span>
        }

        @Override
        public ActivityMigrationMapping.OneToManyMapping convertFromJson(JsonNode jsonNode, ObjectMapper objectMapper) {
<span class="nc" id="L470">            String fromActivityId = jsonNode.get(ProcessInstanceMigrationDocumentConstants.FROM_ACTIVITY_ID_JSON_PROPERTY).textValue();</span>
<span class="nc" id="L471">            JsonNode toActivityIdsNode = jsonNode.get(ProcessInstanceMigrationDocumentConstants.TO_ACTIVITY_IDS_JSON_PROPERTY);</span>
<span class="nc" id="L472">            List&lt;String&gt; toActivityIds = objectMapper.convertValue(toActivityIdsNode, new TypeReference&lt;&gt;() {</span>

            });

<span class="nc" id="L476">            ActivityMigrationMapping.OneToManyMapping oneToManyMapping = ActivityMigrationMapping.createMappingFor(fromActivityId, toActivityIds);</span>
<span class="nc" id="L477">            convertAdditionalMappingInfoFromJson(oneToManyMapping, jsonNode);</span>

<span class="nc" id="L479">            Map&lt;String, Map&lt;String, Object&gt;&gt; localVariables = getLocalVariablesFromJson(jsonNode, objectMapper);</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">            if (localVariables != null) {</span>
<span class="nc" id="L481">                oneToManyMapping.withLocalVariables(localVariables);</span>
            }

<span class="nc" id="L484">            return oneToManyMapping;</span>
        }
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>