<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultProcessDiagramCanvas.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.image.impl</a> &gt; <span class="el_source">DefaultProcessDiagramCanvas.java</span></div><h1>DefaultProcessDiagramCanvas.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.image.impl;

import java.awt.BasicStroke;
import java.awt.Color;
import java.awt.Font;
import java.awt.FontMetrics;
import java.awt.Graphics2D;
import java.awt.Paint;
import java.awt.Point;
import java.awt.Polygon;
import java.awt.Rectangle;
import java.awt.RenderingHints;
import java.awt.Shape;
import java.awt.Stroke;
import java.awt.font.FontRenderContext;
import java.awt.font.LineBreakMeasurer;
import java.awt.font.TextAttribute;
import java.awt.font.TextLayout;
import java.awt.geom.AffineTransform;
import java.awt.geom.Ellipse2D;
import java.awt.geom.Line2D;
import java.awt.geom.Path2D;
import java.awt.geom.PathIterator;
import java.awt.geom.Rectangle2D;
import java.awt.geom.RoundRectangle2D;
import java.awt.image.BufferedImage;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.text.AttributedCharacterIterator;
import java.text.AttributedString;
import java.util.ArrayList;
import java.util.List;

import javax.imageio.ImageIO;

import org.flowable.bpmn.model.AssociationDirection;
import org.flowable.bpmn.model.GraphicInfo;
import org.flowable.image.exception.FlowableImageException;
import org.flowable.image.util.ReflectUtil;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Represents a canvas on which BPMN 2.0 constructs can be drawn.
 * 
 * Some of the icons used are licensed under a Creative Commons Attribution 2.5 License, see http://www.famfamfam.com/lab/icons/silk/
 * 
 * @see DefaultProcessDiagramGenerator
 * @author Joram Barrez
 */
public class DefaultProcessDiagramCanvas {

<span class="nc" id="L68">    protected static final Logger LOGGER = LoggerFactory.getLogger(DefaultProcessDiagramCanvas.class);</span>

<span class="nc" id="L70">    public enum SHAPE_TYPE {</span>
<span class="nc" id="L71">        Rectangle, Rhombus, Ellipse</span>
    }

    // Predefined sized
    protected static final int ARROW_WIDTH = 5;
    protected static final int CONDITIONAL_INDICATOR_WIDTH = 16;
    protected static final int DEFAULT_INDICATOR_WIDTH = 10;
    protected static final int MARKER_WIDTH = 12;
    protected static final int FONT_SIZE = 11;
    protected static final int FONT_SPACING = 2;
    protected static final int TEXT_PADDING = 3;
    protected static final int ANNOTATION_TEXT_PADDING = 7;
    protected static final int LINE_HEIGHT = FONT_SIZE + FONT_SPACING;

    // Colors
<span class="nc" id="L86">    protected static final Color TASK_BOX_COLOR = new Color(249, 249, 249);</span>
<span class="nc" id="L87">    protected static final Color SUBPROCESS_BOX_COLOR = new Color(255, 255, 255);</span>
<span class="nc" id="L88">    protected static final Color EVENT_COLOR = new Color(255, 255, 255);</span>
<span class="nc" id="L89">    protected static final Color CONNECTION_COLOR = new Color(88, 88, 88);</span>
<span class="nc" id="L90">    protected static final Color CONDITIONAL_INDICATOR_COLOR = new Color(255, 255, 255);</span>
<span class="nc" id="L91">    protected static final Color HIGHLIGHT_COLOR = Color.RED;</span>
<span class="nc" id="L92">    protected static final Color LABEL_COLOR = new Color(112, 146, 190);</span>
<span class="nc" id="L93">    protected static final Color TASK_BORDER_COLOR = new Color(187, 187, 187);</span>
<span class="nc" id="L94">    protected static final Color EVENT_BORDER_COLOR = new Color(88, 88, 88);</span>
<span class="nc" id="L95">    protected static final Color SUBPROCESS_BORDER_COLOR = new Color(0, 0, 0);</span>

    // Fonts
    protected static Font LABEL_FONT;
    protected static Font ANNOTATION_FONT;

    // Strokes
<span class="nc" id="L102">    protected static final Stroke THICK_TASK_BORDER_STROKE = new BasicStroke(3.0f);</span>
<span class="nc" id="L103">    protected static final Stroke GATEWAY_TYPE_STROKE = new BasicStroke(3.0f);</span>
<span class="nc" id="L104">    protected static final Stroke END_EVENT_STROKE = new BasicStroke(3.0f);</span>
<span class="nc" id="L105">    protected static final Stroke MULTI_INSTANCE_STROKE = new BasicStroke(1.3f);</span>
<span class="nc" id="L106">    protected static final Stroke EVENT_SUBPROCESS_STROKE = new BasicStroke(1.0f, BasicStroke.CAP_BUTT, BasicStroke.JOIN_MITER, 1.0f, new float[] { 1.0f }, 0.0f);</span>
<span class="nc" id="L107">    protected static final Stroke NON_INTERRUPTING_EVENT_STROKE = new BasicStroke(1.0f, BasicStroke.CAP_BUTT, BasicStroke.JOIN_MITER, 1.0f, new float[] { 4.0f, 3.0f }, 0.0f);</span>
<span class="nc" id="L108">    protected static final Stroke HIGHLIGHT_FLOW_STROKE = new BasicStroke(1.3f);</span>
<span class="nc" id="L109">    protected static final Stroke ANNOTATION_STROKE = new BasicStroke(2.0f);</span>
<span class="nc" id="L110">    protected static final Stroke ASSOCIATION_STROKE = new BasicStroke(2.0f, BasicStroke.CAP_BUTT, BasicStroke.JOIN_MITER, 1.0f, new float[] { 2.0f, 2.0f }, 0.0f);</span>

    // icons
    protected static final int ICON_PADDING = 5;
    protected static BufferedImage USERTASK_IMAGE;
    protected static BufferedImage SCRIPTTASK_IMAGE;
    protected static BufferedImage SERVICETASK_IMAGE;
    protected static BufferedImage RECEIVETASK_IMAGE;
    protected static BufferedImage SENDTASK_IMAGE;
    protected static BufferedImage CASETASK_IMAGE;
    protected static BufferedImage MANUALTASK_IMAGE;
    protected static BufferedImage BUSINESS_RULE_TASK_IMAGE;
    protected static BufferedImage SHELL_TASK_IMAGE;
    protected static BufferedImage DMN_TASK_IMAGE;
    protected static BufferedImage CAMEL_TASK_IMAGE;
    protected static BufferedImage HTTP_TASK_IMAGE;

    protected static BufferedImage TIMER_IMAGE;
    protected static BufferedImage COMPENSATE_THROW_IMAGE;
    protected static BufferedImage COMPENSATE_CATCH_IMAGE;
    protected static BufferedImage CONDITIONAL_CATCH_IMAGE;
    protected static BufferedImage ERROR_THROW_IMAGE;
    protected static BufferedImage ERROR_CATCH_IMAGE;
    protected static BufferedImage ESCALATION_THROW_IMAGE;
    protected static BufferedImage ESCALATION_CATCH_IMAGE;
    protected static BufferedImage MESSAGE_THROW_IMAGE;
    protected static BufferedImage MESSAGE_CATCH_IMAGE;
    protected static BufferedImage SIGNAL_CATCH_IMAGE;
    protected static BufferedImage SIGNAL_THROW_IMAGE;

<span class="nc" id="L140">    protected int canvasWidth = -1;</span>
<span class="nc" id="L141">    protected int canvasHeight = -1;</span>
<span class="nc" id="L142">    protected int minX = -1;</span>
<span class="nc" id="L143">    protected int minY = -1;</span>
    protected BufferedImage processDiagram;
    protected Graphics2D g;
    protected FontMetrics fontMetrics;
    protected boolean closed;
    protected ClassLoader customClassLoader;
<span class="nc" id="L149">    protected String activityFontName = &quot;Arial&quot;;</span>
<span class="nc" id="L150">    protected String labelFontName = &quot;Arial&quot;;</span>
<span class="nc" id="L151">    protected String annotationFontName = &quot;Arial&quot;;</span>

    /**
     * Creates an empty canvas with given width and height.
     * 
     * Allows to specify minimal boundaries on the left and upper side of the canvas. This is useful for diagrams that have white space there. Everything beneath these minimum values will be cropped.
     * It's also possible to pass a specific font name and a class loader for the icon images.
     * 
     */
    public DefaultProcessDiagramCanvas(int width, int height, int minX, int minY, String imageType,
<span class="nc" id="L161">            String activityFontName, String labelFontName, String annotationFontName, ClassLoader customClassLoader) {</span>

<span class="nc" id="L163">        this.canvasWidth = width;</span>
<span class="nc" id="L164">        this.canvasHeight = height;</span>
<span class="nc" id="L165">        this.minX = minX;</span>
<span class="nc" id="L166">        this.minY = minY;</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (activityFontName != null) {</span>
<span class="nc" id="L168">            this.activityFontName = activityFontName;</span>
        }
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (labelFontName != null) {</span>
<span class="nc" id="L171">            this.labelFontName = labelFontName;</span>
        }
<span class="nc bnc" id="L173" title="All 2 branches missed.">        if (annotationFontName != null) {</span>
<span class="nc" id="L174">            this.annotationFontName = annotationFontName;</span>
        }
<span class="nc" id="L176">        this.customClassLoader = customClassLoader;</span>

<span class="nc" id="L178">        initialize(imageType);</span>
<span class="nc" id="L179">    }</span>

    /**
     * Creates an empty canvas with given width and height.
     * 
     * Allows to specify minimal boundaries on the left and upper side of the canvas. This is useful for diagrams that have white space there (eg Signavio). Everything beneath these minimum values
     * will be cropped.
     * 
     * @param minX
     *            Hint that will be used when generating the image. Parts that fall below minX on the horizontal scale will be cropped.
     * @param minY
     *            Hint that will be used when generating the image. Parts that fall below minX on the horizontal scale will be cropped.
     */
<span class="nc" id="L192">    public DefaultProcessDiagramCanvas(int width, int height, int minX, int minY, String imageType) {</span>
<span class="nc" id="L193">        this.canvasWidth = width;</span>
<span class="nc" id="L194">        this.canvasHeight = height;</span>
<span class="nc" id="L195">        this.minX = minX;</span>
<span class="nc" id="L196">        this.minY = minY;</span>

<span class="nc" id="L198">        initialize(imageType);</span>
<span class="nc" id="L199">    }</span>

    public void initialize(String imageType) {
<span class="nc bnc" id="L202" title="All 2 branches missed.">        if (&quot;png&quot;.equalsIgnoreCase(imageType)) {</span>
<span class="nc" id="L203">            this.processDiagram = new BufferedImage(canvasWidth, canvasHeight, BufferedImage.TYPE_INT_ARGB);</span>
        } else {
<span class="nc" id="L205">            this.processDiagram = new BufferedImage(canvasWidth, canvasHeight, BufferedImage.TYPE_INT_RGB);</span>
        }

<span class="nc" id="L208">        this.g = processDiagram.createGraphics();</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (!&quot;png&quot;.equalsIgnoreCase(imageType)) {</span>
<span class="nc" id="L210">            this.g.setBackground(new Color(255, 255, 255, 0));</span>
<span class="nc" id="L211">            this.g.clearRect(0, 0, canvasWidth, canvasHeight);</span>
        }

<span class="nc" id="L214">        g.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);</span>
<span class="nc" id="L215">        g.setPaint(Color.black);</span>

<span class="nc" id="L217">        Font font = new Font(activityFontName, Font.BOLD, FONT_SIZE);</span>
<span class="nc" id="L218">        g.setFont(font);</span>
<span class="nc" id="L219">        this.fontMetrics = g.getFontMetrics();</span>

<span class="nc" id="L221">        LABEL_FONT = new Font(labelFontName, Font.ITALIC, 10);</span>
<span class="nc" id="L222">        ANNOTATION_FONT = new Font(annotationFontName, Font.PLAIN, FONT_SIZE);</span>

        try {
<span class="nc" id="L225">            USERTASK_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/userTask.png&quot;, customClassLoader));</span>
<span class="nc" id="L226">            SCRIPTTASK_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/scriptTask.png&quot;, customClassLoader));</span>
<span class="nc" id="L227">            SERVICETASK_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/serviceTask.png&quot;, customClassLoader));</span>
<span class="nc" id="L228">            RECEIVETASK_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/receiveTask.png&quot;, customClassLoader));</span>
<span class="nc" id="L229">            SENDTASK_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/sendTask.png&quot;, customClassLoader));</span>
<span class="nc" id="L230">            CASETASK_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/caseTask.png&quot;, customClassLoader));</span>
<span class="nc" id="L231">            MANUALTASK_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/manualTask.png&quot;, customClassLoader));</span>
<span class="nc" id="L232">            BUSINESS_RULE_TASK_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/businessRuleTask.png&quot;, customClassLoader));</span>
<span class="nc" id="L233">            SHELL_TASK_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/shellTask.png&quot;, customClassLoader));</span>
<span class="nc" id="L234">            DMN_TASK_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/dmnTask.png&quot;, customClassLoader));</span>
<span class="nc" id="L235">            CAMEL_TASK_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/camelTask.png&quot;, customClassLoader));</span>
<span class="nc" id="L236">            HTTP_TASK_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/httpTask.png&quot;, customClassLoader));</span>

<span class="nc" id="L238">            TIMER_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/timer.png&quot;, customClassLoader));</span>
<span class="nc" id="L239">            COMPENSATE_THROW_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/compensate-throw.png&quot;, customClassLoader));</span>
<span class="nc" id="L240">            COMPENSATE_CATCH_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/compensate.png&quot;, customClassLoader));</span>
<span class="nc" id="L241">            CONDITIONAL_CATCH_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/conditional.png&quot;, customClassLoader));</span>
<span class="nc" id="L242">            ERROR_THROW_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/error-throw.png&quot;, customClassLoader));</span>
<span class="nc" id="L243">            ERROR_CATCH_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/error.png&quot;, customClassLoader));</span>
<span class="nc" id="L244">            ESCALATION_THROW_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/escalation-throw.png&quot;, customClassLoader));</span>
<span class="nc" id="L245">            ESCALATION_CATCH_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/escalation.png&quot;, customClassLoader));</span>
<span class="nc" id="L246">            MESSAGE_THROW_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/message-throw.png&quot;, customClassLoader));</span>
<span class="nc" id="L247">            MESSAGE_CATCH_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/message.png&quot;, customClassLoader));</span>
<span class="nc" id="L248">            SIGNAL_THROW_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/signal-throw.png&quot;, customClassLoader));</span>
<span class="nc" id="L249">            SIGNAL_CATCH_IMAGE = ImageIO.read(ReflectUtil.getResource(&quot;org/flowable/icons/signal.png&quot;, customClassLoader));</span>
            
<span class="nc" id="L251">        } catch (IOException e) {</span>
<span class="nc" id="L252">            LOGGER.warn(&quot;Could not load image for process diagram creation: {}&quot;, e.getMessage());</span>
<span class="nc" id="L253">        }</span>
<span class="nc" id="L254">    }</span>

    /**
     * Generates an image of what currently is drawn on the canvas.
     * 
     * Throws an {@link FlowableImageException} when {@link #close()} is already called.
     */
    public InputStream generateImage(String imageType) {
<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (closed) {</span>
<span class="nc" id="L263">            throw new FlowableImageException(&quot;ProcessDiagramGenerator already closed&quot;);</span>
        }

<span class="nc" id="L266">        try (ByteArrayOutputStream out = new ByteArrayOutputStream()) {</span>
<span class="nc" id="L267">            ImageIO.write(processDiagram, imageType, out);</span>
<span class="nc" id="L268">            return new ByteArrayInputStream(out.toByteArray());</span>
<span class="nc" id="L269">        } catch (IOException e) {</span>
<span class="nc" id="L270">            throw new FlowableImageException(&quot;Error while generating process image&quot;, e);</span>
        }
    }

    /**
     * Generates an image of what currently is drawn on the canvas.
     * 
     * Throws an {@link FlowableImageException} when {@link #close()} is already called.
     */
    public BufferedImage generateBufferedImage(String imageType) {
<span class="nc bnc" id="L280" title="All 2 branches missed.">        if (closed) {</span>
<span class="nc" id="L281">            throw new FlowableImageException(&quot;ProcessDiagramGenerator already closed&quot;);</span>
        }

        // Try to remove white space
<span class="nc bnc" id="L285" title="All 2 branches missed.">        minX = (minX &lt;= 5) ? 5 : minX;</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">        minY = (minY &lt;= 5) ? 5 : minY;</span>
<span class="nc" id="L287">        BufferedImage imageToSerialize = processDiagram;</span>
<span class="nc" id="L288">        imageToSerialize = processDiagram.getSubimage(minX - 5, minY - 5, canvasWidth - minX + 5, canvasHeight - minY + 5);</span>
<span class="nc" id="L289">        return imageToSerialize;</span>
    }

    /**
     * Closes the canvas which disallows further drawing and releases graphical resources.
     */
    public void close() {
<span class="nc" id="L296">        g.dispose();</span>
<span class="nc" id="L297">        closed = true;</span>
<span class="nc" id="L298">    }</span>

    public void drawNoneStartEvent(GraphicInfo graphicInfo) {
<span class="nc" id="L301">        drawStartEvent(graphicInfo, null, 1.0);</span>
<span class="nc" id="L302">    }</span>

    public void drawTimerStartEvent(GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L305">        drawStartEvent(graphicInfo, TIMER_IMAGE, scaleFactor);</span>
<span class="nc" id="L306">    }</span>

    public void drawSignalStartEvent(GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L309">        drawStartEvent(graphicInfo, SIGNAL_CATCH_IMAGE, scaleFactor);</span>
<span class="nc" id="L310">    }</span>

    public void drawMessageStartEvent(GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L313">        drawStartEvent(graphicInfo, MESSAGE_CATCH_IMAGE, scaleFactor);</span>
<span class="nc" id="L314">    }</span>
    
    public void drawEventRegistryStartEvent(GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L317">        drawStartEvent(graphicInfo, MESSAGE_CATCH_IMAGE, scaleFactor);</span>
<span class="nc" id="L318">    }</span>

    public void drawStartEvent(GraphicInfo graphicInfo, BufferedImage image, double scaleFactor) {
<span class="nc" id="L321">        Paint originalPaint = g.getPaint();</span>
<span class="nc" id="L322">        g.setPaint(EVENT_COLOR);</span>
<span class="nc" id="L323">        Ellipse2D circle = new Ellipse2D.Double(graphicInfo.getX(), graphicInfo.getY(),</span>
<span class="nc" id="L324">                graphicInfo.getWidth(), graphicInfo.getHeight());</span>
<span class="nc" id="L325">        g.fill(circle);</span>
<span class="nc" id="L326">        g.setPaint(EVENT_BORDER_COLOR);</span>
<span class="nc" id="L327">        g.draw(circle);</span>
<span class="nc" id="L328">        g.setPaint(originalPaint);</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">        if (image != null) {</span>
            // calculate coordinates to center image
<span class="nc" id="L331">            int imageX = (int) Math.round(graphicInfo.getX() + (graphicInfo.getWidth() / 2) - (image.getWidth() / (2 * scaleFactor)));</span>
<span class="nc" id="L332">            int imageY = (int) Math.round(graphicInfo.getY() + (graphicInfo.getHeight() / 2) - (image.getHeight() / (2 * scaleFactor)));</span>
<span class="nc" id="L333">            g.drawImage(image, imageX, imageY,</span>
<span class="nc" id="L334">                    (int) (image.getWidth() / scaleFactor), (int) (image.getHeight() / scaleFactor), null);</span>
        }

<span class="nc" id="L337">    }</span>

    public void drawNoneEndEvent(GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L340">        Paint originalPaint = g.getPaint();</span>
<span class="nc" id="L341">        Stroke originalStroke = g.getStroke();</span>
<span class="nc" id="L342">        g.setPaint(EVENT_COLOR);</span>
<span class="nc" id="L343">        Ellipse2D circle = new Ellipse2D.Double(graphicInfo.getX(), graphicInfo.getY(),</span>
<span class="nc" id="L344">                graphicInfo.getWidth(), graphicInfo.getHeight());</span>
<span class="nc" id="L345">        g.fill(circle);</span>
<span class="nc" id="L346">        g.setPaint(EVENT_BORDER_COLOR);</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">        if (scaleFactor == 1.0) {</span>
<span class="nc" id="L348">            g.setStroke(END_EVENT_STROKE);</span>
        } else {
<span class="nc" id="L350">            g.setStroke(new BasicStroke(2.0f));</span>
        }
<span class="nc" id="L352">        g.draw(circle);</span>
<span class="nc" id="L353">        g.setStroke(originalStroke);</span>
<span class="nc" id="L354">        g.setPaint(originalPaint);</span>
<span class="nc" id="L355">    }</span>

    public void drawErrorEndEvent(String name, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L358">        drawErrorEndEvent(graphicInfo, scaleFactor);</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">        if (scaleFactor == 1.0) {</span>
<span class="nc" id="L360">            drawLabel(name, graphicInfo);</span>
        }
<span class="nc" id="L362">    }</span>
    
    public void drawEscalationEndEvent(String name, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L365">        drawEscalationEndEvent(graphicInfo, scaleFactor);</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">        if (scaleFactor == 1.0) {</span>
<span class="nc" id="L367">            drawLabel(name, graphicInfo);</span>
        }
<span class="nc" id="L369">    }</span>

    public void drawErrorEndEvent(GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L372">        drawNoneEndEvent(graphicInfo, scaleFactor);</span>
<span class="nc" id="L373">        g.drawImage(ERROR_THROW_IMAGE, (int) (graphicInfo.getX() + (graphicInfo.getWidth() / 4)),</span>
<span class="nc" id="L374">                (int) (graphicInfo.getY() + (graphicInfo.getHeight() / 4)),</span>
<span class="nc" id="L375">                (int) (ERROR_THROW_IMAGE.getWidth() / scaleFactor),</span>
<span class="nc" id="L376">                (int) (ERROR_THROW_IMAGE.getHeight() / scaleFactor), null);</span>
<span class="nc" id="L377">    }</span>
    
    public void drawEscalationEndEvent(GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L380">        drawNoneEndEvent(graphicInfo, scaleFactor);</span>
<span class="nc" id="L381">        g.drawImage(ESCALATION_THROW_IMAGE, (int) (graphicInfo.getX() + (graphicInfo.getWidth() / 4)),</span>
<span class="nc" id="L382">                (int) (graphicInfo.getY() + (graphicInfo.getHeight() / 4)),</span>
<span class="nc" id="L383">                (int) (ESCALATION_THROW_IMAGE.getWidth() / scaleFactor),</span>
<span class="nc" id="L384">                (int) (ESCALATION_THROW_IMAGE.getHeight() / scaleFactor), null);</span>
<span class="nc" id="L385">    }</span>

    public void drawErrorStartEvent(GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L388">        drawNoneStartEvent(graphicInfo);</span>
<span class="nc" id="L389">        g.drawImage(ERROR_CATCH_IMAGE, (int) (graphicInfo.getX() + (graphicInfo.getWidth() / 4)),</span>
<span class="nc" id="L390">                (int) (graphicInfo.getY() + (graphicInfo.getHeight() / 4)),</span>
<span class="nc" id="L391">                (int) (ERROR_CATCH_IMAGE.getWidth() / scaleFactor),</span>
<span class="nc" id="L392">                (int) (ERROR_CATCH_IMAGE.getHeight() / scaleFactor), null);</span>
<span class="nc" id="L393">    }</span>
    
    public void drawEscalationStartEvent(GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L396">        drawNoneStartEvent(graphicInfo);</span>
<span class="nc" id="L397">        g.drawImage(ESCALATION_CATCH_IMAGE, (int) (graphicInfo.getX() + (graphicInfo.getWidth() / 4)),</span>
<span class="nc" id="L398">                (int) (graphicInfo.getY() + (graphicInfo.getHeight() / 4)),</span>
<span class="nc" id="L399">                (int) (ESCALATION_CATCH_IMAGE.getWidth() / scaleFactor),</span>
<span class="nc" id="L400">                (int) (ESCALATION_CATCH_IMAGE.getHeight() / scaleFactor), null);</span>
<span class="nc" id="L401">    }</span>
    
    public void drawConditionalStartEvent(GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L404">        drawNoneStartEvent(graphicInfo);</span>
<span class="nc" id="L405">        g.drawImage(CONDITIONAL_CATCH_IMAGE, (int) (graphicInfo.getX() + (graphicInfo.getWidth() / 4)),</span>
<span class="nc" id="L406">                (int) (graphicInfo.getY() + (graphicInfo.getHeight() / 4)),</span>
<span class="nc" id="L407">                (int) (CONDITIONAL_CATCH_IMAGE.getWidth() / scaleFactor),</span>
<span class="nc" id="L408">                (int) (CONDITIONAL_CATCH_IMAGE.getHeight() / scaleFactor), null);</span>
<span class="nc" id="L409">    }</span>

    public void drawCatchingEvent(GraphicInfo graphicInfo, boolean isInterrupting,
            BufferedImage image, String eventType, double scaleFactor) {

        // event circles
<span class="nc" id="L415">        Ellipse2D outerCircle = new Ellipse2D.Double(graphicInfo.getX(), graphicInfo.getY(),</span>
<span class="nc" id="L416">                graphicInfo.getWidth(), graphicInfo.getHeight());</span>
<span class="nc" id="L417">        int innerCircleSize = (int) (2 / scaleFactor);</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">        if (innerCircleSize == 0) {</span>
<span class="nc" id="L419">            innerCircleSize = 1;</span>
        }
        
<span class="nc" id="L422">        int innerCircleX = (int) graphicInfo.getX() + innerCircleSize;</span>
<span class="nc" id="L423">        int innerCircleY = (int) graphicInfo.getY() + innerCircleSize;</span>
<span class="nc" id="L424">        int innerCircleWidth = (int) graphicInfo.getWidth() - (2 * innerCircleSize);</span>
<span class="nc" id="L425">        int innerCircleHeight = (int) graphicInfo.getHeight() - (2 * innerCircleSize);</span>
<span class="nc" id="L426">        Ellipse2D innerCircle = new Ellipse2D.Double(innerCircleX, innerCircleY, innerCircleWidth, innerCircleHeight);</span>

<span class="nc" id="L428">        Paint originalPaint = g.getPaint();</span>
<span class="nc" id="L429">        Stroke originalStroke = g.getStroke();</span>
<span class="nc" id="L430">        g.setPaint(EVENT_COLOR);</span>
<span class="nc" id="L431">        g.fill(outerCircle);</span>

<span class="nc" id="L433">        g.setPaint(EVENT_BORDER_COLOR);</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">        if (!isInterrupting) {</span>
<span class="nc" id="L435">            g.setStroke(NON_INTERRUPTING_EVENT_STROKE);</span>
        }
        
<span class="nc" id="L438">        g.draw(outerCircle);</span>
<span class="nc" id="L439">        g.setStroke(originalStroke);</span>
<span class="nc" id="L440">        g.setPaint(originalPaint);</span>
<span class="nc" id="L441">        g.draw(innerCircle);</span>

<span class="nc bnc" id="L443" title="All 2 branches missed.">        if (image != null) {</span>
            // calculate coordinates to center image
<span class="nc" id="L445">            int imageX = (int) (graphicInfo.getX() + (graphicInfo.getWidth() / 2) - (image.getWidth() / (2 * scaleFactor)));</span>
<span class="nc" id="L446">            int imageY = (int) (graphicInfo.getY() + (graphicInfo.getHeight() / 2) - (image.getHeight() / (2 * scaleFactor)));</span>
<span class="nc bnc" id="L447" title="All 4 branches missed.">            if (scaleFactor == 1.0 &amp;&amp; &quot;timer&quot;.equals(eventType)) {</span>
                // move image one pixel to center timer image
<span class="nc" id="L449">                imageX++;</span>
<span class="nc" id="L450">                imageY++;</span>
            }
            
<span class="nc" id="L453">            g.drawImage(image, imageX, imageY, (int) (image.getWidth() / scaleFactor),</span>
<span class="nc" id="L454">                    (int) (image.getHeight() / scaleFactor), null);</span>
        }
<span class="nc" id="L456">    }</span>

    public void drawCatchingCompensateEvent(String name, GraphicInfo graphicInfo, boolean isInterrupting, double scaleFactor) {
<span class="nc" id="L459">        drawCatchingCompensateEvent(graphicInfo, isInterrupting, scaleFactor);</span>
<span class="nc" id="L460">        drawLabel(name, graphicInfo);</span>
<span class="nc" id="L461">    }</span>

    public void drawCatchingCompensateEvent(GraphicInfo graphicInfo, boolean isInterrupting, double scaleFactor) {
<span class="nc" id="L464">        drawCatchingEvent(graphicInfo, isInterrupting, COMPENSATE_CATCH_IMAGE, &quot;compensate&quot;, scaleFactor);</span>
<span class="nc" id="L465">    }</span>
    
    public void drawCatchingConditionalEvent(String name, GraphicInfo graphicInfo, boolean isInterrupting, double scaleFactor) {
<span class="nc" id="L468">        drawCatchingConditionalEvent(graphicInfo, isInterrupting, scaleFactor);</span>
<span class="nc" id="L469">        drawLabel(name, graphicInfo);</span>
<span class="nc" id="L470">    }</span>
    
    public void drawCatchingConditionalEvent(GraphicInfo graphicInfo, boolean isInterrupting, double scaleFactor) {
<span class="nc" id="L473">        drawCatchingEvent(graphicInfo, isInterrupting, CONDITIONAL_CATCH_IMAGE, &quot;conditional&quot;, scaleFactor);</span>
<span class="nc" id="L474">    }</span>

    public void drawCatchingTimerEvent(String name, GraphicInfo graphicInfo, boolean isInterrupting, double scaleFactor) {
<span class="nc" id="L477">        drawCatchingTimerEvent(graphicInfo, isInterrupting, scaleFactor);</span>
<span class="nc" id="L478">        drawLabel(name, graphicInfo);</span>
<span class="nc" id="L479">    }</span>

    public void drawCatchingTimerEvent(GraphicInfo graphicInfo, boolean isInterrupting, double scaleFactor) {
<span class="nc" id="L482">        drawCatchingEvent(graphicInfo, isInterrupting, TIMER_IMAGE, &quot;timer&quot;, scaleFactor);</span>
<span class="nc" id="L483">    }</span>

    public void drawCatchingErrorEvent(String name, GraphicInfo graphicInfo, boolean isInterrupting, double scaleFactor) {
<span class="nc" id="L486">        drawCatchingErrorEvent(graphicInfo, isInterrupting, scaleFactor);</span>
<span class="nc" id="L487">        drawLabel(name, graphicInfo);</span>
<span class="nc" id="L488">    }</span>

    public void drawCatchingErrorEvent(GraphicInfo graphicInfo, boolean isInterrupting, double scaleFactor) {
<span class="nc" id="L491">        drawCatchingEvent(graphicInfo, isInterrupting, ERROR_CATCH_IMAGE, &quot;error&quot;, scaleFactor);</span>
<span class="nc" id="L492">    }</span>
    
    public void drawCatchingEscalationEvent(GraphicInfo graphicInfo, boolean isInterrupting, double scaleFactor) {
<span class="nc" id="L495">        drawCatchingEvent(graphicInfo, isInterrupting, ESCALATION_CATCH_IMAGE, &quot;escalation&quot;, scaleFactor);</span>
<span class="nc" id="L496">    }</span>

    public void drawCatchingSignalEvent(String name, GraphicInfo graphicInfo, boolean isInterrupting, double scaleFactor) {
<span class="nc" id="L499">        drawCatchingSignalEvent(graphicInfo, isInterrupting, scaleFactor);</span>
<span class="nc" id="L500">        drawLabel(name, graphicInfo);</span>
<span class="nc" id="L501">    }</span>

    public void drawCatchingSignalEvent(GraphicInfo graphicInfo, boolean isInterrupting, double scaleFactor) {
<span class="nc" id="L504">        drawCatchingEvent(graphicInfo, isInterrupting, SIGNAL_CATCH_IMAGE, &quot;signal&quot;, scaleFactor);</span>
<span class="nc" id="L505">    }</span>

    public void drawCatchingMessageEvent(GraphicInfo graphicInfo, boolean isInterrupting, double scaleFactor) {
<span class="nc" id="L508">        drawCatchingEvent(graphicInfo, isInterrupting, MESSAGE_CATCH_IMAGE, &quot;message&quot;, scaleFactor);</span>
<span class="nc" id="L509">    }</span>
    
    public void drawCatchingEventRegistryEvent(GraphicInfo graphicInfo, boolean isInterrupting, double scaleFactor) {
<span class="nc" id="L512">        drawCatchingEvent(graphicInfo, isInterrupting, MESSAGE_CATCH_IMAGE, &quot;message&quot;, scaleFactor);</span>
<span class="nc" id="L513">    }</span>

    public void drawCatchingMessageEvent(String name, GraphicInfo graphicInfo, boolean isInterrupting, double scaleFactor) {
<span class="nc" id="L516">        drawCatchingEvent(graphicInfo, isInterrupting, MESSAGE_CATCH_IMAGE, &quot;message&quot;, scaleFactor);</span>
<span class="nc" id="L517">        drawLabel(name, graphicInfo);</span>
<span class="nc" id="L518">    }</span>
    
    public void drawCatchingEventRegistryEvent(String name, GraphicInfo graphicInfo, boolean isInterrupting, double scaleFactor) {
<span class="nc" id="L521">        drawCatchingEvent(graphicInfo, isInterrupting, MESSAGE_CATCH_IMAGE, &quot;message&quot;, scaleFactor);</span>
<span class="nc" id="L522">        drawLabel(name, graphicInfo);</span>
<span class="nc" id="L523">    }</span>

    public void drawThrowingCompensateEvent(GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L526">        drawCatchingEvent(graphicInfo, true, COMPENSATE_THROW_IMAGE, &quot;compensate&quot;, scaleFactor);</span>
<span class="nc" id="L527">    }</span>

    public void drawThrowingSignalEvent(GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L530">        drawCatchingEvent(graphicInfo, true, SIGNAL_THROW_IMAGE, &quot;signal&quot;, scaleFactor);</span>
<span class="nc" id="L531">    }</span>
    
    public void drawThrowingEscalationEvent(GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L534">        drawCatchingEvent(graphicInfo, true, ESCALATION_THROW_IMAGE, &quot;escalation&quot;, scaleFactor);</span>
<span class="nc" id="L535">    }</span>

    public void drawThrowingNoneEvent(GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L538">        drawCatchingEvent(graphicInfo, true, null, &quot;none&quot;, scaleFactor);</span>
<span class="nc" id="L539">    }</span>

    public void drawSequenceflow(int srcX, int srcY, int targetX, int targetY, boolean conditional, double scaleFactor) {
<span class="nc" id="L542">        drawSequenceflow(srcX, srcY, targetX, targetY, conditional, false, scaleFactor);</span>
<span class="nc" id="L543">    }</span>

    public void drawSequenceflow(int srcX, int srcY, int targetX, int targetY, boolean conditional, boolean highLighted, double scaleFactor) {
<span class="nc" id="L546">        Paint originalPaint = g.getPaint();</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">        if (highLighted) {</span>
<span class="nc" id="L548">            g.setPaint(HIGHLIGHT_COLOR);</span>
        }

<span class="nc" id="L551">        Line2D.Double line = new Line2D.Double(srcX, srcY, targetX, targetY);</span>
<span class="nc" id="L552">        g.draw(line);</span>
<span class="nc" id="L553">        drawArrowHead(line, scaleFactor);</span>

<span class="nc bnc" id="L555" title="All 2 branches missed.">        if (conditional) {</span>
<span class="nc" id="L556">            drawConditionalSequenceFlowIndicator(line, scaleFactor);</span>
        }

<span class="nc bnc" id="L559" title="All 2 branches missed.">        if (highLighted) {</span>
<span class="nc" id="L560">            g.setPaint(originalPaint);</span>
        }
<span class="nc" id="L562">    }</span>

    public void drawAssociation(int[] xPoints, int[] yPoints, AssociationDirection associationDirection, boolean highLighted, double scaleFactor) {
<span class="nc" id="L565">        boolean conditional = false;</span>
<span class="nc" id="L566">        boolean isDefault = false;</span>
<span class="nc" id="L567">        drawConnection(xPoints, yPoints, conditional, isDefault, &quot;association&quot;, associationDirection, highLighted, scaleFactor);</span>
<span class="nc" id="L568">    }</span>

    public void drawSequenceflow(int[] xPoints, int[] yPoints, boolean conditional, boolean isDefault, boolean highLighted, double scaleFactor) {
<span class="nc" id="L571">        drawConnection(xPoints, yPoints, conditional, isDefault, &quot;sequenceFlow&quot;, AssociationDirection.ONE, highLighted, scaleFactor);</span>
<span class="nc" id="L572">    }</span>

    public void drawConnection(int[] xPoints, int[] yPoints, boolean conditional, boolean isDefault, String connectionType,
            AssociationDirection associationDirection, boolean highLighted, double scaleFactor) {

<span class="nc" id="L577">        Paint originalPaint = g.getPaint();</span>
<span class="nc" id="L578">        Stroke originalStroke = g.getStroke();</span>

<span class="nc" id="L580">        g.setPaint(CONNECTION_COLOR);</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">        if (&quot;association&quot;.equals(connectionType)) {</span>
<span class="nc" id="L582">            g.setStroke(ASSOCIATION_STROKE);</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">        } else if (highLighted) {</span>
<span class="nc" id="L584">            g.setPaint(HIGHLIGHT_COLOR);</span>
<span class="nc" id="L585">            g.setStroke(HIGHLIGHT_FLOW_STROKE);</span>
        }

<span class="nc bnc" id="L588" title="All 2 branches missed.">        for (int i = 1; i &lt; xPoints.length; i++) {</span>
<span class="nc" id="L589">            int sourceX = xPoints[i - 1];</span>
<span class="nc" id="L590">            int sourceY = yPoints[i - 1];</span>
<span class="nc" id="L591">            int targetX = xPoints[i];</span>
<span class="nc" id="L592">            int targetY = yPoints[i];</span>
<span class="nc" id="L593">            Line2D.Double line = new Line2D.Double(sourceX, sourceY, targetX, targetY);</span>
<span class="nc" id="L594">            g.draw(line);</span>
        }

<span class="nc bnc" id="L597" title="All 2 branches missed.">        if (isDefault) {</span>
<span class="nc" id="L598">            Line2D.Double line = new Line2D.Double(xPoints[0], yPoints[0], xPoints[1], yPoints[1]);</span>
<span class="nc" id="L599">            drawDefaultSequenceFlowIndicator(line, scaleFactor);</span>
        }

<span class="nc bnc" id="L602" title="All 2 branches missed.">        if (conditional) {</span>
<span class="nc" id="L603">            Line2D.Double line = new Line2D.Double(xPoints[0], yPoints[0], xPoints[1], yPoints[1]);</span>
<span class="nc" id="L604">            drawConditionalSequenceFlowIndicator(line, scaleFactor);</span>
        }

<span class="nc bnc" id="L607" title="All 4 branches missed.">        if (associationDirection == AssociationDirection.ONE || associationDirection == AssociationDirection.BOTH) {</span>
<span class="nc" id="L608">            Line2D.Double line = new Line2D.Double(xPoints[xPoints.length - 2], yPoints[xPoints.length - 2], xPoints[xPoints.length - 1], yPoints[xPoints.length - 1]);</span>
<span class="nc" id="L609">            drawArrowHead(line, scaleFactor);</span>
        }
<span class="nc bnc" id="L611" title="All 2 branches missed.">        if (associationDirection == AssociationDirection.BOTH) {</span>
<span class="nc" id="L612">            Line2D.Double line = new Line2D.Double(xPoints[1], yPoints[1], xPoints[0], yPoints[0]);</span>
<span class="nc" id="L613">            drawArrowHead(line, scaleFactor);</span>
        }
<span class="nc" id="L615">        g.setPaint(originalPaint);</span>
<span class="nc" id="L616">        g.setStroke(originalStroke);</span>
<span class="nc" id="L617">    }</span>

    public void drawSequenceflowWithoutArrow(int srcX, int srcY, int targetX, int targetY, boolean conditional, double scaleFactor) {
<span class="nc" id="L620">        drawSequenceflowWithoutArrow(srcX, srcY, targetX, targetY, conditional, false, scaleFactor);</span>
<span class="nc" id="L621">    }</span>

    public void drawSequenceflowWithoutArrow(int srcX, int srcY, int targetX, int targetY, boolean conditional, boolean highLighted, double scaleFactor) {
<span class="nc" id="L624">        Paint originalPaint = g.getPaint();</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">        if (highLighted) {</span>
<span class="nc" id="L626">            g.setPaint(HIGHLIGHT_COLOR);</span>
        }

<span class="nc" id="L629">        Line2D.Double line = new Line2D.Double(srcX, srcY, targetX, targetY);</span>
<span class="nc" id="L630">        g.draw(line);</span>

<span class="nc bnc" id="L632" title="All 2 branches missed.">        if (conditional) {</span>
<span class="nc" id="L633">            drawConditionalSequenceFlowIndicator(line, scaleFactor);</span>
        }

<span class="nc bnc" id="L636" title="All 2 branches missed.">        if (highLighted) {</span>
<span class="nc" id="L637">            g.setPaint(originalPaint);</span>
        }
<span class="nc" id="L639">    }</span>

    public void drawArrowHead(Line2D.Double line, double scaleFactor) {
<span class="nc" id="L642">        int doubleArrowWidth = (int) (2 * ARROW_WIDTH / scaleFactor);</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">        if (doubleArrowWidth == 0) {</span>
<span class="nc" id="L644">            doubleArrowWidth = 2;</span>
        }
<span class="nc" id="L646">        Polygon arrowHead = new Polygon();</span>
<span class="nc" id="L647">        arrowHead.addPoint(0, 0);</span>
<span class="nc" id="L648">        int arrowHeadPoint = (int) (-ARROW_WIDTH / scaleFactor);</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">        if (arrowHeadPoint == 0) {</span>
<span class="nc" id="L650">            arrowHeadPoint = -1;</span>
        }
<span class="nc" id="L652">        arrowHead.addPoint(arrowHeadPoint, -doubleArrowWidth);</span>
<span class="nc" id="L653">        arrowHeadPoint = (int) (ARROW_WIDTH / scaleFactor);</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">        if (arrowHeadPoint == 0) {</span>
<span class="nc" id="L655">            arrowHeadPoint = 1;</span>
        }
<span class="nc" id="L657">        arrowHead.addPoint(arrowHeadPoint, -doubleArrowWidth);</span>

<span class="nc" id="L659">        AffineTransform transformation = new AffineTransform();</span>
<span class="nc" id="L660">        transformation.setToIdentity();</span>
<span class="nc" id="L661">        double angle = Math.atan2(line.y2 - line.y1, line.x2 - line.x1);</span>
<span class="nc" id="L662">        transformation.translate(line.x2, line.y2);</span>
<span class="nc" id="L663">        transformation.rotate((angle - Math.PI / 2d));</span>

<span class="nc" id="L665">        AffineTransform originalTransformation = g.getTransform();</span>
<span class="nc" id="L666">        g.setTransform(transformation);</span>
<span class="nc" id="L667">        g.fill(arrowHead);</span>
<span class="nc" id="L668">        g.setTransform(originalTransformation);</span>
<span class="nc" id="L669">    }</span>

    public void drawDefaultSequenceFlowIndicator(Line2D.Double line, double scaleFactor) {
<span class="nc" id="L672">        double length = DEFAULT_INDICATOR_WIDTH / scaleFactor;</span>
<span class="nc" id="L673">        double halfOfLength = length / 2;</span>
<span class="nc" id="L674">        double f = 8;</span>
<span class="nc" id="L675">        Line2D.Double defaultIndicator = new Line2D.Double(-halfOfLength, 0, halfOfLength, 0);</span>

<span class="nc" id="L677">        double angle = Math.atan2(line.y2 - line.y1, line.x2 - line.x1);</span>
<span class="nc" id="L678">        double dx = f * Math.cos(angle);</span>
<span class="nc" id="L679">        double dy = f * Math.sin(angle);</span>
<span class="nc" id="L680">        double x1 = line.x1 + dx;</span>
<span class="nc" id="L681">        double y1 = line.y1 + dy;</span>

<span class="nc" id="L683">        AffineTransform transformation = new AffineTransform();</span>
<span class="nc" id="L684">        transformation.setToIdentity();</span>
<span class="nc" id="L685">        transformation.translate(x1, y1);</span>
<span class="nc" id="L686">        transformation.rotate((angle - 3 * Math.PI / 4));</span>

<span class="nc" id="L688">        AffineTransform originalTransformation = g.getTransform();</span>
<span class="nc" id="L689">        g.setTransform(transformation);</span>
<span class="nc" id="L690">        g.draw(defaultIndicator);</span>

<span class="nc" id="L692">        g.setTransform(originalTransformation);</span>
<span class="nc" id="L693">    }</span>

    public void drawConditionalSequenceFlowIndicator(Line2D.Double line, double scaleFactor) {
<span class="nc bnc" id="L696" title="All 2 branches missed.">        if (scaleFactor &gt; 1.0) {</span>
<span class="nc" id="L697">            return;</span>
        }
<span class="nc" id="L699">        int horizontal = (int) (CONDITIONAL_INDICATOR_WIDTH * 0.7);</span>
<span class="nc" id="L700">        int halfOfHorizontal = horizontal / 2;</span>
<span class="nc" id="L701">        int halfOfVertical = CONDITIONAL_INDICATOR_WIDTH / 2;</span>

<span class="nc" id="L703">        Polygon conditionalIndicator = new Polygon();</span>
<span class="nc" id="L704">        conditionalIndicator.addPoint(0, 0);</span>
<span class="nc" id="L705">        conditionalIndicator.addPoint(-halfOfHorizontal, halfOfVertical);</span>
<span class="nc" id="L706">        conditionalIndicator.addPoint(0, CONDITIONAL_INDICATOR_WIDTH);</span>
<span class="nc" id="L707">        conditionalIndicator.addPoint(halfOfHorizontal, halfOfVertical);</span>

<span class="nc" id="L709">        AffineTransform transformation = new AffineTransform();</span>
<span class="nc" id="L710">        transformation.setToIdentity();</span>
<span class="nc" id="L711">        double angle = Math.atan2(line.y2 - line.y1, line.x2 - line.x1);</span>
<span class="nc" id="L712">        transformation.translate(line.x1, line.y1);</span>
<span class="nc" id="L713">        transformation.rotate((angle - Math.PI / 2d));</span>

<span class="nc" id="L715">        AffineTransform originalTransformation = g.getTransform();</span>
<span class="nc" id="L716">        g.setTransform(transformation);</span>
<span class="nc" id="L717">        g.draw(conditionalIndicator);</span>

<span class="nc" id="L719">        Paint originalPaint = g.getPaint();</span>
<span class="nc" id="L720">        g.setPaint(CONDITIONAL_INDICATOR_COLOR);</span>
<span class="nc" id="L721">        g.fill(conditionalIndicator);</span>

<span class="nc" id="L723">        g.setPaint(originalPaint);</span>
<span class="nc" id="L724">        g.setTransform(originalTransformation);</span>
<span class="nc" id="L725">    }</span>

    public void drawTask(BufferedImage icon, String name, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L728">        drawTask(name, graphicInfo, scaleFactor);</span>
<span class="nc" id="L729">        g.drawImage(icon, (int) (graphicInfo.getX() + ICON_PADDING / scaleFactor),</span>
<span class="nc" id="L730">                (int) (graphicInfo.getY() + ICON_PADDING / scaleFactor),</span>
<span class="nc" id="L731">                (int) (icon.getWidth() / scaleFactor), (int) (icon.getHeight() / scaleFactor), null);</span>
<span class="nc" id="L732">    }</span>

    public void drawTask(String name, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L735">        drawTask(name, graphicInfo, false, scaleFactor);</span>
<span class="nc" id="L736">    }</span>

    public void drawPoolOrLane(String name, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L739">        int x = (int) graphicInfo.getX();</span>
<span class="nc" id="L740">        int y = (int) graphicInfo.getY();</span>
<span class="nc" id="L741">        int width = (int) graphicInfo.getWidth();</span>
<span class="nc" id="L742">        int height = (int) graphicInfo.getHeight();</span>
<span class="nc" id="L743">        g.drawRect(x, y, width, height);</span>

        // Add the name as text, vertical
<span class="nc bnc" id="L746" title="All 6 branches missed.">        if (scaleFactor == 1.0 &amp;&amp; name != null &amp;&amp; name.length() &gt; 0) {</span>
            // Include some padding
<span class="nc" id="L748">            int availableTextSpace = height - 6;</span>

            // Create rotation for derived font
<span class="nc" id="L751">            AffineTransform transformation = new AffineTransform();</span>
<span class="nc" id="L752">            transformation.setToIdentity();</span>
<span class="nc" id="L753">            transformation.rotate(270 * Math.PI / 180);</span>

<span class="nc" id="L755">            Font currentFont = g.getFont();</span>
<span class="nc" id="L756">            Font theDerivedFont = currentFont.deriveFont(transformation);</span>
<span class="nc" id="L757">            g.setFont(theDerivedFont);</span>

<span class="nc" id="L759">            String truncated = fitTextToWidth(name, availableTextSpace);</span>
<span class="nc" id="L760">            int realWidth = fontMetrics.stringWidth(truncated);</span>

<span class="nc" id="L762">            g.drawString(truncated, x + 2 + fontMetrics.getHeight(), 3 + y + availableTextSpace - (availableTextSpace - realWidth) / 2);</span>
<span class="nc" id="L763">            g.setFont(currentFont);</span>
        }
<span class="nc" id="L765">    }</span>

    protected void drawTask(String name, GraphicInfo graphicInfo, boolean thickBorder, double scaleFactor) {
<span class="nc" id="L768">        Paint originalPaint = g.getPaint();</span>
<span class="nc" id="L769">        int x = (int) graphicInfo.getX();</span>
<span class="nc" id="L770">        int y = (int) graphicInfo.getY();</span>
<span class="nc" id="L771">        int width = (int) graphicInfo.getWidth();</span>
<span class="nc" id="L772">        int height = (int) graphicInfo.getHeight();</span>

        // Create a new gradient paint for every task box, gradient depends on x and y and is not relative
<span class="nc" id="L775">        g.setPaint(TASK_BOX_COLOR);</span>

<span class="nc" id="L777">        int arcR = 6;</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">        if (thickBorder) {</span>
<span class="nc" id="L779">            arcR = 3;</span>
        }

        // shape
<span class="nc" id="L783">        RoundRectangle2D rect = new RoundRectangle2D.Double(x, y, width, height, arcR, arcR);</span>
<span class="nc" id="L784">        g.fill(rect);</span>
<span class="nc" id="L785">        g.setPaint(TASK_BORDER_COLOR);</span>

<span class="nc bnc" id="L787" title="All 2 branches missed.">        if (thickBorder) {</span>
<span class="nc" id="L788">            Stroke originalStroke = g.getStroke();</span>
<span class="nc" id="L789">            g.setStroke(THICK_TASK_BORDER_STROKE);</span>
<span class="nc" id="L790">            g.draw(rect);</span>
<span class="nc" id="L791">            g.setStroke(originalStroke);</span>
<span class="nc" id="L792">        } else {</span>
<span class="nc" id="L793">            g.draw(rect);</span>
        }

<span class="nc" id="L796">        g.setPaint(originalPaint);</span>
        // text
<span class="nc bnc" id="L798" title="All 6 branches missed.">        if (scaleFactor == 1.0 &amp;&amp; name != null &amp;&amp; name.length() &gt; 0) {</span>
<span class="nc" id="L799">            int boxWidth = width - (2 * TEXT_PADDING);</span>
<span class="nc" id="L800">            int boxHeight = height - 16 - ICON_PADDING - ICON_PADDING - MARKER_WIDTH - 2 - 2;</span>
<span class="nc" id="L801">            int boxX = x + width / 2 - boxWidth / 2;</span>
<span class="nc" id="L802">            int boxY = y + height / 2 - boxHeight / 2 + ICON_PADDING + ICON_PADDING - 2 - 2;</span>

<span class="nc" id="L804">            drawMultilineCentredText(name, boxX, boxY, boxWidth, boxHeight);</span>
        }
<span class="nc" id="L806">    }</span>

    protected void drawMultilineCentredText(String text, int x, int y, int boxWidth, int boxHeight) {
<span class="nc" id="L809">        drawMultilineText(text, x, y, boxWidth, boxHeight, true);</span>
<span class="nc" id="L810">    }</span>

    protected void drawMultilineAnnotationText(String text, int x, int y, int boxWidth, int boxHeight) {
<span class="nc" id="L813">        drawMultilineText(text, x, y, boxWidth, boxHeight, false);</span>
<span class="nc" id="L814">    }</span>

    protected void drawMultilineText(String text, int x, int y, int boxWidth, int boxHeight, boolean centered) {
        // Create an attributed string based in input text
<span class="nc" id="L818">        AttributedString attributedString = new AttributedString(text);</span>
<span class="nc" id="L819">        attributedString.addAttribute(TextAttribute.FONT, g.getFont());</span>
<span class="nc" id="L820">        attributedString.addAttribute(TextAttribute.FOREGROUND, Color.black);</span>

<span class="nc" id="L822">        AttributedCharacterIterator characterIterator = attributedString.getIterator();</span>

<span class="nc" id="L824">        int currentHeight = 0;</span>
        // Prepare a list of lines of text we'll be drawing
<span class="nc" id="L826">        List&lt;TextLayout&gt; layouts = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L827">        String lastLine = null;</span>

<span class="nc" id="L829">        LineBreakMeasurer measurer = new LineBreakMeasurer(characterIterator, g.getFontRenderContext());</span>

<span class="nc" id="L831">        TextLayout layout = null;</span>
<span class="nc bnc" id="L832" title="All 4 branches missed.">        while (measurer.getPosition() &lt; characterIterator.getEndIndex() &amp;&amp; currentHeight &lt;= boxHeight) {</span>

<span class="nc" id="L834">            int previousPosition = measurer.getPosition();</span>

            // Request next layout
<span class="nc" id="L837">            layout = measurer.nextLayout(boxWidth);</span>

<span class="nc" id="L839">            int height = ((Float) (layout.getDescent() + layout.getAscent() + layout.getLeading())).intValue();</span>

<span class="nc bnc" id="L841" title="All 2 branches missed.">            if (currentHeight + height &gt; boxHeight) {</span>
                // The line we're about to add should NOT be added anymore, append three dots to previous one instead
                // to indicate more text is truncated
<span class="nc bnc" id="L844" title="All 2 branches missed.">                if (!layouts.isEmpty()) {</span>
<span class="nc" id="L845">                    layouts.remove(layouts.size() - 1);</span>

<span class="nc bnc" id="L847" title="All 2 branches missed.">                    if (lastLine.length() &gt;= 4) {</span>
<span class="nc" id="L848">                        lastLine = lastLine.substring(0, lastLine.length() - 4) + &quot;...&quot;;</span>
                    }
<span class="nc" id="L850">                    layouts.add(new TextLayout(lastLine, g.getFont(), g.getFontRenderContext()));</span>
                } else {
                    // at least, draw one line even if text does not fit in order to avoid empty box
<span class="nc" id="L853">                    layouts.add(layout);</span>
<span class="nc" id="L854">                    currentHeight += height;</span>
                }
<span class="nc" id="L856">                break;</span>
                
            } else {
<span class="nc" id="L859">                layouts.add(layout);</span>
<span class="nc" id="L860">                lastLine = text.substring(previousPosition, measurer.getPosition());</span>
<span class="nc" id="L861">                currentHeight += height;</span>
            }
<span class="nc" id="L863">        }</span>

<span class="nc bnc" id="L865" title="All 2 branches missed.">        float currentY = y + (centered ? ((boxHeight - currentHeight) / 2) : 0);</span>
<span class="nc" id="L866">        float currentX = 0;</span>

        // Actually draw the lines
<span class="nc bnc" id="L869" title="All 2 branches missed.">        for (TextLayout textLayout : layouts) {</span>

<span class="nc" id="L871">            currentY += textLayout.getAscent();</span>
<span class="nc bnc" id="L872" title="All 2 branches missed.">            currentX = x + (centered ? ((boxWidth - ((Double) textLayout.getBounds().getWidth()).floatValue()) / 2) : 0);</span>

<span class="nc" id="L874">            textLayout.draw(g, currentX, currentY);</span>
<span class="nc" id="L875">            currentY += textLayout.getDescent() + textLayout.getLeading();</span>
<span class="nc" id="L876">        }</span>

<span class="nc" id="L878">    }</span>

    protected String fitTextToWidth(String original, int width) {
<span class="nc" id="L881">        String text = original;</span>

        // remove length for &quot;...&quot;
<span class="nc" id="L884">        int maxWidth = width - 10;</span>

<span class="nc bnc" id="L886" title="All 4 branches missed.">        while (fontMetrics.stringWidth(text + &quot;...&quot;) &gt; maxWidth &amp;&amp; text.length() &gt; 0) {</span>
<span class="nc" id="L887">            text = text.substring(0, text.length() - 1);</span>
        }

<span class="nc bnc" id="L890" title="All 2 branches missed.">        if (!text.equals(original)) {</span>
<span class="nc" id="L891">            text = text + &quot;...&quot;;</span>
        }

<span class="nc" id="L894">        return text;</span>
    }

    public void drawUserTask(String name, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L898">        drawTask(USERTASK_IMAGE, name, graphicInfo, scaleFactor);</span>
<span class="nc" id="L899">    }</span>

    public void drawScriptTask(String name, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L902">        drawTask(SCRIPTTASK_IMAGE, name, graphicInfo, scaleFactor);</span>
<span class="nc" id="L903">    }</span>

    public void drawServiceTask(String name, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L906">        drawTask(SERVICETASK_IMAGE, name, graphicInfo, scaleFactor);</span>
<span class="nc" id="L907">    }</span>

    public void drawReceiveTask(String name, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L910">        drawTask(RECEIVETASK_IMAGE, name, graphicInfo, scaleFactor);</span>
<span class="nc" id="L911">    }</span>

    public void drawSendTask(String name, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L914">        drawTask(SENDTASK_IMAGE, name, graphicInfo, scaleFactor);</span>
<span class="nc" id="L915">    }</span>

    public void drawManualTask(String name, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L918">        drawTask(MANUALTASK_IMAGE, name, graphicInfo, scaleFactor);</span>
<span class="nc" id="L919">    }</span>
    
    public void drawSendEventServiceTask(String name, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L922">        drawTask(SENDTASK_IMAGE, name, graphicInfo, scaleFactor);</span>
<span class="nc" id="L923">    }</span>
    
    public void drawCaseServiceTask(String name, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L926">        drawTask(CASETASK_IMAGE, name, graphicInfo, scaleFactor);</span>
<span class="nc" id="L927">    }</span>

    public void drawBusinessRuleTask(String name, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L930">        drawTask(BUSINESS_RULE_TASK_IMAGE, name, graphicInfo, scaleFactor);</span>
<span class="nc" id="L931">    }</span>

    public void drawShellTask(String name, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L934">        drawTask(SHELL_TASK_IMAGE, name, graphicInfo, scaleFactor);</span>
<span class="nc" id="L935">    }</span>

    public void drawDMNTask(String name, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L938">        drawTask(DMN_TASK_IMAGE, name, graphicInfo, scaleFactor);</span>
<span class="nc" id="L939">    }</span>

    public void drawCamelTask(String name, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L942">        drawTask(CAMEL_TASK_IMAGE, name, graphicInfo, scaleFactor);</span>
<span class="nc" id="L943">    }</span>

    public void drawHttpTask(String name, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L946">        drawTask(HTTP_TASK_IMAGE, name, graphicInfo, scaleFactor);</span>
<span class="nc" id="L947">    }</span>

    public void drawExpandedSubProcess(String name, GraphicInfo graphicInfo, boolean isTriggeredByEvent, double scaleFactor) {
<span class="nc" id="L950">        RoundRectangle2D rect = new RoundRectangle2D.Double(graphicInfo.getX(), graphicInfo.getY(),</span>
<span class="nc" id="L951">                graphicInfo.getWidth(), graphicInfo.getHeight(), 8, 8);</span>

        // Use different stroke (dashed)
<span class="nc bnc" id="L954" title="All 2 branches missed.">        if (isTriggeredByEvent) {</span>
<span class="nc" id="L955">            Stroke originalStroke = g.getStroke();</span>
<span class="nc" id="L956">            g.setStroke(EVENT_SUBPROCESS_STROKE);</span>
<span class="nc" id="L957">            g.draw(rect);</span>
<span class="nc" id="L958">            g.setStroke(originalStroke);</span>
<span class="nc" id="L959">        } else {</span>
<span class="nc" id="L960">            Paint originalPaint = g.getPaint();</span>
<span class="nc" id="L961">            g.setPaint(SUBPROCESS_BOX_COLOR);</span>
<span class="nc" id="L962">            g.fill(rect);</span>
<span class="nc" id="L963">            g.setPaint(SUBPROCESS_BORDER_COLOR);</span>
<span class="nc" id="L964">            g.draw(rect);</span>
<span class="nc" id="L965">            g.setPaint(originalPaint);</span>
        }
<span class="nc bnc" id="L967" title="All 6 branches missed.">        if (scaleFactor == 1.0 &amp;&amp; name != null &amp;&amp; !name.isEmpty()) {</span>
<span class="nc" id="L968">            String text = fitTextToWidth(name, (int) graphicInfo.getWidth());</span>
<span class="nc" id="L969">            g.drawString(text, (int) graphicInfo.getX() + 10, (int) graphicInfo.getY() + 15);</span>
        }
<span class="nc" id="L971">    }</span>
    public void drawExpandedTransaction(String name, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L973">        RoundRectangle2D rect = new RoundRectangle2D.Double(graphicInfo.getX(), graphicInfo.getY(),</span>
<span class="nc" id="L974">                graphicInfo.getWidth(), graphicInfo.getHeight(), 8, 8);</span>
<span class="nc" id="L975">        RoundRectangle2D outerRect = new RoundRectangle2D.Double(graphicInfo.getX()-3,</span>
<span class="nc" id="L976">                graphicInfo.getY()-3,</span>
<span class="nc" id="L977">                graphicInfo.getWidth()+6,</span>
<span class="nc" id="L978">                graphicInfo.getHeight()+6,</span>
                8,
                8);
<span class="nc" id="L981">        Paint originalPaint = g.getPaint();</span>
<span class="nc" id="L982">        g.setPaint(SUBPROCESS_BOX_COLOR);</span>
<span class="nc" id="L983">        g.fill(outerRect);</span>
<span class="nc" id="L984">        g.setPaint(SUBPROCESS_BORDER_COLOR);</span>
<span class="nc" id="L985">        g.draw(outerRect);</span>
<span class="nc" id="L986">        g.setPaint(SUBPROCESS_BOX_COLOR);</span>
<span class="nc" id="L987">        g.fill(rect);</span>
<span class="nc" id="L988">        g.setPaint(SUBPROCESS_BORDER_COLOR);</span>
<span class="nc" id="L989">        g.draw(rect);</span>
<span class="nc" id="L990">        g.setPaint(originalPaint);</span>

<span class="nc bnc" id="L992" title="All 6 branches missed.">        if (scaleFactor == 1.0 &amp;&amp; name != null &amp;&amp; !name.isEmpty()) {</span>
<span class="nc" id="L993">            String text = fitTextToWidth(name, (int) graphicInfo.getWidth());</span>
<span class="nc" id="L994">            g.drawString(text, (int) graphicInfo.getX() + 10, (int) graphicInfo.getY() + 15);</span>
        }
<span class="nc" id="L996">    }</span>

    public void drawCollapsedSubProcess(String name, GraphicInfo graphicInfo, Boolean isTriggeredByEvent, double scaleFactor) {
<span class="nc" id="L999">        drawCollapsedTask(name, graphicInfo, false, scaleFactor);</span>
<span class="nc" id="L1000">    }</span>

    public void drawCollapsedCallActivity(String name, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L1003">        drawCollapsedTask(name, graphicInfo, true, scaleFactor);</span>
<span class="nc" id="L1004">    }</span>

    protected void drawCollapsedTask(String name, GraphicInfo graphicInfo, boolean thickBorder, double scaleFactor) {
        // The collapsed marker is now visualized separately
<span class="nc" id="L1008">        drawTask(name, graphicInfo, thickBorder, scaleFactor);</span>
<span class="nc" id="L1009">    }</span>

    public void drawCollapsedMarker(int x, int y, int width, int height) {
        // rectangle
<span class="nc" id="L1013">        int rectangleWidth = MARKER_WIDTH;</span>
<span class="nc" id="L1014">        int rectangleHeight = MARKER_WIDTH;</span>
<span class="nc" id="L1015">        Rectangle rect = new Rectangle(x + (width - rectangleWidth) / 2, y + height - rectangleHeight - 3, rectangleWidth, rectangleHeight);</span>
<span class="nc" id="L1016">        g.draw(rect);</span>

        // plus inside rectangle
<span class="nc" id="L1019">        Line2D.Double line = new Line2D.Double(rect.getCenterX(), rect.getY() + 2, rect.getCenterX(), rect.getMaxY() - 2);</span>
<span class="nc" id="L1020">        g.draw(line);</span>
<span class="nc" id="L1021">        line = new Line2D.Double(rect.getMinX() + 2, rect.getCenterY(), rect.getMaxX() - 2, rect.getCenterY());</span>
<span class="nc" id="L1022">        g.draw(line);</span>
<span class="nc" id="L1023">    }</span>

    public void drawActivityMarkers(int x, int y, int width, int height, boolean multiInstanceSequential, boolean multiInstanceParallel, boolean collapsed) {
<span class="nc bnc" id="L1026" title="All 2 branches missed.">        if (collapsed) {</span>
<span class="nc bnc" id="L1027" title="All 4 branches missed.">            if (!multiInstanceSequential &amp;&amp; !multiInstanceParallel) {</span>
<span class="nc" id="L1028">                drawCollapsedMarker(x, y, width, height);</span>
            } else {
<span class="nc" id="L1030">                drawCollapsedMarker(x - MARKER_WIDTH / 2 - 2, y, width, height);</span>
<span class="nc bnc" id="L1031" title="All 2 branches missed.">                if (multiInstanceSequential) {</span>
<span class="nc" id="L1032">                    drawMultiInstanceMarker(true, x + MARKER_WIDTH / 2 + 2, y, width, height);</span>
                } else {
<span class="nc" id="L1034">                    drawMultiInstanceMarker(false, x + MARKER_WIDTH / 2 + 2, y, width, height);</span>
                }
            }
        } else {
<span class="nc bnc" id="L1038" title="All 2 branches missed.">            if (multiInstanceSequential) {</span>
<span class="nc" id="L1039">                drawMultiInstanceMarker(true, x, y, width, height);</span>
<span class="nc bnc" id="L1040" title="All 2 branches missed.">            } else if (multiInstanceParallel) {</span>
<span class="nc" id="L1041">                drawMultiInstanceMarker(false, x, y, width, height);</span>
            }
        }
<span class="nc" id="L1044">    }</span>

    public void drawGateway(GraphicInfo graphicInfo) {
<span class="nc" id="L1047">        Polygon rhombus = new Polygon();</span>
<span class="nc" id="L1048">        int x = (int) graphicInfo.getX();</span>
<span class="nc" id="L1049">        int y = (int) graphicInfo.getY();</span>
<span class="nc" id="L1050">        int width = (int) graphicInfo.getWidth();</span>
<span class="nc" id="L1051">        int height = (int) graphicInfo.getHeight();</span>

<span class="nc" id="L1053">        rhombus.addPoint(x, y + (height / 2));</span>
<span class="nc" id="L1054">        rhombus.addPoint(x + (width / 2), y + height);</span>
<span class="nc" id="L1055">        rhombus.addPoint(x + width, y + (height / 2));</span>
<span class="nc" id="L1056">        rhombus.addPoint(x + (width / 2), y);</span>
<span class="nc" id="L1057">        g.draw(rhombus);</span>
<span class="nc" id="L1058">    }</span>

    public void drawParallelGateway(GraphicInfo graphicInfo, double scaleFactor) {
        // rhombus
<span class="nc" id="L1062">        drawGateway(graphicInfo);</span>
<span class="nc" id="L1063">        int x = (int) graphicInfo.getX();</span>
<span class="nc" id="L1064">        int y = (int) graphicInfo.getY();</span>
<span class="nc" id="L1065">        int width = (int) graphicInfo.getWidth();</span>
<span class="nc" id="L1066">        int height = (int) graphicInfo.getHeight();</span>

<span class="nc bnc" id="L1068" title="All 2 branches missed.">        if (scaleFactor == 1.0) {</span>
            // plus inside rhombus
<span class="nc" id="L1070">            Stroke originalStroke = g.getStroke();</span>
<span class="nc" id="L1071">            g.setStroke(GATEWAY_TYPE_STROKE);</span>
<span class="nc" id="L1072">            Line2D.Double line = new Line2D.Double(x + 10, y + height / 2, x + width - 10, y + height / 2); // horizontal</span>
<span class="nc" id="L1073">            g.draw(line);</span>
<span class="nc" id="L1074">            line = new Line2D.Double(x + width / 2, y + height - 10, x + width / 2, y + 10); // vertical</span>
<span class="nc" id="L1075">            g.draw(line);</span>
<span class="nc" id="L1076">            g.setStroke(originalStroke);</span>
        }
<span class="nc" id="L1078">    }</span>

    public void drawExclusiveGateway(GraphicInfo graphicInfo, double scaleFactor) {
        // rhombus
<span class="nc" id="L1082">        drawGateway(graphicInfo);</span>
<span class="nc" id="L1083">        int x = (int) graphicInfo.getX();</span>
<span class="nc" id="L1084">        int y = (int) graphicInfo.getY();</span>
<span class="nc" id="L1085">        int width = (int) graphicInfo.getWidth();</span>
<span class="nc" id="L1086">        int height = (int) graphicInfo.getHeight();</span>

<span class="nc" id="L1088">        int quarterWidth = width / 4;</span>
<span class="nc" id="L1089">        int quarterHeight = height / 4;</span>

<span class="nc bnc" id="L1091" title="All 2 branches missed.">        if (scaleFactor == 1.0) {</span>
            // X inside rhombus
<span class="nc" id="L1093">            Stroke originalStroke = g.getStroke();</span>
<span class="nc" id="L1094">            g.setStroke(GATEWAY_TYPE_STROKE);</span>
<span class="nc" id="L1095">            Line2D.Double line = new Line2D.Double(x + quarterWidth + 3, y + quarterHeight + 3, x + 3 * quarterWidth - 3, y + 3 * quarterHeight - 3);</span>
<span class="nc" id="L1096">            g.draw(line);</span>
<span class="nc" id="L1097">            line = new Line2D.Double(x + quarterWidth + 3, y + 3 * quarterHeight - 3, x + 3 * quarterWidth - 3, y + quarterHeight + 3);</span>
<span class="nc" id="L1098">            g.draw(line);</span>
<span class="nc" id="L1099">            g.setStroke(originalStroke);</span>
        }
<span class="nc" id="L1101">    }</span>

    public void drawInclusiveGateway(GraphicInfo graphicInfo, double scaleFactor) {
        // rhombus
<span class="nc" id="L1105">        drawGateway(graphicInfo);</span>
<span class="nc" id="L1106">        int x = (int) graphicInfo.getX();</span>
<span class="nc" id="L1107">        int y = (int) graphicInfo.getY();</span>
<span class="nc" id="L1108">        int width = (int) graphicInfo.getWidth();</span>
<span class="nc" id="L1109">        int height = (int) graphicInfo.getHeight();</span>

<span class="nc" id="L1111">        int diameter = width / 2;</span>

<span class="nc bnc" id="L1113" title="All 2 branches missed.">        if (scaleFactor == 1.0) {</span>
            // circle inside rhombus
<span class="nc" id="L1115">            Stroke originalStroke = g.getStroke();</span>
<span class="nc" id="L1116">            g.setStroke(GATEWAY_TYPE_STROKE);</span>
<span class="nc" id="L1117">            Ellipse2D.Double circle = new Ellipse2D.Double(((width - diameter) / 2) + x, ((height - diameter) / 2) + y, diameter, diameter);</span>
<span class="nc" id="L1118">            g.draw(circle);</span>
<span class="nc" id="L1119">            g.setStroke(originalStroke);</span>
        }
<span class="nc" id="L1121">    }</span>

    public void drawEventBasedGateway(GraphicInfo graphicInfo, double scaleFactor) {
        // rhombus
<span class="nc" id="L1125">        drawGateway(graphicInfo);</span>

<span class="nc bnc" id="L1127" title="All 2 branches missed.">        if (scaleFactor == 1.0) {</span>
<span class="nc" id="L1128">            int x = (int) graphicInfo.getX();</span>
<span class="nc" id="L1129">            int y = (int) graphicInfo.getY();</span>
<span class="nc" id="L1130">            int width = (int) graphicInfo.getWidth();</span>
<span class="nc" id="L1131">            int height = (int) graphicInfo.getHeight();</span>

<span class="nc" id="L1133">            double scale = .6;</span>

<span class="nc" id="L1135">            GraphicInfo eventInfo = new GraphicInfo();</span>
<span class="nc" id="L1136">            eventInfo.setX(x + width * (1 - scale) / 2);</span>
<span class="nc" id="L1137">            eventInfo.setY(y + height * (1 - scale) / 2);</span>
<span class="nc" id="L1138">            eventInfo.setWidth(width * scale);</span>
<span class="nc" id="L1139">            eventInfo.setHeight(height * scale);</span>
<span class="nc" id="L1140">            drawCatchingEvent(eventInfo, true, null, &quot;eventGateway&quot;, scaleFactor);</span>

<span class="nc" id="L1142">            double r = width / 6.;</span>

            // create pentagon (coords with respect to center)
<span class="nc" id="L1145">            int topX = (int) (.95 * r); // top right corner</span>
<span class="nc" id="L1146">            int topY = (int) (-.31 * r);</span>
<span class="nc" id="L1147">            int bottomX = (int) (.59 * r); // bottom right corner</span>
<span class="nc" id="L1148">            int bottomY = (int) (.81 * r);</span>

<span class="nc" id="L1150">            int[] xPoints = new int[] { 0, topX, bottomX, -bottomX, -topX };</span>
<span class="nc" id="L1151">            int[] yPoints = new int[] { -(int) r, topY, bottomY, bottomY, topY };</span>
<span class="nc" id="L1152">            Polygon pentagon = new Polygon(xPoints, yPoints, 5);</span>
<span class="nc" id="L1153">            pentagon.translate(x + width / 2, y + width / 2);</span>

            // draw
<span class="nc" id="L1156">            g.drawPolygon(pentagon);</span>
        }
<span class="nc" id="L1158">    }</span>

    public void drawMultiInstanceMarker(boolean sequential, int x, int y, int width, int height) {
<span class="nc" id="L1161">        int rectangleWidth = MARKER_WIDTH;</span>
<span class="nc" id="L1162">        int rectangleHeight = MARKER_WIDTH;</span>
<span class="nc" id="L1163">        int lineX = x + (width - rectangleWidth) / 2;</span>
<span class="nc" id="L1164">        int lineY = y + height - rectangleHeight - 3;</span>

<span class="nc" id="L1166">        Stroke originalStroke = g.getStroke();</span>
<span class="nc" id="L1167">        g.setStroke(MULTI_INSTANCE_STROKE);</span>

<span class="nc bnc" id="L1169" title="All 2 branches missed.">        if (sequential) {</span>
<span class="nc" id="L1170">            g.draw(new Line2D.Double(lineX, lineY, lineX + rectangleWidth, lineY));</span>
<span class="nc" id="L1171">            g.draw(new Line2D.Double(lineX, lineY + rectangleHeight / 2, lineX + rectangleWidth, lineY + rectangleHeight / 2));</span>
<span class="nc" id="L1172">            g.draw(new Line2D.Double(lineX, lineY + rectangleHeight, lineX + rectangleWidth, lineY + rectangleHeight));</span>
        } else {
<span class="nc" id="L1174">            g.draw(new Line2D.Double(lineX, lineY, lineX, lineY + rectangleHeight));</span>
<span class="nc" id="L1175">            g.draw(new Line2D.Double(lineX + rectangleWidth / 2, lineY, lineX + rectangleWidth / 2, lineY + rectangleHeight));</span>
<span class="nc" id="L1176">            g.draw(new Line2D.Double(lineX + rectangleWidth, lineY, lineX + rectangleWidth, lineY + rectangleHeight));</span>
        }

<span class="nc" id="L1179">        g.setStroke(originalStroke);</span>
<span class="nc" id="L1180">    }</span>

    public void drawHighLight(int x, int y, int width, int height) {
<span class="nc" id="L1183">        Paint originalPaint = g.getPaint();</span>
<span class="nc" id="L1184">        Stroke originalStroke = g.getStroke();</span>

<span class="nc" id="L1186">        g.setPaint(HIGHLIGHT_COLOR);</span>
<span class="nc" id="L1187">        g.setStroke(THICK_TASK_BORDER_STROKE);</span>

<span class="nc" id="L1189">        RoundRectangle2D rect = new RoundRectangle2D.Double(x, y, width, height, 20, 20);</span>
<span class="nc" id="L1190">        g.draw(rect);</span>

<span class="nc" id="L1192">        g.setPaint(originalPaint);</span>
<span class="nc" id="L1193">        g.setStroke(originalStroke);</span>
<span class="nc" id="L1194">    }</span>

    public void drawTextAnnotation(String text, GraphicInfo graphicInfo, double scaleFactor) {
<span class="nc" id="L1197">        int x = (int) graphicInfo.getX();</span>
<span class="nc" id="L1198">        int y = (int) graphicInfo.getY();</span>
<span class="nc" id="L1199">        int width = (int) graphicInfo.getWidth();</span>
<span class="nc" id="L1200">        int height = (int) graphicInfo.getHeight();</span>

<span class="nc" id="L1202">        Font originalFont = g.getFont();</span>
<span class="nc" id="L1203">        Stroke originalStroke = g.getStroke();</span>

<span class="nc" id="L1205">        g.setFont(ANNOTATION_FONT);</span>

<span class="nc" id="L1207">        Path2D path = new Path2D.Double();</span>
<span class="nc" id="L1208">        int lineLength = 18;</span>
<span class="nc" id="L1209">        path.moveTo(x + lineLength, y);</span>
<span class="nc" id="L1210">        path.lineTo(x, y);</span>
<span class="nc" id="L1211">        path.lineTo(x, y + height);</span>
<span class="nc" id="L1212">        path.lineTo(x + lineLength, y + height);</span>

<span class="nc" id="L1214">        path.lineTo(x + lineLength, y + height - 1);</span>
<span class="nc" id="L1215">        path.lineTo(x + 1, y + height - 1);</span>
<span class="nc" id="L1216">        path.lineTo(x + 1, y + 1);</span>
<span class="nc" id="L1217">        path.lineTo(x + lineLength, y + 1);</span>
<span class="nc" id="L1218">        path.closePath();</span>

<span class="nc" id="L1220">        g.draw(path);</span>

<span class="nc" id="L1222">        int boxWidth = width - (2 * ANNOTATION_TEXT_PADDING);</span>
<span class="nc" id="L1223">        int boxHeight = height - (2 * ANNOTATION_TEXT_PADDING);</span>
<span class="nc" id="L1224">        int boxX = x + width / 2 - boxWidth / 2;</span>
<span class="nc" id="L1225">        int boxY = y + height / 2 - boxHeight / 2;</span>

<span class="nc bnc" id="L1227" title="All 6 branches missed.">        if (scaleFactor == 1.0 &amp;&amp; text != null &amp;&amp; !text.isEmpty()) {</span>
<span class="nc" id="L1228">            drawMultilineAnnotationText(text, boxX, boxY, boxWidth, boxHeight);</span>
        }

        // restore originals
<span class="nc" id="L1232">        g.setFont(originalFont);</span>
<span class="nc" id="L1233">        g.setStroke(originalStroke);</span>
<span class="nc" id="L1234">    }</span>

    public void drawLabel(String text, GraphicInfo graphicInfo) {
<span class="nc" id="L1237">        drawLabel(text, graphicInfo, true);</span>
<span class="nc" id="L1238">    }</span>

    public void drawLabel(String text, GraphicInfo graphicInfo, boolean centered) {
<span class="nc" id="L1241">        float interline = 1.0f;</span>

        // text
<span class="nc bnc" id="L1244" title="All 4 branches missed.">        if (text != null &amp;&amp; text.length() &gt; 0) {</span>
<span class="nc" id="L1245">            Paint originalPaint = g.getPaint();</span>
<span class="nc" id="L1246">            Font originalFont = g.getFont();</span>

<span class="nc" id="L1248">            g.setPaint(LABEL_COLOR);</span>
<span class="nc" id="L1249">            g.setFont(LABEL_FONT);</span>

<span class="nc" id="L1251">            int wrapWidth = 100;</span>
<span class="nc" id="L1252">            double textY = graphicInfo.getY();</span>

            // TODO: use drawMultilineText()
<span class="nc" id="L1255">            AttributedString as = new AttributedString(text);</span>
<span class="nc" id="L1256">            as.addAttribute(TextAttribute.FOREGROUND, g.getPaint());</span>
<span class="nc" id="L1257">            as.addAttribute(TextAttribute.FONT, g.getFont());</span>
<span class="nc" id="L1258">            AttributedCharacterIterator aci = as.getIterator();</span>
<span class="nc" id="L1259">            FontRenderContext frc = new FontRenderContext(null, true, false);</span>
<span class="nc" id="L1260">            LineBreakMeasurer lbm = new LineBreakMeasurer(aci, frc);</span>

<span class="nc bnc" id="L1262" title="All 2 branches missed.">            while (lbm.getPosition() &lt; text.length()) {</span>
<span class="nc" id="L1263">                TextLayout tl = lbm.nextLayout(wrapWidth);</span>
<span class="nc" id="L1264">                textY += tl.getAscent();</span>
<span class="nc" id="L1265">                Rectangle2D bb = tl.getBounds();</span>
<span class="nc" id="L1266">                double tX = graphicInfo.getX();</span>
<span class="nc bnc" id="L1267" title="All 2 branches missed.">                if (centered) {</span>
<span class="nc" id="L1268">                    tX += (int) (graphicInfo.getWidth() / 2 - bb.getWidth() / 2);</span>
                }
<span class="nc" id="L1270">                tl.draw(g, (float) tX, (float) textY);</span>
<span class="nc" id="L1271">                textY += tl.getDescent() + tl.getLeading() + (interline - 1.0f) * tl.getAscent();</span>
<span class="nc" id="L1272">            }</span>

            // restore originals
<span class="nc" id="L1275">            g.setFont(originalFont);</span>
<span class="nc" id="L1276">            g.setPaint(originalPaint);</span>
        }
<span class="nc" id="L1278">    }</span>

    /**
     * This method makes coordinates of connection flow better.
     * 
     * @param sourceShapeType
     * @param targetShapeType
     * @param sourceGraphicInfo
     * @param targetGraphicInfo
     * @param graphicInfoList
     * 
     */
    public List&lt;GraphicInfo&gt; connectionPerfectionizer(SHAPE_TYPE sourceShapeType, SHAPE_TYPE targetShapeType, GraphicInfo sourceGraphicInfo, GraphicInfo targetGraphicInfo, List&lt;GraphicInfo&gt; graphicInfoList) {
<span class="nc" id="L1291">        Shape shapeFirst = createShape(sourceShapeType, sourceGraphicInfo);</span>
<span class="nc" id="L1292">        Shape shapeLast = createShape(targetShapeType, targetGraphicInfo);</span>

<span class="nc bnc" id="L1294" title="All 4 branches missed.">        if (graphicInfoList != null &amp;&amp; graphicInfoList.size() &gt; 0) {</span>
<span class="nc" id="L1295">            GraphicInfo graphicInfoFirst = graphicInfoList.get(0);</span>
<span class="nc" id="L1296">            GraphicInfo graphicInfoLast = graphicInfoList.get(graphicInfoList.size() - 1);</span>
<span class="nc bnc" id="L1297" title="All 2 branches missed.">            if (shapeFirst != null) {</span>
<span class="nc" id="L1298">                graphicInfoFirst.setX(shapeFirst.getBounds2D().getCenterX());</span>
<span class="nc" id="L1299">                graphicInfoFirst.setY(shapeFirst.getBounds2D().getCenterY());</span>
            }
<span class="nc bnc" id="L1301" title="All 2 branches missed.">            if (shapeLast != null) {</span>
<span class="nc" id="L1302">                graphicInfoLast.setX(shapeLast.getBounds2D().getCenterX());</span>
<span class="nc" id="L1303">                graphicInfoLast.setY(shapeLast.getBounds2D().getCenterY());</span>
            }

<span class="nc" id="L1306">            Point p = null;</span>

<span class="nc bnc" id="L1308" title="All 2 branches missed.">            if (shapeFirst != null) {</span>
<span class="nc bnc" id="L1309" title="All 2 branches missed.">                if (graphicInfoList.size() &gt; 1) {</span>
<span class="nc" id="L1310">                    Line2D.Double lineFirst = new Line2D.Double(graphicInfoFirst.getX(), graphicInfoFirst.getY(), graphicInfoList.get(1).getX(), graphicInfoList.get(1).getY());</span>
<span class="nc" id="L1311">                    p = getIntersection(shapeFirst, lineFirst);</span>
                }
<span class="nc bnc" id="L1313" title="All 2 branches missed.">                if (p != null) {</span>
<span class="nc" id="L1314">                    graphicInfoFirst.setX(p.getX());</span>
<span class="nc" id="L1315">                    graphicInfoFirst.setY(p.getY());</span>
                }
            }

<span class="nc" id="L1319">            p = null;</span>

<span class="nc bnc" id="L1321" title="All 2 branches missed.">            if (shapeLast != null) {</span>
<span class="nc bnc" id="L1322" title="All 2 branches missed.">                if (graphicInfoList.size() &gt;= 2) {</span>
<span class="nc" id="L1323">                    Line2D.Double lineLast = new Line2D.Double(graphicInfoLast.getX(), graphicInfoLast.getY(), graphicInfoList.get(graphicInfoList.size() - 2).getX(), graphicInfoList.get(graphicInfoList.size() - 2).getY());</span>
<span class="nc" id="L1324">                    p = getIntersection(shapeLast, lineLast);</span>
                }
<span class="nc bnc" id="L1326" title="All 2 branches missed.">                if (p != null) {</span>
<span class="nc" id="L1327">                    graphicInfoLast.setX(p.getX());</span>
<span class="nc" id="L1328">                    graphicInfoLast.setY(p.getY());</span>
                }
            }
        }

<span class="nc" id="L1333">        return graphicInfoList;</span>
    }

    /**
     * This method creates shape by type and coordinates.
     * 
     * @param shapeType
     * @param graphicInfo
     * @return Shape
     */
    private static Shape createShape(SHAPE_TYPE shapeType, GraphicInfo graphicInfo) {
<span class="nc bnc" id="L1344" title="All 2 branches missed.">        if (SHAPE_TYPE.Rectangle == shapeType) {</span>
            // source is rectangle
<span class="nc" id="L1346">            return new Rectangle2D.Double(graphicInfo.getX(), graphicInfo.getY(), graphicInfo.getWidth(), graphicInfo.getHeight());</span>
<span class="nc bnc" id="L1347" title="All 2 branches missed.">        } else if (SHAPE_TYPE.Rhombus == shapeType) {</span>
            // source is rhombus
<span class="nc" id="L1349">            Path2D.Double rhombus = new Path2D.Double();</span>
<span class="nc" id="L1350">            rhombus.moveTo(graphicInfo.getX(), graphicInfo.getY() + graphicInfo.getHeight() / 2);</span>
<span class="nc" id="L1351">            rhombus.lineTo(graphicInfo.getX() + graphicInfo.getWidth() / 2, graphicInfo.getY() + graphicInfo.getHeight());</span>
<span class="nc" id="L1352">            rhombus.lineTo(graphicInfo.getX() + graphicInfo.getWidth(), graphicInfo.getY() + graphicInfo.getHeight() / 2);</span>
<span class="nc" id="L1353">            rhombus.lineTo(graphicInfo.getX() + graphicInfo.getWidth() / 2, graphicInfo.getY());</span>
<span class="nc" id="L1354">            rhombus.lineTo(graphicInfo.getX(), graphicInfo.getY() + graphicInfo.getHeight() / 2);</span>
<span class="nc" id="L1355">            rhombus.closePath();</span>
<span class="nc" id="L1356">            return rhombus;</span>
<span class="nc bnc" id="L1357" title="All 2 branches missed.">        } else if (SHAPE_TYPE.Ellipse == shapeType) {</span>
            // source is ellipse
<span class="nc" id="L1359">            return new Ellipse2D.Double(graphicInfo.getX(), graphicInfo.getY(), graphicInfo.getWidth(), graphicInfo.getHeight());</span>
        } else {
            // unknown source element, just do not correct coordinates
        }
<span class="nc" id="L1363">        return null;</span>
    }

    /**
     * This method returns intersection point of shape border and line.
     * 
     * @param shape
     * @param line
     * @return Point
     */
    private static Point getIntersection(Shape shape, Line2D.Double line) {
<span class="nc bnc" id="L1374" title="All 2 branches missed.">        if (shape instanceof Ellipse2D) {</span>
<span class="nc" id="L1375">            return getEllipseIntersection(shape, line);</span>
<span class="nc bnc" id="L1376" title="All 4 branches missed.">        } else if (shape instanceof Rectangle2D || shape instanceof Path2D) {</span>
<span class="nc" id="L1377">            return getShapeIntersection(shape, line);</span>
        } else {
            // something strange
<span class="nc" id="L1380">            return null;</span>
        }
    }

    /**
     * This method calculates ellipse intersection with line
     * 
     * @param shape
     *            Bounds of this shape used to calculate parameters of inscribed into this bounds ellipse.
     * @param line
     * @return Intersection point
     */
    private static Point getEllipseIntersection(Shape shape, Line2D.Double line) {
<span class="nc" id="L1393">        double angle = Math.atan2(line.y2 - line.y1, line.x2 - line.x1);</span>
<span class="nc" id="L1394">        double x = shape.getBounds2D().getWidth() / 2 * Math.cos(angle) + shape.getBounds2D().getCenterX();</span>
<span class="nc" id="L1395">        double y = shape.getBounds2D().getHeight() / 2 * Math.sin(angle) + shape.getBounds2D().getCenterY();</span>
<span class="nc" id="L1396">        Point p = new Point();</span>
<span class="nc" id="L1397">        p.setLocation(x, y);</span>
<span class="nc" id="L1398">        return p;</span>
    }

    /**
     * This method calculates shape intersection with line.
     * 
     * @param shape
     * @param line
     * @return Intersection point
     */
    private static Point getShapeIntersection(Shape shape, Line2D.Double line) {
<span class="nc" id="L1409">        PathIterator it = shape.getPathIterator(null);</span>
<span class="nc" id="L1410">        double[] coords = new double[6];</span>
<span class="nc" id="L1411">        double[] pos = new double[2];</span>
<span class="nc" id="L1412">        Line2D.Double l = new Line2D.Double();</span>
<span class="nc bnc" id="L1413" title="All 2 branches missed.">        while (!it.isDone()) {</span>
<span class="nc" id="L1414">            int type = it.currentSegment(coords);</span>
<span class="nc bnc" id="L1415" title="All 4 branches missed.">            switch (type) {</span>
            case PathIterator.SEG_MOVETO:
<span class="nc" id="L1417">                pos[0] = coords[0];</span>
<span class="nc" id="L1418">                pos[1] = coords[1];</span>
<span class="nc" id="L1419">                break;</span>
            case PathIterator.SEG_LINETO:
<span class="nc" id="L1421">                l = new Line2D.Double(pos[0], pos[1], coords[0], coords[1]);</span>
<span class="nc bnc" id="L1422" title="All 2 branches missed.">                if (line.intersectsLine(l)) {</span>
<span class="nc" id="L1423">                    return getLinesIntersection(line, l);</span>
                }
<span class="nc" id="L1425">                pos[0] = coords[0];</span>
<span class="nc" id="L1426">                pos[1] = coords[1];</span>
<span class="nc" id="L1427">                break;</span>
            case PathIterator.SEG_CLOSE:
<span class="nc" id="L1429">                break;</span>
            default:
                // whatever
            }
<span class="nc" id="L1433">            it.next();</span>
<span class="nc" id="L1434">        }</span>
<span class="nc" id="L1435">        return null;</span>
    }

    /**
     * This method calculates intersections of two lines.
     * 
     * @param a
     *            Line 1
     * @param b
     *            Line 2
     * @return Intersection point
     */
    private static Point getLinesIntersection(Line2D a, Line2D b) {
<span class="nc" id="L1448">        double d = (a.getX1() - a.getX2()) * (b.getY2() - b.getY1()) - (a.getY1() - a.getY2()) * (b.getX2() - b.getX1());</span>
<span class="nc" id="L1449">        double da = (a.getX1() - b.getX1()) * (b.getY2() - b.getY1()) - (a.getY1() - b.getY1()) * (b.getX2() - b.getX1());</span>
        // double db = (a.getX1()-a.getX2())*(a.getY1()-b.getY1()) - (a.getY1()-a.getY2())*(a.getX1()-b.getX1());
<span class="nc" id="L1451">        double ta = da / d;</span>
        // double tb = db/d;
<span class="nc" id="L1453">        Point p = new Point();</span>
<span class="nc" id="L1454">        p.setLocation(a.getX1() + ta * (a.getX2() - a.getX1()), a.getY1() + ta * (a.getY2() - a.getY1()));</span>
<span class="nc" id="L1455">        return p;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>