<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultProcessDiagramGenerator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.image.impl</a> &gt; <span class="el_source">DefaultProcessDiagramGenerator.java</span></div><h1>DefaultProcessDiagramGenerator.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.image.impl;

import java.awt.image.BufferedImage;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.flowable.bpmn.model.Activity;
import org.flowable.bpmn.model.AdhocSubProcess;
import org.flowable.bpmn.model.Artifact;
import org.flowable.bpmn.model.Association;
import org.flowable.bpmn.model.AssociationDirection;
import org.flowable.bpmn.model.BaseElement;
import org.flowable.bpmn.model.BoundaryEvent;
import org.flowable.bpmn.model.BpmnModel;
import org.flowable.bpmn.model.BusinessRuleTask;
import org.flowable.bpmn.model.CallActivity;
import org.flowable.bpmn.model.CaseServiceTask;
import org.flowable.bpmn.model.CompensateEventDefinition;
import org.flowable.bpmn.model.ConditionalEventDefinition;
import org.flowable.bpmn.model.EndEvent;
import org.flowable.bpmn.model.ErrorEventDefinition;
import org.flowable.bpmn.model.EscalationEventDefinition;
import org.flowable.bpmn.model.Event;
import org.flowable.bpmn.model.EventDefinition;
import org.flowable.bpmn.model.EventGateway;
import org.flowable.bpmn.model.EventSubProcess;
import org.flowable.bpmn.model.ExclusiveGateway;
import org.flowable.bpmn.model.ExtensionElement;
import org.flowable.bpmn.model.ExternalWorkerServiceTask;
import org.flowable.bpmn.model.FlowElement;
import org.flowable.bpmn.model.FlowElementsContainer;
import org.flowable.bpmn.model.FlowNode;
import org.flowable.bpmn.model.Gateway;
import org.flowable.bpmn.model.GraphicInfo;
import org.flowable.bpmn.model.HttpServiceTask;
import org.flowable.bpmn.model.InclusiveGateway;
import org.flowable.bpmn.model.IntermediateCatchEvent;
import org.flowable.bpmn.model.Lane;
import org.flowable.bpmn.model.ManualTask;
import org.flowable.bpmn.model.MessageEventDefinition;
import org.flowable.bpmn.model.MultiInstanceLoopCharacteristics;
import org.flowable.bpmn.model.ParallelGateway;
import org.flowable.bpmn.model.Pool;
import org.flowable.bpmn.model.Process;
import org.flowable.bpmn.model.ReceiveTask;
import org.flowable.bpmn.model.ScriptTask;
import org.flowable.bpmn.model.SendEventServiceTask;
import org.flowable.bpmn.model.SendTask;
import org.flowable.bpmn.model.SequenceFlow;
import org.flowable.bpmn.model.ServiceTask;
import org.flowable.bpmn.model.SignalEventDefinition;
import org.flowable.bpmn.model.StartEvent;
import org.flowable.bpmn.model.SubProcess;
import org.flowable.bpmn.model.Task;
import org.flowable.bpmn.model.TextAnnotation;
import org.flowable.bpmn.model.ThrowEvent;
import org.flowable.bpmn.model.TimerEventDefinition;
import org.flowable.bpmn.model.Transaction;
import org.flowable.bpmn.model.UserTask;
import org.flowable.image.ProcessDiagramGenerator;

/**
 * Class to generate an image based the diagram interchange information in a BPMN 2.0 process.
 * 
 * @author Joram Barrez
 * @author Tijs Rademakers
 * @author Zheng Ji
 *
 */
public class DefaultProcessDiagramGenerator implements ProcessDiagramGenerator {

<span class="nc" id="L89">    protected Map&lt;Class&lt;? extends BaseElement&gt;, ActivityDrawInstruction&gt; activityDrawInstructions = new HashMap&lt;&gt;();</span>
<span class="nc" id="L90">    protected Map&lt;Class&lt;? extends BaseElement&gt;, ArtifactDrawInstruction&gt; artifactDrawInstructions = new HashMap&lt;&gt;();</span>

    public DefaultProcessDiagramGenerator() {
<span class="nc" id="L93">        this(1.0);</span>
<span class="nc" id="L94">    }</span>

    // The instructions on how to draw a certain construct is
    // created statically and stored in a map for performance.
<span class="nc" id="L98">    public DefaultProcessDiagramGenerator(final double scaleFactor) {</span>
        // start event
<span class="nc" id="L100">        activityDrawInstructions.put(StartEvent.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L104">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L105">                StartEvent startEvent = (StartEvent) flowNode;</span>
<span class="nc bnc" id="L106" title="All 4 branches missed.">                if (startEvent.getEventDefinitions() != null &amp;&amp; !startEvent.getEventDefinitions().isEmpty()) {</span>
<span class="nc" id="L107">                    EventDefinition eventDefinition = startEvent.getEventDefinitions().get(0);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                    if (eventDefinition instanceof TimerEventDefinition) {</span>
<span class="nc" id="L109">                        processDiagramCanvas.drawTimerStartEvent(graphicInfo, scaleFactor);</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">                    } else if (eventDefinition instanceof ErrorEventDefinition) {</span>
<span class="nc" id="L111">                        processDiagramCanvas.drawErrorStartEvent(graphicInfo, scaleFactor);</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                    } else if (eventDefinition instanceof EscalationEventDefinition) {</span>
<span class="nc" id="L113">                        processDiagramCanvas.drawEscalationStartEvent(graphicInfo, scaleFactor);</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                    } else if (eventDefinition instanceof ConditionalEventDefinition) {</span>
<span class="nc" id="L115">                        processDiagramCanvas.drawConditionalStartEvent(graphicInfo, scaleFactor);</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                    } else if (eventDefinition instanceof SignalEventDefinition) {</span>
<span class="nc" id="L117">                        processDiagramCanvas.drawSignalStartEvent(graphicInfo, scaleFactor);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">                    } else if (eventDefinition instanceof MessageEventDefinition) {</span>
<span class="nc" id="L119">                        processDiagramCanvas.drawMessageStartEvent(graphicInfo, scaleFactor);</span>
                    } else {
<span class="nc" id="L121">                        processDiagramCanvas.drawNoneStartEvent(graphicInfo);</span>
                    }
<span class="nc" id="L123">                } else {</span>
<span class="nc" id="L124">                    List&lt;ExtensionElement&gt; eventTypeElements = startEvent.getExtensionElements().get(&quot;eventType&quot;);</span>
<span class="nc bnc" id="L125" title="All 4 branches missed.">                    if (eventTypeElements != null &amp;&amp; eventTypeElements.size() &gt; 0) {</span>
<span class="nc" id="L126">                        processDiagramCanvas.drawEventRegistryStartEvent(graphicInfo, scaleFactor);</span>
                        
                    } else {
<span class="nc" id="L129">                        processDiagramCanvas.drawNoneStartEvent(graphicInfo);</span>
                    }
                }
<span class="nc" id="L132">            }</span>
        });

        // signal catch
<span class="nc" id="L136">        activityDrawInstructions.put(IntermediateCatchEvent.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L140">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L141">                IntermediateCatchEvent intermediateCatchEvent = (IntermediateCatchEvent) flowNode;</span>
<span class="nc bnc" id="L142" title="All 4 branches missed.">                if (intermediateCatchEvent.getEventDefinitions() != null &amp;&amp; !intermediateCatchEvent.getEventDefinitions().isEmpty()) {</span>
                    
<span class="nc bnc" id="L144" title="All 2 branches missed.">                    if (intermediateCatchEvent.getEventDefinitions().get(0) instanceof SignalEventDefinition) {</span>
<span class="nc" id="L145">                        processDiagramCanvas.drawCatchingSignalEvent(flowNode.getName(), graphicInfo, true, scaleFactor);</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">                    } else if (intermediateCatchEvent.getEventDefinitions().get(0) instanceof TimerEventDefinition) {</span>
<span class="nc" id="L147">                        processDiagramCanvas.drawCatchingTimerEvent(flowNode.getName(), graphicInfo, true, scaleFactor);</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">                    } else if (intermediateCatchEvent.getEventDefinitions().get(0) instanceof MessageEventDefinition) {</span>
<span class="nc" id="L149">                        processDiagramCanvas.drawCatchingMessageEvent(flowNode.getName(), graphicInfo, true, scaleFactor);</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">                    } else if (intermediateCatchEvent.getEventDefinitions().get(0) instanceof ConditionalEventDefinition) {</span>
<span class="nc" id="L151">                        processDiagramCanvas.drawCatchingConditionalEvent(flowNode.getName(), graphicInfo, true, scaleFactor);</span>
                    }
                }
<span class="nc" id="L154">            }</span>
        });

        // signal throw
<span class="nc" id="L158">        activityDrawInstructions.put(ThrowEvent.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L162">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L163">                ThrowEvent throwEvent = (ThrowEvent) flowNode;</span>
<span class="nc bnc" id="L164" title="All 4 branches missed.">                if (throwEvent.getEventDefinitions() != null &amp;&amp; !throwEvent.getEventDefinitions().isEmpty()) {</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">                    if (throwEvent.getEventDefinitions().get(0) instanceof SignalEventDefinition) {</span>
<span class="nc" id="L166">                        processDiagramCanvas.drawThrowingSignalEvent(graphicInfo, scaleFactor);</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">                    } else if (throwEvent.getEventDefinitions().get(0) instanceof EscalationEventDefinition) {</span>
<span class="nc" id="L168">                        processDiagramCanvas.drawThrowingEscalationEvent(graphicInfo, scaleFactor);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">                    } else if (throwEvent.getEventDefinitions().get(0) instanceof CompensateEventDefinition) {</span>
<span class="nc" id="L170">                        processDiagramCanvas.drawThrowingCompensateEvent(graphicInfo, scaleFactor);</span>
                    } else {
<span class="nc" id="L172">                        processDiagramCanvas.drawThrowingNoneEvent(graphicInfo, scaleFactor);</span>
                    }
                } else {
<span class="nc" id="L175">                    processDiagramCanvas.drawThrowingNoneEvent(graphicInfo, scaleFactor);</span>
                }
<span class="nc" id="L177">            }</span>
        });

        // end event
<span class="nc" id="L181">        activityDrawInstructions.put(EndEvent.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L185">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L186">                EndEvent endEvent = (EndEvent) flowNode;</span>
<span class="nc bnc" id="L187" title="All 4 branches missed.">                if (endEvent.getEventDefinitions() != null &amp;&amp; !endEvent.getEventDefinitions().isEmpty()) {</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">                    if (endEvent.getEventDefinitions().get(0) instanceof ErrorEventDefinition) {</span>
<span class="nc" id="L189">                        processDiagramCanvas.drawErrorEndEvent(flowNode.getName(), graphicInfo, scaleFactor);</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">                    } else if (endEvent.getEventDefinitions().get(0) instanceof EscalationEventDefinition) {</span>
<span class="nc" id="L191">                        processDiagramCanvas.drawEscalationEndEvent(flowNode.getName(), graphicInfo, scaleFactor);</span>
                    } else {
<span class="nc" id="L193">                        processDiagramCanvas.drawNoneEndEvent(graphicInfo, scaleFactor);</span>
                    }
                } else {
<span class="nc" id="L196">                    processDiagramCanvas.drawNoneEndEvent(graphicInfo, scaleFactor);</span>
                }
<span class="nc" id="L198">            }</span>
        });

        // task
<span class="nc" id="L202">        activityDrawInstructions.put(Task.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L206">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L207">                processDiagramCanvas.drawTask(flowNode.getName(), graphicInfo, scaleFactor);</span>
<span class="nc" id="L208">            }</span>
        });

        // user task
<span class="nc" id="L212">        activityDrawInstructions.put(UserTask.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L216">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L217">                processDiagramCanvas.drawUserTask(flowNode.getName(), graphicInfo, scaleFactor);</span>
<span class="nc" id="L218">            }</span>
        });

        // script task
<span class="nc" id="L222">        activityDrawInstructions.put(ScriptTask.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L226">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L227">                processDiagramCanvas.drawScriptTask(flowNode.getName(), graphicInfo, scaleFactor);</span>
<span class="nc" id="L228">            }</span>
        });

        // service task
<span class="nc" id="L232">        activityDrawInstructions.put(ServiceTask.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L236">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L237">                ServiceTask serviceTask = (ServiceTask) flowNode;</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">                if (&quot;camel&quot;.equalsIgnoreCase(serviceTask.getType())) {</span>
<span class="nc" id="L239">                    processDiagramCanvas.drawCamelTask(serviceTask.getName(), graphicInfo, scaleFactor);</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">                } else if (ServiceTask.HTTP_TASK.equalsIgnoreCase(serviceTask.getType())) {</span>
<span class="nc" id="L241">                    processDiagramCanvas.drawHttpTask(serviceTask.getName(), graphicInfo, scaleFactor);</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">                } else if (ServiceTask.DMN_TASK.equalsIgnoreCase(serviceTask.getType())) {</span>
<span class="nc" id="L243">                    processDiagramCanvas.drawDMNTask(serviceTask.getName(), graphicInfo, scaleFactor);</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                } else if (ServiceTask.SHELL_TASK.equalsIgnoreCase(serviceTask.getType())) {</span>
<span class="nc" id="L245">                    processDiagramCanvas.drawShellTask(serviceTask.getName(), graphicInfo, scaleFactor);</span>
                } else {
<span class="nc" id="L247">                    processDiagramCanvas.drawServiceTask(serviceTask.getName(), graphicInfo, scaleFactor);</span>
                }
<span class="nc" id="L249">            }</span>
        });
        
        // http service task
<span class="nc" id="L253">        activityDrawInstructions.put(HttpServiceTask.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L257">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L258">                processDiagramCanvas.drawHttpTask(flowNode.getName(), graphicInfo, scaleFactor);</span>
<span class="nc" id="L259">            }</span>
        });

        // receive task
<span class="nc" id="L263">        activityDrawInstructions.put(ReceiveTask.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L267">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L268">                processDiagramCanvas.drawReceiveTask(flowNode.getName(), graphicInfo, scaleFactor);</span>
<span class="nc" id="L269">            }</span>
        });

        // send task
<span class="nc" id="L273">        activityDrawInstructions.put(SendTask.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L277">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L278">                processDiagramCanvas.drawSendTask(flowNode.getName(), graphicInfo, scaleFactor);</span>
<span class="nc" id="L279">            }</span>
        });

        // manual task
<span class="nc" id="L283">        activityDrawInstructions.put(ManualTask.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L287">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L288">                processDiagramCanvas.drawManualTask(flowNode.getName(), graphicInfo, scaleFactor);</span>
<span class="nc" id="L289">            }</span>
        });
        
        // send event service task
<span class="nc" id="L293">        activityDrawInstructions.put(SendEventServiceTask.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L297">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L298">                processDiagramCanvas.drawSendEventServiceTask(flowNode.getName(), graphicInfo, scaleFactor);</span>
<span class="nc" id="L299">            }</span>
        });

        // external worker service task
<span class="nc" id="L303">        activityDrawInstructions.put(ExternalWorkerServiceTask.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L307">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L308">                ServiceTask serviceTask = (ServiceTask) flowNode;</span>
<span class="nc" id="L309">                processDiagramCanvas.drawServiceTask(serviceTask.getName(), graphicInfo, scaleFactor);</span>
<span class="nc" id="L310">            }</span>
        });
        
        // case service task
<span class="nc" id="L314">        activityDrawInstructions.put(CaseServiceTask.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L318">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L319">                processDiagramCanvas.drawCaseServiceTask(flowNode.getName(), graphicInfo, scaleFactor);</span>
<span class="nc" id="L320">            }</span>
        });

        // businessRuleTask task
<span class="nc" id="L324">        activityDrawInstructions.put(BusinessRuleTask.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L328">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L329">                processDiagramCanvas.drawBusinessRuleTask(flowNode.getName(), graphicInfo, scaleFactor);</span>
<span class="nc" id="L330">            }</span>
        });

        // exclusive gateway
<span class="nc" id="L334">        activityDrawInstructions.put(ExclusiveGateway.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L338">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L339">                processDiagramCanvas.drawExclusiveGateway(graphicInfo, scaleFactor);</span>
<span class="nc" id="L340">            }</span>
        });

        // inclusive gateway
<span class="nc" id="L344">        activityDrawInstructions.put(InclusiveGateway.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L348">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L349">                processDiagramCanvas.drawInclusiveGateway(graphicInfo, scaleFactor);</span>
<span class="nc" id="L350">            }</span>
        });

        // parallel gateway
<span class="nc" id="L354">        activityDrawInstructions.put(ParallelGateway.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L358">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L359">                processDiagramCanvas.drawParallelGateway(graphicInfo, scaleFactor);</span>
<span class="nc" id="L360">            }</span>
        });

        // event based gateway
<span class="nc" id="L364">        activityDrawInstructions.put(EventGateway.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L368">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L369">                processDiagramCanvas.drawEventBasedGateway(graphicInfo, scaleFactor);</span>
<span class="nc" id="L370">            }</span>
        });

        // Boundary timer
<span class="nc" id="L374">        activityDrawInstructions.put(BoundaryEvent.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L378">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L379">                BoundaryEvent boundaryEvent = (BoundaryEvent) flowNode;</span>
<span class="nc bnc" id="L380" title="All 4 branches missed.">                if (boundaryEvent.getEventDefinitions() != null &amp;&amp; !boundaryEvent.getEventDefinitions().isEmpty()) {</span>
<span class="nc" id="L381">                    EventDefinition eventDefinition = boundaryEvent.getEventDefinitions().get(0);</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">                    if (eventDefinition instanceof TimerEventDefinition) {</span>
<span class="nc" id="L383">                        processDiagramCanvas.drawCatchingTimerEvent(flowNode.getName(), graphicInfo, boundaryEvent.isCancelActivity(), scaleFactor);</span>
                        
<span class="nc bnc" id="L385" title="All 2 branches missed.">                    } else if (eventDefinition instanceof ConditionalEventDefinition) {</span>
<span class="nc" id="L386">                        processDiagramCanvas.drawCatchingConditionalEvent(graphicInfo, boundaryEvent.isCancelActivity(), scaleFactor);</span>

<span class="nc bnc" id="L388" title="All 2 branches missed.">                    } else if (eventDefinition instanceof ErrorEventDefinition) {</span>
<span class="nc" id="L389">                        processDiagramCanvas.drawCatchingErrorEvent(graphicInfo, boundaryEvent.isCancelActivity(), scaleFactor);</span>
                        
<span class="nc bnc" id="L391" title="All 2 branches missed.">                    } else if (eventDefinition instanceof EscalationEventDefinition) {</span>
<span class="nc" id="L392">                        processDiagramCanvas.drawCatchingEscalationEvent(graphicInfo, boundaryEvent.isCancelActivity(), scaleFactor);</span>

<span class="nc bnc" id="L394" title="All 2 branches missed.">                    } else if (eventDefinition instanceof SignalEventDefinition) {</span>
<span class="nc" id="L395">                        processDiagramCanvas.drawCatchingSignalEvent(flowNode.getName(), graphicInfo, boundaryEvent.isCancelActivity(), scaleFactor);</span>

<span class="nc bnc" id="L397" title="All 2 branches missed.">                    } else if (eventDefinition instanceof MessageEventDefinition) {</span>
<span class="nc" id="L398">                        processDiagramCanvas.drawCatchingMessageEvent(flowNode.getName(), graphicInfo, boundaryEvent.isCancelActivity(), scaleFactor);</span>

<span class="nc bnc" id="L400" title="All 2 branches missed.">                    } else if (eventDefinition instanceof CompensateEventDefinition) {</span>
<span class="nc" id="L401">                        processDiagramCanvas.drawCatchingCompensateEvent(graphicInfo, boundaryEvent.isCancelActivity(), scaleFactor);</span>
                    }
                    
<span class="nc" id="L404">                } else {</span>
<span class="nc" id="L405">                    List&lt;ExtensionElement&gt; eventTypeElements = boundaryEvent.getExtensionElements().get(&quot;eventType&quot;);</span>
<span class="nc bnc" id="L406" title="All 4 branches missed.">                    if (eventTypeElements != null &amp;&amp; eventTypeElements.size() &gt; 0) {</span>
<span class="nc" id="L407">                        processDiagramCanvas.drawCatchingEventRegistryEvent(flowNode.getName(), graphicInfo, boundaryEvent.isCancelActivity(), scaleFactor);</span>
                    }
                }
<span class="nc" id="L410">            }</span>
        });

        // subprocess
<span class="nc" id="L414">        activityDrawInstructions.put(SubProcess.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L418">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc bnc" id="L419" title="All 4 branches missed.">                if (graphicInfo.getExpanded() != null &amp;&amp; !graphicInfo.getExpanded()) {</span>
<span class="nc" id="L420">                    processDiagramCanvas.drawCollapsedSubProcess(flowNode.getName(), graphicInfo, false, scaleFactor);</span>
                } else {
<span class="nc" id="L422">                    processDiagramCanvas.drawExpandedSubProcess(flowNode.getName(), graphicInfo, false, scaleFactor);</span>
                }
<span class="nc" id="L424">            }</span>
        });
        
        // transaction
<span class="nc" id="L428">        activityDrawInstructions.put(Transaction.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L432">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc bnc" id="L433" title="All 4 branches missed.">                if (graphicInfo.getExpanded() != null &amp;&amp; !graphicInfo.getExpanded()) {</span>
<span class="nc" id="L434">                    processDiagramCanvas.drawCollapsedSubProcess(flowNode.getName(), graphicInfo, false, scaleFactor);</span>
                } else {
<span class="nc" id="L436">                   processDiagramCanvas.drawExpandedTransaction(flowNode.getName(), graphicInfo,  scaleFactor);</span>
                }
<span class="nc" id="L438">            }</span>
        });

        // Event subprocess
<span class="nc" id="L442">        activityDrawInstructions.put(EventSubProcess.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L446">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc bnc" id="L447" title="All 4 branches missed.">                if (graphicInfo.getExpanded() != null &amp;&amp; !graphicInfo.getExpanded()) {</span>
<span class="nc" id="L448">                    processDiagramCanvas.drawCollapsedSubProcess(flowNode.getName(), graphicInfo, true, scaleFactor);</span>
                } else {
<span class="nc" id="L450">                    processDiagramCanvas.drawExpandedSubProcess(flowNode.getName(), graphicInfo, true, scaleFactor);</span>
                }
<span class="nc" id="L452">            }</span>
        });

        // Adhoc subprocess
<span class="nc" id="L456">        activityDrawInstructions.put(AdhocSubProcess.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L460">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc bnc" id="L461" title="All 4 branches missed.">                if (graphicInfo.getExpanded() != null &amp;&amp; !graphicInfo.getExpanded()) {</span>
<span class="nc" id="L462">                    processDiagramCanvas.drawCollapsedSubProcess(flowNode.getName(), graphicInfo, false, scaleFactor);</span>
                } else {
<span class="nc" id="L464">                    processDiagramCanvas.drawExpandedSubProcess(flowNode.getName(), graphicInfo, false, scaleFactor);</span>
                }
<span class="nc" id="L466">            }</span>
        });

        // call activity
<span class="nc" id="L470">        activityDrawInstructions.put(CallActivity.class, new ActivityDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode) {
<span class="nc" id="L474">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc" id="L475">                processDiagramCanvas.drawCollapsedCallActivity(flowNode.getName(), graphicInfo, scaleFactor);</span>
<span class="nc" id="L476">            }</span>
        });

        // text annotation
<span class="nc" id="L480">        artifactDrawInstructions.put(TextAnnotation.class, new ArtifactDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, Artifact artifact) {
<span class="nc" id="L484">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(artifact.getId());</span>
<span class="nc" id="L485">                TextAnnotation textAnnotation = (TextAnnotation) artifact;</span>
<span class="nc" id="L486">                processDiagramCanvas.drawTextAnnotation(textAnnotation.getText(), graphicInfo, scaleFactor);</span>
<span class="nc" id="L487">            }</span>
        });

        // association
<span class="nc" id="L491">        artifactDrawInstructions.put(Association.class, new ArtifactDrawInstruction() {</span>

            @Override
            public void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, Artifact artifact) {
<span class="nc" id="L495">                Association association = (Association) artifact;</span>
<span class="nc" id="L496">                String sourceRef = association.getSourceRef();</span>
<span class="nc" id="L497">                String targetRef = association.getTargetRef();</span>

                // source and target can be instance of FlowElement or Artifact
<span class="nc" id="L500">                BaseElement sourceElement = bpmnModel.getFlowElement(sourceRef);</span>
<span class="nc" id="L501">                BaseElement targetElement = bpmnModel.getFlowElement(targetRef);</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">                if (sourceElement == null) {</span>
<span class="nc" id="L503">                    sourceElement = bpmnModel.getArtifact(sourceRef);</span>
                }
<span class="nc bnc" id="L505" title="All 2 branches missed.">                if (targetElement == null) {</span>
<span class="nc" id="L506">                    targetElement = bpmnModel.getArtifact(targetRef);</span>
                }
<span class="nc" id="L508">                List&lt;GraphicInfo&gt; graphicInfoList = bpmnModel.getFlowLocationGraphicInfo(artifact.getId());</span>
<span class="nc" id="L509">                graphicInfoList = connectionPerfectionizer(processDiagramCanvas, bpmnModel, sourceElement, targetElement, graphicInfoList);</span>

<span class="nc bnc" id="L511" title="All 2 branches missed.">                if (graphicInfoList != null) {</span>
<span class="nc" id="L512">                    int[] xPoints = new int[graphicInfoList.size()];</span>
<span class="nc" id="L513">                    int[] yPoints = new int[graphicInfoList.size()];</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">                    for (int i = 1; i &lt; graphicInfoList.size(); i++) {</span>
<span class="nc" id="L515">                        GraphicInfo graphicInfo = graphicInfoList.get(i);</span>
<span class="nc" id="L516">                        GraphicInfo previousGraphicInfo = graphicInfoList.get(i - 1);</span>

<span class="nc bnc" id="L518" title="All 2 branches missed.">                        if (i == 1) {</span>
<span class="nc" id="L519">                            xPoints[0] = (int) previousGraphicInfo.getX();</span>
<span class="nc" id="L520">                            yPoints[0] = (int) previousGraphicInfo.getY();</span>
                        }
<span class="nc" id="L522">                        xPoints[i] = (int) graphicInfo.getX();</span>
<span class="nc" id="L523">                        yPoints[i] = (int) graphicInfo.getY();</span>
                    }

<span class="nc" id="L526">                    AssociationDirection associationDirection = association.getAssociationDirection();</span>
<span class="nc" id="L527">                    processDiagramCanvas.drawAssociation(xPoints, yPoints, associationDirection, false, scaleFactor);</span>
                }
<span class="nc" id="L529">            }</span>
        });
<span class="nc" id="L531">    }</span>

    @Override
    public InputStream generateDiagram(BpmnModel bpmnModel, String imageType, List&lt;String&gt; highLightedActivities, List&lt;String&gt; highLightedFlows,
            String activityFontName, String labelFontName, String annotationFontName, ClassLoader customClassLoader, double scaleFactor,boolean drawSequenceFlowNameWithNoLabelDI) {

<span class="nc" id="L537">        return generateProcessDiagram(bpmnModel, imageType, highLightedActivities, highLightedFlows,</span>
<span class="nc" id="L538">                activityFontName, labelFontName, annotationFontName, customClassLoader, scaleFactor,drawSequenceFlowNameWithNoLabelDI).generateImage(imageType);</span>
    }

    @Override
    public InputStream generateDiagram(BpmnModel bpmnModel, String imageType, List&lt;String&gt; highLightedActivities, List&lt;String&gt; highLightedFlows,boolean drawSequenceFlowNameWithNoLabelDI) {
<span class="nc" id="L543">        return generateDiagram(bpmnModel, imageType, highLightedActivities, highLightedFlows, null, null, null, null, 1.0,drawSequenceFlowNameWithNoLabelDI);</span>
    }

    @Override
    public InputStream generateDiagram(BpmnModel bpmnModel, String imageType,
            List&lt;String&gt; highLightedActivities, List&lt;String&gt; highLightedFlows, double scaleFactor,boolean drawSequenceFlowNameWithNoLabelDI) {
<span class="nc" id="L549">        return generateDiagram(bpmnModel, imageType, highLightedActivities, highLightedFlows, null, null, null, null, scaleFactor,drawSequenceFlowNameWithNoLabelDI);</span>
    }

    @Override
    public InputStream generateDiagram(BpmnModel bpmnModel, String imageType, List&lt;String&gt; highLightedActivities,boolean drawSequenceFlowNameWithNoLabelDI) {
<span class="nc" id="L554">        return generateDiagram(bpmnModel, imageType, highLightedActivities, Collections.emptyList(),drawSequenceFlowNameWithNoLabelDI);</span>
    }

    @Override
    public InputStream generateDiagram(BpmnModel bpmnModel, String imageType, List&lt;String&gt; highLightedActivities, double scaleFactor,boolean drawSequenceFlowNameWithNoLabelDI) {
<span class="nc" id="L559">        return generateDiagram(bpmnModel, imageType, highLightedActivities, Collections.emptyList(), scaleFactor,drawSequenceFlowNameWithNoLabelDI);</span>
    }

    @Override
    public InputStream generateDiagram(BpmnModel bpmnModel, String imageType, String activityFontName,
            String labelFontName, String annotationFontName, ClassLoader customClassLoader,boolean drawSequenceFlowNameWithNoLabelDI) {

<span class="nc" id="L566">        return generateDiagram(bpmnModel, imageType, Collections.emptyList(), Collections.emptyList(),</span>
                activityFontName, labelFontName, annotationFontName, customClassLoader, 1.0,drawSequenceFlowNameWithNoLabelDI);
    }

    @Override
    public InputStream generateDiagram(BpmnModel bpmnModel, String imageType, String activityFontName,
            String labelFontName, String annotationFontName, ClassLoader customClassLoader, double scaleFactor,boolean drawSequenceFlowNameWithNoLabelDI) {

<span class="nc" id="L574">        return generateDiagram(bpmnModel, imageType, Collections.emptyList(), Collections.emptyList(),</span>
                activityFontName, labelFontName, annotationFontName, customClassLoader, scaleFactor,drawSequenceFlowNameWithNoLabelDI);
    }

    @Override
    public InputStream generatePngDiagram(BpmnModel bpmnModel,boolean drawSequenceFlowNameWithNoLabelDI) {
<span class="nc" id="L580">        return generatePngDiagram(bpmnModel, 1.0,drawSequenceFlowNameWithNoLabelDI);</span>
    }

    @Override
    public InputStream generatePngDiagram(BpmnModel bpmnModel, double scaleFactor,boolean drawSequenceFlowNameWithNoLabelDI) {
<span class="nc" id="L585">        return generateDiagram(bpmnModel, &quot;png&quot;, Collections.emptyList(), Collections.emptyList(), scaleFactor,drawSequenceFlowNameWithNoLabelDI);</span>
    }

    @Override
    public InputStream generateJpgDiagram(BpmnModel bpmnModel) {
<span class="nc" id="L590">        return generateJpgDiagram(bpmnModel, 1.0,false);</span>
    }

    @Override
    public InputStream generateJpgDiagram(BpmnModel bpmnModel, double scaleFactor,boolean drawSequenceFlowNameWithNoLabelDI) {
<span class="nc" id="L595">        return generateDiagram(bpmnModel, &quot;jpg&quot;, Collections.emptyList(), Collections.emptyList(),drawSequenceFlowNameWithNoLabelDI);</span>
    }

    public BufferedImage generateImage(BpmnModel bpmnModel, String imageType, List&lt;String&gt; highLightedActivities, List&lt;String&gt; highLightedFlows,
            String activityFontName, String labelFontName, String annotationFontName, ClassLoader customClassLoader, double scaleFactor,boolean drawSequenceFlowNameWithNoLabelDI) {

<span class="nc" id="L601">        return generateProcessDiagram(bpmnModel, imageType, highLightedActivities, highLightedFlows,</span>
<span class="nc" id="L602">                activityFontName, labelFontName, annotationFontName, customClassLoader, scaleFactor,drawSequenceFlowNameWithNoLabelDI).generateBufferedImage(imageType);</span>
    }

    public BufferedImage generateImage(BpmnModel bpmnModel, String imageType,
            List&lt;String&gt; highLightedActivities, List&lt;String&gt; highLightedFlows, double scaleFactor,boolean drawSequenceFlowNameWithNoLabelDI) {

<span class="nc" id="L608">        return generateImage(bpmnModel, imageType, highLightedActivities, highLightedFlows, null, null, null, null, scaleFactor,drawSequenceFlowNameWithNoLabelDI);</span>
    }

    @Override
    public BufferedImage generatePngImage(BpmnModel bpmnModel, double scaleFactor) {
<span class="nc" id="L613">        return generateImage(bpmnModel, &quot;png&quot;, Collections.emptyList(), Collections.emptyList(), scaleFactor,false);</span>
    }

    protected DefaultProcessDiagramCanvas generateProcessDiagram(BpmnModel bpmnModel, String imageType,
            List&lt;String&gt; highLightedActivities, List&lt;String&gt; highLightedFlows,
            String activityFontName, String labelFontName, String annotationFontName, ClassLoader customClassLoader, double scaleFactor,boolean drawSequenceFlowNameWithNoLabelDI) {

<span class="nc" id="L620">        prepareBpmnModel(bpmnModel);</span>

<span class="nc" id="L622">        DefaultProcessDiagramCanvas processDiagramCanvas = initProcessDiagramCanvas(bpmnModel, imageType, activityFontName, labelFontName, annotationFontName, customClassLoader);</span>

        // Draw pool shape, if process is participant in collaboration
<span class="nc bnc" id="L625" title="All 2 branches missed.">        for (Pool pool : bpmnModel.getPools()) {</span>
<span class="nc" id="L626">            GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(pool.getId());</span>
<span class="nc" id="L627">            processDiagramCanvas.drawPoolOrLane(pool.getName(), graphicInfo, scaleFactor);</span>
<span class="nc" id="L628">        }</span>

        // Draw lanes
<span class="nc bnc" id="L631" title="All 2 branches missed.">        for (Process process : bpmnModel.getProcesses()) {</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">            for (Lane lane : process.getLanes()) {</span>
<span class="nc" id="L633">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(lane.getId());</span>
<span class="nc" id="L634">                processDiagramCanvas.drawPoolOrLane(lane.getName(), graphicInfo, scaleFactor);</span>
<span class="nc" id="L635">            }</span>
<span class="nc" id="L636">        }</span>

        // Draw activities and their sequence-flows
<span class="nc bnc" id="L639" title="All 2 branches missed.">        for (Process process : bpmnModel.getProcesses()) {</span>
<span class="nc bnc" id="L640" title="All 2 branches missed.">            for (FlowNode flowNode : process.findFlowElementsOfType(FlowNode.class)) {</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">                if (!isPartOfCollapsedSubProcess(flowNode, bpmnModel)) {</span>
<span class="nc" id="L642">                    drawActivity(processDiagramCanvas, bpmnModel, flowNode, highLightedActivities, highLightedFlows, scaleFactor,drawSequenceFlowNameWithNoLabelDI);</span>
                }
<span class="nc" id="L644">            }</span>
<span class="nc" id="L645">        }</span>

        // Draw artifacts
<span class="nc bnc" id="L648" title="All 2 branches missed.">        for (Process process : bpmnModel.getProcesses()) {</span>

<span class="nc bnc" id="L650" title="All 2 branches missed.">            for (Artifact artifact : process.getArtifacts()) {</span>
<span class="nc" id="L651">                drawArtifact(processDiagramCanvas, bpmnModel, artifact);</span>
<span class="nc" id="L652">            }</span>

<span class="nc" id="L654">            List&lt;SubProcess&gt; subProcesses = process.findFlowElementsOfType(SubProcess.class, true);</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">            if (subProcesses != null) {</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">                for (SubProcess subProcess : subProcesses) {</span>
                    
<span class="nc" id="L658">                    GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(subProcess.getId());</span>
<span class="nc bnc" id="L659" title="All 6 branches missed.">                    if (graphicInfo != null &amp;&amp; graphicInfo.getExpanded() != null &amp;&amp; !graphicInfo.getExpanded()) {</span>
<span class="nc" id="L660">                        continue;</span>
                    }
                    
<span class="nc bnc" id="L663" title="All 2 branches missed.">                    if (!isPartOfCollapsedSubProcess(subProcess, bpmnModel)) {</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">                        for (Artifact subProcessArtifact : subProcess.getArtifacts()) {</span>
<span class="nc" id="L665">                            drawArtifact(processDiagramCanvas, bpmnModel, subProcessArtifact);</span>
<span class="nc" id="L666">                        }</span>
                    }
<span class="nc" id="L668">                }</span>
            }
<span class="nc" id="L670">        }</span>

<span class="nc" id="L672">        return processDiagramCanvas;</span>
    }

    protected void prepareBpmnModel(BpmnModel bpmnModel) {

        // Need to make sure all elements have positive x and y.
        // Check all graphicInfo and update the elements accordingly

<span class="nc" id="L680">        List&lt;GraphicInfo&gt; allGraphicInfos = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">        if (bpmnModel.getLocationMap() != null) {</span>
<span class="nc" id="L682">            allGraphicInfos.addAll(bpmnModel.getLocationMap().values());</span>
        }
<span class="nc bnc" id="L684" title="All 2 branches missed.">        if (bpmnModel.getLabelLocationMap() != null) {</span>
<span class="nc" id="L685">            allGraphicInfos.addAll(bpmnModel.getLabelLocationMap().values());</span>
        }
<span class="nc bnc" id="L687" title="All 2 branches missed.">        if (bpmnModel.getFlowLocationMap() != null) {</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">            for (List&lt;GraphicInfo&gt; flowGraphicInfos : bpmnModel.getFlowLocationMap().values()) {</span>
<span class="nc" id="L689">                allGraphicInfos.addAll(flowGraphicInfos);</span>
<span class="nc" id="L690">            }</span>
        }

<span class="nc bnc" id="L693" title="All 2 branches missed.">        if (allGraphicInfos.size() &gt; 0) {</span>

<span class="nc" id="L695">            boolean needsTranslationX = false;</span>
<span class="nc" id="L696">            boolean needsTranslationY = false;</span>

<span class="nc" id="L698">            double lowestX = 0.0;</span>
<span class="nc" id="L699">            double lowestY = 0.0;</span>

            // Collect lowest x and y
<span class="nc bnc" id="L702" title="All 2 branches missed.">            for (GraphicInfo graphicInfo : allGraphicInfos) {</span>

<span class="nc" id="L704">                double x = graphicInfo.getX();</span>
<span class="nc" id="L705">                double y = graphicInfo.getY();</span>

<span class="nc bnc" id="L707" title="All 2 branches missed.">                if (x &lt; lowestX) {</span>
<span class="nc" id="L708">                    needsTranslationX = true;</span>
<span class="nc" id="L709">                    lowestX = x;</span>
                }
<span class="nc bnc" id="L711" title="All 2 branches missed.">                if (y &lt; lowestY) {</span>
<span class="nc" id="L712">                    needsTranslationY = true;</span>
<span class="nc" id="L713">                    lowestY = y;</span>
                }

<span class="nc" id="L716">            }</span>

            // Update all graphicInfo objects
<span class="nc bnc" id="L719" title="All 4 branches missed.">            if (needsTranslationX || needsTranslationY) {</span>

<span class="nc" id="L721">                double translationX = Math.abs(lowestX);</span>
<span class="nc" id="L722">                double translationY = Math.abs(lowestY);</span>

<span class="nc bnc" id="L724" title="All 2 branches missed.">                for (GraphicInfo graphicInfo : allGraphicInfos) {</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">                    if (needsTranslationX) {</span>
<span class="nc" id="L726">                        graphicInfo.setX(graphicInfo.getX() + translationX);</span>
                    }
<span class="nc bnc" id="L728" title="All 2 branches missed.">                    if (needsTranslationY) {</span>
<span class="nc" id="L729">                        graphicInfo.setY(graphicInfo.getY() + translationY);</span>
                    }
<span class="nc" id="L731">                }</span>
            }

        }

<span class="nc" id="L736">    }</span>

    protected void drawActivity(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel,
            FlowNode flowNode, List&lt;String&gt; highLightedActivities, List&lt;String&gt; highLightedFlows, double scaleFactor,Boolean drawSequenceFlowNameWithNoLabelDI ) {

<span class="nc" id="L741">        ActivityDrawInstruction drawInstruction = activityDrawInstructions.get(flowNode.getClass());</span>
<span class="nc bnc" id="L742" title="All 2 branches missed.">        if (drawInstruction != null) {</span>

<span class="nc" id="L744">            drawInstruction.draw(processDiagramCanvas, bpmnModel, flowNode);</span>

            // Gather info on the multi instance marker
<span class="nc" id="L747">            boolean multiInstanceSequential = false;</span>
<span class="nc" id="L748">            boolean multiInstanceParallel = false;</span>
<span class="nc" id="L749">            boolean collapsed = false;</span>
<span class="nc bnc" id="L750" title="All 2 branches missed.">            if (flowNode instanceof Activity) {</span>
<span class="nc" id="L751">                Activity activity = (Activity) flowNode;</span>
<span class="nc" id="L752">                MultiInstanceLoopCharacteristics multiInstanceLoopCharacteristics = activity.getLoopCharacteristics();</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">                if (multiInstanceLoopCharacteristics != null) {</span>
<span class="nc" id="L754">                    multiInstanceSequential = multiInstanceLoopCharacteristics.isSequential();</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">                    multiInstanceParallel = !multiInstanceSequential;</span>
                }
            }

            // Gather info on the collapsed marker
<span class="nc" id="L760">            GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>
<span class="nc bnc" id="L761" title="All 2 branches missed.">            if (flowNode instanceof SubProcess) {</span>
<span class="nc bnc" id="L762" title="All 4 branches missed.">                collapsed = graphicInfo.getExpanded() != null &amp;&amp; !graphicInfo.getExpanded();</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">            } else if (flowNode instanceof CallActivity) {</span>
<span class="nc" id="L764">                collapsed = true;</span>
            }

<span class="nc bnc" id="L767" title="All 2 branches missed.">            if (scaleFactor == 1.0) {</span>
                // Actually draw the markers
<span class="nc" id="L769">                processDiagramCanvas.drawActivityMarkers((int) graphicInfo.getX(), (int) graphicInfo.getY(), (int) graphicInfo.getWidth(), (int) graphicInfo.getHeight(),</span>
                        multiInstanceSequential, multiInstanceParallel, collapsed);
            }

            // Draw highlighted activities
<span class="nc bnc" id="L774" title="All 2 branches missed.">            if (highLightedActivities.contains(flowNode.getId())) {</span>
<span class="nc" id="L775">                drawHighLight(processDiagramCanvas, bpmnModel.getGraphicInfo(flowNode.getId()));</span>
            }

<span class="nc bnc" id="L778" title="All 2 branches missed.">        } else if (flowNode instanceof Task) {</span>
<span class="nc" id="L779">            activityDrawInstructions.get(Task.class).draw(processDiagramCanvas, bpmnModel, flowNode);</span>
            
<span class="nc bnc" id="L781" title="All 2 branches missed.">            if (highLightedActivities.contains(flowNode.getId())) {</span>
<span class="nc" id="L782">                drawHighLight(processDiagramCanvas, bpmnModel.getGraphicInfo(flowNode.getId()));</span>
            }
        }

        // Outgoing transitions of activity
<span class="nc bnc" id="L787" title="All 2 branches missed.">        for (SequenceFlow sequenceFlow : flowNode.getOutgoingFlows()) {</span>
<span class="nc" id="L788">            boolean highLighted = (highLightedFlows.contains(sequenceFlow.getId()));</span>
<span class="nc" id="L789">            String defaultFlow = null;</span>
<span class="nc bnc" id="L790" title="All 2 branches missed.">            if (flowNode instanceof Activity) {</span>
<span class="nc" id="L791">                defaultFlow = ((Activity) flowNode).getDefaultFlow();</span>
<span class="nc bnc" id="L792" title="All 2 branches missed.">            } else if (flowNode instanceof Gateway) {</span>
<span class="nc" id="L793">                defaultFlow = ((Gateway) flowNode).getDefaultFlow();</span>
            }

<span class="nc" id="L796">            boolean isDefault = false;</span>
<span class="nc bnc" id="L797" title="All 4 branches missed.">            if (defaultFlow != null &amp;&amp; defaultFlow.equalsIgnoreCase(sequenceFlow.getId())) {</span>
<span class="nc" id="L798">                isDefault = true;</span>
            }
<span class="nc bnc" id="L800" title="All 6 branches missed.">            boolean drawConditionalIndicator = sequenceFlow.getConditionExpression() != null &amp;&amp; sequenceFlow.getConditionExpression().trim().length() &gt; 0 &amp;&amp; !(flowNode instanceof Gateway);</span>

<span class="nc" id="L802">            String sourceRef = sequenceFlow.getSourceRef();</span>
<span class="nc" id="L803">            String targetRef = sequenceFlow.getTargetRef();</span>
<span class="nc" id="L804">            FlowElement sourceElement = bpmnModel.getFlowElement(sourceRef);</span>
<span class="nc" id="L805">            FlowElement targetElement = bpmnModel.getFlowElement(targetRef);</span>
<span class="nc" id="L806">            List&lt;GraphicInfo&gt; graphicInfoList = bpmnModel.getFlowLocationGraphicInfo(sequenceFlow.getId());</span>
<span class="nc bnc" id="L807" title="All 4 branches missed.">            if (graphicInfoList != null &amp;&amp; graphicInfoList.size() &gt; 0) {</span>
<span class="nc" id="L808">                graphicInfoList = connectionPerfectionizer(processDiagramCanvas, bpmnModel, sourceElement, targetElement, graphicInfoList);</span>
<span class="nc" id="L809">                int[] xPoints = new int[graphicInfoList.size()];</span>
<span class="nc" id="L810">                int[] yPoints = new int[graphicInfoList.size()];</span>

<span class="nc bnc" id="L812" title="All 2 branches missed.">                for (int i = 1; i &lt; graphicInfoList.size(); i++) {</span>
<span class="nc" id="L813">                    GraphicInfo graphicInfo = graphicInfoList.get(i);</span>
<span class="nc" id="L814">                    GraphicInfo previousGraphicInfo = graphicInfoList.get(i - 1);</span>

<span class="nc bnc" id="L816" title="All 2 branches missed.">                    if (i == 1) {</span>
<span class="nc" id="L817">                        xPoints[0] = (int) previousGraphicInfo.getX();</span>
<span class="nc" id="L818">                        yPoints[0] = (int) previousGraphicInfo.getY();</span>
                    }
<span class="nc" id="L820">                    xPoints[i] = (int) graphicInfo.getX();</span>
<span class="nc" id="L821">                    yPoints[i] = (int) graphicInfo.getY();</span>

                }

<span class="nc" id="L825">                processDiagramCanvas.drawSequenceflow(xPoints, yPoints, drawConditionalIndicator, isDefault, highLighted, scaleFactor);</span>

                // Draw sequenceflow label
<span class="nc" id="L828">                GraphicInfo labelGraphicInfo = bpmnModel.getLabelGraphicInfo(sequenceFlow.getId());</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">                if (labelGraphicInfo != null) {</span>
<span class="nc" id="L830">                    processDiagramCanvas.drawLabel(sequenceFlow.getName(), labelGraphicInfo, false);</span>
                } else {
<span class="nc bnc" id="L832" title="All 2 branches missed.">                    if (drawSequenceFlowNameWithNoLabelDI) {</span>
<span class="nc" id="L833">                        GraphicInfo lineCenter = getLineCenter(graphicInfoList);</span>
<span class="nc" id="L834">                        processDiagramCanvas.drawLabel(sequenceFlow.getName(), lineCenter, false); </span>
                    }
                    
                }
            }
<span class="nc" id="L839">        }</span>

        // Nested elements
<span class="nc bnc" id="L842" title="All 2 branches missed.">        if (flowNode instanceof FlowElementsContainer) {</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">            for (FlowElement nestedFlowElement : ((FlowElementsContainer) flowNode).getFlowElements()) {</span>
<span class="nc bnc" id="L844" title="All 4 branches missed.">                if (nestedFlowElement instanceof FlowNode &amp;&amp; !isPartOfCollapsedSubProcess(nestedFlowElement, bpmnModel)) {</span>
<span class="nc" id="L845">                    drawActivity(processDiagramCanvas, bpmnModel, (FlowNode) nestedFlowElement,</span>
                            highLightedActivities, highLightedFlows, scaleFactor,drawSequenceFlowNameWithNoLabelDI);
                }
<span class="nc" id="L848">            }</span>
        }
<span class="nc" id="L850">    }</span>

    /**
     * This method makes coordinates of connection flow better.
     * 
     * @param processDiagramCanvas
     * @param bpmnModel
     * @param sourceElement
     * @param targetElement
     * @param graphicInfoList
     * @return
     */
    protected static List&lt;GraphicInfo&gt; connectionPerfectionizer(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, BaseElement sourceElement, BaseElement targetElement, List&lt;GraphicInfo&gt; graphicInfoList) {
<span class="nc" id="L863">        GraphicInfo sourceGraphicInfo = bpmnModel.getGraphicInfo(sourceElement.getId());</span>
<span class="nc" id="L864">        GraphicInfo targetGraphicInfo = bpmnModel.getGraphicInfo(targetElement.getId());</span>

<span class="nc" id="L866">        DefaultProcessDiagramCanvas.SHAPE_TYPE sourceShapeType = getShapeType(sourceElement);</span>
<span class="nc" id="L867">        DefaultProcessDiagramCanvas.SHAPE_TYPE targetShapeType = getShapeType(targetElement);</span>

<span class="nc" id="L869">        return processDiagramCanvas.connectionPerfectionizer(sourceShapeType, targetShapeType, sourceGraphicInfo, targetGraphicInfo, graphicInfoList);</span>
    }

    /**
     * This method returns shape type of base element.&lt;br&gt;
     * Each element can be presented as rectangle, rhombus, or ellipse.
     * 
     * @param baseElement
     * @return DefaultProcessDiagramCanvas.SHAPE_TYPE
     */
    protected static DefaultProcessDiagramCanvas.SHAPE_TYPE getShapeType(BaseElement baseElement) {
<span class="nc bnc" id="L880" title="All 6 branches missed.">        if (baseElement instanceof Task || baseElement instanceof Activity || baseElement instanceof TextAnnotation) {</span>
<span class="nc" id="L881">            return DefaultProcessDiagramCanvas.SHAPE_TYPE.Rectangle;</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">        } else if (baseElement instanceof Gateway) {</span>
<span class="nc" id="L883">            return DefaultProcessDiagramCanvas.SHAPE_TYPE.Rhombus;</span>
<span class="nc bnc" id="L884" title="All 2 branches missed.">        } else if (baseElement instanceof Event) {</span>
<span class="nc" id="L885">            return DefaultProcessDiagramCanvas.SHAPE_TYPE.Ellipse;</span>
        } else {
            // unknown source element, just do not correct coordinates
        }
<span class="nc" id="L889">        return null;</span>
    }

    protected static GraphicInfo getLineCenter(List&lt;GraphicInfo&gt; graphicInfoList) {
<span class="nc" id="L893">        GraphicInfo gi = new GraphicInfo();</span>

<span class="nc" id="L895">        int[] xPoints = new int[graphicInfoList.size()];</span>
<span class="nc" id="L896">        int[] yPoints = new int[graphicInfoList.size()];</span>

<span class="nc" id="L898">        double length = 0;</span>
<span class="nc" id="L899">        double[] lengths = new double[graphicInfoList.size()];</span>
<span class="nc" id="L900">        lengths[0] = 0;</span>
        double m;
<span class="nc bnc" id="L902" title="All 2 branches missed.">        for (int i = 1; i &lt; graphicInfoList.size(); i++) {</span>
<span class="nc" id="L903">            GraphicInfo graphicInfo = graphicInfoList.get(i);</span>
<span class="nc" id="L904">            GraphicInfo previousGraphicInfo = graphicInfoList.get(i - 1);</span>

<span class="nc bnc" id="L906" title="All 2 branches missed.">            if (i == 1) {</span>
<span class="nc" id="L907">                xPoints[0] = (int) previousGraphicInfo.getX();</span>
<span class="nc" id="L908">                yPoints[0] = (int) previousGraphicInfo.getY();</span>
            }
<span class="nc" id="L910">            xPoints[i] = (int) graphicInfo.getX();</span>
<span class="nc" id="L911">            yPoints[i] = (int) graphicInfo.getY();</span>

<span class="nc" id="L913">            length += Math.sqrt(</span>
<span class="nc" id="L914">                    Math.pow((int) graphicInfo.getX() - (int) previousGraphicInfo.getX(), 2) +</span>
<span class="nc" id="L915">                            Math.pow((int) graphicInfo.getY() - (int) previousGraphicInfo.getY(), 2));</span>
<span class="nc" id="L916">            lengths[i] = length;</span>
        }
<span class="nc" id="L918">        m = length / 2;</span>
<span class="nc" id="L919">        int p1 = 0;</span>
<span class="nc" id="L920">        int p2 = 1;</span>
<span class="nc bnc" id="L921" title="All 2 branches missed.">        for (int i = 1; i &lt; lengths.length; i++) {</span>
<span class="nc" id="L922">            double len = lengths[i];</span>
<span class="nc" id="L923">            p1 = i - 1;</span>
<span class="nc" id="L924">            p2 = i;</span>
<span class="nc bnc" id="L925" title="All 2 branches missed.">            if (len &gt; m) {</span>
<span class="nc" id="L926">                break;</span>
            }
        }

<span class="nc" id="L930">        GraphicInfo graphicInfo1 = graphicInfoList.get(p1);</span>
<span class="nc" id="L931">        GraphicInfo graphicInfo2 = graphicInfoList.get(p2);</span>

<span class="nc" id="L933">        double AB = (int) graphicInfo2.getX() - (int) graphicInfo1.getX();</span>
<span class="nc" id="L934">        double OA = (int) graphicInfo2.getY() - (int) graphicInfo1.getY();</span>
<span class="nc" id="L935">        double OB = lengths[p2] - lengths[p1];</span>
<span class="nc" id="L936">        double ob = m - lengths[p1];</span>
<span class="nc" id="L937">        double ab = AB * ob / OB;</span>
<span class="nc" id="L938">        double oa = OA * ob / OB;</span>

<span class="nc" id="L940">        double mx = graphicInfo1.getX() + ab;</span>
<span class="nc" id="L941">        double my = graphicInfo1.getY() + oa;</span>

<span class="nc" id="L943">        gi.setX(mx);</span>
<span class="nc" id="L944">        gi.setY(my);</span>
<span class="nc" id="L945">        return gi;</span>
    }

    protected void drawArtifact(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, Artifact artifact) {

<span class="nc" id="L950">        ArtifactDrawInstruction drawInstruction = artifactDrawInstructions.get(artifact.getClass());</span>
<span class="nc bnc" id="L951" title="All 2 branches missed.">        if (drawInstruction != null) {</span>
<span class="nc" id="L952">            drawInstruction.draw(processDiagramCanvas, bpmnModel, artifact);</span>
        }
<span class="nc" id="L954">    }</span>

    private static void drawHighLight(DefaultProcessDiagramCanvas processDiagramCanvas, GraphicInfo graphicInfo) {
<span class="nc" id="L957">        processDiagramCanvas.drawHighLight((int) graphicInfo.getX(), (int) graphicInfo.getY(), (int) graphicInfo.getWidth(), (int) graphicInfo.getHeight());</span>

<span class="nc" id="L959">    }</span>

    protected static DefaultProcessDiagramCanvas initProcessDiagramCanvas(BpmnModel bpmnModel, String imageType,
            String activityFontName, String labelFontName, String annotationFontName, ClassLoader customClassLoader) {

        // We need to calculate maximum values to know how big the image will be in its entirety
<span class="nc" id="L965">        double minX = Double.MAX_VALUE;</span>
<span class="nc" id="L966">        double maxX = 0;</span>
<span class="nc" id="L967">        double minY = Double.MAX_VALUE;</span>
<span class="nc" id="L968">        double maxY = 0;</span>

<span class="nc bnc" id="L970" title="All 2 branches missed.">        for (Pool pool : bpmnModel.getPools()) {</span>
<span class="nc" id="L971">            GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(pool.getId());</span>
<span class="nc" id="L972">            minX = graphicInfo.getX();</span>
<span class="nc" id="L973">            maxX = graphicInfo.getX() + graphicInfo.getWidth();</span>
<span class="nc" id="L974">            minY = graphicInfo.getY();</span>
<span class="nc" id="L975">            maxY = graphicInfo.getY() + graphicInfo.getHeight();</span>
<span class="nc" id="L976">        }</span>

<span class="nc" id="L978">        List&lt;FlowNode&gt; flowNodes = gatherAllFlowNodes(bpmnModel);</span>
<span class="nc bnc" id="L979" title="All 2 branches missed.">        for (FlowNode flowNode : flowNodes) {</span>

<span class="nc" id="L981">            GraphicInfo flowNodeGraphicInfo = bpmnModel.getGraphicInfo(flowNode.getId());</span>

            // width
<span class="nc bnc" id="L984" title="All 2 branches missed.">            if (flowNodeGraphicInfo.getX() + flowNodeGraphicInfo.getWidth() &gt; maxX) {</span>
<span class="nc" id="L985">                maxX = flowNodeGraphicInfo.getX() + flowNodeGraphicInfo.getWidth();</span>
            }
<span class="nc bnc" id="L987" title="All 2 branches missed.">            if (flowNodeGraphicInfo.getX() &lt; minX) {</span>
<span class="nc" id="L988">                minX = flowNodeGraphicInfo.getX();</span>
            }
            // height
<span class="nc bnc" id="L991" title="All 2 branches missed.">            if (flowNodeGraphicInfo.getY() + flowNodeGraphicInfo.getHeight() &gt; maxY) {</span>
<span class="nc" id="L992">                maxY = flowNodeGraphicInfo.getY() + flowNodeGraphicInfo.getHeight();</span>
            }
<span class="nc bnc" id="L994" title="All 2 branches missed.">            if (flowNodeGraphicInfo.getY() &lt; minY) {</span>
<span class="nc" id="L995">                minY = flowNodeGraphicInfo.getY();</span>
            }

<span class="nc bnc" id="L998" title="All 2 branches missed.">            for (SequenceFlow sequenceFlow : flowNode.getOutgoingFlows()) {</span>
<span class="nc" id="L999">                List&lt;GraphicInfo&gt; graphicInfoList = bpmnModel.getFlowLocationGraphicInfo(sequenceFlow.getId());</span>
<span class="nc bnc" id="L1000" title="All 2 branches missed.">                if (graphicInfoList != null) {</span>
<span class="nc bnc" id="L1001" title="All 2 branches missed.">                    for (GraphicInfo graphicInfo : graphicInfoList) {</span>
                        // width
<span class="nc bnc" id="L1003" title="All 2 branches missed.">                        if (graphicInfo.getX() &gt; maxX) {</span>
<span class="nc" id="L1004">                            maxX = graphicInfo.getX();</span>
                        }
<span class="nc bnc" id="L1006" title="All 2 branches missed.">                        if (graphicInfo.getX() &lt; minX) {</span>
<span class="nc" id="L1007">                            minX = graphicInfo.getX();</span>
                        }
                        // height
<span class="nc bnc" id="L1010" title="All 2 branches missed.">                        if (graphicInfo.getY() &gt; maxY) {</span>
<span class="nc" id="L1011">                            maxY = graphicInfo.getY();</span>
                        }
<span class="nc bnc" id="L1013" title="All 2 branches missed.">                        if (graphicInfo.getY() &lt; minY) {</span>
<span class="nc" id="L1014">                            minY = graphicInfo.getY();</span>
                        }
<span class="nc" id="L1016">                    }</span>
                }
<span class="nc" id="L1018">            }</span>
<span class="nc" id="L1019">        }</span>

<span class="nc" id="L1021">        List&lt;Artifact&gt; artifacts = gatherAllArtifacts(bpmnModel);</span>
<span class="nc bnc" id="L1022" title="All 2 branches missed.">        for (Artifact artifact : artifacts) {</span>

<span class="nc" id="L1024">            GraphicInfo artifactGraphicInfo = bpmnModel.getGraphicInfo(artifact.getId());</span>

<span class="nc bnc" id="L1026" title="All 2 branches missed.">            if (artifactGraphicInfo != null) {</span>
                // width
<span class="nc bnc" id="L1028" title="All 2 branches missed.">                if (artifactGraphicInfo.getX() + artifactGraphicInfo.getWidth() &gt; maxX) {</span>
<span class="nc" id="L1029">                    maxX = artifactGraphicInfo.getX() + artifactGraphicInfo.getWidth();</span>
                }
<span class="nc bnc" id="L1031" title="All 2 branches missed.">                if (artifactGraphicInfo.getX() &lt; minX) {</span>
<span class="nc" id="L1032">                    minX = artifactGraphicInfo.getX();</span>
                }
                // height
<span class="nc bnc" id="L1035" title="All 2 branches missed.">                if (artifactGraphicInfo.getY() + artifactGraphicInfo.getHeight() &gt; maxY) {</span>
<span class="nc" id="L1036">                    maxY = artifactGraphicInfo.getY() + artifactGraphicInfo.getHeight();</span>
                }
<span class="nc bnc" id="L1038" title="All 2 branches missed.">                if (artifactGraphicInfo.getY() &lt; minY) {</span>
<span class="nc" id="L1039">                    minY = artifactGraphicInfo.getY();</span>
                }
            }

<span class="nc" id="L1043">            List&lt;GraphicInfo&gt; graphicInfoList = bpmnModel.getFlowLocationGraphicInfo(artifact.getId());</span>
<span class="nc bnc" id="L1044" title="All 2 branches missed.">            if (graphicInfoList != null) {</span>
<span class="nc bnc" id="L1045" title="All 2 branches missed.">                for (GraphicInfo graphicInfo : graphicInfoList) {</span>
                    // width
<span class="nc bnc" id="L1047" title="All 2 branches missed.">                    if (graphicInfo.getX() &gt; maxX) {</span>
<span class="nc" id="L1048">                        maxX = graphicInfo.getX();</span>
                    }
<span class="nc bnc" id="L1050" title="All 2 branches missed.">                    if (graphicInfo.getX() &lt; minX) {</span>
<span class="nc" id="L1051">                        minX = graphicInfo.getX();</span>
                    }
                    // height
<span class="nc bnc" id="L1054" title="All 2 branches missed.">                    if (graphicInfo.getY() &gt; maxY) {</span>
<span class="nc" id="L1055">                        maxY = graphicInfo.getY();</span>
                    }
<span class="nc bnc" id="L1057" title="All 2 branches missed.">                    if (graphicInfo.getY() &lt; minY) {</span>
<span class="nc" id="L1058">                        minY = graphicInfo.getY();</span>
                    }
<span class="nc" id="L1060">                }</span>
            }
<span class="nc" id="L1062">        }</span>

<span class="nc" id="L1064">        int nrOfLanes = 0;</span>
<span class="nc bnc" id="L1065" title="All 2 branches missed.">        for (Process process : bpmnModel.getProcesses()) {</span>
<span class="nc bnc" id="L1066" title="All 2 branches missed.">            for (Lane l : process.getLanes()) {</span>

<span class="nc" id="L1068">                nrOfLanes++;</span>

<span class="nc" id="L1070">                GraphicInfo graphicInfo = bpmnModel.getGraphicInfo(l.getId());</span>
                // // width
<span class="nc bnc" id="L1072" title="All 2 branches missed.">                if (graphicInfo.getX() + graphicInfo.getWidth() &gt; maxX) {</span>
<span class="nc" id="L1073">                    maxX = graphicInfo.getX() + graphicInfo.getWidth();</span>
                }
<span class="nc bnc" id="L1075" title="All 2 branches missed.">                if (graphicInfo.getX() &lt; minX) {</span>
<span class="nc" id="L1076">                    minX = graphicInfo.getX();</span>
                }
                // height
<span class="nc bnc" id="L1079" title="All 2 branches missed.">                if (graphicInfo.getY() + graphicInfo.getHeight() &gt; maxY) {</span>
<span class="nc" id="L1080">                    maxY = graphicInfo.getY() + graphicInfo.getHeight();</span>
                }
<span class="nc bnc" id="L1082" title="All 2 branches missed.">                if (graphicInfo.getY() &lt; minY) {</span>
<span class="nc" id="L1083">                    minY = graphicInfo.getY();</span>
                }
<span class="nc" id="L1085">            }</span>
<span class="nc" id="L1086">        }</span>

        // Special case, see https://activiti.atlassian.net/browse/ACT-1431
<span class="nc bnc" id="L1089" title="All 6 branches missed.">        if (flowNodes.isEmpty() &amp;&amp; bpmnModel.getPools().isEmpty() &amp;&amp; nrOfLanes == 0) {</span>
            // Nothing to show
<span class="nc" id="L1091">            minX = 0;</span>
<span class="nc" id="L1092">            minY = 0;</span>
        }

<span class="nc" id="L1095">        return new DefaultProcessDiagramCanvas((int) maxX + 10, (int) maxY + 10, (int) minX, (int) minY,</span>
                imageType, activityFontName, labelFontName, annotationFontName, customClassLoader);
    }

    protected static List&lt;Artifact&gt; gatherAllArtifacts(BpmnModel bpmnModel) {
<span class="nc" id="L1100">        List&lt;Artifact&gt; artifacts = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1101" title="All 2 branches missed.">        for (Process process : bpmnModel.getProcesses()) {</span>
<span class="nc" id="L1102">            artifacts.addAll(process.getArtifacts());</span>
<span class="nc" id="L1103">        }</span>
<span class="nc" id="L1104">        return artifacts;</span>
    }

    protected static List&lt;FlowNode&gt; gatherAllFlowNodes(BpmnModel bpmnModel) {
<span class="nc" id="L1108">        List&lt;FlowNode&gt; flowNodes = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1109" title="All 2 branches missed.">        for (Process process : bpmnModel.getProcesses()) {</span>
<span class="nc" id="L1110">            flowNodes.addAll(gatherAllFlowNodes(process));</span>
<span class="nc" id="L1111">        }</span>
<span class="nc" id="L1112">        return flowNodes;</span>
    }

    protected static List&lt;FlowNode&gt; gatherAllFlowNodes(FlowElementsContainer flowElementsContainer) {
<span class="nc" id="L1116">        List&lt;FlowNode&gt; flowNodes = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1117" title="All 2 branches missed.">        for (FlowElement flowElement : flowElementsContainer.getFlowElements()) {</span>
<span class="nc bnc" id="L1118" title="All 2 branches missed.">            if (flowElement instanceof FlowNode) {</span>
<span class="nc" id="L1119">                flowNodes.add((FlowNode) flowElement);</span>
            }
<span class="nc bnc" id="L1121" title="All 2 branches missed.">            if (flowElement instanceof FlowElementsContainer) {</span>
<span class="nc" id="L1122">                flowNodes.addAll(gatherAllFlowNodes((FlowElementsContainer) flowElement));</span>
            }
<span class="nc" id="L1124">        }</span>
<span class="nc" id="L1125">        return flowNodes;</span>
    }
    
    protected boolean isPartOfCollapsedSubProcess(FlowElement flowElement, BpmnModel model) {
<span class="nc" id="L1129">        SubProcess subProcess = flowElement.getSubProcess();</span>
<span class="nc bnc" id="L1130" title="All 2 branches missed.">        if (subProcess != null) {</span>
<span class="nc" id="L1131">            GraphicInfo graphicInfo = model.getGraphicInfo(subProcess.getId());</span>
<span class="nc bnc" id="L1132" title="All 6 branches missed.">            if (graphicInfo != null &amp;&amp; graphicInfo.getExpanded() != null &amp;&amp; !graphicInfo.getExpanded()) {</span>
<span class="nc" id="L1133">                return true;</span>
            }
            
<span class="nc" id="L1136">            return isPartOfCollapsedSubProcess(subProcess, model);</span>
        }
        
<span class="nc" id="L1139">        return false;</span>
    }

    public Map&lt;Class&lt;? extends BaseElement&gt;, ActivityDrawInstruction&gt; getActivityDrawInstructions() {
<span class="nc" id="L1143">        return activityDrawInstructions;</span>
    }

    public void setActivityDrawInstructions(
            Map&lt;Class&lt;? extends BaseElement&gt;, ActivityDrawInstruction&gt; activityDrawInstructions) {
<span class="nc" id="L1148">        this.activityDrawInstructions = activityDrawInstructions;</span>
<span class="nc" id="L1149">    }</span>

    public Map&lt;Class&lt;? extends BaseElement&gt;, ArtifactDrawInstruction&gt; getArtifactDrawInstructions() {
<span class="nc" id="L1152">        return artifactDrawInstructions;</span>
    }

    public void setArtifactDrawInstructions(
            Map&lt;Class&lt;? extends BaseElement&gt;, ArtifactDrawInstruction&gt; artifactDrawInstructions) {
<span class="nc" id="L1157">        this.artifactDrawInstructions = artifactDrawInstructions;</span>
<span class="nc" id="L1158">    }</span>

    protected interface ActivityDrawInstruction {
        void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, FlowNode flowNode);
    }

    protected interface ArtifactDrawInstruction {
        void draw(DefaultProcessDiagramCanvas processDiagramCanvas, BpmnModel bpmnModel, Artifact artifact);
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>