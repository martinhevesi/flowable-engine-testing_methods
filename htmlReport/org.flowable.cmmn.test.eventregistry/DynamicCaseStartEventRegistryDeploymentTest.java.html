<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DynamicCaseStartEventRegistryDeploymentTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.cmmn.test.eventregistry</a> &gt; <span class="el_source">DynamicCaseStartEventRegistryDeploymentTest.java</span></div><h1>DynamicCaseStartEventRegistryDeploymentTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.cmmn.test.eventregistry;

import static org.assertj.core.api.Assertions.assertThat;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.assertj.core.groups.Tuple;
import org.flowable.cmmn.api.repository.CaseDefinition;
import org.flowable.cmmn.api.runtime.CaseInstance;
import org.flowable.cmmn.engine.test.CmmnDeployment;
import org.flowable.common.engine.api.FlowableIllegalArgumentException;
import org.flowable.eventregistry.api.EventDeployment;
import org.flowable.eventregistry.api.EventRepositoryService;
import org.flowable.eventsubscription.api.EventSubscription;
import org.flowable.task.api.Task;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import org.junit.jupiter.api.Assertions;

/**
 * Various tests for event-registry based case starts, both static and dynamic and the handling of the event subscriptions.
 *
 * @author Micha Kiener
 */
<span class="nc" id="L40">public class DynamicCaseStartEventRegistryDeploymentTest extends FlowableEventRegistryCmmnTestCase {</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryStaticStartTestCase.cmmn&quot;
    })
    public void testStaticEventRegistryCaseStart() {
<span class="nc" id="L47">        sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>

<span class="nc" id="L49">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().list())</span>
<span class="nc" id="L50">                .extracting(CaseInstance::getCaseDefinitionKey)</span>
<span class="nc" id="L51">                .containsExactlyInAnyOrder(&quot;eventRegistryStaticStartTestCase&quot;);</span>

<span class="nc" id="L53">        Task task = cmmnTaskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L54">        assertThat(task).isNotNull();</span>

<span class="nc" id="L56">        cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L58">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>
<span class="nc" id="L59">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryDynamicStartTestCase.cmmn&quot;
    })
    public void testDynamicEventRegistryCaseStartWithoutManualSubscription() {
<span class="nc" id="L66">        sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>

        // there must be no running case instance as we didn't create a manual subscription yet
<span class="nc" id="L69">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>
<span class="nc" id="L70">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryStaticStartTestCase.cmmn&quot;
    })
    public void testDynamicEventRegistryCaseStartWithoutCaseDefinition() {
<span class="nc" id="L77">        FlowableIllegalArgumentException exception = Assertions.assertThrowsExactly(FlowableIllegalArgumentException.class, () -&gt; {</span>
            // manually register start subscription, but with different correlation than the actual event being sent
<span class="nc" id="L79">            cmmnRuntimeService.createCaseInstanceStartEventSubscriptionBuilder()</span>
<span class="nc" id="L80">                .addCorrelationParameterValue(&quot;customer&quot;, &quot;test&quot;)</span>
<span class="nc" id="L81">                .addCorrelationParameterValue(&quot;action&quot;, &quot;start&quot;)</span>
<span class="nc" id="L82">                .subscribe();</span>
<span class="nc" id="L83">        });</span>

<span class="nc" id="L85">        assertThat(exception.getMessage()).isEqualTo(&quot;The case definition must be provided using the key for the subscription to be registered.&quot;);</span>
<span class="nc" id="L86">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryStaticStartTestCase.cmmn&quot;
    })
    public void testDynamicEventRegistryCaseStartWithIllegalManualSubscriptionForWrongStartEvent() {
<span class="nc" id="L93">        FlowableIllegalArgumentException exception = Assertions.assertThrowsExactly(FlowableIllegalArgumentException.class, () -&gt; {</span>
            // manually register start subscription, but with different correlation than the actual event being sent
<span class="nc" id="L95">            cmmnRuntimeService.createCaseInstanceStartEventSubscriptionBuilder()</span>
<span class="nc" id="L96">                .caseDefinitionKey(&quot;eventRegistryStaticStartTestCase&quot;)</span>
<span class="nc" id="L97">                .addCorrelationParameterValue(&quot;customer&quot;, &quot;test&quot;)</span>
<span class="nc" id="L98">                .addCorrelationParameterValue(&quot;action&quot;, &quot;start&quot;)</span>
<span class="nc" id="L99">                .subscribe();</span>
<span class="nc" id="L100">        });</span>

<span class="nc" id="L102">        CaseDefinition caseDefinition = cmmnRepositoryService.createCaseDefinitionQuery().caseDefinitionKey(&quot;eventRegistryStaticStartTestCase&quot;).latestVersion().singleResult();</span>

<span class="nc" id="L104">        assertThat(exception.getMessage()).isEqualTo(&quot;The case definition with id '&quot; + caseDefinition.getId() + &quot;' does not have an event-registry based start event with a manual subscription behavior.&quot;);</span>
<span class="nc" id="L105">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryDynamicStartTestCase.cmmn&quot;
    })
    public void testDynamicEventRegistryCaseStartWithNonMatchingManualSubscription() {
        // manually register start subscription, but with different correlation than the actual event being sent
<span class="nc" id="L113">        cmmnRuntimeService.createCaseInstanceStartEventSubscriptionBuilder()</span>
<span class="nc" id="L114">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;)</span>
<span class="nc" id="L115">            .addCorrelationParameterValue(&quot;customer&quot;, &quot;test&quot;)</span>
<span class="nc" id="L116">            .addCorrelationParameterValue(&quot;action&quot;, &quot;start&quot;)</span>
<span class="nc" id="L117">            .subscribe();</span>

<span class="nc" id="L119">        sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>

        // there must be no running case instance as we didn't create a manual subscription yet
<span class="nc" id="L122">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>
<span class="nc" id="L123">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryDynamicStartTestCase.cmmn&quot;
    })
    public void testDynamicEventRegistryCaseStartWithIllegalManualSubscriptionForWrongCorrelation() {
<span class="nc" id="L130">        FlowableIllegalArgumentException exception = Assertions.assertThrowsExactly(FlowableIllegalArgumentException.class, () -&gt; {</span>
            // manually register start subscription, but with different correlation than the actual event being sent
<span class="nc" id="L132">            cmmnRuntimeService.createCaseInstanceStartEventSubscriptionBuilder()</span>
<span class="nc" id="L133">                .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;)</span>
<span class="nc" id="L134">                .addCorrelationParameterValue(&quot;invalidCorrelationParameter&quot;, &quot;test&quot;)</span>
<span class="nc" id="L135">                .addCorrelationParameterValue(&quot;action&quot;, &quot;start&quot;)</span>
<span class="nc" id="L136">                .subscribe();</span>
<span class="nc" id="L137">        });</span>

<span class="nc" id="L139">        assertThat(exception.getMessage()).isEqualTo(&quot;There is no correlation parameter with name 'invalidCorrelationParameter' defined in event model with key 'simpleTest'. You can only subscribe for an event with a combination of valid correlation parameters.&quot;);</span>
<span class="nc" id="L140">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryDynamicStartTestCase.cmmn&quot;
    })
    public void testDynamicEventRegistryCaseStartWithMatchingManualSubscription() {
        // manually register start subscription, matching the event correlation sent later
<span class="nc" id="L148">        EventSubscription eventSubscription = cmmnRuntimeService.createCaseInstanceStartEventSubscriptionBuilder()</span>
<span class="nc" id="L149">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;)</span>
<span class="nc" id="L150">            .addCorrelationParameterValue(&quot;customer&quot;, &quot;kermit&quot;)</span>
<span class="nc" id="L151">            .addCorrelationParameterValue(&quot;action&quot;, &quot;start&quot;)</span>
<span class="nc" id="L152">            .subscribe();</span>

<span class="nc" id="L154">        assertThat(eventSubscription).isNotNull().extracting(EventSubscription::getScopeDefinitionKey).isEqualTo(&quot;eventRegistryDynamicStartTestCase&quot;);</span>

<span class="nc" id="L156">        sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>

<span class="nc" id="L158">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().list())</span>
<span class="nc" id="L159">                .extracting(CaseInstance::getCaseDefinitionKey)</span>
<span class="nc" id="L160">                .containsExactlyInAnyOrder(&quot;eventRegistryDynamicStartTestCase&quot;);</span>

<span class="nc" id="L162">        Task task = cmmnTaskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L163">        assertThat(task).isNotNull();</span>

<span class="nc" id="L165">        cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L167">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>
<span class="nc" id="L168">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryDynamicStartTestCase.cmmn&quot;
    })
    public void testDynamicEventRegistryCaseStartWithMatchingManualSubscriptionVersion2() {
        // manually register start subscription, matching the event correlation sent later
<span class="nc" id="L176">        cmmnRuntimeService.createCaseInstanceStartEventSubscriptionBuilder()</span>
<span class="nc" id="L177">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;)</span>
<span class="nc" id="L178">            .addCorrelationParameterValues(Map.of(&quot;customer&quot;, &quot;kermit&quot;, &quot;action&quot;, &quot;start&quot;))</span>
<span class="nc" id="L179">            .subscribe();</span>

<span class="nc" id="L181">        sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>

<span class="nc" id="L183">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().list())</span>
<span class="nc" id="L184">                .extracting(CaseInstance::getCaseDefinitionKey)</span>
<span class="nc" id="L185">                .containsExactlyInAnyOrder(&quot;eventRegistryDynamicStartTestCase&quot;);</span>

<span class="nc" id="L187">        Task task = cmmnTaskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L188">        assertThat(task).isNotNull();</span>

<span class="nc" id="L190">        cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L192">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>
<span class="nc" id="L193">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryStaticStartTestCase.cmmn&quot;
    })
    public void testStaticEventRegistryCaseStartAfterRedeployment() {
<span class="nc" id="L200">        sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>

<span class="nc" id="L202">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().list())</span>
<span class="nc" id="L203">                .extracting(CaseInstance::getCaseDefinitionKey)</span>
<span class="nc" id="L204">                .containsExactlyInAnyOrder(&quot;eventRegistryStaticStartTestCase&quot;);</span>

<span class="nc" id="L206">        Task task = cmmnTaskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L207">        assertThat(task).isNotNull();</span>

<span class="nc" id="L209">        cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L211">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>

        // redeploy the case definition (which removes and re-adds the static start subscription)
<span class="nc" id="L214">        CaseDefinition caseDefinition = deployCaseDefinition(&quot;eventRegistryStaticStartTestCase.cmmn&quot;,</span>
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryStaticStartTestCase.cmmn&quot;);

        try {
<span class="nc" id="L218">            sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>

<span class="nc" id="L220">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list())</span>
<span class="nc" id="L221">                .extracting(CaseInstance::getCaseDefinitionId)</span>
<span class="nc" id="L222">                .containsExactlyInAnyOrder(caseDefinition.getId());</span>

<span class="nc" id="L224">            task = cmmnTaskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L225">            assertThat(task).isNotNull();</span>

<span class="nc" id="L227">            cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L229">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>
        } finally {
<span class="nc" id="L231">            deleteDeployment(caseDefinition.getDeploymentId());</span>
        }
<span class="nc" id="L233">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryDynamicStartTestCase.cmmn&quot;
    })
    public void testDynamicEventRegistryCaseStartAfterRedeployment() {
        // manually register start subscription, matching the event correlation sent later
<span class="nc" id="L241">        cmmnRuntimeService.createCaseInstanceStartEventSubscriptionBuilder()</span>
<span class="nc" id="L242">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;)</span>
<span class="nc" id="L243">            .addCorrelationParameterValue(&quot;customer&quot;, &quot;kermit&quot;)</span>
<span class="nc" id="L244">            .addCorrelationParameterValue(&quot;action&quot;, &quot;start&quot;)</span>
<span class="nc" id="L245">            .subscribe();</span>

<span class="nc" id="L247">        sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>

<span class="nc" id="L249">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().list())</span>
<span class="nc" id="L250">                .extracting(CaseInstance::getCaseDefinitionKey)</span>
<span class="nc" id="L251">                .containsExactlyInAnyOrder(&quot;eventRegistryDynamicStartTestCase&quot;);</span>

<span class="nc" id="L253">        Task task = cmmnTaskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L254">        assertThat(task).isNotNull();</span>

<span class="nc" id="L256">        cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L258">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>

        // the scope definition key must be present in the subscription
<span class="nc" id="L261">        assertThat(cmmnRuntimeService.createEventSubscriptionQuery().eventType(&quot;simpleTest&quot;).list())</span>
<span class="nc" id="L262">            .extracting(EventSubscription::getScopeDefinitionKey)</span>
<span class="nc" id="L263">            .containsExactlyInAnyOrder(&quot;eventRegistryDynamicStartTestCase&quot;);</span>

        // redeploy the case definition (which must not remove the subscriptions, but rather update them to the newest version)
<span class="nc" id="L266">        CaseDefinition caseDefinition = deployCaseDefinition(&quot;eventRegistryDynamicStartTestCase.cmmn&quot;,</span>
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryDynamicStartTestCase.cmmn&quot;);

        try {
<span class="nc" id="L270">            sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>

<span class="nc" id="L272">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list())</span>
<span class="nc" id="L273">                .extracting(CaseInstance::getCaseDefinitionKey, CaseInstance::getCaseDefinitionId)</span>
<span class="nc" id="L274">                .containsExactlyInAnyOrder(Tuple.tuple(&quot;eventRegistryDynamicStartTestCase&quot;, caseDefinition.getId()));</span>

<span class="nc" id="L276">            task = cmmnTaskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L277">            assertThat(task).isNotNull();</span>

<span class="nc" id="L279">            cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L281">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>
        } finally {
<span class="nc" id="L283">            deleteDeployment(caseDefinition.getDeploymentId());</span>
        }
<span class="nc" id="L285">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryDynamicStartTestCase.cmmn&quot;
    })
    public void testDynamicEventRegistryCaseStartAfterRedeploymentWithoutAutoUpdate() {
        // manually register start subscription, matching the event correlation sent later
<span class="nc" id="L293">        cmmnRuntimeService.createCaseInstanceStartEventSubscriptionBuilder()</span>
<span class="nc" id="L294">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;)</span>
<span class="nc" id="L295">            .addCorrelationParameterValue(&quot;customer&quot;, &quot;kermit&quot;)</span>
<span class="nc" id="L296">            .addCorrelationParameterValue(&quot;action&quot;, &quot;start&quot;)</span>
<span class="nc" id="L297">            .doNotUpdateToLatestVersionAutomatically()</span>
<span class="nc" id="L298">            .subscribe();</span>

<span class="nc" id="L300">        sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>

<span class="nc" id="L302">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().list())</span>
<span class="nc" id="L303">                .extracting(CaseInstance::getCaseDefinitionKey)</span>
<span class="nc" id="L304">                .containsExactlyInAnyOrder(&quot;eventRegistryDynamicStartTestCase&quot;);</span>

<span class="nc" id="L306">        Task task = cmmnTaskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L307">        assertThat(task).isNotNull();</span>

<span class="nc" id="L309">        cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L311">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>

        // the scope definition key must not be present in the event subscription
<span class="nc" id="L314">        assertThat(cmmnRuntimeService.createEventSubscriptionQuery().eventType(&quot;simpleTest&quot;).list())</span>
<span class="nc" id="L315">            .extracting(EventSubscription::getScopeDefinitionKey).containsOnlyNulls();</span>

        // search the first case definition as we don't have auto-update in the subscription
<span class="nc" id="L318">        CaseDefinition caseDefinition = cmmnRepositoryService.createCaseDefinitionQuery()</span>
<span class="nc" id="L319">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;).latestVersion().singleResult();</span>

        // redeploy the case definition (which must not remove the subscriptions, but rather update them to the newest version)
<span class="nc" id="L322">        CaseDefinition latestCaseDefinition = deployCaseDefinition(&quot;eventRegistryDynamicStartTestCase.cmmn&quot;,</span>
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryDynamicStartTestCase.cmmn&quot;);

        try {
<span class="nc" id="L326">            sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>

<span class="nc" id="L328">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list())</span>
<span class="nc" id="L329">                .extracting(CaseInstance::getCaseDefinitionKey, CaseInstance::getCaseDefinitionId)</span>
<span class="nc" id="L330">                .containsExactlyInAnyOrder(Tuple.tuple(&quot;eventRegistryDynamicStartTestCase&quot;, caseDefinition.getId()));</span>

<span class="nc" id="L332">            task = cmmnTaskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L333">            assertThat(task).isNotNull();</span>

<span class="nc" id="L335">            cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L337">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>
        } finally {
<span class="nc" id="L339">            deleteDeployment(latestCaseDefinition.getDeploymentId());</span>
        }
<span class="nc" id="L341">    }</span>

    @Test
    public void testSubscriptionDeletionAfterUndeploy() {
<span class="nc" id="L345">        CaseDefinition caseDefinition = deployCaseDefinition(&quot;eventRegistryDynamicStartTestCase.cmmn&quot;,</span>
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryDynamicStartTestCase.cmmn&quot;);

        try {
            // manually register start subscriptions
<span class="nc" id="L350">            cmmnRuntimeService.createCaseInstanceStartEventSubscriptionBuilder()</span>
<span class="nc" id="L351">                .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;)</span>
<span class="nc" id="L352">                .addCorrelationParameterValue(&quot;customer&quot;, &quot;kermit&quot;)</span>
<span class="nc" id="L353">                .addCorrelationParameterValue(&quot;action&quot;, &quot;start&quot;)</span>
<span class="nc" id="L354">                .subscribe();</span>

<span class="nc" id="L356">            Map&lt;String, Object&gt; correlationParameters = new HashMap&lt;&gt;();</span>
<span class="nc" id="L357">            correlationParameters.put(&quot;customer&quot;, &quot;kermit&quot;);</span>
<span class="nc" id="L358">            correlationParameters.put(&quot;action&quot;, &quot;start&quot;);</span>
<span class="nc" id="L359">            String correlationConfig1 = getEventRegistry().generateKey(correlationParameters);</span>

<span class="nc" id="L361">            cmmnRuntimeService.createCaseInstanceStartEventSubscriptionBuilder()</span>
<span class="nc" id="L362">                .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;)</span>
<span class="nc" id="L363">                .addCorrelationParameterValue(&quot;customer&quot;, &quot;frog&quot;)</span>
<span class="nc" id="L364">                .addCorrelationParameterValue(&quot;action&quot;, &quot;end&quot;)</span>
<span class="nc" id="L365">                .subscribe();</span>

<span class="nc" id="L367">            correlationParameters.put(&quot;customer&quot;, &quot;frog&quot;);</span>
<span class="nc" id="L368">            correlationParameters.put(&quot;action&quot;, &quot;end&quot;);</span>
<span class="nc" id="L369">            String correlationConfig2 = getEventRegistry().generateKey(correlationParameters);</span>

<span class="nc" id="L371">            assertThat(cmmnRuntimeService.createEventSubscriptionQuery().scopeDefinitionId(caseDefinition.getId()).list())</span>
<span class="nc" id="L372">                .extracting(EventSubscription::getScopeDefinitionId, EventSubscription::getConfiguration)</span>
<span class="nc" id="L373">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L374">                    Tuple.tuple(caseDefinition.getId(), correlationConfig1),</span>
<span class="nc" id="L375">                    Tuple.tuple(caseDefinition.getId(), correlationConfig2));</span>
        } finally {
<span class="nc" id="L377">            deleteDeployment(caseDefinition.getDeploymentId());</span>
        }

        // now the subscriptions also need to be deleted, after the case definition was undeployed
<span class="nc" id="L381">        assertThat(cmmnRuntimeService.createEventSubscriptionQuery().scopeDefinitionId(caseDefinition.getId()).list()).isEmpty();</span>
<span class="nc" id="L382">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryDynamicStartTestCase.cmmn&quot;
    })
    public void testDynamicEventRegistryCaseStartAfterSubscriptionMigration() {
        // manually register start subscription, matching the event correlation sent later
<span class="nc" id="L390">        cmmnRuntimeService.createCaseInstanceStartEventSubscriptionBuilder()</span>
<span class="nc" id="L391">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;)</span>
<span class="nc" id="L392">            .addCorrelationParameterValue(&quot;customer&quot;, &quot;kermit&quot;)</span>
<span class="nc" id="L393">            .addCorrelationParameterValue(&quot;action&quot;, &quot;start&quot;)</span>
<span class="nc" id="L394">            .doNotUpdateToLatestVersionAutomatically()</span>
<span class="nc" id="L395">            .subscribe();</span>

<span class="nc" id="L397">        cmmnRuntimeService.createCaseInstanceStartEventSubscriptionBuilder()</span>
<span class="nc" id="L398">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;)</span>
<span class="nc" id="L399">            .addCorrelationParameterValue(&quot;customer&quot;, &quot;frog&quot;)</span>
<span class="nc" id="L400">            .addCorrelationParameterValue(&quot;action&quot;, &quot;end&quot;)</span>
<span class="nc" id="L401">            .doNotUpdateToLatestVersionAutomatically()</span>
<span class="nc" id="L402">            .subscribe();</span>

        // search the first case definition as we don't have auto-update in the subscriptions
<span class="nc" id="L405">        CaseDefinition caseDefinition = cmmnRepositoryService.createCaseDefinitionQuery()</span>
<span class="nc" id="L406">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;).latestVersion().singleResult();</span>

<span class="nc" id="L408">        assertThat(cmmnRuntimeService.createEventSubscriptionQuery().eventType(&quot;simpleTest&quot;).list())</span>
<span class="nc" id="L409">            .extracting(EventSubscription::getScopeDefinitionId)</span>
<span class="nc" id="L410">            .containsExactlyInAnyOrder(caseDefinition.getId(), caseDefinition.getId());</span>

        // redeploy the case definition (which must not remove or update the existing subscriptions)
<span class="nc" id="L413">        CaseDefinition newCaseDefinition = deployCaseDefinition(&quot;eventRegistryDynamicStartTestCase.cmmn&quot;,</span>
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryDynamicStartTestCase.cmmn&quot;);

        try {
<span class="nc" id="L417">            sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>

<span class="nc" id="L419">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list())</span>
<span class="nc" id="L420">                .extracting(CaseInstance::getCaseDefinitionKey, CaseInstance::getCaseDefinitionId)</span>
<span class="nc" id="L421">                .containsExactlyInAnyOrder(Tuple.tuple(&quot;eventRegistryDynamicStartTestCase&quot;, caseDefinition.getId()));</span>

<span class="nc" id="L423">            Task task = cmmnTaskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L424">            assertThat(task).isNotNull();</span>

<span class="nc" id="L426">            cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L428">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>

            // now migrate to the latest case definition manually
<span class="nc" id="L431">            cmmnRuntimeService.createCaseInstanceStartEventSubscriptionModificationBuilder()</span>
<span class="nc" id="L432">                .caseDefinitionId(caseDefinition.getId())</span>
<span class="nc" id="L433">                .migrateToLatestCaseDefinition();</span>

<span class="nc" id="L435">            assertThat(cmmnRuntimeService.createEventSubscriptionQuery().eventType(&quot;simpleTest&quot;).list())</span>
<span class="nc" id="L436">                .extracting(EventSubscription::getScopeDefinitionId)</span>
<span class="nc" id="L437">                .containsExactlyInAnyOrder(newCaseDefinition.getId(), newCaseDefinition.getId());</span>

<span class="nc" id="L439">            sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>

<span class="nc" id="L441">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list())</span>
<span class="nc" id="L442">                .extracting(CaseInstance::getCaseDefinitionKey, CaseInstance::getCaseDefinitionId)</span>
<span class="nc" id="L443">                .containsExactlyInAnyOrder(Tuple.tuple(&quot;eventRegistryDynamicStartTestCase&quot;, newCaseDefinition.getId()));</span>

<span class="nc" id="L445">            task = cmmnTaskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L446">            assertThat(task).isNotNull();</span>

<span class="nc" id="L448">            cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L450">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>
        } finally {
<span class="nc" id="L452">            deleteDeployment(newCaseDefinition.getDeploymentId());</span>
        }
<span class="nc" id="L454">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryDynamicStartTestCase.cmmn&quot;
    })
    public void testDynamicEventRegistryCaseStartAfterSingleSubscriptionMigration() {
        // manually register start subscription, matching the event correlation sent later
<span class="nc" id="L462">        cmmnRuntimeService.createCaseInstanceStartEventSubscriptionBuilder()</span>
<span class="nc" id="L463">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;)</span>
<span class="nc" id="L464">            .addCorrelationParameterValue(&quot;customer&quot;, &quot;kermit&quot;)</span>
<span class="nc" id="L465">            .addCorrelationParameterValue(&quot;action&quot;, &quot;start&quot;)</span>
<span class="nc" id="L466">            .doNotUpdateToLatestVersionAutomatically()</span>
<span class="nc" id="L467">            .subscribe();</span>

<span class="nc" id="L469">        cmmnRuntimeService.createCaseInstanceStartEventSubscriptionBuilder()</span>
<span class="nc" id="L470">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;)</span>
<span class="nc" id="L471">            .addCorrelationParameterValue(&quot;customer&quot;, &quot;frog&quot;)</span>
<span class="nc" id="L472">            .addCorrelationParameterValue(&quot;action&quot;, &quot;end&quot;)</span>
<span class="nc" id="L473">            .doNotUpdateToLatestVersionAutomatically()</span>
<span class="nc" id="L474">            .subscribe();</span>


<span class="nc" id="L477">        Map&lt;String, Object&gt; correlationParameters = new HashMap&lt;&gt;();</span>
<span class="nc" id="L478">        correlationParameters.put(&quot;customer&quot;, &quot;kermit&quot;);</span>
<span class="nc" id="L479">        correlationParameters.put(&quot;action&quot;, &quot;start&quot;);</span>
<span class="nc" id="L480">        String correlationConfig1 = getEventRegistry().generateKey(correlationParameters);</span>

<span class="nc" id="L482">        correlationParameters.put(&quot;customer&quot;, &quot;frog&quot;);</span>
<span class="nc" id="L483">        correlationParameters.put(&quot;action&quot;, &quot;end&quot;);</span>
<span class="nc" id="L484">        String correlationConfig2 = getEventRegistry().generateKey(correlationParameters);</span>

        // search the first case definition as we don't have auto-update in the subscriptions
<span class="nc" id="L487">        CaseDefinition caseDefinition = cmmnRepositoryService.createCaseDefinitionQuery()</span>
<span class="nc" id="L488">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;).latestVersion().singleResult();</span>

<span class="nc" id="L490">        assertThat(cmmnRuntimeService.createEventSubscriptionQuery().eventType(&quot;simpleTest&quot;).list())</span>
<span class="nc" id="L491">            .extracting(EventSubscription::getScopeDefinitionId, EventSubscription::getConfiguration)</span>
<span class="nc" id="L492">            .containsExactlyInAnyOrder(</span>
<span class="nc" id="L493">                Tuple.tuple(caseDefinition.getId(), correlationConfig1),</span>
<span class="nc" id="L494">                Tuple.tuple(caseDefinition.getId(), correlationConfig2));</span>

        // redeploy the case definition (which must not remove or update the existing subscriptions)
<span class="nc" id="L497">        CaseDefinition newCaseDefinition = deployCaseDefinition(&quot;eventRegistryDynamicStartTestCase.cmmn&quot;,</span>
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryDynamicStartTestCase.cmmn&quot;);

        try {
<span class="nc" id="L501">            sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>

<span class="nc" id="L503">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list())</span>
<span class="nc" id="L504">                .extracting(CaseInstance::getCaseDefinitionKey, CaseInstance::getCaseDefinitionId)</span>
<span class="nc" id="L505">                .containsExactlyInAnyOrder(Tuple.tuple(&quot;eventRegistryDynamicStartTestCase&quot;, caseDefinition.getId()));</span>

<span class="nc" id="L507">            Task task = cmmnTaskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L508">            assertThat(task).isNotNull();</span>

<span class="nc" id="L510">            cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L512">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>

            // now migrate to the latest case definition manually
<span class="nc" id="L515">            cmmnRuntimeService.createCaseInstanceStartEventSubscriptionModificationBuilder()</span>
<span class="nc" id="L516">                .caseDefinitionId(caseDefinition.getId())</span>
<span class="nc" id="L517">                .addCorrelationParameterValues(Map.of(&quot;customer&quot;, &quot;kermit&quot;, &quot;action&quot;, &quot;start&quot;))</span>
<span class="nc" id="L518">                .migrateToLatestCaseDefinition();</span>

<span class="nc" id="L520">            assertThat(cmmnRuntimeService.createEventSubscriptionQuery().eventType(&quot;simpleTest&quot;).list())</span>
<span class="nc" id="L521">                .extracting(EventSubscription::getScopeDefinitionId, EventSubscription::getConfiguration)</span>
<span class="nc" id="L522">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L523">                    Tuple.tuple(caseDefinition.getId(), correlationConfig2),</span>
<span class="nc" id="L524">                    Tuple.tuple(newCaseDefinition.getId(), correlationConfig1));</span>

<span class="nc" id="L526">            sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>

<span class="nc" id="L528">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list())</span>
<span class="nc" id="L529">                .extracting(CaseInstance::getCaseDefinitionKey, CaseInstance::getCaseDefinitionId)</span>
<span class="nc" id="L530">                .containsExactlyInAnyOrder(Tuple.tuple(&quot;eventRegistryDynamicStartTestCase&quot;, newCaseDefinition.getId()));</span>

<span class="nc" id="L532">            task = cmmnTaskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L533">            assertThat(task).isNotNull();</span>

<span class="nc" id="L535">            cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L537">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>
        } finally {
<span class="nc" id="L539">            deleteDeployment(newCaseDefinition.getDeploymentId());</span>
        }
<span class="nc" id="L541">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryDynamicStartTestCase.cmmn&quot;
    })
    public void testDynamicEventRegistryCaseStartAfterSingleSubscriptionMigrationToSpecificVersion() {
        // manually register start subscription, matching the event correlation sent later
<span class="nc" id="L549">        cmmnRuntimeService.createCaseInstanceStartEventSubscriptionBuilder()</span>
<span class="nc" id="L550">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;)</span>
<span class="nc" id="L551">            .addCorrelationParameterValue(&quot;customer&quot;, &quot;kermit&quot;)</span>
<span class="nc" id="L552">            .addCorrelationParameterValue(&quot;action&quot;, &quot;start&quot;)</span>
<span class="nc" id="L553">            .doNotUpdateToLatestVersionAutomatically()</span>
<span class="nc" id="L554">            .subscribe();</span>

<span class="nc" id="L556">        cmmnRuntimeService.createCaseInstanceStartEventSubscriptionBuilder()</span>
<span class="nc" id="L557">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;)</span>
<span class="nc" id="L558">            .addCorrelationParameterValue(&quot;customer&quot;, &quot;frog&quot;)</span>
<span class="nc" id="L559">            .addCorrelationParameterValue(&quot;action&quot;, &quot;end&quot;)</span>
<span class="nc" id="L560">            .doNotUpdateToLatestVersionAutomatically()</span>
<span class="nc" id="L561">            .subscribe();</span>


<span class="nc" id="L564">        Map&lt;String, Object&gt; correlationParameters = new HashMap&lt;&gt;();</span>
<span class="nc" id="L565">        correlationParameters.put(&quot;customer&quot;, &quot;kermit&quot;);</span>
<span class="nc" id="L566">        correlationParameters.put(&quot;action&quot;, &quot;start&quot;);</span>
<span class="nc" id="L567">        String correlationConfig1 = getEventRegistry().generateKey(correlationParameters);</span>

<span class="nc" id="L569">        correlationParameters.put(&quot;customer&quot;, &quot;frog&quot;);</span>
<span class="nc" id="L570">        correlationParameters.put(&quot;action&quot;, &quot;end&quot;);</span>
<span class="nc" id="L571">        String correlationConfig2 = getEventRegistry().generateKey(correlationParameters);</span>

        // search the first case definition as we don't have auto-update in the subscriptions
<span class="nc" id="L574">        CaseDefinition caseDefinition = cmmnRepositoryService.createCaseDefinitionQuery()</span>
<span class="nc" id="L575">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;).latestVersion().singleResult();</span>

<span class="nc" id="L577">        assertThat(cmmnRuntimeService.createEventSubscriptionQuery().eventType(&quot;simpleTest&quot;).list())</span>
<span class="nc" id="L578">            .extracting(EventSubscription::getScopeDefinitionId, EventSubscription::getConfiguration)</span>
<span class="nc" id="L579">            .containsExactlyInAnyOrder(</span>
<span class="nc" id="L580">                Tuple.tuple(caseDefinition.getId(), correlationConfig1),</span>
<span class="nc" id="L581">                Tuple.tuple(caseDefinition.getId(), correlationConfig2));</span>

        // redeploy the case definition (which must not remove or update the existing subscriptions)
<span class="nc" id="L584">        CaseDefinition newCaseDefinition = deployCaseDefinition(&quot;eventRegistryDynamicStartTestCase.cmmn&quot;,</span>
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryDynamicStartTestCase.cmmn&quot;);

        try {
<span class="nc" id="L588">            sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>

<span class="nc" id="L590">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list())</span>
<span class="nc" id="L591">                .extracting(CaseInstance::getCaseDefinitionKey, CaseInstance::getCaseDefinitionId)</span>
<span class="nc" id="L592">                .containsExactlyInAnyOrder(Tuple.tuple(&quot;eventRegistryDynamicStartTestCase&quot;, caseDefinition.getId()));</span>

<span class="nc" id="L594">            Task task = cmmnTaskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L595">            assertThat(task).isNotNull();</span>

<span class="nc" id="L597">            cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L599">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>

            // now migrate to the latest case definition manually
<span class="nc" id="L602">            cmmnRuntimeService.createCaseInstanceStartEventSubscriptionModificationBuilder()</span>
<span class="nc" id="L603">                .caseDefinitionId(caseDefinition.getId())</span>
<span class="nc" id="L604">                .addCorrelationParameterValues(Map.of(&quot;customer&quot;, &quot;kermit&quot;, &quot;action&quot;, &quot;start&quot;))</span>
<span class="nc" id="L605">                .migrateToCaseDefinition(newCaseDefinition.getId());</span>

<span class="nc" id="L607">            assertThat(cmmnRuntimeService.createEventSubscriptionQuery().eventType(&quot;simpleTest&quot;).list())</span>
<span class="nc" id="L608">                .extracting(EventSubscription::getScopeDefinitionId, EventSubscription::getConfiguration)</span>
<span class="nc" id="L609">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L610">                    Tuple.tuple(caseDefinition.getId(), correlationConfig2),</span>
<span class="nc" id="L611">                    Tuple.tuple(newCaseDefinition.getId(), correlationConfig1));</span>

<span class="nc" id="L613">            sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>

<span class="nc" id="L615">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list())</span>
<span class="nc" id="L616">                .extracting(CaseInstance::getCaseDefinitionKey, CaseInstance::getCaseDefinitionId)</span>
<span class="nc" id="L617">                .containsExactlyInAnyOrder(Tuple.tuple(&quot;eventRegistryDynamicStartTestCase&quot;, newCaseDefinition.getId()));</span>

<span class="nc" id="L619">            task = cmmnTaskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L620">            assertThat(task).isNotNull();</span>

<span class="nc" id="L622">            cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L624">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>
        } finally {
<span class="nc" id="L626">            deleteDeployment(newCaseDefinition.getDeploymentId());</span>
        }
<span class="nc" id="L628">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryDynamicStartTestCase.cmmn&quot;
    })
    public void testDynamicEventRegistryCaseStartAfterSingleSubscriptionDeletion() {
        // manually register start subscription, matching the event correlation sent later
<span class="nc" id="L636">        cmmnRuntimeService.createCaseInstanceStartEventSubscriptionBuilder()</span>
<span class="nc" id="L637">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;)</span>
<span class="nc" id="L638">            .addCorrelationParameterValue(&quot;customer&quot;, &quot;kermit&quot;)</span>
<span class="nc" id="L639">            .addCorrelationParameterValue(&quot;action&quot;, &quot;start&quot;)</span>
<span class="nc" id="L640">            .doNotUpdateToLatestVersionAutomatically()</span>
<span class="nc" id="L641">            .subscribe();</span>

<span class="nc" id="L643">        cmmnRuntimeService.createCaseInstanceStartEventSubscriptionBuilder()</span>
<span class="nc" id="L644">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;)</span>
<span class="nc" id="L645">            .addCorrelationParameterValue(&quot;customer&quot;, &quot;frog&quot;)</span>
<span class="nc" id="L646">            .addCorrelationParameterValue(&quot;action&quot;, &quot;end&quot;)</span>
<span class="nc" id="L647">            .doNotUpdateToLatestVersionAutomatically()</span>
<span class="nc" id="L648">            .subscribe();</span>


<span class="nc" id="L651">        Map&lt;String, Object&gt; correlationParameters = new HashMap&lt;&gt;();</span>
<span class="nc" id="L652">        correlationParameters.put(&quot;customer&quot;, &quot;kermit&quot;);</span>
<span class="nc" id="L653">        correlationParameters.put(&quot;action&quot;, &quot;start&quot;);</span>
<span class="nc" id="L654">        String correlationConfig1 = getEventRegistry().generateKey(correlationParameters);</span>

<span class="nc" id="L656">        correlationParameters.put(&quot;customer&quot;, &quot;frog&quot;);</span>
<span class="nc" id="L657">        correlationParameters.put(&quot;action&quot;, &quot;end&quot;);</span>
<span class="nc" id="L658">        String correlationConfig2 = getEventRegistry().generateKey(correlationParameters);</span>

        // search the first case definition as we don't have auto-update in the subscriptions
<span class="nc" id="L661">        CaseDefinition caseDefinition =cmmnRepositoryService.createCaseDefinitionQuery()</span>
<span class="nc" id="L662">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;).latestVersion().singleResult();</span>

<span class="nc" id="L664">        assertThat(cmmnRuntimeService.createEventSubscriptionQuery().eventType(&quot;simpleTest&quot;).list())</span>
<span class="nc" id="L665">            .extracting(EventSubscription::getScopeDefinitionId, EventSubscription::getConfiguration)</span>
<span class="nc" id="L666">            .containsExactlyInAnyOrder(</span>
<span class="nc" id="L667">                Tuple.tuple(caseDefinition.getId(), correlationConfig1),</span>
<span class="nc" id="L668">                Tuple.tuple(caseDefinition.getId(), correlationConfig2));</span>

        // redeploy the case definition (which must not remove or update the existing subscriptions)
<span class="nc" id="L671">        CaseDefinition newCaseDefinition = deployCaseDefinition(&quot;eventRegistryDynamicStartTestCase.cmmn&quot;,</span>
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryDynamicStartTestCase.cmmn&quot;);

        try {
<span class="nc" id="L675">            sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>

<span class="nc" id="L677">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list())</span>
<span class="nc" id="L678">                .extracting(CaseInstance::getCaseDefinitionKey, CaseInstance::getCaseDefinitionId)</span>
<span class="nc" id="L679">                .containsExactlyInAnyOrder(Tuple.tuple(&quot;eventRegistryDynamicStartTestCase&quot;, caseDefinition.getId()));</span>

<span class="nc" id="L681">            Task task = cmmnTaskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L682">            assertThat(task).isNotNull();</span>

<span class="nc" id="L684">            cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L686">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>

            // now migrate to the latest case definition manually
<span class="nc" id="L689">            cmmnRuntimeService.createCaseInstanceStartEventSubscriptionDeletionBuilder()</span>
<span class="nc" id="L690">                .caseDefinitionId(caseDefinition.getId())</span>
<span class="nc" id="L691">                .addCorrelationParameterValues(Map.of(&quot;customer&quot;, &quot;kermit&quot;, &quot;action&quot;, &quot;start&quot;))</span>
<span class="nc" id="L692">                .deleteSubscriptions();</span>

<span class="nc" id="L694">            assertThat(cmmnRuntimeService.createEventSubscriptionQuery().eventType(&quot;simpleTest&quot;).list())</span>
<span class="nc" id="L695">                .extracting(EventSubscription::getScopeDefinitionId, EventSubscription::getConfiguration)</span>
<span class="nc" id="L696">                .containsExactlyInAnyOrder(Tuple.tuple(caseDefinition.getId(), correlationConfig2));</span>

<span class="nc" id="L698">            sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>
<span class="nc" id="L699">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>

<span class="nc" id="L701">            sendEvent(&quot;frog&quot;, &quot;end&quot;);</span>

<span class="nc" id="L703">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list())</span>
<span class="nc" id="L704">                .extracting(CaseInstance::getCaseDefinitionKey, CaseInstance::getCaseDefinitionId)</span>
<span class="nc" id="L705">                .containsExactlyInAnyOrder(Tuple.tuple(&quot;eventRegistryDynamicStartTestCase&quot;, caseDefinition.getId()));</span>

<span class="nc" id="L707">            task = cmmnTaskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L708">            assertThat(task).isNotNull();</span>

<span class="nc" id="L710">            cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L712">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>
        } finally {
<span class="nc" id="L714">            deleteDeployment(newCaseDefinition.getDeploymentId());</span>
        }
<span class="nc" id="L716">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryDynamicStartTestCase.cmmn&quot;
    })
    public void testDynamicEventRegistryCaseStartAfterAllSubscriptionDeletion() {
        // manually register start subscription, matching the event correlation sent later
<span class="nc" id="L724">        cmmnRuntimeService.createCaseInstanceStartEventSubscriptionBuilder()</span>
<span class="nc" id="L725">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;)</span>
<span class="nc" id="L726">            .addCorrelationParameterValue(&quot;customer&quot;, &quot;kermit&quot;)</span>
<span class="nc" id="L727">            .addCorrelationParameterValue(&quot;action&quot;, &quot;start&quot;)</span>
<span class="nc" id="L728">            .doNotUpdateToLatestVersionAutomatically()</span>
<span class="nc" id="L729">            .subscribe();</span>

<span class="nc" id="L731">        cmmnRuntimeService.createCaseInstanceStartEventSubscriptionBuilder()</span>
<span class="nc" id="L732">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;)</span>
<span class="nc" id="L733">            .addCorrelationParameterValue(&quot;customer&quot;, &quot;frog&quot;)</span>
<span class="nc" id="L734">            .addCorrelationParameterValue(&quot;action&quot;, &quot;end&quot;)</span>
<span class="nc" id="L735">            .doNotUpdateToLatestVersionAutomatically()</span>
<span class="nc" id="L736">            .subscribe();</span>


<span class="nc" id="L739">        Map&lt;String, Object&gt; correlationParameters = new HashMap&lt;&gt;();</span>
<span class="nc" id="L740">        correlationParameters.put(&quot;customer&quot;, &quot;kermit&quot;);</span>
<span class="nc" id="L741">        correlationParameters.put(&quot;action&quot;, &quot;start&quot;);</span>
<span class="nc" id="L742">        String correlationConfig1 = getEventRegistry().generateKey(correlationParameters);</span>

<span class="nc" id="L744">        correlationParameters.put(&quot;customer&quot;, &quot;frog&quot;);</span>
<span class="nc" id="L745">        correlationParameters.put(&quot;action&quot;, &quot;end&quot;);</span>
<span class="nc" id="L746">        String correlationConfig2 = getEventRegistry().generateKey(correlationParameters);</span>

        // search the first case definition as we don't have auto-update in the subscriptions
<span class="nc" id="L749">        CaseDefinition caseDefinition = cmmnRepositoryService.createCaseDefinitionQuery()</span>
<span class="nc" id="L750">            .caseDefinitionKey(&quot;eventRegistryDynamicStartTestCase&quot;).latestVersion().singleResult();</span>

<span class="nc" id="L752">        assertThat(cmmnRuntimeService.createEventSubscriptionQuery().eventType(&quot;simpleTest&quot;).list())</span>
<span class="nc" id="L753">            .extracting(EventSubscription::getScopeDefinitionId, EventSubscription::getConfiguration)</span>
<span class="nc" id="L754">            .containsExactlyInAnyOrder(</span>
<span class="nc" id="L755">                Tuple.tuple(caseDefinition.getId(), correlationConfig1),</span>
<span class="nc" id="L756">                Tuple.tuple(caseDefinition.getId(), correlationConfig2));</span>

        // redeploy the case definition (which must not remove or update the existing subscriptions)
<span class="nc" id="L759">        CaseDefinition newCaseDefinition = deployCaseDefinition(&quot;eventRegistryDynamicStartTestCase.cmmn&quot;,</span>
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.eventRegistryDynamicStartTestCase.cmmn&quot;);

        try {
<span class="nc" id="L763">            sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>

<span class="nc" id="L765">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list())</span>
<span class="nc" id="L766">                .extracting(CaseInstance::getCaseDefinitionKey, CaseInstance::getCaseDefinitionId)</span>
<span class="nc" id="L767">                .containsExactlyInAnyOrder(Tuple.tuple(&quot;eventRegistryDynamicStartTestCase&quot;, caseDefinition.getId()));</span>

<span class="nc" id="L769">            Task task = cmmnTaskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L770">            assertThat(task).isNotNull();</span>

<span class="nc" id="L772">            cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L774">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>

            // now migrate to the latest case definition manually
<span class="nc" id="L777">            cmmnRuntimeService.createCaseInstanceStartEventSubscriptionDeletionBuilder()</span>
<span class="nc" id="L778">                .caseDefinitionId(caseDefinition.getId())</span>
<span class="nc" id="L779">                .deleteSubscriptions();</span>

<span class="nc" id="L781">            assertThat(cmmnRuntimeService.createEventSubscriptionQuery().eventType(&quot;simpleTest&quot;).list()).isEmpty();</span>

<span class="nc" id="L783">            sendEvent(&quot;kermit&quot;, &quot;start&quot;);</span>
<span class="nc" id="L784">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>

<span class="nc" id="L786">            sendEvent(&quot;frog&quot;, &quot;end&quot;);</span>
<span class="nc" id="L787">            assertThat(cmmnRuntimeService.createCaseInstanceQuery().list()).isEmpty();</span>
        } finally {
<span class="nc" id="L789">            deleteDeployment(newCaseDefinition.getDeploymentId());</span>
        }
<span class="nc" id="L791">    }</span>

    protected CaseInstance sendEvent(String customerId, String action) {
<span class="nc" id="L794">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L795">            .caseDefinitionKey(&quot;sendTestEventCase&quot;)</span>
<span class="nc" id="L796">            .variable(&quot;customerId&quot;, customerId)</span>
<span class="nc" id="L797">            .variable(&quot;customerName&quot;, &quot;Kermit the Frog&quot;)</span>
<span class="nc" id="L798">            .variable(&quot;eventKey&quot;, &quot;simpleTest&quot;)</span>
<span class="nc" id="L799">            .variable(&quot;action&quot;, action)</span>
<span class="nc" id="L800">            .start();</span>

<span class="nc" id="L802">        return caseInstance;</span>
    }

    @Before
    public void deployEventDefinitionAndSendEventCaseDefinition() {
<span class="nc" id="L807">        EventRepositoryService eventRepositoryService = getEventRepositoryService();</span>
<span class="nc" id="L808">        eventRepositoryService.createDeployment()</span>
<span class="nc" id="L809">            .name(&quot;SimpleEvent&quot;)</span>
<span class="nc" id="L810">            .addClasspathResource(&quot;org/flowable/cmmn/test/eventregistry/SendInternalEventTaskTest.simple.event&quot;)</span>
<span class="nc" id="L811">            .deploy();</span>

<span class="nc" id="L813">        deployCaseDefinition(&quot;sendTestEventCase.cmmn&quot;,</span>
            &quot;org/flowable/cmmn/test/eventregistry/DynamicCaseStartEventRegistryDeploymentTest.sendTestEventCase.cmmn&quot;);
<span class="nc" id="L815">    }</span>

    @After
    public void deleteEventAndCaseDeployment() {
<span class="nc" id="L819">        EventRepositoryService eventRepositoryService = getEventRepositoryService();</span>
<span class="nc" id="L820">        List&lt;EventDeployment&gt; deployments = eventRepositoryService.createDeploymentQuery().list();</span>
<span class="nc bnc" id="L821" title="All 2 branches missed.">        for (EventDeployment eventDeployment : deployments) {</span>
<span class="nc" id="L822">            eventRepositoryService.deleteDeployment(eventDeployment.getId());</span>
<span class="nc" id="L823">        }</span>

<span class="nc" id="L825">        CaseDefinition caseDefinition = cmmnRepositoryService.createCaseDefinitionQuery().caseDefinitionKey(&quot;sendTestEventCase&quot;).singleResult();</span>
<span class="nc bnc" id="L826" title="All 2 branches missed.">        if (caseDefinition != null) {</span>
<span class="nc" id="L827">            deleteDeployment(caseDefinition.getDeploymentId());</span>
        }
<span class="nc" id="L829">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>