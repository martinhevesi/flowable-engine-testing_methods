<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractEngineConfigurator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.common.engine.impl</a> &gt; <span class="el_source">AbstractEngineConfigurator.java</span></div><h1>AbstractEngineConfigurator.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.common.engine.impl;

import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;

import org.apache.ibatis.type.TypeAliasRegistry;
import org.apache.ibatis.type.TypeHandlerRegistry;
import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.impl.db.MybatisTypeAliasConfigurator;
import org.flowable.common.engine.impl.db.MybatisTypeHandlerConfigurator;
import org.flowable.common.engine.impl.persistence.entity.Entity;
import org.w3c.dom.Document;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.xml.sax.SAXException;

/**
 * Convenience class for external engines (IDM/DMN/Form/...) to work together with the process engine
 * while also sharing as much internal resources as possible.
 *
 * @author Joram Barrez
 */
<span class="nc" id="L43">public abstract class AbstractEngineConfigurator implements EngineConfigurator {</span>

    protected boolean enableMybatisXmlMappingValidation;

    @Override
    public void beforeInit(AbstractEngineConfiguration engineConfiguration) {
<span class="nc" id="L49">        registerCustomDeployers(engineConfiguration);</span>
<span class="nc" id="L50">        registerCustomMybatisMappings(engineConfiguration);</span>

<span class="nc" id="L52">        List&lt;MybatisTypeAliasConfigurator&gt; typeAliasConfigs = getMybatisTypeAliases();</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">        if (typeAliasConfigs != null) {</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">            for (MybatisTypeAliasConfigurator customMybatisTypeAliasConfig : typeAliasConfigs) {</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">                if (engineConfiguration.getDependentEngineMybatisTypeAliasConfigs() == null) {</span>
<span class="nc" id="L56">                    engineConfiguration.setDependentEngineMybatisTypeAliasConfigs(new ArrayList&lt;&gt;());</span>
                }
<span class="nc" id="L58">                engineConfiguration.getDependentEngineMybatisTypeAliasConfigs().add(customMybatisTypeAliasConfig);</span>
<span class="nc" id="L59">            }</span>
        }

<span class="nc" id="L62">        List&lt;MybatisTypeHandlerConfigurator&gt; typeHandlerConfigs = getMybatisTypeHandlers();</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (typeHandlerConfigs != null) {</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">            for (MybatisTypeHandlerConfigurator typeHandler : typeHandlerConfigs) {</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">                if (engineConfiguration.getDependentEngineMybatisTypeHandlerConfigs() == null) {</span>
<span class="nc" id="L66">                    engineConfiguration.setDependentEngineMybatisTypeHandlerConfigs(new ArrayList&lt;&gt;());</span>
                }
<span class="nc" id="L68">                engineConfiguration.getDependentEngineMybatisTypeHandlerConfigs() .add(typeHandler);</span>
<span class="nc" id="L69">            }</span>
        }
<span class="nc" id="L71">    }</span>

    protected void registerCustomDeployers(AbstractEngineConfiguration engineConfiguration) {
<span class="nc" id="L74">        List&lt;EngineDeployer&gt; deployers = getCustomDeployers();</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (deployers != null) {</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">            if (engineConfiguration.getCustomPostDeployers() == null) {</span>
<span class="nc" id="L77">                engineConfiguration.setCustomPostDeployers(new ArrayList&lt;&gt;());</span>
            }
<span class="nc" id="L79">            engineConfiguration.getCustomPostDeployers().addAll(deployers);</span>
        }
<span class="nc" id="L81">    }</span>

    protected abstract List&lt;EngineDeployer&gt; getCustomDeployers();

    /**
     * @return The path to the Mybatis cfg file that is normally used for the engine (so the full cfg, not an individual mapper).
     *         Return null in case no custom mappers should be loaded.
     */
    protected abstract String getMybatisCfgPath();

    protected void registerCustomMybatisMappings(AbstractEngineConfiguration engineConfiguration) {
<span class="nc" id="L92">        String cfgPath = getMybatisCfgPath();</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (cfgPath != null) {</span>
<span class="nc" id="L94">            Set&lt;String&gt; resources = new HashSet&lt;&gt;();</span>

<span class="nc" id="L96">            ClassLoader classLoader = engineConfiguration.getClassLoader();</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">            if (classLoader == null) {</span>
<span class="nc" id="L98">                classLoader = this.getClass().getClassLoader();</span>
            }

<span class="nc" id="L101">            List&lt;MybatisTypeAliasConfigurator&gt; typeAliasConfigurators = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L102">            List&lt;MybatisTypeHandlerConfigurator&gt; typeHandlerConfigurators = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L103">            try (InputStream inputStream = classLoader.getResourceAsStream(cfgPath)) {</span>
<span class="nc" id="L104">                DocumentBuilderFactory docBuilderFactory = createDocumentBuilderFactory();</span>
<span class="nc" id="L105">                DocumentBuilder docBuilder = docBuilderFactory.newDocumentBuilder();</span>
<span class="nc" id="L106">                Document document = docBuilder.parse(inputStream);</span>
                
<span class="nc" id="L108">                NodeList typeAliasList = document.getElementsByTagName(&quot;typeAlias&quot;);</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">                for (int i = 0; i &lt; typeAliasList.getLength(); i++) {</span>
<span class="nc" id="L110">                    Node node = typeAliasList.item(i);</span>
<span class="nc" id="L111">                    MybatisTypeAliasConfigurator typeAlias = new MybatisTypeAliasConfigurator() {</span>
                        @Override
                        public void configure(TypeAliasRegistry typeAliasRegistry) {
                            try {
<span class="nc" id="L115">                                typeAliasRegistry.registerAlias(node.getAttributes().getNamedItem(&quot;alias&quot;).getTextContent(), </span>
<span class="nc" id="L116">                                                Class.forName(node.getAttributes().getNamedItem(&quot;type&quot;).getTextContent()));</span>
<span class="nc" id="L117">                            } catch (Exception e) {</span>
<span class="nc" id="L118">                                throw new FlowableException(&quot;Failed to load type alias class&quot;, e);</span>
<span class="nc" id="L119">                            }</span>
<span class="nc" id="L120">                        }</span>
                    };
<span class="nc" id="L122">                    typeAliasConfigurators.add(typeAlias);</span>
                    
                }
                
<span class="nc" id="L126">                NodeList typeHandlerList = document.getElementsByTagName(&quot;tagHandler&quot;);</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">                for (int i = 0; i &lt; typeHandlerList.getLength(); i++) {</span>
<span class="nc" id="L128">                    Node node = typeHandlerList.item(i);</span>
<span class="nc" id="L129">                    MybatisTypeHandlerConfigurator typeHandler = new MybatisTypeHandlerConfigurator() {</span>
                        @Override
                        public void configure(TypeHandlerRegistry typeHandlerRegistry) {
                            try {
<span class="nc" id="L133">                                typeHandlerRegistry.register(node.getAttributes().getNamedItem(&quot;javaType&quot;).getTextContent(),</span>
<span class="nc" id="L134">                                                node.getAttributes().getNamedItem(&quot;handler&quot;).getTextContent());</span>
<span class="nc" id="L135">                            } catch (Exception e) {</span>
<span class="nc" id="L136">                                throw new FlowableException(&quot;Failed to load type handler class&quot;, e);</span>
<span class="nc" id="L137">                            }</span>
<span class="nc" id="L138">                        }</span>
                    };
<span class="nc" id="L140">                    typeHandlerConfigurators.add(typeHandler);</span>
                }
                
<span class="nc" id="L143">                NodeList nodeList = document.getElementsByTagName(&quot;mapper&quot;);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                for (int i = 0; i &lt; nodeList.getLength(); i++) {</span>
<span class="nc" id="L145">                    Node node = nodeList.item(i);</span>
<span class="nc" id="L146">                    resources.add(node.getAttributes().getNamedItem(&quot;resource&quot;).getTextContent());</span>
                }
                
<span class="nc" id="L149">            } catch (IOException e) {</span>
<span class="nc" id="L150">                throw new FlowableException(&quot;Could not read IDM Mybatis configuration file&quot;, e);</span>
<span class="nc" id="L151">            } catch (ParserConfigurationException | SAXException e) {</span>
<span class="nc" id="L152">                throw new FlowableException(&quot;Could not parse Mybatis configuration file&quot;, e);</span>
<span class="nc" id="L153">            }</span>
            
<span class="nc bnc" id="L155" title="All 2 branches missed.">            if (typeAliasConfigurators.size() &gt; 0) {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">                if (engineConfiguration.getDependentEngineMybatisTypeAliasConfigs() == null) {</span>
<span class="nc" id="L157">                    engineConfiguration.setDependentEngineMybatisTypeAliasConfigs(typeAliasConfigurators);</span>
                    
                } else {
<span class="nc" id="L160">                    engineConfiguration.getDependentEngineMybatisTypeAliasConfigs().addAll(typeAliasConfigurators);</span>
                }
            }
            
<span class="nc bnc" id="L164" title="All 2 branches missed.">            if (typeHandlerConfigurators.size() &gt; 0) {</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">                if (engineConfiguration.getDependentEngineMybatisTypeHandlerConfigs() == null) {</span>
<span class="nc" id="L166">                    engineConfiguration.setDependentEngineMybatisTypeHandlerConfigs(typeHandlerConfigurators);</span>
                    
                } else {
<span class="nc" id="L169">                    engineConfiguration.getDependentEngineMybatisTypeHandlerConfigs().addAll(typeHandlerConfigurators);</span>
                }
            }

<span class="nc bnc" id="L173" title="All 2 branches missed.">            if (engineConfiguration.getCustomMybatisXMLMappers() == null) {</span>
<span class="nc" id="L174">                engineConfiguration.setCustomMybatisXMLMappers(resources);</span>
            } else {
<span class="nc" id="L176">                engineConfiguration.getCustomMybatisXMLMappers().addAll(resources);</span>
            }
        }
<span class="nc" id="L179">    }</span>

    protected DocumentBuilderFactory createDocumentBuilderFactory() throws ParserConfigurationException {
<span class="nc" id="L182">        DocumentBuilderFactory docBuilderFactory = DocumentBuilderFactory.newInstance();</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">        if (!enableMybatisXmlMappingValidation) {</span>
<span class="nc" id="L184">            docBuilderFactory.setValidating(false);</span>
<span class="nc" id="L185">            docBuilderFactory.setNamespaceAware(false);</span>
<span class="nc" id="L186">            docBuilderFactory.setExpandEntityReferences(false);</span>
<span class="nc" id="L187">            docBuilderFactory.setFeature(&quot;http://apache.org/xml/features/nonvalidating/load-external-dtd&quot;, false);</span>
<span class="nc" id="L188">            docBuilderFactory.setFeature(&quot;http://apache.org/xml/features/nonvalidating/load-dtd-grammar&quot;, false);</span>
        }
<span class="nc" id="L190">        return docBuilderFactory;</span>
    }

    /**
     * Override when custom type aliases are needed.
     */
    protected List&lt;MybatisTypeAliasConfigurator&gt; getMybatisTypeAliases() {
<span class="nc" id="L197">        return null;</span>
    }

    /**
     * Override when custom type handlers are needed.
     */
    protected List&lt;MybatisTypeHandlerConfigurator&gt; getMybatisTypeHandlers() {
<span class="nc" id="L204">        return null;</span>
    }

    protected void initialiseCommonProperties(AbstractEngineConfiguration engineConfiguration, AbstractEngineConfiguration targetEngineConfiguration) {
<span class="nc" id="L208">        initEngineConfigurations(engineConfiguration, targetEngineConfiguration);</span>
<span class="nc" id="L209">        initEventRegistryEventConsumers(engineConfiguration, targetEngineConfiguration);</span>
<span class="nc" id="L210">        initCommandContextFactory(engineConfiguration, targetEngineConfiguration);</span>
<span class="nc" id="L211">        initIdGenerator(engineConfiguration, targetEngineConfiguration);</span>

<span class="nc bnc" id="L213" title="All 2 branches missed.">        if (targetEngineConfiguration.isUsingRelationalDatabase()) {</span>
<span class="nc" id="L214">            initDataSource(engineConfiguration, targetEngineConfiguration);</span>
<span class="nc" id="L215">            initDbSqlSessionFactory(engineConfiguration, targetEngineConfiguration);</span>
<span class="nc" id="L216">            initDbProperties(engineConfiguration, targetEngineConfiguration);</span>
        }

<span class="nc" id="L219">        initSessionFactories(engineConfiguration, targetEngineConfiguration);</span>
<span class="nc" id="L220">        initEventDispatcher(engineConfiguration, targetEngineConfiguration);</span>
<span class="nc" id="L221">        initClock(engineConfiguration, targetEngineConfiguration);</span>
<span class="nc" id="L222">        initObjectMapper(engineConfiguration, targetEngineConfiguration);</span>
<span class="nc" id="L223">        initVariableTypes(engineConfiguration, targetEngineConfiguration);</span>
<span class="nc" id="L224">    }</span>

    protected void initEngineConfigurations(AbstractEngineConfiguration engineConfiguration, AbstractEngineConfiguration targetEngineConfiguration) {
<span class="nc" id="L227">        targetEngineConfiguration.setEngineConfigurations(engineConfiguration.getEngineConfigurations());</span>
<span class="nc" id="L228">    }</span>

    protected void initServiceConfigurations(AbstractEngineConfiguration engineConfiguration, AbstractEngineConfiguration targetEngineConfiguration) {
<span class="nc bnc" id="L231" title="All 2 branches missed.">        for (String serviceConfigurationKey : engineConfiguration.getServiceConfigurations().keySet()) {</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">            if (targetEngineConfiguration.getServiceConfigurations() == null</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                    || !targetEngineConfiguration.getServiceConfigurations().containsKey(serviceConfigurationKey)) {</span>
<span class="nc" id="L234">                targetEngineConfiguration.addServiceConfiguration(serviceConfigurationKey, engineConfiguration.getServiceConfigurations().get(serviceConfigurationKey));</span>
            }
<span class="nc" id="L236">        }</span>
<span class="nc" id="L237">    }</span>
    
    protected void initEventRegistryEventConsumers(AbstractEngineConfiguration engineConfiguration, AbstractEngineConfiguration targetEngineConfiguration) {
<span class="nc" id="L240">        targetEngineConfiguration.setEventRegistryEventConsumers(engineConfiguration.getEventRegistryEventConsumers());</span>
<span class="nc" id="L241">    }</span>

    protected void initCommandContextFactory(AbstractEngineConfiguration engineConfiguration, AbstractEngineConfiguration targetEngineConfiguration) {
<span class="nc" id="L244">        targetEngineConfiguration.setCommandContextFactory(engineConfiguration.getCommandContextFactory());</span>
<span class="nc" id="L245">    }</span>

    protected void initIdGenerator(AbstractEngineConfiguration engineConfiguration, AbstractEngineConfiguration targetEngineConfiguration) {
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (targetEngineConfiguration.getIdGenerator() == null) {</span>
<span class="nc" id="L249">            targetEngineConfiguration.setIdGenerator(engineConfiguration.getIdGenerator());</span>
        }
<span class="nc" id="L251">        targetEngineConfiguration.setUsePrefixId(engineConfiguration.isUsePrefixId());</span>
<span class="nc" id="L252">    }</span>

    protected void initDataSource(AbstractEngineConfiguration engineConfiguration, AbstractEngineConfiguration targetEngineConfiguration) {
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (engineConfiguration.getDataSource() != null) {</span>
<span class="nc" id="L256">            targetEngineConfiguration.setDataSource(engineConfiguration.getDataSource());</span>
        } else {
<span class="nc" id="L258">            throw new FlowableException(&quot;A datasource is required for initializing the engine &quot;);</span>
        }
<span class="nc" id="L260">    }</span>

    protected void initDbSqlSessionFactory(AbstractEngineConfiguration engineConfiguration, AbstractEngineConfiguration targetEngineConfiguration) {
<span class="nc" id="L263">        targetEngineConfiguration.setDbSqlSessionFactory(engineConfiguration.getDbSqlSessionFactory());</span>
<span class="nc" id="L264">        targetEngineConfiguration.setSqlSessionFactory(engineConfiguration.getSqlSessionFactory());</span>
<span class="nc" id="L265">        targetEngineConfiguration.defaultInitDbSqlSessionFactoryEntitySettings(getEntityInsertionOrder(), getEntityDeletionOrder());</span>
<span class="nc" id="L266">    }</span>

    protected void initSessionFactories(AbstractEngineConfiguration engineConfiguration, AbstractEngineConfiguration targetEngineConfiguration) {
<span class="nc" id="L269">        targetEngineConfiguration.setSessionFactories(engineConfiguration.getSessionFactories());</span>
<span class="nc" id="L270">    }</span>

    protected void initDbProperties(AbstractEngineConfiguration engineConfiguration, AbstractEngineConfiguration targetEngineConfiguration) {
<span class="nc" id="L273">        targetEngineConfiguration.setDatabaseType(engineConfiguration.getDatabaseType());</span>
<span class="nc" id="L274">        targetEngineConfiguration.setDatabaseCatalog(engineConfiguration.getDatabaseCatalog());</span>
<span class="nc" id="L275">        targetEngineConfiguration.setDatabaseSchema(engineConfiguration.getDatabaseSchema());</span>
<span class="nc" id="L276">        targetEngineConfiguration.setDatabaseSchemaUpdate(engineConfiguration.getDatabaseSchemaUpdate());</span>
<span class="nc" id="L277">        targetEngineConfiguration.setDatabaseTablePrefix(engineConfiguration.getDatabaseTablePrefix());</span>
<span class="nc" id="L278">        targetEngineConfiguration.setDatabaseWildcardEscapeCharacter(engineConfiguration.getDatabaseWildcardEscapeCharacter());</span>
<span class="nc" id="L279">        targetEngineConfiguration.setDefaultCommandConfig(engineConfiguration.getDefaultCommandConfig());</span>
<span class="nc" id="L280">        targetEngineConfiguration.setSchemaCommandConfig(engineConfiguration.getSchemaCommandConfig());</span>
<span class="nc" id="L281">        targetEngineConfiguration.setTransactionFactory(engineConfiguration.getTransactionFactory());</span>
<span class="nc" id="L282">        targetEngineConfiguration.setTransactionContextFactory(engineConfiguration.getTransactionContextFactory());</span>
<span class="nc" id="L283">        targetEngineConfiguration.setTransactionsExternallyManaged(engineConfiguration.isTransactionsExternallyManaged());</span>
<span class="nc" id="L284">    }</span>

    protected void initEventDispatcher(AbstractEngineConfiguration engineConfiguration, AbstractEngineConfiguration targetEngineConfiguration) {
<span class="nc bnc" id="L287" title="All 2 branches missed.">        if (engineConfiguration.getEventDispatcher() != null) {</span>
<span class="nc" id="L288">            targetEngineConfiguration.setEventDispatcher(engineConfiguration.getEventDispatcher());</span>
        }
<span class="nc" id="L290">    }</span>

    protected void initClock(AbstractEngineConfiguration engineConfiguration, AbstractEngineConfiguration targetEngineConfiguration) {
<span class="nc" id="L293">        targetEngineConfiguration.setClock(engineConfiguration.getClock());</span>
<span class="nc" id="L294">    }</span>

    protected void initObjectMapper(AbstractEngineConfiguration engineConfiguration, AbstractEngineConfiguration targetEngineConfiguration) {
<span class="nc bnc" id="L297" title="All 2 branches missed.">        if (targetEngineConfiguration.getObjectMapper() == null) {</span>
<span class="nc" id="L298">            targetEngineConfiguration.setObjectMapper(engineConfiguration.getObjectMapper());</span>
        }
<span class="nc" id="L300">    }</span>

    protected void initVariableTypes(AbstractEngineConfiguration engineConfiguration, AbstractEngineConfiguration targetEngineConfiguration) {
<span class="nc bnc" id="L303" title="All 4 branches missed.">        if (engineConfiguration instanceof HasVariableTypes &amp;&amp; targetEngineConfiguration instanceof HasVariableTypes) {</span>
<span class="nc" id="L304">            ((HasVariableTypes) targetEngineConfiguration).setVariableTypes(((HasVariableTypes) engineConfiguration).getVariableTypes());</span>
        }
<span class="nc" id="L306">    }</span>

    protected abstract List&lt;Class&lt;? extends Entity&gt;&gt; getEntityInsertionOrder();

    protected abstract List&lt;Class&lt;? extends Entity&gt;&gt; getEntityDeletionOrder();

    public boolean isEnableMybatisXmlMappingValidation() {
<span class="nc" id="L313">        return enableMybatisXmlMappingValidation;</span>
    }

    public void setEnableMybatisXmlMappingValidation(boolean enableMybatisXmlMappingValidation) {
<span class="nc" id="L317">        this.enableMybatisXmlMappingValidation = enableMybatisXmlMappingValidation;</span>
<span class="nc" id="L318">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>