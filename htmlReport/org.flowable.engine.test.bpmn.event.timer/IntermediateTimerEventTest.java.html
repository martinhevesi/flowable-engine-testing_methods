<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IntermediateTimerEventTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.bpmn.event.timer</a> &gt; <span class="el_source">IntermediateTimerEventTest.java</span></div><h1>IntermediateTimerEventTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.engine.test.bpmn.event.timer;

import static org.assertj.core.api.Assertions.assertThat;

import java.text.SimpleDateFormat;
import java.time.Instant;
import java.util.Calendar;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.flowable.engine.impl.test.JobTestHelper;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.job.api.Job;
import org.flowable.job.api.TimerJobQuery;
import org.flowable.task.api.Task;
import org.junit.jupiter.api.Test;

<span class="nc" id="L35">public class IntermediateTimerEventTest extends PluggableFlowableTestCase {</span>
<span class="nc" id="L36">    private SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd'T'HH:mm:ss&quot;);</span>

    @Test
    @Deployment
    public void testCatchingTimerEvent() throws Exception {
        // Set the clock fixed
<span class="nc" id="L42">        Date startTime = new Date();</span>

        // After process start, there should be timer created
<span class="nc" id="L45">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;intermediateTimerEventExample&quot;);</span>
<span class="nc" id="L46">        TimerJobQuery jobQuery = managementService.createTimerJobQuery().processInstanceId(pi.getId());</span>
<span class="nc" id="L47">        assertThat(jobQuery.count()).isEqualTo(1);</span>
        
<span class="nc" id="L49">        Job job = managementService.createTimerJobQuery().elementId(&quot;timer&quot;).singleResult();</span>
<span class="nc" id="L50">        assertThat(job.getElementId()).isEqualTo(&quot;timer&quot;);</span>
<span class="nc" id="L51">        assertThat(job.getElementName()).isEqualTo(&quot;Timer catch&quot;);</span>

        // After setting the clock to time '50minutes and 5 seconds', the second timer should fire
<span class="nc" id="L54">        processEngineConfiguration.getClock().setCurrentTime(new Date(startTime.getTime() + ((50 * 60 * 1000) + 5000)));</span>
<span class="nc" id="L55">        waitForJobExecutorToProcessAllJobsAndExecutableTimerJobs(7000L, 25L);</span>

<span class="nc" id="L57">        assertThat(jobQuery.count()).isZero();</span>
<span class="nc" id="L58">        assertProcessEnded(pi.getProcessInstanceId());</span>

<span class="nc" id="L60">    }</span>

    @Test
    @Deployment
    public void testTimerEventWithStartAndDuration() throws Exception {

<span class="nc" id="L66">        Calendar testStartCal = new GregorianCalendar(2016, 0, 1, 10, 0, 0);</span>
<span class="nc" id="L67">        Date testStartTime = testStartCal.getTime();</span>
<span class="nc" id="L68">        processEngineConfiguration.getClock().setCurrentTime(testStartTime);</span>

<span class="nc" id="L70">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;timerEventWithStartAndDuration&quot;);</span>
<span class="nc" id="L71">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L72">        assertThat(tasks)</span>
<span class="nc" id="L73">                .extracting(Task::getName)</span>
<span class="nc" id="L74">                .containsExactly(&quot;Task A&quot;);</span>

<span class="nc" id="L76">        TimerJobQuery jobQuery = managementService.createTimerJobQuery().processInstanceId(pi.getId());</span>
<span class="nc" id="L77">        assertThat(jobQuery.count()).isZero();</span>

<span class="nc" id="L79">        Date startDate = new Date();</span>
<span class="nc" id="L80">        runtimeService.setVariable(pi.getId(), &quot;StartDate&quot;, startDate);</span>
<span class="nc" id="L81">        taskService.complete(tasks.get(0).getId());</span>

<span class="nc" id="L83">        jobQuery = managementService.createTimerJobQuery().processInstanceId(pi.getId());</span>
<span class="nc" id="L84">        assertThat(jobQuery.count()).isEqualTo(1);</span>

<span class="nc" id="L86">        processEngineConfiguration.getClock().setCurrentTime(new Date(startDate.getTime() + 7000L));</span>

<span class="nc" id="L88">        jobQuery = managementService.createTimerJobQuery().processInstanceId(pi.getId());</span>
<span class="nc" id="L89">        assertThat(jobQuery.count()).isEqualTo(1);</span>
<span class="nc" id="L90">        jobQuery = managementService.createTimerJobQuery().processInstanceId(pi.getId()).executable();</span>
<span class="nc" id="L91">        assertThat(jobQuery.count()).isZero();</span>

<span class="nc" id="L93">        processEngineConfiguration.getClock().setCurrentTime(new Date(startDate.getTime() + 11000L));</span>
<span class="nc" id="L94">        waitForJobExecutorToProcessAllJobsAndExecutableTimerJobs(15000L, 25L);</span>

<span class="nc" id="L96">        jobQuery = managementService.createTimerJobQuery().processInstanceId(pi.getId());</span>
<span class="nc" id="L97">        assertThat(jobQuery.count()).isZero();</span>

<span class="nc" id="L99">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L100">        assertThat(tasks)</span>
<span class="nc" id="L101">                .extracting(Task::getName)</span>
<span class="nc" id="L102">                .containsExactly(&quot;Task B&quot;);</span>
<span class="nc" id="L103">        taskService.complete(tasks.get(0).getId());</span>

<span class="nc" id="L105">        assertProcessEnded(pi.getProcessInstanceId());</span>

<span class="nc" id="L107">        processEngineConfiguration.getClock().reset();</span>
<span class="nc" id="L108">    }</span>

    @Test
    @Deployment
    public void testExpression() {
        // Set the clock fixed
<span class="nc" id="L114">        HashMap&lt;String, Object&gt; variables1 = new HashMap&lt;&gt;();</span>
<span class="nc" id="L115">        variables1.put(&quot;dueDate&quot;, new Date());</span>

<span class="nc" id="L117">        HashMap&lt;String, Object&gt; variables2 = new HashMap&lt;&gt;();</span>
<span class="nc" id="L118">        variables2.put(&quot;dueDate&quot;, new SimpleDateFormat(&quot;yyyy-MM-dd'T'HH:mm:ss&quot;).format(new Date()));</span>

<span class="nc" id="L120">        HashMap&lt;String, Object&gt; variables3 = new HashMap&lt;&gt;();</span>
<span class="nc" id="L121">        variables3.put(&quot;dueDate&quot;, Instant.now());</span>

        // After process start, there should be timer created
<span class="nc" id="L124">        ProcessInstance pi1 = runtimeService.startProcessInstanceByKey(&quot;intermediateTimerEventExample&quot;, variables1);</span>
<span class="nc" id="L125">        ProcessInstance pi2 = runtimeService.startProcessInstanceByKey(&quot;intermediateTimerEventExample&quot;, variables2);</span>
<span class="nc" id="L126">        ProcessInstance pi3 = runtimeService.startProcessInstanceByKey(&quot;intermediateTimerEventExample&quot;, variables3);</span>

<span class="nc" id="L128">        assertThat(managementService.createTimerJobQuery().processInstanceId(pi1.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L129">        assertThat(managementService.createTimerJobQuery().processInstanceId(pi2.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L130">        assertThat(managementService.createTimerJobQuery().processInstanceId(pi3.getId()).count()).isEqualTo(1);</span>

        // After setting the clock to one second in the future the timers should fire
<span class="nc" id="L133">        List&lt;Job&gt; jobs = managementService.createTimerJobQuery().executable().list();</span>
<span class="nc" id="L134">        assertThat(jobs).hasSize(3);</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">        for (Job job : jobs) {</span>
<span class="nc" id="L136">            managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L137">            managementService.executeJob(job.getId());</span>
<span class="nc" id="L138">        }</span>

<span class="nc" id="L140">        assertThat(managementService.createTimerJobQuery().processInstanceId(pi1.getId()).count()).isZero();</span>
<span class="nc" id="L141">        assertThat(managementService.createTimerJobQuery().processInstanceId(pi2.getId()).count()).isZero();</span>
<span class="nc" id="L142">        assertThat(managementService.createTimerJobQuery().processInstanceId(pi3.getId()).count()).isZero();</span>

<span class="nc" id="L144">        assertProcessEnded(pi1.getProcessInstanceId());</span>
<span class="nc" id="L145">        assertProcessEnded(pi2.getProcessInstanceId());</span>
<span class="nc" id="L146">        assertProcessEnded(pi3.getProcessInstanceId());</span>
<span class="nc" id="L147">    }</span>

    @Test
    @Deployment
    public void testLoop() {
<span class="nc" id="L152">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;testLoop&quot;);</span>

        // After looping 3 times, the process should end
<span class="nc bnc" id="L155" title="All 2 branches missed.">        for (int i = 0; i &lt; 3; i++) {</span>
<span class="nc" id="L156">            Job timer = managementService.createTimerJobQuery().singleResult();</span>
<span class="nc" id="L157">            managementService.moveTimerToExecutableJob(timer.getId());</span>
<span class="nc" id="L158">            managementService.executeJob(timer.getId());</span>
        }

<span class="nc" id="L161">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L162">    }</span>

    @Test
    @Deployment
    public void testLoopWithCycle() {
<span class="nc" id="L167">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;testLoop&quot;);</span>

        // After looping 3 times, the process should end. Cycle should NOT repeat itself
<span class="nc bnc" id="L170" title="All 2 branches missed.">        for (int i = 0; i &lt; 3; i++) {</span>
<span class="nc" id="L171">            Job timer = managementService.createTimerJobQuery().singleResult();</span>
<span class="nc" id="L172">            managementService.moveTimerToExecutableJob(timer.getId());</span>
<span class="nc" id="L173">            managementService.executeJob(timer.getId());</span>
        }

<span class="nc" id="L176">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L177">    }</span>

    @Test
    @Deployment
    public void testRescheduleTimer() {
        // startDate variable set to one hour from now
<span class="nc" id="L183">        Calendar calendar = Calendar.getInstance();</span>
<span class="nc" id="L184">        calendar.add(Calendar.HOUR, 1);</span>
<span class="nc" id="L185">        long startTimeInMillis = calendar.getTime().getTime();</span>

<span class="nc" id="L187">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L188">        variables.put(&quot;startDate&quot;, calendar.getTime());</span>
<span class="nc" id="L189">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;rescheduleTimer&quot;, variables);</span>

<span class="nc" id="L191">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L192">        assertThat(tasks).isEmpty();</span>
<span class="nc" id="L193">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L194">        assertThat(timerJob).isNotNull();</span>
<span class="nc" id="L195">        long diffInMilliseconds = Math.abs(startTimeInMillis - timerJob.getDuedate().getTime());</span>
<span class="nc" id="L196">        assertThat(diffInMilliseconds).isLessThan(100);</span>

        // reschedule timer for two hours from now
<span class="nc" id="L199">        calendar = Calendar.getInstance();</span>
<span class="nc" id="L200">        calendar.add(Calendar.HOUR, 2);</span>
<span class="nc" id="L201">        Job rescheduledJob = managementService.rescheduleTimeDateJob(timerJob.getId(), sdf.format(calendar.getTime()));</span>
<span class="nc" id="L202">        assertThat(rescheduledJob).isNotNull();</span>
<span class="nc" id="L203">        assertThat(rescheduledJob.getId()).isNotSameAs(timerJob.getId());</span>

<span class="nc" id="L205">        Job timer = managementService.createTimerJobQuery().singleResult();</span>
<span class="nc" id="L206">        assertThat(timer.getId()).isEqualTo(rescheduledJob.getId());</span>

<span class="nc" id="L208">        timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L209">        diffInMilliseconds = Math.abs(startTimeInMillis - timerJob.getDuedate().getTime());</span>
<span class="nc" id="L210">        assertThat(diffInMilliseconds).isGreaterThan(59 * 60 * 1000);</span>

        // Move clock forward 1 hour from now
<span class="nc" id="L213">        calendar = Calendar.getInstance();</span>
<span class="nc" id="L214">        calendar.add(Calendar.HOUR, 1);</span>
<span class="nc" id="L215">        calendar.add(Calendar.MINUTE, 5);</span>
<span class="nc" id="L216">        processEngineConfiguration.getClock().setCurrentTime(calendar.getTime());</span>
<span class="nc" id="L217">        JobTestHelper.executeJobExecutorForTime(processEngineConfiguration, 1000, 100);</span>

        // Confirm timer has not run
<span class="nc" id="L220">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L221">        assertThat(tasks).isEmpty();</span>
<span class="nc" id="L222">        timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L223">        assertThat(timerJob).isNotNull();</span>

        // Move clock forward 2 hours from now
<span class="nc" id="L226">        calendar = Calendar.getInstance();</span>
<span class="nc" id="L227">        calendar.add(Calendar.HOUR, 2);</span>
<span class="nc" id="L228">        processEngineConfiguration.getClock().setCurrentTime(calendar.getTime());</span>
<span class="nc" id="L229">        waitForJobExecutorToProcessAllJobsAndExecutableTimerJobs(2000, 100);</span>

        // Confirm timer has run
<span class="nc" id="L232">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L233">        assertThat(tasks).hasSize(1);</span>
<span class="nc" id="L234">        timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L235">        assertThat(timerJob).isNull();</span>
<span class="nc" id="L236">    }</span>

    @Test
    @Deployment
    public void testParallelTimerEvents() throws Exception {
        // Set the clock fixed
<span class="nc" id="L242">        Date startTime = new Date();</span>

        // After process start, there should be timer created
<span class="nc" id="L245">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;parallelIntermediateTimers&quot;);</span>
<span class="nc" id="L246">        TimerJobQuery jobQuery = managementService.createTimerJobQuery().processInstanceId(pi.getId());</span>
<span class="nc" id="L247">        assertThat(jobQuery.count()).isEqualTo(2);</span>

        // After setting the clock to time '50minutes and 5 seconds', the both timers should fire in parallel
<span class="nc" id="L250">        processEngineConfiguration.getClock().setCurrentTime(new Date(startTime.getTime() + ((50 * 60 * 1000) + 5000)));</span>
        try {
<span class="nc" id="L252">            JobTestHelper.waitForJobExecutorToProcessAllJobsAndExecutableTimerJobs(</span>
                    this.processEngineConfiguration, this.managementService, 20000L, 250L
            );

<span class="nc" id="L256">            assertThat(jobQuery.count()).isZero();</span>
<span class="nc" id="L257">            assertProcessEnded(pi.getProcessInstanceId());</span>
<span class="nc" id="L258">            assertThat(IntermediateTimerEventTestCounter.getCount())</span>
<span class="nc" id="L259">                    .as(&quot;Timer paths must be executed 2 times (or more, with tx retries).isTrue() without failure repetition&quot;)</span>
<span class="nc" id="L260">                    .isGreaterThanOrEqualTo(2);</span>
        } finally {
<span class="nc" id="L262">            processEngineConfiguration.getClock().reset();</span>
        }
<span class="nc" id="L264">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>