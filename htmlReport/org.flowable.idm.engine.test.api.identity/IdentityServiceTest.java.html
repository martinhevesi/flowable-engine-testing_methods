<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IdentityServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.idm.engine.test.api.identity</a> &gt; <span class="el_source">IdentityServiceTest.java</span></div><h1>IdentityServiceTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.idm.engine.test.api.identity;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

import java.util.Date;
import java.util.List;

import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.api.FlowableIllegalArgumentException;
import org.flowable.common.engine.api.FlowableOptimisticLockingException;
import org.flowable.idm.api.Group;
import org.flowable.idm.api.Picture;
import org.flowable.idm.api.Token;
import org.flowable.idm.api.User;
import org.flowable.idm.engine.impl.authentication.ApacheDigester;
import org.flowable.idm.engine.test.PluggableFlowableIdmTestCase;
import org.junit.jupiter.api.Test;

/**
 * @author Frederik Heremans
 */
<span class="nc" id="L36">public class IdentityServiceTest extends PluggableFlowableIdmTestCase {</span>

    @Test
    public void testUserInfo() {
<span class="nc" id="L40">        User user = idmIdentityService.newUser(&quot;testuser&quot;);</span>
<span class="nc" id="L41">        idmIdentityService.saveUser(user);</span>

<span class="nc" id="L43">        idmIdentityService.setUserInfo(&quot;testuser&quot;, &quot;myinfo&quot;, &quot;myvalue&quot;);</span>
<span class="nc" id="L44">        assertThat(idmIdentityService.getUserInfo(&quot;testuser&quot;, &quot;myinfo&quot;)).isEqualTo(&quot;myvalue&quot;);</span>

<span class="nc" id="L46">        idmIdentityService.setUserInfo(&quot;testuser&quot;, &quot;myinfo&quot;, &quot;myvalue2&quot;);</span>
<span class="nc" id="L47">        assertThat(idmIdentityService.getUserInfo(&quot;testuser&quot;, &quot;myinfo&quot;)).isEqualTo(&quot;myvalue2&quot;);</span>

<span class="nc" id="L49">        idmIdentityService.deleteUserInfo(&quot;testuser&quot;, &quot;myinfo&quot;);</span>
<span class="nc" id="L50">        assertThat(idmIdentityService.getUserInfo(&quot;testuser&quot;, &quot;myinfo&quot;)).isNull();</span>

<span class="nc" id="L52">        idmIdentityService.deleteUser(user.getId());</span>
<span class="nc" id="L53">    }</span>

    @Test
    public void testCreateExistingUser() {
<span class="nc" id="L57">        User user = idmIdentityService.newUser(&quot;testuser&quot;);</span>
<span class="nc" id="L58">        idmIdentityService.saveUser(user);</span>

        // Expected exception while saving new user with the same name as an existing one.
<span class="nc" id="L61">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L62">            User secondUser = idmIdentityService.newUser(&quot;testuser&quot;);</span>
<span class="nc" id="L63">            idmIdentityService.saveUser(secondUser);</span>
<span class="nc" id="L64">        })</span>
<span class="nc" id="L65">                .isInstanceOf(RuntimeException.class);</span>

<span class="nc" id="L67">        idmIdentityService.deleteUser(user.getId());</span>
<span class="nc" id="L68">    }</span>

    @Test
    public void testUpdateUser() {
        // First, create a new user
<span class="nc" id="L73">        User user = idmIdentityService.newUser(&quot;johndoe&quot;);</span>
<span class="nc" id="L74">        user.setFirstName(&quot;John&quot;);</span>
<span class="nc" id="L75">        user.setLastName(&quot;Doe&quot;);</span>
<span class="nc" id="L76">        user.setEmail(&quot;johndoe@alfresco.com&quot;);</span>
<span class="nc" id="L77">        idmIdentityService.saveUser(user);</span>

        // Fetch and update the user
<span class="nc" id="L80">        user = idmIdentityService.createUserQuery().userId(&quot;johndoe&quot;).singleResult();</span>
<span class="nc" id="L81">        user.setEmail(&quot;updated@alfresco.com&quot;);</span>
<span class="nc" id="L82">        user.setFirstName(&quot;Jane&quot;);</span>
<span class="nc" id="L83">        user.setLastName(&quot;Donnel&quot;);</span>
<span class="nc" id="L84">        idmIdentityService.saveUser(user);</span>

<span class="nc" id="L86">        user = idmIdentityService.createUserQuery().userId(&quot;johndoe&quot;).singleResult();</span>
<span class="nc" id="L87">        assertThat(user.getFirstName()).isEqualTo(&quot;Jane&quot;);</span>
<span class="nc" id="L88">        assertThat(user.getLastName()).isEqualTo(&quot;Donnel&quot;);</span>
<span class="nc" id="L89">        assertThat(user.getEmail()).isEqualTo(&quot;updated@alfresco.com&quot;);</span>

<span class="nc" id="L91">        idmIdentityService.deleteUser(user.getId());</span>
<span class="nc" id="L92">    }</span>

    @Test
    public void testUpdateUserDeltaOnly() {
        // First, create a new user
<span class="nc" id="L97">        User user = idmIdentityService.newUser(&quot;testuser&quot;);</span>
<span class="nc" id="L98">        user.setFirstName(&quot;John&quot;);</span>
<span class="nc" id="L99">        user.setLastName(&quot;Doe&quot;);</span>
<span class="nc" id="L100">        user.setDisplayName(&quot;John Doe&quot;);</span>
<span class="nc" id="L101">        user.setEmail(&quot;testuser@flowable.com&quot;);</span>
<span class="nc" id="L102">        user.setPassword(&quot;test&quot;);</span>
<span class="nc" id="L103">        idmIdentityService.saveUser(user);</span>
<span class="nc" id="L104">        String initialPassword = user.getPassword();</span>

        // Fetch and update the user
<span class="nc" id="L107">        user = idmIdentityService.createUserQuery().userId(&quot;testuser&quot;).singleResult();</span>
<span class="nc" id="L108">        assertThat(user)</span>
<span class="nc" id="L109">                .returns(&quot;John&quot;, User::getFirstName)</span>
<span class="nc" id="L110">                .returns(&quot;Doe&quot;, User::getLastName)</span>
<span class="nc" id="L111">                .returns(&quot;John Doe&quot;, User::getDisplayName)</span>
<span class="nc" id="L112">                .returns(&quot;testuser@flowable.com&quot;, User::getEmail)</span>
<span class="nc" id="L113">                .returns(initialPassword, User::getPassword);</span>

<span class="nc" id="L115">        user.setFirstName(&quot;Jane&quot;);</span>
<span class="nc" id="L116">        idmIdentityService.saveUser(user);</span>

<span class="nc" id="L118">        user = idmIdentityService.createUserQuery().userId(&quot;testuser&quot;).singleResult();</span>
<span class="nc" id="L119">        assertThat(user)</span>
<span class="nc" id="L120">                .returns(&quot;Jane&quot;, User::getFirstName)</span>
<span class="nc" id="L121">                .returns(&quot;Doe&quot;, User::getLastName)</span>
<span class="nc" id="L122">                .returns(&quot;John Doe&quot;, User::getDisplayName)</span>
<span class="nc" id="L123">                .returns(&quot;testuser@flowable.com&quot;, User::getEmail)</span>
<span class="nc" id="L124">                .returns(initialPassword, User::getPassword);</span>

<span class="nc" id="L126">        user.setLastName(&quot;Doelle&quot;);</span>
<span class="nc" id="L127">        idmIdentityService.saveUser(user);</span>

<span class="nc" id="L129">        user = idmIdentityService.createUserQuery().userId(&quot;testuser&quot;).singleResult();</span>
<span class="nc" id="L130">        assertThat(user)</span>
<span class="nc" id="L131">                .returns(&quot;Jane&quot;, User::getFirstName)</span>
<span class="nc" id="L132">                .returns(&quot;Doelle&quot;, User::getLastName)</span>
<span class="nc" id="L133">                .returns(&quot;John Doe&quot;, User::getDisplayName)</span>
<span class="nc" id="L134">                .returns(&quot;testuser@flowable.com&quot;, User::getEmail)</span>
<span class="nc" id="L135">                .returns(initialPassword, User::getPassword);</span>

<span class="nc" id="L137">        user.setDisplayName(&quot;Jane Doelle&quot;);</span>
<span class="nc" id="L138">        idmIdentityService.saveUser(user);</span>

<span class="nc" id="L140">        user = idmIdentityService.createUserQuery().userId(&quot;testuser&quot;).singleResult();</span>
<span class="nc" id="L141">        assertThat(user)</span>
<span class="nc" id="L142">                .returns(&quot;Jane&quot;, User::getFirstName)</span>
<span class="nc" id="L143">                .returns(&quot;Doelle&quot;, User::getLastName)</span>
<span class="nc" id="L144">                .returns(&quot;Jane Doelle&quot;, User::getDisplayName)</span>
<span class="nc" id="L145">                .returns(&quot;testuser@flowable.com&quot;, User::getEmail)</span>
<span class="nc" id="L146">                .returns(initialPassword, User::getPassword);</span>

<span class="nc" id="L148">        user.setEmail(&quot;janedoelle@flowable.com&quot;);</span>
<span class="nc" id="L149">        idmIdentityService.saveUser(user);</span>

<span class="nc" id="L151">        user = idmIdentityService.createUserQuery().userId(&quot;testuser&quot;).singleResult();</span>
<span class="nc" id="L152">        assertThat(user)</span>
<span class="nc" id="L153">                .returns(&quot;Jane&quot;, User::getFirstName)</span>
<span class="nc" id="L154">                .returns(&quot;Doelle&quot;, User::getLastName)</span>
<span class="nc" id="L155">                .returns(&quot;Jane Doelle&quot;, User::getDisplayName)</span>
<span class="nc" id="L156">                .returns(&quot;janedoelle@flowable.com&quot;, User::getEmail)</span>
<span class="nc" id="L157">                .returns(initialPassword, User::getPassword);</span>

<span class="nc" id="L159">        user.setPassword(&quot;test-pass&quot;);</span>
<span class="nc" id="L160">        idmIdentityService.saveUser(user);</span>

<span class="nc" id="L162">        user = idmIdentityService.createUserQuery().userId(&quot;testuser&quot;).singleResult();</span>
<span class="nc" id="L163">        assertThat(user)</span>
<span class="nc" id="L164">                .returns(&quot;Jane&quot;, User::getFirstName)</span>
<span class="nc" id="L165">                .returns(&quot;Doelle&quot;, User::getLastName)</span>
<span class="nc" id="L166">                .returns(&quot;Jane Doelle&quot;, User::getDisplayName)</span>
<span class="nc" id="L167">                .returns(&quot;janedoelle@flowable.com&quot;, User::getEmail)</span>
<span class="nc" id="L168">                .returns(initialPassword, User::getPassword);</span>

<span class="nc" id="L170">        idmIdentityService.deleteUser(user.getId());</span>
<span class="nc" id="L171">    }</span>

    @Test
    public void testUserPicture() {
        // First, create a new user
<span class="nc" id="L176">        User user = idmIdentityService.newUser(&quot;johndoe&quot;);</span>
<span class="nc" id="L177">        idmIdentityService.saveUser(user);</span>
<span class="nc" id="L178">        String userId = user.getId();</span>

<span class="nc" id="L180">        Picture picture = new Picture(&quot;niceface&quot;.getBytes(), &quot;image/string&quot;);</span>
<span class="nc" id="L181">        idmIdentityService.setUserPicture(userId, picture);</span>

<span class="nc" id="L183">        picture = idmIdentityService.getUserPicture(userId);</span>

        // Fetch and update the user
<span class="nc" id="L186">        user = idmIdentityService.createUserQuery().userId(&quot;johndoe&quot;).singleResult();</span>
<span class="nc" id="L187">        assertThat(picture.getBytes()).as(&quot;byte arrays differ&quot;).isEqualTo(&quot;niceface&quot;.getBytes());</span>
<span class="nc" id="L188">        assertThat(picture.getMimeType()).isEqualTo(&quot;image/string&quot;);</span>

        // interface definition states that setting picture to null should delete it
<span class="nc" id="L191">        idmIdentityService.setUserPicture(userId, null);</span>
<span class="nc" id="L192">        assertThat(idmIdentityService.getUserPicture(userId)).as(&quot;it should be possible to nullify user picture&quot;).isNull();</span>
<span class="nc" id="L193">        user = idmIdentityService.createUserQuery().userId(&quot;johndoe&quot;).singleResult();</span>
<span class="nc" id="L194">        assertThat(idmIdentityService.getUserPicture(userId)).as(&quot;it should be possible to delete user picture&quot;).isNull();</span>

<span class="nc" id="L196">        idmIdentityService.deleteUser(user.getId());</span>
<span class="nc" id="L197">    }</span>

    @Test
    public void testUpdateGroup() {
<span class="nc" id="L201">        Group group = idmIdentityService.newGroup(&quot;sales&quot;);</span>
<span class="nc" id="L202">        group.setName(&quot;Sales&quot;);</span>
<span class="nc" id="L203">        idmIdentityService.saveGroup(group);</span>

<span class="nc" id="L205">        group = idmIdentityService.createGroupQuery().groupId(&quot;sales&quot;).singleResult();</span>
<span class="nc" id="L206">        group.setName(&quot;Updated&quot;);</span>
<span class="nc" id="L207">        idmIdentityService.saveGroup(group);</span>

<span class="nc" id="L209">        group = idmIdentityService.createGroupQuery().groupId(&quot;sales&quot;).singleResult();</span>
<span class="nc" id="L210">        assertThat(group.getName()).isEqualTo(&quot;Updated&quot;);</span>

<span class="nc" id="L212">        idmIdentityService.deleteGroup(group.getId());</span>
<span class="nc" id="L213">    }</span>

    @Test
    public void findUserByUnexistingId() {
<span class="nc" id="L217">        User user = idmIdentityService.createUserQuery().userId(&quot;unexistinguser&quot;).singleResult();</span>
<span class="nc" id="L218">        assertThat(user).isNull();</span>
<span class="nc" id="L219">    }</span>

    @Test
    public void findGroupByUnexistingId() {
<span class="nc" id="L223">        Group group = idmIdentityService.createGroupQuery().groupId(&quot;unexistinggroup&quot;).singleResult();</span>
<span class="nc" id="L224">        assertThat(group).isNull();</span>
<span class="nc" id="L225">    }</span>

    @Test
    public void testCreateMembershipUnexistingGroup() {
<span class="nc" id="L229">        User johndoe = idmIdentityService.newUser(&quot;johndoe&quot;);</span>
<span class="nc" id="L230">        idmIdentityService.saveUser(johndoe);</span>

<span class="nc" id="L232">        assertThatThrownBy(() -&gt; idmIdentityService.createMembership(johndoe.getId(), &quot;unexistinggroup&quot;))</span>
<span class="nc" id="L233">                .isInstanceOf(RuntimeException.class);</span>

<span class="nc" id="L235">        idmIdentityService.deleteUser(johndoe.getId());</span>
<span class="nc" id="L236">    }</span>

    @Test
    public void testCreateMembershipUnexistingUser() {
<span class="nc" id="L240">        Group sales = idmIdentityService.newGroup(&quot;sales&quot;);</span>
<span class="nc" id="L241">        idmIdentityService.saveGroup(sales);</span>

<span class="nc" id="L243">        assertThatThrownBy(() -&gt; idmIdentityService.createMembership(&quot;unexistinguser&quot;, sales.getId()))</span>
<span class="nc" id="L244">                .isInstanceOf(RuntimeException.class);</span>

<span class="nc" id="L246">        idmIdentityService.deleteGroup(sales.getId());</span>
<span class="nc" id="L247">    }</span>

    @Test
    public void testCreateMembershipAlreadyExisting() {
<span class="nc" id="L251">        Group sales = idmIdentityService.newGroup(&quot;sales&quot;);</span>
<span class="nc" id="L252">        idmIdentityService.saveGroup(sales);</span>
<span class="nc" id="L253">        User johndoe = idmIdentityService.newUser(&quot;johndoe&quot;);</span>
<span class="nc" id="L254">        idmIdentityService.saveUser(johndoe);</span>

        // Create the membership
<span class="nc" id="L257">        idmIdentityService.createMembership(johndoe.getId(), sales.getId());</span>

<span class="nc" id="L259">        assertThatThrownBy(() -&gt; idmIdentityService.createMembership(johndoe.getId(), sales.getId()))</span>
<span class="nc" id="L260">                .isInstanceOf(RuntimeException.class);</span>

<span class="nc" id="L262">        idmIdentityService.deleteGroup(sales.getId());</span>
<span class="nc" id="L263">        idmIdentityService.deleteUser(johndoe.getId());</span>
<span class="nc" id="L264">    }</span>

    @Test
    public void testSaveGroupNullArgument() {
<span class="nc" id="L268">        assertThatThrownBy(() -&gt; idmIdentityService.saveGroup(null))</span>
<span class="nc" id="L269">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L270">                .hasMessageContaining(&quot;group is null&quot;);</span>
<span class="nc" id="L271">    }</span>

    @Test
    public void testSaveUserNullArgument() {
<span class="nc" id="L275">        assertThatThrownBy(() -&gt; idmIdentityService.saveUser(null))</span>
<span class="nc" id="L276">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L277">                .hasMessageContaining(&quot;user is null&quot;);</span>
<span class="nc" id="L278">    }</span>

    @Test
    public void testFindGroupByIdNullArgument() {
<span class="nc" id="L282">        assertThatThrownBy(() -&gt; idmIdentityService.createGroupQuery().groupId(null).singleResult())</span>
<span class="nc" id="L283">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L284">                .hasMessageContaining(&quot;id is null&quot;);</span>
<span class="nc" id="L285">    }</span>

    @Test
    public void testCreateMembershipNullArguments() {
<span class="nc" id="L289">        assertThatThrownBy(() -&gt; idmIdentityService.createMembership(null, &quot;group&quot;))</span>
<span class="nc" id="L290">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L291">                .hasMessageContaining(&quot;userId is null&quot;);</span>

<span class="nc" id="L293">        assertThatThrownBy(() -&gt; idmIdentityService.createMembership(&quot;userId&quot;, null))</span>
<span class="nc" id="L294">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L295">                .hasMessageContaining(&quot;groupId is null&quot;);</span>
<span class="nc" id="L296">    }</span>

    @Test
    public void testFindGroupsByUserIdNullArguments() {
<span class="nc" id="L300">        assertThatThrownBy(() -&gt; idmIdentityService.createGroupQuery().groupMember(null).singleResult())</span>
<span class="nc" id="L301">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L302">                .hasMessageContaining(&quot;userId is null&quot;);</span>
<span class="nc" id="L303">    }</span>

    @Test
    public void testFindUsersByGroupUnexistingGroup() {
<span class="nc" id="L307">        List&lt;User&gt; users = idmIdentityService.createUserQuery().memberOfGroup(&quot;unexistinggroup&quot;).list();</span>
<span class="nc" id="L308">        assertThat(users).isEmpty();</span>
<span class="nc" id="L309">    }</span>

    @Test
    public void testDeleteGroupNullArguments() {
<span class="nc" id="L313">        assertThatThrownBy(() -&gt; idmIdentityService.deleteGroup(null))</span>
<span class="nc" id="L314">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L315">                .hasMessageContaining(&quot;groupId is null&quot;);</span>
<span class="nc" id="L316">    }</span>

    @Test
    public void testDeleteMembership() {
<span class="nc" id="L320">        Group sales = idmIdentityService.newGroup(&quot;sales&quot;);</span>
<span class="nc" id="L321">        idmIdentityService.saveGroup(sales);</span>

<span class="nc" id="L323">        User johndoe = idmIdentityService.newUser(&quot;johndoe&quot;);</span>
<span class="nc" id="L324">        idmIdentityService.saveUser(johndoe);</span>
        // Add membership
<span class="nc" id="L326">        idmIdentityService.createMembership(johndoe.getId(), sales.getId());</span>

<span class="nc" id="L328">        List&lt;Group&gt; groups = idmIdentityService.createGroupQuery().groupMember(johndoe.getId()).list();</span>
<span class="nc" id="L329">        assertThat(groups)</span>
<span class="nc" id="L330">                .extracting(Group::getId)</span>
<span class="nc" id="L331">                .containsExactly(&quot;sales&quot;);</span>

        // Delete the membership and check members of sales group
<span class="nc" id="L334">        idmIdentityService.deleteMembership(johndoe.getId(), sales.getId());</span>
<span class="nc" id="L335">        groups = idmIdentityService.createGroupQuery().groupMember(johndoe.getId()).list();</span>
<span class="nc" id="L336">        assertThat(groups).isEmpty();</span>

<span class="nc" id="L338">        idmIdentityService.deleteGroup(&quot;sales&quot;);</span>
<span class="nc" id="L339">        idmIdentityService.deleteUser(&quot;johndoe&quot;);</span>
<span class="nc" id="L340">    }</span>

    @Test
    public void testDeleteMembershipWhenUserIsNoMember() {
<span class="nc" id="L344">        Group sales = idmIdentityService.newGroup(&quot;sales&quot;);</span>
<span class="nc" id="L345">        idmIdentityService.saveGroup(sales);</span>

<span class="nc" id="L347">        User johndoe = idmIdentityService.newUser(&quot;johndoe&quot;);</span>
<span class="nc" id="L348">        idmIdentityService.saveUser(johndoe);</span>

        // Delete the membership when the user is no member
<span class="nc" id="L351">        idmIdentityService.deleteMembership(johndoe.getId(), sales.getId());</span>

<span class="nc" id="L353">        idmIdentityService.deleteGroup(&quot;sales&quot;);</span>
<span class="nc" id="L354">        idmIdentityService.deleteUser(&quot;johndoe&quot;);</span>
<span class="nc" id="L355">    }</span>

    @Test
    public void testDeleteMembershipUnexistingGroup() {
<span class="nc" id="L359">        User johndoe = idmIdentityService.newUser(&quot;johndoe&quot;);</span>
<span class="nc" id="L360">        idmIdentityService.saveUser(johndoe);</span>
        // No exception should be thrown when group doesn't exist
<span class="nc" id="L362">        idmIdentityService.deleteMembership(johndoe.getId(), &quot;unexistinggroup&quot;);</span>
<span class="nc" id="L363">        idmIdentityService.deleteUser(johndoe.getId());</span>
<span class="nc" id="L364">    }</span>

    @Test
    public void testDeleteMembershipUnexistingUser() {
<span class="nc" id="L368">        Group sales = idmIdentityService.newGroup(&quot;sales&quot;);</span>
<span class="nc" id="L369">        idmIdentityService.saveGroup(sales);</span>
        // No exception should be thrown when user doesn't exist
<span class="nc" id="L371">        idmIdentityService.deleteMembership(&quot;unexistinguser&quot;, sales.getId());</span>
<span class="nc" id="L372">        idmIdentityService.deleteGroup(sales.getId());</span>
<span class="nc" id="L373">    }</span>

    @Test
    public void testDeleteMemberschipNullArguments() {
<span class="nc" id="L377">        assertThatThrownBy(() -&gt; idmIdentityService.deleteMembership(null, &quot;group&quot;))</span>
<span class="nc" id="L378">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L379">                .hasMessageContaining(&quot;userId is null&quot;);</span>

<span class="nc" id="L381">        assertThatThrownBy(() -&gt; idmIdentityService.deleteMembership(&quot;user&quot;, null))</span>
<span class="nc" id="L382">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L383">                .hasMessageContaining(&quot;groupId is null&quot;);</span>
<span class="nc" id="L384">    }</span>

    @Test
    public void testDeleteUserNullArguments() {
<span class="nc" id="L388">        assertThatThrownBy(() -&gt; idmIdentityService.deleteUser(null))</span>
<span class="nc" id="L389">                .isInstanceOf(FlowableException.class)</span>
<span class="nc" id="L390">                .hasMessageContaining(&quot;userId is null&quot;);</span>
<span class="nc" id="L391">    }</span>

    @Test
    public void testDeleteUserUnexistingUserId() {
        // No exception should be thrown. Deleting an unexisting user should
        // be ignored silently
<span class="nc" id="L397">        idmIdentityService.deleteUser(&quot;unexistinguser&quot;);</span>
<span class="nc" id="L398">    }</span>

    @Test
    public void testCheckPasswordNullSafe() {
<span class="nc" id="L402">        assertThat(idmIdentityService.checkPassword(&quot;userId&quot;, null)).isFalse();</span>
<span class="nc" id="L403">        assertThat(idmIdentityService.checkPassword(null, &quot;passwd&quot;)).isFalse();</span>
<span class="nc" id="L404">        assertThat(idmIdentityService.checkPassword(null, null)).isFalse();</span>
<span class="nc" id="L405">    }</span>

    @Test
    public void testChangePassword() {

<span class="nc" id="L410">        idmEngineConfiguration.setPasswordEncoder(new ApacheDigester(ApacheDigester.Digester.MD5));</span>

<span class="nc" id="L412">        User user = idmIdentityService.newUser(&quot;johndoe&quot;);</span>
<span class="nc" id="L413">        user.setPassword(&quot;xxx&quot;);</span>
<span class="nc" id="L414">        idmIdentityService.saveUser(user);</span>

<span class="nc" id="L416">        user = idmIdentityService.createUserQuery().userId(&quot;johndoe&quot;).list().get(0);</span>
<span class="nc" id="L417">        user.setFirstName(&quot;John Doe&quot;);</span>
<span class="nc" id="L418">        idmIdentityService.saveUser(user);</span>
<span class="nc" id="L419">        User johndoe = idmIdentityService.createUserQuery().userId(&quot;johndoe&quot;).list().get(0);</span>
<span class="nc" id="L420">        assertThat(johndoe.getPassword()).isNotEqualTo(&quot;xxx&quot;);</span>
<span class="nc" id="L421">        assertThat(johndoe.getFirstName()).isEqualTo(&quot;John Doe&quot;);</span>
<span class="nc" id="L422">        assertThat(idmIdentityService.checkPassword(&quot;johndoe&quot;, &quot;xxx&quot;)).isTrue();</span>

<span class="nc" id="L424">        user = idmIdentityService.createUserQuery().userId(&quot;johndoe&quot;).list().get(0);</span>
<span class="nc" id="L425">        user.setPassword(&quot;yyy&quot;);</span>
<span class="nc" id="L426">        idmIdentityService.saveUser(user);</span>
<span class="nc" id="L427">        assertThat(idmIdentityService.checkPassword(&quot;johndoe&quot;, &quot;xxx&quot;)).isTrue();</span>

<span class="nc" id="L429">        user = idmIdentityService.createUserQuery().userId(&quot;johndoe&quot;).list().get(0);</span>
<span class="nc" id="L430">        user.setPassword(&quot;yyy&quot;);</span>
<span class="nc" id="L431">        idmIdentityService.updateUserPassword(user);</span>
<span class="nc" id="L432">        assertThat(idmIdentityService.checkPassword(&quot;johndoe&quot;, &quot;yyy&quot;)).isTrue();</span>

<span class="nc" id="L434">        idmIdentityService.deleteUser(&quot;johndoe&quot;);</span>
<span class="nc" id="L435">    }</span>

    @Test
    public void testUserOptimisticLockingException() {
<span class="nc" id="L439">        User user = idmIdentityService.newUser(&quot;kermit&quot;);</span>
<span class="nc" id="L440">        idmIdentityService.saveUser(user);</span>

<span class="nc" id="L442">        User user1 = idmIdentityService.createUserQuery().singleResult();</span>
<span class="nc" id="L443">        User user2 = idmIdentityService.createUserQuery().singleResult();</span>

<span class="nc" id="L445">        user1.setFirstName(&quot;name one&quot;);</span>
<span class="nc" id="L446">        idmIdentityService.saveUser(user1);</span>

<span class="nc" id="L448">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L449">            user2.setFirstName(&quot;name two&quot;);</span>
<span class="nc" id="L450">            idmIdentityService.saveUser(user2);</span>
<span class="nc" id="L451">        })</span>
<span class="nc" id="L452">                .isExactlyInstanceOf(FlowableOptimisticLockingException.class);</span>

<span class="nc" id="L454">        idmIdentityService.deleteUser(user.getId());</span>
<span class="nc" id="L455">    }</span>

    @Test
    public void testGroupOptimisticLockingException() {
<span class="nc" id="L459">        Group group = idmIdentityService.newGroup(&quot;group&quot;);</span>
<span class="nc" id="L460">        idmIdentityService.saveGroup(group);</span>

<span class="nc" id="L462">        Group group1 = idmIdentityService.createGroupQuery().singleResult();</span>
<span class="nc" id="L463">        Group group2 = idmIdentityService.createGroupQuery().singleResult();</span>

<span class="nc" id="L465">        group1.setName(&quot;name one&quot;);</span>
<span class="nc" id="L466">        idmIdentityService.saveGroup(group1);</span>

<span class="nc" id="L468">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L469">            group2.setName(&quot;name two&quot;);</span>
<span class="nc" id="L470">            idmIdentityService.saveGroup(group2);</span>
<span class="nc" id="L471">        })</span>
<span class="nc" id="L472">                .isExactlyInstanceOf(FlowableOptimisticLockingException.class);</span>

<span class="nc" id="L474">        idmIdentityService.deleteGroup(group.getId());</span>
<span class="nc" id="L475">    }</span>

    @Test
    public void testNewToken() {
<span class="nc" id="L479">        Token token = idmIdentityService.newToken(&quot;myToken&quot;);</span>
<span class="nc" id="L480">        token.setIpAddress(&quot;127.0.0.1&quot;);</span>
<span class="nc" id="L481">        token.setTokenValue(&quot;myValue&quot;);</span>
<span class="nc" id="L482">        token.setTokenDate(new Date());</span>

<span class="nc" id="L484">        idmIdentityService.saveToken(token);</span>

<span class="nc" id="L486">        Token token1 = idmIdentityService.createTokenQuery().singleResult();</span>
<span class="nc" id="L487">        assertThat(token1.getId()).isEqualTo(&quot;myToken&quot;);</span>
<span class="nc" id="L488">        assertThat(token1.getTokenValue()).isEqualTo(&quot;myValue&quot;);</span>
<span class="nc" id="L489">        assertThat(token1.getIpAddress()).isEqualTo(&quot;127.0.0.1&quot;);</span>
<span class="nc" id="L490">        assertThat(token1.getUserAgent()).isNull();</span>

<span class="nc" id="L492">        token1.setUserAgent(&quot;myAgent&quot;);</span>
<span class="nc" id="L493">        idmIdentityService.saveToken(token1);</span>

<span class="nc" id="L495">        token1 = idmIdentityService.createTokenQuery().singleResult();</span>
<span class="nc" id="L496">        assertThat(token1.getUserAgent()).isEqualTo(&quot;myAgent&quot;);</span>

<span class="nc" id="L498">        idmIdentityService.deleteToken(token1.getId());</span>
<span class="nc" id="L499">    }</span>

    @Test
    public void testTokenOptimisticLockingException() {
<span class="nc" id="L503">        Token token = idmIdentityService.newToken(&quot;myToken&quot;);</span>
<span class="nc" id="L504">        idmIdentityService.saveToken(token);</span>

<span class="nc" id="L506">        Token token1 = idmIdentityService.createTokenQuery().singleResult();</span>
<span class="nc" id="L507">        Token token2 = idmIdentityService.createTokenQuery().singleResult();</span>

<span class="nc" id="L509">        token1.setUserAgent(&quot;name one&quot;);</span>
<span class="nc" id="L510">        idmIdentityService.saveToken(token1);</span>

<span class="nc" id="L512">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L513">            token2.setUserAgent(&quot;name two&quot;);</span>
<span class="nc" id="L514">            idmIdentityService.saveToken(token2);</span>
<span class="nc" id="L515">        })</span>
<span class="nc" id="L516">                .isExactlyInstanceOf(FlowableOptimisticLockingException.class);</span>

<span class="nc" id="L518">        idmIdentityService.deleteToken(token.getId());</span>
<span class="nc" id="L519">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>