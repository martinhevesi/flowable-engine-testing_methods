<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ChangeStateForMultiInstanceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.runtime.changestate</a> &gt; <span class="el_source">ChangeStateForMultiInstanceTest.java</span></div><h1>ChangeStateForMultiInstanceTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.engine.test.api.runtime.changestate;

import static org.assertj.core.api.Assertions.assertThat;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import org.assertj.core.api.Condition;
import org.flowable.engine.impl.persistence.entity.ExecutionEntity;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.runtime.ChangeActivityStateBuilder;
import org.flowable.engine.runtime.Execution;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.task.api.Task;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

/**
 * @author Frederik Heremans
 * @author Joram Barrez
 * @author Dennis Federico
 */
<span class="nc" id="L42">public class ChangeStateForMultiInstanceTest extends PluggableFlowableTestCase {</span>

<span class="nc" id="L44">    private ChangeStateEventListener changeStateEventListener = new ChangeStateEventListener();</span>

    @BeforeEach
    protected void setUp() {
<span class="nc" id="L48">        processEngine.getRuntimeService().addEventListener(changeStateEventListener);</span>
<span class="nc" id="L49">    }</span>

    @AfterEach
    protected void tearDown() {
<span class="nc" id="L53">        processEngine.getRuntimeService().removeEventListener(changeStateEventListener);</span>
<span class="nc" id="L54">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/multiInstanceSequential.bpmn20.xml&quot;)
    public void testSetCurrentActivityToSequentialMultiInstanceTask() {
<span class="nc" id="L59">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;sequentialMultiInstance&quot;)</span>
<span class="nc" id="L60">                .variable(&quot;nrOfLoops&quot;, 3)</span>
<span class="nc" id="L61">                .start();</span>

<span class="nc" id="L63">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L64">        assertThat(executions)</span>
<span class="nc" id="L65">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L66">                .containsExactly(&quot;beforeMultiInstance&quot;);</span>
<span class="nc" id="L67">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L68">        assertThat(tasks)</span>
<span class="nc" id="L69">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L70">                .containsExactly(&quot;beforeMultiInstance&quot;);</span>

<span class="nc" id="L72">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L73">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L74">                .moveActivityIdTo(&quot;beforeMultiInstance&quot;, &quot;seqTasks&quot;)</span>
<span class="nc" id="L75">                .changeState();</span>

        //First in the loop
<span class="nc" id="L78">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
        //One MI root and one seq Execution
<span class="nc" id="L80">        assertThat(executions)</span>
<span class="nc" id="L81">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L82">                .containsExactly(&quot;seqTasks&quot;, &quot;seqTasks&quot;);</span>

<span class="nc" id="L84">        Execution miRoot = executions.stream().filter(e -&gt; ((ExecutionEntity) e).isMultiInstanceRoot()).findFirst().get();</span>
<span class="nc" id="L85">        Map&lt;String, Object&gt; miRootVars = runtimeService.getVariables(miRoot.getId());</span>
<span class="nc" id="L86">        assertThat(miRootVars)</span>
<span class="nc" id="L87">                .extracting(&quot;nrOfActiveInstances&quot;, &quot;nrOfCompletedInstances&quot;, &quot;nrOfLoops&quot;)</span>
<span class="nc" id="L88">                .containsExactly(1, 0, 3);</span>

<span class="nc" id="L90">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).active().list();</span>
<span class="nc" id="L91">        assertThat(tasks)</span>
<span class="nc" id="L92">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L93">                .containsExactly(&quot;seqTasks&quot;);</span>
<span class="nc" id="L94">        assertThat(taskService.getVariable(tasks.get(0).getId(), &quot;loopCounter&quot;)).isEqualTo(0);</span>

<span class="nc" id="L96">        taskService.complete(tasks.get(0).getId());</span>

        //Second in the loop
<span class="nc" id="L99">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
        //One MI root and one seq Execution
<span class="nc" id="L101">        assertThat(executions)</span>
<span class="nc" id="L102">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L103">                .containsExactly(&quot;seqTasks&quot;, &quot;seqTasks&quot;);</span>

<span class="nc" id="L105">        miRoot = executions.stream().filter(e -&gt; ((ExecutionEntity) e).isMultiInstanceRoot()).findFirst().get();</span>
<span class="nc" id="L106">        miRootVars = runtimeService.getVariables(miRoot.getId());</span>
<span class="nc" id="L107">        assertThat(miRootVars)</span>
<span class="nc" id="L108">                .extracting(&quot;nrOfActiveInstances&quot;, &quot;nrOfCompletedInstances&quot;, &quot;nrOfLoops&quot;)</span>
<span class="nc" id="L109">                .containsExactly(1, 1, 3);</span>

<span class="nc" id="L111">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).active().list();</span>
<span class="nc" id="L112">        assertThat(tasks)</span>
<span class="nc" id="L113">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L114">                .containsExactly(&quot;seqTasks&quot;);</span>
<span class="nc" id="L115">        assertThat(taskService.getVariable(tasks.get(0).getId(), &quot;loopCounter&quot;)).isEqualTo(1);</span>

        //Complete second and third
<span class="nc" id="L118">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L119">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).active().list();</span>
<span class="nc" id="L120">        taskService.complete(tasks.get(0).getId());</span>

        //After the MI
<span class="nc" id="L123">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L124">        assertThat(executions)</span>
<span class="nc" id="L125">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L126">                .containsExactly(&quot;nextTask&quot;);</span>
<span class="nc" id="L127">        assertThat((ExecutionEntity) executions.get(0))</span>
<span class="nc" id="L128">                .extracting(ExecutionEntity::isMultiInstanceRoot)</span>
<span class="nc" id="L129">                .isEqualTo(false);</span>

<span class="nc" id="L131">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).active().singleResult();</span>
<span class="nc" id="L132">        assertThat(task)</span>
<span class="nc" id="L133">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L134">                .isEqualTo(&quot;nextTask&quot;);</span>
<span class="nc" id="L135">        assertThat(taskService.getVariable(task.getId(), &quot;loopCounter&quot;)).isNull();</span>

        //Complete the process
<span class="nc" id="L138">        taskService.complete(task.getId());</span>
<span class="nc" id="L139">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L140">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/multiInstanceSequential.bpmn20.xml&quot;)
    public void testSetCurrentActivityOfSequentialMultiInstanceTask() {
<span class="nc" id="L145">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;sequentialMultiInstance&quot;)</span>
<span class="nc" id="L146">                .variable(&quot;nrOfLoops&quot;, 5)</span>
<span class="nc" id="L147">                .start();</span>

<span class="nc" id="L149">        completeTask(taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult());</span>

<span class="nc" id="L151">        List&lt;Execution&gt; seqExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L152">        assertThat(seqExecutions).hasSize(2);</span>
<span class="nc" id="L153">        List&lt;Task&gt; activeSeqTasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).active().list();</span>
<span class="nc" id="L154">        assertThat(activeSeqTasks).hasSize(1);</span>

        //First in the loop
<span class="nc" id="L157">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L158">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;seqTasks&quot;);</span>
<span class="nc" id="L159">        assertThat(taskService.getVariable(task.getId(), &quot;loopCounter&quot;)).isEqualTo(0);</span>
<span class="nc" id="L160">        taskService.complete(task.getId());</span>

        //Second in the loop
<span class="nc" id="L163">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L164">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;seqTasks&quot;);</span>
<span class="nc" id="L165">        assertThat(taskService.getVariable(task.getId(), &quot;loopCounter&quot;)).isEqualTo(1);</span>

<span class="nc" id="L167">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L168">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L169">                .moveActivityIdTo(&quot;seqTasks&quot;, &quot;nextTask&quot;)</span>
<span class="nc" id="L170">                .changeState();</span>

<span class="nc" id="L172">        seqExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L173">        assertThat(seqExecutions).hasSize(1);</span>
<span class="nc" id="L174">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L175">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;nextTask&quot;);</span>
<span class="nc" id="L176">        assertThat(taskService.getVariable(task.getId(), &quot;loopCounter&quot;)).isNull();</span>
<span class="nc" id="L177">        taskService.complete(task.getId());</span>

<span class="nc" id="L179">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L180">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/multiInstanceSequential.bpmn20.xml&quot;)
    public void testSetCurrentParentExecutionOfSequentialMultiInstanceTask() {
<span class="nc" id="L185">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;sequentialMultiInstance&quot;)</span>
<span class="nc" id="L186">                .variable(&quot;nrOfLoops&quot;, 5)</span>
<span class="nc" id="L187">                .start();</span>

<span class="nc" id="L189">        completeTask(taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult());</span>

<span class="nc" id="L191">        List&lt;Execution&gt; seqExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L192">        assertThat(seqExecutions).hasSize(2);</span>
<span class="nc" id="L193">        List&lt;Task&gt; activeSeqTasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).active().list();</span>
<span class="nc" id="L194">        assertThat(activeSeqTasks).hasSize(1);</span>

        //First in the loop
<span class="nc" id="L197">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L198">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;seqTasks&quot;);</span>
<span class="nc" id="L199">        assertThat(taskService.getVariable(task.getId(), &quot;loopCounter&quot;)).isEqualTo(0);</span>
<span class="nc" id="L200">        taskService.complete(task.getId());</span>

        //Second in the loop
<span class="nc" id="L203">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L204">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;seqTasks&quot;);</span>
<span class="nc" id="L205">        assertThat(taskService.getVariable(task.getId(), &quot;loopCounter&quot;)).isEqualTo(1);</span>

        //move the parent execution - otherwise the parent multi instance execution remains, although active==false.
<span class="nc" id="L208">        String parentExecutionId = runtimeService.createExecutionQuery().executionId(task.getExecutionId()).singleResult().getParentId();</span>
<span class="nc" id="L209">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L210">                .moveExecutionToActivityId(parentExecutionId, &quot;nextTask&quot;)</span>
<span class="nc" id="L211">                .changeState();</span>

<span class="nc" id="L213">        seqExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L214">        assertThat(seqExecutions).hasSize(1);</span>
<span class="nc" id="L215">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L216">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;nextTask&quot;);</span>
<span class="nc" id="L217">        assertThat(taskService.getVariable(task.getId(), &quot;loopCounter&quot;)).isNull();</span>
<span class="nc" id="L218">        taskService.complete(task.getId());</span>

<span class="nc" id="L220">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L221">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/multiInstanceParallel.bpmn20.xml&quot;)
    public void testSetCurrentActivityToParallelMultiInstanceTask() {
<span class="nc" id="L226">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;parallelMultiInstance&quot;)</span>
<span class="nc" id="L227">                .variable(&quot;nrOfLoops&quot;, 3)</span>
<span class="nc" id="L228">                .start();</span>

<span class="nc" id="L230">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L231">        assertThat(executions)</span>
<span class="nc" id="L232">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L233">                .containsExactly(&quot;beforeMultiInstance&quot;);</span>
<span class="nc" id="L234">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L235">        assertThat(tasks)</span>
<span class="nc" id="L236">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L237">                .containsExactly(&quot;beforeMultiInstance&quot;);</span>

<span class="nc" id="L239">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L240">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L241">                .moveActivityIdTo(&quot;beforeMultiInstance&quot;, &quot;parallelTasks&quot;)</span>
<span class="nc" id="L242">                .changeState();</span>

        //First in the loop
<span class="nc" id="L245">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
        //One MI root and 3 parallel Executions
<span class="nc" id="L247">        assertThat(executions)</span>
<span class="nc" id="L248">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L249">                .containsExactly(&quot;parallelTasks&quot;, &quot;parallelTasks&quot;, &quot;parallelTasks&quot;, &quot;parallelTasks&quot;);</span>

<span class="nc" id="L251">        Execution miRoot = executions.stream().filter(e -&gt; ((ExecutionEntity) e).isMultiInstanceRoot()).findFirst().get();</span>
<span class="nc" id="L252">        Map&lt;String, Object&gt; miRootVars = runtimeService.getVariables(miRoot.getId());</span>
<span class="nc" id="L253">        assertThat(miRootVars)</span>
<span class="nc" id="L254">                .extracting(&quot;nrOfActiveInstances&quot;, &quot;nrOfCompletedInstances&quot;, &quot;nrOfLoops&quot;)</span>
<span class="nc" id="L255">                .containsExactly(3, 0, 3);</span>

<span class="nc" id="L257">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).active().list();</span>
<span class="nc" id="L258">        assertThat(tasks)</span>
<span class="nc" id="L259">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L260">                .containsExactly(&quot;parallelTasks&quot;, &quot;parallelTasks&quot;, &quot;parallelTasks&quot;);</span>
<span class="nc" id="L261">        assertThat(tasks)</span>
<span class="nc" id="L262">                .extracting(task -&gt; taskService.getVariable(task.getId(), &quot;loopCounter&quot;))</span>
<span class="nc" id="L263">                .isNotNull();</span>
        //        assertThat(taskService.getVariable(tasks.get(0).getId(), &quot;loopCounter&quot;)).isNotNull()

        //Complete one execution
<span class="nc" id="L267">        taskService.complete(tasks.get(0).getId());</span>

        //Confirm new state
<span class="nc" id="L270">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L271">        assertThat(executions)</span>
<span class="nc" id="L272">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L273">                .containsExactly(&quot;parallelTasks&quot;, &quot;parallelTasks&quot;, &quot;parallelTasks&quot;, &quot;parallelTasks&quot;);</span>

<span class="nc" id="L275">        miRoot = executions.stream().filter(e -&gt; ((ExecutionEntity) e).isMultiInstanceRoot()).findFirst().get();</span>
<span class="nc" id="L276">        miRootVars = runtimeService.getVariables(miRoot.getId());</span>
<span class="nc" id="L277">        assertThat(miRootVars)</span>
<span class="nc" id="L278">                .extracting(&quot;nrOfActiveInstances&quot;, &quot;nrOfCompletedInstances&quot;, &quot;nrOfLoops&quot;)</span>
<span class="nc" id="L279">                .containsExactly(2, 1, 3);</span>

        //Two executions are inactive, the completed before and the MI root
<span class="nc" id="L282">        assertThat(executions)</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">                .haveExactly(2, new Condition&lt;&gt;((Execution execution) -&gt; !((ExecutionEntity) execution).isActive(), &quot;inactive&quot;));</span>

<span class="nc" id="L285">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).active().list();</span>
<span class="nc" id="L286">        assertThat(tasks)</span>
<span class="nc" id="L287">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L288">                .containsExactly(&quot;parallelTasks&quot;, &quot;parallelTasks&quot;);</span>
<span class="nc" id="L289">        assertThat(taskService.getVariable(tasks.get(0).getId(), &quot;loopCounter&quot;)).isEqualTo(1);</span>

        //Complete the rest of the Tasks
<span class="nc" id="L292">        tasks.forEach(this::completeTask);</span>

        //After the MI
<span class="nc" id="L295">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L296">        assertThat(executions)</span>
<span class="nc" id="L297">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L298">                .containsExactly(&quot;nextTask&quot;);</span>
<span class="nc" id="L299">        assertThat((ExecutionEntity) executions.get(0))</span>
<span class="nc" id="L300">                .extracting(ExecutionEntity::isMultiInstanceRoot).isEqualTo(false);</span>

<span class="nc" id="L302">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).active().singleResult();</span>
<span class="nc" id="L303">        assertThat(task)</span>
<span class="nc" id="L304">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L305">                .isEqualTo(&quot;nextTask&quot;);</span>
<span class="nc" id="L306">        assertThat(taskService.getVariable(task.getId(), &quot;loopCounter&quot;)).isNull();</span>

        //Complete the process
<span class="nc" id="L309">        taskService.complete(task.getId());</span>
<span class="nc" id="L310">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L311">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/multiInstanceParallel.bpmn20.xml&quot;)
    public void testSetCurrentActivityOfParallelMultiInstanceTask() {
<span class="nc" id="L316">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;parallelMultiInstance&quot;)</span>
<span class="nc" id="L317">                .variable(&quot;nrOfLoops&quot;, 3)</span>
<span class="nc" id="L318">                .start();</span>

<span class="nc" id="L320">        completeTask(taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult());</span>

<span class="nc" id="L322">        List&lt;Execution&gt; parallelExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L323">        assertThat(parallelExecutions).hasSize(4);</span>
<span class="nc" id="L324">        List&lt;Task&gt; activeParallelTasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).active().list();</span>
<span class="nc" id="L325">        assertThat(activeParallelTasks).hasSize(3);</span>

        //Complete one of the tasks
<span class="nc" id="L328">        taskService.complete(activeParallelTasks.get(1).getId());</span>
<span class="nc" id="L329">        parallelExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L330">        assertThat(parallelExecutions).hasSize(4);</span>
<span class="nc" id="L331">        activeParallelTasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).active().list();</span>
<span class="nc" id="L332">        assertThat(activeParallelTasks).hasSize(2);</span>

<span class="nc" id="L334">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L335">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L336">                .moveActivityIdTo(&quot;parallelTasks&quot;, &quot;nextTask&quot;)</span>
<span class="nc" id="L337">                .changeState();</span>

<span class="nc" id="L339">        parallelExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L340">        assertThat(parallelExecutions).hasSize(1);</span>
<span class="nc" id="L341">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L342">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;nextTask&quot;);</span>
<span class="nc" id="L343">        taskService.complete(task.getId());</span>

<span class="nc" id="L345">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L346">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/multiInstanceParallel.bpmn20.xml&quot;)
    public void testSetCurrentParentExecutionOfParallelMultiInstanceTask() {
<span class="nc" id="L351">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;parallelMultiInstance&quot;)</span>
<span class="nc" id="L352">                .variable(&quot;nrOfLoops&quot;, 3)</span>
<span class="nc" id="L353">                .start();</span>

<span class="nc" id="L355">        completeTask(taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult());</span>

<span class="nc" id="L357">        List&lt;Execution&gt; parallelExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L358">        assertThat(parallelExecutions).hasSize(4);</span>
<span class="nc" id="L359">        List&lt;Task&gt; activeParallelTasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).active().list();</span>
<span class="nc" id="L360">        assertThat(activeParallelTasks).hasSize(3);</span>

        //Complete one of the tasks
<span class="nc" id="L363">        taskService.complete(activeParallelTasks.get(1).getId());</span>
<span class="nc" id="L364">        parallelExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L365">        assertThat(parallelExecutions).hasSize(4);</span>
<span class="nc" id="L366">        activeParallelTasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).active().list();</span>
<span class="nc" id="L367">        assertThat(activeParallelTasks).hasSize(2);</span>

        //Fetch the parent execution of the multi instance task execution
<span class="nc" id="L370">        String parentExecutionId = runtimeService.createExecutionQuery().executionId(activeParallelTasks.get(0).getExecutionId()).singleResult().getParentId();</span>
<span class="nc" id="L371">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L372">                .moveExecutionToActivityId(parentExecutionId, &quot;nextTask&quot;)</span>
<span class="nc" id="L373">                .changeState();</span>

<span class="nc" id="L375">        parallelExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L376">        assertThat(parallelExecutions).hasSize(1);</span>
<span class="nc" id="L377">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L378">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;nextTask&quot;);</span>
<span class="nc" id="L379">        taskService.complete(task.getId());</span>

<span class="nc" id="L381">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L382">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/multiInstanceParallelSubProcess.bpmn20.xml&quot;)
    public void testSetCurrentExecutionWithinMultiInstanceParallelSubProcess() {
<span class="nc" id="L387">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;parallelMultiInstanceSubProcess&quot;)</span>
<span class="nc" id="L388">                .variable(&quot;nrOfLoops&quot;, 3)</span>
<span class="nc" id="L389">                .start();</span>

        //One of the child executions is the parent of the multiInstance &quot;loop&quot;
<span class="nc" id="L392">        long executionsCount = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L393">        assertThat(executionsCount).isEqualTo(7);</span>
<span class="nc" id="L394">        long parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcess&quot;).count();</span>
<span class="nc" id="L395">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L396">        List&lt;Execution&gt; subTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask1&quot;).list();</span>
<span class="nc" id="L397">        assertThat(subTask1Executions).hasSize(3);</span>

        //Move one of the executions within the multiInstance subProcess
<span class="nc" id="L400">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L401">                .moveExecutionToActivityId(subTask1Executions.get(0).getId(), &quot;subTask2&quot;)</span>
<span class="nc" id="L402">                .changeState();</span>

<span class="nc" id="L404">        executionsCount = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L405">        assertThat(executionsCount).isEqualTo(7);</span>
<span class="nc" id="L406">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcess&quot;).count();</span>
<span class="nc" id="L407">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L408">        subTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask1&quot;).list();</span>
<span class="nc" id="L409">        assertThat(subTask1Executions).hasSize(2);</span>
<span class="nc" id="L410">        List&lt;Execution&gt; subTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask2&quot;).list();</span>
<span class="nc" id="L411">        assertThat(subTask2Executions).hasSize(1);</span>

        //Complete one of the parallel subProcesses &quot;subTask2&quot;
<span class="nc" id="L414">        Task task = taskService.createTaskQuery().executionId(subTask2Executions.get(0).getId()).singleResult();</span>
<span class="nc" id="L415">        taskService.complete(task.getId());</span>

<span class="nc" id="L417">        executionsCount = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L418">        assertThat(executionsCount).isEqualTo(6);</span>
<span class="nc" id="L419">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcess&quot;).count();</span>
<span class="nc" id="L420">        assertThat(parallelSubProcessCount).isEqualTo(2);</span>
<span class="nc" id="L421">        subTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask1&quot;).list();</span>
<span class="nc" id="L422">        assertThat(subTask1Executions).hasSize(2);</span>
<span class="nc" id="L423">        subTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask2&quot;).list();</span>
<span class="nc" id="L424">        assertThat(subTask2Executions).isEmpty();</span>

        //Move the other two executions, one by one
<span class="nc" id="L427">        ChangeActivityStateBuilder changeActivityStateBuilder = runtimeService.createChangeActivityStateBuilder();</span>
<span class="nc" id="L428">        subTask1Executions.forEach(e -&gt; changeActivityStateBuilder.moveExecutionToActivityId(e.getId(), &quot;subTask2&quot;));</span>
<span class="nc" id="L429">        changeActivityStateBuilder.changeState();</span>

<span class="nc" id="L431">        executionsCount = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L432">        assertThat(executionsCount).isEqualTo(6);</span>
<span class="nc" id="L433">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcess&quot;).count();</span>
<span class="nc" id="L434">        assertThat(parallelSubProcessCount).isEqualTo(2);</span>
<span class="nc" id="L435">        subTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask1&quot;).list();</span>
<span class="nc" id="L436">        assertThat(subTask1Executions).isEmpty();</span>
<span class="nc" id="L437">        subTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask2&quot;).list();</span>
<span class="nc" id="L438">        assertThat(subTask2Executions).hasSize(2);</span>

        //Complete the rest of the SubProcesses
<span class="nc" id="L441">        List&lt;Task&gt; tasks = taskService.createTaskQuery().taskDefinitionKey(&quot;subTask2&quot;).list();</span>
<span class="nc" id="L442">        assertThat(tasks).hasSize(2);</span>
<span class="nc" id="L443">        tasks.forEach(t -&gt; taskService.complete(t.getId()));</span>

        //There's no multiInstance anymore
<span class="nc" id="L446">        executionsCount = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L447">        assertThat(executionsCount).isEqualTo(1);</span>

<span class="nc" id="L449">        task = taskService.createTaskQuery().active().singleResult();</span>
<span class="nc" id="L450">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;lastTask&quot;);</span>
<span class="nc" id="L451">        taskService.complete(task.getId());</span>

<span class="nc" id="L453">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L454">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/multiInstanceParallelSubProcess.bpmn20.xml&quot;)
    public void testSetCurrentActivityWithinMultiInstanceParallelSubProcess() {
<span class="nc" id="L459">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;parallelMultiInstanceSubProcess&quot;)</span>
<span class="nc" id="L460">                .variable(&quot;nrOfLoops&quot;, 3)</span>
<span class="nc" id="L461">                .start();</span>

        //One of the child executions is the parent of the multiInstance &quot;loop&quot;
<span class="nc" id="L464">        long executionsCount = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L465">        assertThat(executionsCount).isEqualTo(7);</span>
<span class="nc" id="L466">        long parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcess&quot;).count();</span>
<span class="nc" id="L467">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L468">        List&lt;Execution&gt; subTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask1&quot;).list();</span>
<span class="nc" id="L469">        assertThat(subTask1Executions).hasSize(3);</span>

        //Move one of the executions within the multiInstance subProcess
<span class="nc" id="L472">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L473">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L474">                .moveActivityIdTo(&quot;subTask1&quot;, &quot;subTask2&quot;)</span>
<span class="nc" id="L475">                .changeState();</span>

<span class="nc" id="L477">        executionsCount = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L478">        assertThat(executionsCount).isEqualTo(7);</span>
<span class="nc" id="L479">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcess&quot;).count();</span>
<span class="nc" id="L480">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L481">        subTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask1&quot;).list();</span>
<span class="nc" id="L482">        assertThat(subTask1Executions).isEmpty();</span>
<span class="nc" id="L483">        List&lt;Execution&gt; subTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask2&quot;).list();</span>
<span class="nc" id="L484">        assertThat(subTask2Executions).hasSize(3);</span>

        //Complete the parallel subProcesses &quot;subTask2&quot;
<span class="nc" id="L487">        List&lt;Task&gt; tasks = taskService.createTaskQuery().taskDefinitionKey(&quot;subTask2&quot;).list();</span>
<span class="nc" id="L488">        assertThat(tasks).hasSize(3);</span>
<span class="nc" id="L489">        tasks.forEach(t -&gt; taskService.complete(t.getId()));</span>

        //There's no multiInstance anymore
<span class="nc" id="L492">        executionsCount = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L493">        assertThat(executionsCount).isEqualTo(1);</span>

<span class="nc" id="L495">        Task task = taskService.createTaskQuery().active().singleResult();</span>
<span class="nc" id="L496">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;lastTask&quot;);</span>
<span class="nc" id="L497">        taskService.complete(task.getId());</span>

<span class="nc" id="L499">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L500">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/multiInstanceNestedParallelSubProcesses.bpmn20.xml&quot;)
    public void testSetCurrentExecutionWithinNestedMultiInstanceParallelSubProcess() {
<span class="nc" id="L505">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;parallelNestedMultiInstanceSubProcesses&quot;).start();</span>

<span class="nc" id="L507">        long totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L508">        assertThat(totalChildExecutions).isEqualTo(7);</span>
<span class="nc" id="L509">        long parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L510">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L511">        List&lt;Execution&gt; subTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask1&quot;).list();</span>
<span class="nc" id="L512">        assertThat(subTask1Executions).hasSize(3);</span>

        //Start the nested subProcesses by completing the first task of the outer subProcess
<span class="nc" id="L515">        List&lt;Task&gt; tasks = taskService.createTaskQuery().taskDefinitionKey(&quot;subTask1&quot;).list();</span>
<span class="nc" id="L516">        assertThat(tasks).hasSize(3);</span>
<span class="nc" id="L517">        tasks.forEach(t -&gt; taskService.complete(t.getId()));</span>

        // 3 instances of the outerSubProcess and each have 3 instances of a nestedSubProcess, for a total of 9 nestedSubTask executions
        // 9 nestedSubProcess instances and 3 outerSubProcesses instances -&gt; 12 executions
        // 1 Parent execution for the outerSubProcess and 1 parent for each nestedSubProcess -&gt; 4 extra parent executions
        // Grand Total -&gt;
<span class="nc" id="L523">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L524">        assertThat(totalChildExecutions).isEqualTo(25);</span>
<span class="nc" id="L525">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L526">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L527">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelNestedSubProcess&quot;).count();</span>
<span class="nc" id="L528">        assertThat(parallelSubProcessCount).isEqualTo(9);</span>
<span class="nc" id="L529">        List&lt;Execution&gt; nestedSubTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask1&quot;).list();</span>
<span class="nc" id="L530">        assertThat(nestedSubTask1Executions).hasSize(9);</span>

        //Move one of the executions within of the nested multiInstance subProcesses
<span class="nc" id="L533">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L534">                .moveExecutionToActivityId(nestedSubTask1Executions.get(0).getId(), &quot;nestedSubTask2&quot;)</span>
<span class="nc" id="L535">                .moveExecutionToActivityId(nestedSubTask1Executions.get(3).getId(), &quot;nestedSubTask2&quot;)</span>
<span class="nc" id="L536">                .moveExecutionToActivityId(nestedSubTask1Executions.get(6).getId(), &quot;nestedSubTask2&quot;)</span>
<span class="nc" id="L537">                .changeState();</span>

<span class="nc" id="L539">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L540">        assertThat(totalChildExecutions).isEqualTo(25);</span>
<span class="nc" id="L541">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L542">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L543">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelNestedSubProcess&quot;).count();</span>
<span class="nc" id="L544">        assertThat(parallelSubProcessCount).isEqualTo(9);</span>
<span class="nc" id="L545">        nestedSubTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask1&quot;).list();</span>
<span class="nc" id="L546">        assertThat(nestedSubTask1Executions).hasSize(6);</span>
<span class="nc" id="L547">        List&lt;Execution&gt; nestedSubTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask2&quot;).list();</span>
<span class="nc" id="L548">        assertThat(nestedSubTask2Executions).hasSize(3);</span>

        //Complete one of the outer subProcesses
<span class="nc" id="L551">        Task task = taskService.createTaskQuery().executionId(nestedSubTask2Executions.get(0).getId()).singleResult();</span>
<span class="nc" id="L552">        taskService.complete(task.getId());</span>

        //One less task execution and one less nested instance
<span class="nc" id="L555">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L556">        assertThat(totalChildExecutions).isEqualTo(24);</span>
<span class="nc" id="L557">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L558">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L559">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelNestedSubProcess&quot;).count();</span>
<span class="nc" id="L560">        assertThat(parallelSubProcessCount).isEqualTo(8);</span>
<span class="nc" id="L561">        nestedSubTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask1&quot;).list();</span>
<span class="nc" id="L562">        assertThat(nestedSubTask1Executions).hasSize(6);</span>
<span class="nc" id="L563">        nestedSubTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask2&quot;).list();</span>
<span class="nc" id="L564">        assertThat(nestedSubTask2Executions).hasSize(2);</span>

        //Move the rest of the nestedSubTask1 executions
<span class="nc" id="L567">        ChangeActivityStateBuilder changeActivityStateBuilder = runtimeService.createChangeActivityStateBuilder();</span>
<span class="nc" id="L568">        nestedSubTask1Executions.forEach(e -&gt; changeActivityStateBuilder.moveExecutionToActivityId(e.getId(), &quot;nestedSubTask2&quot;));</span>
<span class="nc" id="L569">        changeActivityStateBuilder.changeState();</span>

<span class="nc" id="L571">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L572">        assertThat(totalChildExecutions).isEqualTo(24);</span>
<span class="nc" id="L573">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L574">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L575">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelNestedSubProcess&quot;).count();</span>
<span class="nc" id="L576">        assertThat(parallelSubProcessCount).isEqualTo(8);</span>
<span class="nc" id="L577">        nestedSubTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask1&quot;).list();</span>
<span class="nc" id="L578">        assertThat(nestedSubTask1Executions).isEmpty();</span>
<span class="nc" id="L579">        nestedSubTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask2&quot;).list();</span>
<span class="nc" id="L580">        assertThat(nestedSubTask2Executions).hasSize(8);</span>

        //Complete all the nestedSubTask2
<span class="nc" id="L583">        tasks = taskService.createTaskQuery().taskDefinitionKey(&quot;nestedSubTask2&quot;).list();</span>
<span class="nc" id="L584">        assertThat(tasks).hasSize(8);</span>
<span class="nc" id="L585">        tasks.forEach(t -&gt; taskService.complete(t.getId()));</span>

        //Nested subProcesses have completed, only outer subProcess remain
<span class="nc" id="L588">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L589">        assertThat(totalChildExecutions).isEqualTo(7);</span>
<span class="nc" id="L590">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L591">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L592">        List&lt;Execution&gt; subTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask2&quot;).list();</span>
<span class="nc" id="L593">        assertThat(subTask2Executions).hasSize(3);</span>

        //Complete the outer subProcesses
<span class="nc" id="L596">        tasks = taskService.createTaskQuery().taskDefinitionKey(&quot;subTask2&quot;).list();</span>
<span class="nc" id="L597">        assertThat(tasks).hasSize(3);</span>
<span class="nc" id="L598">        tasks.forEach(t -&gt; taskService.complete(t.getId()));</span>

<span class="nc" id="L600">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L601">        assertThat(totalChildExecutions).isEqualTo(1);</span>

<span class="nc" id="L603">        task = taskService.createTaskQuery().active().singleResult();</span>
<span class="nc" id="L604">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;lastTask&quot;);</span>
<span class="nc" id="L605">        taskService.complete(task.getId());</span>

<span class="nc" id="L607">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L608">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/multiInstanceNestedParallelSubProcesses.bpmn20.xml&quot;)
    public void testSetCurrentActivityWithinNestedMultiInstanceParallelSubProcess() {
<span class="nc" id="L613">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;parallelNestedMultiInstanceSubProcesses&quot;).start();</span>

<span class="nc" id="L615">        long totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L616">        assertThat(totalChildExecutions).isEqualTo(7);</span>
<span class="nc" id="L617">        long parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L618">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L619">        List&lt;Execution&gt; subTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask1&quot;).list();</span>
<span class="nc" id="L620">        assertThat(subTask1Executions).hasSize(3);</span>

        //Start the nested subProcesses by completing the first task of the outer subProcess
<span class="nc" id="L623">        List&lt;Task&gt; tasks = taskService.createTaskQuery().taskDefinitionKey(&quot;subTask1&quot;).list();</span>
<span class="nc" id="L624">        assertThat(tasks).hasSize(3);</span>
<span class="nc" id="L625">        tasks.forEach(t -&gt; taskService.complete(t.getId()));</span>

        // 3 instances of the outerSubProcess and each have 3 instances of a nestedSubProcess, for a total of 9 nestedSubTask executions
        // 9 nestedSubProcess instances and 3 outerSubProcesses instances -&gt; 12 executions
        // 1 Parent execution for the outerSubProcess and 1 parent for each nestedSubProcess -&gt; 4 extra parent executions
        // Grand Total -&gt;
<span class="nc" id="L631">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L632">        assertThat(totalChildExecutions).isEqualTo(25);</span>
<span class="nc" id="L633">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L634">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L635">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelNestedSubProcess&quot;).count();</span>
<span class="nc" id="L636">        assertThat(parallelSubProcessCount).isEqualTo(9);</span>
<span class="nc" id="L637">        List&lt;Execution&gt; nestedSubTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask1&quot;).list();</span>
<span class="nc" id="L638">        assertThat(nestedSubTask1Executions).hasSize(9);</span>

        //Complete one task for each nestedSubProcess
<span class="nc" id="L641">        taskService.complete(taskService.createTaskQuery().executionId(nestedSubTask1Executions.get(0).getId()).singleResult().getId());</span>
<span class="nc" id="L642">        taskService.complete(taskService.createTaskQuery().executionId(nestedSubTask1Executions.get(3).getId()).singleResult().getId());</span>
<span class="nc" id="L643">        taskService.complete(taskService.createTaskQuery().executionId(nestedSubTask1Executions.get(6).getId()).singleResult().getId());</span>

<span class="nc" id="L645">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L646">        assertThat(totalChildExecutions).isEqualTo(25);</span>
<span class="nc" id="L647">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L648">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L649">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelNestedSubProcess&quot;).count();</span>
<span class="nc" id="L650">        assertThat(parallelSubProcessCount).isEqualTo(9);</span>
<span class="nc" id="L651">        nestedSubTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask1&quot;).list();</span>
<span class="nc" id="L652">        assertThat(nestedSubTask1Executions).hasSize(6);</span>
<span class="nc" id="L653">        List&lt;Execution&gt; nestedSubTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask2&quot;).list();</span>
<span class="nc" id="L654">        assertThat(nestedSubTask2Executions).hasSize(3);</span>

        //Moving the nestedSubTask1 activity should move all its executions
<span class="nc" id="L657">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L658">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L659">                .moveActivityIdTo(&quot;nestedSubTask1&quot;, &quot;nestedSubTask2&quot;)</span>
<span class="nc" id="L660">                .changeState();</span>

<span class="nc" id="L662">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L663">        assertThat(totalChildExecutions).isEqualTo(25);</span>
<span class="nc" id="L664">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L665">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L666">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelNestedSubProcess&quot;).count();</span>
<span class="nc" id="L667">        assertThat(parallelSubProcessCount).isEqualTo(9);</span>
<span class="nc" id="L668">        nestedSubTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask1&quot;).list();</span>
<span class="nc" id="L669">        assertThat(nestedSubTask1Executions).isEmpty();</span>
<span class="nc" id="L670">        nestedSubTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask2&quot;).list();</span>
<span class="nc" id="L671">        assertThat(nestedSubTask2Executions).hasSize(9);</span>

        //Complete all the nestedSubTask2
<span class="nc" id="L674">        tasks = taskService.createTaskQuery().taskDefinitionKey(&quot;nestedSubTask2&quot;).list();</span>
<span class="nc" id="L675">        assertThat(tasks).hasSize(9);</span>
<span class="nc" id="L676">        tasks.forEach(t -&gt; taskService.complete(t.getId()));</span>

        //Nested subProcesses have completed, only outer subProcess remain
<span class="nc" id="L679">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L680">        assertThat(totalChildExecutions).isEqualTo(7);</span>
<span class="nc" id="L681">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L682">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L683">        List&lt;Execution&gt; subTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask2&quot;).list();</span>
<span class="nc" id="L684">        assertThat(subTask2Executions).hasSize(3);</span>

        //Complete the outer subProcesses
<span class="nc" id="L687">        tasks = taskService.createTaskQuery().taskDefinitionKey(&quot;subTask2&quot;).list();</span>
<span class="nc" id="L688">        assertThat(tasks).hasSize(3);</span>
<span class="nc" id="L689">        tasks.forEach(t -&gt; taskService.complete(t.getId()));</span>

<span class="nc" id="L691">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L692">        assertThat(totalChildExecutions).isEqualTo(1);</span>

<span class="nc" id="L694">        Task task = taskService.createTaskQuery().active().singleResult();</span>
<span class="nc" id="L695">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;lastTask&quot;);</span>
<span class="nc" id="L696">        taskService.complete(task.getId());</span>

<span class="nc" id="L698">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L699">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/multiInstanceParallelSubProcess.bpmn20.xml&quot;)
    public void testSetCurrentMultiInstanceSubProcessParentExecutionWithinProcess() {
<span class="nc" id="L704">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;parallelMultiInstanceSubProcess&quot;)</span>
<span class="nc" id="L705">                .variable(&quot;nrOfLoops&quot;, 3)</span>
<span class="nc" id="L706">                .start();</span>

        //One of the child executions is the parent of the multiInstance &quot;loop&quot;
<span class="nc" id="L709">        long executionsCount = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L710">        assertThat(executionsCount).isEqualTo(7);</span>
<span class="nc" id="L711">        long parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcess&quot;).count();</span>
<span class="nc" id="L712">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L713">        List&lt;Execution&gt; subTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask1&quot;).list();</span>
<span class="nc" id="L714">        assertThat(subTask1Executions).hasSize(3);</span>

        //Complete one of the Tasks
<span class="nc" id="L717">        Task task = taskService.createTaskQuery().executionId(subTask1Executions.get(1).getId()).singleResult();</span>
<span class="nc" id="L718">        taskService.complete(task.getId());</span>

<span class="nc" id="L720">        executionsCount = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L721">        assertThat(executionsCount).isEqualTo(7);</span>
<span class="nc" id="L722">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcess&quot;).count();</span>
<span class="nc" id="L723">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L724">        subTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask1&quot;).list();</span>
<span class="nc" id="L725">        assertThat(subTask1Executions).hasSize(2);</span>
<span class="nc" id="L726">        List&lt;Execution&gt; subTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask2&quot;).list();</span>
<span class="nc" id="L727">        assertThat(subTask2Executions).hasSize(1);</span>

        //Move the parallelSubProcess via the parentExecution Ids
<span class="nc" id="L730">        String ParallelSubProcessParentExecutionId = runtimeService.createExecutionQuery()</span>
<span class="nc" id="L731">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L732">                .activityId(&quot;parallelSubProcess&quot;)</span>
<span class="nc" id="L733">                .list()</span>
<span class="nc" id="L734">                .stream()</span>
<span class="nc" id="L735">                .findFirst()</span>
<span class="nc" id="L736">                .map(Execution::getParentId)</span>
<span class="nc" id="L737">                .get();</span>

<span class="nc" id="L739">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L740">                .moveExecutionToActivityId(ParallelSubProcessParentExecutionId, &quot;lastTask&quot;)</span>
<span class="nc" id="L741">                .changeState();</span>

        //There's no multiInstance anymore
<span class="nc" id="L744">        executionsCount = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L745">        assertThat(executionsCount).isEqualTo(1);</span>

<span class="nc" id="L747">        task = taskService.createTaskQuery().active().singleResult();</span>
<span class="nc" id="L748">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;lastTask&quot;);</span>
<span class="nc" id="L749">        taskService.complete(task.getId());</span>

<span class="nc" id="L751">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L752">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/multiInstanceParallelSubProcess.bpmn20.xml&quot;)
    public void testSetCurrentMultiInstanceSubProcessParentActivityWithinProcess() {
<span class="nc" id="L757">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;parallelMultiInstanceSubProcess&quot;)</span>
<span class="nc" id="L758">                .variable(&quot;nrOfLoops&quot;, 3)</span>
<span class="nc" id="L759">                .start();</span>

        //One of the child executions is the parent of the multiInstance &quot;loop&quot;
<span class="nc" id="L762">        long executionsCount = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L763">        assertThat(executionsCount).isEqualTo(7);</span>
<span class="nc" id="L764">        long parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcess&quot;).count();</span>
<span class="nc" id="L765">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L766">        List&lt;Execution&gt; subTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask1&quot;).list();</span>
<span class="nc" id="L767">        assertThat(subTask1Executions).hasSize(3);</span>

        //Complete one of the Tasks
<span class="nc" id="L770">        Task task = taskService.createTaskQuery().executionId(subTask1Executions.get(1).getId()).singleResult();</span>
<span class="nc" id="L771">        taskService.complete(task.getId());</span>

<span class="nc" id="L773">        executionsCount = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L774">        assertThat(executionsCount).isEqualTo(7);</span>
<span class="nc" id="L775">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcess&quot;).count();</span>
<span class="nc" id="L776">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L777">        subTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask1&quot;).list();</span>
<span class="nc" id="L778">        assertThat(subTask1Executions).hasSize(2);</span>
<span class="nc" id="L779">        List&lt;Execution&gt; subTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask2&quot;).list();</span>
<span class="nc" id="L780">        assertThat(subTask2Executions).hasSize(1);</span>

        //Move the parallelSubProcess
<span class="nc" id="L783">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L784">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L785">                .moveActivityIdTo(&quot;parallelSubProcess&quot;, &quot;lastTask&quot;)</span>
<span class="nc" id="L786">                .changeState();</span>

        //There's no multiInstance anymore
<span class="nc" id="L789">        executionsCount = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L790">        assertThat(executionsCount).isEqualTo(1);</span>

<span class="nc" id="L792">        task = taskService.createTaskQuery().active().singleResult();</span>
<span class="nc" id="L793">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;lastTask&quot;);</span>
<span class="nc" id="L794">        taskService.complete(task.getId());</span>

<span class="nc" id="L796">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L797">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/multiInstanceNestedParallelSubProcesses.bpmn20.xml&quot;)
    public void testSetCurrentMultiInstanceNestedSubProcessParentExecutionWithinSubProcess() {
<span class="nc" id="L802">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;parallelNestedMultiInstanceSubProcesses&quot;).start();</span>

<span class="nc" id="L804">        long totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L805">        assertThat(totalChildExecutions).isEqualTo(7);</span>
<span class="nc" id="L806">        long parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L807">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L808">        List&lt;Execution&gt; subTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask1&quot;).list();</span>
<span class="nc" id="L809">        assertThat(subTask1Executions).hasSize(3);</span>

        //Start the nested subProcesses by completing the first task of the outer subProcess
<span class="nc" id="L812">        List&lt;Task&gt; tasks = taskService.createTaskQuery().taskDefinitionKey(&quot;subTask1&quot;).list();</span>
<span class="nc" id="L813">        assertThat(tasks).hasSize(3);</span>
<span class="nc" id="L814">        tasks.forEach(t -&gt; taskService.complete(t.getId()));</span>

        // 3 instances of the outerSubProcess and each have 3 instances of a nestedSubProcess, for a total of 9 nestedSubTask executions
        // 9 nestedSubProcess instances and 3 outerSubProcesses instances -&gt; 12 executions
        // 1 Parent execution for the outerSubProcess and 1 parent for each nestedSubProcess -&gt; 4 extra parent executions
        // Grand Total -&gt;
<span class="nc" id="L820">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L821">        assertThat(totalChildExecutions).isEqualTo(25);</span>
<span class="nc" id="L822">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L823">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L824">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelNestedSubProcess&quot;).count();</span>
<span class="nc" id="L825">        assertThat(parallelSubProcessCount).isEqualTo(9);</span>
<span class="nc" id="L826">        List&lt;Execution&gt; nestedSubTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask1&quot;).list();</span>
<span class="nc" id="L827">        assertThat(nestedSubTask1Executions).hasSize(9);</span>

        //Complete some of the Nested tasks
<span class="nc" id="L830">        taskService.complete(taskService.createTaskQuery().executionId(nestedSubTask1Executions.get(0).getId()).singleResult().getId());</span>
<span class="nc" id="L831">        taskService.complete(taskService.createTaskQuery().executionId(nestedSubTask1Executions.get(3).getId()).singleResult().getId());</span>
<span class="nc" id="L832">        taskService.complete(taskService.createTaskQuery().executionId(nestedSubTask1Executions.get(6).getId()).singleResult().getId());</span>

<span class="nc" id="L834">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L835">        assertThat(totalChildExecutions).isEqualTo(25);</span>
<span class="nc" id="L836">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L837">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L838">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelNestedSubProcess&quot;).count();</span>
<span class="nc" id="L839">        assertThat(parallelSubProcessCount).isEqualTo(9);</span>
<span class="nc" id="L840">        nestedSubTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask1&quot;).list();</span>
<span class="nc" id="L841">        assertThat(nestedSubTask1Executions).hasSize(6);</span>
<span class="nc" id="L842">        List&lt;Execution&gt; nestedSubTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask2&quot;).list();</span>
<span class="nc" id="L843">        assertThat(nestedSubTask2Executions).hasSize(3);</span>

        //Complete one of the nested subProcesses
<span class="nc" id="L846">        Task task = taskService.createTaskQuery().executionId(nestedSubTask2Executions.get(0).getId()).singleResult();</span>
<span class="nc" id="L847">        taskService.complete(task.getId());</span>

        //One less task execution and one less nested instance
<span class="nc" id="L850">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L851">        assertThat(totalChildExecutions).isEqualTo(24);</span>
<span class="nc" id="L852">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L853">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L854">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelNestedSubProcess&quot;).count();</span>
<span class="nc" id="L855">        assertThat(parallelSubProcessCount).isEqualTo(8);</span>
<span class="nc" id="L856">        nestedSubTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask1&quot;).list();</span>
<span class="nc" id="L857">        assertThat(nestedSubTask1Executions).hasSize(6);</span>
<span class="nc" id="L858">        nestedSubTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask2&quot;).list();</span>
<span class="nc" id="L859">        assertThat(nestedSubTask2Executions).hasSize(2);</span>

        //Move each nested multiInstance parent
<span class="nc" id="L862">        Stream&lt;String&gt; parallelNestedSubProcessesParentIds = runtimeService.createExecutionQuery()</span>
<span class="nc" id="L863">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L864">                .activityId(&quot;parallelNestedSubProcess&quot;)</span>
<span class="nc" id="L865">                .list()</span>
<span class="nc" id="L866">                .stream()</span>
<span class="nc" id="L867">                .map(Execution::getParentId)</span>
<span class="nc" id="L868">                .distinct();</span>

<span class="nc" id="L870">        parallelNestedSubProcessesParentIds.forEach(parentId -&gt; {</span>
<span class="nc" id="L871">            runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L872">                    .moveExecutionToActivityId(parentId, &quot;subTask2&quot;)</span>
<span class="nc" id="L873">                    .changeState();</span>
<span class="nc" id="L874">        });</span>

        //Nested subProcesses have completed, only outer subProcess remain
<span class="nc" id="L877">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L878">        assertThat(totalChildExecutions).isEqualTo(7);</span>
<span class="nc" id="L879">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L880">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L881">        List&lt;Execution&gt; subTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask2&quot;).list();</span>
<span class="nc" id="L882">        assertThat(subTask2Executions).hasSize(3);</span>

        //Complete the outer subProcesses
<span class="nc" id="L885">        tasks = taskService.createTaskQuery().taskDefinitionKey(&quot;subTask2&quot;).list();</span>
<span class="nc" id="L886">        assertThat(tasks).hasSize(3);</span>
<span class="nc" id="L887">        tasks.forEach(t -&gt; taskService.complete(t.getId()));</span>

<span class="nc" id="L889">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L890">        assertThat(totalChildExecutions).isEqualTo(1);</span>

<span class="nc" id="L892">        task = taskService.createTaskQuery().active().singleResult();</span>
<span class="nc" id="L893">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;lastTask&quot;);</span>
<span class="nc" id="L894">        taskService.complete(task.getId());</span>

<span class="nc" id="L896">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L897">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/multiInstanceNestedParallelSubProcesses.bpmn20.xml&quot;)
    public void testSetCurrentMultiInstanceNestedSubProcessParentActivityWithinSubProcess() {
<span class="nc" id="L902">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;parallelNestedMultiInstanceSubProcesses&quot;).start();</span>

<span class="nc" id="L904">        long totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L905">        assertThat(totalChildExecutions).isEqualTo(7);</span>
<span class="nc" id="L906">        long parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L907">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L908">        List&lt;Execution&gt; subTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask1&quot;).list();</span>
<span class="nc" id="L909">        assertThat(subTask1Executions).hasSize(3);</span>

        //Start the nested subProcesses by completing the first task of the outer subProcess
<span class="nc" id="L912">        List&lt;Task&gt; tasks = taskService.createTaskQuery().taskDefinitionKey(&quot;subTask1&quot;).list();</span>
<span class="nc" id="L913">        assertThat(tasks).hasSize(3);</span>
<span class="nc" id="L914">        tasks.forEach(t -&gt; taskService.complete(t.getId()));</span>

        // 3 instances of the outerSubProcess and each have 3 instances of a nestedSubProcess, for a total of 9 nestedSubTask executions
        // 9 nestedSubProcess instances and 3 outerSubProcesses instances -&gt; 12 executions
        // 1 Parent execution for the outerSubProcess and 1 parent for each nestedSubProcess -&gt; 4 extra parent executions
        // Grand Total -&gt;
<span class="nc" id="L920">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L921">        assertThat(totalChildExecutions).isEqualTo(25);</span>
<span class="nc" id="L922">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L923">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L924">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelNestedSubProcess&quot;).count();</span>
<span class="nc" id="L925">        assertThat(parallelSubProcessCount).isEqualTo(9);</span>
<span class="nc" id="L926">        List&lt;Execution&gt; nestedSubTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask1&quot;).list();</span>
<span class="nc" id="L927">        assertThat(nestedSubTask1Executions).hasSize(9);</span>

        //Complete some of the Nested tasks
<span class="nc" id="L930">        taskService.complete(taskService.createTaskQuery().executionId(nestedSubTask1Executions.get(0).getId()).singleResult().getId());</span>
<span class="nc" id="L931">        taskService.complete(taskService.createTaskQuery().executionId(nestedSubTask1Executions.get(3).getId()).singleResult().getId());</span>
<span class="nc" id="L932">        taskService.complete(taskService.createTaskQuery().executionId(nestedSubTask1Executions.get(6).getId()).singleResult().getId());</span>

<span class="nc" id="L934">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L935">        assertThat(totalChildExecutions).isEqualTo(25);</span>
<span class="nc" id="L936">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L937">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L938">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelNestedSubProcess&quot;).count();</span>
<span class="nc" id="L939">        assertThat(parallelSubProcessCount).isEqualTo(9);</span>
<span class="nc" id="L940">        nestedSubTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask1&quot;).list();</span>
<span class="nc" id="L941">        assertThat(nestedSubTask1Executions).hasSize(6);</span>
<span class="nc" id="L942">        List&lt;Execution&gt; nestedSubTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask2&quot;).list();</span>
<span class="nc" id="L943">        assertThat(nestedSubTask2Executions).hasSize(3);</span>

        //Complete one of the nested subProcesses
<span class="nc" id="L946">        Task task = taskService.createTaskQuery().executionId(nestedSubTask2Executions.get(0).getId()).singleResult();</span>
<span class="nc" id="L947">        taskService.complete(task.getId());</span>

        //One less task execution and one less nested instance
<span class="nc" id="L950">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L951">        assertThat(totalChildExecutions).isEqualTo(24);</span>
<span class="nc" id="L952">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L953">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L954">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelNestedSubProcess&quot;).count();</span>
<span class="nc" id="L955">        assertThat(parallelSubProcessCount).isEqualTo(8);</span>
<span class="nc" id="L956">        nestedSubTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask1&quot;).list();</span>
<span class="nc" id="L957">        assertThat(nestedSubTask1Executions).hasSize(6);</span>
<span class="nc" id="L958">        nestedSubTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;nestedSubTask2&quot;).list();</span>
<span class="nc" id="L959">        assertThat(nestedSubTask2Executions).hasSize(2);</span>

        //Move the activity nested multiInstance parent
<span class="nc" id="L962">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L963">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L964">                .moveActivityIdTo(&quot;parallelNestedSubProcess&quot;, &quot;subTask2&quot;)</span>
<span class="nc" id="L965">                .changeState();</span>

        //Nested subProcesses have completed, only outer subProcess remain
<span class="nc" id="L968">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L969">        assertThat(totalChildExecutions).isEqualTo(7);</span>
<span class="nc" id="L970">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcessOuter&quot;).count();</span>
<span class="nc" id="L971">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L972">        List&lt;Execution&gt; subTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;subTask2&quot;).list();</span>
<span class="nc" id="L973">        assertThat(subTask2Executions).hasSize(3);</span>

        //Complete the outer subProcesses
<span class="nc" id="L976">        tasks = taskService.createTaskQuery().taskDefinitionKey(&quot;subTask2&quot;).list();</span>
<span class="nc" id="L977">        assertThat(tasks).hasSize(3);</span>
<span class="nc" id="L978">        tasks.forEach(t -&gt; taskService.complete(t.getId()));</span>

<span class="nc" id="L980">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L981">        assertThat(totalChildExecutions).isEqualTo(1);</span>

<span class="nc" id="L983">        task = taskService.createTaskQuery().active().singleResult();</span>
<span class="nc" id="L984">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;lastTask&quot;);</span>
<span class="nc" id="L985">        taskService.complete(task.getId());</span>

<span class="nc" id="L987">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L988">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/parallelGatewayInsideMultiInstanceSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivitiesUsingParallelGatewayNestedInMultiInstanceSubProcess() {
<span class="nc" id="L993">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;parallelGatewayInsideMultiInstanceSubProcess&quot;);</span>

<span class="nc" id="L995">        long totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L996">        assertThat(totalChildExecutions).isEqualTo(7);</span>
<span class="nc" id="L997">        long parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcess&quot;).count();</span>
<span class="nc" id="L998">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L999">        List&lt;Execution&gt; preForkTaskExecutions = runtimeService.createExecutionQuery().activityId(&quot;preForkTask&quot;).list();</span>
<span class="nc" id="L1000">        assertThat(preForkTaskExecutions).hasSize(3);</span>
<span class="nc" id="L1001">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1002">        assertThat(tasks).hasSize(3);</span>
<span class="nc" id="L1003">        assertThat(tasks.get(0).getTaskDefinitionKey()).isEqualTo(&quot;preForkTask&quot;);</span>

        //Move a task before the fork within the multiInstance subProcess
<span class="nc" id="L1006">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1007">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1008">                .moveSingleActivityIdToActivityIds(&quot;preForkTask&quot;, Arrays.asList(&quot;forkTask1&quot;, &quot;forkTask2&quot;))</span>
<span class="nc" id="L1009">                .changeState();</span>

<span class="nc" id="L1011">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L1012">        assertThat(totalChildExecutions).isEqualTo(10);</span>
<span class="nc" id="L1013">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcess&quot;).count();</span>
<span class="nc" id="L1014">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L1015">        List&lt;Execution&gt; forkTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;forkTask1&quot;).list();</span>
<span class="nc" id="L1016">        assertThat(forkTask1Executions).hasSize(3);</span>
<span class="nc" id="L1017">        List&lt;Execution&gt; forkTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;forkTask2&quot;).list();</span>
<span class="nc" id="L1018">        assertThat(forkTask2Executions).hasSize(3);</span>
<span class="nc" id="L1019">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1020">        assertThat(tasks).hasSize(6);</span>
<span class="nc" id="L1021">        Map&lt;String, List&lt;Task&gt;&gt; taskGroups = tasks.stream().collect(Collectors.groupingBy(Task::getTaskDefinitionKey));</span>
<span class="nc" id="L1022">        assertThat(taskGroups)</span>
<span class="nc" id="L1023">                .containsOnlyKeys(&quot;forkTask1&quot;, &quot;forkTask2&quot;);</span>
<span class="nc" id="L1024">        assertThat(taskGroups.get(&quot;forkTask1&quot;)).hasSize(3);</span>
<span class="nc" id="L1025">        assertThat(taskGroups.get(&quot;forkTask2&quot;)).hasSize(3);</span>

        //Move the parallel gateway task forward
<span class="nc" id="L1028">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1029">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1030">                .moveActivityIdsToSingleActivityId(Arrays.asList(&quot;forkTask1&quot;, &quot;forkTask2&quot;), &quot;parallelJoin&quot;)</span>
<span class="nc" id="L1031">                .changeState();</span>

<span class="nc" id="L1033">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L1034">        assertThat(totalChildExecutions).isEqualTo(7);</span>
<span class="nc" id="L1035">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcess&quot;).count();</span>
<span class="nc" id="L1036">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L1037">        List&lt;Execution&gt; postForkTaskExecutions = runtimeService.createExecutionQuery().activityId(&quot;postForkTask&quot;).list();</span>
<span class="nc" id="L1038">        assertThat(postForkTaskExecutions).hasSize(3);</span>
<span class="nc" id="L1039">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1040">        assertThat(tasks).hasSize(3);</span>
<span class="nc" id="L1041">        tasks.forEach(t -&gt; assertThat(t.getTaskDefinitionKey()).isEqualTo(&quot;postForkTask&quot;));</span>

        //Complete one of the tasks
<span class="nc" id="L1044">        taskService.complete(tasks.get(1).getId());</span>

<span class="nc" id="L1046">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L1047">        assertThat(totalChildExecutions).isEqualTo(6);</span>
<span class="nc" id="L1048">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcess&quot;).count();</span>
<span class="nc" id="L1049">        assertThat(parallelSubProcessCount).isEqualTo(2);</span>
<span class="nc" id="L1050">        postForkTaskExecutions = runtimeService.createExecutionQuery().activityId(&quot;postForkTask&quot;).list();</span>
<span class="nc" id="L1051">        assertThat(postForkTaskExecutions).hasSize(2);</span>
<span class="nc" id="L1052">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1053">        assertThat(tasks).hasSize(2);</span>
<span class="nc" id="L1054">        tasks.forEach(t -&gt; assertThat(t.getTaskDefinitionKey()).isEqualTo(&quot;postForkTask&quot;));</span>

        //Finish the rest since we cannot move out of a multiInstance subProcess
<span class="nc" id="L1057">        tasks.forEach(t -&gt; taskService.complete(t.getId()));</span>

<span class="nc" id="L1059">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L1060">        assertThat(totalChildExecutions).isEqualTo(1);</span>
<span class="nc" id="L1061">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1062">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;lastTask&quot;);</span>

<span class="nc" id="L1064">        taskService.complete(task.getId());</span>

<span class="nc" id="L1066">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1067">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/parallelGatewayInsideMultiInstanceSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentExecutionsUsingParallelGatewayNestedInMultiInstanceSubProcess() {
<span class="nc" id="L1072">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;parallelGatewayInsideMultiInstanceSubProcess&quot;);</span>

<span class="nc" id="L1074">        long totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L1075">        assertThat(totalChildExecutions).isEqualTo(7);</span>
<span class="nc" id="L1076">        long parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcess&quot;).count();</span>
<span class="nc" id="L1077">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L1078">        List&lt;Execution&gt; preForkTaskExecutions = runtimeService.createExecutionQuery().activityId(&quot;preForkTask&quot;).list();</span>
<span class="nc" id="L1079">        assertThat(preForkTaskExecutions).hasSize(3);</span>
<span class="nc" id="L1080">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1081">        assertThat(tasks).hasSize(3);</span>
<span class="nc" id="L1082">        assertThat(tasks.get(0).getTaskDefinitionKey()).isEqualTo(&quot;preForkTask&quot;);</span>

        //Move a task before the fork within the multiInstance subProcess
<span class="nc" id="L1085">        preForkTaskExecutions.forEach(e -&gt; runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1086">                .moveSingleExecutionToActivityIds(e.getId(), Arrays.asList(&quot;forkTask1&quot;, &quot;forkTask2&quot;))</span>
<span class="nc" id="L1087">                .changeState());</span>

<span class="nc" id="L1089">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L1090">        assertThat(totalChildExecutions).isEqualTo(10);</span>
<span class="nc" id="L1091">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcess&quot;).count();</span>
<span class="nc" id="L1092">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L1093">        List&lt;Execution&gt; forkTask1Executions = runtimeService.createExecutionQuery().activityId(&quot;forkTask1&quot;).list();</span>
<span class="nc" id="L1094">        assertThat(forkTask1Executions).hasSize(3);</span>
<span class="nc" id="L1095">        List&lt;Execution&gt; forkTask2Executions = runtimeService.createExecutionQuery().activityId(&quot;forkTask2&quot;).list();</span>
<span class="nc" id="L1096">        assertThat(forkTask2Executions).hasSize(3);</span>
<span class="nc" id="L1097">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1098">        assertThat(tasks).hasSize(6);</span>
<span class="nc" id="L1099">        Map&lt;String, List&lt;Task&gt;&gt; taskGroups = tasks.stream().collect(Collectors.groupingBy(Task::getTaskDefinitionKey));</span>
<span class="nc" id="L1100">        assertThat(taskGroups)</span>
<span class="nc" id="L1101">                .containsOnlyKeys(&quot;forkTask1&quot;, &quot;forkTask2&quot;);</span>
<span class="nc" id="L1102">        assertThat(taskGroups.get(&quot;forkTask1&quot;)).hasSize(3);</span>
<span class="nc" id="L1103">        assertThat(taskGroups.get(&quot;forkTask2&quot;)).hasSize(3);</span>

        //Move the parallel gateway task forward
<span class="nc" id="L1106">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1107">                .moveExecutionsToSingleActivityId(</span>
<span class="nc" id="L1108">                        Stream.concat(forkTask1Executions.stream().map(Execution::getId), forkTask2Executions.stream().map(Execution::getId))</span>
<span class="nc" id="L1109">                                .collect(Collectors.toList()), &quot;postForkTask&quot;)</span>
<span class="nc" id="L1110">                .changeState();</span>

<span class="nc" id="L1112">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L1113">        assertThat(totalChildExecutions).isEqualTo(7);</span>
<span class="nc" id="L1114">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcess&quot;).count();</span>
<span class="nc" id="L1115">        assertThat(parallelSubProcessCount).isEqualTo(3);</span>
<span class="nc" id="L1116">        List&lt;Execution&gt; postForkTaskExecutions = runtimeService.createExecutionQuery().activityId(&quot;postForkTask&quot;).list();</span>
<span class="nc" id="L1117">        assertThat(postForkTaskExecutions).hasSize(3);</span>
<span class="nc" id="L1118">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1119">        assertThat(tasks).hasSize(3);</span>
<span class="nc" id="L1120">        tasks.forEach(t -&gt; assertThat(t.getTaskDefinitionKey()).isEqualTo(&quot;postForkTask&quot;));</span>

        //Complete one of the tasks
<span class="nc" id="L1123">        taskService.complete(tasks.get(1).getId());</span>

<span class="nc" id="L1125">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L1126">        assertThat(totalChildExecutions).isEqualTo(6);</span>
<span class="nc" id="L1127">        parallelSubProcessCount = runtimeService.createExecutionQuery().activityId(&quot;parallelSubProcess&quot;).count();</span>
<span class="nc" id="L1128">        assertThat(parallelSubProcessCount).isEqualTo(2);</span>
<span class="nc" id="L1129">        postForkTaskExecutions = runtimeService.createExecutionQuery().activityId(&quot;postForkTask&quot;).list();</span>
<span class="nc" id="L1130">        assertThat(postForkTaskExecutions).hasSize(2);</span>
<span class="nc" id="L1131">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1132">        assertThat(tasks).hasSize(2);</span>
<span class="nc" id="L1133">        tasks.forEach(t -&gt; assertThat(t.getTaskDefinitionKey()).isEqualTo(&quot;postForkTask&quot;));</span>

        //Finish the rest since we cannot move out of a multiInstance subProcess
<span class="nc" id="L1136">        tasks.forEach(t -&gt; taskService.complete(t.getId()));</span>

<span class="nc" id="L1138">        totalChildExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().count();</span>
<span class="nc" id="L1139">        assertThat(totalChildExecutions).isEqualTo(1);</span>
<span class="nc" id="L1140">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1141">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;lastTask&quot;);</span>

<span class="nc" id="L1143">        taskService.complete(task.getId());</span>

<span class="nc" id="L1145">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1146">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/inclusiveGatewayNestedInsideMultiInstanceSubProcess.bpmn20.xml&quot; })
    public void testCompleteSetCurrentActivitiesUsingInclusiveGatewayNestedInMultiInstanceSubProcess() {
<span class="nc" id="L1151">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;inclusiveGatewayInsideMultiInstanceSubProcess&quot;);</span>

        //1x MI subProc root, 3x parallel MI subProc, 9x Task executions (3 tasks per Gw path)
<span class="nc" id="L1154">        List&lt;Execution&gt; childExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1155">        assertThat(childExecutions).hasSize(13);</span>
<span class="nc" id="L1156">        Map&lt;String, List&lt;Execution&gt;&gt; classifiedExecutions = groupListContentBy(childExecutions, Execution::getActivityId);</span>
<span class="nc" id="L1157">        assertThat(classifiedExecutions).containsKey(&quot;parallelSubProcess&quot;);</span>
<span class="nc" id="L1158">        assertThat(classifiedExecutions.get(&quot;parallelSubProcess&quot;)).hasSize(4);</span>
<span class="nc" id="L1159">        assertThat(classifiedExecutions).containsKey(&quot;taskInclusive1&quot;);</span>
<span class="nc" id="L1160">        assertThat(classifiedExecutions.get(&quot;taskInclusive1&quot;)).hasSize(3);</span>
<span class="nc" id="L1161">        assertThat(classifiedExecutions).containsKey(&quot;taskInclusive2&quot;);</span>
<span class="nc" id="L1162">        assertThat(classifiedExecutions.get(&quot;taskInclusive2&quot;)).hasSize(3);</span>
<span class="nc" id="L1163">        assertThat(classifiedExecutions).containsKey(&quot;taskInclusive3&quot;);</span>
<span class="nc" id="L1164">        assertThat(classifiedExecutions.get(&quot;taskInclusive3&quot;)).hasSize(3);</span>

<span class="nc" id="L1166">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1167">        Map&lt;String, List&lt;Task&gt;&gt; classifiedTasks = tasks.stream().collect(Collectors.groupingBy(Task::getTaskDefinitionKey));</span>
<span class="nc" id="L1168">        assertThat(classifiedTasks)</span>
<span class="nc" id="L1169">                .containsOnlyKeys(&quot;taskInclusive1&quot;, &quot;taskInclusive2&quot;, &quot;taskInclusive3&quot;);</span>

        //Move all activities
<span class="nc" id="L1172">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1173">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1174">                .moveActivityIdsToSingleActivityId(Arrays.asList(&quot;taskInclusive1&quot;, &quot;taskInclusive2&quot;, &quot;taskInclusive3&quot;), &quot;inclusiveJoin&quot;)</span>
<span class="nc" id="L1175">                .changeState();</span>

        //Still 3 subProcesses running, all of them past the gateway fork/join
<span class="nc" id="L1178">        childExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1179">        assertThat(childExecutions).hasSize(7);</span>
<span class="nc" id="L1180">        classifiedExecutions = groupListContentBy(childExecutions, Execution::getActivityId);</span>
<span class="nc" id="L1181">        assertThat(classifiedExecutions).containsKeys(&quot;parallelSubProcess&quot;, &quot;postForkTask&quot;);</span>
<span class="nc" id="L1182">        assertThat(classifiedExecutions.get(&quot;parallelSubProcess&quot;)).hasSize(4);</span>
<span class="nc" id="L1183">        assertThat(classifiedExecutions.get(&quot;postForkTask&quot;)).hasSize(3);</span>

<span class="nc" id="L1185">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1186">        assertThat(tasks).hasSize(3);</span>
<span class="nc" id="L1187">        tasks.forEach(t -&gt; assertThat(t.getTaskDefinitionKey()).isEqualTo(&quot;postForkTask&quot;));</span>

        //Finish the remaining subProcesses tasks
<span class="nc" id="L1190">        tasks.forEach(t -&gt; taskService.complete(t.getId()));</span>

        //Only one execution and task remaining
<span class="nc" id="L1193">        childExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1194">        assertThat(childExecutions).hasSize(1);</span>
<span class="nc" id="L1195">        assertThat(childExecutions.get(0).getActivityId()).isEqualTo(&quot;lastTask&quot;);</span>
<span class="nc" id="L1196">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1197">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;lastTask&quot;);</span>

        //Complete the process
<span class="nc" id="L1200">        taskService.complete(task.getId());</span>
<span class="nc" id="L1201">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1202">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/inclusiveGatewayNestedInsideMultiInstanceSubProcess.bpmn20.xml&quot; })
    public void testCompleteSetCurrentExecutionsUsingInclusiveGatewayNestedInMultiInstanceSubProcess() {
<span class="nc" id="L1207">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;inclusiveGatewayInsideMultiInstanceSubProcess&quot;);</span>

        //1x MI subProc root, 3x parallel MI subProc, 9x Task executions (3 tasks per Gw path)
<span class="nc" id="L1210">        List&lt;Execution&gt; childExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1211">        assertThat(childExecutions).hasSize(13);</span>
<span class="nc" id="L1212">        Map&lt;String, List&lt;Execution&gt;&gt; classifiedExecutions = groupListContentBy(childExecutions, Execution::getActivityId);</span>
<span class="nc" id="L1213">        assertThat(classifiedExecutions).containsKeys(&quot;parallelSubProcess&quot;, &quot;taskInclusive1&quot;, &quot;taskInclusive2&quot;, &quot;taskInclusive3&quot;);</span>
<span class="nc" id="L1214">        assertThat(classifiedExecutions.get(&quot;parallelSubProcess&quot;)).hasSize(4);</span>
<span class="nc" id="L1215">        assertThat(classifiedExecutions.get(&quot;taskInclusive1&quot;)).hasSize(3);</span>
<span class="nc" id="L1216">        assertThat(classifiedExecutions.get(&quot;taskInclusive2&quot;)).hasSize(3);</span>
<span class="nc" id="L1217">        assertThat(classifiedExecutions.get(&quot;taskInclusive3&quot;)).hasSize(3);</span>

<span class="nc" id="L1219">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1220">        Map&lt;String, List&lt;Task&gt;&gt; classifiedTasks = tasks.stream().collect(Collectors.groupingBy(Task::getTaskDefinitionKey));</span>
<span class="nc" id="L1221">        assertThat(classifiedTasks)</span>
<span class="nc" id="L1222">                .containsOnlyKeys(&quot;taskInclusive1&quot;, &quot;taskInclusive2&quot;, &quot;taskInclusive3&quot;);</span>

        //Finish one activity in two MI subProcesses
<span class="nc" id="L1225">        taskService.complete(classifiedTasks.get(&quot;taskInclusive1&quot;).get(1).getId());</span>
<span class="nc" id="L1226">        taskService.complete(classifiedTasks.get(&quot;taskInclusive2&quot;).get(2).getId());</span>

        //1x MI subProc root, 3x parallel MI subProc, 7x Gw Task executions, 2x Gw join executions
<span class="nc" id="L1229">        childExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1230">        assertThat(childExecutions).hasSize(13);</span>
<span class="nc" id="L1231">        classifiedExecutions = groupListContentBy(childExecutions, Execution::getActivityId);</span>
<span class="nc" id="L1232">        assertThat(classifiedExecutions).containsKeys(&quot;parallelSubProcess&quot;, &quot;taskInclusive1&quot;, &quot;taskInclusive2&quot;, &quot;taskInclusive3&quot;, &quot;inclusiveJoin&quot;);</span>
<span class="nc" id="L1233">        assertThat(classifiedExecutions.get(&quot;parallelSubProcess&quot;)).hasSize(4);</span>
<span class="nc" id="L1234">        assertThat(classifiedExecutions.get(&quot;taskInclusive1&quot;)).hasSize(2);</span>
<span class="nc" id="L1235">        assertThat(classifiedExecutions.get(&quot;taskInclusive2&quot;)).hasSize(2);</span>
<span class="nc" id="L1236">        assertThat(classifiedExecutions.get(&quot;taskInclusive3&quot;)).hasSize(3);</span>
<span class="nc" id="L1237">        assertThat(classifiedExecutions.get(&quot;inclusiveJoin&quot;)).hasSize(2);</span>

<span class="nc" id="L1239">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1240">        classifiedTasks = tasks.stream().collect(Collectors.groupingBy(Task::getTaskDefinitionKey));</span>
<span class="nc" id="L1241">        assertThat(classifiedTasks).hasSize(3);</span>
<span class="nc" id="L1242">        assertThat(classifiedExecutions).containsKeys(&quot;taskInclusive1&quot;, &quot;taskInclusive2&quot;, &quot;taskInclusive3&quot;);</span>
<span class="nc" id="L1243">        assertThat(classifiedExecutions.get(&quot;taskInclusive1&quot;)).hasSize(2);</span>
<span class="nc" id="L1244">        assertThat(classifiedExecutions.get(&quot;taskInclusive2&quot;)).hasSize(2);</span>
<span class="nc" id="L1245">        assertThat(classifiedExecutions.get(&quot;taskInclusive3&quot;)).hasSize(3);</span>

        //TEST 1 (move all)... change state of &quot;all&quot; executions in a gateway at once
        //Move the executions of the gateway that still contains 3 tasks in execution
<span class="nc" id="L1249">        Stream&lt;Execution&gt; tempStream = Stream.concat(classifiedExecutions.get(&quot;taskInclusive1&quot;).stream(), classifiedExecutions.get(&quot;taskInclusive2&quot;).stream());</span>
<span class="nc" id="L1250">        Map&lt;String, List&lt;Execution&gt;&gt; taskExecutionsByParent = Stream.concat(tempStream, classifiedExecutions.get(&quot;taskInclusive3&quot;).stream())</span>
<span class="nc" id="L1251">                .collect(Collectors.groupingBy(Execution::getParentId));</span>

<span class="nc" id="L1253">        List&lt;String&gt; ids = taskExecutionsByParent.values().stream()</span>
<span class="nc bnc" id="L1254" title="All 2 branches missed.">                .filter(l -&gt; l.size() == 3)</span>
<span class="nc" id="L1255">                .findFirst().orElseGet(ArrayList::new)</span>
<span class="nc" id="L1256">                .stream().map(Execution::getId)</span>
<span class="nc" id="L1257">                .collect(Collectors.toList());</span>

        //Move into the synchronizing gateway
<span class="nc" id="L1260">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1261">                .moveExecutionsToSingleActivityId(ids, &quot;inclusiveJoin&quot;)</span>
<span class="nc" id="L1262">                .changeState();</span>

        //There'll be still 3 subProcesses running, 2 with &quot;gateways&quot; still in execution, one with task3 &amp; task1 &amp; join, one with task3, task2 and join
        // the 3rd subProcess should be past the gateway fork/join
<span class="nc" id="L1266">        childExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1267">        assertThat(childExecutions).hasSize(11);</span>
<span class="nc" id="L1268">        classifiedExecutions = groupListContentBy(childExecutions, Execution::getActivityId);</span>
<span class="nc" id="L1269">        assertThat(classifiedExecutions)</span>
<span class="nc" id="L1270">                .containsKeys(&quot;parallelSubProcess&quot;, &quot;taskInclusive1&quot;, &quot;taskInclusive2&quot;, &quot;taskInclusive3&quot;, &quot;inclusiveJoin&quot;, &quot;postForkTask&quot;);</span>
<span class="nc" id="L1271">        assertThat(classifiedExecutions.get(&quot;parallelSubProcess&quot;)).hasSize(4);</span>
<span class="nc" id="L1272">        assertThat(classifiedExecutions.get(&quot;taskInclusive1&quot;)).hasSize(1);</span>
<span class="nc" id="L1273">        assertThat(classifiedExecutions.get(&quot;taskInclusive2&quot;)).hasSize(1);</span>
<span class="nc" id="L1274">        assertThat(classifiedExecutions.get(&quot;taskInclusive3&quot;)).hasSize(2);</span>
<span class="nc" id="L1275">        assertThat(classifiedExecutions.get(&quot;inclusiveJoin&quot;)).hasSize(2);</span>
<span class="nc" id="L1276">        assertThat(classifiedExecutions.get(&quot;postForkTask&quot;)).hasSize(1);</span>

<span class="nc" id="L1278">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1279">        classifiedTasks = tasks.stream().collect(Collectors.groupingBy(Task::getTaskDefinitionKey));</span>
<span class="nc" id="L1280">        assertThat(classifiedTasks).containsOnlyKeys(&quot;taskInclusive1&quot;, &quot;taskInclusive2&quot;, &quot;taskInclusive3&quot;, &quot;postForkTask&quot;);</span>
<span class="nc" id="L1281">        assertThat(classifiedTasks.get(&quot;taskInclusive1&quot;)).hasSize(1);</span>
<span class="nc" id="L1282">        assertThat(classifiedTasks.get(&quot;taskInclusive2&quot;)).hasSize(1);</span>
<span class="nc" id="L1283">        assertThat(classifiedTasks.get(&quot;taskInclusive3&quot;)).hasSize(2);</span>
<span class="nc" id="L1284">        assertThat(classifiedTasks.get(&quot;postForkTask&quot;)).hasSize(1);</span>

        //TEST 2 (complete last execution)... complete the last execution of a gateway were a task execution was already moved into the synchronizing join
<span class="nc" id="L1287">        ids = classifiedExecutions.get(&quot;taskInclusive1&quot;).stream().map(Execution::getId).collect(Collectors.toList());</span>
        //Move into the synchronizing gateway
<span class="nc" id="L1289">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1290">                .moveExecutionsToSingleActivityId(ids, &quot;inclusiveJoin&quot;)</span>
<span class="nc" id="L1291">                .changeState();</span>

        //Complete remaining task3, the next inline test needs the task to be completed too
<span class="nc bnc" id="L1294" title="All 2 branches missed.">        for (Task t : tasks) {</span>
<span class="nc bnc" id="L1295" title="All 2 branches missed.">            if (&quot;taskInclusive3&quot;.equals(t.getTaskDefinitionKey())) {</span>
<span class="nc" id="L1296">                taskService.complete(t.getId());</span>
            }
<span class="nc" id="L1298">        }</span>

        //Still 3 subProcesses running, two of them past the gateway fork/join and the remaining one with a task2 pending
<span class="nc" id="L1301">        childExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1302">        assertThat(childExecutions).hasSize(9);</span>
<span class="nc" id="L1303">        classifiedExecutions = groupListContentBy(childExecutions, Execution::getActivityId);</span>
<span class="nc" id="L1304">        assertThat(classifiedExecutions).containsKeys(&quot;parallelSubProcess&quot;, &quot;postForkTask&quot;, &quot;inclusiveJoin&quot;, &quot;taskInclusive2&quot;);</span>
<span class="nc" id="L1305">        assertThat(classifiedExecutions.get(&quot;parallelSubProcess&quot;)).hasSize(4);</span>
<span class="nc" id="L1306">        assertThat(classifiedExecutions.get(&quot;postForkTask&quot;)).hasSize(2);</span>
<span class="nc" id="L1307">        assertThat(classifiedExecutions.get(&quot;inclusiveJoin&quot;)).hasSize(2);</span>
<span class="nc" id="L1308">        assertThat(classifiedExecutions.get(&quot;taskInclusive2&quot;)).hasSize(1);</span>

<span class="nc" id="L1310">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1311">        classifiedTasks = tasks.stream().collect(Collectors.groupingBy(Task::getTaskDefinitionKey));</span>
<span class="nc" id="L1312">        assertThat(classifiedTasks)</span>
<span class="nc" id="L1313">                .containsOnlyKeys(&quot;postForkTask&quot;, &quot;taskInclusive2&quot;);</span>
<span class="nc" id="L1314">        assertThat(classifiedTasks.get(&quot;postForkTask&quot;)).hasSize(2);</span>
<span class="nc" id="L1315">        assertThat(classifiedTasks.get(&quot;taskInclusive2&quot;)).hasSize(1);</span>

        //TEST 3 (move last execution)... move the remaining execution of a gateway with previously completed executions into the synchronizing join
<span class="nc" id="L1318">        ids = classifiedExecutions.get(&quot;taskInclusive2&quot;).stream().map(Execution::getId).collect(Collectors.toList());</span>
        //Move into the synchronizing gateway
<span class="nc" id="L1320">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1321">                .moveExecutionsToSingleActivityId(ids, &quot;inclusiveJoin&quot;)</span>
<span class="nc" id="L1322">                .changeState();</span>

        //Still 3 subProcesses running, all of them past the gateway fork/join
<span class="nc" id="L1325">        childExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1326">        assertThat(childExecutions).hasSize(7);</span>
<span class="nc" id="L1327">        classifiedExecutions = groupListContentBy(childExecutions, Execution::getActivityId);</span>
<span class="nc" id="L1328">        assertThat(classifiedExecutions).containsKeys(&quot;parallelSubProcess&quot;, &quot;postForkTask&quot;);</span>
<span class="nc" id="L1329">        assertThat(classifiedExecutions.get(&quot;parallelSubProcess&quot;)).hasSize(4);</span>
<span class="nc" id="L1330">        assertThat(classifiedExecutions.get(&quot;postForkTask&quot;)).hasSize(3);</span>

<span class="nc" id="L1332">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1333">        assertThat(tasks).hasSize(3);</span>
<span class="nc" id="L1334">        tasks.forEach(t -&gt; assertThat(t.getTaskDefinitionKey()).isEqualTo(&quot;postForkTask&quot;));</span>

        //Finish the remaining subProcesses tasks
<span class="nc" id="L1337">        tasks.forEach(t -&gt; taskService.complete(t.getId()));</span>

        //Only one execution and task remaining
<span class="nc" id="L1340">        childExecutions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1341">        assertThat(childExecutions).hasSize(1);</span>
<span class="nc" id="L1342">        assertThat(childExecutions.get(0).getActivityId()).isEqualTo(&quot;lastTask&quot;);</span>
<span class="nc" id="L1343">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1344">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;lastTask&quot;);</span>

        //Complete the process
<span class="nc" id="L1347">        taskService.complete(task.getId());</span>
<span class="nc" id="L1348">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1349">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>