<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ChangeStateForGatewaysTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.runtime.changestate</a> &gt; <span class="el_source">ChangeStateForGatewaysTest.java</span></div><h1>ChangeStateForGatewaysTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.engine.test.api.runtime.changestate;

import static org.assertj.core.api.Assertions.assertThat;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.stream.Collectors;

import org.flowable.common.engine.api.delegate.event.FlowableEngineEventType;
import org.flowable.common.engine.api.delegate.event.FlowableEvent;
import org.flowable.engine.delegate.event.FlowableActivityEvent;
import org.flowable.engine.impl.persistence.entity.ExecutionEntity;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.runtime.Execution;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.task.api.Task;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

/**
 * @author Frederik Heremans
 * @author Joram Barrez
 * @author Dennis Federico
 */
<span class="nc" id="L46">public class ChangeStateForGatewaysTest extends PluggableFlowableTestCase {</span>

<span class="nc" id="L48">    private ChangeStateEventListener changeStateEventListener = new ChangeStateEventListener();</span>

    @BeforeEach
    protected void setUp() {
<span class="nc" id="L52">        processEngine.getRuntimeService().addEventListener(changeStateEventListener);</span>
<span class="nc" id="L53">    }</span>

    @AfterEach
    protected void tearDown() {
<span class="nc" id="L57">        processEngine.getRuntimeService().removeEventListener(changeStateEventListener);</span>
<span class="nc" id="L58">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/parallelTask.bpmn20.xml&quot; })
    public void testSetCurrentActivityToMultipleActivitiesForParallelGateway() {
<span class="nc" id="L63">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startParallelProcess&quot;);</span>
<span class="nc" id="L64">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L65">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L67">        List&lt;String&gt; newActivityIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L68">        newActivityIds.add(&quot;task1&quot;);</span>
<span class="nc" id="L69">        newActivityIds.add(&quot;task2&quot;);</span>

<span class="nc" id="L71">        changeStateEventListener.clear();</span>

<span class="nc" id="L73">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L74">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L75">                .moveSingleActivityIdToActivityIds(&quot;taskBefore&quot;, newActivityIds)</span>
<span class="nc" id="L76">                .changeState();</span>

<span class="nc" id="L78">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L79">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L81">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L82">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L83">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L84">        assertThat(executionsByActivity)</span>
<span class="nc" id="L85">                .containsKeys(&quot;task1&quot;, &quot;task2&quot;)</span>
<span class="nc" id="L86">                .doesNotContainKey(&quot;parallelJoin&quot;);</span>

        //Complete one task1
<span class="nc" id="L89">        Optional&lt;Task&gt; task1 = tasks.stream().filter(t -&gt; &quot;task1&quot;.equals(t.getTaskDefinitionKey())).findFirst();</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (task1.isPresent()) {</span>
<span class="nc" id="L91">            taskService.complete(task1.get().getId());</span>
        }

        // Verify events
<span class="nc" id="L95">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L96">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L98">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L99">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L100">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L102">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L103">        event = iterator.next();</span>
<span class="nc" id="L104">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L105">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;task1&quot;);</span>

<span class="nc" id="L107">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L108">        event = iterator.next();</span>
<span class="nc" id="L109">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L110">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;task2&quot;);</span>

<span class="nc" id="L112">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L114">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L115">        assertThat(tasks).hasSize(1);</span>

<span class="nc" id="L117">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L118">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L119">        executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L120">        assertThat(executionsByActivity)</span>
<span class="nc" id="L121">                .doesNotContainKey(&quot;task1&quot;)</span>
<span class="nc" id="L122">                .containsKeys(&quot;task2&quot;, &quot;parallelJoin&quot;);</span>

<span class="nc" id="L124">        assertThat(((ExecutionEntity) executionsByActivity.get(&quot;parallelJoin&quot;).get(0)).isActive()).isFalse();</span>

<span class="nc" id="L126">        taskService.complete(tasks.get(0).getId());</span>

<span class="nc" id="L128">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L129">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L130">        taskService.complete(task.getId());</span>

<span class="nc" id="L132">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L133">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/parallelTask.bpmn20.xml&quot; })
    public void testSetMultipleActivitiesToSingleActivityAfterParallelGateway() {
<span class="nc" id="L138">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startParallelProcess&quot;);</span>
<span class="nc" id="L139">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L140">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L142">        taskService.complete(task.getId());</span>

<span class="nc" id="L144">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L145">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L147">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L148">        assertThat(executions).hasSize(2);</span>

<span class="nc" id="L150">        List&lt;String&gt; currentActivityIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L151">        currentActivityIds.add(&quot;task1&quot;);</span>
<span class="nc" id="L152">        currentActivityIds.add(&quot;task2&quot;);</span>

<span class="nc" id="L154">        changeStateEventListener.clear();</span>

<span class="nc" id="L156">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L157">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L158">                .moveActivityIdsToSingleActivityId(currentActivityIds, &quot;taskAfter&quot;)</span>
<span class="nc" id="L159">                .changeState();</span>

        // Verify events
<span class="nc" id="L162">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L163">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L165">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L166">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L167">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;task1&quot;);</span>

<span class="nc" id="L169">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L170">        event = iterator.next();</span>
<span class="nc" id="L171">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L172">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;task2&quot;);</span>

<span class="nc" id="L174">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L175">        event = iterator.next();</span>
<span class="nc" id="L176">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L177">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L179">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L181">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

<span class="nc" id="L183">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L184">        assertThat(executions).hasSize(1);</span>

<span class="nc" id="L186">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L187">        taskService.complete(task.getId());</span>

<span class="nc" id="L189">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L190">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/parallelTask.bpmn20.xml&quot; })
    public void testSetMultipleActivitiesIntoSynchronizingParallelGateway() {

        //Move all parallelGateway activities to the synchronizing gateway
<span class="nc" id="L197">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startParallelProcess&quot;);</span>
<span class="nc" id="L198">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L199">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L201">        taskService.complete(task.getId());</span>

<span class="nc" id="L203">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L204">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L205">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L206">        assertThat(executionsByActivity).containsOnlyKeys(&quot;task1&quot;, &quot;task2&quot;);</span>

<span class="nc" id="L208">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L209">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L211">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L212">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L213">                .moveActivityIdsToSingleActivityId(Arrays.asList(&quot;task1&quot;, &quot;task2&quot;), &quot;parallelJoin&quot;)</span>
<span class="nc" id="L214">                .changeState();</span>

<span class="nc" id="L216">        Execution execution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().singleResult();</span>
<span class="nc" id="L217">        assertThat(execution.getActivityId()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L219">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L220">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L222">        taskService.complete(task.getId());</span>
<span class="nc" id="L223">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L224">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/parallelTask.bpmn20.xml&quot; })
    public void testSetMultipleGatewayActivitiesAndSynchronizingParallelGatewayAfterGateway() {

        //Move all parallelGateway activities to the synchronizing gateway
<span class="nc" id="L231">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startParallelProcess&quot;);</span>
<span class="nc" id="L232">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L233">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L235">        taskService.complete(task.getId());</span>

<span class="nc" id="L237">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L238">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L239">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L240">        assertThat(executionsByActivity).containsKeys(&quot;task1&quot;, &quot;task2&quot;);</span>

<span class="nc" id="L242">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L243">        assertThat(tasks).hasSize(2);</span>

        //Complete task1
<span class="nc bnc" id="L246" title="All 2 branches missed.">        for (Task t : tasks) {</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">            if (&quot;task1&quot;.equals(t.getTaskDefinitionKey())) {</span>
<span class="nc" id="L248">                taskService.complete(t.getId());</span>
            }
<span class="nc" id="L250">        }</span>

<span class="nc" id="L252">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L253">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L254">        Map&lt;String, List&lt;Execution&gt;&gt; classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L255">        assertThat(classifiedExecutions).containsKey(&quot;task2&quot;);</span>
<span class="nc" id="L256">        assertThat(classifiedExecutions.get(&quot;task2&quot;)).hasSize(1);</span>
<span class="nc" id="L257">        assertThat(classifiedExecutions).containsKey(&quot;parallelJoin&quot;);</span>
<span class="nc" id="L258">        assertThat(classifiedExecutions.get(&quot;parallelJoin&quot;)).hasSize(1);</span>

<span class="nc" id="L260">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L261">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L262">                .moveActivityIdsToSingleActivityId(Arrays.asList(&quot;task2&quot;, &quot;parallelJoin&quot;), &quot;taskAfter&quot;)</span>
<span class="nc" id="L263">                .changeState();</span>

<span class="nc" id="L265">        Execution execution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().singleResult();</span>
<span class="nc" id="L266">        assertThat(execution.getActivityId()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L268">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L269">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L271">        taskService.complete(task.getId());</span>
<span class="nc" id="L272">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L273">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/parallelTask.bpmn20.xml&quot; })
    public void testSetActivityIntoSynchronizingParallelGatewayFirst() {

        //Move one task to the synchronizing gateway, then complete the remaining task
<span class="nc" id="L280">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startParallelProcess&quot;);</span>
<span class="nc" id="L281">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L282">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L284">        taskService.complete(task.getId());</span>

<span class="nc" id="L286">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L287">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L289">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L290">        assertThat(executions).hasSize(2);</span>

<span class="nc" id="L292">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L293">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L294">                .moveActivityIdTo(&quot;task1&quot;, &quot;parallelJoin&quot;)</span>
<span class="nc" id="L295">                .changeState();</span>

<span class="nc" id="L297">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L298">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L299">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L300">        assertThat(executionsByActivity)</span>
<span class="nc" id="L301">                .doesNotContainKey(&quot;task1&quot;)</span>
<span class="nc" id="L302">                .containsKeys(&quot;task2&quot;, &quot;parallelJoin&quot;);</span>

<span class="nc" id="L304">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L305">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;task2&quot;);</span>

<span class="nc" id="L307">        taskService.complete(task.getId());</span>

<span class="nc" id="L309">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L310">        assertThat(executions).hasSize(1);</span>

<span class="nc" id="L312">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L313">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L315">        taskService.complete(task.getId());</span>
<span class="nc" id="L316">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L317">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/parallelTask.bpmn20.xml&quot; })
    public void testSetActivityIntoSynchronizingParallelGatewayLast() {

        //Complete one task and then move the last remaining task to the synchronizing gateway
<span class="nc" id="L324">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startParallelProcess&quot;);</span>
<span class="nc" id="L325">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L326">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L328">        taskService.complete(task.getId());</span>

<span class="nc" id="L330">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L331">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L333">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L334">        assertThat(executions).hasSize(2);</span>

        //Complete task1
<span class="nc" id="L337">        Optional&lt;Task&gt; task1 = tasks.stream().filter(t -&gt; &quot;task1&quot;.equals(t.getTaskDefinitionKey())).findFirst();</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (task1.isPresent()) {</span>
<span class="nc" id="L339">            taskService.complete(task1.get().getId());</span>
        }

<span class="nc" id="L342">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L343">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L344">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L345">        assertThat(executionsByActivity)</span>
<span class="nc" id="L346">                .doesNotContainKey(&quot;task1&quot;)</span>
<span class="nc" id="L347">                .containsKeys(&quot;task2&quot;, &quot;parallelJoin&quot;);</span>

<span class="nc" id="L349">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L350">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;task2&quot;);</span>

        //Move task2
<span class="nc" id="L353">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L354">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L355">                .moveActivityIdTo(&quot;task2&quot;, &quot;parallelJoin&quot;)</span>
<span class="nc" id="L356">                .changeState();</span>

<span class="nc" id="L358">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L359">        assertThat(executions).hasSize(1);</span>

<span class="nc" id="L361">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L362">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L364">        taskService.complete(task.getId());</span>
<span class="nc" id="L365">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L366">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/parallelTask.bpmn20.xml&quot; })
    public void testSetCurrentExecutionToMultipleActivitiesForParallelGateway() {
<span class="nc" id="L371">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startParallelProcess&quot;);</span>
<span class="nc" id="L372">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L373">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L375">        Execution taskBeforeExecution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().singleResult();</span>

<span class="nc" id="L377">        List&lt;String&gt; newActivityIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L378">        newActivityIds.add(&quot;task1&quot;);</span>
<span class="nc" id="L379">        newActivityIds.add(&quot;task2&quot;);</span>

<span class="nc" id="L381">        changeStateEventListener.clear();</span>

<span class="nc" id="L383">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L384">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L385">                .moveSingleExecutionToActivityIds(taskBeforeExecution.getId(), newActivityIds)</span>
<span class="nc" id="L386">                .changeState();</span>

<span class="nc" id="L388">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L389">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L391">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L392">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L393">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L394">        assertThat(executionsByActivity)</span>
<span class="nc" id="L395">                .containsKeys(&quot;task1&quot;, &quot;task2&quot;)</span>
<span class="nc" id="L396">                .doesNotContainKey(&quot;parallelJoin&quot;);</span>

        //Complete one task1
<span class="nc" id="L399">        Optional&lt;Task&gt; task1 = tasks.stream().filter(t -&gt; &quot;task1&quot;.equals(t.getTaskDefinitionKey())).findFirst();</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">        if (task1.isPresent()) {</span>
<span class="nc" id="L401">            taskService.complete(task1.get().getId());</span>
        }

<span class="nc" id="L404">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L405">        assertThat(tasks).hasSize(1);</span>

<span class="nc" id="L407">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L408">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L409">        executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L410">        assertThat(executionsByActivity)</span>
<span class="nc" id="L411">                .containsKeys(&quot;task2&quot;, &quot;parallelJoin&quot;)</span>
<span class="nc" id="L412">                .doesNotContainKey(&quot;task1&quot;);</span>

<span class="nc" id="L414">        assertThat(((ExecutionEntity) executionsByActivity.get(&quot;parallelJoin&quot;).get(0)).isActive()).isFalse();</span>

<span class="nc" id="L416">        taskService.complete(tasks.get(0).getId());</span>

<span class="nc" id="L418">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L419">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L420">        taskService.complete(task.getId());</span>

<span class="nc" id="L422">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L423">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/parallelTask.bpmn20.xml&quot; })
    public void testSetMultipleExecutionsToSingleActivityAfterParallelGateway() {
<span class="nc" id="L428">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startParallelProcess&quot;);</span>
<span class="nc" id="L429">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L430">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L432">        taskService.complete(task.getId());</span>

<span class="nc" id="L434">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L435">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L437">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L438">        assertThat(executions).hasSize(2);</span>

<span class="nc" id="L440">        List&lt;String&gt; currentExecutionIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L441">        currentExecutionIds.add(executions.get(0).getId());</span>
<span class="nc" id="L442">        currentExecutionIds.add(executions.get(1).getId());</span>
<span class="nc" id="L443">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L444">                .moveExecutionsToSingleActivityId(currentExecutionIds, &quot;taskAfter&quot;)</span>
<span class="nc" id="L445">                .changeState();</span>

<span class="nc" id="L447">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

<span class="nc" id="L449">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L450">        assertThat(executions).hasSize(1);</span>

<span class="nc" id="L452">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L453">        taskService.complete(task.getId());</span>

<span class="nc" id="L455">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L456">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/parallelTask.bpmn20.xml&quot; })
    public void testSetMultipleExecutionsIntoSynchronizingParallelGateway() {

        //Move all gateway executions to the synchronizing gateway
<span class="nc" id="L463">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startParallelProcess&quot;);</span>
<span class="nc" id="L464">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L465">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L467">        taskService.complete(task.getId());</span>

<span class="nc" id="L469">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L470">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L471">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L472">        assertThat(executionsByActivity).containsKeys(&quot;task1&quot;, &quot;task2&quot;);</span>

<span class="nc" id="L474">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L475">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L477">        List&lt;String&gt; executionIds = executions.stream().map(Execution::getId).collect(Collectors.toList());</span>

<span class="nc" id="L479">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L480">                .moveExecutionsToSingleActivityId(executionIds, &quot;parallelJoin&quot;)</span>
<span class="nc" id="L481">                .changeState();</span>

<span class="nc" id="L483">        Execution execution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().singleResult();</span>
<span class="nc" id="L484">        assertThat(execution.getActivityId()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L486">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L487">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L489">        taskService.complete(task.getId());</span>
<span class="nc" id="L490">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L491">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/parallelTask.bpmn20.xml&quot; })
    public void testSetMultipleGatewayExecutionsAndSynchronizingParallelGatewayAfterGateway() {

        //Move all gateway executions to the synchronizing gateway
<span class="nc" id="L498">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startParallelProcess&quot;);</span>
<span class="nc" id="L499">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L500">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L502">        taskService.complete(task.getId());</span>

<span class="nc" id="L504">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L505">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L506">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L507">        assertThat(executionsByActivity).containsKeys(&quot;task1&quot;, &quot;task2&quot;);</span>

<span class="nc" id="L509">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L510">        assertThat(tasks).hasSize(2);</span>

        //Complete task1
<span class="nc bnc" id="L513" title="All 2 branches missed.">        for (Task t : tasks) {</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">            if (&quot;task1&quot;.equals(t.getTaskDefinitionKey())) {</span>
<span class="nc" id="L515">                taskService.complete(t.getId());</span>
            }
<span class="nc" id="L517">        }</span>

<span class="nc" id="L519">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L520">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L521">        Map&lt;String, List&lt;Execution&gt;&gt; classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L522">        assertThat(classifiedExecutions).containsKey(&quot;task2&quot;);</span>
<span class="nc" id="L523">        assertThat(classifiedExecutions.get(&quot;task2&quot;)).hasSize(1);</span>
<span class="nc" id="L524">        assertThat(classifiedExecutions).containsKey(&quot;parallelJoin&quot;);</span>
<span class="nc" id="L525">        assertThat(classifiedExecutions.get(&quot;parallelJoin&quot;)).hasSize(1);</span>

<span class="nc" id="L527">        List&lt;String&gt; executionIds = executions.stream().map(Execution::getId).collect(Collectors.toList());</span>

<span class="nc" id="L529">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L530">                .moveExecutionsToSingleActivityId(executionIds, &quot;taskAfter&quot;)</span>
<span class="nc" id="L531">                .changeState();</span>

<span class="nc" id="L533">        Execution execution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().singleResult();</span>
<span class="nc" id="L534">        assertThat(execution.getActivityId()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L536">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L537">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L539">        taskService.complete(task.getId());</span>
<span class="nc" id="L540">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L541">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/parallelTask.bpmn20.xml&quot; })
    public void testSetExecutionIntoSynchronizingParallelGatewayFirst() {

        //Move one task to the synchronizing gateway, then complete the remaining task
<span class="nc" id="L548">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startParallelProcess&quot;);</span>
<span class="nc" id="L549">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L550">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L552">        taskService.complete(task.getId());</span>

<span class="nc" id="L554">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L555">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L557">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L558">        assertThat(executions).hasSize(2);</span>

<span class="nc" id="L560">        String executionId = executions.stream().filter(e -&gt; &quot;task1&quot;.equals(e.getActivityId())).findFirst().map(Execution::getId).get();</span>
<span class="nc" id="L561">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L562">                .moveExecutionToActivityId(executionId, &quot;parallelJoin&quot;)</span>
<span class="nc" id="L563">                .changeState();</span>

<span class="nc" id="L565">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L566">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L567">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L568">        assertThat(executionsByActivity)</span>
<span class="nc" id="L569">                .containsKeys(&quot;task2&quot;, &quot;parallelJoin&quot;)</span>
<span class="nc" id="L570">                .doesNotContainKey(&quot;task1&quot;);</span>

<span class="nc" id="L572">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L573">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;task2&quot;);</span>

<span class="nc" id="L575">        taskService.complete(task.getId());</span>

<span class="nc" id="L577">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L578">        assertThat(executions).hasSize(1);</span>

<span class="nc" id="L580">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L581">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L583">        taskService.complete(task.getId());</span>
<span class="nc" id="L584">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L585">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/parallelTask.bpmn20.xml&quot; })
    public void testSetExecutionIntoSynchronizingParallelGatewayLast() {

        //Complete one task and then move the last remaining task to the synchronizing gateway
<span class="nc" id="L592">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startParallelProcess&quot;);</span>
<span class="nc" id="L593">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L594">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L596">        taskService.complete(task.getId());</span>

<span class="nc" id="L598">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L599">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L601">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L602">        assertThat(executions).hasSize(2);</span>

        //Complete task1
<span class="nc" id="L605">        Optional&lt;Task&gt; task1 = tasks.stream().filter(t -&gt; &quot;task1&quot;.equals(t.getTaskDefinitionKey())).findFirst();</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">        if (task1.isPresent()) {</span>
<span class="nc" id="L607">            taskService.complete(task1.get().getId());</span>
        }

<span class="nc" id="L610">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L611">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L612">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L613">        assertThat(executionsByActivity)</span>
<span class="nc" id="L614">                .containsKeys(&quot;task2&quot;, &quot;parallelJoin&quot;)</span>
<span class="nc" id="L615">                .doesNotContainKey(&quot;task1&quot;);</span>

<span class="nc" id="L617">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L618">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;task2&quot;);</span>

        //Move task2 execution
<span class="nc" id="L621">        String executionId = executions.stream().filter(e -&gt; &quot;task2&quot;.equals(e.getActivityId())).findFirst().map(Execution::getId).get();</span>

<span class="nc" id="L623">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L624">                .moveExecutionToActivityId(executionId, &quot;parallelJoin&quot;)</span>
<span class="nc" id="L625">                .changeState();</span>

<span class="nc" id="L627">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L628">        assertThat(executions).hasSize(1);</span>

<span class="nc" id="L630">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L631">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L633">        taskService.complete(task.getId());</span>
<span class="nc" id="L634">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L635">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/inclusiveGatewayForkJoin.bpmn20.xml&quot; })
    public void testSetCurrentActivityToMultipleActivitiesForInclusiveGateway() {
<span class="nc" id="L640">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startInclusiveGwProcess&quot;);</span>
<span class="nc" id="L641">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L642">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L644">        List&lt;String&gt; newActivityIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L645">        newActivityIds.add(&quot;task1&quot;);</span>
<span class="nc" id="L646">        newActivityIds.add(&quot;task2&quot;);</span>

<span class="nc" id="L648">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L649">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L650">                .moveSingleActivityIdToActivityIds(&quot;taskBefore&quot;, newActivityIds)</span>
<span class="nc" id="L651">                .changeState();</span>

<span class="nc" id="L653">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L654">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L656">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L657">        assertThat(executions).hasSize(2);</span>

<span class="nc" id="L659">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L660">        assertThat(executionsByActivity).</span>
<span class="nc" id="L661">                containsKeys(&quot;task1&quot;, &quot;task2&quot;)</span>
<span class="nc" id="L662">                .doesNotContainKey(&quot;gwJoin&quot;);</span>

        //Complete one task1
<span class="nc" id="L665">        Optional&lt;Task&gt; task1 = tasks.stream().filter(t -&gt; &quot;task1&quot;.equals(t.getTaskDefinitionKey())).findFirst();</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">        if (task1.isPresent()) {</span>
<span class="nc" id="L667">            taskService.complete(task1.get().getId());</span>
        }

<span class="nc" id="L670">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L671">        assertThat(tasks).hasSize(1);</span>

<span class="nc" id="L673">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L674">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L675">        executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L676">        assertThat(executionsByActivity)</span>
<span class="nc" id="L677">                .containsKeys(&quot;task2&quot;, &quot;gwJoin&quot;)</span>
<span class="nc" id="L678">                .doesNotContainKey(&quot;task1&quot;);</span>

<span class="nc" id="L680">        assertThat(((ExecutionEntity) executionsByActivity.get(&quot;gwJoin&quot;).get(0)).isActive()).isFalse();</span>

<span class="nc" id="L682">        taskService.complete(tasks.get(0).getId());</span>

<span class="nc" id="L684">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L685">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L686">        taskService.complete(task.getId());</span>

<span class="nc" id="L688">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L689">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/inclusiveGatewayForkJoin.bpmn20.xml&quot; })
    public void testSetMultipleActivitiesToSingleActivityAfterInclusiveGateway() {
<span class="nc" id="L694">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startInclusiveGwProcess&quot;);</span>
<span class="nc" id="L695">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L696">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L698">        taskService.complete(task.getId());</span>

<span class="nc" id="L700">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L701">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L703">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L704">        assertThat(executions).hasSize(2);</span>

<span class="nc" id="L706">        List&lt;String&gt; currentActivityIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L707">        currentActivityIds.add(&quot;task1&quot;);</span>
<span class="nc" id="L708">        currentActivityIds.add(&quot;task2&quot;);</span>

<span class="nc" id="L710">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L711">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L712">                .moveActivityIdsToSingleActivityId(currentActivityIds, &quot;taskAfter&quot;)</span>
<span class="nc" id="L713">                .changeState();</span>

<span class="nc" id="L715">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

<span class="nc" id="L717">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L718">        assertThat(executions).hasSize(1);</span>

<span class="nc" id="L720">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L722">        taskService.complete(task.getId());</span>

<span class="nc" id="L724">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L725">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/inclusiveGatewayForkJoin.bpmn20.xml&quot; })
    public void testSetMultipleActivitiesIntoSynchronizingInclusiveGateway() {

        //Move all parallelGateway activities to the synchronizing gateway
<span class="nc" id="L732">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startInclusiveGwProcess&quot;);</span>
<span class="nc" id="L733">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L734">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L736">        taskService.complete(task.getId());</span>

<span class="nc" id="L738">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L739">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L740">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L741">        assertThat(executionsByActivity).containsKeys(&quot;task1&quot;, &quot;task2&quot;);</span>

<span class="nc" id="L743">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L744">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L746">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L747">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L748">                .moveActivityIdsToSingleActivityId(Arrays.asList(&quot;task1&quot;, &quot;task2&quot;), &quot;gwJoin&quot;)</span>
<span class="nc" id="L749">                .changeState();</span>

<span class="nc" id="L751">        Execution execution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().singleResult();</span>
<span class="nc" id="L752">        assertThat(execution.getActivityId()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L754">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L755">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L757">        taskService.complete(task.getId());</span>
<span class="nc" id="L758">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L759">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/inclusiveGatewayForkJoin.bpmn20.xml&quot; })
    public void testSetMultipleGatewayActivitiesAndSynchronizingInclusiveGatewayAfterGateway() {

        //Move all parallelGateway activities to the synchronizing gateway
<span class="nc" id="L766">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startInclusiveGwProcess&quot;);</span>
<span class="nc" id="L767">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L768">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L770">        taskService.complete(task.getId());</span>

<span class="nc" id="L772">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L773">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L774">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L775">        assertThat(executionsByActivity).containsKeys(&quot;task1&quot;, &quot;task2&quot;);</span>

<span class="nc" id="L777">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L778">        assertThat(tasks).hasSize(2);</span>

        //Complete task1
<span class="nc bnc" id="L781" title="All 2 branches missed.">        for (Task t : tasks) {</span>
<span class="nc bnc" id="L782" title="All 2 branches missed.">            if (&quot;task1&quot;.equals(t.getTaskDefinitionKey())) {</span>
<span class="nc" id="L783">                taskService.complete(t.getId());</span>
            }
<span class="nc" id="L785">        }</span>

<span class="nc" id="L787">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L788">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L789">        Map&lt;String, List&lt;Execution&gt;&gt; classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L790">        assertThat(classifiedExecutions).containsKey(&quot;task2&quot;);</span>
<span class="nc" id="L791">        assertThat(classifiedExecutions.get(&quot;task2&quot;)).hasSize(1);</span>
<span class="nc" id="L792">        assertThat(classifiedExecutions).containsKey(&quot;gwJoin&quot;);</span>
<span class="nc" id="L793">        assertThat(classifiedExecutions.get(&quot;gwJoin&quot;)).hasSize(1);</span>

<span class="nc" id="L795">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L796">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L797">                .moveActivityIdsToSingleActivityId(Arrays.asList(&quot;task2&quot;, &quot;gwJoin&quot;), &quot;taskAfter&quot;)</span>
<span class="nc" id="L798">                .changeState();</span>

<span class="nc" id="L800">        Execution execution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().singleResult();</span>
<span class="nc" id="L801">        assertThat(execution.getActivityId()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L803">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L804">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L806">        taskService.complete(task.getId());</span>
<span class="nc" id="L807">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L808">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/inclusiveGatewayForkJoin.bpmn20.xml&quot; })
    public void testSetActivityIntoSynchronizingParallelInclusiveFirst() {

        //Move one task to the synchronizing gateway, then complete the remaining task
<span class="nc" id="L815">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startInclusiveGwProcess&quot;);</span>
<span class="nc" id="L816">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L817">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L819">        taskService.complete(task.getId());</span>

<span class="nc" id="L821">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L822">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L824">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L825">        assertThat(executions).hasSize(2);</span>

<span class="nc" id="L827">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L828">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L829">                .moveActivityIdTo(&quot;task1&quot;, &quot;gwJoin&quot;)</span>
<span class="nc" id="L830">                .changeState();</span>

<span class="nc" id="L832">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L833">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L834">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L835">        assertThat(executionsByActivity)</span>
<span class="nc" id="L836">                .containsKeys(&quot;task2&quot;, &quot;gwJoin&quot;)</span>
<span class="nc" id="L837">                .doesNotContainKey(&quot;task1&quot;);</span>

<span class="nc" id="L839">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

<span class="nc" id="L841">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;task2&quot;);</span>

<span class="nc" id="L843">        taskService.complete(task.getId());</span>

<span class="nc" id="L845">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L846">        assertThat(executions).hasSize(1);</span>

<span class="nc" id="L848">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L849">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L851">        taskService.complete(task.getId());</span>
<span class="nc" id="L852">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L853">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/inclusiveGatewayForkJoin.bpmn20.xml&quot; })
    public void testSetActivityIntoSynchronizingParallelInclusiveLast() {

        //Complete one task and then move the last remaining task to the synchronizing gateway
<span class="nc" id="L860">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startInclusiveGwProcess&quot;);</span>
<span class="nc" id="L861">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L862">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L864">        taskService.complete(task.getId());</span>

<span class="nc" id="L866">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L867">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L869">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L870">        assertThat(executions).hasSize(2);</span>

        //Complete task1
<span class="nc" id="L873">        Optional&lt;Task&gt; task1 = tasks.stream().filter(t -&gt; &quot;task1&quot;.equals(t.getTaskDefinitionKey())).findFirst();</span>
<span class="nc bnc" id="L874" title="All 2 branches missed.">        if (task1.isPresent()) {</span>
<span class="nc" id="L875">            taskService.complete(task1.get().getId());</span>
        }

<span class="nc" id="L878">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L879">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L880">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L881">        assertThat(executionsByActivity)</span>
<span class="nc" id="L882">                .containsKeys(&quot;task2&quot;, &quot;gwJoin&quot;)</span>
<span class="nc" id="L883">                .doesNotContainKey(&quot;task1&quot;);</span>

<span class="nc" id="L885">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L886">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;task2&quot;);</span>

        //Move task2
<span class="nc" id="L889">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L890">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L891">                .moveActivityIdTo(&quot;task2&quot;, &quot;gwJoin&quot;)</span>
<span class="nc" id="L892">                .changeState();</span>

<span class="nc" id="L894">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L895">        assertThat(executions).hasSize(1);</span>

<span class="nc" id="L897">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L898">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L900">        taskService.complete(task.getId());</span>
<span class="nc" id="L901">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L902">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/inclusiveGatewayForkJoin.bpmn20.xml&quot; })
    public void testSetCurrentExecutionToMultipleActivitiesForInclusiveGateway() {
<span class="nc" id="L907">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startInclusiveGwProcess&quot;);</span>
<span class="nc" id="L908">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L909">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L911">        Execution taskBeforeExecution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().singleResult();</span>

<span class="nc" id="L913">        List&lt;String&gt; newActivityIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L914">        newActivityIds.add(&quot;task1&quot;);</span>
<span class="nc" id="L915">        newActivityIds.add(&quot;task2&quot;);</span>
<span class="nc" id="L916">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L917">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L918">                .moveSingleExecutionToActivityIds(taskBeforeExecution.getId(), newActivityIds)</span>
<span class="nc" id="L919">                .changeState();</span>

<span class="nc" id="L921">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L922">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L924">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L925">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L926">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L927">        assertThat(executionsByActivity)</span>
<span class="nc" id="L928">                .containsKeys(&quot;task1&quot;, &quot;task2&quot;)</span>
<span class="nc" id="L929">                .doesNotContainKey(&quot;gwJoin&quot;);</span>

        //Complete one task1
<span class="nc" id="L932">        Optional&lt;Task&gt; task1 = tasks.stream().filter(t -&gt; &quot;task1&quot;.equals(t.getTaskDefinitionKey())).findFirst();</span>
<span class="nc bnc" id="L933" title="All 2 branches missed.">        if (task1.isPresent()) {</span>
<span class="nc" id="L934">            taskService.complete(task1.get().getId());</span>
        }

<span class="nc" id="L937">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L938">        assertThat(tasks).hasSize(1);</span>

<span class="nc" id="L940">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L941">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L942">        executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L943">        assertThat(executionsByActivity)</span>
<span class="nc" id="L944">                .containsKeys(&quot;task2&quot;, &quot;gwJoin&quot;)</span>
<span class="nc" id="L945">                .doesNotContainKey(&quot;task1&quot;);</span>

<span class="nc" id="L947">        assertThat(((ExecutionEntity) executionsByActivity.get(&quot;gwJoin&quot;).get(0)).isActive()).isFalse();</span>

<span class="nc" id="L949">        taskService.complete(tasks.get(0).getId());</span>

<span class="nc" id="L951">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L952">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L953">        taskService.complete(task.getId());</span>

<span class="nc" id="L955">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L956">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/inclusiveGatewayForkJoin.bpmn20.xml&quot; })
    public void testSetMultipleExecutionsToSingleActivityAfterInclusiveGateway() {
<span class="nc" id="L961">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startInclusiveGwProcess&quot;);</span>
<span class="nc" id="L962">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L963">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L965">        taskService.complete(task.getId());</span>

<span class="nc" id="L967">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L968">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L970">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L971">        assertThat(executions).hasSize(2);</span>

<span class="nc" id="L973">        List&lt;String&gt; currentExecutionIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L974">        currentExecutionIds.add(executions.get(0).getId());</span>
<span class="nc" id="L975">        currentExecutionIds.add(executions.get(1).getId());</span>
<span class="nc" id="L976">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L977">                .moveExecutionsToSingleActivityId(currentExecutionIds, &quot;taskAfter&quot;)</span>
<span class="nc" id="L978">                .changeState();</span>

<span class="nc" id="L980">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

<span class="nc" id="L982">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L983">        assertThat(executions).hasSize(1);</span>

<span class="nc" id="L985">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L986">        taskService.complete(task.getId());</span>

<span class="nc" id="L988">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L989">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/inclusiveGatewayForkJoin.bpmn20.xml&quot; })
    public void testSetMultipleExecutionsIntoSynchronizingInclusiveGateway() {

        //Move all gateway executions to the synchronizing gateway
<span class="nc" id="L996">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startInclusiveGwProcess&quot;);</span>
<span class="nc" id="L997">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L998">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1000">        taskService.complete(task.getId());</span>

<span class="nc" id="L1002">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1003">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L1004">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L1005">        assertThat(executionsByActivity).containsKeys(&quot;task1&quot;, &quot;task2&quot;);</span>

<span class="nc" id="L1007">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1008">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L1010">        List&lt;String&gt; executionIds = executions.stream().map(Execution::getId).collect(Collectors.toList());</span>

<span class="nc" id="L1012">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1013">                .moveExecutionsToSingleActivityId(executionIds, &quot;gwJoin&quot;)</span>
<span class="nc" id="L1014">                .changeState();</span>

<span class="nc" id="L1016">        Execution execution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().singleResult();</span>
<span class="nc" id="L1017">        assertThat(execution.getActivityId()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L1019">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1020">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L1022">        taskService.complete(task.getId());</span>
<span class="nc" id="L1023">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1024">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/inclusiveGatewayForkJoin.bpmn20.xml&quot; })
    public void testSetMultipleGatewayExecutionsAndSynchronizingInclusiveGatewayAfterGateway() {

        //Move all gateway executions to the synchronizing gateway
<span class="nc" id="L1031">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startInclusiveGwProcess&quot;);</span>
<span class="nc" id="L1032">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1033">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1035">        taskService.complete(task.getId());</span>

<span class="nc" id="L1037">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1038">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L1039">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L1040">        assertThat(executionsByActivity).containsKeys(&quot;task1&quot;, &quot;task2&quot;);</span>

<span class="nc" id="L1042">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1043">        assertThat(tasks).hasSize(2);</span>

        //Complete task1
<span class="nc bnc" id="L1046" title="All 2 branches missed.">        for (Task t : tasks) {</span>
<span class="nc bnc" id="L1047" title="All 2 branches missed.">            if (&quot;task1&quot;.equals(t.getTaskDefinitionKey())) {</span>
<span class="nc" id="L1048">                taskService.complete(t.getId());</span>
            }
<span class="nc" id="L1050">        }</span>

<span class="nc" id="L1052">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1053">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L1054">        Map&lt;String, List&lt;Execution&gt;&gt; classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L1055">        assertThat(classifiedExecutions).containsKey(&quot;task2&quot;);</span>
<span class="nc" id="L1056">        assertThat(classifiedExecutions.get(&quot;task2&quot;)).hasSize(1);</span>
<span class="nc" id="L1057">        assertThat(classifiedExecutions).containsKey(&quot;gwJoin&quot;);</span>
<span class="nc" id="L1058">        assertThat(classifiedExecutions.get(&quot;gwJoin&quot;)).hasSize(1);</span>

<span class="nc" id="L1060">        List&lt;String&gt; executionIds = executions.stream().map(Execution::getId).collect(Collectors.toList());</span>

<span class="nc" id="L1062">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1063">                .moveExecutionsToSingleActivityId(executionIds, &quot;taskAfter&quot;)</span>
<span class="nc" id="L1064">                .changeState();</span>

<span class="nc" id="L1066">        Execution execution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().singleResult();</span>
<span class="nc" id="L1067">        assertThat(execution.getActivityId()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L1069">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1070">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L1072">        taskService.complete(task.getId());</span>
<span class="nc" id="L1073">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1074">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/inclusiveGatewayForkJoin.bpmn20.xml&quot; })
    public void testSetExecutionIntoSynchronizingInclusiveGatewayFirst() {

        //Move one task to the synchronizing gateway, then complete the remaining task
<span class="nc" id="L1081">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startInclusiveGwProcess&quot;);</span>
<span class="nc" id="L1082">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1083">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1085">        taskService.complete(task.getId());</span>

<span class="nc" id="L1087">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1088">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L1090">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1091">        assertThat(executions).hasSize(2);</span>

<span class="nc" id="L1093">        String executionId = executions.stream().filter(e -&gt; &quot;task1&quot;.equals(e.getActivityId())).findFirst().map(Execution::getId).get();</span>
<span class="nc" id="L1094">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1095">                .moveExecutionToActivityId(executionId, &quot;gwJoin&quot;)</span>
<span class="nc" id="L1096">                .changeState();</span>

<span class="nc" id="L1098">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1099">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L1100">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L1101">        assertThat(executionsByActivity)</span>
<span class="nc" id="L1102">                .containsKeys(&quot;task2&quot;, &quot;gwJoin&quot;)</span>
<span class="nc" id="L1103">                .doesNotContainKey(&quot;task1&quot;);</span>

<span class="nc" id="L1105">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1106">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;task2&quot;);</span>

<span class="nc" id="L1108">        taskService.complete(task.getId());</span>

<span class="nc" id="L1110">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1111">        assertThat(executions).hasSize(1);</span>

<span class="nc" id="L1113">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1114">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L1116">        taskService.complete(task.getId());</span>
<span class="nc" id="L1117">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1118">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/inclusiveGatewayForkJoin.bpmn20.xml&quot; })
    public void testSetExecutionIntoSynchronizingInclusiveGatewayLast() {

        //Complete one task and then move the last remaining task to the synchronizing gateway
<span class="nc" id="L1125">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startInclusiveGwProcess&quot;);</span>
<span class="nc" id="L1126">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1127">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1129">        taskService.complete(task.getId());</span>

<span class="nc" id="L1131">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1132">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L1134">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1135">        assertThat(executions).hasSize(2);</span>

        //Complete task1
<span class="nc" id="L1138">        Optional&lt;Task&gt; task1 = tasks.stream().filter(t -&gt; &quot;task1&quot;.equals(t.getTaskDefinitionKey())).findFirst();</span>
<span class="nc bnc" id="L1139" title="All 2 branches missed.">        if (task1.isPresent()) {</span>
<span class="nc" id="L1140">            taskService.complete(task1.get().getId());</span>
        }

<span class="nc" id="L1143">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1144">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L1145">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L1146">        assertThat(executionsByActivity)</span>
<span class="nc" id="L1147">                .containsKeys(&quot;task2&quot;, &quot;gwJoin&quot;)</span>
<span class="nc" id="L1148">                .doesNotContainKey(&quot;task1&quot;);</span>

<span class="nc" id="L1150">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1151">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;task2&quot;);</span>

        //Move task2 execution
<span class="nc" id="L1154">        String executionId = executions.stream().filter(e -&gt; &quot;task2&quot;.equals(e.getActivityId())).findFirst().map(Execution::getId).get();</span>
<span class="nc" id="L1155">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1156">                .moveExecutionToActivityId(executionId, &quot;gwJoin&quot;)</span>
<span class="nc" id="L1157">                .changeState();</span>

<span class="nc" id="L1159">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1160">        assertThat(executions).hasSize(1);</span>

<span class="nc" id="L1162">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1163">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>

<span class="nc" id="L1165">        taskService.complete(task.getId());</span>
<span class="nc" id="L1166">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1167">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/parallelSubProcesses.bpmn20.xml&quot; })
    public void testSetCurrentActivityToMultipleActivitiesForParallelSubProcesses() {
<span class="nc" id="L1172">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startParallelProcess&quot;);</span>
<span class="nc" id="L1173">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1174">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1176">        List&lt;String&gt; newActivityIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1177">        newActivityIds.add(&quot;subtask&quot;);</span>
<span class="nc" id="L1178">        newActivityIds.add(&quot;subtask2&quot;);</span>
<span class="nc" id="L1179">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1180">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1181">                .moveSingleActivityIdToActivityIds(&quot;taskBefore&quot;, newActivityIds)</span>
<span class="nc" id="L1182">                .changeState();</span>

<span class="nc" id="L1184">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1185">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L1187">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1188">        assertThat(executions).hasSize(4);</span>

<span class="nc" id="L1190">        Optional&lt;Execution&gt; parallelJoinExecution = executions.stream().filter(e -&gt; &quot;parallelJoin&quot;.equals(e.getActivityId())).findFirst();</span>
<span class="nc" id="L1191">        assertThat(parallelJoinExecution).isNotPresent();</span>

<span class="nc" id="L1193">        taskService.complete(tasks.get(0).getId());</span>

<span class="nc" id="L1195">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1196">        assertThat(tasks).hasSize(1);</span>

<span class="nc" id="L1198">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1199">        assertThat(executions).hasSize(3);</span>

<span class="nc" id="L1201">        parallelJoinExecution = executions.stream().filter(e -&gt; &quot;parallelJoin&quot;.equals(e.getActivityId())).findFirst();</span>
<span class="nc" id="L1202">        assertThat(parallelJoinExecution).isPresent();</span>
<span class="nc" id="L1203">        assertThat(((ExecutionEntity) parallelJoinExecution.get()).isActive()).isFalse();</span>

<span class="nc" id="L1205">        taskService.complete(tasks.get(0).getId());</span>

<span class="nc" id="L1207">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1208">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1209">        taskService.complete(task.getId());</span>

<span class="nc" id="L1211">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1212">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/parallelSubProcesses.bpmn20.xml&quot; })
    public void testSetMultipleActivitiesToSingleActivityAfterParallelSubProcesses() {
<span class="nc" id="L1217">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startParallelProcess&quot;);</span>
<span class="nc" id="L1218">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1219">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1221">        taskService.complete(task.getId());</span>

<span class="nc" id="L1223">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1224">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L1226">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1227">        assertThat(executions).hasSize(4);</span>

<span class="nc" id="L1229">        List&lt;String&gt; currentActivityIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1230">        currentActivityIds.add(&quot;subtask&quot;);</span>
<span class="nc" id="L1231">        currentActivityIds.add(&quot;subtask2&quot;);</span>
<span class="nc" id="L1232">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1233">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1234">                .moveActivityIdsToSingleActivityId(currentActivityIds, &quot;taskAfter&quot;)</span>
<span class="nc" id="L1235">                .changeState();</span>

<span class="nc" id="L1237">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

<span class="nc" id="L1239">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1240">        assertThat(executions).hasSize(1);</span>

<span class="nc" id="L1242">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1243">        taskService.complete(task.getId());</span>

<span class="nc" id="L1245">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1246">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/parallelSubProcessesMultipleTasks.bpmn20.xml&quot; })
    public void testMoveCurrentActivityInParallelSubProcess() {
<span class="nc" id="L1251">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startParallelProcess&quot;);</span>
<span class="nc" id="L1252">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1253">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1255">        taskService.complete(task.getId());</span>

<span class="nc" id="L1257">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1258">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L1260">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1261">        assertThat(executions).hasSize(4);</span>

<span class="nc" id="L1263">        Execution subProcessExecution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).activityId(&quot;subProcess1&quot;)</span>
<span class="nc" id="L1264">                .singleResult();</span>
<span class="nc" id="L1265">        String subProcessExecutionId = subProcessExecution.getId();</span>
<span class="nc" id="L1266">        runtimeService.setVariableLocal(subProcessExecutionId, &quot;subProcessVar&quot;, &quot;test&quot;);</span>

<span class="nc" id="L1268">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1269">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1270">                .moveActivityIdTo(&quot;subtask&quot;, &quot;subtask2&quot;)</span>
<span class="nc" id="L1271">                .changeState();</span>

<span class="nc" id="L1273">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1274">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L1276">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1277">        assertThat(executions).hasSize(4);</span>

<span class="nc" id="L1279">        subProcessExecution = runtimeService.createExecutionQuery().executionId(subProcessExecutionId).singleResult();</span>
<span class="nc" id="L1280">        assertThat(subProcessExecution).isNotNull();</span>
<span class="nc" id="L1281">        assertThat(runtimeService.getVariableLocal(subProcessExecutionId, &quot;subProcessVar&quot;)).isEqualTo(&quot;test&quot;);</span>

<span class="nc" id="L1283">        taskService.complete(tasks.get(0).getId());</span>

<span class="nc" id="L1285">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1286">        assertThat(tasks).hasSize(1);</span>

<span class="nc" id="L1288">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1289">        assertThat(executions).hasSize(3);</span>

<span class="nc" id="L1291">        taskService.complete(tasks.get(0).getId());</span>

<span class="nc" id="L1293">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1294">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1295">        taskService.complete(task.getId());</span>

<span class="nc" id="L1297">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1298">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/multipleParallelSubProcesses.bpmn20.xml&quot; })
    public void testSetCurrentActivityToMultipleActivitiesForInclusiveAndParallelSubProcesses() {
<span class="nc" id="L1303">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startParallelProcess&quot;, Collections.singletonMap(&quot;var1&quot;, &quot;test2&quot;));</span>
<span class="nc" id="L1304">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1305">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1307">        List&lt;String&gt; newActivityIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1308">        newActivityIds.add(&quot;taskInclusive3&quot;);</span>
<span class="nc" id="L1309">        newActivityIds.add(&quot;subtask&quot;);</span>
<span class="nc" id="L1310">        newActivityIds.add(&quot;subtask3&quot;);</span>
<span class="nc" id="L1311">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1312">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1313">                .moveSingleActivityIdToActivityIds(&quot;taskBefore&quot;, newActivityIds)</span>
<span class="nc" id="L1314">                .changeState();</span>

<span class="nc" id="L1316">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1317">        assertThat(tasks).hasSize(3);</span>

<span class="nc" id="L1319">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1320">        assertThat(executions).hasSize(5);</span>

<span class="nc" id="L1322">        Optional&lt;Execution&gt; parallelJoinExecution = executions.stream().filter(e -&gt; &quot;parallelJoin&quot;.equals(e.getActivityId())).findFirst();</span>
<span class="nc" id="L1323">        assertThat(parallelJoinExecution).isNotPresent();</span>

<span class="nc" id="L1325">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;subtask&quot;).singleResult();</span>
<span class="nc" id="L1326">        taskService.complete(task.getId());</span>

<span class="nc" id="L1328">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1329">        assertThat(tasks).hasSize(3);</span>

<span class="nc" id="L1331">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;subtask2&quot;).singleResult();</span>
<span class="nc" id="L1332">        taskService.complete(task.getId());</span>

<span class="nc" id="L1334">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1335">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L1337">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1338">        assertThat(executions).hasSize(4);</span>

<span class="nc" id="L1340">        parallelJoinExecution = executions.stream().filter(e -&gt; &quot;parallelJoin&quot;.equals(e.getActivityId())).findFirst();</span>
<span class="nc" id="L1341">        assertThat(parallelJoinExecution).isPresent();</span>
<span class="nc" id="L1342">        assertThat(((ExecutionEntity) parallelJoinExecution.get()).isActive()).isFalse();</span>

<span class="nc" id="L1344">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;subtask3&quot;).singleResult();</span>
<span class="nc" id="L1345">        taskService.complete(task.getId());</span>

<span class="nc" id="L1347">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1348">        assertThat(executions).hasSize(2);</span>

<span class="nc" id="L1350">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1351">        assertThat(tasks).hasSize(1);</span>

<span class="nc" id="L1353">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;taskInclusive3&quot;).singleResult();</span>
<span class="nc" id="L1354">        taskService.complete(task.getId());</span>

<span class="nc" id="L1356">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1357">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1358">        taskService.complete(task.getId());</span>

<span class="nc" id="L1360">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1361">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/multipleParallelSubProcesses.bpmn20.xml&quot; })
    public void testSetCurrentActivitiesToSingleActivityForInclusiveAndParallelSubProcesses() {
<span class="nc" id="L1366">        Map&lt;String, Object&gt; variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1367">        variableMap.put(&quot;var1&quot;, &quot;test2&quot;);</span>
<span class="nc" id="L1368">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startParallelProcess&quot;, variableMap);</span>
<span class="nc" id="L1369">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1370">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1372">        taskService.complete(task.getId());</span>

<span class="nc" id="L1374">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1375">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L1377">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;taskInclusive1&quot;).singleResult();</span>
<span class="nc" id="L1378">        assertThat(task).isNotNull();</span>
<span class="nc" id="L1379">        taskService.complete(task.getId());</span>

<span class="nc" id="L1381">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1382">        assertThat(tasks).hasSize(3);</span>

<span class="nc" id="L1384">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;taskInclusive3&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L1385">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;subtask&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L1386">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;subtask3&quot;).count()).isEqualTo(1);</span>

<span class="nc" id="L1388">        List&lt;String&gt; currentActivityIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1389">        currentActivityIds.add(&quot;taskInclusive3&quot;);</span>
<span class="nc" id="L1390">        currentActivityIds.add(&quot;subtask&quot;);</span>
<span class="nc" id="L1391">        currentActivityIds.add(&quot;subtask3&quot;);</span>

<span class="nc" id="L1393">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1394">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1395">                .moveActivityIdsToSingleActivityId(currentActivityIds, &quot;taskAfter&quot;)</span>
<span class="nc" id="L1396">                .changeState();</span>

<span class="nc" id="L1398">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1399">        assertThat(tasks).hasSize(1);</span>

<span class="nc" id="L1401">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1402">        assertThat(executions).hasSize(1);</span>

<span class="nc" id="L1404">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1405">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1406">        taskService.complete(task.getId());</span>

<span class="nc" id="L1408">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1409">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/multipleParallelSubProcesses.bpmn20.xml&quot; })
    public void testSetCurrentActivitiesToSingleActivityInInclusiveGateway() {
<span class="nc" id="L1414">        Map&lt;String, Object&gt; variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1415">        variableMap.put(&quot;var1&quot;, &quot;test2&quot;);</span>
<span class="nc" id="L1416">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startParallelProcess&quot;, variableMap);</span>
<span class="nc" id="L1417">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1418">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1420">        taskService.complete(task.getId());</span>

<span class="nc" id="L1422">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1423">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L1425">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;taskInclusive1&quot;).singleResult();</span>
<span class="nc" id="L1426">        assertThat(task).isNotNull();</span>
<span class="nc" id="L1427">        taskService.complete(task.getId());</span>

<span class="nc" id="L1429">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1430">        assertThat(tasks).hasSize(3);</span>

<span class="nc" id="L1432">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;taskInclusive3&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L1433">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;subtask&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L1434">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;subtask3&quot;).count()).isEqualTo(1);</span>

<span class="nc" id="L1436">        List&lt;String&gt; currentActivityIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1437">        currentActivityIds.add(&quot;subtask&quot;);</span>
<span class="nc" id="L1438">        currentActivityIds.add(&quot;subtask3&quot;);</span>

<span class="nc" id="L1440">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1441">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1442">                .moveActivityIdsToSingleActivityId(currentActivityIds, &quot;taskInclusive1&quot;)</span>
<span class="nc" id="L1443">                .changeState();</span>

<span class="nc" id="L1445">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1446">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L1448">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1449">        assertThat(executions).hasSize(2);</span>

<span class="nc" id="L1451">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;taskInclusive3&quot;).singleResult();</span>
<span class="nc" id="L1452">        taskService.complete(task.getId());</span>

<span class="nc" id="L1454">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;taskInclusive1&quot;).singleResult();</span>
<span class="nc" id="L1455">        taskService.complete(task.getId());</span>

<span class="nc" id="L1457">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1458">        assertThat(executions).hasSize(5);</span>

<span class="nc" id="L1460">        Optional&lt;Execution&gt; inclusiveJoinExecution = executions.stream().filter(e -&gt; &quot;inclusiveJoin&quot;.equals(e.getActivityId())).findFirst();</span>
<span class="nc" id="L1461">        assertThat(inclusiveJoinExecution).isPresent();</span>
<span class="nc" id="L1462">        assertThat(((ExecutionEntity) inclusiveJoinExecution.get()).isActive()).isFalse();</span>

<span class="nc" id="L1464">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;subtask3&quot;).singleResult();</span>
<span class="nc" id="L1465">        taskService.complete(task.getId());</span>

<span class="nc" id="L1467">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;subtask&quot;).singleResult();</span>
<span class="nc" id="L1468">        taskService.complete(task.getId());</span>

<span class="nc" id="L1470">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;subtask2&quot;).singleResult();</span>
<span class="nc" id="L1471">        taskService.complete(task.getId());</span>

<span class="nc" id="L1473">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1474">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1475">        taskService.complete(task.getId());</span>

<span class="nc" id="L1477">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1478">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>