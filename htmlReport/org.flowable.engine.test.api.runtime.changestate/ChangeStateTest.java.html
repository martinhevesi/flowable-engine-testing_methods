<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ChangeStateTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.runtime.changestate</a> &gt; <span class="el_source">ChangeStateTest.java</span></div><h1>ChangeStateTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.engine.test.api.runtime.changestate;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.entry;
import static org.assertj.core.api.Assertions.tuple;

import java.util.Iterator;
import java.util.List;
import java.util.Map;

import org.flowable.common.engine.api.delegate.event.FlowableEngineEntityEvent;
import org.flowable.common.engine.api.delegate.event.FlowableEngineEventType;
import org.flowable.common.engine.api.delegate.event.FlowableEvent;
import org.flowable.engine.delegate.event.FlowableActivityEvent;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.runtime.ChangeActivityStateBuilder;
import org.flowable.engine.runtime.DataObject;
import org.flowable.engine.runtime.Execution;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.eventsubscription.api.EventSubscription;
import org.flowable.job.api.Job;
import org.flowable.task.api.Task;
import org.flowable.variable.api.event.FlowableVariableEvent;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

/**
 * @author Frederik Heremans
 * @author Joram Barrez
 * @author Dennis Federico
 */
<span class="nc" id="L47">public class ChangeStateTest extends PluggableFlowableTestCase {</span>

<span class="nc" id="L49">    private ChangeStateEventListener changeStateEventListener = new ChangeStateEventListener();</span>

    @BeforeEach
    protected void setUp() {
<span class="nc" id="L53">        processEngine.getRuntimeService().addEventListener(changeStateEventListener);</span>
<span class="nc" id="L54">    }</span>

    @AfterEach
    protected void tearDown() {
<span class="nc" id="L58">        processEngine.getRuntimeService().removeEventListener(changeStateEventListener);</span>
<span class="nc" id="L59">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/twoTasksProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityBackwardForSimpleProcess() {
<span class="nc" id="L64">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;twoTasksProcess&quot;);</span>
<span class="nc" id="L65">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L66">        taskService.complete(task.getId());</span>

<span class="nc" id="L68">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L69">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;secondTask&quot;);</span>

<span class="nc" id="L71">        changeStateEventListener.clear();</span>

<span class="nc" id="L73">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L74">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L75">                .moveActivityIdTo(&quot;secondTask&quot;, &quot;firstTask&quot;)</span>
<span class="nc" id="L76">                .changeState();</span>

<span class="nc" id="L78">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L79">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;firstTask&quot;);</span>

        // Verify events
<span class="nc" id="L82">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L83">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L85">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L86">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L87">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;secondTask&quot;);</span>

<span class="nc" id="L89">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L90">        event = iterator.next();</span>
<span class="nc" id="L91">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L92">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;firstTask&quot;);</span>

<span class="nc" id="L94">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L96">        taskService.complete(task.getId());</span>

<span class="nc" id="L98">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L99">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;secondTask&quot;);</span>
<span class="nc" id="L100">        taskService.complete(task.getId());</span>

<span class="nc" id="L102">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L103">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/twoTasksProcess.bpmn20.xml&quot; })
    public void testSetCurrentExecutionBackwardForSimpleProcess() {
<span class="nc" id="L108">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;twoTasksProcess&quot;);</span>
<span class="nc" id="L109">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L110">        taskService.complete(task.getId());</span>

<span class="nc" id="L112">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L113">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;secondTask&quot;);</span>

<span class="nc" id="L115">        changeStateEventListener.clear();</span>

<span class="nc" id="L117">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L118">                .moveExecutionToActivityId(task.getExecutionId(), &quot;firstTask&quot;)</span>
<span class="nc" id="L119">                .changeState();</span>

<span class="nc" id="L121">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L122">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;firstTask&quot;);</span>

        // Verify events
<span class="nc" id="L125">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L126">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L128">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L129">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L130">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;secondTask&quot;);</span>

<span class="nc" id="L132">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L133">        event = iterator.next();</span>
<span class="nc" id="L134">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L135">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;firstTask&quot;);</span>

<span class="nc" id="L137">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L139">        taskService.complete(task.getId());</span>

<span class="nc" id="L141">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L142">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;secondTask&quot;);</span>
<span class="nc" id="L143">        taskService.complete(task.getId());</span>

<span class="nc" id="L145">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L146">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/twoTasksProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityForwardForSimpleProcess() {
<span class="nc" id="L151">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;twoTasksProcess&quot;);</span>
<span class="nc" id="L152">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L153">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;firstTask&quot;);</span>

<span class="nc" id="L155">        changeStateEventListener.clear();</span>

<span class="nc" id="L157">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L158">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L159">                .moveActivityIdTo(&quot;firstTask&quot;, &quot;secondTask&quot;)</span>
<span class="nc" id="L160">                .changeState();</span>

        // Verify events
<span class="nc" id="L163">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L164">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L166">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L167">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L168">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;firstTask&quot;);</span>

<span class="nc" id="L170">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L171">        event = iterator.next();</span>
<span class="nc" id="L172">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L173">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;secondTask&quot;);</span>

<span class="nc" id="L175">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L177">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L178">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;secondTask&quot;);</span>
<span class="nc" id="L179">        taskService.complete(task.getId());</span>

<span class="nc" id="L181">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L182">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/twoTasksProcess.bpmn20.xml&quot; })
    public void testSetCurrentExecutionForwardForSimpleProcess() {
<span class="nc" id="L187">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;twoTasksProcess&quot;);</span>
<span class="nc" id="L188">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L189">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;firstTask&quot;);</span>

<span class="nc" id="L191">        changeStateEventListener.clear();</span>

<span class="nc" id="L193">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L194">                .moveExecutionToActivityId(task.getExecutionId(), &quot;secondTask&quot;)</span>
<span class="nc" id="L195">                .changeState();</span>

        // Verify events
<span class="nc" id="L198">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L199">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L201">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L202">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L203">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;firstTask&quot;);</span>

<span class="nc" id="L205">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L206">        event = iterator.next();</span>
<span class="nc" id="L207">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L208">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;secondTask&quot;);</span>

<span class="nc" id="L210">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L212">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L213">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;secondTask&quot;);</span>
<span class="nc" id="L214">        taskService.complete(task.getId());</span>

<span class="nc" id="L216">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L217">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/twoTasksProcessWithTimer.bpmn20.xml&quot; })
    public void testSetCurrentActivityWithTimerForSimpleProcess() {
<span class="nc" id="L222">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;twoTasksProcess&quot;);</span>

<span class="nc" id="L224">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L225">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;firstTask&quot;);</span>

<span class="nc" id="L227">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L228">        Execution execution = runtimeService.createExecutionQuery().parentId(task.getExecutionId()).singleResult();</span>
<span class="nc" id="L229">        managementService.createTimerJobQuery().executionId(execution.getId()).singleResult();</span>

<span class="nc" id="L231">        assertThat(timerJob).isNotNull();</span>

<span class="nc" id="L233">        changeStateEventListener.clear();</span>

<span class="nc" id="L235">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L236">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L237">                .moveActivityIdTo(&quot;firstTask&quot;, &quot;secondTask&quot;)</span>
<span class="nc" id="L238">                .changeState();</span>

<span class="nc" id="L240">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L241">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;secondTask&quot;);</span>

<span class="nc" id="L243">        timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L244">        assertThat(timerJob).isNull();</span>

        // Verify events
<span class="nc" id="L247">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L248">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L250">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L251">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.JOB_CANCELED);</span>
<span class="nc" id="L252">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) event;</span>
<span class="nc" id="L253">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L254">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc" id="L256">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L257">        event = iterator.next();</span>
<span class="nc" id="L258">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L259">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;firstTask&quot;);</span>

<span class="nc" id="L261">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L262">        event = iterator.next();</span>
<span class="nc" id="L263">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L264">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;secondTask&quot;);</span>

<span class="nc" id="L266">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L268">        taskService.complete(task.getId());</span>

<span class="nc" id="L270">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L271">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/twoTasksProcessWithTimer.bpmn20.xml&quot; })
    public void testSetCurrentExecutionWithTimerForSimpleProcess() {
<span class="nc" id="L276">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;twoTasksProcess&quot;);</span>

<span class="nc" id="L278">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L279">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;firstTask&quot;);</span>

<span class="nc" id="L281">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L282">        assertThat(timerJob).isNotNull();</span>

<span class="nc" id="L284">        changeStateEventListener.clear();</span>

<span class="nc" id="L286">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L287">                .moveExecutionToActivityId(task.getExecutionId(), &quot;secondTask&quot;)</span>
<span class="nc" id="L288">                .changeState();</span>

<span class="nc" id="L290">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L291">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;secondTask&quot;);</span>

<span class="nc" id="L293">        timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L294">        assertThat(timerJob).isNull();</span>

        // Verify events
<span class="nc" id="L297">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L298">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L300">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L301">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.JOB_CANCELED);</span>
<span class="nc" id="L302">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) event;</span>
<span class="nc" id="L303">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L304">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc" id="L306">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L307">        event = iterator.next();</span>
<span class="nc" id="L308">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L309">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;firstTask&quot;);</span>

<span class="nc" id="L311">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L312">        event = iterator.next();</span>
<span class="nc" id="L313">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L314">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;secondTask&quot;);</span>

<span class="nc" id="L316">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L318">        taskService.complete(task.getId());</span>

<span class="nc" id="L320">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L321">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/twoTasksProcessWithTimer.bpmn20.xml&quot; })
    public void testSetCurrentActivityToActivityWithTimerForSimpleProcess() {
<span class="nc" id="L326">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;twoTasksProcess&quot;);</span>

<span class="nc" id="L328">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L329">        assertThat(timerJob).isNotNull();</span>

<span class="nc" id="L331">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L332">        taskService.complete(task.getId());</span>

<span class="nc" id="L334">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L335">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;secondTask&quot;);</span>

<span class="nc" id="L337">        timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L338">        assertThat(timerJob).isNull();</span>

<span class="nc" id="L340">        changeStateEventListener.clear();</span>

<span class="nc" id="L342">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L343">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L344">                .moveActivityIdTo(&quot;secondTask&quot;, &quot;firstTask&quot;)</span>
<span class="nc" id="L345">                .changeState();</span>

<span class="nc" id="L347">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L348">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;firstTask&quot;);</span>

<span class="nc" id="L350">        timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L351">        assertThat(timerJob).isNotNull();</span>

        // Verify events
<span class="nc" id="L354">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L355">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L357">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L358">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L359">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;secondTask&quot;);</span>

<span class="nc" id="L361">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L362">        event = iterator.next();</span>
<span class="nc" id="L363">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L364">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;firstTask&quot;);</span>

<span class="nc" id="L366">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L367">        event = iterator.next();</span>
<span class="nc" id="L368">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.TIMER_SCHEDULED);</span>
<span class="nc" id="L369">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) event;</span>
<span class="nc" id="L370">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L371">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc" id="L373">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L375">        taskService.complete(task.getId());</span>

<span class="nc" id="L377">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L378">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;secondTask&quot;);</span>
<span class="nc" id="L379">        taskService.complete(task.getId());</span>

<span class="nc" id="L381">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L382">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/twoTasksProcessWithTimer.bpmn20.xml&quot; })
    public void testSetCurrentExecutionToActivityWithTimerForSimpleProcess() {
<span class="nc" id="L387">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;twoTasksProcess&quot;);</span>

<span class="nc" id="L389">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L390">        assertThat(timerJob).isNotNull();</span>

<span class="nc" id="L392">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L393">        taskService.complete(task.getId());</span>

<span class="nc" id="L395">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L396">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;secondTask&quot;);</span>

<span class="nc" id="L398">        timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L399">        assertThat(timerJob).isNull();</span>

<span class="nc" id="L401">        changeStateEventListener.clear();</span>

<span class="nc" id="L403">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L404">                .moveExecutionToActivityId(task.getExecutionId(), &quot;firstTask&quot;)</span>
<span class="nc" id="L405">                .changeState();</span>

        // Verify events
<span class="nc" id="L408">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L409">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L411">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L412">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L413">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;secondTask&quot;);</span>

<span class="nc" id="L415">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L416">        event = iterator.next();</span>
<span class="nc" id="L417">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L418">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;firstTask&quot;);</span>

<span class="nc" id="L420">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L421">        event = iterator.next();</span>
<span class="nc" id="L422">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.TIMER_SCHEDULED);</span>
<span class="nc" id="L423">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) event;</span>
<span class="nc" id="L424">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L425">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc" id="L427">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L428">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;firstTask&quot;);</span>

<span class="nc" id="L430">        timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L431">        assertThat(timerJob).isNotNull();</span>

<span class="nc" id="L433">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L435">        taskService.complete(task.getId());</span>

<span class="nc" id="L437">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L438">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;secondTask&quot;);</span>
<span class="nc" id="L439">        taskService.complete(task.getId());</span>

<span class="nc" id="L441">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L442">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/twoTasksProcessWithTimers.bpmn20.xml&quot; })
    public void testSetCurrentActivityWithTimerToActivityWithTimerSimpleProcess() {
<span class="nc" id="L447">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;twoTasksProcessWithTimers&quot;);</span>

<span class="nc" id="L449">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L450">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;firstTask&quot;);</span>
<span class="nc" id="L451">        Execution execution = runtimeService.createExecutionQuery().parentId(task.getExecutionId()).singleResult();</span>
<span class="nc" id="L452">        Job timerJob1 = managementService.createTimerJobQuery().executionId(execution.getId()).singleResult();</span>
<span class="nc" id="L453">        assertThat(timerJob1).isNotNull();</span>

<span class="nc" id="L455">        changeStateEventListener.clear();</span>

<span class="nc" id="L457">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L458">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L459">                .moveActivityIdTo(&quot;firstTask&quot;, &quot;secondTask&quot;)</span>
<span class="nc" id="L460">                .changeState();</span>

<span class="nc" id="L462">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L463">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;secondTask&quot;);</span>
<span class="nc" id="L464">        Job timerJob2 = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L465">        assertThat(timerJob2).isNotNull();</span>
<span class="nc" id="L466">        assertThat(timerJob1.getExecutionId()).isNotEqualTo(timerJob2.getExecutionId());</span>

        // Verify events
<span class="nc" id="L469">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L470">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L472">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L473">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.JOB_CANCELED);</span>
<span class="nc" id="L474">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) event;</span>
<span class="nc" id="L475">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L476">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;firstTimerEvent&quot;);</span>

<span class="nc" id="L478">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L479">        event = iterator.next();</span>
<span class="nc" id="L480">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L481">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;firstTask&quot;);</span>

<span class="nc" id="L483">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L484">        event = iterator.next();</span>
<span class="nc" id="L485">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L486">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;secondTask&quot;);</span>

<span class="nc" id="L488">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L489">        event = iterator.next();</span>
<span class="nc" id="L490">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.TIMER_SCHEDULED);</span>
<span class="nc" id="L491">        entityEvent = (FlowableEngineEntityEvent) event;</span>
<span class="nc" id="L492">        timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L493">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;secondTimerEvent&quot;);</span>

<span class="nc" id="L495">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L497">        Job job = managementService.moveTimerToExecutableJob(timerJob2.getId());</span>
<span class="nc" id="L498">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L500">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L501">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;thirdTask&quot;);</span>

<span class="nc" id="L503">        taskService.complete(task.getId());</span>

<span class="nc" id="L505">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L506">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityOutOfSubProcess() {
<span class="nc" id="L511">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;);</span>
<span class="nc" id="L512">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L513">        taskService.complete(task.getId());</span>

<span class="nc" id="L515">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L516">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L518">        changeStateEventListener.clear();</span>

<span class="nc" id="L520">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L521">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L522">                .moveActivityIdTo(&quot;subTask&quot;, &quot;taskBefore&quot;)</span>
<span class="nc" id="L523">                .changeState();</span>

<span class="nc" id="L525">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L526">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L528">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L529">        assertThat(executions).hasSize(2);</span>

        // Verify events
<span class="nc" id="L532">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L533">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L535">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L536">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L537">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L539">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L540">        event = iterator.next();</span>
<span class="nc" id="L541">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L542">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L544">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L545">        event = iterator.next();</span>
<span class="nc" id="L546">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L547">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L549">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L551">        taskService.complete(task.getId());</span>

<span class="nc" id="L553">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L554">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>
<span class="nc" id="L555">        taskService.complete(task.getId());</span>

<span class="nc" id="L557">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L558">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L559">        taskService.complete(task.getId());</span>

<span class="nc" id="L561">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L562">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentExecutionOutOfSubProcess() {
<span class="nc" id="L567">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;);</span>
<span class="nc" id="L568">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L569">        taskService.complete(task.getId());</span>

<span class="nc" id="L571">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L572">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L574">        changeStateEventListener.clear();</span>

<span class="nc" id="L576">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L577">                .moveExecutionToActivityId(task.getExecutionId(), &quot;taskBefore&quot;)</span>
<span class="nc" id="L578">                .changeState();</span>

<span class="nc" id="L580">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L581">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L583">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L584">        assertThat(executions).hasSize(2);</span>

        // Verify events
<span class="nc" id="L587">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L588">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L590">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L591">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L592">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L594">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L595">        event = iterator.next();</span>
<span class="nc" id="L596">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L597">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L599">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L600">        event = iterator.next();</span>
<span class="nc" id="L601">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L602">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L604">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L606">        taskService.complete(task.getId());</span>

<span class="nc" id="L608">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L609">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>
<span class="nc" id="L610">        taskService.complete(task.getId());</span>

<span class="nc" id="L612">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L613">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L614">        taskService.complete(task.getId());</span>

<span class="nc" id="L616">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L617">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityIntoSubProcess() {
<span class="nc" id="L622">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;);</span>

<span class="nc" id="L624">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L625">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L627">        changeStateEventListener.clear();</span>

<span class="nc" id="L629">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L630">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L631">                .moveActivityIdTo(&quot;taskBefore&quot;, &quot;subTask&quot;)</span>
<span class="nc" id="L632">                .changeState();</span>

<span class="nc" id="L634">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L635">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L637">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L638">        assertThat(executions).hasSize(3);</span>

        // Verify events
<span class="nc" id="L641">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L642">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L644">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L645">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L646">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L648">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L649">        event = iterator.next();</span>
<span class="nc" id="L650">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L651">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L653">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L654">        event = iterator.next();</span>
<span class="nc" id="L655">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.VARIABLE_CREATED);</span>
<span class="nc" id="L656">        assertThat(((FlowableVariableEvent) event).getVariableName()).isEqualTo(&quot;name&quot;);</span>
<span class="nc" id="L657">        assertThat(((FlowableVariableEvent) event).getVariableValue()).isEqualTo(&quot;John&quot;);</span>

<span class="nc" id="L659">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L660">        event = iterator.next();</span>
<span class="nc" id="L661">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L662">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L664">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L666">        taskService.complete(task.getId());</span>

<span class="nc" id="L668">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L669">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L670">        taskService.complete(task.getId());</span>

<span class="nc" id="L672">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L673">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentExecutionIntoSubProcess() {
<span class="nc" id="L678">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;);</span>

<span class="nc" id="L680">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L681">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L683">        changeStateEventListener.clear();</span>

<span class="nc" id="L685">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L686">                .moveExecutionToActivityId(task.getExecutionId(), &quot;subTask&quot;)</span>
<span class="nc" id="L687">                .changeState();</span>

<span class="nc" id="L689">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L690">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L692">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L693">        assertThat(executions).hasSize(3);</span>

        // Verify events
<span class="nc" id="L696">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L697">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L699">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L700">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L701">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L703">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L704">        event = iterator.next();</span>
<span class="nc" id="L705">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L706">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L708">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L709">        event = iterator.next();</span>
<span class="nc" id="L710">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.VARIABLE_CREATED);</span>
<span class="nc" id="L711">        assertThat(((FlowableVariableEvent) event).getVariableName()).isEqualTo(&quot;name&quot;);</span>
<span class="nc" id="L712">        assertThat(((FlowableVariableEvent) event).getVariableValue()).isEqualTo(&quot;John&quot;);</span>

<span class="nc" id="L714">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L715">        event = iterator.next();</span>
<span class="nc" id="L716">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L717">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L719">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L721">        taskService.complete(task.getId());</span>

<span class="nc" id="L723">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L724">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L725">        taskService.complete(task.getId());</span>

<span class="nc" id="L727">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L728">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityIntoSubProcessWithModeledDataObject() {
<span class="nc" id="L733">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;);</span>

<span class="nc" id="L735">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L736">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L738">        changeStateEventListener.clear();</span>

<span class="nc" id="L740">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L741">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L742">                .moveActivityIdTo(&quot;taskBefore&quot;, &quot;subTask&quot;)</span>
<span class="nc" id="L743">                .changeState();</span>

<span class="nc" id="L745">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L746">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L748">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L749">        assertThat(executions).hasSize(3);</span>

<span class="nc" id="L751">        Execution subProcessExecution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).activityId(&quot;subProcess&quot;)</span>
<span class="nc" id="L752">                .singleResult();</span>
<span class="nc" id="L753">        assertThat(runtimeService.getVariableLocal(subProcessExecution.getId(), &quot;name&quot;, String.class)).isNotNull();</span>
<span class="nc" id="L754">        DataObject nameDataObject = runtimeService.getDataObjectLocal(subProcessExecution.getId(), &quot;name&quot;);</span>
<span class="nc" id="L755">        assertThat(nameDataObject).isNotNull();</span>
<span class="nc" id="L756">        assertThat(nameDataObject.getValue()).isEqualTo(&quot;John&quot;);</span>

        // Verify events
<span class="nc" id="L759">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L760">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L762">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L763">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L764">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L766">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L767">        event = iterator.next();</span>
<span class="nc" id="L768">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L769">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L771">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L772">        event = iterator.next();</span>
<span class="nc" id="L773">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.VARIABLE_CREATED);</span>
<span class="nc" id="L774">        assertThat(((FlowableVariableEvent) event).getVariableName()).isEqualTo(&quot;name&quot;);</span>
<span class="nc" id="L775">        assertThat(((FlowableVariableEvent) event).getVariableValue()).isEqualTo(&quot;John&quot;);</span>

<span class="nc" id="L777">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L778">        event = iterator.next();</span>
<span class="nc" id="L779">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L780">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L782">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L784">        taskService.complete(task.getId());</span>

<span class="nc" id="L786">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L787">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L788">        taskService.complete(task.getId());</span>

<span class="nc" id="L790">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L791">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentExecutionIntoSubProcessWithModeledDataObject() {
<span class="nc" id="L796">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;);</span>

<span class="nc" id="L798">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L799">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L801">        changeStateEventListener.clear();</span>

<span class="nc" id="L803">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L804">                .moveExecutionToActivityId(task.getExecutionId(), &quot;subTask&quot;)</span>
<span class="nc" id="L805">                .changeState();</span>

<span class="nc" id="L807">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L808">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L810">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L811">        assertThat(executions).hasSize(3);</span>

<span class="nc" id="L813">        Execution subProcessExecution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).activityId(&quot;subProcess&quot;)</span>
<span class="nc" id="L814">                .singleResult();</span>
<span class="nc" id="L815">        assertThat(runtimeService.getVariableLocal(subProcessExecution.getId(), &quot;name&quot;, String.class)).isNotNull();</span>

<span class="nc" id="L817">        DataObject nameDataObject = runtimeService.getDataObjectLocal(subProcessExecution.getId(), &quot;name&quot;);</span>
<span class="nc" id="L818">        assertThat(nameDataObject).isNotNull();</span>
<span class="nc" id="L819">        assertThat(nameDataObject.getValue()).isEqualTo(&quot;John&quot;);</span>

        // Verify events
<span class="nc" id="L822">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L823">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L825">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L826">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L827">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L829">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L830">        event = iterator.next();</span>
<span class="nc" id="L831">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L832">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L834">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L835">        event = iterator.next();</span>
<span class="nc" id="L836">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.VARIABLE_CREATED);</span>
<span class="nc" id="L837">        assertThat(((FlowableVariableEvent) event).getVariableName()).isEqualTo(&quot;name&quot;);</span>
<span class="nc" id="L838">        assertThat(((FlowableVariableEvent) event).getVariableValue()).isEqualTo(&quot;John&quot;);</span>

<span class="nc" id="L840">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L841">        event = iterator.next();</span>
<span class="nc" id="L842">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L843">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L845">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L847">        taskService.complete(task.getId());</span>

<span class="nc" id="L849">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L850">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L851">        taskService.complete(task.getId());</span>

<span class="nc" id="L853">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L854">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskSubProcessWithTimer.bpmn20.xml&quot; })
    public void testSetCurrentActivityOutOfSubProcessWithTimer() {
<span class="nc" id="L859">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;);</span>
<span class="nc" id="L860">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L861">        taskService.complete(task.getId());</span>

<span class="nc" id="L863">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L864">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L866">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L867">        assertThat(timerJob).isNotNull();</span>

<span class="nc" id="L869">        changeStateEventListener.clear();</span>

<span class="nc" id="L871">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L872">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L873">                .moveActivityIdTo(&quot;subTask&quot;, &quot;taskBefore&quot;)</span>
<span class="nc" id="L874">                .changeState();</span>

<span class="nc" id="L876">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L877">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L879">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L880">        assertThat(executions).hasSize(2);</span>

<span class="nc" id="L882">        timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L883">        assertThat(timerJob).isNull();</span>

        // Verify events
<span class="nc" id="L886">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L887">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L889">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L890">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L891">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L893">        event = iterator.next();</span>
<span class="nc" id="L894">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.JOB_CANCELED);</span>
<span class="nc" id="L895">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) event;</span>
<span class="nc" id="L896">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L897">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc" id="L899">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L900">        event = iterator.next();</span>
<span class="nc" id="L901">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L902">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L904">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L905">        event = iterator.next();</span>
<span class="nc" id="L906">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L907">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L909">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L911">        taskService.complete(task.getId());</span>

<span class="nc" id="L913">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L914">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L916">        timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L917">        assertThat(timerJob).isNotNull();</span>

<span class="nc" id="L919">        taskService.complete(task.getId());</span>

<span class="nc" id="L921">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L922">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L923">        taskService.complete(task.getId());</span>

<span class="nc" id="L925">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L926">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskSubProcessWithTimer.bpmn20.xml&quot; })
    public void testSetCurrentExecutionOutOfSubProcessWithTimer() {
<span class="nc" id="L931">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;);</span>
<span class="nc" id="L932">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L933">        taskService.complete(task.getId());</span>

<span class="nc" id="L935">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L936">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L938">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L939">        assertThat(timerJob).isNotNull();</span>

<span class="nc" id="L941">        changeStateEventListener.clear();</span>

<span class="nc" id="L943">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L944">                .moveExecutionToActivityId(task.getExecutionId(), &quot;taskBefore&quot;)</span>
<span class="nc" id="L945">                .changeState();</span>

<span class="nc" id="L947">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L948">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L950">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L951">        assertThat(executions).hasSize(2);</span>

<span class="nc" id="L953">        timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L954">        assertThat(timerJob).isNull();</span>

        // Verify events
<span class="nc" id="L957">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L958">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L960">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L961">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L962">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L964">        event = iterator.next();</span>
<span class="nc" id="L965">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.JOB_CANCELED);</span>
<span class="nc" id="L966">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) event;</span>
<span class="nc" id="L967">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L968">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc" id="L970">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L971">        event = iterator.next();</span>
<span class="nc" id="L972">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L973">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L975">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L976">        event = iterator.next();</span>
<span class="nc" id="L977">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L978">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L980">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L982">        taskService.complete(task.getId());</span>

<span class="nc" id="L984">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L985">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L987">        timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L988">        assertThat(timerJob).isNotNull();</span>

<span class="nc" id="L990">        taskService.complete(task.getId());</span>

<span class="nc" id="L992">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L993">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L994">        taskService.complete(task.getId());</span>

<span class="nc" id="L996">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L997">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskSubProcessWithTimer.bpmn20.xml&quot; })
    public void testSetCurrentActivityToTaskInSubProcessWithTimer() {
<span class="nc" id="L1002">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;);</span>
<span class="nc" id="L1003">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1004">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1006">        changeStateEventListener.clear();</span>

<span class="nc" id="L1008">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1009">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1010">                .moveActivityIdTo(&quot;taskBefore&quot;, &quot;subTask&quot;)</span>
<span class="nc" id="L1011">                .changeState();</span>

<span class="nc" id="L1013">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1014">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1016">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1017">        assertThat(executions).hasSize(4);</span>

<span class="nc" id="L1019">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1020">        assertThat(timerJob).isNotNull();</span>

        // Verify events
<span class="nc" id="L1023">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L1024">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L1026">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L1027">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L1028">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1030">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1031">        event = iterator.next();</span>
<span class="nc" id="L1032">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1033">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L1035">        event = iterator.next();</span>
<span class="nc" id="L1036">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.TIMER_SCHEDULED);</span>
<span class="nc" id="L1037">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) event;</span>
<span class="nc" id="L1038">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L1039">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc" id="L1041">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1042">        event = iterator.next();</span>
<span class="nc" id="L1043">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1044">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1046">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L1048">        taskService.complete(task.getId());</span>

<span class="nc" id="L1050">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1051">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1052">        taskService.complete(task.getId());</span>

<span class="nc" id="L1054">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1055">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskSubProcessWithTimer.bpmn20.xml&quot; })
    public void testSetCurrentExecutionToTaskInSubProcessWithTimer() {
<span class="nc" id="L1060">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;);</span>
<span class="nc" id="L1061">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1062">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1064">        changeStateEventListener.clear();</span>

<span class="nc" id="L1066">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1067">                .moveExecutionToActivityId(task.getExecutionId(), &quot;subTask&quot;)</span>
<span class="nc" id="L1068">                .changeState();</span>

<span class="nc" id="L1070">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1071">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1073">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1074">        assertThat(executions).hasSize(4);</span>

<span class="nc" id="L1076">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1077">        assertThat(timerJob).isNotNull();</span>

        // Verify events
<span class="nc" id="L1080">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L1081">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L1083">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L1084">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L1085">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1087">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1088">        event = iterator.next();</span>
<span class="nc" id="L1089">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1090">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L1092">        event = iterator.next();</span>
<span class="nc" id="L1093">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.TIMER_SCHEDULED);</span>
<span class="nc" id="L1094">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) event;</span>
<span class="nc" id="L1095">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L1096">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc" id="L1098">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1099">        event = iterator.next();</span>
<span class="nc" id="L1100">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1101">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1103">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L1105">        taskService.complete(task.getId());</span>

<span class="nc" id="L1107">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1108">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1109">        taskService.complete(task.getId());</span>

<span class="nc" id="L1111">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1112">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskSubProcessWithTimer.bpmn20.xml&quot; })
    public void testSetCurrentActivityToTaskInSubProcessAndExecuteTimer() {
<span class="nc" id="L1117">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;);</span>
<span class="nc" id="L1118">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1119">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1121">        changeStateEventListener.clear();</span>

<span class="nc" id="L1123">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1124">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1125">                .moveActivityIdTo(&quot;taskBefore&quot;, &quot;subTask&quot;)</span>
<span class="nc" id="L1126">                .changeState();</span>

<span class="nc" id="L1128">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1129">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1131">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1132">        assertThat(timerJob).isNotNull();</span>

        // Verify events
<span class="nc" id="L1135">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L1136">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L1138">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L1139">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L1140">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1142">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1143">        event = iterator.next();</span>
<span class="nc" id="L1144">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1145">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L1147">        event = iterator.next();</span>
<span class="nc" id="L1148">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.TIMER_SCHEDULED);</span>
<span class="nc" id="L1149">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) event;</span>
<span class="nc" id="L1150">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L1151">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc" id="L1153">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1154">        event = iterator.next();</span>
<span class="nc" id="L1155">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1156">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1158">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L1160">        Job executableJob = managementService.moveTimerToExecutableJob(timerJob.getId());</span>
<span class="nc" id="L1161">        managementService.executeJob(executableJob.getId());</span>

<span class="nc" id="L1163">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1164">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskWithTimerInSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityOutOfSubProcessTaskWithTimer() {
<span class="nc" id="L1169">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;);</span>
<span class="nc" id="L1170">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1171">        taskService.complete(task.getId());</span>

<span class="nc" id="L1173">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1174">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1176">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1177">        assertThat(timerJob).isNotNull();</span>

<span class="nc" id="L1179">        changeStateEventListener.clear();</span>

<span class="nc" id="L1181">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1182">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1183">                .moveActivityIdTo(&quot;subTask&quot;, &quot;subTask2&quot;)</span>
<span class="nc" id="L1184">                .changeState();</span>

<span class="nc" id="L1186">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1187">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask2&quot;);</span>

<span class="nc" id="L1189">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1190">        assertThat(executions).hasSize(3);</span>

<span class="nc" id="L1192">        timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1193">        assertThat(timerJob).isNull();</span>

        // Verify events
<span class="nc" id="L1196">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L1197">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L1199">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L1200">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.JOB_CANCELED);</span>
<span class="nc" id="L1201">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) event;</span>
<span class="nc" id="L1202">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L1203">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc" id="L1205">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1206">        event = iterator.next();</span>
<span class="nc" id="L1207">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L1208">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1210">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1211">        event = iterator.next();</span>
<span class="nc" id="L1212">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1213">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask2&quot;);</span>

<span class="nc" id="L1215">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L1217">        taskService.complete(task.getId());</span>

<span class="nc" id="L1219">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1220">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1221">        taskService.complete(task.getId());</span>

<span class="nc" id="L1223">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1224">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskWithTimerInSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentExecutionOutOfSubProcessTaskWithTimer() {
<span class="nc" id="L1229">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;);</span>
<span class="nc" id="L1230">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1231">        taskService.complete(task.getId());</span>

<span class="nc" id="L1233">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1234">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1236">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1237">        assertThat(timerJob).isNotNull();</span>

<span class="nc" id="L1239">        changeStateEventListener.clear();</span>

<span class="nc" id="L1241">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1242">                .moveExecutionToActivityId(task.getExecutionId(), &quot;subTask2&quot;)</span>
<span class="nc" id="L1243">                .changeState();</span>

<span class="nc" id="L1245">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1246">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask2&quot;);</span>

<span class="nc" id="L1248">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1249">        assertThat(executions).hasSize(3);</span>

<span class="nc" id="L1251">        timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1252">        assertThat(timerJob).isNull();</span>

        // Verify events
<span class="nc" id="L1255">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L1256">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L1258">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L1259">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.JOB_CANCELED);</span>
<span class="nc" id="L1260">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) event;</span>
<span class="nc" id="L1261">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L1262">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc" id="L1264">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1265">        event = iterator.next();</span>
<span class="nc" id="L1266">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L1267">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1269">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1270">        event = iterator.next();</span>
<span class="nc" id="L1271">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1272">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask2&quot;);</span>

<span class="nc" id="L1274">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L1276">        taskService.complete(task.getId());</span>

<span class="nc" id="L1278">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1279">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1280">        taskService.complete(task.getId());</span>

<span class="nc" id="L1282">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1283">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskWithTimerInSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityToTaskWithTimerInSubProcess() {
<span class="nc" id="L1288">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;);</span>
<span class="nc" id="L1289">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1290">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1292">        changeStateEventListener.clear();</span>

<span class="nc" id="L1294">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1295">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1296">                .moveActivityIdTo(&quot;taskBefore&quot;, &quot;subTask&quot;)</span>
<span class="nc" id="L1297">                .changeState();</span>

        // Verify events
<span class="nc" id="L1300">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L1301">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L1303">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L1304">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L1305">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1307">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1308">        event = iterator.next();</span>
<span class="nc" id="L1309">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1310">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L1312">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1313">        event = iterator.next();</span>
<span class="nc" id="L1314">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1315">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1317">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1318">        event = iterator.next();</span>
<span class="nc" id="L1319">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.TIMER_SCHEDULED);</span>
<span class="nc" id="L1320">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) event;</span>
<span class="nc" id="L1321">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L1322">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc" id="L1324">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L1326">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1327">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>
<span class="nc" id="L1328">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1329">        assertThat(executions).hasSize(4);</span>
<span class="nc" id="L1330">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1331">        assertThat(timerJob).isNotNull();</span>
<span class="nc" id="L1332">        taskService.complete(task.getId());</span>

<span class="nc" id="L1334">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1335">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask2&quot;);</span>
<span class="nc" id="L1336">        taskService.complete(task.getId());</span>

<span class="nc" id="L1338">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1339">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1340">        taskService.complete(task.getId());</span>

<span class="nc" id="L1342">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1343">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskWithTimerInSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentExecutionToTaskWithTimerInSubProcess() {
<span class="nc" id="L1348">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;);</span>
<span class="nc" id="L1349">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1350">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1352">        changeStateEventListener.clear();</span>

<span class="nc" id="L1354">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1355">                .moveExecutionToActivityId(task.getExecutionId(), &quot;subTask&quot;)</span>
<span class="nc" id="L1356">                .changeState();</span>

<span class="nc" id="L1358">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1359">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>
<span class="nc" id="L1360">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1361">        assertThat(executions).hasSize(4);</span>
<span class="nc" id="L1362">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1363">        assertThat(timerJob).isNotNull();</span>

        // Verify events
<span class="nc" id="L1366">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L1367">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L1369">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L1370">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L1371">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1373">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1374">        event = iterator.next();</span>
<span class="nc" id="L1375">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1376">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L1378">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1379">        event = iterator.next();</span>
<span class="nc" id="L1380">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1381">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1383">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1384">        event = iterator.next();</span>

<span class="nc" id="L1386">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.TIMER_SCHEDULED);</span>
<span class="nc" id="L1387">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) event;</span>
<span class="nc" id="L1388">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L1389">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc" id="L1391">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L1393">        taskService.complete(task.getId());</span>

<span class="nc" id="L1395">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1396">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask2&quot;);</span>
<span class="nc" id="L1397">        taskService.complete(task.getId());</span>

<span class="nc" id="L1399">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1400">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1401">        taskService.complete(task.getId());</span>

<span class="nc" id="L1403">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1404">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskWithTimerInSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityToTaskWithTimerInSubProcessAndExecuteTimer() {
<span class="nc" id="L1409">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;);</span>
<span class="nc" id="L1410">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1411">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1413">        changeStateEventListener.clear();</span>

<span class="nc" id="L1415">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1416">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1417">                .moveActivityIdTo(&quot;taskBefore&quot;, &quot;subTask&quot;)</span>
<span class="nc" id="L1418">                .changeState();</span>

<span class="nc" id="L1420">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1421">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>
<span class="nc" id="L1422">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1423">        assertThat(executions).hasSize(4);</span>
<span class="nc" id="L1424">        Job timerJob = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1425">        assertThat(timerJob).isNotNull();</span>

        // Verify events
<span class="nc" id="L1428">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L1429">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L1431">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L1432">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L1433">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1435">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1436">        event = iterator.next();</span>
<span class="nc" id="L1437">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1438">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L1440">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1441">        event = iterator.next();</span>
<span class="nc" id="L1442">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1443">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1445">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1446">        event = iterator.next();</span>
<span class="nc" id="L1447">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.TIMER_SCHEDULED);</span>
<span class="nc" id="L1448">        FlowableEngineEntityEvent entityEvent = (FlowableEngineEntityEvent) event;</span>
<span class="nc" id="L1449">        Job timer = (Job) entityEvent.getEntity();</span>
<span class="nc" id="L1450">        assertThat(getJobActivityId(timer)).isEqualTo(&quot;boundaryTimerEvent&quot;);</span>

<span class="nc" id="L1452">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L1454">        Job executableTimerJob = managementService.moveTimerToExecutableJob(timerJob.getId());</span>
<span class="nc" id="L1455">        managementService.executeJob(executableTimerJob.getId());</span>

<span class="nc" id="L1457">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1458">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1459">        taskService.complete(task.getId());</span>

<span class="nc" id="L1461">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1462">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskNestedSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityIntoNestedSubProcessExecutionFromRoot() {
<span class="nc" id="L1467">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startNestedSubProcess&quot;);</span>
<span class="nc" id="L1468">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1469">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1471">        changeStateEventListener.clear();</span>

<span class="nc" id="L1473">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1474">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1475">                .moveActivityIdTo(&quot;taskBefore&quot;, &quot;nestedSubTask&quot;)</span>
<span class="nc" id="L1476">                .changeState();</span>

<span class="nc" id="L1478">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1479">        assertThat(executions)</span>
<span class="nc" id="L1480">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1481">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;nestedSubProcess&quot;, &quot;nestedSubTask&quot;);</span>
<span class="nc" id="L1482">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1483">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;nestedSubTask&quot;);</span>

        // Verify events
<span class="nc" id="L1486">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L1487">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L1489">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L1490">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L1491">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1493">        event = iterator.next();</span>
<span class="nc" id="L1494">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1495">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L1497">        event = iterator.next();</span>
<span class="nc" id="L1498">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1499">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubProcess&quot;);</span>

<span class="nc" id="L1501">        event = iterator.next();</span>
<span class="nc" id="L1502">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1503">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubTask&quot;);</span>

<span class="nc" id="L1505">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L1507">        taskService.complete(task.getId());</span>

<span class="nc" id="L1509">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1510">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTaskAfter&quot;);</span>
<span class="nc" id="L1511">        taskService.complete(task.getId());</span>

<span class="nc" id="L1513">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1514">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1515">        taskService.complete(task.getId());</span>

<span class="nc" id="L1517">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1518">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.oneTaskNestedSubProcessWithObject.bpmn20.xml&quot; })
    public void testSetCurrentActivityIntoNestedSubProcessExecutionFromRootWithDataObject() {
<span class="nc" id="L1523">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startNestedSubProcess&quot;);</span>
<span class="nc" id="L1524">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1525">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1527">        changeStateEventListener.clear();</span>

<span class="nc" id="L1529">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1530">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1531">                .moveActivityIdTo(&quot;taskBefore&quot;, &quot;nestedSubTask&quot;)</span>
<span class="nc" id="L1532">                .changeState();</span>

<span class="nc" id="L1534">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1535">        assertThat(executions)</span>
<span class="nc" id="L1536">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1537">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;nestedSubProcess&quot;, &quot;nestedSubTask&quot;);</span>
<span class="nc" id="L1538">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1539">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;nestedSubTask&quot;);</span>

<span class="nc" id="L1541">        Execution nestedSubProcess = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).activityId(&quot;nestedSubProcess&quot;)</span>
<span class="nc" id="L1542">                .singleResult();</span>
<span class="nc" id="L1543">        assertThat(runtimeService.getVariableLocal(nestedSubProcess.getId(), &quot;name&quot;, String.class)).isNotNull();</span>
<span class="nc" id="L1544">        DataObject nameDataObject = runtimeService.getDataObjectLocal(nestedSubProcess.getId(), &quot;name&quot;);</span>
<span class="nc" id="L1545">        assertThat(nameDataObject).isNotNull();</span>
<span class="nc" id="L1546">        assertThat(nameDataObject.getValue()).isEqualTo(&quot;John&quot;);</span>

        // Verify events
<span class="nc" id="L1549">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L1550">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L1552">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L1553">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L1554">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1556">        event = iterator.next();</span>
<span class="nc" id="L1557">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1558">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L1560">        event = iterator.next();</span>
<span class="nc" id="L1561">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1562">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubProcess&quot;);</span>

<span class="nc" id="L1564">        event = iterator.next();</span>
<span class="nc" id="L1565">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.VARIABLE_CREATED);</span>
<span class="nc" id="L1566">        assertThat(((FlowableVariableEvent) event).getVariableName()).isEqualTo(&quot;name&quot;);</span>
<span class="nc" id="L1567">        assertThat(((FlowableVariableEvent) event).getVariableValue()).isEqualTo(&quot;John&quot;);</span>

<span class="nc" id="L1569">        event = iterator.next();</span>
<span class="nc" id="L1570">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1571">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubTask&quot;);</span>

<span class="nc" id="L1573">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L1575">        taskService.complete(task.getId());</span>

<span class="nc" id="L1577">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1578">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTaskAfter&quot;);</span>
<span class="nc" id="L1579">        taskService.complete(task.getId());</span>

<span class="nc" id="L1581">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1582">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1583">        taskService.complete(task.getId());</span>

<span class="nc" id="L1585">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1586">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskNestedSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentExecutionIntoNestedSubProcessExecutionFromRoot() {
<span class="nc" id="L1591">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startNestedSubProcess&quot;);</span>
<span class="nc" id="L1592">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1593">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1595">        changeStateEventListener.clear();</span>

<span class="nc" id="L1597">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1598">                .moveExecutionToActivityId(task.getExecutionId(), &quot;nestedSubTask&quot;)</span>
<span class="nc" id="L1599">                .changeState();</span>

<span class="nc" id="L1601">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1602">        assertThat(executions)</span>
<span class="nc" id="L1603">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1604">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;nestedSubProcess&quot;, &quot;nestedSubTask&quot;);</span>
<span class="nc" id="L1605">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1606">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;nestedSubTask&quot;);</span>

        // Verify events
<span class="nc" id="L1609">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L1610">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L1612">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L1613">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L1614">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1616">        event = iterator.next();</span>
<span class="nc" id="L1617">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1618">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L1620">        event = iterator.next();</span>
<span class="nc" id="L1621">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1622">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubProcess&quot;);</span>

<span class="nc" id="L1624">        event = iterator.next();</span>
<span class="nc" id="L1625">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1626">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubTask&quot;);</span>

<span class="nc" id="L1628">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L1630">        taskService.complete(task.getId());</span>

<span class="nc" id="L1632">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1633">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTaskAfter&quot;);</span>
<span class="nc" id="L1634">        taskService.complete(task.getId());</span>

<span class="nc" id="L1636">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1637">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1638">        taskService.complete(task.getId());</span>

<span class="nc" id="L1640">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1641">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.oneTaskNestedSubProcessWithObject.bpmn20.xml&quot; })
    public void testSetCurrentExecutionIntoNestedSubProcessExecutionFromRootWithDataObject() {
<span class="nc" id="L1646">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startNestedSubProcess&quot;);</span>
<span class="nc" id="L1647">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1648">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1650">        changeStateEventListener.clear();</span>

<span class="nc" id="L1652">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1653">                .moveExecutionToActivityId(task.getExecutionId(), &quot;nestedSubTask&quot;)</span>
<span class="nc" id="L1654">                .changeState();</span>

<span class="nc" id="L1656">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1657">        assertThat(executions)</span>
<span class="nc" id="L1658">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1659">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;nestedSubProcess&quot;, &quot;nestedSubTask&quot;);</span>
<span class="nc" id="L1660">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1661">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;nestedSubTask&quot;);</span>

<span class="nc" id="L1663">        Execution nestedSubProcess = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).activityId(&quot;nestedSubProcess&quot;)</span>
<span class="nc" id="L1664">                .singleResult();</span>
<span class="nc" id="L1665">        assertThat(runtimeService.getVariableLocal(nestedSubProcess.getId(), &quot;name&quot;, String.class)).isNotNull();</span>
<span class="nc" id="L1666">        DataObject nameDataObject = runtimeService.getDataObjectLocal(nestedSubProcess.getId(), &quot;name&quot;);</span>
<span class="nc" id="L1667">        assertThat(nameDataObject).isNotNull();</span>
<span class="nc" id="L1668">        assertThat(nameDataObject.getValue()).isEqualTo(&quot;John&quot;);</span>

        // Verify events
<span class="nc" id="L1671">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L1672">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L1674">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L1675">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L1676">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L1678">        event = iterator.next();</span>
<span class="nc" id="L1679">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1680">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L1682">        event = iterator.next();</span>
<span class="nc" id="L1683">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1684">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubProcess&quot;);</span>

<span class="nc" id="L1686">        event = iterator.next();</span>
<span class="nc" id="L1687">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.VARIABLE_CREATED);</span>
<span class="nc" id="L1688">        assertThat(((FlowableVariableEvent) event).getVariableName()).isEqualTo(&quot;name&quot;);</span>
<span class="nc" id="L1689">        assertThat(((FlowableVariableEvent) event).getVariableValue()).isEqualTo(&quot;John&quot;);</span>

<span class="nc" id="L1691">        event = iterator.next();</span>
<span class="nc" id="L1692">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1693">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubTask&quot;);</span>

<span class="nc" id="L1695">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L1697">        taskService.complete(task.getId());</span>

<span class="nc" id="L1699">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1700">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTaskAfter&quot;);</span>
<span class="nc" id="L1701">        taskService.complete(task.getId());</span>

<span class="nc" id="L1703">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1704">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1705">        taskService.complete(task.getId());</span>

<span class="nc" id="L1707">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1708">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskNestedSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityIntoNestedSubProcessExecutionFromOuter() {
<span class="nc" id="L1713">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startNestedSubProcess&quot;);</span>
<span class="nc" id="L1714">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1715">        taskService.complete(task.getId());</span>
<span class="nc" id="L1716">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1717">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1719">        changeStateEventListener.clear();</span>

<span class="nc" id="L1721">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1722">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1723">                .moveActivityIdTo(&quot;subTask&quot;, &quot;nestedSubTask&quot;)</span>
<span class="nc" id="L1724">                .changeState();</span>

<span class="nc" id="L1726">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1727">        assertThat(executions)</span>
<span class="nc" id="L1728">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1729">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;nestedSubProcess&quot;, &quot;nestedSubTask&quot;);</span>
<span class="nc" id="L1730">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1731">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;nestedSubTask&quot;);</span>

        // Verify events
<span class="nc" id="L1734">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L1735">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L1737">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L1738">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L1739">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1741">        event = iterator.next();</span>
<span class="nc" id="L1742">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1743">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubProcess&quot;);</span>

<span class="nc" id="L1745">        event = iterator.next();</span>
<span class="nc" id="L1746">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1747">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubTask&quot;);</span>

<span class="nc" id="L1749">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L1751">        taskService.complete(task.getId());</span>

<span class="nc" id="L1753">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1754">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTaskAfter&quot;);</span>
<span class="nc" id="L1755">        taskService.complete(task.getId());</span>

<span class="nc" id="L1757">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1758">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1759">        taskService.complete(task.getId());</span>

<span class="nc" id="L1761">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1762">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.oneTaskNestedSubProcessWithObject.bpmn20.xml&quot; })
    public void testSetCurrentActivityIntoNestedSubProcessExecutionFromOuterWithDataObject() {
<span class="nc" id="L1767">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startNestedSubProcess&quot;);</span>
<span class="nc" id="L1768">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1769">        taskService.complete(task.getId());</span>
<span class="nc" id="L1770">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1771">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1773">        changeStateEventListener.clear();</span>

<span class="nc" id="L1775">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1776">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1777">                .moveActivityIdTo(&quot;subTask&quot;, &quot;nestedSubTask&quot;)</span>
<span class="nc" id="L1778">                .changeState();</span>

<span class="nc" id="L1780">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1781">        assertThat(executions)</span>
<span class="nc" id="L1782">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1783">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;nestedSubProcess&quot;, &quot;nestedSubTask&quot;);</span>
<span class="nc" id="L1784">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1785">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;nestedSubTask&quot;);</span>

<span class="nc" id="L1787">        Execution nestedSubProcess = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).activityId(&quot;nestedSubProcess&quot;)</span>
<span class="nc" id="L1788">                .singleResult();</span>
<span class="nc" id="L1789">        assertThat(runtimeService.getVariableLocal(nestedSubProcess.getId(), &quot;name&quot;, String.class)).isNotNull();</span>
<span class="nc" id="L1790">        DataObject nameDataObject = runtimeService.getDataObjectLocal(nestedSubProcess.getId(), &quot;name&quot;);</span>
<span class="nc" id="L1791">        assertThat(nameDataObject).isNotNull();</span>
<span class="nc" id="L1792">        assertThat(nameDataObject.getValue()).isEqualTo(&quot;John&quot;);</span>

        // Verify events
<span class="nc" id="L1795">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L1796">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L1798">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L1799">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L1800">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1802">        event = iterator.next();</span>
<span class="nc" id="L1803">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1804">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubProcess&quot;);</span>

<span class="nc" id="L1806">        event = iterator.next();</span>
<span class="nc" id="L1807">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.VARIABLE_CREATED);</span>
<span class="nc" id="L1808">        assertThat(((FlowableVariableEvent) event).getVariableName()).isEqualTo(&quot;name&quot;);</span>
<span class="nc" id="L1809">        assertThat(((FlowableVariableEvent) event).getVariableValue()).isEqualTo(&quot;John&quot;);</span>

<span class="nc" id="L1811">        event = iterator.next();</span>
<span class="nc" id="L1812">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1813">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubTask&quot;);</span>

<span class="nc" id="L1815">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L1817">        taskService.complete(task.getId());</span>

<span class="nc" id="L1819">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1820">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTaskAfter&quot;);</span>
<span class="nc" id="L1821">        taskService.complete(task.getId());</span>

<span class="nc" id="L1823">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1824">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1825">        taskService.complete(task.getId());</span>

<span class="nc" id="L1827">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1828">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskNestedSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentExecutionIntoNestedSubProcessExecutionFromOuter() {
<span class="nc" id="L1833">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startNestedSubProcess&quot;);</span>
<span class="nc" id="L1834">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1835">        taskService.complete(task.getId());</span>
<span class="nc" id="L1836">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1837">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1839">        changeStateEventListener.clear();</span>

<span class="nc" id="L1841">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1842">                .moveExecutionToActivityId(task.getExecutionId(), &quot;nestedSubTask&quot;)</span>
<span class="nc" id="L1843">                .changeState();</span>

<span class="nc" id="L1845">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1846">        assertThat(executions)</span>
<span class="nc" id="L1847">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1848">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;nestedSubProcess&quot;, &quot;nestedSubTask&quot;);</span>
<span class="nc" id="L1849">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1850">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;nestedSubTask&quot;);</span>

        // Verify events
<span class="nc" id="L1853">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L1854">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L1856">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L1857">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L1858">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1860">        event = iterator.next();</span>
<span class="nc" id="L1861">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1862">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubProcess&quot;);</span>

<span class="nc" id="L1864">        event = iterator.next();</span>
<span class="nc" id="L1865">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1866">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubTask&quot;);</span>

<span class="nc" id="L1868">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L1870">        taskService.complete(task.getId());</span>

<span class="nc" id="L1872">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1873">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTaskAfter&quot;);</span>
<span class="nc" id="L1874">        taskService.complete(task.getId());</span>

<span class="nc" id="L1876">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1877">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1878">        taskService.complete(task.getId());</span>

<span class="nc" id="L1880">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1881">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.oneTaskNestedSubProcessWithObject.bpmn20.xml&quot; })
    public void testSetCurrentExecutionIntoNestedSubProcessExecutionFromOuterWithDataObject() {
<span class="nc" id="L1886">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startNestedSubProcess&quot;);</span>
<span class="nc" id="L1887">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1888">        taskService.complete(task.getId());</span>
<span class="nc" id="L1889">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1890">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1892">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1893">        assertThat(executions).hasSize(2);</span>

<span class="nc" id="L1895">        changeStateEventListener.clear();</span>

<span class="nc" id="L1897">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1898">                .moveExecutionToActivityId(task.getExecutionId(), &quot;nestedSubTask&quot;)</span>
<span class="nc" id="L1899">                .changeState();</span>

<span class="nc" id="L1901">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1902">        assertThat(executions)</span>
<span class="nc" id="L1903">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1904">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;nestedSubProcess&quot;, &quot;nestedSubTask&quot;);</span>
<span class="nc" id="L1905">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1906">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;nestedSubTask&quot;);</span>

<span class="nc" id="L1908">        Execution nestedSubProcess = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).activityId(&quot;nestedSubProcess&quot;)</span>
<span class="nc" id="L1909">                .singleResult();</span>
<span class="nc" id="L1910">        assertThat(runtimeService.getVariableLocal(nestedSubProcess.getId(), &quot;name&quot;, String.class)).isNotNull();</span>
<span class="nc" id="L1911">        DataObject nameDataObject = runtimeService.getDataObjectLocal(nestedSubProcess.getId(), &quot;name&quot;);</span>
<span class="nc" id="L1912">        assertThat(nameDataObject).isNotNull();</span>
<span class="nc" id="L1913">        assertThat(nameDataObject.getValue()).isEqualTo(&quot;John&quot;);</span>

        // Verify events
<span class="nc" id="L1916">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L1917">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L1919">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L1920">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L1921">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L1923">        event = iterator.next();</span>
<span class="nc" id="L1924">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1925">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubProcess&quot;);</span>

<span class="nc" id="L1927">        event = iterator.next();</span>
<span class="nc" id="L1928">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.VARIABLE_CREATED);</span>
<span class="nc" id="L1929">        assertThat(((FlowableVariableEvent) event).getVariableName()).isEqualTo(&quot;name&quot;);</span>
<span class="nc" id="L1930">        assertThat(((FlowableVariableEvent) event).getVariableValue()).isEqualTo(&quot;John&quot;);</span>

<span class="nc" id="L1932">        event = iterator.next();</span>
<span class="nc" id="L1933">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1934">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubTask&quot;);</span>

<span class="nc" id="L1936">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L1938">        taskService.complete(task.getId());</span>

<span class="nc" id="L1940">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1941">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTaskAfter&quot;);</span>
<span class="nc" id="L1942">        taskService.complete(task.getId());</span>

<span class="nc" id="L1944">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1945">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L1946">        taskService.complete(task.getId());</span>

<span class="nc" id="L1948">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1949">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskNestedSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityOutOfNestedSubProcessExecution() {
<span class="nc" id="L1954">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startNestedSubProcess&quot;);</span>
<span class="nc" id="L1955">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1956">        taskService.complete(task.getId());</span>

<span class="nc" id="L1958">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1959">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>
<span class="nc" id="L1960">        taskService.complete(task.getId());</span>

<span class="nc" id="L1962">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1963">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;nestedSubTask&quot;);</span>

<span class="nc" id="L1965">        changeStateEventListener.clear();</span>

<span class="nc" id="L1967">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1968">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1969">                .moveActivityIdTo(&quot;nestedSubTask&quot;, &quot;subTaskAfter&quot;)</span>
<span class="nc" id="L1970">                .changeState();</span>

<span class="nc" id="L1972">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1973">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTaskAfter&quot;);</span>

<span class="nc" id="L1975">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1976">        assertThat(executions).hasSize(3);</span>

        // Verify events
<span class="nc" id="L1979">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L1980">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L1982">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L1983">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L1984">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubTask&quot;);</span>

<span class="nc" id="L1986">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1987">        event = iterator.next();</span>
<span class="nc" id="L1988">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L1989">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubProcess&quot;);</span>

<span class="nc" id="L1991">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L1992">        event = iterator.next();</span>
<span class="nc" id="L1993">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L1994">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTaskAfter&quot;);</span>

<span class="nc" id="L1996">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L1998">        taskService.complete(task.getId());</span>

<span class="nc" id="L2000">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2001">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L2002">        taskService.complete(task.getId());</span>

<span class="nc" id="L2004">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2005">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskNestedSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentExecutionOutOfNestedSubProcessExecution() {
<span class="nc" id="L2010">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startNestedSubProcess&quot;);</span>
<span class="nc" id="L2011">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2012">        taskService.complete(task.getId());</span>

<span class="nc" id="L2014">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2015">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>
<span class="nc" id="L2016">        taskService.complete(task.getId());</span>

<span class="nc" id="L2018">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2019">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;nestedSubTask&quot;);</span>

<span class="nc" id="L2021">        changeStateEventListener.clear();</span>

<span class="nc" id="L2023">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L2024">                .moveExecutionToActivityId(task.getExecutionId(), &quot;subTaskAfter&quot;)</span>
<span class="nc" id="L2025">                .changeState();</span>

<span class="nc" id="L2027">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2028">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTaskAfter&quot;);</span>

<span class="nc" id="L2030">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2031">        assertThat(executions).hasSize(3);</span>

        // Verify events
<span class="nc" id="L2034">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L2035">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L2037">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L2038">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L2039">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubTask&quot;);</span>

<span class="nc" id="L2041">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L2042">        event = iterator.next();</span>
<span class="nc" id="L2043">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L2044">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubProcess&quot;);</span>

<span class="nc" id="L2046">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L2047">        event = iterator.next();</span>
<span class="nc" id="L2048">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L2049">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTaskAfter&quot;);</span>

<span class="nc" id="L2051">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L2053">        taskService.complete(task.getId());</span>

<span class="nc" id="L2055">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2056">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L2057">        taskService.complete(task.getId());</span>

<span class="nc" id="L2059">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2060">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskNestedSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityOutOfNestedSubProcessExecutionIntoContainingSubProcess() {
<span class="nc" id="L2065">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startNestedSubProcess&quot;);</span>
<span class="nc" id="L2066">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2067">        taskService.complete(task.getId());</span>

<span class="nc" id="L2069">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2070">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>
<span class="nc" id="L2071">        taskService.complete(task.getId());</span>

<span class="nc" id="L2073">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2074">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;nestedSubTask&quot;);</span>

<span class="nc" id="L2076">        changeStateEventListener.clear();</span>

<span class="nc" id="L2078">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L2079">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2080">                .moveActivityIdTo(&quot;nestedSubTask&quot;, &quot;subTask&quot;)</span>
<span class="nc" id="L2081">                .changeState();</span>

<span class="nc" id="L2083">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2084">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>
<span class="nc" id="L2085">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2086">        assertThat(executions).hasSize(3);</span>

        // Verify events
<span class="nc" id="L2089">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L2090">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L2092">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L2093">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L2094">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubTask&quot;);</span>

<span class="nc" id="L2096">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L2097">        event = iterator.next();</span>
<span class="nc" id="L2098">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L2099">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubProcess&quot;);</span>

<span class="nc" id="L2101">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L2102">        event = iterator.next();</span>
<span class="nc" id="L2103">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L2104">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L2106">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L2108">        taskService.complete(task.getId());</span>

<span class="nc" id="L2110">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2111">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;nestedSubTask&quot;);</span>
<span class="nc" id="L2112">        taskService.complete(task.getId());</span>

<span class="nc" id="L2114">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2115">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTaskAfter&quot;);</span>
<span class="nc" id="L2116">        taskService.complete(task.getId());</span>

<span class="nc" id="L2118">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2119">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L2120">        taskService.complete(task.getId());</span>

<span class="nc" id="L2122">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2123">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskNestedSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentExecutionOutOfNestedSubProcessExecutionIntoContainingSubProcess() {
<span class="nc" id="L2128">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startNestedSubProcess&quot;);</span>
<span class="nc" id="L2129">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2130">        taskService.complete(task.getId());</span>

<span class="nc" id="L2132">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2133">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>
<span class="nc" id="L2134">        taskService.complete(task.getId());</span>

<span class="nc" id="L2136">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2137">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;nestedSubTask&quot;);</span>

<span class="nc" id="L2139">        changeStateEventListener.clear();</span>

<span class="nc" id="L2141">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L2142">                .moveExecutionToActivityId(task.getExecutionId(), &quot;subTask&quot;)</span>
<span class="nc" id="L2143">                .changeState();</span>

<span class="nc" id="L2145">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2146">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>
<span class="nc" id="L2147">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2148">        assertThat(executions).hasSize(3);</span>

        // Verify events
<span class="nc" id="L2151">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L2152">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L2154">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L2155">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L2156">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubTask&quot;);</span>

<span class="nc" id="L2158">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L2159">        event = iterator.next();</span>
<span class="nc" id="L2160">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L2161">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;nestedSubProcess&quot;);</span>

<span class="nc" id="L2163">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L2164">        event = iterator.next();</span>
<span class="nc" id="L2165">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L2166">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L2168">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L2170">        taskService.complete(task.getId());</span>

<span class="nc" id="L2172">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2173">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;nestedSubTask&quot;);</span>
<span class="nc" id="L2174">        taskService.complete(task.getId());</span>

<span class="nc" id="L2176">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2177">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTaskAfter&quot;);</span>
<span class="nc" id="L2178">        taskService.complete(task.getId());</span>

<span class="nc" id="L2180">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2181">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L2182">        taskService.complete(task.getId());</span>

<span class="nc" id="L2184">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2185">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/taskTwoSubProcesses.bpmn20.xml&quot; })
    public void testSetCurrentActivityFromSubProcessToAnotherSubProcess() {
<span class="nc" id="L2190">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;twoSubProcesses&quot;);</span>
<span class="nc" id="L2191">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2192">        taskService.complete(task.getId());</span>

<span class="nc" id="L2194">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2195">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subtask&quot;);</span>

<span class="nc" id="L2197">        changeStateEventListener.clear();</span>

<span class="nc" id="L2199">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L2200">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2201">                .moveActivityIdTo(&quot;subtask&quot;, &quot;subtask2&quot;)</span>
<span class="nc" id="L2202">                .changeState();</span>

<span class="nc" id="L2204">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2205">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subtask2&quot;);</span>

<span class="nc" id="L2207">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2208">        assertThat(executions).hasSize(3);</span>

        // Verify events
<span class="nc" id="L2211">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L2212">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L2214">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L2215">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L2216">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subtask&quot;);</span>

<span class="nc" id="L2218">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L2219">        event = iterator.next();</span>
<span class="nc" id="L2220">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L2221">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L2223">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L2224">        event = iterator.next();</span>
<span class="nc" id="L2225">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L2226">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess2&quot;);</span>

<span class="nc" id="L2228">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L2229">        event = iterator.next();</span>
<span class="nc" id="L2230">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L2231">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subtask2&quot;);</span>

<span class="nc" id="L2233">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L2235">        taskService.complete(task.getId());</span>

<span class="nc" id="L2237">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2238">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L2239">        taskService.complete(task.getId());</span>

<span class="nc" id="L2241">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2242">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/taskTwoSubProcesses.bpmn20.xml&quot; })
    public void testSetCurrentExecutionFromSubProcessToAnotherSubProcess() {
<span class="nc" id="L2247">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;twoSubProcesses&quot;);</span>
<span class="nc" id="L2248">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2249">        taskService.complete(task.getId());</span>

<span class="nc" id="L2251">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2252">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subtask&quot;);</span>

<span class="nc" id="L2254">        changeStateEventListener.clear();</span>

<span class="nc" id="L2256">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L2257">                .moveExecutionToActivityId(task.getExecutionId(), &quot;subtask2&quot;)</span>
<span class="nc" id="L2258">                .changeState();</span>

<span class="nc" id="L2260">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2261">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subtask2&quot;);</span>

<span class="nc" id="L2263">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2264">        assertThat(executions).hasSize(3);</span>

        // Verify events
<span class="nc" id="L2267">        Iterator&lt;FlowableEvent&gt; iterator = changeStateEventListener.iterator();</span>
<span class="nc" id="L2268">        assertThat(iterator.hasNext()).isTrue();</span>

<span class="nc" id="L2270">        FlowableEvent event = iterator.next();</span>
<span class="nc" id="L2271">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L2272">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subtask&quot;);</span>

<span class="nc" id="L2274">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L2275">        event = iterator.next();</span>
<span class="nc" id="L2276">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_CANCELLED);</span>
<span class="nc" id="L2277">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess&quot;);</span>

<span class="nc" id="L2279">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L2280">        event = iterator.next();</span>
<span class="nc" id="L2281">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L2282">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subProcess2&quot;);</span>

<span class="nc" id="L2284">        assertThat(iterator.hasNext()).isTrue();</span>
<span class="nc" id="L2285">        event = iterator.next();</span>
<span class="nc" id="L2286">        assertThat(event.getType()).isEqualTo(FlowableEngineEventType.ACTIVITY_STARTED);</span>
<span class="nc" id="L2287">        assertThat(((FlowableActivityEvent) event).getActivityId()).isEqualTo(&quot;subtask2&quot;);</span>

<span class="nc" id="L2289">        assertThat(iterator.hasNext()).isFalse();</span>

<span class="nc" id="L2291">        taskService.complete(task.getId());</span>

<span class="nc" id="L2293">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2294">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L2295">        taskService.complete(task.getId());</span>

<span class="nc" id="L2297">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2298">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityForSubProcessWithVariables() {
<span class="nc" id="L2303">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;);</span>
<span class="nc" id="L2304">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2305">        taskService.complete(task.getId());</span>

<span class="nc" id="L2307">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2308">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L2310">        changeStateEventListener.clear();</span>

<span class="nc" id="L2312">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L2313">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2314">                .moveActivityIdTo(&quot;subTask&quot;, &quot;taskBefore&quot;)</span>
<span class="nc" id="L2315">                .processVariable(&quot;processVar1&quot;, &quot;test&quot;)</span>
<span class="nc" id="L2316">                .processVariable(&quot;processVar2&quot;, 10)</span>
<span class="nc" id="L2317">                .localVariable(&quot;taskBefore&quot;, &quot;localVar1&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L2318">                .localVariable(&quot;taskBefore&quot;, &quot;localVar2&quot;, 20)</span>
<span class="nc" id="L2319">                .changeState();</span>

<span class="nc" id="L2321">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2322">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L2324">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2325">        assertThat(executions).hasSize(2);</span>

<span class="nc" id="L2327">        Map&lt;String, Object&gt; processVariables = runtimeService.getVariables(processInstance.getId());</span>
<span class="nc" id="L2328">        assertThat(processVariables)</span>
<span class="nc" id="L2329">                .contains(</span>
<span class="nc" id="L2330">                        entry(&quot;processVar1&quot;, &quot;test&quot;),</span>
<span class="nc" id="L2331">                        entry(&quot;processVar2&quot;, 10)</span>
                )
<span class="nc" id="L2333">                .doesNotContainKeys(&quot;localVar1&quot;, &quot;localVar2&quot;);</span>

<span class="nc" id="L2335">        Execution execution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).activityId(&quot;taskBefore&quot;).singleResult();</span>
<span class="nc" id="L2336">        Map&lt;String, Object&gt; localVariables = runtimeService.getVariablesLocal(execution.getId());</span>
<span class="nc" id="L2337">        assertThat(localVariables)</span>
<span class="nc" id="L2338">                .contains(</span>
<span class="nc" id="L2339">                        entry(&quot;localVar1&quot;, &quot;test2&quot;),</span>
<span class="nc" id="L2340">                        entry(&quot;localVar2&quot;, 20)</span>
                );

        // Verify events
<span class="nc" id="L2344">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L2345">                .extracting(FlowableEvent::getType)</span>
<span class="nc" id="L2346">                .containsExactly(</span>
                        FlowableEngineEventType.VARIABLE_CREATED,
                        FlowableEngineEventType.VARIABLE_CREATED,
                        FlowableEngineEventType.ACTIVITY_CANCELLED,
                        FlowableEngineEventType.ACTIVITY_CANCELLED,
                        FlowableEngineEventType.VARIABLE_CREATED,
                        FlowableEngineEventType.VARIABLE_CREATED,
                        FlowableEngineEventType.ACTIVITY_STARTED
                );

<span class="nc" id="L2356">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L2357">                .filteredOn(stateEvent -&gt; stateEvent instanceof FlowableVariableEvent)</span>
<span class="nc" id="L2358">                .extracting(</span>
<span class="nc" id="L2359">                        stateEvent -&gt; ((FlowableVariableEvent) stateEvent).getVariableName(),</span>
<span class="nc" id="L2360">                        stateEvent -&gt; ((FlowableVariableEvent) stateEvent).getVariableValue()</span>
                )
<span class="nc" id="L2362">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2363">                        tuple(&quot;processVar1&quot;, &quot;test&quot;),</span>
<span class="nc" id="L2364">                        tuple(&quot;processVar2&quot;, 10),</span>
<span class="nc" id="L2365">                        tuple(&quot;localVar1&quot;, &quot;test2&quot;),</span>
<span class="nc" id="L2366">                        tuple(&quot;localVar2&quot;, 20)</span>
                );

<span class="nc" id="L2369">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L2370">                .filteredOn(stateEvent -&gt; stateEvent instanceof FlowableActivityEvent)</span>
<span class="nc" id="L2371">                .extracting(stateEvent -&gt; ((FlowableActivityEvent) stateEvent).getActivityId())</span>
<span class="nc" id="L2372">                .containsExactlyInAnyOrder(</span>
                        &quot;subTask&quot;,
                        &quot;subProcess&quot;,
                        &quot;taskBefore&quot;
                );

<span class="nc" id="L2378">        taskService.complete(task.getId());</span>

<span class="nc" id="L2380">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2381">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>
<span class="nc" id="L2382">        taskService.complete(task.getId());</span>

<span class="nc" id="L2384">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2385">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L2386">        taskService.complete(task.getId());</span>

<span class="nc" id="L2388">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2389">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentExecutionForSubProcessWithVariables() {
<span class="nc" id="L2394">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;);</span>
<span class="nc" id="L2395">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2396">        taskService.complete(task.getId());</span>

<span class="nc" id="L2398">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2399">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L2401">        changeStateEventListener.clear();</span>

<span class="nc" id="L2403">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L2404">                .moveExecutionToActivityId(task.getExecutionId(), &quot;taskBefore&quot;)</span>
<span class="nc" id="L2405">                .processVariable(&quot;processVar1&quot;, &quot;test&quot;)</span>
<span class="nc" id="L2406">                .processVariable(&quot;processVar2&quot;, 10)</span>
<span class="nc" id="L2407">                .localVariable(&quot;taskBefore&quot;, &quot;localVar1&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L2408">                .localVariable(&quot;taskBefore&quot;, &quot;localVar2&quot;, 20)</span>
<span class="nc" id="L2409">                .changeState();</span>

<span class="nc" id="L2411">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2412">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskBefore&quot;);</span>

<span class="nc" id="L2414">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2415">        assertThat(executions).hasSize(2);</span>

<span class="nc" id="L2417">        Map&lt;String, Object&gt; processVariables = runtimeService.getVariables(processInstance.getId());</span>
<span class="nc" id="L2418">        assertThat(processVariables)</span>
<span class="nc" id="L2419">                .contains(</span>
<span class="nc" id="L2420">                        entry(&quot;processVar1&quot;, &quot;test&quot;),</span>
<span class="nc" id="L2421">                        entry(&quot;processVar2&quot;, 10)</span>
                )
<span class="nc" id="L2423">                .doesNotContainKeys(&quot;localVar1&quot;, &quot;localVar2&quot;);</span>

<span class="nc" id="L2425">        Execution execution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).activityId(&quot;taskBefore&quot;).singleResult();</span>
<span class="nc" id="L2426">        Map&lt;String, Object&gt; localVariables = runtimeService.getVariablesLocal(execution.getId());</span>
<span class="nc" id="L2427">        assertThat(localVariables)</span>
<span class="nc" id="L2428">                .contains(</span>
<span class="nc" id="L2429">                        entry(&quot;localVar1&quot;, &quot;test2&quot;),</span>
<span class="nc" id="L2430">                        entry(&quot;localVar2&quot;, 20)</span>
                );

        // Verify events
<span class="nc" id="L2434">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L2435">                .extracting(FlowableEvent::getType)</span>
<span class="nc" id="L2436">                .containsExactly(</span>
                        FlowableEngineEventType.VARIABLE_CREATED,
                        FlowableEngineEventType.VARIABLE_CREATED,
                        FlowableEngineEventType.ACTIVITY_CANCELLED,
                        FlowableEngineEventType.ACTIVITY_CANCELLED,
                        FlowableEngineEventType.VARIABLE_CREATED,
                        FlowableEngineEventType.VARIABLE_CREATED,
                        FlowableEngineEventType.ACTIVITY_STARTED
                );

<span class="nc" id="L2446">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L2447">                .filteredOn(stateEvent -&gt; stateEvent instanceof FlowableVariableEvent)</span>
<span class="nc" id="L2448">                .extracting(</span>
<span class="nc" id="L2449">                        stateEvent -&gt; ((FlowableVariableEvent) stateEvent).getVariableName(),</span>
<span class="nc" id="L2450">                        stateEvent -&gt; ((FlowableVariableEvent) stateEvent).getVariableValue()</span>
                )
<span class="nc" id="L2452">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2453">                        tuple(&quot;processVar1&quot;, &quot;test&quot;),</span>
<span class="nc" id="L2454">                        tuple(&quot;processVar2&quot;, 10),</span>
<span class="nc" id="L2455">                        tuple(&quot;localVar1&quot;, &quot;test2&quot;),</span>
<span class="nc" id="L2456">                        tuple(&quot;localVar2&quot;, 20)</span>
                );

<span class="nc" id="L2459">        assertThat(changeStateEventListener.getEvents())</span>
<span class="nc" id="L2460">                .filteredOn(stateEvent -&gt; stateEvent instanceof FlowableActivityEvent)</span>
<span class="nc" id="L2461">                .extracting(stateEvent -&gt; ((FlowableActivityEvent) stateEvent).getActivityId())</span>
<span class="nc" id="L2462">                .containsExactlyInAnyOrder(</span>
                        &quot;subTask&quot;,
                        &quot;subProcess&quot;,
                        &quot;taskBefore&quot;
                );

<span class="nc" id="L2468">        taskService.complete(task.getId());</span>

<span class="nc" id="L2470">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2471">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>
<span class="nc" id="L2472">        taskService.complete(task.getId());</span>

<span class="nc" id="L2474">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2475">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L2476">        taskService.complete(task.getId());</span>

<span class="nc" id="L2478">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2479">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityInUnstartedSubProcessWithModeledDataObject() {
<span class="nc" id="L2484">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;);</span>

<span class="nc" id="L2486">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L2487">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2488">                .moveActivityIdTo(&quot;taskBefore&quot;, &quot;subTask&quot;)</span>
<span class="nc" id="L2489">                .changeState();</span>

<span class="nc" id="L2491">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2492">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L2494">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2495">        assertThat(executions).hasSize(3);</span>

<span class="nc" id="L2497">        Execution subProcessExecution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).activityId(&quot;subProcess&quot;)</span>
<span class="nc" id="L2498">                .singleResult();</span>
<span class="nc" id="L2499">        assertThat(runtimeService.getVariableLocal(subProcessExecution.getId(), &quot;name&quot;, String.class)).isNotNull();</span>

<span class="nc" id="L2501">        DataObject nameDataObject = runtimeService.getDataObjectLocal(subProcessExecution.getId(), &quot;name&quot;);</span>
<span class="nc" id="L2502">        assertThat(nameDataObject).isNotNull();</span>
<span class="nc" id="L2503">        assertThat(nameDataObject.getValue()).isEqualTo(&quot;John&quot;);</span>

<span class="nc" id="L2505">        taskService.complete(task.getId());</span>

<span class="nc" id="L2507">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2508">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L2509">        taskService.complete(task.getId());</span>

<span class="nc" id="L2511">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2512">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityInUnstartedSubProcessWithLocalVariableOnSubProcess() {
<span class="nc" id="L2517">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;);</span>

<span class="nc" id="L2519">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L2520">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2521">                .moveActivityIdTo(&quot;taskBefore&quot;, &quot;subTask&quot;)</span>
<span class="nc" id="L2522">                .localVariable(&quot;subProcess&quot;, &quot;name&quot;, &quot;Joe&quot;)</span>
<span class="nc" id="L2523">                .changeState();</span>

<span class="nc" id="L2525">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2526">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;subTask&quot;);</span>

<span class="nc" id="L2528">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2529">        assertThat(executions).hasSize(3);</span>

<span class="nc" id="L2531">        Execution subProcessExecution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).activityId(&quot;subProcess&quot;)</span>
<span class="nc" id="L2532">                .singleResult();</span>
<span class="nc" id="L2533">        assertThat(runtimeService.getVariableLocal(subProcessExecution.getId(), &quot;name&quot;, String.class)).isNotNull();</span>

<span class="nc" id="L2535">        DataObject nameDataObject = runtimeService.getDataObjectLocal(subProcessExecution.getId(), &quot;name&quot;);</span>
<span class="nc" id="L2536">        assertThat(nameDataObject).isNotNull();</span>
<span class="nc" id="L2537">        assertThat(nameDataObject.getValue()).isEqualTo(&quot;Joe&quot;);</span>

<span class="nc" id="L2539">        taskService.complete(task.getId());</span>

<span class="nc" id="L2541">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2542">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;taskAfter&quot;);</span>
<span class="nc" id="L2543">        taskService.complete(task.getId());</span>

<span class="nc" id="L2545">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2546">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleIntermediateSignalCatchEvent.bpmn20.xml&quot; })
    public void testSetCurrentActivityToIntermediateSignalCatchEvent() {
<span class="nc" id="L2551">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForSimpleIntermediateEvent&quot;);</span>

<span class="nc" id="L2553">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2554">        Map&lt;String, List&lt;Execution&gt;&gt; classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2555">        assertThat(classifiedExecutions).containsOnlyKeys(&quot;beforeCatchEvent&quot;);</span>
<span class="nc" id="L2556">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2557">        Map&lt;String, List&lt;Task&gt;&gt; classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L2558">        assertThat(classifiedTasks.get(&quot;beforeCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2559">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2560">        Map&lt;String, List&lt;EventSubscription&gt;&gt; classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L2561">        assertThat(classifiedEventSubscriptions).isEmpty();</span>

        //Move to catchEvent
<span class="nc" id="L2564">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L2565">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2566">                .moveActivityIdTo(&quot;beforeCatchEvent&quot;, &quot;intermediateCatchEvent&quot;)</span>
<span class="nc" id="L2567">                .changeState();</span>

<span class="nc" id="L2569">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2570">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2571">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L2572">        assertThat(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2573">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2574">        assertThat(tasks).isEmpty();</span>
<span class="nc" id="L2575">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2576">        classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L2577">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2578">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;).get(0).getEventType()).isEqualTo(&quot;signal&quot;);</span>

        //Trigger the event
<span class="nc" id="L2581">        runtimeService.signalEventReceived(&quot;someSignal&quot;);</span>

<span class="nc" id="L2583">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2584">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2585">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L2586">        assertThat(classifiedExecutions.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2587">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2588">        classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L2589">        assertThat(classifiedTasks.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2590">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2591">        assertThat(eventSubscriptions).isEmpty();</span>

        //Complete the process
<span class="nc" id="L2594">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L2595">        assertProcessEnded(processInstance.getId());</span>

<span class="nc" id="L2597">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleIntermediateSignalCatchEvent.bpmn20.xml&quot; })
    public void testSetCurrentExecutionToIntermediateSignalCatchEvent() {
<span class="nc" id="L2602">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForSimpleIntermediateEvent&quot;);</span>

<span class="nc" id="L2604">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2605">        Map&lt;String, List&lt;Execution&gt;&gt; classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2606">        assertThat(classifiedExecutions).containsOnlyKeys(&quot;beforeCatchEvent&quot;);</span>
<span class="nc" id="L2607">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2608">        Map&lt;String, List&lt;Task&gt;&gt; classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L2609">        assertThat(classifiedTasks.get(&quot;beforeCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2610">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2611">        Map&lt;String, List&lt;EventSubscription&gt;&gt; classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L2612">        assertThat(classifiedEventSubscriptions).isEmpty();</span>

        //Move to catchEvent
<span class="nc" id="L2615">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L2616">                .moveExecutionToActivityId(classifiedExecutions.get(&quot;beforeCatchEvent&quot;).get(0).getId(), &quot;intermediateCatchEvent&quot;)</span>
<span class="nc" id="L2617">                .changeState();</span>

<span class="nc" id="L2619">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2620">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2621">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L2622">        assertThat(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2623">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2624">        assertThat(tasks).isEmpty();</span>

<span class="nc" id="L2626">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2627">        classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L2628">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2629">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;).get(0).getEventType()).isEqualTo(&quot;signal&quot;);</span>

        //Trigger the event
<span class="nc" id="L2632">        runtimeService.signalEventReceived(&quot;someSignal&quot;);</span>

<span class="nc" id="L2634">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2635">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2636">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L2637">        assertThat(classifiedExecutions.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2638">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2639">        classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L2640">        assertThat(classifiedTasks.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2641">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2642">        assertThat(eventSubscriptions).isEmpty();</span>

        //Complete the process
<span class="nc" id="L2645">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L2646">        assertProcessEnded(processInstance.getId());</span>

<span class="nc" id="L2648">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleIntermediateSignalCatchEvent.bpmn20.xml&quot; })
    public void testSetCurrentActivityFromIntermediateSignalCatchEvent() {
<span class="nc" id="L2653">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForSimpleIntermediateEvent&quot;);</span>

<span class="nc" id="L2655">        Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L2656">        assertThat(task).isNotNull();</span>
<span class="nc" id="L2657">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;beforeCatchEvent&quot;);</span>

        //Complete initial task
<span class="nc" id="L2660">        taskService.complete(task.getId());</span>

        //Process is waiting for event invocation
<span class="nc" id="L2663">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2664">        Map&lt;String, List&lt;Execution&gt;&gt; classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2665">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L2666">        assertThat(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2667">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2668">        assertThat(tasks).isEmpty();</span>

<span class="nc" id="L2670">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2671">        Map&lt;String, List&lt;EventSubscription&gt;&gt; classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L2672">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>

        //Move back to the initial task
<span class="nc" id="L2675">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L2676">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2677">                .moveActivityIdTo(&quot;intermediateCatchEvent&quot;, &quot;beforeCatchEvent&quot;)</span>
<span class="nc" id="L2678">                .changeState();</span>

        //Process is in the initial state, no subscriptions exists
<span class="nc" id="L2681">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2682">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2683">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L2684">        assertThat(classifiedExecutions.get(&quot;beforeCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2685">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2686">        Map&lt;String, List&lt;Task&gt;&gt; classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L2687">        assertThat(classifiedTasks).hasSize(1);</span>
<span class="nc" id="L2688">        assertThat(classifiedTasks.get(&quot;beforeCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2689">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2690">        assertThat(eventSubscriptions).isEmpty();</span>

        //Complete the task once more
<span class="nc" id="L2693">        taskService.complete(tasks.get(0).getId());</span>

        //Process is waiting for signal again
<span class="nc" id="L2696">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2697">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2698">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L2699">        assertThat(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2700">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2701">        assertThat(tasks).isEmpty();</span>

<span class="nc" id="L2703">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2704">        classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L2705">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2706">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;).get(0).getEventType()).isEqualTo(&quot;signal&quot;);</span>

        //Move forward from the event catch
<span class="nc" id="L2709">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L2710">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2711">                .moveActivityIdTo(&quot;intermediateCatchEvent&quot;, &quot;afterCatchEvent&quot;)</span>
<span class="nc" id="L2712">                .changeState();</span>

        //Process is on the last task
<span class="nc" id="L2715">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2716">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2717">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L2718">        assertThat(classifiedExecutions.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2719">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2720">        classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L2721">        assertThat(classifiedTasks.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2722">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2723">        assertThat(eventSubscriptions).isEmpty();</span>

        //Complete the process
<span class="nc" id="L2726">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L2727">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2728">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleIntermediateSignalCatchEvent.bpmn20.xml&quot; })
    public void testSetCurrentExecutionFromIntermediateSignalCatchEvent() {
<span class="nc" id="L2733">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForSimpleIntermediateEvent&quot;);</span>

<span class="nc" id="L2735">        Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L2736">        assertThat(task).isNotNull();</span>
<span class="nc" id="L2737">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;beforeCatchEvent&quot;);</span>

        //Complete initial task
<span class="nc" id="L2740">        taskService.complete(task.getId());</span>

        //Process is waiting for event invocation
<span class="nc" id="L2743">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2744">        Map&lt;String, List&lt;Execution&gt;&gt; classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2745">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L2746">        assertThat(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2747">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2748">        assertThat(tasks).isEmpty();</span>

<span class="nc" id="L2750">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2751">        Map&lt;String, List&lt;EventSubscription&gt;&gt; classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L2752">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>

        //Move back to the initial task
<span class="nc" id="L2755">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L2756">                .moveExecutionToActivityId(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;).get(0).getId(), &quot;beforeCatchEvent&quot;)</span>
<span class="nc" id="L2757">                .changeState();</span>

        //Process is in the initial state, no subscriptions exists
<span class="nc" id="L2760">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2761">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2762">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L2763">        assertThat(classifiedExecutions.get(&quot;beforeCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2764">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2765">        Map&lt;String, List&lt;Task&gt;&gt; classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L2766">        assertThat(classifiedTasks).hasSize(1);</span>
<span class="nc" id="L2767">        assertThat(classifiedTasks.get(&quot;beforeCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2768">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2769">        assertThat(eventSubscriptions).isEmpty();</span>

        //Complete the task once more
<span class="nc" id="L2772">        taskService.complete(tasks.get(0).getId());</span>

        //Process is waiting for signal again
<span class="nc" id="L2775">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2776">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2777">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L2778">        assertThat(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2779">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2780">        assertThat(tasks).isEmpty();</span>

<span class="nc" id="L2782">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2783">        classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L2784">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2785">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;).get(0).getEventType()).isEqualTo(&quot;signal&quot;);</span>

        //Move forward from the event catch
<span class="nc" id="L2788">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L2789">                .moveExecutionToActivityId(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;).get(0).getId(), &quot;afterCatchEvent&quot;)</span>
<span class="nc" id="L2790">                .changeState();</span>

        //Process is on the last task
<span class="nc" id="L2793">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2794">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2795">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L2796">        assertThat(classifiedExecutions.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2797">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2798">        classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L2799">        assertThat(classifiedTasks.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2800">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2801">        assertThat(eventSubscriptions).isEmpty();</span>

        //Complete the process
<span class="nc" id="L2804">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L2805">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2806">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleIntermediateMessageCatchEvent.bpmn20.xml&quot; })
    public void testSetCurrentActivityToIntermediateMessageCatchEvent() {
<span class="nc" id="L2811">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForSimpleIntermediateEvent&quot;);</span>

<span class="nc" id="L2813">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2814">        Map&lt;String, List&lt;Execution&gt;&gt; classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2815">        assertThat(classifiedExecutions).containsOnlyKeys(&quot;beforeCatchEvent&quot;);</span>
<span class="nc" id="L2816">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2817">        Map&lt;String, List&lt;Task&gt;&gt; classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L2818">        assertThat(classifiedTasks.get(&quot;beforeCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2819">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2820">        Map&lt;String, List&lt;EventSubscription&gt;&gt; classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L2821">        assertThat(classifiedEventSubscriptions).isEmpty();</span>

        //Move to catchEvent
<span class="nc" id="L2824">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L2825">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2826">                .moveActivityIdTo(&quot;beforeCatchEvent&quot;, &quot;intermediateCatchEvent&quot;)</span>
<span class="nc" id="L2827">                .changeState();</span>

<span class="nc" id="L2829">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2830">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2831">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L2832">        assertThat(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2833">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2834">        assertThat(tasks).isEmpty();</span>

<span class="nc" id="L2836">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2837">        classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L2838">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2839">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;).get(0).getEventType()).isEqualTo(&quot;message&quot;);</span>

        //Trigger the event
<span class="nc" id="L2842">        String messageCatchingExecutionId = classifiedExecutions.get(&quot;intermediateCatchEvent&quot;).get(0).getId();</span>
<span class="nc" id="L2843">        runtimeService.messageEventReceived(&quot;someMessage&quot;, messageCatchingExecutionId);</span>

<span class="nc" id="L2845">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2846">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2847">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L2848">        assertThat(classifiedExecutions.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2849">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2850">        classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L2851">        assertThat(classifiedTasks.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2852">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2853">        assertThat(eventSubscriptions).isEmpty();</span>

        //Complete the process
<span class="nc" id="L2856">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L2857">        assertProcessEnded(processInstance.getId());</span>

<span class="nc" id="L2859">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleIntermediateMessageCatchEvent.bpmn20.xml&quot; })
    public void testSetCurrentExecutionToIntermediateMessageCatchEvent() {
<span class="nc" id="L2864">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForSimpleIntermediateEvent&quot;);</span>

<span class="nc" id="L2866">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2867">        Map&lt;String, List&lt;Execution&gt;&gt; classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2868">        assertThat(classifiedExecutions).containsOnlyKeys(&quot;beforeCatchEvent&quot;);</span>
<span class="nc" id="L2869">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2870">        Map&lt;String, List&lt;Task&gt;&gt; classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L2871">        assertThat(classifiedTasks.get(&quot;beforeCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2872">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2873">        Map&lt;String, List&lt;EventSubscription&gt;&gt; classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L2874">        assertThat(classifiedEventSubscriptions).isEmpty();</span>

        //Move to catchEvent
<span class="nc" id="L2877">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L2878">                .moveExecutionToActivityId(classifiedExecutions.get(&quot;beforeCatchEvent&quot;).get(0).getId(), &quot;intermediateCatchEvent&quot;)</span>
<span class="nc" id="L2879">                .changeState();</span>

<span class="nc" id="L2881">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2882">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2883">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L2884">        assertThat(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2885">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2886">        assertThat(tasks).isEmpty();</span>

<span class="nc" id="L2888">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2889">        classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L2890">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2891">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;).get(0).getEventType()).isEqualTo(&quot;message&quot;);</span>

        //Trigger the event
<span class="nc" id="L2894">        String messageCatchingExecutionId = classifiedExecutions.get(&quot;intermediateCatchEvent&quot;).get(0).getId();</span>
<span class="nc" id="L2895">        runtimeService.messageEventReceived(&quot;someMessage&quot;, messageCatchingExecutionId);</span>

<span class="nc" id="L2897">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2898">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2899">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L2900">        assertThat(classifiedExecutions.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2901">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2902">        classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L2903">        assertThat(classifiedTasks.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2904">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2905">        assertThat(eventSubscriptions).isEmpty();</span>

        //Complete the process
<span class="nc" id="L2908">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L2909">        assertProcessEnded(processInstance.getId());</span>

<span class="nc" id="L2911">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleIntermediateMessageCatchEvent.bpmn20.xml&quot; })
    public void testSetCurrentActivityFromIntermediateMessageCatchEvent() {
<span class="nc" id="L2916">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForSimpleIntermediateEvent&quot;);</span>

<span class="nc" id="L2918">        Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L2919">        assertThat(task).isNotNull();</span>
<span class="nc" id="L2920">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;beforeCatchEvent&quot;);</span>

        //Complete initial task
<span class="nc" id="L2923">        taskService.complete(task.getId());</span>

        //Process is waiting for event invocation
<span class="nc" id="L2926">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2927">        Map&lt;String, List&lt;Execution&gt;&gt; classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2928">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L2929">        assertThat(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2930">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2931">        assertThat(tasks).isEmpty();</span>

<span class="nc" id="L2933">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2934">        Map&lt;String, List&lt;EventSubscription&gt;&gt; classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L2935">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>

        //Move back to the initial task
<span class="nc" id="L2938">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L2939">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2940">                .moveActivityIdTo(&quot;intermediateCatchEvent&quot;, &quot;beforeCatchEvent&quot;)</span>
<span class="nc" id="L2941">                .changeState();</span>

        //Process is in the initial state, no subscriptions exists
<span class="nc" id="L2944">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2945">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2946">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L2947">        assertThat(classifiedExecutions.get(&quot;beforeCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2948">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2949">        Map&lt;String, List&lt;Task&gt;&gt; classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L2950">        assertThat(classifiedTasks).hasSize(1);</span>
<span class="nc" id="L2951">        assertThat(classifiedTasks.get(&quot;beforeCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2952">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2953">        assertThat(eventSubscriptions).isEmpty();</span>

        //Complete the task once more
<span class="nc" id="L2956">        taskService.complete(tasks.get(0).getId());</span>

        //Process is waiting for signal again
<span class="nc" id="L2959">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2960">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2961">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L2962">        assertThat(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2963">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2964">        assertThat(tasks).isEmpty();</span>

<span class="nc" id="L2966">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2967">        classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L2968">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2969">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;).get(0).getEventType()).isEqualTo(&quot;message&quot;);</span>

        //Move forward from the event catch
<span class="nc" id="L2972">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L2973">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2974">                .moveActivityIdTo(&quot;intermediateCatchEvent&quot;, &quot;afterCatchEvent&quot;)</span>
<span class="nc" id="L2975">                .changeState();</span>

        //Process is on the last task
<span class="nc" id="L2978">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L2979">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L2980">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L2981">        assertThat(classifiedExecutions.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2982">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2983">        classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L2984">        assertThat(classifiedTasks.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L2985">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2986">        assertThat(eventSubscriptions).isEmpty();</span>

        //Complete the process
<span class="nc" id="L2989">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L2990">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L2991">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleIntermediateMessageCatchEvent.bpmn20.xml&quot; })
    public void testSetCurrentExecutionFromIntermediateMessageCatchEvent() {
<span class="nc" id="L2996">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForSimpleIntermediateEvent&quot;);</span>

<span class="nc" id="L2998">        Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L2999">        assertThat(task).isNotNull();</span>
<span class="nc" id="L3000">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;beforeCatchEvent&quot;);</span>

        //Complete initial task
<span class="nc" id="L3003">        taskService.complete(task.getId());</span>

        //Process is waiting for event invocation
<span class="nc" id="L3006">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3007">        Map&lt;String, List&lt;Execution&gt;&gt; classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L3008">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L3009">        assertThat(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3010">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3011">        assertThat(tasks).isEmpty();</span>

<span class="nc" id="L3013">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3014">        Map&lt;String, List&lt;EventSubscription&gt;&gt; classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L3015">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>

        //Move back to the initial task
<span class="nc" id="L3018">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L3019">                .moveExecutionToActivityId(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;).get(0).getId(), &quot;beforeCatchEvent&quot;)</span>
<span class="nc" id="L3020">                .changeState();</span>

        //Process is in the initial state, no subscriptions exists
<span class="nc" id="L3023">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3024">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L3025">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L3026">        assertThat(classifiedExecutions.get(&quot;beforeCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3027">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3028">        Map&lt;String, List&lt;Task&gt;&gt; classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L3029">        assertThat(classifiedTasks).hasSize(1);</span>
<span class="nc" id="L3030">        assertThat(classifiedTasks.get(&quot;beforeCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3031">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3032">        assertThat(eventSubscriptions).isEmpty();</span>

        //Complete the task once more
<span class="nc" id="L3035">        taskService.complete(tasks.get(0).getId());</span>

        //Process is waiting for signal again
<span class="nc" id="L3038">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3039">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L3040">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L3041">        assertThat(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3042">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3043">        assertThat(tasks).isEmpty();</span>

<span class="nc" id="L3045">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3046">        classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L3047">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3048">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;).get(0).getEventType()).isEqualTo(&quot;message&quot;);</span>

        //Move forward from the event catch
<span class="nc" id="L3051">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L3052">                .moveExecutionToActivityId(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;).get(0).getId(), &quot;afterCatchEvent&quot;)</span>
<span class="nc" id="L3053">                .changeState();</span>

        //Process is on the last task
<span class="nc" id="L3056">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L3057">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L3058">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L3059">        assertThat(classifiedExecutions.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3060">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3061">        classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L3062">        assertThat(classifiedTasks.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3063">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L3064">        assertThat(eventSubscriptions).isEmpty();</span>

        //Complete the process
<span class="nc" id="L3067">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L3068">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3069">    }</span>

    protected void checkInitialStateForMultipleProcessesWithSimpleEventCatch(Map&lt;String, List&lt;Execution&gt;&gt; executionsByProcessInstance) {
<span class="nc" id="L3072">        executionsByProcessInstance.forEach((processId, executions) -&gt; {</span>
<span class="nc" id="L3073">            Map&lt;String, List&lt;Execution&gt;&gt; classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L3074">            assertThat(classifiedExecutions).containsOnlyKeys(&quot;beforeCatchEvent&quot;);</span>
<span class="nc" id="L3075">            List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3076">            Map&lt;String, List&lt;Task&gt;&gt; classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L3077">            assertThat(classifiedTasks.get(&quot;beforeCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3078">            List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3079">            Map&lt;String, List&lt;EventSubscription&gt;&gt; classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L3080">            assertThat(classifiedEventSubscriptions).isEmpty();</span>
<span class="nc" id="L3081">        });</span>
<span class="nc" id="L3082">    }</span>

    protected void checkWaitStateForMultipleProcessesWithSimpleEventCatch(Map&lt;String, List&lt;Execution&gt;&gt; executionsByProcessInstance) {
<span class="nc" id="L3085">        executionsByProcessInstance.forEach((processId, executions) -&gt; {</span>
<span class="nc" id="L3086">            Map&lt;String, List&lt;Execution&gt;&gt; classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L3087">            assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L3088">            assertThat(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3089">            List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3090">            assertThat(tasks).isEmpty();</span>

<span class="nc" id="L3092">            List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3093">            Map&lt;String, List&lt;EventSubscription&gt;&gt; classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L3094">            assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3095">        });</span>
<span class="nc" id="L3096">    }</span>

    protected void checkFinalStateForMultipleProcessesWithSimpleEventCatch(Map&lt;String, List&lt;Execution&gt;&gt; executionsByProcessInstance) {
<span class="nc" id="L3099">        executionsByProcessInstance.forEach((processId, executions) -&gt; {</span>
<span class="nc" id="L3100">            Map&lt;String, List&lt;Execution&gt;&gt; classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L3101">            assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L3102">            assertThat(classifiedExecutions.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3103">            List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3104">            Map&lt;String, List&lt;Task&gt;&gt; classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L3105">            assertThat(classifiedTasks.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3106">            List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3107">            assertThat(eventSubscriptions).isEmpty();</span>
<span class="nc" id="L3108">        });</span>
<span class="nc" id="L3109">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleIntermediateSignalCatchEvent.bpmn20.xml&quot; })
    public void testSetCurrentActivityToIntermediateCatchEventForMultipleProcessesTriggerSimultaneously() {
<span class="nc" id="L3114">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;changeStateForSimpleIntermediateEvent&quot;);</span>
<span class="nc" id="L3115">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;changeStateForSimpleIntermediateEvent&quot;);</span>

<span class="nc" id="L3117">        List&lt;Execution&gt; allExecutions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L3118">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByProcessInstance = groupListContentBy(allExecutions, Execution::getProcessInstanceId);</span>
<span class="nc" id="L3119">        assertThat(executionsByProcessInstance).hasSize(2);</span>

<span class="nc" id="L3121">        checkInitialStateForMultipleProcessesWithSimpleEventCatch(executionsByProcessInstance);</span>

        //Move both processes to the eventCatch
<span class="nc" id="L3124">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L3125">                .processInstanceId(processInstance1.getId())</span>
<span class="nc" id="L3126">                .moveActivityIdTo(&quot;beforeCatchEvent&quot;, &quot;intermediateCatchEvent&quot;)</span>
<span class="nc" id="L3127">                .changeState();</span>

<span class="nc" id="L3129">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L3130">                .processInstanceId(processInstance2.getId())</span>
<span class="nc" id="L3131">                .moveActivityIdTo(&quot;beforeCatchEvent&quot;, &quot;intermediateCatchEvent&quot;)</span>
<span class="nc" id="L3132">                .changeState();</span>

<span class="nc" id="L3134">        allExecutions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L3135">        executionsByProcessInstance = groupListContentBy(allExecutions, Execution::getProcessInstanceId);</span>
<span class="nc" id="L3136">        assertThat(executionsByProcessInstance).hasSize(2);</span>

<span class="nc" id="L3138">        checkWaitStateForMultipleProcessesWithSimpleEventCatch(executionsByProcessInstance);</span>

        //Trigger signal
<span class="nc" id="L3141">        runtimeService.signalEventReceived(&quot;someSignal&quot;);</span>

        //Both processes should be on the final task execution
<span class="nc" id="L3144">        allExecutions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L3145">        executionsByProcessInstance = groupListContentBy(allExecutions, Execution::getProcessInstanceId);</span>
<span class="nc" id="L3146">        assertThat(executionsByProcessInstance).hasSize(2);</span>

<span class="nc" id="L3148">        checkFinalStateForMultipleProcessesWithSimpleEventCatch(executionsByProcessInstance);</span>

        //Complete the remaining tasks for both processes
<span class="nc" id="L3151">        taskService.createTaskQuery().list().forEach(this::completeTask);</span>
<span class="nc" id="L3152">        assertProcessEnded(processInstance1.getId());</span>
<span class="nc" id="L3153">        assertProcessEnded(processInstance2.getId());</span>
<span class="nc" id="L3154">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleIntermediateSignalCatchEvent.bpmn20.xml&quot; })
    public void testSetCurrentExecutionToIntermediateCatchEventForMultipleProcessesTriggerSimultaneously() {
<span class="nc" id="L3159">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;changeStateForSimpleIntermediateEvent&quot;);</span>
<span class="nc" id="L3160">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;changeStateForSimpleIntermediateEvent&quot;);</span>

<span class="nc" id="L3162">        List&lt;Execution&gt; allExecutions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L3163">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByProcessInstance = groupListContentBy(allExecutions, Execution::getProcessInstanceId);</span>
<span class="nc" id="L3164">        assertThat(executionsByProcessInstance).hasSize(2);</span>

<span class="nc" id="L3166">        checkInitialStateForMultipleProcessesWithSimpleEventCatch(executionsByProcessInstance);</span>

        //Move both processes to the eventCatch
<span class="nc" id="L3169">        ChangeActivityStateBuilder changeActivityStateBuilder = runtimeService.createChangeActivityStateBuilder();</span>
<span class="nc" id="L3170">        allExecutions.stream()</span>
<span class="nc" id="L3171">                .filter(e -&gt; &quot;beforeCatchEvent&quot;.equals(e.getActivityId()))</span>
<span class="nc" id="L3172">                .map(Execution::getId)</span>
<span class="nc" id="L3173">                .forEach(id -&gt; changeActivityStateBuilder.moveExecutionToActivityId(id, &quot;intermediateCatchEvent&quot;));</span>
<span class="nc" id="L3174">        changeActivityStateBuilder.changeState();</span>

<span class="nc" id="L3176">        allExecutions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L3177">        executionsByProcessInstance = groupListContentBy(allExecutions, Execution::getProcessInstanceId);</span>
<span class="nc" id="L3178">        assertThat(executionsByProcessInstance).hasSize(2);</span>

<span class="nc" id="L3180">        checkWaitStateForMultipleProcessesWithSimpleEventCatch(executionsByProcessInstance);</span>

        //Trigger signal
<span class="nc" id="L3183">        runtimeService.signalEventReceived(&quot;someSignal&quot;);</span>

        //Both processes should be on the final task execution
<span class="nc" id="L3186">        allExecutions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L3187">        executionsByProcessInstance = groupListContentBy(allExecutions, Execution::getProcessInstanceId);</span>
<span class="nc" id="L3188">        assertThat(executionsByProcessInstance).hasSize(2);</span>

<span class="nc" id="L3190">        checkFinalStateForMultipleProcessesWithSimpleEventCatch(executionsByProcessInstance);</span>

        //Complete the remaining tasks for both processes
<span class="nc" id="L3193">        taskService.createTaskQuery().list().forEach(this::completeTask);</span>
<span class="nc" id="L3194">        assertProcessEnded(processInstance1.getId());</span>
<span class="nc" id="L3195">        assertProcessEnded(processInstance2.getId());</span>
<span class="nc" id="L3196">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleIntermediateSignalCatchEvent.bpmn20.xml&quot; })
    public void testSetCurrentActivityToIntermediateCatchEventForMultipleProcessesTriggerDiffered() {
<span class="nc" id="L3201">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;changeStateForSimpleIntermediateEvent&quot;);</span>
<span class="nc" id="L3202">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;changeStateForSimpleIntermediateEvent&quot;);</span>

<span class="nc" id="L3204">        List&lt;Execution&gt; allExecutions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L3205">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByProcessInstance = groupListContentBy(allExecutions, Execution::getProcessInstanceId);</span>
<span class="nc" id="L3206">        assertThat(executionsByProcessInstance).hasSize(2);</span>

<span class="nc" id="L3208">        checkInitialStateForMultipleProcessesWithSimpleEventCatch(executionsByProcessInstance);</span>

        //Move one process to the eventCatch
<span class="nc" id="L3211">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L3212">                .processInstanceId(processInstance1.getId())</span>
<span class="nc" id="L3213">                .moveActivityIdTo(&quot;beforeCatchEvent&quot;, &quot;intermediateCatchEvent&quot;)</span>
<span class="nc" id="L3214">                .changeState();</span>

<span class="nc" id="L3216">        allExecutions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L3217">        executionsByProcessInstance = groupListContentBy(allExecutions, Execution::getProcessInstanceId);</span>
<span class="nc" id="L3218">        assertThat(executionsByProcessInstance).hasSize(2);</span>

        //ProcessInstance1 waiting for event
<span class="nc" id="L3221">        String processId = processInstance1.getId();</span>
<span class="nc" id="L3222">        List&lt;Execution&gt; executions = executionsByProcessInstance.get(processId);</span>
<span class="nc" id="L3223">        Map&lt;String, List&lt;Execution&gt;&gt; classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L3224">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L3225">        assertThat(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3226">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3227">        assertThat(tasks).isEmpty();</span>

<span class="nc" id="L3229">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3230">        Map&lt;String, List&lt;EventSubscription&gt;&gt; classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L3231">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>

        //processInstance2 Execution still on initial state
<span class="nc" id="L3234">        processId = processInstance2.getId();</span>
<span class="nc" id="L3235">        executions = executionsByProcessInstance.get(processId);</span>
<span class="nc" id="L3236">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L3237">        assertThat(classifiedExecutions).containsOnlyKeys(&quot;beforeCatchEvent&quot;);</span>
<span class="nc" id="L3238">        tasks = taskService.createTaskQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3239">        Map&lt;String, List&lt;Task&gt;&gt; classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L3240">        assertThat(classifiedTasks.get(&quot;beforeCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3241">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3242">        classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L3243">        assertThat(classifiedEventSubscriptions).isEmpty();</span>

        //Trigger signal
<span class="nc" id="L3246">        runtimeService.signalEventReceived(&quot;someSignal&quot;);</span>

        //Move the second process to the eventCatch
<span class="nc" id="L3249">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L3250">                .processInstanceId(processInstance2.getId())</span>
<span class="nc" id="L3251">                .moveActivityIdTo(&quot;beforeCatchEvent&quot;, &quot;intermediateCatchEvent&quot;)</span>
<span class="nc" id="L3252">                .changeState();</span>

        //ProcessInstance1 is on the postEvent task
<span class="nc" id="L3255">        processId = processInstance1.getId();</span>
<span class="nc" id="L3256">        executions = runtimeService.createExecutionQuery().processInstanceId(processId).onlyChildExecutions().list();</span>
<span class="nc" id="L3257">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L3258">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L3259">        assertThat(classifiedExecutions.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3260">        tasks = taskService.createTaskQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3261">        classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L3262">        assertThat(classifiedTasks.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3263">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3264">        assertThat(eventSubscriptions).isEmpty();</span>

        //ProcessInstance2 is waiting for the event
<span class="nc" id="L3267">        processId = processInstance2.getId();</span>
<span class="nc" id="L3268">        executions = runtimeService.createExecutionQuery().processInstanceId(processId).onlyChildExecutions().list();</span>
<span class="nc" id="L3269">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L3270">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L3271">        assertThat(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3272">        tasks = taskService.createTaskQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3273">        assertThat(tasks).isEmpty();</span>

<span class="nc" id="L3275">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3276">        classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L3277">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>

        //Fire the event once more
<span class="nc" id="L3280">        runtimeService.signalEventReceived(&quot;someSignal&quot;);</span>

        //Both process should be on the postEvent task execution
<span class="nc" id="L3283">        allExecutions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L3284">        executionsByProcessInstance = groupListContentBy(allExecutions, Execution::getProcessInstanceId);</span>
<span class="nc" id="L3285">        assertThat(executionsByProcessInstance).hasSize(2);</span>

<span class="nc" id="L3287">        checkFinalStateForMultipleProcessesWithSimpleEventCatch(executionsByProcessInstance);</span>

        //Complete the remaining tasks for both processes
<span class="nc" id="L3290">        taskService.createTaskQuery().list().forEach(this::completeTask);</span>
<span class="nc" id="L3291">        assertProcessEnded(processInstance1.getId());</span>
<span class="nc" id="L3292">        assertProcessEnded(processInstance2.getId());</span>
<span class="nc" id="L3293">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleIntermediateSignalCatchEvent.bpmn20.xml&quot; })
    public void testSetCurrentExecutionToIntermediateCatchEventForMultipleProcessesTriggerDiffered() {
<span class="nc" id="L3298">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;changeStateForSimpleIntermediateEvent&quot;);</span>
<span class="nc" id="L3299">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;changeStateForSimpleIntermediateEvent&quot;);</span>

<span class="nc" id="L3301">        List&lt;Execution&gt; allExecutions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L3302">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByProcessInstance = groupListContentBy(allExecutions, Execution::getProcessInstanceId);</span>
<span class="nc" id="L3303">        assertThat(executionsByProcessInstance).hasSize(2);</span>

<span class="nc" id="L3305">        checkInitialStateForMultipleProcessesWithSimpleEventCatch(executionsByProcessInstance);</span>

        //Move one execution to the event catch
<span class="nc" id="L3308">        String executionId = executionsByProcessInstance.get(processInstance1.getId()).stream()</span>
<span class="nc" id="L3309">                .filter(e -&gt; &quot;beforeCatchEvent&quot;.equals(e.getActivityId()))</span>
<span class="nc" id="L3310">                .findFirst()</span>
<span class="nc" id="L3311">                .map(Execution::getId)</span>
<span class="nc" id="L3312">                .get();</span>
<span class="nc" id="L3313">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L3314">                .moveExecutionToActivityId(executionId, &quot;intermediateCatchEvent&quot;)</span>
<span class="nc" id="L3315">                .changeState();</span>

<span class="nc" id="L3317">        allExecutions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L3318">        executionsByProcessInstance = groupListContentBy(allExecutions, Execution::getProcessInstanceId);</span>
<span class="nc" id="L3319">        assertThat(executionsByProcessInstance).hasSize(2);</span>

        //ProcessInstance1 waiting for event
<span class="nc" id="L3322">        String processId = processInstance1.getId();</span>
<span class="nc" id="L3323">        List&lt;Execution&gt; executions = executionsByProcessInstance.get(processId);</span>
<span class="nc" id="L3324">        Map&lt;String, List&lt;Execution&gt;&gt; classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L3325">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L3326">        assertThat(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3327">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3328">        assertThat(tasks).isEmpty();</span>

<span class="nc" id="L3330">        List&lt;EventSubscription&gt; eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3331">        Map&lt;String, List&lt;EventSubscription&gt;&gt; classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L3332">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>

        //processInstance2 Execution still on initial state
<span class="nc" id="L3335">        processId = processInstance2.getId();</span>
<span class="nc" id="L3336">        executions = executionsByProcessInstance.get(processId);</span>
<span class="nc" id="L3337">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L3338">        assertThat(classifiedExecutions).containsOnlyKeys(&quot;beforeCatchEvent&quot;);</span>
<span class="nc" id="L3339">        tasks = taskService.createTaskQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3340">        Map&lt;String, List&lt;Task&gt;&gt; classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L3341">        assertThat(classifiedTasks.get(&quot;beforeCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3342">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3343">        classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L3344">        assertThat(classifiedEventSubscriptions).isEmpty();</span>

        //Trigger signal
<span class="nc" id="L3347">        runtimeService.signalEventReceived(&quot;someSignal&quot;);</span>

        //Move the second process to the eventCatch
<span class="nc" id="L3350">        executionId = executionsByProcessInstance.get(processInstance2.getId()).stream()</span>
<span class="nc" id="L3351">                .filter(e -&gt; &quot;beforeCatchEvent&quot;.equals(e.getActivityId()))</span>
<span class="nc" id="L3352">                .findFirst()</span>
<span class="nc" id="L3353">                .map(Execution::getId)</span>
<span class="nc" id="L3354">                .get();</span>
<span class="nc" id="L3355">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L3356">                .moveExecutionToActivityId(executionId, &quot;intermediateCatchEvent&quot;)</span>
<span class="nc" id="L3357">                .changeState();</span>

        //ProcessInstance1 is on the postEvent task
<span class="nc" id="L3360">        processId = processInstance1.getId();</span>
<span class="nc" id="L3361">        executions = runtimeService.createExecutionQuery().processInstanceId(processId).onlyChildExecutions().list();</span>
<span class="nc" id="L3362">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L3363">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L3364">        assertThat(classifiedExecutions.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3365">        tasks = taskService.createTaskQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3366">        classifiedTasks = groupListContentBy(tasks, Task::getTaskDefinitionKey);</span>
<span class="nc" id="L3367">        assertThat(classifiedTasks.get(&quot;afterCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3368">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3369">        assertThat(eventSubscriptions).isEmpty();</span>

        //ProcessInstance2 is waiting for the event
<span class="nc" id="L3372">        processId = processInstance2.getId();</span>
<span class="nc" id="L3373">        executions = runtimeService.createExecutionQuery().processInstanceId(processId).onlyChildExecutions().list();</span>
<span class="nc" id="L3374">        classifiedExecutions = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L3375">        assertThat(classifiedExecutions).hasSize(1);</span>
<span class="nc" id="L3376">        assertThat(classifiedExecutions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>
<span class="nc" id="L3377">        tasks = taskService.createTaskQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3378">        assertThat(tasks).isEmpty();</span>

<span class="nc" id="L3380">        eventSubscriptions = runtimeService.createEventSubscriptionQuery().processInstanceId(processId).list();</span>
<span class="nc" id="L3381">        classifiedEventSubscriptions = groupListContentBy(eventSubscriptions, EventSubscription::getActivityId);</span>
<span class="nc" id="L3382">        assertThat(classifiedEventSubscriptions.get(&quot;intermediateCatchEvent&quot;)).hasSize(1);</span>

        //Fire the event once more
<span class="nc" id="L3385">        runtimeService.signalEventReceived(&quot;someSignal&quot;);</span>

        //Both process should be on the postEvent task execution
<span class="nc" id="L3388">        allExecutions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L3389">        executionsByProcessInstance = groupListContentBy(allExecutions, Execution::getProcessInstanceId);</span>
<span class="nc" id="L3390">        assertThat(executionsByProcessInstance).hasSize(2);</span>

<span class="nc" id="L3392">        checkFinalStateForMultipleProcessesWithSimpleEventCatch(executionsByProcessInstance);</span>

        //Complete the remaining tasks for both processes
<span class="nc" id="L3395">        taskService.createTaskQuery().list().forEach(this::completeTask);</span>
<span class="nc" id="L3396">        assertProcessEnded(processInstance1.getId());</span>
<span class="nc" id="L3397">        assertProcessEnded(processInstance2.getId());</span>
<span class="nc" id="L3398">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/multipleEventSubProcessEvents.bpmn20.xml&quot; })
    public void testEnableEventSubProcessStartEvent() {
<span class="nc" id="L3403">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

<span class="nc" id="L3405">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3406">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;processTask&quot;);</span>
        
<span class="nc" id="L3408">        runtimeService.signalEventReceived(&quot;mySignal&quot;);</span>
        
<span class="nc" id="L3410">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3411">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;eventSubProcessTask&quot;);</span>
        
<span class="nc" id="L3413">        assertThat(runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(0);</span>

<span class="nc" id="L3415">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L3416">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L3417">                .enableEventSubProcessStartEvent(&quot;messageEventSubProcessStart&quot;)</span>
<span class="nc" id="L3418">                .changeState();</span>
        
<span class="nc" id="L3420">        assertThat(runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L3421">        EventSubscription messageEventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
        
<span class="nc" id="L3423">        runtimeService.messageEventReceived(&quot;myMessage&quot;, messageEventSubscription.getExecutionId());</span>

<span class="nc" id="L3425">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3426">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;messageEventSubProcessTask&quot;);</span>
<span class="nc" id="L3427">        taskService.complete(task.getId());</span>

<span class="nc" id="L3429">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L3430">    }</span>
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>