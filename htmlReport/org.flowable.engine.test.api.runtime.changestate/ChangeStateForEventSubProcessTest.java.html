<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ChangeStateForEventSubProcessTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.runtime.changestate</a> &gt; <span class="el_source">ChangeStateForEventSubProcessTest.java</span></div><h1>ChangeStateForEventSubProcessTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.engine.test.api.runtime.changestate;

import static org.assertj.core.api.Assertions.assertThat;

import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.runtime.Execution;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.eventsubscription.api.EventSubscription;
import org.flowable.job.api.Job;
import org.flowable.task.api.Task;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

/**
 * @author Dennis Federico
 */
<span class="nc" id="L36">public class ChangeStateForEventSubProcessTest extends PluggableFlowableTestCase {</span>

<span class="nc" id="L38">    private ChangeStateEventListener changeStateEventListener = new ChangeStateEventListener();</span>

    @BeforeEach
    protected void setUp() {
<span class="nc" id="L42">        processEngine.getRuntimeService().addEventListener(changeStateEventListener);</span>
<span class="nc" id="L43">    }</span>

    @AfterEach
    protected void tearDown() {
<span class="nc" id="L47">        processEngine.getRuntimeService().removeEventListener(changeStateEventListener);</span>
<span class="nc" id="L48">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleMessageEventSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityFromMessageEventSubProcessStart() {
<span class="nc" id="L53">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

<span class="nc" id="L55">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L56">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L57">        assertThat(executionsByActivity).hasSize(2);</span>
<span class="nc" id="L58">        assertThat(executionsByActivity.get(&quot;processTask&quot;)).hasSize(1);</span>
<span class="nc" id="L59">        assertThat(executionsByActivity.get(&quot;eventSubProcessStart&quot;)).hasSize(1);</span>

<span class="nc" id="L61">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L62">        Map&lt;String, List&lt;Task&gt;&gt; tasksByKey = tasks.stream().collect(Collectors.groupingBy(Task::getTaskDefinitionKey));</span>
<span class="nc" id="L63">        assertThat(tasksByKey).hasSize(1);</span>
<span class="nc" id="L64">        assertThat(tasksByKey.get(&quot;processTask&quot;)).hasSize(1);</span>

<span class="nc" id="L66">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L67">        assertThat(eventSubscription.getActivityId()).isEqualTo(&quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L68">        assertThat(eventSubscription.getEventType()).isEqualTo(&quot;message&quot;);</span>
<span class="nc" id="L69">        assertThat(eventSubscription.getEventName()).isEqualTo(&quot;eventMessage&quot;);</span>

<span class="nc" id="L71">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L72">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L73">                .moveActivityIdTo(&quot;eventSubProcessStart&quot;, &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L74">                .changeState();</span>

<span class="nc" id="L76">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L77">        tasksByKey = tasks.stream().collect(Collectors.groupingBy(Task::getTaskDefinitionKey));</span>
<span class="nc" id="L78">        assertThat(tasksByKey).hasSize(2);</span>
<span class="nc" id="L79">        assertThat(tasksByKey.get(&quot;processTask&quot;)).hasSize(1);</span>
<span class="nc" id="L80">        assertThat(tasksByKey.get(&quot;eventSubProcessTask&quot;)).hasSize(1);</span>

<span class="nc" id="L82">        eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L83">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L85">        taskService.complete(tasksByKey.get(&quot;eventSubProcessTask&quot;).get(0).getId());</span>
<span class="nc" id="L86">        taskService.complete(tasksByKey.get(&quot;processTask&quot;).get(0).getId());</span>

<span class="nc" id="L88">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L89">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleMessageEventSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentExecutionFromMessageEventSubProcessStart() {
<span class="nc" id="L94">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

<span class="nc" id="L96">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L97">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L98">        assertThat(executionsByActivity).hasSize(2);</span>
<span class="nc" id="L99">        assertThat(executionsByActivity.get(&quot;processTask&quot;)).hasSize(1);</span>
<span class="nc" id="L100">        assertThat(executionsByActivity.get(&quot;eventSubProcessStart&quot;)).hasSize(1);</span>

<span class="nc" id="L102">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L103">        Map&lt;String, List&lt;Task&gt;&gt; tasksByKey = tasks.stream().collect(Collectors.groupingBy(Task::getTaskDefinitionKey));</span>
<span class="nc" id="L104">        assertThat(tasksByKey).hasSize(1);</span>
<span class="nc" id="L105">        assertThat(tasksByKey.get(&quot;processTask&quot;)).hasSize(1);</span>

<span class="nc" id="L107">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L108">        assertThat(eventSubscription.getActivityId()).isEqualTo(&quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L109">        assertThat(eventSubscription.getEventType()).isEqualTo(&quot;message&quot;);</span>
<span class="nc" id="L110">        assertThat(eventSubscription.getEventName()).isEqualTo(&quot;eventMessage&quot;);</span>

<span class="nc" id="L112">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L113">                .moveExecutionToActivityId(executionsByActivity.get(&quot;eventSubProcessStart&quot;).get(0).getId(), &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L114">                .changeState();</span>

<span class="nc" id="L116">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L117">        tasksByKey = tasks.stream().collect(Collectors.groupingBy(Task::getTaskDefinitionKey));</span>
<span class="nc" id="L118">        assertThat(tasksByKey).hasSize(2);</span>
<span class="nc" id="L119">        assertThat(tasksByKey.get(&quot;processTask&quot;)).hasSize(1);</span>
<span class="nc" id="L120">        assertThat(tasksByKey.get(&quot;eventSubProcessTask&quot;)).hasSize(1);</span>

<span class="nc" id="L122">        eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L123">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L125">        taskService.complete(tasksByKey.get(&quot;eventSubProcessTask&quot;).get(0).getId());</span>
<span class="nc" id="L126">        taskService.complete(tasksByKey.get(&quot;processTask&quot;).get(0).getId());</span>

<span class="nc" id="L128">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L129">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleSignalEventSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityFromSignalEventSubProcessStart() {
<span class="nc" id="L134">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

<span class="nc" id="L136">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L137">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L138">        assertThat(executionsByActivity).hasSize(2);</span>
<span class="nc" id="L139">        assertThat(executionsByActivity.get(&quot;processTask&quot;)).hasSize(1);</span>
<span class="nc" id="L140">        assertThat(executionsByActivity.get(&quot;eventSubProcessStart&quot;)).hasSize(1);</span>

<span class="nc" id="L142">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L143">        Map&lt;String, List&lt;Task&gt;&gt; tasksByKey = tasks.stream().collect(Collectors.groupingBy(Task::getTaskDefinitionKey));</span>
<span class="nc" id="L144">        assertThat(tasksByKey).hasSize(1);</span>
<span class="nc" id="L145">        assertThat(tasksByKey.get(&quot;processTask&quot;)).hasSize(1);</span>

<span class="nc" id="L147">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L148">        assertThat(eventSubscription.getActivityId()).isEqualTo(&quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L149">        assertThat(eventSubscription.getEventType()).isEqualTo(&quot;signal&quot;);</span>
<span class="nc" id="L150">        assertThat(eventSubscription.getEventName()).isEqualTo(&quot;eventSignal&quot;);</span>

<span class="nc" id="L152">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L153">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L154">                .moveActivityIdTo(&quot;eventSubProcessStart&quot;, &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L155">                .changeState();</span>

<span class="nc" id="L157">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L158">        tasksByKey = tasks.stream().collect(Collectors.groupingBy(Task::getTaskDefinitionKey));</span>
<span class="nc" id="L159">        assertThat(tasksByKey).hasSize(2);</span>
<span class="nc" id="L160">        assertThat(tasksByKey.get(&quot;processTask&quot;)).hasSize(1);</span>
<span class="nc" id="L161">        assertThat(tasksByKey.get(&quot;eventSubProcessTask&quot;)).hasSize(1);</span>

<span class="nc" id="L163">        eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L164">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L166">        taskService.complete(tasksByKey.get(&quot;eventSubProcessTask&quot;).get(0).getId());</span>
<span class="nc" id="L167">        taskService.complete(tasksByKey.get(&quot;processTask&quot;).get(0).getId());</span>

<span class="nc" id="L169">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L170">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleSignalEventSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentExecutionFromSignalEventSubProcessStart() {
<span class="nc" id="L175">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

<span class="nc" id="L177">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L178">        Map&lt;String, List&lt;Execution&gt;&gt; executionsByActivity = groupListContentBy(executions, Execution::getActivityId);</span>
<span class="nc" id="L179">        assertThat(executionsByActivity).hasSize(2);</span>
<span class="nc" id="L180">        assertThat(executionsByActivity.get(&quot;processTask&quot;)).hasSize(1);</span>
<span class="nc" id="L181">        assertThat(executionsByActivity.get(&quot;eventSubProcessStart&quot;)).hasSize(1);</span>

<span class="nc" id="L183">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L184">        Map&lt;String, List&lt;Task&gt;&gt; tasksByKey = tasks.stream().collect(Collectors.groupingBy(Task::getTaskDefinitionKey));</span>
<span class="nc" id="L185">        assertThat(tasksByKey).hasSize(1);</span>
<span class="nc" id="L186">        assertThat(tasksByKey.get(&quot;processTask&quot;)).hasSize(1);</span>

<span class="nc" id="L188">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L189">        assertThat(eventSubscription.getActivityId()).isEqualTo(&quot;eventSubProcessStart&quot;);</span>
<span class="nc" id="L190">        assertThat(eventSubscription.getEventType()).isEqualTo(&quot;signal&quot;);</span>
<span class="nc" id="L191">        assertThat(eventSubscription.getEventName()).isEqualTo(&quot;eventSignal&quot;);</span>

<span class="nc" id="L193">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L194">                .moveExecutionToActivityId(executionsByActivity.get(&quot;eventSubProcessStart&quot;).get(0).getId(), &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L195">                .changeState();</span>

<span class="nc" id="L197">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L198">        tasksByKey = tasks.stream().collect(Collectors.groupingBy(Task::getTaskDefinitionKey));</span>
<span class="nc" id="L199">        assertThat(tasksByKey).hasSize(2);</span>
<span class="nc" id="L200">        assertThat(tasksByKey.get(&quot;processTask&quot;)).hasSize(1);</span>
<span class="nc" id="L201">        assertThat(tasksByKey.get(&quot;eventSubProcessTask&quot;)).hasSize(1);</span>

<span class="nc" id="L203">        eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L204">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L206">        taskService.complete(tasksByKey.get(&quot;eventSubProcessTask&quot;).get(0).getId());</span>
<span class="nc" id="L207">        taskService.complete(tasksByKey.get(&quot;processTask&quot;).get(0).getId());</span>

<span class="nc" id="L209">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L210">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleSignalEventSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityToActivityInsideSignalEventSubProcess() {
<span class="nc" id="L215">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

<span class="nc" id="L217">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L218">        assertThat(executions).extracting(Execution::getActivityId).containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L220">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L221">        assertThat(tasks).extracting(Task::getTaskDefinitionKey).containsExactlyInAnyOrder(&quot;processTask&quot;);</span>

<span class="nc" id="L223">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L224">        assertThat(eventSubscription)</span>
<span class="nc" id="L225">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L226">                .containsExactly(&quot;eventSubProcessStart&quot;, &quot;signal&quot;, &quot;eventSignal&quot;);</span>

<span class="nc" id="L228">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L229">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L230">                .moveActivityIdTo(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L231">                .changeState();</span>

<span class="nc" id="L233">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L234">        assertThat(executions)</span>
<span class="nc" id="L235">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L236">                .containsExactlyInAnyOrder(&quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L238">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L239">        assertThat(tasks)</span>
<span class="nc" id="L240">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L241">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L243">        eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L244">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L246">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L247">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L248">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleMessageEventSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityToActivityInsideMessageEventSubProcess() {
<span class="nc" id="L253">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

<span class="nc" id="L255">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L256">        assertThat(executions).extracting(Execution::getActivityId).containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L258">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L259">        assertThat(tasks)</span>
<span class="nc" id="L260">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L261">                .contains(&quot;processTask&quot;);</span>

<span class="nc" id="L263">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L264">        assertThat(eventSubscription)</span>
<span class="nc" id="L265">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L266">                .containsExactly(&quot;eventSubProcessStart&quot;, &quot;message&quot;, &quot;eventMessage&quot;);</span>

<span class="nc" id="L268">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L269">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L270">                .moveActivityIdTo(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L271">                .changeState();</span>

<span class="nc" id="L273">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L274">        assertThat(executions)</span>
<span class="nc" id="L275">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L276">                .containsExactlyInAnyOrder(&quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L278">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L279">        assertThat(tasks)</span>
<span class="nc" id="L280">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L281">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L283">        eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L284">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L286">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L287">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L288">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleTimerEventSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityToActivityInsideTimerEventSubProcess() {
<span class="nc" id="L293">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

<span class="nc" id="L295">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L296">        assertThat(executions)</span>
<span class="nc" id="L297">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L298">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L300">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L301">        assertThat(tasks)</span>
<span class="nc" id="L302">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L303">                .containsExactly(&quot;processTask&quot;);</span>

<span class="nc" id="L305">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L306">        assertThat(job).isNotNull();</span>

<span class="nc" id="L308">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L309">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L310">                .moveActivityIdTo(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L311">                .changeState();</span>

<span class="nc" id="L313">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L314">        assertThat(executions)</span>
<span class="nc" id="L315">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L316">                .containsExactlyInAnyOrder(&quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L318">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L319">        assertThat(tasks)</span>
<span class="nc" id="L320">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L321">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L323">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L324">        assertThat(job).isNull();</span>

<span class="nc" id="L326">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L327">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L328">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleNonInterruptingSignalEventSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentOnlyActivityToActivityInsideNonInterruptingSignalEventSubProcess() {
<span class="nc" id="L334">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

<span class="nc" id="L336">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L337">        assertThat(executions)</span>
<span class="nc" id="L338">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L339">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L341">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L342">        assertThat(tasks)</span>
<span class="nc" id="L343">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L344">                .containsExactly(&quot;processTask&quot;);</span>

<span class="nc" id="L346">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L347">        assertThat(eventSubscription)</span>
<span class="nc" id="L348">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L349">                .containsExactly(&quot;eventSubProcessStart&quot;, &quot;signal&quot;, &quot;eventSignal&quot;);</span>

<span class="nc" id="L351">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L352">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L353">                .moveActivityIdTo(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L354">                .changeState();</span>

<span class="nc" id="L356">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L357">        assertThat(executions)</span>
<span class="nc" id="L358">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L359">                .containsExactlyInAnyOrder(&quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L361">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L362">        assertThat(tasks).</span>
<span class="nc" id="L363">                extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L364">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>

        //SINCE THE LAST EXECUTION ON THE PARENT SCOPE WAS MOVED, THERE SHOULD BE NO EVENT SUBSCRIPTION
<span class="nc" id="L367">        eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L368">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L370">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L371">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L372">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleNonInterruptingMessageEventSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentOnlyActivityToActivityInsideNonInterruptingMessageEventSubProcess() {
<span class="nc" id="L378">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

<span class="nc" id="L380">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L381">        assertThat(executions)</span>
<span class="nc" id="L382">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L383">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L385">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L386">        assertThat(tasks)</span>
<span class="nc" id="L387">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L388">                .containsExactly(&quot;processTask&quot;);</span>

<span class="nc" id="L390">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L391">        assertThat(eventSubscription)</span>
<span class="nc" id="L392">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L393">                .containsExactly(&quot;eventSubProcessStart&quot;, &quot;message&quot;, &quot;eventMessage&quot;);</span>

<span class="nc" id="L395">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L396">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L397">                .moveActivityIdTo(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L398">                .changeState();</span>

<span class="nc" id="L400">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L401">        assertThat(executions)</span>
<span class="nc" id="L402">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L403">                .containsExactlyInAnyOrder(&quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L405">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L406">        assertThat(tasks)</span>
<span class="nc" id="L407">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L408">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>

        //SINCE THE LAST EXECUTION ON THE PARENT SCOPE WAS MOVED, THERE SHOULD BE NO EVENT SUBSCRIPTION//SINCE THE LAST EXECUTION ON THE PARENT SCOPE WAS MOVED, THERE SHOULD BE NO EVENT SUBSCRIPTION
<span class="nc" id="L411">        eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L412">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L414">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L415">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L416">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.simpleNonInterruptingTimerEventSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentOnlyActivityToActivityInsideNonInterruptingTimerEventSubProcess() {
<span class="nc" id="L422">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

<span class="nc" id="L424">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L425">        assertThat(executions).extracting(Execution::getActivityId).containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L427">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L428">        assertThat(tasks)</span>
<span class="nc" id="L429">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L430">                .containsExactly(&quot;processTask&quot;);</span>

<span class="nc" id="L432">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L433">        assertThat(job).isNotNull();</span>

<span class="nc" id="L435">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L436">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L437">                .moveActivityIdTo(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L438">                .changeState();</span>

<span class="nc" id="L440">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L441">        assertThat(executions)</span>
<span class="nc" id="L442">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L443">                .containsExactlyInAnyOrder(&quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L445">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L446">        assertThat(tasks)</span>
<span class="nc" id="L447">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L448">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L450">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L451">        assertThat(job).isNull();</span>

        //SINCE THE LAST EXECUTION ON THE PARENT SCOPE WAS MOVED, THERE SHOULD BE NO EVENT SUBSCRIPTION
<span class="nc" id="L454">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L455">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L456">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.TimerParallelSignalEventSubProcess.bpmn20.xml&quot; })
    public void testSetParallelActivityToActivityInsideSignalEventSubProcess() {
<span class="nc" id="L461">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;TAES&quot;);</span>

<span class="nc" id="L463">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L464">        assertThat(executions)</span>
<span class="nc" id="L465">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L466">                .containsExactlyInAnyOrder(&quot;spawnParallelTask&quot;, &quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L468">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L469">        assertThat(eventSubscription)</span>
<span class="nc" id="L470">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L471">                .containsExactly(&quot;eventSubProcessStart&quot;, &quot;signal&quot;, &quot;eventSignal&quot;);</span>

        //Spawn a parallel task
<span class="nc" id="L474">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L475">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L476">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L478">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L479">        assertThat(executions)</span>
<span class="nc" id="L480">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L481">                .containsExactlyInAnyOrder(&quot;spawnParallelTask&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L483">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L484">        assertThat(tasks)</span>
<span class="nc" id="L485">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L486">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>

<span class="nc" id="L488">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L489">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L490">                .moveActivityIdTo(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L491">                .changeState();</span>

<span class="nc" id="L493">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L494">        assertThat(executions)</span>
<span class="nc" id="L495">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L496">                .containsExactlyInAnyOrder(&quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L498">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L499">        assertThat(tasks)</span>
<span class="nc" id="L500">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L501">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L503">        eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L504">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L506">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L507">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L508">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.TimerParallelMessageEventSubProcess.bpmn20.xml&quot; })
    public void testSetParallelActivityToActivityInsideMessageEventSubProcess() {
<span class="nc" id="L513">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;TAES&quot;);</span>

<span class="nc" id="L515">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L516">        assertThat(executions)</span>
<span class="nc" id="L517">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L518">                .containsExactlyInAnyOrder(&quot;spawnParallelTask&quot;, &quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L520">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L521">        assertThat(eventSubscription)</span>
<span class="nc" id="L522">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L523">                .containsExactly(&quot;eventSubProcessStart&quot;, &quot;message&quot;, &quot;myMessage&quot;);</span>

        //Spawn a parallel task
<span class="nc" id="L526">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L527">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L528">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L530">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L531">        assertThat(executions)</span>
<span class="nc" id="L532">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L533">                .containsExactlyInAnyOrder(&quot;spawnParallelTask&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L535">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L536">        assertThat(tasks)</span>
<span class="nc" id="L537">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L538">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>

<span class="nc" id="L540">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L541">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L542">                .moveActivityIdTo(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L543">                .changeState();</span>

<span class="nc" id="L545">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L546">        assertThat(executions)</span>
<span class="nc" id="L547">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L548">                .containsExactlyInAnyOrder(&quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L550">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L551">        assertThat(tasks)</span>
<span class="nc" id="L552">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L553">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L555">        eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L556">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L558">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L559">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L560">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.TimerParallelTimerEventSubProcess.bpmn20.xml&quot; })
    public void testSetParallelActivityToActivityInsideTimerEventSubProcess() {
<span class="nc" id="L565">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;TAES&quot;);</span>

<span class="nc" id="L567">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L568">        assertThat(executions)</span>
<span class="nc" id="L569">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L570">                .containsExactlyInAnyOrder(&quot;spawnParallelTask&quot;, &quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>

        //Spawn the parallel task
<span class="nc" id="L573">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L574">                .list().stream()</span>
<span class="nc" id="L575">                .filter(j -&gt; &quot;spawnParallelTask&quot;.equals(getJobActivityId(j)))</span>
<span class="nc" id="L576">                .findFirst().get();</span>
<span class="nc" id="L577">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L578">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L580">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L581">        assertThat(executions)</span>
<span class="nc" id="L582">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L583">                .containsExactlyInAnyOrder(&quot;spawnParallelTask&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L585">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L586">        assertThat(tasks)</span>
<span class="nc" id="L587">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L588">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>

<span class="nc" id="L590">        List&lt;Job&gt; jobs = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L591">        assertThat(jobs)</span>
<span class="nc" id="L592">                .extracting(this::getJobActivityId)</span>
<span class="nc" id="L593">                .containsExactly(&quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L595">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L596">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L597">                .moveActivityIdTo(&quot;processTask&quot;, &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L598">                .changeState();</span>

<span class="nc" id="L600">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L601">        assertThat(executions)</span>
<span class="nc" id="L602">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L603">                .containsExactlyInAnyOrder(&quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L605">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L606">        assertThat(tasks)</span>
<span class="nc" id="L607">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L608">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L610">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L611">        assertThat(job).isNull();</span>

<span class="nc" id="L613">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L614">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L615">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.TimerParallelNonInterruptingSignalEventSubProcess.bpmn20.xml&quot; })
    public void testSetParallelActivityToActivityInsideNonInterruptingSignalEventSubProcess() {
<span class="nc" id="L621">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;TAES&quot;);</span>

<span class="nc" id="L623">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L624">        assertThat(executions)</span>
<span class="nc" id="L625">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L626">                .containsExactlyInAnyOrder(&quot;spawnParallelTask&quot;, &quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L628">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L629">        assertThat(eventSubscription)</span>
<span class="nc" id="L630">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L631">                .containsExactly(&quot;eventSubProcessStart&quot;, &quot;signal&quot;, &quot;eventSignal&quot;);</span>

        //Spawn a parallel task
<span class="nc" id="L634">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L635">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L636">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L638">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L639">        assertThat(executions)</span>
<span class="nc" id="L640">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L641">                .containsExactlyInAnyOrder(&quot;spawnParallelTask&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L643">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L644">        assertThat(tasks)</span>
<span class="nc" id="L645">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L646">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>

<span class="nc" id="L648">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L649">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L650">                .moveActivityIdTo(&quot;parallelTask&quot;, &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L651">                .changeState();</span>

<span class="nc" id="L653">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L654">        assertThat(executions)</span>
<span class="nc" id="L655">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L656">                .containsExactlyInAnyOrder(&quot;spawnParallelTask&quot;, &quot;processTask&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessStart&quot;, &quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L658">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L659">        assertThat(tasks)</span>
<span class="nc" id="L660">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L661">                .containsExactlyInAnyOrder(&quot;eventSubProcessTask&quot;, &quot;processTask&quot;);</span>

<span class="nc" id="L663">        eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L664">        assertThat(eventSubscription)</span>
<span class="nc" id="L665">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L666">                .containsExactly(&quot;eventSubProcessStart&quot;, &quot;signal&quot;, &quot;eventSignal&quot;);</span>

        //Fire the signal
<span class="nc" id="L669">        runtimeService.signalEventReceived(&quot;eventSignal&quot;);</span>

<span class="nc" id="L671">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L672">        assertThat(executions)</span>
<span class="nc" id="L673">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L674">                .containsExactlyInAnyOrder(&quot;spawnParallelTask&quot;, &quot;processTask&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessStart&quot;,</span>
                        &quot;eventSubProcessTask&quot;, &quot;eventSubProcessTask&quot;);

<span class="nc" id="L677">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L678">        assertThat(tasks)</span>
<span class="nc" id="L679">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L680">                .containsExactlyInAnyOrder(&quot;eventSubProcessTask&quot;, &quot;eventSubProcessTask&quot;, &quot;processTask&quot;);</span>

<span class="nc" id="L682">        eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L683">        assertThat(eventSubscription)</span>
<span class="nc" id="L684">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L685">                .containsExactly(&quot;eventSubProcessStart&quot;, &quot;signal&quot;, &quot;eventSignal&quot;);</span>

<span class="nc" id="L687">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L688">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L689">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.TimerParallelNonInterruptingMessageEventSubProcess.bpmn20.xml&quot; })
    public void testSetParallelActivityToActivityInsideNonInterruptingMessageEventSubProcess() {
<span class="nc" id="L695">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;TAES&quot;);</span>

<span class="nc" id="L697">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L698">        assertThat(executions)</span>
<span class="nc" id="L699">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L700">                .containsExactlyInAnyOrder(&quot;spawnParallelTask&quot;, &quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L702">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L703">        assertThat(eventSubscription)</span>
<span class="nc" id="L704">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L705">                .containsExactly(&quot;eventSubProcessStart&quot;, &quot;message&quot;, &quot;myMessage&quot;);</span>

        //Spawn a parallel task
<span class="nc" id="L708">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L709">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L710">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L712">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L713">        assertThat(executions)</span>
<span class="nc" id="L714">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L715">                .containsExactlyInAnyOrder(&quot;spawnParallelTask&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L717">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L718">        assertThat(tasks)</span>
<span class="nc" id="L719">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L720">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>

<span class="nc" id="L722">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L723">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L724">                .moveActivityIdTo(&quot;parallelTask&quot;, &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L725">                .changeState();</span>

<span class="nc" id="L727">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L728">        assertThat(executions)</span>
<span class="nc" id="L729">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L730">                .containsExactlyInAnyOrder(&quot;spawnParallelTask&quot;, &quot;processTask&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L732">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L733">        assertThat(tasks)</span>
<span class="nc" id="L734">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L735">                .containsExactlyInAnyOrder(&quot;eventSubProcessTask&quot;, &quot;processTask&quot;);</span>

<span class="nc" id="L737">        eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L738">        assertThat(eventSubscription)</span>
<span class="nc" id="L739">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L740">                .containsExactly(&quot;eventSubProcessStart&quot;, &quot;message&quot;, &quot;myMessage&quot;);</span>

        //Trigger the event
<span class="nc" id="L743">        Execution messageSubscriptionExecution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L744">                .messageEventSubscriptionName(&quot;myMessage&quot;).singleResult();</span>
<span class="nc" id="L745">        runtimeService.messageEventReceived(&quot;myMessage&quot;, messageSubscriptionExecution.getId());</span>

<span class="nc" id="L747">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L748">        assertThat(executions)</span>
<span class="nc" id="L749">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L750">                .containsExactlyInAnyOrder(&quot;spawnParallelTask&quot;, &quot;processTask&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessStart&quot;,</span>
                        &quot;eventSubProcessTask&quot;, &quot;eventSubProcessTask&quot;);

<span class="nc" id="L753">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L754">        assertThat(tasks)</span>
<span class="nc" id="L755">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L756">                .containsExactlyInAnyOrder(&quot;eventSubProcessTask&quot;, &quot;eventSubProcessTask&quot;, &quot;processTask&quot;);</span>

<span class="nc" id="L758">        eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L759">        assertThat(eventSubscription)</span>
<span class="nc" id="L760">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L761">                .containsExactly(&quot;eventSubProcessStart&quot;, &quot;message&quot;, &quot;myMessage&quot;);</span>

<span class="nc" id="L763">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L764">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L765">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.TimerParallelNonInterruptingTimerEventSubProcess.bpmn20.xml&quot; })
    public void testSetParallelActivityToActivityInsideNonInterruptingTimerEventSubProcess() {
<span class="nc" id="L771">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;TAES&quot;);</span>

<span class="nc" id="L773">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L774">        assertThat(executions)</span>
<span class="nc" id="L775">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L776">                .containsExactlyInAnyOrder(&quot;spawnParallelTask&quot;, &quot;processTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L778">        List&lt;Job&gt; jobs = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L779">        assertThat(jobs)</span>
<span class="nc" id="L780">                .extracting(this::getJobActivityId)</span>
<span class="nc" id="L781">                .containsExactlyInAnyOrder(&quot;spawnParallelTask&quot;, &quot;eventSubProcessStart&quot;);</span>

        //Spawn the parallel task
<span class="nc" id="L784">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L785">                .list().stream()</span>
<span class="nc" id="L786">                .filter(j -&gt; &quot;spawnParallelTask&quot;.equals(getJobActivityId(j)))</span>
<span class="nc" id="L787">                .findFirst().get();</span>
<span class="nc" id="L788">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L789">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L791">        jobs = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L792">        assertThat(jobs)</span>
<span class="nc" id="L793">                .extracting(this::getJobActivityId)</span>
<span class="nc" id="L794">                .containsExactly(&quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L796">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L797">        assertThat(executions)</span>
<span class="nc" id="L798">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L799">                .containsExactlyInAnyOrder(&quot;spawnParallelTask&quot;, &quot;processTask&quot;, &quot;parallelTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L801">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L802">        assertThat(tasks)</span>
<span class="nc" id="L803">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L804">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>

<span class="nc" id="L806">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L807">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L808">                .moveActivityIdTo(&quot;parallelTask&quot;, &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L809">                .changeState();</span>

<span class="nc" id="L811">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L812">        assertThat(executions)</span>
<span class="nc" id="L813">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L814">                .containsExactlyInAnyOrder(&quot;spawnParallelTask&quot;, &quot;processTask&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessStart&quot;, &quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L816">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L817">        assertThat(tasks)</span>
<span class="nc" id="L818">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L819">                .containsExactlyInAnyOrder(&quot;eventSubProcessTask&quot;, &quot;processTask&quot;);</span>

<span class="nc" id="L821">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L822">        assertThat(job)</span>
<span class="nc" id="L823">                .extracting(this::getJobActivityId)</span>
<span class="nc" id="L824">                .isEqualTo(&quot;eventSubProcessStart&quot;);</span>

        //Trigger the eventSubProcess timer
<span class="nc" id="L827">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L828">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L830">        executions = runtimeService.createExecutionQuery().onlyChildExecutions().list();</span>
<span class="nc" id="L831">        assertThat(executions)</span>
<span class="nc" id="L832">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L833">                .containsExactlyInAnyOrder(&quot;spawnParallelTask&quot;, &quot;processTask&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessStart&quot;,</span>
                        &quot;eventSubProcessTask&quot;, &quot;eventSubProcessTask&quot;);

<span class="nc" id="L836">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L837">        assertThat(tasks)</span>
<span class="nc" id="L838">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L839">                .containsExactlyInAnyOrder(&quot;eventSubProcessTask&quot;, &quot;eventSubProcessTask&quot;, &quot;processTask&quot;);</span>

<span class="nc" id="L841">        jobs = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L842">        assertThat(jobs)</span>
<span class="nc" id="L843">                .extracting(this::getJobActivityId)</span>
<span class="nc" id="L844">                .containsExactly(&quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L846">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L847">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L848">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.nestedSignalEventSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityToActivityAtParentSubProcessOfNestedSignalEventSubProcess() {
<span class="nc" id="L853">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

<span class="nc" id="L855">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L856">        assertThat(executions)</span>
<span class="nc" id="L857">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L858">                .containsExactly(&quot;processTask&quot;);</span>

<span class="nc" id="L860">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L861">        assertThat(tasks)</span>
<span class="nc" id="L862">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L863">                .containsExactly(&quot;processTask&quot;);</span>

<span class="nc" id="L865">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L866">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L868">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L869">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L870">                .moveActivityIdTo(&quot;processTask&quot;, &quot;subProcessTask&quot;)</span>
<span class="nc" id="L871">                .changeState();</span>

<span class="nc" id="L873">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L874">        assertThat(executions)</span>
<span class="nc" id="L875">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L876">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L878">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L879">        assertThat(tasks)</span>
<span class="nc" id="L880">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L881">                .containsExactly(&quot;subProcessTask&quot;);</span>

<span class="nc" id="L883">        eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L884">        assertThat(eventSubscription)</span>
<span class="nc" id="L885">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L886">                .containsExactly(&quot;eventSubProcessStart&quot;, &quot;signal&quot;, &quot;eventSignal&quot;);</span>

        //Trigger the event
<span class="nc" id="L889">        runtimeService.signalEventReceived(&quot;eventSignal&quot;);</span>

<span class="nc" id="L891">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L892">        assertThat(executions)</span>
<span class="nc" id="L893">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L894">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessStart&quot;, &quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L896">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L897">        assertThat(tasks)</span>
<span class="nc" id="L898">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L899">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L901">        eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L902">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L904">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L905">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L906">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.nestedMessageEventSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityToActivityAtParentSubProcessOfNestedMessageEventSubProcess() {
<span class="nc" id="L911">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

<span class="nc" id="L913">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L914">        assertThat(executions)</span>
<span class="nc" id="L915">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L916">                .containsExactly(&quot;processTask&quot;);</span>

<span class="nc" id="L918">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L919">        assertThat(tasks)</span>
<span class="nc" id="L920">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L921">                .containsExactly(&quot;processTask&quot;);</span>

<span class="nc" id="L923">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L924">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L926">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L927">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L928">                .moveActivityIdTo(&quot;processTask&quot;, &quot;subProcessTask&quot;)</span>
<span class="nc" id="L929">                .changeState();</span>

<span class="nc" id="L931">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L932">        assertThat(executions)</span>
<span class="nc" id="L933">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L934">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L936">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L937">        assertThat(tasks)</span>
<span class="nc" id="L938">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L939">                .containsExactly(&quot;subProcessTask&quot;);</span>

<span class="nc" id="L941">        eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L942">        assertThat(eventSubscription)</span>
<span class="nc" id="L943">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L944">                .containsExactly(&quot;eventSubProcessStart&quot;, &quot;message&quot;, &quot;eventMessage&quot;);</span>

        //Trigger the event
<span class="nc" id="L947">        runtimeService.messageEventReceived(&quot;eventMessage&quot;, eventSubscription.getExecutionId());</span>

<span class="nc" id="L949">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L950">        assertThat(executions)</span>
<span class="nc" id="L951">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L952">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessStart&quot;, &quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L954">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L955">        assertThat(tasks)</span>
<span class="nc" id="L956">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L957">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L959">        eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L960">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L962">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L963">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L964">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.nestedTimerEventSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityToActivityAtParentSubProcessOfNestedTimerEventSubProcess() {
<span class="nc" id="L969">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

<span class="nc" id="L971">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L972">        assertThat(executions)</span>
<span class="nc" id="L973">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L974">                .containsExactly(&quot;processTask&quot;);</span>

<span class="nc" id="L976">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L977">        assertThat(tasks)</span>
<span class="nc" id="L978">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L979">                .containsExactly(&quot;processTask&quot;);</span>

<span class="nc" id="L981">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L982">        assertThat(job).isNull();</span>

<span class="nc" id="L984">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L985">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L986">                .moveActivityIdTo(&quot;processTask&quot;, &quot;subProcessTask&quot;)</span>
<span class="nc" id="L987">                .changeState();</span>

<span class="nc" id="L989">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L990">        assertThat(executions)</span>
<span class="nc" id="L991">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L992">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L994">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L995">        assertThat(tasks)</span>
<span class="nc" id="L996">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L997">                .containsExactly(&quot;subProcessTask&quot;);</span>

<span class="nc" id="L999">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1000">        assertThat(job)</span>
<span class="nc" id="L1001">                .extracting(this::getJobActivityId)</span>
<span class="nc" id="L1002">                .isEqualTo(&quot;eventSubProcessStart&quot;);</span>

        //Fire the timer
<span class="nc" id="L1005">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1006">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L1008">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1009">        assertThat(executions)</span>
<span class="nc" id="L1010">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1011">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessStart&quot;, &quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L1013">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1014">        assertThat(tasks)</span>
<span class="nc" id="L1015">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1016">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L1018">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1019">        assertThat(job).isNull();</span>

<span class="nc" id="L1021">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L1022">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1023">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.nestedSignalEventSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityToActivityInsideNestedSignalEventSubProcess() {
<span class="nc" id="L1028">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

        //Move the current task inside the subProcess
<span class="nc" id="L1031">        completeTask(taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult());</span>

<span class="nc" id="L1033">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1034">        assertThat(executions)</span>
<span class="nc" id="L1035">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1036">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L1038">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1039">        assertThat(tasks)</span>
<span class="nc" id="L1040">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1041">                .containsExactly(&quot;subProcessTask&quot;);</span>

<span class="nc" id="L1043">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1044">        assertThat(eventSubscription)</span>
<span class="nc" id="L1045">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L1046">                .containsExactly(&quot;eventSubProcessStart&quot;, &quot;signal&quot;, &quot;eventSignal&quot;);</span>

<span class="nc" id="L1048">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1049">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1050">                .moveActivityIdTo(&quot;subProcessTask&quot;, &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L1051">                .changeState();</span>

<span class="nc" id="L1053">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1054">        assertThat(executions)</span>
<span class="nc" id="L1055">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1056">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L1058">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1059">        assertThat(tasks)</span>
<span class="nc" id="L1060">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1061">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L1063">        eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1064">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L1066">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L1067">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1068">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.nestedMessageEventSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityToActivityInsideNestedMessageEventSubProcess() {
<span class="nc" id="L1073">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

        //Move the current task inside the subProcess
<span class="nc" id="L1076">        completeTask(taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult());</span>

<span class="nc" id="L1078">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1079">        assertThat(executions).</span>
<span class="nc" id="L1080">                extracting(Execution::getActivityId)</span>
<span class="nc" id="L1081">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L1083">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1084">        assertThat(tasks)</span>
<span class="nc" id="L1085">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1086">                .containsExactly(&quot;subProcessTask&quot;);</span>

<span class="nc" id="L1088">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1089">        assertThat(eventSubscription)</span>
<span class="nc" id="L1090">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L1091">                .containsExactly(&quot;eventSubProcessStart&quot;, &quot;message&quot;, &quot;eventMessage&quot;);</span>

<span class="nc" id="L1093">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1094">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1095">                .moveActivityIdTo(&quot;subProcessTask&quot;, &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L1096">                .changeState();</span>

<span class="nc" id="L1098">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1099">        assertThat(executions)</span>
<span class="nc" id="L1100">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1101">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L1103">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1104">        assertThat(tasks)</span>
<span class="nc" id="L1105">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1106">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L1108">        eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1109">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L1111">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L1112">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1113">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.nestedTimerEventSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityToActivityInsideNestedTimerEventSubProcess() {
<span class="nc" id="L1118">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

        //Move the current task inside the subProcess
<span class="nc" id="L1121">        completeTask(taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult());</span>

<span class="nc" id="L1123">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1124">        assertThat(executions)</span>
<span class="nc" id="L1125">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1126">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L1128">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1129">        assertThat(tasks)</span>
<span class="nc" id="L1130">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1131">                .containsExactly(&quot;subProcessTask&quot;);</span>

<span class="nc" id="L1133">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1134">        assertThat(job)</span>
<span class="nc" id="L1135">                .extracting(this::getJobActivityId)</span>
<span class="nc" id="L1136">                .isEqualTo(&quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L1138">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1139">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1140">                .moveActivityIdTo(&quot;subProcessTask&quot;, &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L1141">                .changeState();</span>

<span class="nc" id="L1143">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1144">        assertThat(executions)</span>
<span class="nc" id="L1145">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1146">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L1148">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1149">        assertThat(tasks)</span>
<span class="nc" id="L1150">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1151">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L1153">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1154">        assertThat(job).isNull();</span>

<span class="nc" id="L1156">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L1157">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1158">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.nestedNonInterruptingSignalEventSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityToActivityInsideNestedNonInterruptingSignalEventSubProcess() {
<span class="nc" id="L1164">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

        //Move the current task inside the subProcess
<span class="nc" id="L1167">        completeTask(taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult());</span>

<span class="nc" id="L1169">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1170">        assertThat(executions)</span>
<span class="nc" id="L1171">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1172">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L1174">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1175">        assertThat(tasks)</span>
<span class="nc" id="L1176">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1177">                .containsExactly(&quot;subProcessTask&quot;);</span>

<span class="nc" id="L1179">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1180">        assertThat(eventSubscription)</span>
<span class="nc" id="L1181">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L1182">                .containsExactly(&quot;eventSubProcessStart&quot;, &quot;signal&quot;, &quot;eventSignal&quot;);</span>

<span class="nc" id="L1184">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1185">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1186">                .moveActivityIdTo(&quot;subProcessTask&quot;, &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L1187">                .changeState();</span>

<span class="nc" id="L1189">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1190">        assertThat(executions)</span>
<span class="nc" id="L1191">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1192">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L1194">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1195">        assertThat(tasks)</span>
<span class="nc" id="L1196">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1197">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>

        //SINCE THE LAST EXECUTION ON THE PARENT SCOPE WAS MOVED, THERE SHOULD BE NO EVENT SUBSCRIPTION
<span class="nc" id="L1200">        eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1201">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L1203">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L1204">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1205">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.nestedNonInterruptingMessageEventSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityToActivityInsideNestedNonInterruptingMessageEventSubProcess() {
<span class="nc" id="L1211">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

        //Move the current task inside the subProcess
<span class="nc" id="L1214">        completeTask(taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult());</span>

<span class="nc" id="L1216">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1217">        assertThat(executions)</span>
<span class="nc" id="L1218">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1219">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L1221">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1222">        assertThat(tasks)</span>
<span class="nc" id="L1223">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1224">                .containsExactly(&quot;subProcessTask&quot;);</span>

<span class="nc" id="L1226">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1227">        assertThat(eventSubscription)</span>
<span class="nc" id="L1228">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L1229">                .containsExactly(&quot;eventSubProcessStart&quot;, &quot;message&quot;, &quot;eventMessage&quot;);</span>

<span class="nc" id="L1231">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1232">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1233">                .moveActivityIdTo(&quot;subProcessTask&quot;, &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L1234">                .changeState();</span>

<span class="nc" id="L1236">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1237">        assertThat(executions)</span>
<span class="nc" id="L1238">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1239">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L1241">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1242">        assertThat(tasks)</span>
<span class="nc" id="L1243">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1244">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>

        //SINCE THE LAST EXECUTION ON THE PARENT SCOPE WAS MOVED, THERE SHOULD BE NO EVENT SUBSCRIPTION
<span class="nc" id="L1247">        eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1248">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L1250">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L1251">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1252">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.nestedNonInterruptingTimerEventSubProcess.bpmn20.xml&quot; })
    public void testSetCurrentActivityToActivityInsideNestedNonInterruptingTimerEventSubProcess() {
<span class="nc" id="L1258">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

        //Move the current task inside the subProcess
<span class="nc" id="L1261">        completeTask(taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult());</span>

<span class="nc" id="L1263">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1264">        assertThat(executions)</span>
<span class="nc" id="L1265">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1266">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L1268">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1269">        assertThat(tasks)</span>
<span class="nc" id="L1270">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1271">                .containsExactly(&quot;subProcessTask&quot;);</span>

<span class="nc" id="L1273">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1274">        assertThat(job)</span>
<span class="nc" id="L1275">                .extracting(this::getJobActivityId)</span>
<span class="nc" id="L1276">                .isEqualTo(&quot;eventSubProcessStart&quot;);</span>

<span class="nc" id="L1278">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1279">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1280">                .moveActivityIdTo(&quot;subProcessTask&quot;, &quot;eventSubProcessTask&quot;)</span>
<span class="nc" id="L1281">                .changeState();</span>

<span class="nc" id="L1283">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1284">        assertThat(executions)</span>
<span class="nc" id="L1285">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1286">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;eventSubProcess&quot;, &quot;eventSubProcessTask&quot;);</span>

<span class="nc" id="L1288">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1289">        assertThat(tasks)</span>
<span class="nc" id="L1290">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1291">                .containsExactly(&quot;eventSubProcessTask&quot;);</span>

        //SINCE THE LAST EXECUTION ON THE PARENT SCOPE WAS MOVED, THERE SHOULD BE NO EVENT SUBSCRIPTION
<span class="nc" id="L1294">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1295">        assertThat(job).isNull();</span>

<span class="nc" id="L1297">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L1298">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1299">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.TimerParallelNestedSignalEventSubProcess.bpmn20.xml&quot; })
    public void testSetParallelActivityToActivityInsideNestedSignalEventSubProcessWithActivityAtRootScope() {
<span class="nc" id="L1305">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

        //Spawn a parallel task
<span class="nc" id="L1308">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1309">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1310">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L1312">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1313">        assertThat(executions)</span>
<span class="nc" id="L1314">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1315">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;, &quot;spawnParallelTask&quot;);</span>

<span class="nc" id="L1317">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1318">        assertThat(tasks)</span>
<span class="nc" id="L1319">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1320">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>

<span class="nc" id="L1322">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1323">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L1325">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1326">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1327">                .moveActivityIdTo(&quot;parallelTask&quot;, &quot;signalEventSubProcessTask&quot;)</span>
<span class="nc" id="L1328">                .changeState();</span>

<span class="nc" id="L1330">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1331">        assertThat(executions)</span>
<span class="nc" id="L1332">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1333">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;signalEventSubProcess&quot;, &quot;signalEventSubProcessTask&quot;, &quot;processTask&quot;, &quot;spawnParallelTask&quot;);</span>

<span class="nc" id="L1335">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1336">        assertThat(tasks)</span>
<span class="nc" id="L1337">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1338">                .containsExactlyInAnyOrder(&quot;signalEventSubProcessTask&quot;, &quot;processTask&quot;);</span>

<span class="nc" id="L1340">        eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1341">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L1343">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L1344">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1345">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.TimerParallelNestedSignalEventSubProcess.bpmn20.xml&quot; })
    public void testSetParallelActivityToActivityInsideNestedSignalEventSubProcessWithActivityAtParentScope() {
<span class="nc" id="L1351">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

<span class="nc" id="L1353">        Task currentTask = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

        //Spawn a parallel task
<span class="nc" id="L1356">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1357">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1358">        managementService.executeJob(job.getId());</span>

        //Move the current task inside the subProcess
<span class="nc" id="L1361">        completeTask(currentTask);</span>

<span class="nc" id="L1363">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1364">        assertThat(executions)</span>
<span class="nc" id="L1365">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1366">                .containsExactlyInAnyOrder(&quot;parallelTask&quot;, &quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;signalEventSubProcessStart&quot;);</span>

<span class="nc" id="L1368">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1369">        assertThat(tasks)</span>
<span class="nc" id="L1370">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1371">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;parallelTask&quot;);</span>

<span class="nc" id="L1373">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1374">        assertThat(eventSubscription)</span>
<span class="nc" id="L1375">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L1376">                .containsExactly(&quot;signalEventSubProcessStart&quot;, &quot;signal&quot;, &quot;eventSignal&quot;);</span>

<span class="nc" id="L1378">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1379">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1380">                .moveActivityIdTo(&quot;parallelTask&quot;, &quot;signalEventSubProcessTask&quot;)</span>
<span class="nc" id="L1381">                .changeState();</span>

<span class="nc" id="L1383">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1384">        assertThat(executions)</span>
<span class="nc" id="L1385">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1386">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;signalEventSubProcess&quot;, &quot;signalEventSubProcessTask&quot;);</span>

<span class="nc" id="L1388">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1389">        assertThat(tasks)</span>
<span class="nc" id="L1390">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1391">                .containsExactly(&quot;signalEventSubProcessTask&quot;);</span>

<span class="nc" id="L1393">        eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1394">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L1396">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L1397">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1398">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.TimerParallelNestedMessageEventSubProcess.bpmn20.xml&quot; })
    public void testSetParallelActivityToActivityInsideNestedMessageEventSubProcessWithActivityAtRootScope() {
<span class="nc" id="L1404">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

        //Spawn a parallel task
<span class="nc" id="L1407">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1408">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1409">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L1411">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1412">        assertThat(executions)</span>
<span class="nc" id="L1413">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1414">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;, &quot;spawnParallelTask&quot;);</span>

<span class="nc" id="L1416">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1417">        assertThat(tasks)</span>
<span class="nc" id="L1418">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1419">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>

<span class="nc" id="L1421">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1422">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L1424">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1425">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1426">                .moveActivityIdTo(&quot;parallelTask&quot;, &quot;messageEventSubProcessTask&quot;)</span>
<span class="nc" id="L1427">                .changeState();</span>

<span class="nc" id="L1429">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1430">        assertThat(executions)</span>
<span class="nc" id="L1431">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1432">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;messageEventSubProcess&quot;, &quot;messageEventSubProcessTask&quot;, &quot;processTask&quot;, &quot;spawnParallelTask&quot;);</span>

<span class="nc" id="L1434">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1435">        assertThat(tasks)</span>
<span class="nc" id="L1436">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1437">                .containsExactlyInAnyOrder(&quot;messageEventSubProcessTask&quot;, &quot;processTask&quot;);</span>

<span class="nc" id="L1439">        eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1440">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L1442">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L1443">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1444">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.TimerParallelNestedMessageEventSubProcess.bpmn20.xml&quot; })
    public void testSetParallelActivityToActivityInsideNestedMessageEventSubProcessWithActivityAtParentScope() {
<span class="nc" id="L1450">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

<span class="nc" id="L1452">        Task currentTask = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

        //Spawn a parallel task
<span class="nc" id="L1455">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1456">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1457">        managementService.executeJob(job.getId());</span>

        //Move the current task inside the subProcess
<span class="nc" id="L1460">        completeTask(currentTask);</span>

<span class="nc" id="L1462">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1463">        assertThat(executions)</span>
<span class="nc" id="L1464">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1465">                .containsExactlyInAnyOrder(&quot;parallelTask&quot;, &quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;messageEventSubProcessStart&quot;);</span>

<span class="nc" id="L1467">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1468">        assertThat(tasks)</span>
<span class="nc" id="L1469">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1470">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;parallelTask&quot;);</span>

<span class="nc" id="L1472">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1473">        assertThat(eventSubscription)</span>
<span class="nc" id="L1474">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L1475">                .containsExactly(&quot;messageEventSubProcessStart&quot;, &quot;message&quot;, &quot;eventMessage&quot;);</span>

<span class="nc" id="L1477">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1478">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1479">                .moveActivityIdTo(&quot;parallelTask&quot;, &quot;messageEventSubProcessTask&quot;)</span>
<span class="nc" id="L1480">                .changeState();</span>

<span class="nc" id="L1482">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1483">        assertThat(executions)</span>
<span class="nc" id="L1484">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1485">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;messageEventSubProcess&quot;, &quot;messageEventSubProcessTask&quot;);</span>

<span class="nc" id="L1487">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1488">        assertThat(tasks).extracting(Task::getTaskDefinitionKey).containsExactlyInAnyOrder(&quot;messageEventSubProcessTask&quot;);</span>

<span class="nc" id="L1490">        eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1491">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L1493">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L1494">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1495">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.TimerParallelNestedTimerEventSubProcess.bpmn20.xml&quot; })
    public void testSetParallelActivityToActivityInsideNestedTimerEventSubProcessWithActivityAtRootScope() {
<span class="nc" id="L1501">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

        //Spawn a parallel task
<span class="nc" id="L1504">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1505">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1506">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L1508">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1509">        assertThat(executions)</span>
<span class="nc" id="L1510">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1511">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;, &quot;spawnParallelTask&quot;);</span>

<span class="nc" id="L1513">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1514">        assertThat(tasks)</span>
<span class="nc" id="L1515">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1516">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>

        //The TimerEvent SubProcess stat time is not registered
<span class="nc" id="L1519">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1520">        assertThat(job).isNull();</span>

<span class="nc" id="L1522">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1523">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1524">                .moveActivityIdTo(&quot;parallelTask&quot;, &quot;timerEventSubProcessTask&quot;)</span>
<span class="nc" id="L1525">                .changeState();</span>

<span class="nc" id="L1527">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1528">        assertThat(executions)</span>
<span class="nc" id="L1529">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1530">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;timerEventSubProcess&quot;, &quot;timerEventSubProcessTask&quot;, &quot;processTask&quot;, &quot;spawnParallelTask&quot;);</span>

<span class="nc" id="L1532">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1533">        assertThat(tasks)</span>
<span class="nc" id="L1534">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1535">                .containsExactlyInAnyOrder(&quot;timerEventSubProcessTask&quot;, &quot;processTask&quot;);</span>

<span class="nc" id="L1537">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1538">        assertThat(job).isNull();</span>

<span class="nc" id="L1540">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L1541">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1542">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.TimerParallelNestedTimerEventSubProcess.bpmn20.xml&quot; })
    public void testSetParallelActivityToActivityInsideNestedTimerEventSubProcessWithActivityAtParentScope() {
<span class="nc" id="L1548">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

<span class="nc" id="L1550">        Task currentTask = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

        //Spawn a parallel task
<span class="nc" id="L1553">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1554">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1555">        managementService.executeJob(job.getId());</span>

        //Move the current task inside the subProcess
<span class="nc" id="L1558">        completeTask(currentTask);</span>

<span class="nc" id="L1560">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1561">        assertThat(executions)</span>
<span class="nc" id="L1562">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1563">                .containsExactlyInAnyOrder(&quot;parallelTask&quot;, &quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;timerEventSubProcessStart&quot;);</span>

<span class="nc" id="L1565">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1566">        assertThat(tasks)</span>
<span class="nc" id="L1567">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1568">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;parallelTask&quot;);</span>

        //The TimerEvent SubProcess stat time is not registered
<span class="nc" id="L1571">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1572">        assertThat(job)</span>
<span class="nc" id="L1573">                .extracting(this::getJobActivityId)</span>
<span class="nc" id="L1574">                .isEqualTo(&quot;timerEventSubProcessStart&quot;);</span>

<span class="nc" id="L1576">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1577">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1578">                .moveActivityIdTo(&quot;parallelTask&quot;, &quot;timerEventSubProcessTask&quot;)</span>
<span class="nc" id="L1579">                .changeState();</span>

<span class="nc" id="L1581">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1582">        assertThat(executions)</span>
<span class="nc" id="L1583">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1584">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;timerEventSubProcess&quot;, &quot;timerEventSubProcessTask&quot;);</span>

<span class="nc" id="L1586">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1587">        assertThat(tasks)</span>
<span class="nc" id="L1588">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1589">                .containsExactly(&quot;timerEventSubProcessTask&quot;);</span>

<span class="nc" id="L1591">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1592">        assertThat(job).isNull();</span>

<span class="nc" id="L1594">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L1595">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1596">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.TimerParallelNestedNonInterruptingSignalEventSubProcess.bpmn20.xml&quot; })
    public void testSetParallelActivityToActivityInsideNestedNonInterruptingSignalEventSubProcessWithActivityAtRootScope() {
<span class="nc" id="L1602">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

        //Spawn a parallel task
<span class="nc" id="L1605">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1606">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1607">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L1609">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1610">        assertThat(executions)</span>
<span class="nc" id="L1611">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1612">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;, &quot;spawnParallelTask&quot;);</span>

<span class="nc" id="L1614">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1615">        assertThat(tasks)</span>
<span class="nc" id="L1616">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1617">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>

<span class="nc" id="L1619">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1620">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L1622">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1623">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1624">                .moveActivityIdTo(&quot;parallelTask&quot;, &quot;signalEventSubProcessTask&quot;)</span>
<span class="nc" id="L1625">                .changeState();</span>

        //Behaves like interrupting eventSubProcess since there are other executions at the parentScope
<span class="nc" id="L1628">        eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1629">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L1631">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1632">        assertThat(executions)</span>
<span class="nc" id="L1633">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1634">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;signalEventSubProcess&quot;, &quot;signalEventSubProcessTask&quot;, &quot;processTask&quot;, &quot;spawnParallelTask&quot;);</span>

<span class="nc" id="L1636">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1637">        assertThat(tasks)</span>
<span class="nc" id="L1638">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1639">                .containsExactlyInAnyOrder(&quot;signalEventSubProcessTask&quot;, &quot;processTask&quot;);</span>

<span class="nc" id="L1641">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L1642">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1643">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.TimerParallelNestedNonInterruptingSignalEventSubProcess.bpmn20.xml&quot; })
    public void testSetParallelActivityToActivityInsideNestedNonInterruptingSignalEventSubProcessWithActivityAtParentScope() {
<span class="nc" id="L1649">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

<span class="nc" id="L1651">        Task currentTask = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

        //Spawn a parallel task
<span class="nc" id="L1654">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1655">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1656">        managementService.executeJob(job.getId());</span>

        //Move the current task inside the subProcess
<span class="nc" id="L1659">        completeTask(currentTask);</span>

<span class="nc" id="L1661">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1662">        assertThat(executions)</span>
<span class="nc" id="L1663">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1664">                .containsExactlyInAnyOrder(&quot;parallelTask&quot;, &quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;signalEventSubProcessStart&quot;);</span>

<span class="nc" id="L1666">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1667">        assertThat(tasks)</span>
<span class="nc" id="L1668">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1669">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;parallelTask&quot;);</span>

<span class="nc" id="L1671">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1672">        assertThat(eventSubscription)</span>
<span class="nc" id="L1673">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L1674">                .containsExactly(&quot;signalEventSubProcessStart&quot;, &quot;signal&quot;, &quot;eventSignal&quot;);</span>

<span class="nc" id="L1676">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1677">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1678">                .moveActivityIdTo(&quot;parallelTask&quot;, &quot;signalEventSubProcessTask&quot;)</span>
<span class="nc" id="L1679">                .changeState();</span>

<span class="nc" id="L1681">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1682">        assertThat(executions)</span>
<span class="nc" id="L1683">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1684">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;signalEventSubProcessStart&quot;, &quot;signalEventSubProcess&quot;, &quot;signalEventSubProcessTask&quot;);</span>

<span class="nc" id="L1686">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1687">        assertThat(tasks)</span>
<span class="nc" id="L1688">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1689">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;signalEventSubProcessTask&quot;);</span>

<span class="nc" id="L1691">        eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1692">        assertThat(eventSubscription)</span>
<span class="nc" id="L1693">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L1694">                .containsExactly(&quot;signalEventSubProcessStart&quot;, &quot;signal&quot;, &quot;eventSignal&quot;);</span>

        //We can trigger the event again
<span class="nc" id="L1697">        runtimeService.signalEventReceived(&quot;eventSignal&quot;);</span>

<span class="nc" id="L1699">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1700">        assertThat(executions)</span>
<span class="nc" id="L1701">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1702">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;signalEventSubProcessStart&quot;, &quot;signalEventSubProcess&quot;, &quot;signalEventSubProcessTask&quot;,</span>
                        &quot;signalEventSubProcess&quot;, &quot;signalEventSubProcessTask&quot;);

<span class="nc" id="L1705">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1706">        assertThat(tasks)</span>
<span class="nc" id="L1707">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1708">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;signalEventSubProcessTask&quot;, &quot;signalEventSubProcessTask&quot;);</span>

<span class="nc" id="L1710">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L1711">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1712">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.TimerParallelNestedNonInterruptingMessageEventSubProcess.bpmn20.xml&quot; })
    public void testSetParallelActivityToActivityInsideNestedNonInterruptingMessageEventSubProcessWithActivityAtRootScope() {
<span class="nc" id="L1718">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

        //Spawn a parallel task
<span class="nc" id="L1721">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1722">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1723">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L1725">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1726">        assertThat(executions)</span>
<span class="nc" id="L1727">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1728">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;, &quot;spawnParallelTask&quot;);</span>

<span class="nc" id="L1730">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1731">        assertThat(tasks)</span>
<span class="nc" id="L1732">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1733">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>

<span class="nc" id="L1735">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1736">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L1738">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1739">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1740">                .moveActivityIdTo(&quot;parallelTask&quot;, &quot;messageEventSubProcessTask&quot;)</span>
<span class="nc" id="L1741">                .changeState();</span>

        //Behaves like interrupting eventSubProcess since there are other executions at the parentScope
<span class="nc" id="L1744">        eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1745">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L1747">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1748">        assertThat(executions)</span>
<span class="nc" id="L1749">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1750">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;messageEventSubProcess&quot;, &quot;messageEventSubProcessTask&quot;, &quot;processTask&quot;, &quot;spawnParallelTask&quot;);</span>

<span class="nc" id="L1752">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1753">        assertThat(tasks)</span>
<span class="nc" id="L1754">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1755">                .containsExactlyInAnyOrder(&quot;messageEventSubProcessTask&quot;, &quot;processTask&quot;);</span>

<span class="nc" id="L1757">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L1758">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1759">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.TimerParallelNestedNonInterruptingMessageEventSubProcess.bpmn20.xml&quot; })
    public void testSetParallelActivityToActivityInsideNestedNonInterruptingMessageEventSubProcessWithActivityAtParentScope() {
<span class="nc" id="L1765">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

<span class="nc" id="L1767">        Task currentTask = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

        //Spawn a parallel task
<span class="nc" id="L1770">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1771">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1772">        managementService.executeJob(job.getId());</span>

        //Move the current task inside the subProcess
<span class="nc" id="L1775">        completeTask(currentTask);</span>

<span class="nc" id="L1777">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1778">        assertThat(executions)</span>
<span class="nc" id="L1779">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1780">                .containsExactlyInAnyOrder(&quot;parallelTask&quot;, &quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;messageEventSubProcessStart&quot;);</span>

<span class="nc" id="L1782">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1783">        assertThat(tasks)</span>
<span class="nc" id="L1784">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1785">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;parallelTask&quot;);</span>

<span class="nc" id="L1787">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1788">        assertThat(eventSubscription)</span>
<span class="nc" id="L1789">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L1790">                .containsExactly(&quot;messageEventSubProcessStart&quot;, &quot;message&quot;, &quot;eventMessage&quot;);</span>

<span class="nc" id="L1792">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1793">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1794">                .moveActivityIdTo(&quot;parallelTask&quot;, &quot;messageEventSubProcessTask&quot;)</span>
<span class="nc" id="L1795">                .changeState();</span>

<span class="nc" id="L1797">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1798">        assertThat(executions)</span>
<span class="nc" id="L1799">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1800">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;messageEventSubProcessStart&quot;, &quot;messageEventSubProcess&quot;,</span>
                        &quot;messageEventSubProcessTask&quot;);

<span class="nc" id="L1803">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1804">        assertThat(tasks)</span>
<span class="nc" id="L1805">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1806">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;messageEventSubProcessTask&quot;);</span>

<span class="nc" id="L1808">        eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1809">        assertThat(eventSubscription)</span>
<span class="nc" id="L1810">                .extracting(EventSubscription::getActivityId, EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L1811">                .containsExactly(&quot;messageEventSubProcessStart&quot;, &quot;message&quot;, &quot;eventMessage&quot;);</span>

        //We can trigger the event again
<span class="nc" id="L1814">        Execution messageSubscriptionExecution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1815">                .messageEventSubscriptionName(&quot;eventMessage&quot;).singleResult();</span>
<span class="nc" id="L1816">        runtimeService.messageEventReceived(&quot;eventMessage&quot;, messageSubscriptionExecution.getId());</span>

<span class="nc" id="L1818">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1819">        assertThat(executions)</span>
<span class="nc" id="L1820">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1821">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;messageEventSubProcessStart&quot;, &quot;messageEventSubProcess&quot;,</span>
                        &quot;messageEventSubProcessTask&quot;, &quot;messageEventSubProcess&quot;, &quot;messageEventSubProcessTask&quot;);

<span class="nc" id="L1824">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1825">        assertThat(tasks)</span>
<span class="nc" id="L1826">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1827">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;messageEventSubProcessTask&quot;, &quot;messageEventSubProcessTask&quot;);</span>

<span class="nc" id="L1829">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L1830">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1831">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.TimerParallelNestedNonInterruptingTimerEventSubProcess.bpmn20.xml&quot; })
    public void testSetParallelActivityToActivityInsideNestedNonInterruptingTimerEventSubProcessWithActivityAtRootScope() {
<span class="nc" id="L1837">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

        //Spawn a parallel task
<span class="nc" id="L1840">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1841">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1842">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L1844">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1845">        assertThat(executions)</span>
<span class="nc" id="L1846">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1847">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;, &quot;spawnParallelTask&quot;);</span>

<span class="nc" id="L1849">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1850">        assertThat(tasks)</span>
<span class="nc" id="L1851">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1852">                .containsExactlyInAnyOrder(&quot;processTask&quot;, &quot;parallelTask&quot;);</span>

<span class="nc" id="L1854">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1855">        assertThat(eventSubscription).isNull();</span>

<span class="nc" id="L1857">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1858">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1859">                .moveActivityIdTo(&quot;parallelTask&quot;, &quot;timerEventSubProcessTask&quot;)</span>
<span class="nc" id="L1860">                .changeState();</span>

        //Behaves like interrupting eventSubProcess since there are other executions at the parentScope
<span class="nc" id="L1863">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1864">        assertThat(job).isNull();</span>

<span class="nc" id="L1866">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1867">        assertThat(executions)</span>
<span class="nc" id="L1868">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1869">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;timerEventSubProcess&quot;, &quot;timerEventSubProcessTask&quot;, &quot;processTask&quot;, &quot;spawnParallelTask&quot;);</span>

<span class="nc" id="L1871">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1872">        assertThat(tasks)</span>
<span class="nc" id="L1873">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1874">                .containsExactlyInAnyOrder(&quot;timerEventSubProcessTask&quot;, &quot;processTask&quot;);</span>

<span class="nc" id="L1876">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L1877">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1878">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/runtime/changestate/RuntimeServiceChangeStateTest.TimerParallelNestedNonInterruptingTimerEventSubProcess.bpmn20.xml&quot; })
    public void testSetParallelActivityToActivityInsideNestedNonInterruptingTimerEventSubProcessWithActivityAtParentScope() {
<span class="nc" id="L1884">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;changeStateForEventSubProcess&quot;);</span>

<span class="nc" id="L1886">        Task currentTask = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

        //Spawn a parallel task
<span class="nc" id="L1889">        Job job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1890">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1891">        managementService.executeJob(job.getId());</span>

        //Move the current task inside the subProcess
<span class="nc" id="L1894">        completeTask(currentTask);</span>

<span class="nc" id="L1896">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1897">        assertThat(executions)</span>
<span class="nc" id="L1898">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1899">                .containsExactlyInAnyOrder(&quot;parallelTask&quot;, &quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;timerEventSubProcessStart&quot;);</span>

<span class="nc" id="L1901">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1902">        assertThat(tasks)</span>
<span class="nc" id="L1903">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1904">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;parallelTask&quot;);</span>

<span class="nc" id="L1906">        List&lt;Job&gt; jobs = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1907">        assertThat(jobs)</span>
<span class="nc" id="L1908">                .extracting(this::getJobActivityId)</span>
<span class="nc" id="L1909">                .contains(&quot;timerEventSubProcessStart&quot;);</span>

<span class="nc" id="L1911">        runtimeService.createChangeActivityStateBuilder()</span>
<span class="nc" id="L1912">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1913">                .moveActivityIdTo(&quot;parallelTask&quot;, &quot;timerEventSubProcessTask&quot;)</span>
<span class="nc" id="L1914">                .changeState();</span>

<span class="nc" id="L1916">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1917">        assertThat(executions)</span>
<span class="nc" id="L1918">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1919">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;timerEventSubProcessStart&quot;, &quot;timerEventSubProcess&quot;, &quot;timerEventSubProcessTask&quot;);</span>

<span class="nc" id="L1921">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1922">        assertThat(tasks)</span>
<span class="nc" id="L1923">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1924">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;timerEventSubProcessTask&quot;);</span>

<span class="nc" id="L1926">        job = managementService.createTimerJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1927">        assertThat(job)</span>
<span class="nc" id="L1928">                .extracting(this::getJobActivityId)</span>
<span class="nc" id="L1929">                .isEqualTo(&quot;timerEventSubProcessStart&quot;);</span>

        //We can trigger the event again
<span class="nc" id="L1932">        managementService.moveTimerToExecutableJob(job.getId());</span>
<span class="nc" id="L1933">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L1935">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().list();</span>
<span class="nc" id="L1936">        assertThat(executions)</span>
<span class="nc" id="L1937">                .extracting(Execution::getActivityId)</span>
<span class="nc" id="L1938">                .containsExactlyInAnyOrder(&quot;subProcess&quot;, &quot;subProcessTask&quot;, &quot;timerEventSubProcessStart&quot;, &quot;timerEventSubProcess&quot;, &quot;timerEventSubProcessTask&quot;,</span>
                        &quot;timerEventSubProcess&quot;, &quot;timerEventSubProcessTask&quot;);

<span class="nc" id="L1941">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1942">        assertThat(tasks)</span>
<span class="nc" id="L1943">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L1944">                .containsExactlyInAnyOrder(&quot;subProcessTask&quot;, &quot;timerEventSubProcessTask&quot;, &quot;timerEventSubProcessTask&quot;);</span>

<span class="nc" id="L1946">        completeProcessInstanceTasks(processInstance.getId());</span>
<span class="nc" id="L1947">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1948">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>