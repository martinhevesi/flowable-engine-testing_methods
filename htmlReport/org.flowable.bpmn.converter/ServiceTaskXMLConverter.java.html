<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ServiceTaskXMLConverter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.bpmn.converter</a> &gt; <span class="el_source">ServiceTaskXMLConverter.java</span></div><h1>ServiceTaskXMLConverter.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.bpmn.converter;

import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.xml.stream.XMLStreamReader;
import javax.xml.stream.XMLStreamWriter;

import org.apache.commons.lang3.StringUtils;
import org.flowable.bpmn.constants.BpmnXMLConstants;
import org.flowable.bpmn.converter.child.BaseChildElementParser;
import org.flowable.bpmn.converter.child.EventInParameterParser;
import org.flowable.bpmn.converter.child.EventOutParameterParser;
import org.flowable.bpmn.converter.child.InParameterParser;
import org.flowable.bpmn.converter.child.OutParameterParser;
import org.flowable.bpmn.converter.export.FieldExtensionExport;
import org.flowable.bpmn.converter.export.MapExceptionExport;
import org.flowable.bpmn.converter.export.ScriptInfoExport;
import org.flowable.bpmn.converter.util.BpmnXMLUtil;
import org.flowable.bpmn.model.AbstractFlowableHttpHandler;
import org.flowable.bpmn.model.BaseElement;
import org.flowable.bpmn.model.BpmnModel;
import org.flowable.bpmn.model.CaseServiceTask;
import org.flowable.bpmn.model.CustomProperty;
import org.flowable.bpmn.model.ExtensionAttribute;
import org.flowable.bpmn.model.ExtensionElement;
import org.flowable.bpmn.model.ExternalWorkerServiceTask;
import org.flowable.bpmn.model.HttpServiceTask;
import org.flowable.bpmn.model.ImplementationType;
import org.flowable.bpmn.model.SendEventServiceTask;
import org.flowable.bpmn.model.ServiceTask;

/**
 * @author Tijs Rademakers
 */
public class ServiceTaskXMLConverter extends BaseBpmnXMLConverter {

<span class="nc" id="L52">    protected Map&lt;String, BaseChildElementParser&gt; caseServiceChildParserMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L53">    protected Map&lt;String, BaseChildElementParser&gt; sendEventServiceChildParserMap = new HashMap&lt;&gt;();</span>
    
<span class="nc" id="L55">    protected static final List&lt;ExtensionAttribute&gt; defaultServiceTaskAttributes = Arrays.asList(</span>
            new ExtensionAttribute(ATTRIBUTE_TYPE),
            new ExtensionAttribute(ATTRIBUTE_TASK_SERVICE_CLASS),
            new ExtensionAttribute(ATTRIBUTE_TASK_SERVICE_EXPRESSION),
            new ExtensionAttribute(ATTRIBUTE_TASK_SERVICE_DELEGATEEXPRESSION),
            new ExtensionAttribute(ATTRIBUTE_TASK_IMPLEMENTATION),
            new ExtensionAttribute(ATTRIBUTE_TASK_OPERATION_REF),
            new ExtensionAttribute(ATTRIBUTE_TASK_SERVICE_RESULT_VARIABLE_NAME),
            new ExtensionAttribute(ATTRIBUTE_TASK_SERVICE_RESULT_VARIABLE),
            new ExtensionAttribute(ATTRIBUTE_TASK_SERVICE_USE_LOCAL_SCOPE_FOR_RESULT_VARIABLE),
            new ExtensionAttribute(ATTRIBUTE_TASK_SERVICE_STORE_RESULT_AS_TRANSIENT),
            new ExtensionAttribute(ATTRIBUTE_TASK_SERVICE_EXTENSIONID),
            new ExtensionAttribute(ATTRIBUTE_TASK_SERVICE_SKIP_EXPRESSION),
            new ExtensionAttribute(ATTRIBUTE_ACTIVITY_TRIGGERABLE),
            new ExtensionAttribute(ATTRIBUTE_TASK_EXTERNAL_WORKER_TOPIC),
            new ExtensionAttribute(ATTRIBUTE_TASK_HTTP_PARALLEL_IN_SAME_TRANSACTION),
            new ExtensionAttribute(ATTRIBUTE_CASE_TASK_CASE_DEFINITION_KEY),
            new ExtensionAttribute(ATTRIBUTE_CASE_TASK_CASE_INSTANCE_NAME),
            new ExtensionAttribute(ATTRIBUTE_BUSINESS_KEY),
            new ExtensionAttribute(ATTRIBUTE_INHERIT_BUSINESS_KEY),
            new ExtensionAttribute(ATTRIBUTE_SAME_DEPLOYMENT),
            new ExtensionAttribute(ATTRIBUTE_FALLBACK_TO_DEFAULT_TENANT),
            new ExtensionAttribute(ATTRIBUTE_ID_VARIABLE_NAME));

<span class="nc" id="L79">    public ServiceTaskXMLConverter() {</span>

        // Case service
<span class="nc" id="L82">        InParameterParser inParameterParser = new InParameterParser();</span>
<span class="nc" id="L83">        caseServiceChildParserMap.put(inParameterParser.getElementName(), inParameterParser);</span>
<span class="nc" id="L84">        OutParameterParser outParameterParser = new OutParameterParser();</span>
<span class="nc" id="L85">        caseServiceChildParserMap.put(outParameterParser.getElementName(), outParameterParser);</span>

        // Send event service
<span class="nc" id="L88">        EventInParameterParser eventInParameterParser = new EventInParameterParser();</span>
<span class="nc" id="L89">        sendEventServiceChildParserMap.put(eventInParameterParser.getElementName(), eventInParameterParser);</span>
<span class="nc" id="L90">        EventOutParameterParser eventOutParameterParser = new EventOutParameterParser();</span>
<span class="nc" id="L91">        sendEventServiceChildParserMap.put(eventOutParameterParser.getElementName(), eventOutParameterParser);</span>
<span class="nc" id="L92">    }</span>

    @Override
    public Class&lt;? extends BaseElement&gt; getBpmnElementType() {
<span class="nc" id="L96">        return ServiceTask.class;</span>
    }

    @Override
    protected String getXMLElementName() {
<span class="nc" id="L101">        return ELEMENT_TASK_SERVICE;</span>
    }

    @Override
    @SuppressWarnings(&quot;unchecked&quot;)
    protected BaseElement convertXMLToElement(XMLStreamReader xtr, BpmnModel model) throws Exception {
<span class="nc" id="L107">        String serviceTaskType = BpmnXMLUtil.getAttributeValue(ATTRIBUTE_TYPE, xtr);</span>
        
<span class="nc" id="L109">        ServiceTask serviceTask = null;</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (ServiceTask.HTTP_TASK.equals(serviceTaskType)) {</span>
<span class="nc" id="L111">            serviceTask = new HttpServiceTask();</span>
            
<span class="nc bnc" id="L113" title="All 2 branches missed.">        } else if (ServiceTask.CASE_TASK.equals(serviceTaskType)) {</span>
<span class="nc" id="L114">            serviceTask = new CaseServiceTask();</span>
            
<span class="nc bnc" id="L116" title="All 2 branches missed.">        } else if (ServiceTask.SEND_EVENT_TASK.equals(serviceTaskType)) {</span>
<span class="nc" id="L117">            serviceTask = new SendEventServiceTask();</span>
            
<span class="nc bnc" id="L119" title="All 4 branches missed.">        } else if (ServiceTask.EXTERNAL_WORKER_TASK.equals(serviceTaskType) || ServiceTask.EXTERNAL_WORKER_TASK_LEGACY.equals(serviceTaskType)) {</span>
<span class="nc" id="L120">            serviceTaskType = ServiceTask.EXTERNAL_WORKER_TASK;</span>
<span class="nc" id="L121">            serviceTask = new ExternalWorkerServiceTask();</span>
            
        } else {
<span class="nc" id="L124">            serviceTask = new ServiceTask();</span>
        }
        
<span class="nc" id="L127">        BpmnXMLUtil.addXMLLocation(serviceTask, xtr);</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(BpmnXMLUtil.getAttributeValue(ATTRIBUTE_TASK_SERVICE_CLASS, xtr))) {</span>
<span class="nc" id="L129">            serviceTask.setImplementationType(ImplementationType.IMPLEMENTATION_TYPE_CLASS);</span>
<span class="nc" id="L130">            serviceTask.setImplementation(BpmnXMLUtil.getAttributeValue(ATTRIBUTE_TASK_SERVICE_CLASS, xtr));</span>

<span class="nc bnc" id="L132" title="All 2 branches missed.">        } else if (StringUtils.isNotEmpty(BpmnXMLUtil.getAttributeValue(ATTRIBUTE_TASK_SERVICE_EXPRESSION, xtr))) {</span>
<span class="nc" id="L133">            serviceTask.setImplementationType(ImplementationType.IMPLEMENTATION_TYPE_EXPRESSION);</span>
<span class="nc" id="L134">            serviceTask.setImplementation(BpmnXMLUtil.getAttributeValue(ATTRIBUTE_TASK_SERVICE_EXPRESSION, xtr));</span>

<span class="nc bnc" id="L136" title="All 2 branches missed.">        } else if (StringUtils.isNotEmpty(BpmnXMLUtil.getAttributeValue(ATTRIBUTE_TASK_SERVICE_DELEGATEEXPRESSION, xtr))) {</span>
<span class="nc" id="L137">            serviceTask.setImplementationType(ImplementationType.IMPLEMENTATION_TYPE_DELEGATEEXPRESSION);</span>
<span class="nc" id="L138">            serviceTask.setImplementation(BpmnXMLUtil.getAttributeValue(ATTRIBUTE_TASK_SERVICE_DELEGATEEXPRESSION, xtr));</span>

<span class="nc bnc" id="L140" title="All 2 branches missed.">        } else if (&quot;##WebService&quot;.equals(xtr.getAttributeValue(null, ATTRIBUTE_TASK_IMPLEMENTATION))) {</span>
<span class="nc" id="L141">            serviceTask.setImplementationType(ImplementationType.IMPLEMENTATION_TYPE_WEBSERVICE);</span>
<span class="nc" id="L142">            serviceTask.setOperationRef(parseOperationRef(xtr.getAttributeValue(null, ATTRIBUTE_TASK_OPERATION_REF), model));</span>
        }

<span class="nc" id="L145">        serviceTask.setResultVariableName(BpmnXMLUtil.getAttributeValue(ATTRIBUTE_TASK_SERVICE_RESULT_VARIABLE_NAME, xtr));</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (StringUtils.isEmpty(serviceTask.getResultVariableName())) {</span>
<span class="nc" id="L147">            serviceTask.setResultVariableName(BpmnXMLUtil.getAttributeValue(ATTRIBUTE_TASK_SERVICE_RESULT_VARIABLE, xtr));</span>
        }

<span class="nc" id="L150">        serviceTask.setUseLocalScopeForResultVariable(Boolean.parseBoolean(BpmnXMLUtil.getAttributeValue(ATTRIBUTE_TASK_SERVICE_USE_LOCAL_SCOPE_FOR_RESULT_VARIABLE, xtr)));</span>
<span class="nc" id="L151">        serviceTask.setStoreResultVariableAsTransient(Boolean.parseBoolean(BpmnXMLUtil.getAttributeValue(ATTRIBUTE_TASK_SERVICE_STORE_RESULT_AS_TRANSIENT, xtr)));</span>

<span class="nc" id="L153">        serviceTask.setType(serviceTaskType);</span>
<span class="nc" id="L154">        serviceTask.setExtensionId(BpmnXMLUtil.getAttributeValue(ATTRIBUTE_TASK_SERVICE_EXTENSIONID, xtr));</span>

<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(BpmnXMLUtil.getAttributeValue(ATTRIBUTE_TASK_SERVICE_SKIP_EXPRESSION, xtr))) {</span>
<span class="nc" id="L157">            serviceTask.setSkipExpression(BpmnXMLUtil.getAttributeValue(ATTRIBUTE_TASK_SERVICE_SKIP_EXPRESSION, xtr));</span>
        }
        
<span class="nc" id="L160">        BpmnXMLUtil.addCustomAttributes(xtr, serviceTask, defaultElementAttributes, defaultActivityAttributes, defaultServiceTaskAttributes);</span>
        
<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (serviceTask instanceof CaseServiceTask) {</span>
<span class="nc" id="L163">            convertCaseServiceTaskXMLProperties((CaseServiceTask) serviceTask, model, xtr);</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">        } else if (serviceTask instanceof SendEventServiceTask) {</span>
<span class="nc" id="L165">            convertSendEventServiceTaskXMLProperties((SendEventServiceTask) serviceTask, model, xtr);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">        } else if (serviceTask instanceof ExternalWorkerServiceTask) {</span>
<span class="nc" id="L167">            convertExternalWorkerTaskXMLProperties((ExternalWorkerServiceTask) serviceTask, model, xtr);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">        } else if (serviceTask instanceof HttpServiceTask) {</span>
<span class="nc" id="L169">            convertHttpServiceTaskXMLProperties((HttpServiceTask) serviceTask, model, xtr);</span>
        } else {
<span class="nc" id="L171">            parseChildElements(getXMLElementName(), serviceTask, model, xtr);</span>
        }

<span class="nc" id="L174">        return serviceTask;</span>
    }

    @Override
    protected void writeAdditionalAttributes(BaseElement element, BpmnModel model, XMLStreamWriter xtw) throws Exception {
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (element instanceof CaseServiceTask) {</span>
<span class="nc" id="L180">            writeCaseServiceTaskAdditionalAttributes(element, model, xtw);</span>

<span class="nc bnc" id="L182" title="All 2 branches missed.">        } else if (element instanceof SendEventServiceTask) {</span>
<span class="nc" id="L183">            writeSendEventServiceAdditionalAttributes(element, model, xtw);</span>

<span class="nc bnc" id="L185" title="All 2 branches missed.">        } else if (element instanceof ExternalWorkerServiceTask) {</span>
<span class="nc" id="L186">            writeExternalTaskAdditionalAttributes((ExternalWorkerServiceTask) element, model, xtw);</span>
            
<span class="nc bnc" id="L188" title="All 2 branches missed.">        } else if (element instanceof HttpServiceTask) {</span>
<span class="nc" id="L189">            writeHttpServiceTaskAdditionalAttributes((HttpServiceTask) element, model, xtw);</span>
            
        } else {
<span class="nc" id="L192">            writeServiceTaskAdditionalAttributes((ServiceTask) element, xtw);</span>
        }
<span class="nc" id="L194">    }</span>

    protected void writeCaseServiceTaskAdditionalAttributes(BaseElement element, BpmnModel model, XMLStreamWriter xtw) throws Exception {
<span class="nc" id="L197">        CaseServiceTask caseServiceTask = (CaseServiceTask) element;</span>
<span class="nc" id="L198">        writeQualifiedAttribute(ATTRIBUTE_TYPE, ServiceTask.CASE_TASK, xtw);</span>

<span class="nc bnc" id="L200" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(caseServiceTask.getSkipExpression())) {</span>
<span class="nc" id="L201">            writeQualifiedAttribute(ATTRIBUTE_TASK_SERVICE_SKIP_EXPRESSION, caseServiceTask.getSkipExpression(), xtw);</span>
        }
<span class="nc bnc" id="L203" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(caseServiceTask.getCaseDefinitionKey())) {</span>
<span class="nc" id="L204">            writeQualifiedAttribute(ATTRIBUTE_CASE_TASK_CASE_DEFINITION_KEY, caseServiceTask.getCaseDefinitionKey(), xtw);</span>
        }
<span class="nc bnc" id="L206" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(caseServiceTask.getCaseInstanceName())) {</span>
<span class="nc" id="L207">            writeQualifiedAttribute(ATTRIBUTE_CASE_TASK_CASE_INSTANCE_NAME, caseServiceTask.getCaseInstanceName(), xtw);</span>
        }
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(caseServiceTask.getBusinessKey())) {</span>
<span class="nc" id="L210">            writeQualifiedAttribute(ATTRIBUTE_BUSINESS_KEY, caseServiceTask.getBusinessKey(), xtw);</span>
        }
<span class="nc bnc" id="L212" title="All 2 branches missed.">        if (caseServiceTask.isInheritBusinessKey()) {</span>
<span class="nc" id="L213">            writeQualifiedAttribute(ATTRIBUTE_INHERIT_BUSINESS_KEY, &quot;true&quot;, xtw);</span>
        }
<span class="nc bnc" id="L215" title="All 2 branches missed.">        if (caseServiceTask.isSameDeployment()) {</span>
<span class="nc" id="L216">            writeQualifiedAttribute(ATTRIBUTE_SAME_DEPLOYMENT, &quot;true&quot;, xtw);</span>
        }
<span class="nc bnc" id="L218" title="All 2 branches missed.">        if (caseServiceTask.isFallbackToDefaultTenant()) {</span>
<span class="nc" id="L219">            writeQualifiedAttribute(ATTRIBUTE_FALLBACK_TO_DEFAULT_TENANT, &quot;true&quot;, xtw);</span>
        }
<span class="nc bnc" id="L221" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(caseServiceTask.getCaseInstanceIdVariableName())) {</span>
<span class="nc" id="L222">            writeQualifiedAttribute(ATTRIBUTE_ID_VARIABLE_NAME, caseServiceTask.getCaseInstanceIdVariableName(), xtw);</span>
        }
<span class="nc" id="L224">    }</span>

    protected void writeSendEventServiceAdditionalAttributes(BaseElement element, BpmnModel model, XMLStreamWriter xtw) throws Exception {
<span class="nc" id="L227">        SendEventServiceTask sendEventServiceTask = (SendEventServiceTask) element;</span>
<span class="nc" id="L228">        writeQualifiedAttribute(ATTRIBUTE_TYPE, ServiceTask.SEND_EVENT_TASK, xtw);</span>

<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(sendEventServiceTask.getSkipExpression())) {</span>
<span class="nc" id="L231">            writeQualifiedAttribute(ATTRIBUTE_TASK_SERVICE_SKIP_EXPRESSION, sendEventServiceTask.getSkipExpression(), xtw);</span>
        }

<span class="nc bnc" id="L234" title="All 2 branches missed.">        if (sendEventServiceTask.isTriggerable()) {</span>
<span class="nc" id="L235">            writeQualifiedAttribute(ATTRIBUTE_TRIGGERABLE, &quot;true&quot;, xtw);</span>
        }
<span class="nc" id="L237">    }</span>

    protected void writeExternalTaskAdditionalAttributes(ExternalWorkerServiceTask externalWorkerTask, BpmnModel model, XMLStreamWriter xtw) throws Exception {
<span class="nc" id="L240">        writeQualifiedAttribute(ATTRIBUTE_TYPE, ServiceTask.EXTERNAL_WORKER_TASK, xtw);</span>
<span class="nc" id="L241">        writeQualifiedAttribute(ATTRIBUTE_TASK_EXTERNAL_WORKER_TOPIC, externalWorkerTask.getTopic(), xtw);</span>

<span class="nc bnc" id="L243" title="All 4 branches missed.">        if (!externalWorkerTask.isAsynchronous() &amp;&amp; externalWorkerTask.isNotExclusive()) {</span>
            // Write the not exclusive only if not async (otherwise it is added in the base)
<span class="nc" id="L245">            writeQualifiedAttribute(ATTRIBUTE_ACTIVITY_EXCLUSIVE, ATTRIBUTE_VALUE_FALSE, xtw);</span>
        }

<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(externalWorkerTask.getSkipExpression())) {</span>
<span class="nc" id="L249">            writeQualifiedAttribute(ATTRIBUTE_TASK_SERVICE_SKIP_EXPRESSION, externalWorkerTask.getSkipExpression(), xtw);</span>
        }
<span class="nc" id="L251">    }</span>


    protected void writeHttpServiceTaskAdditionalAttributes(HttpServiceTask httpServiceTask, BpmnModel model, XMLStreamWriter xtw) throws Exception {

<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (httpServiceTask.getParallelInSameTransaction() != null) {</span>
<span class="nc" id="L257">            writeQualifiedAttribute(ATTRIBUTE_TASK_HTTP_PARALLEL_IN_SAME_TRANSACTION, httpServiceTask.getParallelInSameTransaction().toString(), xtw);</span>
        }

<span class="nc" id="L260">        writeServiceTaskAdditionalAttributes(httpServiceTask, xtw);</span>
<span class="nc" id="L261">    }</span>

    protected void writeServiceTaskAdditionalAttributes(ServiceTask element, XMLStreamWriter xtw) throws Exception {
<span class="nc" id="L264">        ServiceTask serviceTask = element;</span>

<span class="nc bnc" id="L266" title="All 2 branches missed.">        if (ImplementationType.IMPLEMENTATION_TYPE_CLASS.equals(serviceTask.getImplementationType())) {</span>
<span class="nc" id="L267">            writeQualifiedAttribute(ATTRIBUTE_TASK_SERVICE_CLASS, serviceTask.getImplementation(), xtw);</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        } else if (ImplementationType.IMPLEMENTATION_TYPE_EXPRESSION.equals(serviceTask.getImplementationType())) {</span>
<span class="nc" id="L269">            writeQualifiedAttribute(ATTRIBUTE_TASK_SERVICE_EXPRESSION, serviceTask.getImplementation(), xtw);</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">        } else if (ImplementationType.IMPLEMENTATION_TYPE_DELEGATEEXPRESSION.equals(serviceTask.getImplementationType())) {</span>
<span class="nc" id="L271">            writeQualifiedAttribute(ATTRIBUTE_TASK_SERVICE_DELEGATEEXPRESSION, serviceTask.getImplementation(), xtw);</span>
        }

<span class="nc bnc" id="L274" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(serviceTask.getResultVariableName())) {</span>
<span class="nc" id="L275">            writeQualifiedAttribute(ATTRIBUTE_TASK_SERVICE_RESULT_VARIABLE_NAME, serviceTask.getResultVariableName(), xtw);</span>
        }
<span class="nc bnc" id="L277" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(serviceTask.getType())) {</span>
<span class="nc" id="L278">            writeQualifiedAttribute(ATTRIBUTE_TYPE, serviceTask.getType(), xtw);</span>
        }
<span class="nc bnc" id="L280" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(serviceTask.getExtensionId())) {</span>
<span class="nc" id="L281">            writeQualifiedAttribute(ATTRIBUTE_TASK_SERVICE_EXTENSIONID, serviceTask.getExtensionId(), xtw);</span>
        }
<span class="nc bnc" id="L283" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(serviceTask.getSkipExpression())) {</span>
<span class="nc" id="L284">            writeQualifiedAttribute(ATTRIBUTE_TASK_SERVICE_SKIP_EXPRESSION, serviceTask.getSkipExpression(), xtw);</span>
        }
<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (serviceTask.isTriggerable()) {</span>
<span class="nc" id="L287">            writeQualifiedAttribute(ATTRIBUTE_ACTIVITY_TRIGGERABLE, &quot;true&quot;, xtw);</span>
        }

<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (serviceTask.isUseLocalScopeForResultVariable()) {</span>
<span class="nc" id="L291">            writeQualifiedAttribute(ATTRIBUTE_TASK_SERVICE_USE_LOCAL_SCOPE_FOR_RESULT_VARIABLE, &quot;true&quot;, xtw);</span>
        }

<span class="nc bnc" id="L294" title="All 2 branches missed.">        if (serviceTask.isStoreResultVariableAsTransient()) {</span>
<span class="nc" id="L295">            writeQualifiedAttribute(ATTRIBUTE_TASK_SERVICE_STORE_RESULT_AS_TRANSIENT, &quot;true&quot;, xtw);</span>
        }
<span class="nc" id="L297">    }</span>

    @Override
    protected boolean writeExtensionChildElements(BaseElement element, boolean didWriteExtensionStartElement, XMLStreamWriter xtw) throws Exception {
<span class="nc bnc" id="L301" title="All 2 branches missed.">        if (element instanceof CaseServiceTask) {</span>
<span class="nc" id="L302">            return writeCaseServiceTaskExtensionChildElements(element, didWriteExtensionStartElement, xtw);</span>

<span class="nc bnc" id="L304" title="All 2 branches missed.">        } else if (element instanceof SendEventServiceTask) {</span>
<span class="nc" id="L305">            return writeSendServiceExtensionChildElements(element, didWriteExtensionStartElement, xtw);</span>

        } else {
<span class="nc" id="L308">            return writeServiceTaskExtensionChildElements((ServiceTask) element, didWriteExtensionStartElement, xtw);</span>
        }
    }

    protected  boolean writeServiceTaskExtensionChildElements(ServiceTask element, boolean didWriteExtensionStartElement, XMLStreamWriter xtw) throws Exception {
<span class="nc" id="L313">        ServiceTask serviceTask = element;</span>

<span class="nc bnc" id="L315" title="All 2 branches missed.">        if (!serviceTask.getCustomProperties().isEmpty()) {</span>
<span class="nc" id="L316">            writeCustomProperties(serviceTask, didWriteExtensionStartElement, xtw);</span>

        } else {
<span class="nc bnc" id="L319" title="All 2 branches missed.">            if (serviceTask instanceof HttpServiceTask) {</span>
<span class="nc" id="L320">                didWriteExtensionStartElement = writeHttpTaskExtensionElements((HttpServiceTask) serviceTask, didWriteExtensionStartElement, xtw);</span>
            }

<span class="nc" id="L323">            didWriteExtensionStartElement = FieldExtensionExport.writeFieldExtensions(serviceTask.getFieldExtensions(), didWriteExtensionStartElement, xtw);</span>
<span class="nc" id="L324">            didWriteExtensionStartElement = MapExceptionExport.writeMapExceptionExtensions(serviceTask.getMapExceptions(), didWriteExtensionStartElement, xtw);</span>
        }

<span class="nc" id="L327">        return didWriteExtensionStartElement;</span>
    }

    protected boolean writeSendServiceExtensionChildElements(BaseElement element, boolean didWriteExtensionStartElement, XMLStreamWriter xtw) throws Exception {
<span class="nc" id="L331">        SendEventServiceTask sendEventServiceTask = (SendEventServiceTask) element;</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (!didWriteExtensionStartElement) {</span>
<span class="nc" id="L333">            xtw.writeStartElement(ELEMENT_EXTENSIONS);</span>
<span class="nc" id="L334">            didWriteExtensionStartElement = true;</span>
        }
        
<span class="nc" id="L337">        xtw.writeStartElement(FLOWABLE_EXTENSIONS_PREFIX, ELEMENT_EVENT_TYPE, FLOWABLE_EXTENSIONS_NAMESPACE);</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(sendEventServiceTask.getEventType())) {</span>
<span class="nc" id="L339">            xtw.writeCData(sendEventServiceTask.getEventType());</span>
        } else {
<span class="nc" id="L341">            LOGGER.warn(&quot;No event type configured for send event task {}&quot;, sendEventServiceTask.getId());</span>
        }
<span class="nc" id="L343">        xtw.writeEndElement();</span>
        
<span class="nc bnc" id="L345" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(sendEventServiceTask.getTriggerEventType())) {</span>
<span class="nc" id="L346">            xtw.writeStartElement(FLOWABLE_EXTENSIONS_PREFIX, ELEMENT_TRIGGER_EVENT_TYPE, FLOWABLE_EXTENSIONS_NAMESPACE);</span>
<span class="nc" id="L347">            xtw.writeCData(sendEventServiceTask.getTriggerEventType());</span>
<span class="nc" id="L348">            xtw.writeEndElement();</span>
        }
        
<span class="nc bnc" id="L351" title="All 2 branches missed.">        if (sendEventServiceTask.isSendSynchronously()) {</span>
<span class="nc" id="L352">            xtw.writeStartElement(FLOWABLE_EXTENSIONS_PREFIX, ELEMENT_SEND_SYNCHRONOUSLY, FLOWABLE_EXTENSIONS_NAMESPACE);</span>
<span class="nc" id="L353">            xtw.writeCData(String.valueOf(sendEventServiceTask.isSendSynchronously()));</span>
<span class="nc" id="L354">            xtw.writeEndElement();</span>
        }
        
<span class="nc" id="L357">        BpmnXMLUtil.writeIOParameters(ELEMENT_EVENT_IN_PARAMETER, sendEventServiceTask.getEventInParameters(), didWriteExtensionStartElement, xtw);</span>
<span class="nc" id="L358">        BpmnXMLUtil.writeIOParameters(ELEMENT_EVENT_OUT_PARAMETER, sendEventServiceTask.getEventOutParameters(), didWriteExtensionStartElement, xtw);</span>

<span class="nc" id="L360">        return didWriteExtensionStartElement;</span>
    }

    protected boolean writeCaseServiceTaskExtensionChildElements(BaseElement element, boolean didWriteExtensionStartElement, XMLStreamWriter xtw) throws Exception {
<span class="nc" id="L364">        CaseServiceTask caseServiceTask = (CaseServiceTask) element;</span>
<span class="nc" id="L365">        didWriteExtensionStartElement = BpmnXMLUtil.writeIOParameters(ELEMENT_IN_PARAMETERS, caseServiceTask.getInParameters(), didWriteExtensionStartElement, xtw);</span>
<span class="nc" id="L366">        didWriteExtensionStartElement = BpmnXMLUtil.writeIOParameters(ELEMENT_OUT_PARAMETERS, caseServiceTask.getOutParameters(), didWriteExtensionStartElement, xtw);</span>
<span class="nc" id="L367">        return didWriteExtensionStartElement;</span>
    }


    @Override
    protected void writeAdditionalChildElements(BaseElement element, BpmnModel model, XMLStreamWriter xtw) throws Exception {
<span class="nc" id="L373">    }</span>
    
    protected void convertCaseServiceTaskXMLProperties(CaseServiceTask caseServiceTask, BpmnModel bpmnModel, XMLStreamReader xtr) throws Exception {
<span class="nc" id="L376">        String caseDefinitionKey = BpmnXMLUtil.getAttributeValue(ATTRIBUTE_CASE_TASK_CASE_DEFINITION_KEY, xtr);</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(caseDefinitionKey)) {</span>
<span class="nc" id="L378">            caseServiceTask.setCaseDefinitionKey(caseDefinitionKey);</span>
        }

<span class="nc" id="L381">        String caseInstanceName = BpmnXMLUtil.getAttributeValue(ATTRIBUTE_CASE_TASK_CASE_INSTANCE_NAME, xtr);</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(caseInstanceName)) {</span>
<span class="nc" id="L383">            caseServiceTask.setCaseInstanceName(caseInstanceName);</span>
        }

<span class="nc" id="L386">        caseServiceTask.setBusinessKey(BpmnXMLUtil.getAttributeValue(ATTRIBUTE_BUSINESS_KEY, xtr));</span>
<span class="nc" id="L387">        caseServiceTask.setInheritBusinessKey(Boolean.parseBoolean(BpmnXMLUtil.getAttributeValue(ATTRIBUTE_INHERIT_BUSINESS_KEY, xtr)));</span>
<span class="nc" id="L388">        caseServiceTask.setSameDeployment(Boolean.valueOf(BpmnXMLUtil.getAttributeValue(ATTRIBUTE_SAME_DEPLOYMENT, xtr)));</span>
<span class="nc" id="L389">        caseServiceTask.setFallbackToDefaultTenant(Boolean.valueOf(BpmnXMLUtil.getAttributeValue(ATTRIBUTE_FALLBACK_TO_DEFAULT_TENANT, xtr)));</span>
<span class="nc" id="L390">        caseServiceTask.setCaseInstanceIdVariableName(BpmnXMLUtil.getAttributeValue(ATTRIBUTE_ID_VARIABLE_NAME, xtr));</span>
<span class="nc" id="L391">        parseChildElements(getXMLElementName(), caseServiceTask, caseServiceChildParserMap, bpmnModel, xtr);</span>
<span class="nc" id="L392">    }</span>
    
    protected void convertSendEventServiceTaskXMLProperties(SendEventServiceTask sendEventServiceTask, BpmnModel bpmnModel, XMLStreamReader xtr) throws Exception {
<span class="nc" id="L395">        String triggerable = BpmnXMLUtil.getAttributeValue(ATTRIBUTE_TRIGGERABLE, xtr);</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">        if (&quot;true&quot;.equalsIgnoreCase(triggerable)) {</span>
<span class="nc" id="L397">            sendEventServiceTask.setTriggerable(true);</span>
        }

<span class="nc" id="L400">        parseChildElements(getXMLElementName(), sendEventServiceTask, sendEventServiceChildParserMap, bpmnModel, xtr);</span>

        // event related properties are parsed and stored as extension elements (makes export work automatically)

<span class="nc bnc" id="L404" title="All 2 branches missed.">        if (sendEventServiceTask.getExtensionElements() != null) {</span>

<span class="nc" id="L406">            List&lt;ExtensionElement&gt; eventTypeExtensionElements = sendEventServiceTask.getExtensionElements().get(BpmnXMLConstants.ELEMENT_EVENT_TYPE);</span>
<span class="nc bnc" id="L407" title="All 4 branches missed.">            if (eventTypeExtensionElements != null &amp;&amp; !eventTypeExtensionElements.isEmpty()) {</span>
<span class="nc" id="L408">                String eventTypeValue = eventTypeExtensionElements.get(0).getElementText();</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">                if (StringUtils.isNotEmpty(eventTypeValue)) {</span>
<span class="nc" id="L410">                    sendEventServiceTask.setEventType(eventTypeValue);</span>
                }
            }

<span class="nc" id="L414">            List&lt;ExtensionElement&gt; triggerEventTypeExtensionElements = sendEventServiceTask.getExtensionElements().get(BpmnXMLConstants.ELEMENT_TRIGGER_EVENT_TYPE);</span>
<span class="nc bnc" id="L415" title="All 4 branches missed.">            if (triggerEventTypeExtensionElements != null &amp;&amp; !triggerEventTypeExtensionElements.isEmpty()) {</span>
<span class="nc" id="L416">                String triggerEventType = triggerEventTypeExtensionElements.get(0).getElementText();</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">                if (StringUtils.isNotEmpty(triggerEventType)) {</span>
<span class="nc" id="L418">                    sendEventServiceTask.setTriggerEventType(triggerEventType);</span>
                }
            }

<span class="nc" id="L422">            List&lt;ExtensionElement&gt; sendSyncExtensionElements = sendEventServiceTask.getExtensionElements().get(BpmnXMLConstants.ELEMENT_SEND_SYNCHRONOUSLY);</span>
<span class="nc bnc" id="L423" title="All 4 branches missed.">            if (sendSyncExtensionElements != null &amp;&amp; !sendSyncExtensionElements.isEmpty()) {</span>
<span class="nc" id="L424">                String sendSyncValue = sendSyncExtensionElements.get(0).getElementText();</span>
<span class="nc bnc" id="L425" title="All 4 branches missed.">                if (StringUtils.isNotEmpty(sendSyncValue) &amp;&amp; &quot;true&quot;.equalsIgnoreCase(sendSyncValue)) {</span>
<span class="nc" id="L426">                    sendEventServiceTask.setSendSynchronously(true);</span>
                }
            }

        }
<span class="nc" id="L431">    }</span>

    protected void convertExternalWorkerTaskXMLProperties(ExternalWorkerServiceTask externalWorkerServiceTask, BpmnModel bpmnModel, XMLStreamReader xtr) throws Exception {
<span class="nc" id="L434">        externalWorkerServiceTask.setTopic(BpmnXMLUtil.getAttributeValue(ATTRIBUTE_TASK_EXTERNAL_WORKER_TOPIC, xtr));</span>

<span class="nc" id="L436">        parseChildElements(getXMLElementName(), externalWorkerServiceTask, bpmnModel, xtr);</span>
<span class="nc" id="L437">    }</span>

    protected void convertHttpServiceTaskXMLProperties(HttpServiceTask httpServiceTask, BpmnModel bpmnModel, XMLStreamReader xtr) throws Exception {
<span class="nc" id="L440">        String parallelInSameTransaction = BpmnXMLUtil.getAttributeValue(BpmnXMLConstants.ATTRIBUTE_TASK_HTTP_PARALLEL_IN_SAME_TRANSACTION, xtr);</span>

<span class="nc bnc" id="L442" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(parallelInSameTransaction)) {</span>
<span class="nc" id="L443">            httpServiceTask.setParallelInSameTransaction(Boolean.parseBoolean(parallelInSameTransaction));</span>
        }

<span class="nc" id="L446">        parseChildElements(getXMLElementName(), httpServiceTask, bpmnModel, xtr);</span>
<span class="nc" id="L447">    }</span>
    
    protected boolean writeCustomProperties(ServiceTask serviceTask, boolean didWriteExtensionStartElement, XMLStreamWriter xtw) throws Exception {
<span class="nc bnc" id="L450" title="All 2 branches missed.">        for (CustomProperty customProperty : serviceTask.getCustomProperties()) {</span>

<span class="nc bnc" id="L452" title="All 2 branches missed.">            if (StringUtils.isEmpty(customProperty.getSimpleValue())) {</span>
<span class="nc" id="L453">                continue;</span>
            }

<span class="nc bnc" id="L456" title="All 2 branches missed.">            if (!didWriteExtensionStartElement) {</span>
<span class="nc" id="L457">                xtw.writeStartElement(ELEMENT_EXTENSIONS);</span>
<span class="nc" id="L458">                didWriteExtensionStartElement = true;</span>
            }
<span class="nc" id="L460">            xtw.writeStartElement(FLOWABLE_EXTENSIONS_PREFIX, ELEMENT_FIELD, FLOWABLE_EXTENSIONS_NAMESPACE);</span>
<span class="nc" id="L461">            xtw.writeAttribute(ATTRIBUTE_FIELD_NAME, customProperty.getName());</span>
<span class="nc bnc" id="L462" title="All 6 branches missed.">            if ((customProperty.getSimpleValue().contains(&quot;${&quot;) || customProperty.getSimpleValue().contains(&quot;#{&quot;)) &amp;&amp; customProperty.getSimpleValue().contains(&quot;}&quot;)) {</span>

<span class="nc" id="L464">                xtw.writeStartElement(FLOWABLE_EXTENSIONS_PREFIX, ATTRIBUTE_FIELD_EXPRESSION, FLOWABLE_EXTENSIONS_NAMESPACE);</span>
            } else {
<span class="nc" id="L466">                xtw.writeStartElement(FLOWABLE_EXTENSIONS_PREFIX, ELEMENT_FIELD_STRING, FLOWABLE_EXTENSIONS_NAMESPACE);</span>
            }
<span class="nc" id="L468">            xtw.writeCharacters(customProperty.getSimpleValue());</span>
<span class="nc" id="L469">            xtw.writeEndElement();</span>
<span class="nc" id="L470">            xtw.writeEndElement();</span>
<span class="nc" id="L471">        }</span>
        
<span class="nc" id="L473">        return didWriteExtensionStartElement;</span>
    }
    
    protected boolean writeHttpTaskExtensionElements(HttpServiceTask httpServiceTask, boolean didWriteExtensionStartElement, XMLStreamWriter xtw) throws Exception {
<span class="nc bnc" id="L477" title="All 2 branches missed.">        if (httpServiceTask.getHttpRequestHandler() != null) {</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">            if (!didWriteExtensionStartElement) {</span>
<span class="nc" id="L479">                xtw.writeStartElement(ELEMENT_EXTENSIONS);</span>
<span class="nc" id="L480">                didWriteExtensionStartElement = true;</span>
            }
            
<span class="nc" id="L483">            xtw.writeStartElement(FLOWABLE_EXTENSIONS_PREFIX, ELEMENT_HTTP_REQUEST_HANDLER, FLOWABLE_EXTENSIONS_NAMESPACE);</span>
<span class="nc" id="L484">            writeHttpHandlerAttributes(httpServiceTask.getHttpRequestHandler(), xtw);</span>
<span class="nc" id="L485">            xtw.writeEndElement();</span>
        }
        
<span class="nc bnc" id="L488" title="All 2 branches missed.">        if (httpServiceTask.getHttpResponseHandler() != null) {</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">            if (!didWriteExtensionStartElement) {</span>
<span class="nc" id="L490">                xtw.writeStartElement(ELEMENT_EXTENSIONS);</span>
<span class="nc" id="L491">                didWriteExtensionStartElement = true;</span>
            }
            
<span class="nc" id="L494">            xtw.writeStartElement(FLOWABLE_EXTENSIONS_PREFIX, ELEMENT_HTTP_RESPONSE_HANDLER, FLOWABLE_EXTENSIONS_NAMESPACE);</span>
<span class="nc" id="L495">            writeHttpHandlerAttributes(httpServiceTask.getHttpResponseHandler(), xtw);</span>
<span class="nc" id="L496">            xtw.writeEndElement();</span>
        }
        
<span class="nc" id="L499">        return didWriteExtensionStartElement;</span>
    }

    protected String parseOperationRef(String operationRef, BpmnModel model) {
<span class="nc" id="L503">        String result = null;</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(operationRef)) {</span>
<span class="nc" id="L505">            int indexOfP = operationRef.indexOf(':');</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">            if (indexOfP != -1) {</span>
<span class="nc" id="L507">                String prefix = operationRef.substring(0, indexOfP);</span>
<span class="nc" id="L508">                String resolvedNamespace = model.getNamespace(prefix);</span>
<span class="nc" id="L509">                result = resolvedNamespace + &quot;:&quot; + operationRef.substring(indexOfP + 1);</span>
<span class="nc" id="L510">            } else {</span>
<span class="nc" id="L511">                result = model.getTargetNamespace() + &quot;:&quot; + operationRef;</span>
            }
        }
<span class="nc" id="L514">        return result;</span>
    }
    
    protected void writeHttpHandlerAttributes(AbstractFlowableHttpHandler httpHandler, XMLStreamWriter xtw) throws Exception {
<span class="nc bnc" id="L518" title="All 2 branches missed.">        if (ImplementationType.IMPLEMENTATION_TYPE_CLASS.equals(httpHandler.getImplementationType())) {</span>
<span class="nc" id="L519">            xtw.writeAttribute(ATTRIBUTE_TASK_SERVICE_CLASS, httpHandler.getImplementation());</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">        } else if (ImplementationType.IMPLEMENTATION_TYPE_DELEGATEEXPRESSION.equals(httpHandler.getImplementationType())) {</span>
<span class="nc" id="L521">            xtw.writeAttribute(ATTRIBUTE_TASK_SERVICE_DELEGATEEXPRESSION, httpHandler.getImplementation());</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">        } else if (ImplementationType.IMPLEMENTATION_TYPE_SCRIPT.equals(httpHandler.getImplementationType())) {</span>
<span class="nc" id="L523">            xtw.writeAttribute(ATTRIBUTE_TYPE, httpHandler.getImplementationType());</span>
        }
<span class="nc bnc" id="L525" title="All 2 branches missed.">        if (httpHandler.getScriptInfo() != null) {</span>
<span class="nc" id="L526">            ScriptInfoExport.writeScriptInfo(xtw, httpHandler.getScriptInfo());</span>
        }
<span class="nc" id="L528">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>