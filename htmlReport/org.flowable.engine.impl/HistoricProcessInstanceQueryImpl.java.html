<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HistoricProcessInstanceQueryImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.impl</a> &gt; <span class="el_source">HistoricProcessInstanceQueryImpl.java</span></div><h1>HistoricProcessInstanceQueryImpl.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.engine.impl;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Objects;
import java.util.Set;

import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.api.FlowableIllegalArgumentException;
import org.flowable.common.engine.api.query.CacheAwareQuery;
import org.flowable.common.engine.impl.AbstractEngineConfiguration;
import org.flowable.common.engine.impl.interceptor.CommandConfig;
import org.flowable.common.engine.impl.interceptor.CommandContext;
import org.flowable.common.engine.impl.interceptor.CommandExecutor;
import org.flowable.common.engine.impl.persistence.cache.EntityCache;
import org.flowable.engine.history.HistoricProcessInstance;
import org.flowable.engine.history.HistoricProcessInstanceQuery;
import org.flowable.engine.impl.cfg.ProcessEngineConfigurationImpl;
import org.flowable.engine.impl.cmd.DeleteHistoricProcessInstancesCmd;
import org.flowable.engine.impl.cmd.DeleteRelatedDataOfRemovedHistoricProcessInstancesCmd;
import org.flowable.engine.impl.cmd.DeleteTaskAndActivityDataOfRemovedHistoricProcessInstancesCmd;
import org.flowable.engine.impl.context.Context;
import org.flowable.engine.impl.delete.DeleteHistoricProcessInstancesUsingBatchesCmd;
import org.flowable.engine.impl.persistence.entity.HistoricProcessInstanceEntity;
import org.flowable.engine.impl.util.CommandContextUtil;
import org.flowable.variable.service.impl.AbstractVariableQueryImpl;
import org.flowable.variable.service.impl.persistence.entity.HistoricVariableInstanceEntity;

/**
 * @author Tom Baeyens
 * @author Tijs Rademakers
 * @author Falko Menge
 * @author Bernd Ruecker
 * @author Joram Barrez
 */
public class HistoricProcessInstanceQueryImpl extends AbstractVariableQueryImpl&lt;HistoricProcessInstanceQuery, HistoricProcessInstance&gt; 
        implements HistoricProcessInstanceQuery, CacheAwareQuery&lt;HistoricProcessInstanceEntity&gt; {

    private static final long serialVersionUID = 1L;
    
    protected ProcessEngineConfigurationImpl processEngineConfiguration;
    
    protected String processInstanceId;
    protected String processDefinitionId;
    protected String businessKey;
    protected String businessKeyLike;
    protected String businessStatus;
    protected String businessStatusLike;
    protected String deploymentId;
    protected List&lt;String&gt; deploymentIds;
    protected boolean finished;
    protected boolean unfinished;
    protected boolean deleted;
    protected boolean notDeleted;
    protected String startedBy;
    protected String superProcessInstanceId;
    protected boolean excludeSubprocesses;
    protected List&lt;String&gt; processDefinitionKeyIn;
    protected List&lt;String&gt; processKeyNotIn;
    protected Date startedBefore;
    protected Date startedAfter;
    protected Date finishedBefore;
    protected Date finishedAfter;
    protected String processDefinitionKey;
    protected String processDefinitionCategory;
    protected String processDefinitionName;
    protected Integer processDefinitionVersion;
    protected Set&lt;String&gt; processInstanceIds;
    protected String activeActivityId;
    protected Set&lt;String&gt; activeActivityIds;
    protected String involvedUser;
    protected IdentityLinkQueryObject involvedUserIdentityLink;
    protected Set&lt;String&gt; involvedGroups;
    private List&lt;List&lt;String&gt;&gt; safeInvolvedGroups;
    protected IdentityLinkQueryObject involvedGroupIdentityLink;
    protected boolean includeProcessVariables;
    protected boolean withJobException;
    protected String tenantId;
    protected String tenantIdLike;
    protected boolean withoutTenantId;
    protected String name;
    protected String nameLike;
    protected String nameLikeIgnoreCase;
    protected String rootScopeId;
    protected String parentScopeId;
    protected String callbackId;
    protected String callbackType;
    protected boolean withoutCallbackId;
    protected String referenceId;
    protected String referenceType;
    protected String locale;
    protected boolean withLocalizationFallback;
<span class="nc" id="L107">    protected List&lt;HistoricProcessInstanceQueryImpl&gt; orQueryObjects = new ArrayList&lt;&gt;();</span>
    protected HistoricProcessInstanceQueryImpl currentOrQueryObject;
    protected boolean inOrStatement;

<span class="nc" id="L111">    public HistoricProcessInstanceQueryImpl() {</span>
<span class="nc" id="L112">    }</span>

    public HistoricProcessInstanceQueryImpl(CommandContext commandContext, ProcessEngineConfigurationImpl processEngineConfiguration) {
<span class="nc" id="L115">        super(commandContext, processEngineConfiguration.getVariableServiceConfiguration());</span>
<span class="nc" id="L116">        this.processEngineConfiguration = processEngineConfiguration;</span>
<span class="nc" id="L117">    }</span>

    public HistoricProcessInstanceQueryImpl(CommandExecutor commandExecutor, ProcessEngineConfigurationImpl processEngineConfiguration) {
<span class="nc" id="L120">        super(commandExecutor, processEngineConfiguration.getVariableServiceConfiguration());</span>
<span class="nc" id="L121">        this.processEngineConfiguration = processEngineConfiguration;</span>
<span class="nc" id="L122">    }</span>

    @Override
    public HistoricProcessInstanceQueryImpl processInstanceId(String processInstanceId) {
<span class="nc bnc" id="L126" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L127">            this.currentOrQueryObject.processInstanceId = processInstanceId;</span>
        } else {
<span class="nc" id="L129">            this.processInstanceId = processInstanceId;</span>
        }
<span class="nc" id="L131">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery processInstanceIds(Set&lt;String&gt; processInstanceIds) {
<span class="nc bnc" id="L136" title="All 2 branches missed.">        if (processInstanceIds == null) {</span>
<span class="nc" id="L137">            throw new FlowableIllegalArgumentException(&quot;Set of process instance ids is null&quot;);</span>
        }
<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (processInstanceIds.isEmpty()) {</span>
<span class="nc" id="L140">            throw new FlowableIllegalArgumentException(&quot;Set of process instance ids is empty&quot;);</span>
        }

<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L144">            this.currentOrQueryObject.processInstanceIds = processInstanceIds;</span>
        } else {
<span class="nc" id="L146">            this.processInstanceIds = processInstanceIds;</span>
        }
<span class="nc" id="L148">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQueryImpl processDefinitionId(String processDefinitionId) {
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L154">            this.currentOrQueryObject.processDefinitionId = processDefinitionId;</span>
        } else {
<span class="nc" id="L156">            this.processDefinitionId = processDefinitionId;</span>
        }
<span class="nc" id="L158">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery processDefinitionKey(String processDefinitionKey) {
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L164">            this.currentOrQueryObject.processDefinitionKey = processDefinitionKey;</span>
        } else {
<span class="nc" id="L166">            this.processDefinitionKey = processDefinitionKey;</span>
        }
<span class="nc" id="L168">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery processDefinitionKeyIn(List&lt;String&gt; processDefinitionKeys) {
<span class="nc bnc" id="L173" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L174">            currentOrQueryObject.processDefinitionKeyIn = processDefinitionKeys;</span>
        } else {
<span class="nc" id="L176">            this.processDefinitionKeyIn = processDefinitionKeys;</span>
        }
<span class="nc" id="L178">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery processDefinitionCategory(String processDefinitionCategory) {
<span class="nc bnc" id="L183" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L184">            this.currentOrQueryObject.processDefinitionCategory = processDefinitionCategory;</span>
        } else {
<span class="nc" id="L186">            this.processDefinitionCategory = processDefinitionCategory;</span>
        }
<span class="nc" id="L188">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery processDefinitionName(String processDefinitionName) {
<span class="nc bnc" id="L193" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L194">            this.currentOrQueryObject.processDefinitionName = processDefinitionName;</span>
        } else {
<span class="nc" id="L196">            this.processDefinitionName = processDefinitionName;</span>
        }
<span class="nc" id="L198">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery processDefinitionVersion(Integer processDefinitionVersion) {
<span class="nc bnc" id="L203" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L204">            this.currentOrQueryObject.processDefinitionVersion = processDefinitionVersion;</span>
        } else {
<span class="nc" id="L206">            this.processDefinitionVersion = processDefinitionVersion;</span>
        }
<span class="nc" id="L208">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery processInstanceBusinessKey(String businessKey) {
<span class="nc bnc" id="L213" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L214">            this.currentOrQueryObject.businessKey = businessKey;</span>
        } else {
<span class="nc" id="L216">            this.businessKey = businessKey;</span>
        }
<span class="nc" id="L218">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery processInstanceBusinessKeyLike(String businessKeyLike) {
<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L224">            this.currentOrQueryObject.businessKeyLike = businessKeyLike;</span>
        } else {
<span class="nc" id="L226">            this.businessKeyLike = businessKeyLike;</span>
        }
<span class="nc" id="L228">        return this;</span>
    }
    
    @Override
    public HistoricProcessInstanceQuery processInstanceBusinessStatus(String businessStatus) {
<span class="nc bnc" id="L233" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L234">            this.currentOrQueryObject.businessStatus = businessStatus;</span>
        } else {
<span class="nc" id="L236">            this.businessStatus = businessStatus;</span>
        }
<span class="nc" id="L238">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery processInstanceBusinessStatusLike(String businessStatusLike) {
<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L244">            this.currentOrQueryObject.businessStatusLike = businessStatusLike;</span>
        } else {
<span class="nc" id="L246">            this.businessStatusLike = businessStatusLike;</span>
        }
<span class="nc" id="L248">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery processInstanceRootScopeId(String rootScopeId) {
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L254">            this.currentOrQueryObject.rootScopeId = rootScopeId;</span>
        } else {
<span class="nc" id="L256">            this.rootScopeId = rootScopeId;</span>
        }
<span class="nc" id="L258">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery processInstanceParentScopeId(String parentId) {
<span class="nc bnc" id="L263" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L264">            this.currentOrQueryObject.parentScopeId = parentId;</span>
        } else {
<span class="nc" id="L266">            this.parentScopeId = parentId;</span>
        }
<span class="nc" id="L268">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery deploymentId(String deploymentId) {
<span class="nc bnc" id="L273" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L274">            this.currentOrQueryObject.deploymentId = deploymentId;</span>
        } else {
<span class="nc" id="L276">            this.deploymentId = deploymentId;</span>
        }
<span class="nc" id="L278">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery deploymentIdIn(List&lt;String&gt; deploymentIds) {
<span class="nc bnc" id="L283" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L284">            currentOrQueryObject.deploymentIds = deploymentIds;</span>
        } else {
<span class="nc" id="L286">            this.deploymentIds = deploymentIds;</span>
        }
<span class="nc" id="L288">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery finished() {
<span class="nc bnc" id="L293" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L294">            this.currentOrQueryObject.finished = true;</span>
        } else {
<span class="nc" id="L296">            this.finished = true;</span>
        }
<span class="nc" id="L298">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery unfinished() {
<span class="nc bnc" id="L303" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L304">            this.currentOrQueryObject.unfinished = true;</span>
        } else {
<span class="nc" id="L306">            this.unfinished = true;</span>
        }
<span class="nc" id="L308">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery deleted() {
<span class="nc bnc" id="L313" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L314">            this.currentOrQueryObject.deleted = true;</span>
        } else {
<span class="nc" id="L316">            this.deleted = true;</span>
        }
<span class="nc" id="L318">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery notDeleted() {
<span class="nc bnc" id="L323" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L324">            this.currentOrQueryObject.notDeleted = true;</span>
        } else {
<span class="nc" id="L326">            this.notDeleted = true;</span>
        }
<span class="nc" id="L328">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery startedBy(String startedBy) {
<span class="nc bnc" id="L333" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L334">            this.currentOrQueryObject.startedBy = startedBy;</span>
        } else {
<span class="nc" id="L336">            this.startedBy = startedBy;</span>
        }
<span class="nc" id="L338">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery processDefinitionKeyNotIn(List&lt;String&gt; processDefinitionKeys) {
<span class="nc bnc" id="L343" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L344">            this.currentOrQueryObject.processKeyNotIn = processDefinitionKeys;</span>
        } else {
<span class="nc" id="L346">            this.processKeyNotIn = processDefinitionKeys;</span>
        }
<span class="nc" id="L348">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery startedAfter(Date startedAfter) {
<span class="nc bnc" id="L353" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L354">            this.currentOrQueryObject.startedAfter = startedAfter;</span>
        } else {
<span class="nc" id="L356">            this.startedAfter = startedAfter;</span>
        }
<span class="nc" id="L358">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery startedBefore(Date startedBefore) {
<span class="nc bnc" id="L363" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L364">            this.currentOrQueryObject.startedBefore = startedBefore;</span>
        } else {
<span class="nc" id="L366">            this.startedBefore = startedBefore;</span>
        }
<span class="nc" id="L368">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery finishedAfter(Date finishedAfter) {
<span class="nc bnc" id="L373" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L374">            this.currentOrQueryObject.finishedAfter = finishedAfter;</span>
        } else {
<span class="nc" id="L376">            this.finishedAfter = finishedAfter;</span>
<span class="nc" id="L377">            this.finished = true;</span>
        }
<span class="nc" id="L379">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery finishedBefore(Date finishedBefore) {
<span class="nc bnc" id="L384" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L385">            this.currentOrQueryObject.finishedBefore = finishedBefore;</span>
        } else {
<span class="nc" id="L387">            this.finishedBefore = finishedBefore;</span>
<span class="nc" id="L388">            this.finished = true;</span>
        }
<span class="nc" id="L390">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery superProcessInstanceId(String superProcessInstanceId) {
<span class="nc bnc" id="L395" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L396">            this.currentOrQueryObject.superProcessInstanceId = superProcessInstanceId;</span>
        } else {
<span class="nc" id="L398">            this.superProcessInstanceId = superProcessInstanceId;</span>
        }
<span class="nc" id="L400">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery excludeSubprocesses(boolean excludeSubprocesses) {
<span class="nc bnc" id="L405" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L406">            this.currentOrQueryObject.excludeSubprocesses = excludeSubprocesses;</span>
        } else {
<span class="nc" id="L408">            this.excludeSubprocesses = excludeSubprocesses;</span>
        }
<span class="nc" id="L410">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery activeActivityId(String activityId) {
<span class="nc bnc" id="L415" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L416">            this.currentOrQueryObject.activeActivityId = activityId;</span>
        } else {
<span class="nc" id="L418">            this.activeActivityId = activityId;</span>
        }
<span class="nc" id="L420">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery activeActivityIds(Set&lt;String&gt; activityIds) {
<span class="nc bnc" id="L425" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L426">            this.currentOrQueryObject.activeActivityIds = activityIds;</span>
        } else {
<span class="nc" id="L428">            this.activeActivityIds = activityIds;</span>
        }
<span class="nc" id="L430">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery involvedUser(String involvedUser) {
<span class="nc bnc" id="L435" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L436">            this.currentOrQueryObject.involvedUser = involvedUser;</span>
        } else {
<span class="nc" id="L438">            this.involvedUser = involvedUser;</span>
        }
<span class="nc" id="L440">        return this;</span>
    }
    
    @Override
    public HistoricProcessInstanceQuery involvedUser(String userId, String identityLinkType) {
<span class="nc bnc" id="L445" title="All 2 branches missed.">        if (userId == null) {</span>
<span class="nc" id="L446">            throw new FlowableIllegalArgumentException(&quot;userId is null&quot;);</span>
        }
<span class="nc bnc" id="L448" title="All 2 branches missed.">        if (identityLinkType == null) {</span>
<span class="nc" id="L449">            throw new FlowableIllegalArgumentException(&quot;identityLinkType is null&quot;);</span>
        }
<span class="nc bnc" id="L451" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L452">            this.currentOrQueryObject.involvedUserIdentityLink = new IdentityLinkQueryObject(userId, null, identityLinkType);</span>
        } else {
<span class="nc" id="L454">            this.involvedUserIdentityLink = new IdentityLinkQueryObject(userId, null, identityLinkType);</span>
        }
<span class="nc" id="L456">        return this;</span>
    }
    
    @Override
    public HistoricProcessInstanceQuery involvedGroup(String groupId, String identityLinkType) {
<span class="nc bnc" id="L461" title="All 2 branches missed.">        if (groupId == null) {</span>
<span class="nc" id="L462">            throw new FlowableIllegalArgumentException(&quot;groupId is null&quot;);</span>
        }
<span class="nc bnc" id="L464" title="All 2 branches missed.">        if (identityLinkType == null) {</span>
<span class="nc" id="L465">            throw new FlowableIllegalArgumentException(&quot;identityLinkType is null&quot;);</span>
        }
<span class="nc bnc" id="L467" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L468">            this.currentOrQueryObject.involvedGroupIdentityLink = new IdentityLinkQueryObject(null, groupId, identityLinkType);</span>
        } else {
<span class="nc" id="L470">            this.involvedGroupIdentityLink = new IdentityLinkQueryObject(null, groupId, identityLinkType);</span>
        }
<span class="nc" id="L472">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery involvedGroups(Set&lt;String&gt; involvedGroups) {
<span class="nc bnc" id="L477" title="All 2 branches missed.">        if (involvedGroups == null) {</span>
<span class="nc" id="L478">            throw new FlowableIllegalArgumentException(&quot;involvedGroups are null&quot;);</span>
        }
<span class="nc bnc" id="L480" title="All 2 branches missed.">        if (involvedGroups.isEmpty()) {</span>
<span class="nc" id="L481">            throw new FlowableIllegalArgumentException(&quot;involvedGroups are empty&quot;);</span>
        }
<span class="nc bnc" id="L483" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L484">            this.currentOrQueryObject.involvedGroups = involvedGroups;</span>
        } else {
<span class="nc" id="L486">            this.involvedGroups = involvedGroups;</span>
        }
<span class="nc" id="L488">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery includeProcessVariables() {
<span class="nc" id="L493">        this.includeProcessVariables = true;</span>
<span class="nc" id="L494">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery withJobException() {
<span class="nc bnc" id="L499" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L500">            this.currentOrQueryObject.withJobException = true;</span>
        } else {
<span class="nc" id="L502">            this.withJobException = true;</span>
        }
<span class="nc" id="L504">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery processInstanceTenantId(String tenantId) {
<span class="nc bnc" id="L509" title="All 2 branches missed.">        if (tenantId == null) {</span>
<span class="nc" id="L510">            throw new FlowableIllegalArgumentException(&quot;process instance tenant id is null&quot;);</span>
        }
<span class="nc bnc" id="L512" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L513">            this.currentOrQueryObject.tenantId = tenantId;</span>
        } else {
<span class="nc" id="L515">            this.tenantId = tenantId;</span>
        }
<span class="nc" id="L517">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery processInstanceTenantIdLike(String tenantIdLike) {
<span class="nc bnc" id="L522" title="All 2 branches missed.">        if (tenantIdLike == null) {</span>
<span class="nc" id="L523">            throw new FlowableIllegalArgumentException(&quot;process instance tenant id is null&quot;);</span>
        }
<span class="nc bnc" id="L525" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L526">            this.currentOrQueryObject.tenantIdLike = tenantIdLike;</span>
        } else {
<span class="nc" id="L528">            this.tenantIdLike = tenantIdLike;</span>
        }
<span class="nc" id="L530">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery processInstanceWithoutTenantId() {
<span class="nc bnc" id="L535" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L536">            this.currentOrQueryObject.withoutTenantId = true;</span>
        } else {
<span class="nc" id="L538">            this.withoutTenantId = true;</span>
        }
<span class="nc" id="L540">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery processInstanceName(String name) {
<span class="nc bnc" id="L545" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L546">            this.currentOrQueryObject.name = name;</span>
        } else {
<span class="nc" id="L548">            this.name = name;</span>
        }
<span class="nc" id="L550">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery processInstanceNameLike(String nameLike) {
<span class="nc bnc" id="L555" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L556">            this.currentOrQueryObject.nameLike = nameLike;</span>
        } else {
<span class="nc" id="L558">            this.nameLike = nameLike;</span>
        }
<span class="nc" id="L560">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery processInstanceNameLikeIgnoreCase(String nameLikeIgnoreCase) {
<span class="nc bnc" id="L565" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L566">            this.currentOrQueryObject.nameLikeIgnoreCase = nameLikeIgnoreCase.toLowerCase();</span>
        } else {
<span class="nc" id="L568">            this.nameLikeIgnoreCase = nameLikeIgnoreCase.toLowerCase();</span>
        }
<span class="nc" id="L570">        return this;</span>
    }
    
    @Override
    public HistoricProcessInstanceQuery processInstanceCallbackId(String callbackId) {
<span class="nc bnc" id="L575" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L576">            currentOrQueryObject.callbackId = callbackId;</span>
        } else {
<span class="nc" id="L578">            this.callbackId = callbackId;</span>
        }
<span class="nc" id="L580">        return this;</span>
    }
    
    @Override
    public HistoricProcessInstanceQuery processInstanceCallbackType(String callbackType) {
<span class="nc bnc" id="L585" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L586">            currentOrQueryObject.callbackType = callbackType;</span>
        } else {
<span class="nc" id="L588">            this.callbackType = callbackType;</span>
        }
<span class="nc" id="L590">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery withoutProcessInstanceCallbackId() {
<span class="nc bnc" id="L595" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L596">            currentOrQueryObject.withoutCallbackId = true;</span>
        } else {
<span class="nc" id="L598">            this.withoutCallbackId = true;</span>
        }
<span class="nc" id="L600">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery processInstanceReferenceId(String referenceId) {
<span class="nc bnc" id="L605" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L606">            currentOrQueryObject.referenceId = referenceId;</span>
        } else {
<span class="nc" id="L608">            this.referenceId = referenceId;</span>
        }
<span class="nc" id="L610">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery processInstanceReferenceType(String referenceType) {
<span class="nc bnc" id="L615" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L616">            currentOrQueryObject.referenceType = referenceType;</span>
        } else {
<span class="nc" id="L618">            this.referenceType = referenceType;</span>
        }
<span class="nc" id="L620">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery variableValueEquals(String variableName, Object variableValue) {
<span class="nc bnc" id="L625" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L626">            currentOrQueryObject.variableValueEquals(variableName, variableValue, false);</span>
<span class="nc" id="L627">            return this;</span>
        } else {
<span class="nc" id="L629">            return variableValueEquals(variableName, variableValue, false);</span>
        }
    }
    
    @Override
    public HistoricProcessInstanceQuery localVariableValueEquals(String variableName, Object variableValue) {
<span class="nc bnc" id="L635" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L636">            currentOrQueryObject.variableValueEquals(variableName, variableValue, true);</span>
<span class="nc" id="L637">            return this;</span>
        } else {
<span class="nc" id="L639">            return variableValueEquals(variableName, variableValue, true);</span>
        }
    }

    @Override
    public HistoricProcessInstanceQuery variableValueNotEquals(String variableName, Object variableValue) {
<span class="nc bnc" id="L645" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L646">            currentOrQueryObject.variableValueNotEquals(variableName, variableValue, false);</span>
<span class="nc" id="L647">            return this;</span>
        } else {
<span class="nc" id="L649">            return variableValueNotEquals(variableName, variableValue, false);</span>
        }
    }
    
    @Override
    public HistoricProcessInstanceQuery localVariableValueNotEquals(String variableName, Object variableValue) {
<span class="nc bnc" id="L655" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L656">            currentOrQueryObject.variableValueNotEquals(variableName, variableValue, true);</span>
<span class="nc" id="L657">            return this;</span>
        } else {
<span class="nc" id="L659">            return variableValueNotEquals(variableName, variableValue, true);</span>
        }
    }

    @Override
    public HistoricProcessInstanceQuery variableValueEquals(Object variableValue) {
<span class="nc bnc" id="L665" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L666">            currentOrQueryObject.variableValueEquals(variableValue, false);</span>
<span class="nc" id="L667">            return this;</span>
        } else {
<span class="nc" id="L669">            return variableValueEquals(variableValue, false);</span>
        }
    }
    
    @Override
    public HistoricProcessInstanceQuery localVariableValueEquals(Object variableValue) {
<span class="nc bnc" id="L675" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L676">            currentOrQueryObject.variableValueEquals(variableValue, true);</span>
<span class="nc" id="L677">            return this;</span>
        } else {
<span class="nc" id="L679">            return variableValueEquals(variableValue, true);</span>
        }
    }

    @Override
    public HistoricProcessInstanceQuery variableValueEqualsIgnoreCase(String name, String value) {
<span class="nc bnc" id="L685" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L686">            currentOrQueryObject.variableValueEqualsIgnoreCase(name, value, false);</span>
<span class="nc" id="L687">            return this;</span>
        } else {
<span class="nc" id="L689">            return variableValueEqualsIgnoreCase(name, value, false);</span>
        }
    }
    
    @Override
    public HistoricProcessInstanceQuery localVariableValueEqualsIgnoreCase(String name, String value) {
<span class="nc bnc" id="L695" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L696">            currentOrQueryObject.variableValueEqualsIgnoreCase(name, value, true);</span>
<span class="nc" id="L697">            return this;</span>
        } else {
<span class="nc" id="L699">            return variableValueEqualsIgnoreCase(name, value, true);</span>
        }
    }

    @Override
    public HistoricProcessInstanceQuery variableValueNotEqualsIgnoreCase(String name, String value) {
<span class="nc bnc" id="L705" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L706">            currentOrQueryObject.variableValueNotEqualsIgnoreCase(name, value, false);</span>
<span class="nc" id="L707">            return this;</span>
        } else {
<span class="nc" id="L709">            return variableValueNotEqualsIgnoreCase(name, value, false);</span>
        }
    }
    
    @Override
    public HistoricProcessInstanceQuery localVariableValueNotEqualsIgnoreCase(String name, String value) {
<span class="nc bnc" id="L715" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L716">            currentOrQueryObject.variableValueNotEqualsIgnoreCase(name, value, true);</span>
<span class="nc" id="L717">            return this;</span>
        } else {
<span class="nc" id="L719">            return variableValueNotEqualsIgnoreCase(name, value, true);</span>
        }
    }
    
    @Override
    public HistoricProcessInstanceQuery variableValueLikeIgnoreCase(String name, String value) {
<span class="nc bnc" id="L725" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L726">            currentOrQueryObject.variableValueLikeIgnoreCase(name, value, false);</span>
<span class="nc" id="L727">            return this;</span>
        } else {
<span class="nc" id="L729">            return variableValueLikeIgnoreCase(name, value, false);</span>
        }
    }
    
    @Override
    public HistoricProcessInstanceQuery localVariableValueLikeIgnoreCase(String name, String value) {
<span class="nc bnc" id="L735" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L736">            currentOrQueryObject.variableValueLikeIgnoreCase(name, value, true);</span>
<span class="nc" id="L737">            return this;</span>
        } else {
<span class="nc" id="L739">            return variableValueLikeIgnoreCase(name, value, true);</span>
        }
    }

    @Override
    public HistoricProcessInstanceQuery variableValueGreaterThan(String name, Object value) {
<span class="nc bnc" id="L745" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L746">            currentOrQueryObject.variableValueGreaterThan(name, value, false);</span>
<span class="nc" id="L747">            return this;</span>
        } else {
<span class="nc" id="L749">            return variableValueGreaterThan(name, value, false);</span>
        }
    }
    
    @Override
    public HistoricProcessInstanceQuery localVariableValueGreaterThan(String name, Object value) {
<span class="nc bnc" id="L755" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L756">            currentOrQueryObject.variableValueGreaterThan(name, value, true);</span>
<span class="nc" id="L757">            return this;</span>
        } else {
<span class="nc" id="L759">            return variableValueGreaterThan(name, value, true);</span>
        }
    }

    @Override
    public HistoricProcessInstanceQuery variableValueGreaterThanOrEqual(String name, Object value) {
<span class="nc bnc" id="L765" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L766">            currentOrQueryObject.variableValueGreaterThanOrEqual(name, value, false);</span>
<span class="nc" id="L767">            return this;</span>
        } else {
<span class="nc" id="L769">            return variableValueGreaterThanOrEqual(name, value, false);</span>
        }
    }
    
    @Override
    public HistoricProcessInstanceQuery localVariableValueGreaterThanOrEqual(String name, Object value) {
<span class="nc bnc" id="L775" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L776">            currentOrQueryObject.variableValueGreaterThanOrEqual(name, value, true);</span>
<span class="nc" id="L777">            return this;</span>
        } else {
<span class="nc" id="L779">            return variableValueGreaterThanOrEqual(name, value, true);</span>
        }
    }

    @Override
    public HistoricProcessInstanceQuery variableValueLessThan(String name, Object value) {
<span class="nc bnc" id="L785" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L786">            currentOrQueryObject.variableValueLessThan(name, value, false);</span>
<span class="nc" id="L787">            return this;</span>
        } else {
<span class="nc" id="L789">            return variableValueLessThan(name, value, false);</span>
        }
    }
    
    @Override
    public HistoricProcessInstanceQuery localVariableValueLessThan(String name, Object value) {
<span class="nc bnc" id="L795" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L796">            currentOrQueryObject.variableValueLessThan(name, value, true);</span>
<span class="nc" id="L797">            return this;</span>
        } else {
<span class="nc" id="L799">            return variableValueLessThan(name, value, true);</span>
        }
    }

    @Override
    public HistoricProcessInstanceQuery variableValueLessThanOrEqual(String name, Object value) {
<span class="nc bnc" id="L805" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L806">            currentOrQueryObject.variableValueLessThanOrEqual(name, value, false);</span>
<span class="nc" id="L807">            return this;</span>
        } else {
<span class="nc" id="L809">            return variableValueLessThanOrEqual(name, value, false);</span>
        }
    }
    
    @Override
    public HistoricProcessInstanceQuery localVariableValueLessThanOrEqual(String name, Object value) {
<span class="nc bnc" id="L815" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L816">            currentOrQueryObject.variableValueLessThanOrEqual(name, value, true);</span>
<span class="nc" id="L817">            return this;</span>
        } else {
<span class="nc" id="L819">            return variableValueLessThanOrEqual(name, value, true);</span>
        }
    }

    @Override
    public HistoricProcessInstanceQuery variableValueLike(String name, String value) {
<span class="nc bnc" id="L825" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L826">            currentOrQueryObject.variableValueLike(name, value, false);</span>
<span class="nc" id="L827">            return this;</span>
        } else {
<span class="nc" id="L829">            return variableValueLike(name, value, false);</span>
        }
    }
    
    @Override
    public HistoricProcessInstanceQuery localVariableValueLike(String name, String value) {
<span class="nc bnc" id="L835" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L836">            currentOrQueryObject.variableValueLike(name, value, true);</span>
<span class="nc" id="L837">            return this;</span>
        } else {
<span class="nc" id="L839">            return variableValueLike(name, value, true);</span>
        }
    }

    @Override
    public HistoricProcessInstanceQuery variableExists(String name) {
<span class="nc bnc" id="L845" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L846">            currentOrQueryObject.variableExists(name, false);</span>
<span class="nc" id="L847">            return this;</span>
        } else {
<span class="nc" id="L849">            return variableExists(name, false);</span>
        }
    }
    
    @Override
    public HistoricProcessInstanceQuery localVariableExists(String name) {
<span class="nc bnc" id="L855" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L856">            currentOrQueryObject.variableExists(name, true);</span>
<span class="nc" id="L857">            return this;</span>
        } else {
<span class="nc" id="L859">            return variableExists(name, true);</span>
        }
    }
    
    @Override
    public HistoricProcessInstanceQuery variableNotExists(String name) {
<span class="nc bnc" id="L865" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L866">            currentOrQueryObject.variableNotExists(name, false);</span>
<span class="nc" id="L867">            return this;</span>
        } else {
<span class="nc" id="L869">            return variableNotExists(name, false);</span>
        }
    }
    
    @Override
    public HistoricProcessInstanceQuery localVariableNotExists(String name) {
<span class="nc bnc" id="L875" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L876">            currentOrQueryObject.variableNotExists(name, true);</span>
<span class="nc" id="L877">            return this;</span>
        } else {
<span class="nc" id="L879">            return variableNotExists(name, true);</span>
        }
    }
    
    @Override
    public HistoricProcessInstanceQuery locale(String locale) {
<span class="nc" id="L885">        this.locale = locale;</span>
<span class="nc" id="L886">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery withLocalizationFallback() {
<span class="nc" id="L891">        withLocalizationFallback = true;</span>
<span class="nc" id="L892">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery or() {
<span class="nc bnc" id="L897" title="All 2 branches missed.">        if (inOrStatement) {</span>
<span class="nc" id="L898">            throw new FlowableException(&quot;the query is already in an or statement&quot;);</span>
        }

<span class="nc" id="L901">        inOrStatement = true;</span>
<span class="nc bnc" id="L902" title="All 2 branches missed.">        if (commandContext != null) {</span>
<span class="nc" id="L903">            currentOrQueryObject = new HistoricProcessInstanceQueryImpl(commandContext, processEngineConfiguration);</span>
        } else {
<span class="nc" id="L905">            currentOrQueryObject = new HistoricProcessInstanceQueryImpl(commandExecutor, processEngineConfiguration);</span>
        }
<span class="nc" id="L907">        orQueryObjects.add(currentOrQueryObject);</span>
<span class="nc" id="L908">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery endOr() {
<span class="nc bnc" id="L913" title="All 2 branches missed.">        if (!inOrStatement) {</span>
<span class="nc" id="L914">            throw new FlowableException(&quot;endOr() can only be called after calling or()&quot;);</span>
        }

<span class="nc" id="L917">        inOrStatement = false;</span>
<span class="nc" id="L918">        currentOrQueryObject = null;</span>
<span class="nc" id="L919">        return this;</span>
    }

    @Override
    public HistoricProcessInstanceQuery orderByProcessInstanceBusinessKey() {
<span class="nc" id="L924">        return orderBy(HistoricProcessInstanceQueryProperty.BUSINESS_KEY);</span>
    }

    @Override
    public HistoricProcessInstanceQuery orderByProcessInstanceDuration() {
<span class="nc" id="L929">        return orderBy(HistoricProcessInstanceQueryProperty.DURATION);</span>
    }

    @Override
    public HistoricProcessInstanceQuery orderByProcessInstanceStartTime() {
<span class="nc" id="L934">        return orderBy(HistoricProcessInstanceQueryProperty.START_TIME);</span>
    }

    @Override
    public HistoricProcessInstanceQuery orderByProcessInstanceEndTime() {
<span class="nc" id="L939">        return orderBy(HistoricProcessInstanceQueryProperty.END_TIME);</span>
    }

    @Override
    public HistoricProcessInstanceQuery orderByProcessDefinitionId() {
<span class="nc" id="L944">        return orderBy(HistoricProcessInstanceQueryProperty.PROCESS_DEFINITION_ID);</span>
    }

    @Override
    public HistoricProcessInstanceQuery orderByProcessInstanceId() {
<span class="nc" id="L949">        return orderBy(HistoricProcessInstanceQueryProperty.PROCESS_INSTANCE_ID_);</span>
    }

    @Override
    public HistoricProcessInstanceQuery orderByTenantId() {
<span class="nc" id="L954">        return orderBy(HistoricProcessInstanceQueryProperty.TENANT_ID);</span>
    }

    @Override
    public long executeCount(CommandContext commandContext) {
<span class="nc" id="L959">        ensureVariablesInitialized();</span>
        
<span class="nc bnc" id="L961" title="All 2 branches missed.">        if (processEngineConfiguration.getHistoricProcessInstanceQueryInterceptor() != null) {</span>
<span class="nc" id="L962">            processEngineConfiguration.getHistoricProcessInstanceQueryInterceptor().beforeHistoricProcessInstanceQueryExecute(this);</span>
        }
        
<span class="nc" id="L965">        return CommandContextUtil.getHistoricProcessInstanceEntityManager(commandContext).findHistoricProcessInstanceCountByQueryCriteria(this);</span>
    }

    @Override
    public List&lt;HistoricProcessInstance&gt; executeList(CommandContext commandContext) {
<span class="nc" id="L970">        ensureVariablesInitialized();</span>
<span class="nc" id="L971">        List&lt;HistoricProcessInstance&gt; results = null;</span>
        
<span class="nc bnc" id="L973" title="All 2 branches missed.">        if (processEngineConfiguration.getHistoricProcessInstanceQueryInterceptor() != null) {</span>
<span class="nc" id="L974">            processEngineConfiguration.getHistoricProcessInstanceQueryInterceptor().beforeHistoricProcessInstanceQueryExecute(this);</span>
        }
        
<span class="nc bnc" id="L977" title="All 2 branches missed.">        if (includeProcessVariables) {</span>
<span class="nc" id="L978">            results = processEngineConfiguration.getHistoricProcessInstanceEntityManager().findHistoricProcessInstancesAndVariablesByQueryCriteria(this);</span>

<span class="nc bnc" id="L980" title="All 2 branches missed.">            if (processInstanceId != null) {</span>
<span class="nc" id="L981">                addCachedVariableForQueryById(commandContext, results);</span>
            }

        } else {
<span class="nc" id="L985">            results = processEngineConfiguration.getHistoricProcessInstanceEntityManager().findHistoricProcessInstancesByQueryCriteria(this);</span>
        }

<span class="nc bnc" id="L988" title="All 4 branches missed.">        if (processEngineConfiguration.getPerformanceSettings().isEnableLocalization() &amp;&amp; processEngineConfiguration.getInternalProcessLocalizationManager() != null) {</span>
<span class="nc bnc" id="L989" title="All 2 branches missed.">            for (HistoricProcessInstance processInstance : results) {</span>
<span class="nc" id="L990">                processEngineConfiguration.getInternalProcessLocalizationManager().localize(processInstance, locale, withLocalizationFallback);</span>
<span class="nc" id="L991">            }</span>
        }
        
<span class="nc bnc" id="L994" title="All 2 branches missed.">        if (processEngineConfiguration.getHistoricProcessInstanceQueryInterceptor() != null) {</span>
<span class="nc" id="L995">            processEngineConfiguration.getHistoricProcessInstanceQueryInterceptor().afterHistoricProcessInstanceQueryExecute(this, results);</span>
        }

<span class="nc" id="L998">        return results;</span>
    }

    protected void addCachedVariableForQueryById(CommandContext commandContext, List&lt;HistoricProcessInstance&gt; results) {

        // Unlike the ExecutionEntityImpl, variables are not stored on the HistoricExecutionEntityImpl.
        // The solution for the non-historical entity is to use the variable cache on the entity, inspect the variables
        // of the current transaction and add them if necessary.
        // For the historical entity, we need to detect this use case specifically (i.e. byId is used) and check the entityCache.

<span class="nc bnc" id="L1008" title="All 2 branches missed.">        for (HistoricProcessInstance historicProcessInstance : results) {</span>
<span class="nc bnc" id="L1009" title="All 2 branches missed.">            if (Objects.equals(processInstanceId, historicProcessInstance.getId())) {</span>

<span class="nc" id="L1011">                EntityCache entityCache = commandContext.getSession(EntityCache.class);</span>
<span class="nc" id="L1012">                List&lt;HistoricVariableInstanceEntity&gt; cachedVariableEntities = entityCache.findInCache(HistoricVariableInstanceEntity.class);</span>
<span class="nc bnc" id="L1013" title="All 2 branches missed.">                for (HistoricVariableInstanceEntity cachedVariableEntity : cachedVariableEntities) {</span>

<span class="nc bnc" id="L1015" title="All 2 branches missed.">                    if (historicProcessInstance.getId().equals(cachedVariableEntity.getProcessInstanceId())) {</span>

                        // Variables from the cache have precedence
<span class="nc" id="L1018">                        ((HistoricProcessInstanceEntity) historicProcessInstance).getQueryVariables().add(cachedVariableEntity);</span>

                    }

<span class="nc" id="L1022">                }</span>

            }
<span class="nc" id="L1025">        }</span>
<span class="nc" id="L1026">    }</span>

    @Override
    public void enhanceCachedValue(HistoricProcessInstanceEntity processInstance) {
<span class="nc bnc" id="L1030" title="All 2 branches missed.">        if (includeProcessVariables) {</span>
<span class="nc" id="L1031">            processInstance.getQueryVariables()</span>
<span class="nc" id="L1032">                    .addAll(processEngineConfiguration.getVariableServiceConfiguration().getHistoricVariableInstanceEntityManager()</span>
<span class="nc" id="L1033">                            .findHistoricalVariableInstancesByProcessInstanceId(processInstance.getId()));</span>
        }
<span class="nc" id="L1035">    }</span>

    @Override
    protected void ensureVariablesInitialized() {
<span class="nc" id="L1039">        super.ensureVariablesInitialized();</span>

<span class="nc bnc" id="L1041" title="All 2 branches missed.">        for (HistoricProcessInstanceQueryImpl orQueryObject : orQueryObjects) {</span>
<span class="nc" id="L1042">            orQueryObject.ensureVariablesInitialized();</span>
<span class="nc" id="L1043">        }</span>
<span class="nc" id="L1044">    }</span>

    @Override
    public void delete() {
<span class="nc bnc" id="L1048" title="All 2 branches missed.">        if (commandExecutor != null) {</span>
<span class="nc" id="L1049">            commandExecutor.execute(new DeleteHistoricProcessInstancesCmd(this));</span>
        } else {
<span class="nc" id="L1051">            new DeleteHistoricProcessInstancesCmd(this).execute(Context.getCommandContext());</span>
        }
<span class="nc" id="L1053">    }</span>

    @Override
    @Deprecated
    public void deleteWithRelatedData() {
<span class="nc bnc" id="L1058" title="All 2 branches missed.">        if (commandExecutor != null) {</span>
<span class="nc" id="L1059">            CommandConfig config = new CommandConfig().transactionRequiresNew();</span>
<span class="nc" id="L1060">            commandExecutor.execute(config, new DeleteHistoricProcessInstancesCmd(this));</span>
<span class="nc" id="L1061">            commandExecutor.execute(config, new DeleteTaskAndActivityDataOfRemovedHistoricProcessInstancesCmd());</span>
<span class="nc" id="L1062">            commandExecutor.execute(config, new DeleteRelatedDataOfRemovedHistoricProcessInstancesCmd());</span>
<span class="nc" id="L1063">        } else {</span>
<span class="nc" id="L1064">            throw new FlowableException(&quot;deleting historic process instances with related data requires CommandExecutor&quot;);</span>
        }
<span class="nc" id="L1066">    }</span>

    @Override
    public String deleteInParallelUsingBatch(int batchSize, String batchName) {
<span class="nc" id="L1070">        return commandExecutor.execute(new DeleteHistoricProcessInstancesUsingBatchesCmd(this, batchSize, batchName, false));</span>
    }

    @Override
    public String deleteSequentiallyUsingBatch(int batchSize, String batchName) {
<span class="nc" id="L1075">        return commandExecutor.execute(new DeleteHistoricProcessInstancesUsingBatchesCmd(this, batchSize, batchName, true));</span>
    }

    public String getBusinessKey() {
<span class="nc" id="L1079">        return businessKey;</span>
    }

    public String getBusinessKeyLike() {
<span class="nc" id="L1083">        return businessKeyLike;</span>
    }

    public String getBusinessStatus() {
<span class="nc" id="L1087">        return businessStatus;</span>
    }

    public String getBusinessStatusLike() {
<span class="nc" id="L1091">        return businessStatusLike;</span>
    }

    public boolean isOpen() {
<span class="nc" id="L1095">        return unfinished;</span>
    }

    public String getProcessDefinitionId() {
<span class="nc" id="L1099">        return processDefinitionId;</span>
    }

    public String getProcessDefinitionKey() {
<span class="nc" id="L1103">        return processDefinitionKey;</span>
    }

    public List&lt;String&gt; getProcessDefinitionKeyIn() {
<span class="nc" id="L1107">        return processDefinitionKeyIn;</span>
    }

    public String getProcessDefinitionIdLike() {
<span class="nc" id="L1111">        return processDefinitionKey + &quot;:%:%&quot;;</span>
    }

    public String getProcessDefinitionName() {
<span class="nc" id="L1115">        return processDefinitionName;</span>
    }

    public String getProcessDefinitionCategory() {
<span class="nc" id="L1119">        return processDefinitionCategory;</span>
    }

    public Integer getProcessDefinitionVersion() {
<span class="nc" id="L1123">        return processDefinitionVersion;</span>
    }

    public String getProcessInstanceId() {
<span class="nc" id="L1127">        return processInstanceId;</span>
    }
    
    @Override
    public String getId() {
<span class="nc" id="L1132">        return processInstanceId;</span>
    }

    public Set&lt;String&gt; getProcessInstanceIds() {
<span class="nc" id="L1136">        return processInstanceIds;</span>
    }

    public String getStartedBy() {
<span class="nc" id="L1140">        return startedBy;</span>
    }

    public String getSuperProcessInstanceId() {
<span class="nc" id="L1144">        return superProcessInstanceId;</span>
    }

    public boolean isExcludeSubprocesses() {
<span class="nc" id="L1148">        return excludeSubprocesses;</span>
    }

    public List&lt;String&gt; getProcessKeyNotIn() {
<span class="nc" id="L1152">        return processKeyNotIn;</span>
    }

    public Date getStartedAfter() {
<span class="nc" id="L1156">        return startedAfter;</span>
    }

    public Date getStartedBefore() {
<span class="nc" id="L1160">        return startedBefore;</span>
    }

    public Date getFinishedAfter() {
<span class="nc" id="L1164">        return finishedAfter;</span>
    }

    public Date getFinishedBefore() {
<span class="nc" id="L1168">        return finishedBefore;</span>
    }

    public String getActiveActivityId() {
<span class="nc" id="L1172">        return activeActivityId;</span>
    }

    public Set&lt;String&gt; getActiveActivityIds() {
<span class="nc" id="L1176">        return activeActivityIds;</span>
    }

    public String getInvolvedUser() {
<span class="nc" id="L1180">        return involvedUser;</span>
    }

    public Set&lt;String&gt; getInvolvedGroups() {
<span class="nc" id="L1184">        return involvedGroups;</span>
    }

    public String getName() {
<span class="nc" id="L1188">        return name;</span>
    }

    public String getNameLike() {
<span class="nc" id="L1192">        return nameLike;</span>
    }

    public static long getSerialversionuid() {
<span class="nc" id="L1196">        return serialVersionUID;</span>
    }

    public String getDeploymentId() {
<span class="nc" id="L1200">        return deploymentId;</span>
    }

    public List&lt;String&gt; getDeploymentIds() {
<span class="nc" id="L1204">        return deploymentIds;</span>
    }

    public boolean isFinished() {
<span class="nc" id="L1208">        return finished;</span>
    }

    public boolean isUnfinished() {
<span class="nc" id="L1212">        return unfinished;</span>
    }

    public boolean isDeleted() {
<span class="nc" id="L1216">        return deleted;</span>
    }

    public boolean isNotDeleted() {
<span class="nc" id="L1220">        return notDeleted;</span>
    }

    public boolean isIncludeProcessVariables() {
<span class="nc" id="L1224">        return includeProcessVariables;</span>
    }

    public boolean isWithException() {
<span class="nc" id="L1228">        return withJobException;</span>
    }

    public String getTenantId() {
<span class="nc" id="L1232">        return tenantId;</span>
    }

    public String getTenantIdLike() {
<span class="nc" id="L1236">        return tenantIdLike;</span>
    }

    public boolean isWithoutTenantId() {
<span class="nc" id="L1240">        return withoutTenantId;</span>
    }

    public String getNameLikeIgnoreCase() {
<span class="nc" id="L1244">        return nameLikeIgnoreCase;</span>
    }
    
    public String getCallbackId() {
<span class="nc" id="L1248">        return callbackId;</span>
    }

    public String getCallbackType() {
<span class="nc" id="L1252">        return callbackType;</span>
    }

    public boolean isWithoutCallbackId() {
<span class="nc" id="L1256">        return withoutCallbackId;</span>
    }

    public String getReferenceId() {
<span class="nc" id="L1260">        return referenceId;</span>
    }

    public String getReferenceType() {
<span class="nc" id="L1264">        return referenceType;</span>
    }

    public List&lt;HistoricProcessInstanceQueryImpl&gt; getOrQueryObjects() {
<span class="nc" id="L1268">        return orQueryObjects;</span>
    }

    public IdentityLinkQueryObject getInvolvedUserIdentityLink() {
<span class="nc" id="L1272">        return involvedUserIdentityLink;</span>
    }

    public IdentityLinkQueryObject getInvolvedGroupIdentityLink() {
<span class="nc" id="L1276">        return involvedGroupIdentityLink;</span>
    }

    public boolean isWithJobException() {
<span class="nc" id="L1280">        return withJobException;</span>
    }

    public String getLocale() {
<span class="nc" id="L1284">        return locale;</span>
    }

    public boolean isWithLocalizationFallback() {
<span class="nc" id="L1288">        return withLocalizationFallback;</span>
    }

    public boolean isNeedsProcessDefinitionOuterJoin() {
<span class="nc bnc" id="L1292" title="All 2 branches missed.">        if (isNeedsPaging()) {</span>
<span class="nc bnc" id="L1293" title="All 2 branches missed.">            if (AbstractEngineConfiguration.DATABASE_TYPE_ORACLE.equals(databaseType)</span>
<span class="nc bnc" id="L1294" title="All 2 branches missed.">                    || AbstractEngineConfiguration.DATABASE_TYPE_DB2.equals(databaseType)</span>
<span class="nc bnc" id="L1295" title="All 2 branches missed.">                    || AbstractEngineConfiguration.DATABASE_TYPE_MSSQL.equals(databaseType)) {</span>
                // When using oracle, db2 or mssql we don't need outer join for the process definition join.
                // It is not needed because the outer join order by is done by the row number instead
<span class="nc" id="L1298">                return false;</span>
            }
        }

<span class="nc" id="L1302">        return hasOrderByForColumn(HistoricProcessInstanceQueryProperty.PROCESS_DEFINITION_KEY.getName());</span>
    }

    public List&lt;List&lt;String&gt;&gt; getSafeInvolvedGroups() {
<span class="nc" id="L1306">        return safeInvolvedGroups;</span>
    }

    public void setSafeInvolvedGroups(List&lt;List&lt;String&gt;&gt; safeInvolvedGroups) {
<span class="nc" id="L1310">        this.safeInvolvedGroups = safeInvolvedGroups;</span>
<span class="nc" id="L1311">    }</span>

    public String getRootScopeId() {
<span class="nc" id="L1314">        return rootScopeId;</span>
    }

    public String getParentScopeId() {
<span class="nc" id="L1318">        return parentScopeId;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>