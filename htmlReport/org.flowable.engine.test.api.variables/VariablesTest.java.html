<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>VariablesTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.variables</a> &gt; <span class="el_source">VariablesTest.java</span></div><h1>VariablesTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.engine.test.api.variables;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.entry;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;

import org.assertj.core.groups.Tuple;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.engine.RuntimeService;
import org.flowable.engine.delegate.DelegateExecution;
import org.flowable.engine.delegate.JavaDelegate;
import org.flowable.engine.impl.test.HistoryTestHelper;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.impl.util.CommandContextUtil;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.task.api.Task;
import org.flowable.variable.api.history.HistoricVariableInstance;
import org.flowable.variable.api.persistence.entity.VariableInstance;
import org.flowable.variable.api.types.ValueFields;
import org.flowable.variable.service.VariableService;
import org.flowable.variable.service.VariableServiceConfiguration;
import org.flowable.variable.service.impl.persistence.entity.HistoricVariableInstanceEntity;
import org.flowable.variable.service.impl.persistence.entity.VariableInstanceEntity;
import org.joda.time.DateTime;
import org.joda.time.LocalDate;
import org.junit.jupiter.api.Test;

/**
 * Testing various constructs with variables.
 *
 * @author Joram Barrez
 */
<span class="nc" id="L57">public class VariablesTest extends PluggableFlowableTestCase {</span>

    private Map&lt;String, Object&gt; generateVariables() {
<span class="nc" id="L60">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>

        // 10 Strings
<span class="nc bnc" id="L63" title="All 2 branches missed.">        for (int i = 0; i &lt; 10; i++) {</span>
<span class="nc" id="L64">            vars.put(&quot;stringVar&quot; + i, &quot;stringVarValue-&quot; + i);</span>
        }

        // 10 integers
<span class="nc bnc" id="L68" title="All 2 branches missed.">        for (int i = 0; i &lt; 10; i++) {</span>
<span class="nc" id="L69">            vars.put(&quot;intVar&quot; + i, i * 100);</span>
        }

        // 10 dates
<span class="nc bnc" id="L73" title="All 2 branches missed.">        for (int i = 0; i &lt; 10; i++) {</span>
<span class="nc" id="L74">            vars.put(&quot;dateVar&quot; + i, new Date());</span>
        }

        // 10 joda local dates
<span class="nc bnc" id="L78" title="All 2 branches missed.">        for (int i = 0; i &lt; 10; i++) {</span>
<span class="nc" id="L79">            vars.put(&quot;localdateVar&quot; + i, new LocalDate());</span>
        }

        // 10 joda local dates
<span class="nc bnc" id="L83" title="All 2 branches missed.">        for (int i = 0; i &lt; 10; i++) {</span>
<span class="nc" id="L84">            vars.put(&quot;datetimeVar&quot; + i, new DateTime());</span>
        }

        // 10 booleans
<span class="nc bnc" id="L88" title="All 2 branches missed.">        for (int i = 0; i &lt; 10; i++) {</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">            vars.put(&quot;booleanValue&quot; + i, (i % 2 == 0));</span>
        }

        // 10 Serializables
<span class="nc bnc" id="L93" title="All 2 branches missed.">        for (int i = 0; i &lt; 10; i++) {</span>
<span class="nc" id="L94">            vars.put(&quot;serializableValue&quot; + i, new TestSerializableVariable(i));</span>
        }
<span class="nc" id="L96">        return vars;</span>
    }

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/variables/VariablesTest.bpmn20.xml&quot;)
    public void testGetVariables() {

        // Creating 50 vars in total
<span class="nc" id="L104">        Map&lt;String, Object&gt; vars = generateVariables();</span>
<span class="nc" id="L105">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;variablesTest&quot;, vars).getId();</span>

        // Regular getVariables after process instance start
<span class="nc" id="L108">        vars = runtimeService.getVariables(processInstanceId);</span>
<span class="nc" id="L109">        assertThat(vars).hasSize(70);</span>
<span class="nc" id="L110">        int nrOfStrings = 0;</span>
<span class="nc" id="L111">        int nrOfInts = 0;</span>
<span class="nc" id="L112">        int nrOfDates = 0;</span>
<span class="nc" id="L113">        int nrOfLocalDates = 0;</span>
<span class="nc" id="L114">        int nrOfDateTimes = 0;</span>
<span class="nc" id="L115">        int nrOfBooleans = 0;</span>
<span class="nc" id="L116">        int nrOfSerializable = 0;</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        for (String variableName : vars.keySet()) {</span>
<span class="nc" id="L118">            Object variableValue = vars.get(variableName);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">            if (variableValue instanceof String) {</span>
<span class="nc" id="L120">                nrOfStrings++;</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">            } else if (variableValue instanceof Integer) {</span>
<span class="nc" id="L122">                nrOfInts++;</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">            } else if (variableValue instanceof Boolean) {</span>
<span class="nc" id="L124">                nrOfBooleans++;</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">            } else if (variableValue instanceof Date) {</span>
<span class="nc" id="L126">                nrOfDates++;</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">            } else if (variableValue instanceof LocalDate) {</span>
<span class="nc" id="L128">                nrOfLocalDates++;</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">            } else if (variableValue instanceof DateTime) {</span>
<span class="nc" id="L130">                nrOfDateTimes++;</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">            } else if (variableValue instanceof TestSerializableVariable) {</span>
<span class="nc" id="L132">                nrOfSerializable++;</span>
            }
<span class="nc" id="L134">        }</span>

<span class="nc" id="L136">        assertThat(nrOfStrings).isEqualTo(10);</span>
<span class="nc" id="L137">        assertThat(nrOfBooleans).isEqualTo(10);</span>
<span class="nc" id="L138">        assertThat(nrOfDates).isEqualTo(10);</span>
<span class="nc" id="L139">        assertThat(nrOfLocalDates).isEqualTo(10);</span>
<span class="nc" id="L140">        assertThat(nrOfDateTimes).isEqualTo(10);</span>
<span class="nc" id="L141">        assertThat(nrOfInts).isEqualTo(10);</span>
<span class="nc" id="L142">        assertThat(nrOfSerializable).isEqualTo(10);</span>

        // Trying the same after moving the process
<span class="nc" id="L145">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L146">        taskService.complete(task.getId());</span>

<span class="nc" id="L148">        task = taskService.createTaskQuery().taskName(&quot;Task 3&quot;).singleResult();</span>
<span class="nc" id="L149">        String executionId = task.getExecutionId();</span>
<span class="nc" id="L150">        assertThat(processInstanceId).isNotEqualTo(executionId);</span>

<span class="nc" id="L152">        vars = runtimeService.getVariables(processInstanceId);</span>
<span class="nc" id="L153">        assertThat(vars).hasSize(70);</span>
<span class="nc" id="L154">        nrOfStrings = 0;</span>
<span class="nc" id="L155">        nrOfInts = 0;</span>
<span class="nc" id="L156">        nrOfDates = 0;</span>
<span class="nc" id="L157">        nrOfLocalDates = 0;</span>
<span class="nc" id="L158">        nrOfDateTimes = 0;</span>
<span class="nc" id="L159">        nrOfBooleans = 0;</span>
<span class="nc" id="L160">        nrOfSerializable = 0;</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">        for (String variableName : vars.keySet()) {</span>
<span class="nc" id="L162">            Object variableValue = vars.get(variableName);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">            if (variableValue instanceof String) {</span>
<span class="nc" id="L164">                nrOfStrings++;</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            } else if (variableValue instanceof Integer) {</span>
<span class="nc" id="L166">                nrOfInts++;</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">            } else if (variableValue instanceof Boolean) {</span>
<span class="nc" id="L168">                nrOfBooleans++;</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">            } else if (variableValue instanceof Date) {</span>
<span class="nc" id="L170">                nrOfDates++;</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">            } else if (variableValue instanceof LocalDate) {</span>
<span class="nc" id="L172">                nrOfLocalDates++;</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">            } else if (variableValue instanceof DateTime) {</span>
<span class="nc" id="L174">                nrOfDateTimes++;</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">            } else if (variableValue instanceof TestSerializableVariable) {</span>
<span class="nc" id="L176">                nrOfSerializable++;</span>
            }
<span class="nc" id="L178">        }</span>

<span class="nc" id="L180">        assertThat(nrOfStrings).isEqualTo(10);</span>
<span class="nc" id="L181">        assertThat(nrOfBooleans).isEqualTo(10);</span>
<span class="nc" id="L182">        assertThat(nrOfDates).isEqualTo(10);</span>
<span class="nc" id="L183">        assertThat(nrOfLocalDates).isEqualTo(10);</span>
<span class="nc" id="L184">        assertThat(nrOfDateTimes).isEqualTo(10);</span>
<span class="nc" id="L185">        assertThat(nrOfInts).isEqualTo(10);</span>
<span class="nc" id="L186">        assertThat(nrOfSerializable).isEqualTo(10);</span>
<span class="nc" id="L187">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/variables/VariablesTest.bpmn20.xml&quot;)
    public void testGetVariablesLocal() {
        // Creating 50 vars in total
<span class="nc" id="L193">        Map&lt;String, Object&gt; vars = generateVariables();</span>
<span class="nc" id="L194">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;variablesTest&quot;, vars).getId();</span>

        // Regular getVariables after process instance start
<span class="nc" id="L197">        vars = runtimeService.getVariablesLocal(processInstanceId);</span>
<span class="nc" id="L198">        assertThat(vars).hasSize(70);</span>
<span class="nc" id="L199">        int nrOfStrings = 0;</span>
<span class="nc" id="L200">        int nrOfInts = 0;</span>
<span class="nc" id="L201">        int nrOfDates = 0;</span>
<span class="nc" id="L202">        int nrOfLocalDates = 0;</span>
<span class="nc" id="L203">        int nrOfDateTimes = 0;</span>
<span class="nc" id="L204">        int nrOfBooleans = 0;</span>
<span class="nc" id="L205">        int nrOfSerializable = 0;</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">        for (String variableName : vars.keySet()) {</span>
<span class="nc" id="L207">            Object variableValue = vars.get(variableName);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">            if (variableValue instanceof String) {</span>
<span class="nc" id="L209">                nrOfStrings++;</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">            } else if (variableValue instanceof Integer) {</span>
<span class="nc" id="L211">                nrOfInts++;</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">            } else if (variableValue instanceof Boolean) {</span>
<span class="nc" id="L213">                nrOfBooleans++;</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">            } else if (variableValue instanceof Date) {</span>
<span class="nc" id="L215">                nrOfDates++;</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">            } else if (variableValue instanceof LocalDate) {</span>
<span class="nc" id="L217">                nrOfLocalDates++;</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">            } else if (variableValue instanceof DateTime) {</span>
<span class="nc" id="L219">                nrOfDateTimes++;</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">            } else if (variableValue instanceof TestSerializableVariable) {</span>
<span class="nc" id="L221">                nrOfSerializable++;</span>
            }
<span class="nc" id="L223">        }</span>

<span class="nc" id="L225">        assertThat(nrOfStrings).isEqualTo(10);</span>
<span class="nc" id="L226">        assertThat(nrOfBooleans).isEqualTo(10);</span>
<span class="nc" id="L227">        assertThat(nrOfDates).isEqualTo(10);</span>
<span class="nc" id="L228">        assertThat(nrOfLocalDates).isEqualTo(10);</span>
<span class="nc" id="L229">        assertThat(nrOfDateTimes).isEqualTo(10);</span>
<span class="nc" id="L230">        assertThat(nrOfInts).isEqualTo(10);</span>
<span class="nc" id="L231">        assertThat(nrOfSerializable).isEqualTo(10);</span>

        // Trying the same after moving the process
<span class="nc" id="L234">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L235">        taskService.complete(task.getId());</span>

<span class="nc" id="L237">        task = taskService.createTaskQuery().taskName(&quot;Task 3&quot;).singleResult();</span>
<span class="nc" id="L238">        String executionId = task.getExecutionId();</span>
<span class="nc" id="L239">        assertThat(processInstanceId).isNotEqualTo(executionId);</span>

        // On the local scope level, the vars shouldn't be visible
<span class="nc" id="L242">        vars = runtimeService.getVariablesLocal(executionId);</span>
<span class="nc" id="L243">        assertThat(vars).isEmpty();</span>
<span class="nc" id="L244">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/variables/VariablesTest.bpmn20.xml&quot;)
    public void testGetVariable() {
        // Creating 50 vars in total
<span class="nc" id="L250">        Map&lt;String, Object&gt; vars = generateVariables();</span>
<span class="nc" id="L251">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;variablesTest&quot;, vars).getId();</span>

        // This actually does a specific select. Before, this was not the case
        // (all variables were fetched)
        // See the logging to verify this

<span class="nc" id="L257">        String value = (String) runtimeService.getVariable(processInstanceId, &quot;stringVar3&quot;);</span>
<span class="nc" id="L258">        assertThat(value).isEqualTo(&quot;stringVarValue-3&quot;);</span>
<span class="nc" id="L259">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/variables/VariablesTest.bpmn20.xml&quot;)
    public void testGetVariablesLocal2() {
        // Creating 50 vars in total
<span class="nc" id="L265">        Map&lt;String, Object&gt; vars = generateVariables();</span>
<span class="nc" id="L266">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;variablesTest&quot;, vars).getId();</span>

        // Trying the same after moving the process
<span class="nc" id="L269">        Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L270">        taskService.complete(task.getId());</span>

<span class="nc" id="L272">        task = taskService.createTaskQuery().taskName(&quot;Task 3&quot;).singleResult();</span>
<span class="nc" id="L273">        String executionId = task.getExecutionId();</span>
<span class="nc" id="L274">        assertThat(processInstanceId).isNotEqualTo(executionId);</span>

<span class="nc" id="L276">        runtimeService.setVariableLocal(executionId, &quot;stringVar1&quot;, &quot;hello&quot;);</span>
<span class="nc" id="L277">        runtimeService.setVariableLocal(executionId, &quot;stringVar2&quot;, &quot;world&quot;);</span>
<span class="nc" id="L278">        runtimeService.setVariableLocal(executionId, &quot;myVar&quot;, &quot;test123&quot;);</span>

<span class="nc" id="L280">        vars = runtimeService.getVariables(processInstanceId);</span>
<span class="nc" id="L281">        assertThat(vars).hasSize(70);</span>
<span class="nc" id="L282">        int nrOfStrings = 0;</span>
<span class="nc" id="L283">        int nrOfInts = 0;</span>
<span class="nc" id="L284">        int nrOfDates = 0;</span>
<span class="nc" id="L285">        int nrOfLocalDates = 0;</span>
<span class="nc" id="L286">        int nrOfDateTimes = 0;</span>
<span class="nc" id="L287">        int nrOfBooleans = 0;</span>
<span class="nc" id="L288">        int nrOfSerializable = 0;</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">        for (String variableName : vars.keySet()) {</span>
<span class="nc" id="L290">            Object variableValue = vars.get(variableName);</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">            if (variableValue instanceof String) {</span>
<span class="nc" id="L292">                nrOfStrings++;</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">            } else if (variableValue instanceof Integer) {</span>
<span class="nc" id="L294">                nrOfInts++;</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">            } else if (variableValue instanceof Boolean) {</span>
<span class="nc" id="L296">                nrOfBooleans++;</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">            } else if (variableValue instanceof Date) {</span>
<span class="nc" id="L298">                nrOfDates++;</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">            } else if (variableValue instanceof LocalDate) {</span>
<span class="nc" id="L300">                nrOfLocalDates++;</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">            } else if (variableValue instanceof DateTime) {</span>
<span class="nc" id="L302">                nrOfDateTimes++;</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">            } else if (variableValue instanceof TestSerializableVariable) {</span>
<span class="nc" id="L304">                nrOfSerializable++;</span>
            }
<span class="nc" id="L306">        }</span>

<span class="nc" id="L308">        assertThat(nrOfStrings).isEqualTo(10);</span>
<span class="nc" id="L309">        assertThat(nrOfBooleans).isEqualTo(10);</span>
<span class="nc" id="L310">        assertThat(nrOfDates).isEqualTo(10);</span>
<span class="nc" id="L311">        assertThat(nrOfLocalDates).isEqualTo(10);</span>
<span class="nc" id="L312">        assertThat(nrOfDateTimes).isEqualTo(10);</span>
<span class="nc" id="L313">        assertThat(nrOfInts).isEqualTo(10);</span>
<span class="nc" id="L314">        assertThat(nrOfSerializable).isEqualTo(10);</span>

<span class="nc" id="L316">        assertThat(vars)</span>
<span class="nc" id="L317">                .contains(</span>
<span class="nc" id="L318">                        entry(&quot;stringVar1&quot;, &quot;stringVarValue-1&quot;),</span>
<span class="nc" id="L319">                        entry(&quot;stringVar2&quot;, &quot;stringVarValue-2&quot;)</span>
                )
<span class="nc" id="L321">                .doesNotContainKey(&quot;myVar&quot;);</span>

        // Execution local

<span class="nc" id="L325">        vars = runtimeService.getVariables(executionId);</span>

<span class="nc" id="L327">        nrOfStrings = 0;</span>
<span class="nc" id="L328">        nrOfInts = 0;</span>
<span class="nc" id="L329">        nrOfDates = 0;</span>
<span class="nc" id="L330">        nrOfLocalDates = 0;</span>
<span class="nc" id="L331">        nrOfDateTimes = 0;</span>
<span class="nc" id="L332">        nrOfBooleans = 0;</span>
<span class="nc" id="L333">        nrOfSerializable = 0;</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">        for (String variableName : vars.keySet()) {</span>
<span class="nc" id="L335">            Object variableValue = vars.get(variableName);</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">            if (variableValue instanceof String) {</span>
<span class="nc" id="L337">                nrOfStrings++;</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">            } else if (variableValue instanceof Integer) {</span>
<span class="nc" id="L339">                nrOfInts++;</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">            } else if (variableValue instanceof Boolean) {</span>
<span class="nc" id="L341">                nrOfBooleans++;</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">            } else if (variableValue instanceof Date) {</span>
<span class="nc" id="L343">                nrOfDates++;</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">            } else if (variableValue instanceof LocalDate) {</span>
<span class="nc" id="L345">                nrOfLocalDates++;</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">            } else if (variableValue instanceof DateTime) {</span>
<span class="nc" id="L347">                nrOfDateTimes++;</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">            } else if (variableValue instanceof TestSerializableVariable) {</span>
<span class="nc" id="L349">                nrOfSerializable++;</span>
            }
<span class="nc" id="L351">        }</span>

<span class="nc" id="L353">        assertThat(nrOfStrings).isEqualTo(11);</span>
<span class="nc" id="L354">        assertThat(nrOfBooleans).isEqualTo(10);</span>
<span class="nc" id="L355">        assertThat(nrOfDates).isEqualTo(10);</span>
<span class="nc" id="L356">        assertThat(nrOfLocalDates).isEqualTo(10);</span>
<span class="nc" id="L357">        assertThat(nrOfDateTimes).isEqualTo(10);</span>
<span class="nc" id="L358">        assertThat(nrOfInts).isEqualTo(10);</span>
<span class="nc" id="L359">        assertThat(nrOfSerializable).isEqualTo(10);</span>

<span class="nc" id="L361">        assertThat(vars)</span>
<span class="nc" id="L362">                .contains(</span>
<span class="nc" id="L363">                        entry(&quot;stringVar1&quot;, &quot;hello&quot;),</span>
<span class="nc" id="L364">                        entry(&quot;stringVar2&quot;, &quot;world&quot;),</span>
<span class="nc" id="L365">                        entry(&quot;myVar&quot;, &quot;test123&quot;)</span>
                );
<span class="nc" id="L367">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/variables/VariablesTest.bpmn20.xml&quot;)
    public void testGetVariablesWithCollectionThroughRuntimeService() {
        // Creating 50 vars in total
<span class="nc" id="L373">        Map&lt;String, Object&gt; vars = generateVariables();</span>
<span class="nc" id="L374">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;variablesTest&quot;, vars).getId();</span>

<span class="nc" id="L376">        vars = runtimeService.getVariables(processInstanceId, Arrays.asList(&quot;intVar1&quot;, &quot;intVar3&quot;, &quot;intVar5&quot;, &quot;intVar9&quot;));</span>
<span class="nc" id="L377">        assertThat(vars)</span>
<span class="nc" id="L378">                .containsOnly(</span>
<span class="nc" id="L379">                        entry(&quot;intVar1&quot;, 100),</span>
<span class="nc" id="L380">                        entry(&quot;intVar3&quot;, 300),</span>
<span class="nc" id="L381">                        entry(&quot;intVar5&quot;, 500),</span>
<span class="nc" id="L382">                        entry(&quot;intVar9&quot;, 900)</span>
                );

<span class="nc" id="L385">        assertThat(runtimeService.getVariablesLocal(processInstanceId, Arrays.asList(&quot;intVar1&quot;, &quot;intVar3&quot;, &quot;intVar5&quot;, &quot;intVar9&quot;))).hasSize(4);</span>

        // Trying the same after moving the process
<span class="nc" id="L388">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L389">        taskService.complete(task.getId());</span>

<span class="nc" id="L391">        task = taskService.createTaskQuery().taskName(&quot;Task 3&quot;).singleResult();</span>
<span class="nc" id="L392">        String executionId = task.getExecutionId();</span>
<span class="nc" id="L393">        assertThat(processInstanceId).isNotEqualTo(executionId);</span>

<span class="nc" id="L395">        assertThat(runtimeService.getVariablesLocal(executionId, Arrays.asList(&quot;intVar1&quot;, &quot;intVar3&quot;, &quot;intVar5&quot;, &quot;intVar9&quot;))).isEmpty();</span>
<span class="nc" id="L396">    }</span>

    @Test
    @org.flowable.engine.test.Deployment
    public void testGetVariableAllVariableFetchingDefault() {

        // Testing it the default way, all using getVariable(&quot;someVar&quot;);

<span class="nc" id="L404">        Map&lt;String, Object&gt; vars = generateVariables();</span>
<span class="nc" id="L405">        vars.put(&quot;testVar&quot;, &quot;hello&quot;);</span>
<span class="nc" id="L406">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;variablesFetchingTestProcess&quot;, vars).getId();</span>

<span class="nc" id="L408">        taskService.complete(taskService.createTaskQuery().taskName(&quot;Task A&quot;).singleResult().getId());</span>
<span class="nc" id="L409">        taskService.complete(taskService.createTaskQuery().taskName(&quot;Task B&quot;).singleResult().getId()); // Triggers service task invocation</span>

<span class="nc" id="L411">        vars = runtimeService.getVariables(processInstanceId);</span>
<span class="nc" id="L412">        assertThat(vars).hasSize(71);</span>

<span class="nc" id="L414">        String varValue = (String) runtimeService.getVariable(processInstanceId, &quot;testVar&quot;);</span>
<span class="nc" id="L415">        assertThat(varValue).isEqualTo(&quot;HELLO world&quot;);</span>
<span class="nc" id="L416">    }</span>

    @Test
    @org.flowable.engine.test.Deployment
    public void testGetVariableAllVariableFetchingDisabled() {

<span class="nc" id="L422">        Map&lt;String, Object&gt; vars = generateVariables();</span>
<span class="nc" id="L423">        vars.put(&quot;testVar&quot;, &quot;hello&quot;);</span>
<span class="nc" id="L424">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;variablesFetchingTestProcess&quot;, vars).getId();</span>

<span class="nc" id="L426">        taskService.complete(taskService.createTaskQuery().taskName(&quot;Task A&quot;).singleResult().getId());</span>
<span class="nc" id="L427">        taskService.complete(taskService.createTaskQuery().taskName(&quot;Task B&quot;).singleResult().getId()); // Triggers service task invocation</span>

<span class="nc" id="L429">        String varValue = (String) runtimeService.getVariable(processInstanceId, &quot;testVar&quot;);</span>
<span class="nc" id="L430">        assertThat(varValue).isEqualTo(&quot;HELLO world!&quot;);</span>
<span class="nc" id="L431">    }</span>

    @Test
    @org.flowable.engine.test.Deployment
    public void testGetVariableInDelegateMixed() {

<span class="nc" id="L437">        Map&lt;String, Object&gt; vars = generateVariables();</span>
<span class="nc" id="L438">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;variablesFetchingTestProcess&quot;, vars).getId();</span>

<span class="nc" id="L440">        taskService.complete(taskService.createTaskQuery().taskName(&quot;Task A&quot;).singleResult().getId());</span>
<span class="nc" id="L441">        taskService.complete(taskService.createTaskQuery().taskName(&quot;Task B&quot;).singleResult().getId()); // Triggers service task invocation</span>

<span class="nc" id="L443">        assertThat((String) runtimeService.getVariable(processInstanceId, &quot;testVar&quot;)).isEqualTo(&quot;test 1 2 3&quot;);</span>
<span class="nc" id="L444">        assertThat((String) runtimeService.getVariable(processInstanceId, &quot;testVar2&quot;)).isEqualTo(&quot;Hiya&quot;);</span>
<span class="nc" id="L445">    }</span>

    @Test
    @org.flowable.engine.test.Deployment
    public void testGetVariableInDelegateMixed2() {

<span class="nc" id="L451">        Map&lt;String, Object&gt; vars = generateVariables();</span>
<span class="nc" id="L452">        vars.put(&quot;testVar&quot;, &quot;1&quot;);</span>
<span class="nc" id="L453">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;variablesFetchingTestProcess&quot;, vars).getId();</span>

<span class="nc" id="L455">        taskService.complete(taskService.createTaskQuery().taskName(&quot;Task A&quot;).singleResult().getId());</span>
<span class="nc" id="L456">        taskService.complete(taskService.createTaskQuery().taskName(&quot;Task B&quot;).singleResult().getId()); // Triggers service task invocation</span>

<span class="nc" id="L458">        assertThat((String) runtimeService.getVariable(processInstanceId, &quot;testVar&quot;)).isEqualTo(&quot;1234&quot;);</span>
<span class="nc" id="L459">    }</span>

    @Test
    @org.flowable.engine.test.Deployment
    public void testGetVariableInDelegateMixed3() {

<span class="nc" id="L465">        Map&lt;String, Object&gt; vars = generateVariables();</span>
<span class="nc" id="L466">        vars.put(&quot;testVar1&quot;, &quot;one&quot;);</span>
<span class="nc" id="L467">        vars.put(&quot;testVar2&quot;, &quot;two&quot;);</span>
<span class="nc" id="L468">        vars.put(&quot;testVar3&quot;, &quot;three&quot;);</span>
<span class="nc" id="L469">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;variablesFetchingTestProcess&quot;, vars).getId();</span>

<span class="nc" id="L471">        taskService.complete(taskService.createTaskQuery().taskName(&quot;Task A&quot;).singleResult().getId());</span>
<span class="nc" id="L472">        taskService.complete(taskService.createTaskQuery().taskName(&quot;Task B&quot;).singleResult().getId()); // Triggers service task invocation</span>

<span class="nc" id="L474">        assertThat((String) runtimeService.getVariable(processInstanceId, &quot;testVar1&quot;)).isEqualTo(&quot;one-CHANGED&quot;);</span>
<span class="nc" id="L475">        assertThat((String) runtimeService.getVariable(processInstanceId, &quot;testVar2&quot;)).isEqualTo(&quot;two-CHANGED&quot;);</span>
<span class="nc" id="L476">        assertThat(runtimeService.getVariable(processInstanceId, &quot;testVar3&quot;)).isNull();</span>
<span class="nc" id="L477">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/variables/VariablesTest.bpmn20.xml&quot;)
    public void testTaskGetVariables() {
        // Creating 50 vars in total
<span class="nc" id="L483">        Map&lt;String, Object&gt; vars = generateVariables();</span>
<span class="nc" id="L484">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;variablesTest&quot;, vars).getId();</span>

<span class="nc" id="L486">        org.flowable.task.api.Task task = taskService.createTaskQuery().taskName(&quot;Task 1&quot;).singleResult();</span>
<span class="nc" id="L487">        vars = taskService.getVariables(task.getId());</span>
<span class="nc" id="L488">        assertThat(vars).hasSize(70);</span>
<span class="nc" id="L489">        int nrOfStrings = 0;</span>
<span class="nc" id="L490">        int nrOfInts = 0;</span>
<span class="nc" id="L491">        int nrOfDates = 0;</span>
<span class="nc" id="L492">        int nrOfLocalDates = 0;</span>
<span class="nc" id="L493">        int nrOfDateTimes = 0;</span>
<span class="nc" id="L494">        int nrOfBooleans = 0;</span>
<span class="nc" id="L495">        int nrOfSerializable = 0;</span>
<span class="nc bnc" id="L496" title="All 2 branches missed.">        for (String variableName : vars.keySet()) {</span>
<span class="nc" id="L497">            Object variableValue = vars.get(variableName);</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">            if (variableValue instanceof String) {</span>
<span class="nc" id="L499">                nrOfStrings++;</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">            } else if (variableValue instanceof Integer) {</span>
<span class="nc" id="L501">                nrOfInts++;</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">            } else if (variableValue instanceof Boolean) {</span>
<span class="nc" id="L503">                nrOfBooleans++;</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">            } else if (variableValue instanceof Date) {</span>
<span class="nc" id="L505">                nrOfDates++;</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">            } else if (variableValue instanceof LocalDate) {</span>
<span class="nc" id="L507">                nrOfLocalDates++;</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">            } else if (variableValue instanceof DateTime) {</span>
<span class="nc" id="L509">                nrOfDateTimes++;</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">            } else if (variableValue instanceof TestSerializableVariable) {</span>
<span class="nc" id="L511">                nrOfSerializable++;</span>
            }
<span class="nc" id="L513">        }</span>

<span class="nc" id="L515">        assertThat(nrOfStrings).isEqualTo(10);</span>
<span class="nc" id="L516">        assertThat(nrOfBooleans).isEqualTo(10);</span>
<span class="nc" id="L517">        assertThat(nrOfDates).isEqualTo(10);</span>
<span class="nc" id="L518">        assertThat(nrOfLocalDates).isEqualTo(10);</span>
<span class="nc" id="L519">        assertThat(nrOfDateTimes).isEqualTo(10);</span>
<span class="nc" id="L520">        assertThat(nrOfInts).isEqualTo(10);</span>
<span class="nc" id="L521">        assertThat(nrOfSerializable).isEqualTo(10);</span>

        // Get variables local
<span class="nc" id="L524">        assertThat(taskService.getVariablesLocal(task.getId())).isEmpty();</span>

        // Get collection of variables
<span class="nc" id="L527">        assertThat(taskService.getVariables(task.getId(), Arrays.asList(&quot;intVar2&quot;, &quot;intVar5&quot;))).hasSize(2);</span>
<span class="nc" id="L528">        assertThat(taskService.getVariablesLocal(task.getId(), Arrays.asList(&quot;intVar2&quot;, &quot;intVar5&quot;))).isEmpty();</span>

        // Get Variable
<span class="nc" id="L531">        assertThat(taskService.getVariable(task.getId(), &quot;stringVar3&quot;)).isEqualTo(&quot;stringVarValue-3&quot;);</span>
<span class="nc" id="L532">        assertThat(taskService.getVariable(task.getId(), &quot;stringVarDoesNotExist&quot;)).isNull();</span>
<span class="nc" id="L533">        assertThat(taskService.getVariableLocal(task.getId(), &quot;stringVar3&quot;)).isNull();</span>

        // Set local variable
<span class="nc" id="L536">        taskService.setVariableLocal(task.getId(), &quot;localTaskVar&quot;, &quot;localTaskVarValue&quot;);</span>
<span class="nc" id="L537">        assertThat(taskService.getVariables(task.getId())).hasSize(71);</span>
<span class="nc" id="L538">        assertThat(taskService.getVariablesLocal(task.getId())).hasSize(1);</span>
<span class="nc" id="L539">        assertThat(taskService.getVariables(task.getId(), Arrays.asList(&quot;intVar2&quot;, &quot;intVar5&quot;))).hasSize(2);</span>
<span class="nc" id="L540">        assertThat(taskService.getVariablesLocal(task.getId(), Arrays.asList(&quot;intVar2&quot;, &quot;intVar5&quot;))).isEmpty();</span>
<span class="nc" id="L541">        assertThat(taskService.getVariable(task.getId(), &quot;localTaskVar&quot;)).isEqualTo(&quot;localTaskVarValue&quot;);</span>
<span class="nc" id="L542">        assertThat(taskService.getVariableLocal(task.getId(), &quot;localTaskVar&quot;)).isEqualTo(&quot;localTaskVarValue&quot;);</span>

        // Override process variable
<span class="nc" id="L545">        Collection&lt;String&gt; varNames = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L546">        varNames.add(&quot;stringVar1&quot;);</span>
<span class="nc" id="L547">        assertThat(taskService.getVariable(task.getId(), &quot;stringVar1&quot;)).isEqualTo(&quot;stringVarValue-1&quot;);</span>
<span class="nc" id="L548">        assertThat(taskService.getVariables(task.getId(), varNames)).containsEntry(&quot;stringVar1&quot;, &quot;stringVarValue-1&quot;);</span>
<span class="nc" id="L549">        taskService.setVariableLocal(task.getId(), &quot;stringVar1&quot;, &quot;Override&quot;);</span>
<span class="nc" id="L550">        assertThat(taskService.getVariables(task.getId())).hasSize(71);</span>
<span class="nc" id="L551">        assertThat(taskService.getVariable(task.getId(), &quot;stringVar1&quot;)).isEqualTo(&quot;Override&quot;);</span>
<span class="nc" id="L552">        assertThat(taskService.getVariables(task.getId(), varNames)).containsEntry(&quot;stringVar1&quot;, &quot;Override&quot;);</span>
<span class="nc" id="L553">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/variables/VariablesTest.bpmn20.xml&quot;)
    public void testLocalDateVariable() {
        // Creating 50 vars in total
<span class="nc" id="L559">        Map&lt;String, Object&gt; vars = generateVariables();</span>
<span class="nc" id="L560">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;variablesTest&quot;, vars).getId();</span>

<span class="nc" id="L562">        Calendar todayCal = new GregorianCalendar();</span>
<span class="nc" id="L563">        int todayYear = todayCal.get(Calendar.YEAR);</span>
<span class="nc" id="L564">        int todayMonth = todayCal.get(Calendar.MONTH);</span>
<span class="nc" id="L565">        int todayDate = todayCal.get(Calendar.DAY_OF_MONTH);</span>

        // Regular getVariables after process instance start
<span class="nc" id="L568">        LocalDate date1 = (LocalDate) runtimeService.getVariable(processInstanceId, &quot;localdateVar1&quot;);</span>
<span class="nc" id="L569">        assertThat(date1.getYear()).isEqualTo(todayYear);</span>
<span class="nc" id="L570">        assertThat(date1.getMonthOfYear()).isEqualTo(todayMonth + 1);</span>
<span class="nc" id="L571">        assertThat(date1.getDayOfMonth()).isEqualTo(todayDate);</span>

<span class="nc" id="L573">        date1 = new LocalDate(2010, 11, 10);</span>
<span class="nc" id="L574">        runtimeService.setVariable(processInstanceId, &quot;localdateVar1&quot;, date1);</span>
<span class="nc" id="L575">        date1 = (LocalDate) runtimeService.getVariable(processInstanceId, &quot;localdateVar1&quot;);</span>
<span class="nc" id="L576">        assertThat(date1.getYear()).isEqualTo(2010);</span>
<span class="nc" id="L577">        assertThat(date1.getMonthOfYear()).isEqualTo(11);</span>
<span class="nc" id="L578">        assertThat(date1.getDayOfMonth()).isEqualTo(10);</span>

<span class="nc" id="L580">        LocalDate queryDate = new LocalDate(2010, 11, 9);</span>
<span class="nc" id="L581">        ProcessInstance processInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;localdateVar1&quot;, queryDate).singleResult();</span>
<span class="nc" id="L582">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L583">        assertThat(processInstance.getId()).isEqualTo(processInstanceId);</span>

<span class="nc" id="L585">        queryDate = new LocalDate(2010, 11, 10);</span>
<span class="nc" id="L586">        processInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;localdateVar1&quot;, queryDate).singleResult();</span>
<span class="nc" id="L587">        assertThat(processInstance).isNull();</span>

<span class="nc" id="L589">        processInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;localdateVar1&quot;, queryDate).singleResult();</span>
<span class="nc" id="L590">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L591">        assertThat(processInstance.getId()).isEqualTo(processInstanceId);</span>
<span class="nc" id="L592">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/variables/VariablesTest.bpmn20.xml&quot;)
    public void testLocalDateTimeVariable() {
        // Creating 50 vars in total
<span class="nc" id="L598">        Map&lt;String, Object&gt; vars = generateVariables();</span>
<span class="nc" id="L599">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;variablesTest&quot;, vars).getId();</span>

<span class="nc" id="L601">        Calendar todayCal = new GregorianCalendar();</span>
<span class="nc" id="L602">        int todayYear = todayCal.get(Calendar.YEAR);</span>
<span class="nc" id="L603">        int todayMonth = todayCal.get(Calendar.MONTH);</span>
<span class="nc" id="L604">        int todayDate = todayCal.get(Calendar.DAY_OF_MONTH);</span>

        // Regular getVariables after process instance start
<span class="nc" id="L607">        DateTime date1 = (DateTime) runtimeService.getVariable(processInstanceId, &quot;datetimeVar1&quot;);</span>
<span class="nc" id="L608">        assertThat(date1.getYear()).isEqualTo(todayYear);</span>
<span class="nc" id="L609">        assertThat(date1.getMonthOfYear()).isEqualTo(todayMonth + 1);</span>
<span class="nc" id="L610">        assertThat(date1.getDayOfMonth()).isEqualTo(todayDate);</span>

<span class="nc" id="L612">        date1 = new DateTime(2010, 11, 10, 10, 15);</span>
<span class="nc" id="L613">        runtimeService.setVariable(processInstanceId, &quot;datetimeVar1&quot;, date1);</span>
<span class="nc" id="L614">        date1 = (DateTime) runtimeService.getVariable(processInstanceId, &quot;datetimeVar1&quot;);</span>
<span class="nc" id="L615">        assertThat(date1.getYear()).isEqualTo(2010);</span>
<span class="nc" id="L616">        assertThat(date1.getMonthOfYear()).isEqualTo(11);</span>
<span class="nc" id="L617">        assertThat(date1.getDayOfMonth()).isEqualTo(10);</span>
<span class="nc" id="L618">        assertThat(date1.getHourOfDay()).isEqualTo(10);</span>
<span class="nc" id="L619">        assertThat(date1.getMinuteOfHour()).isEqualTo(15);</span>

<span class="nc" id="L621">        DateTime queryDate = new DateTime(2010, 11, 10, 9, 15);</span>
<span class="nc" id="L622">        ProcessInstance processInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;datetimeVar1&quot;, queryDate).singleResult();</span>
<span class="nc" id="L623">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L624">        assertThat(processInstance.getId()).isEqualTo(processInstanceId);</span>

<span class="nc" id="L626">        queryDate = new DateTime(2010, 11, 10, 10, 15);</span>
<span class="nc" id="L627">        processInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;datetimeVar1&quot;, queryDate).singleResult();</span>
<span class="nc" id="L628">        assertThat(processInstance).isNull();</span>

<span class="nc" id="L630">        processInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;datetimeVar1&quot;, queryDate).singleResult();</span>
<span class="nc" id="L631">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L632">        assertThat(processInstance.getId()).isEqualTo(processInstanceId);</span>
<span class="nc" id="L633">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/variables/VariablesTest.bpmn20.xml&quot;)
    public void testUpdateMetaInfo() {
<span class="nc" id="L638">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L639">        variables.put(&quot;myVariable&quot;, &quot;Hello World&quot;);</span>
<span class="nc" id="L640">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;variablesTest&quot;, variables);</span>

<span class="nc" id="L642">        VariableInstance variableInstance = runtimeService.createVariableInstanceQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L643">        assertThat(variableInstance.getMetaInfo()).isNull();</span>

<span class="nc" id="L645">        managementService.executeCommand(commandContext -&gt; {</span>
<span class="nc" id="L646">            List&lt;VariableInstanceEntity&gt; variablesInstances = CommandContextUtil.getVariableService(commandContext)</span>
<span class="nc" id="L647">                    .findVariableInstancesByExecutionId(processInstance.getId());</span>
<span class="nc" id="L648">            assertThat(variablesInstances).extracting(ValueFields::getName).containsExactly(&quot;myVariable&quot;);</span>

<span class="nc" id="L650">            VariableInstanceEntity variableInstanceEntity = variablesInstances.get(0);</span>
<span class="nc" id="L651">            variableInstanceEntity.setMetaInfo(&quot;test meta info&quot;);</span>
<span class="nc" id="L652">            VariableServiceConfiguration variableServiceConfiguration = processEngineConfiguration.getVariableServiceConfiguration();</span>
<span class="nc" id="L653">            variableServiceConfiguration.getVariableInstanceEntityManager().update(variableInstanceEntity);</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">            if (variableServiceConfiguration.getInternalHistoryVariableManager() != null) {</span>
<span class="nc" id="L655">                variableServiceConfiguration.getInternalHistoryVariableManager()</span>
<span class="nc" id="L656">                        .recordVariableUpdate(variableInstanceEntity, commandContext.getClock().getCurrentTime());</span>
            }
<span class="nc" id="L658">            return null;</span>
        });

<span class="nc" id="L661">        variableInstance = runtimeService.createVariableInstanceQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L662">        assertThat(variableInstance.getMetaInfo()).isEqualTo(&quot;test meta info&quot;);</span>

<span class="nc bnc" id="L664" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L665">            HistoricVariableInstance historicVariableInstance = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L666">                    .processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L667">            assertThat(historicVariableInstance.getMetaInfo()).isEqualTo(&quot;test meta info&quot;);</span>
        }
<span class="nc" id="L669">    }</span>

    @Test
    public void testCreateAndUpdateWithValue() {
<span class="nc" id="L673">        List&lt;Object&gt; toDelete = new LinkedList&lt;&gt;();</span>
        try {
<span class="nc" id="L675">            managementService.executeCommand(commandContext -&gt; {</span>

<span class="nc" id="L677">                VariableServiceConfiguration variableServiceConfiguration = CommandContextUtil.getProcessEngineConfiguration(commandContext)</span>
<span class="nc" id="L678">                        .getVariableServiceConfiguration();</span>
<span class="nc" id="L679">                VariableService variableService = variableServiceConfiguration.getVariableService();</span>
<span class="nc" id="L680">                VariableInstanceEntity variableInstanceEntity = variableService</span>
<span class="nc" id="L681">                        .createVariableInstance(&quot;myVariable&quot;);</span>
<span class="nc" id="L682">                variableInstanceEntity.setScopeId(&quot;testScopeId&quot;);</span>
<span class="nc" id="L683">                variableInstanceEntity.setScopeType(&quot;testScopeType&quot;);</span>
<span class="nc" id="L684">                variableService.insertVariableInstanceWithValue(variableInstanceEntity, &quot;myStringValue&quot;, &quot;myTenantId&quot;);</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">                if (variableServiceConfiguration.getInternalHistoryVariableManager() != null) {</span>
<span class="nc" id="L686">                    variableServiceConfiguration.getInternalHistoryVariableManager()</span>
<span class="nc" id="L687">                            .recordVariableCreate(variableInstanceEntity, commandContext.getClock().getCurrentTime());</span>
                }
<span class="nc" id="L689">                return null;</span>
            });

<span class="nc" id="L692">            managementService.executeCommand(commandContext -&gt; {</span>
<span class="nc" id="L693">                List&lt;VariableInstanceEntity&gt; variablesInstances = CommandContextUtil.getVariableService(commandContext)</span>
<span class="nc" id="L694">                        .findVariableInstanceByScopeIdAndScopeType(&quot;testScopeId&quot;, &quot;testScopeType&quot;);</span>
<span class="nc" id="L695">                assertThat(variablesInstances).extracting(ValueFields::getName, ValueFields::getTextValue, VariableInstanceEntity::getTypeName)</span>
<span class="nc" id="L696">                        .containsExactly(Tuple.tuple(&quot;myVariable&quot;, &quot;myStringValue&quot;, &quot;string&quot;));</span>

<span class="nc" id="L698">                VariableInstanceEntity variableInstanceEntity = variablesInstances.get(0);</span>
<span class="nc" id="L699">                VariableServiceConfiguration variableServiceConfiguration = CommandContextUtil.getProcessEngineConfiguration(commandContext)</span>
<span class="nc" id="L700">                        .getVariableServiceConfiguration();</span>
<span class="nc" id="L701">                variableServiceConfiguration.getVariableInstanceValueModifier().updateVariableValue(variableInstanceEntity, 42, &quot;myTenantId&quot;);</span>
<span class="nc" id="L702">                variableServiceConfiguration.getVariableInstanceEntityManager().update(variableInstanceEntity);</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">                if (variableServiceConfiguration.getInternalHistoryVariableManager() != null) {</span>
<span class="nc" id="L704">                    variableServiceConfiguration.getInternalHistoryVariableManager()</span>
<span class="nc" id="L705">                            .recordVariableUpdate(variableInstanceEntity, commandContext.getClock().getCurrentTime());</span>
                }

<span class="nc" id="L708">                return null;</span>
            });

<span class="nc" id="L711">            VariableInstance variableInstance = runtimeService.createVariableInstanceQuery().variableName(&quot;myVariable&quot;).singleResult();</span>
<span class="nc" id="L712">            assertThat(variableInstance.getValue()).isEqualTo(42);</span>
<span class="nc" id="L713">            assertThat(variableInstance.getTypeName()).isEqualTo(&quot;integer&quot;);</span>
<span class="nc" id="L714">            toDelete.add(variableInstance);</span>
            HistoricVariableInstance historicVariableInstance;
<span class="nc bnc" id="L716" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L717">                historicVariableInstance = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L718">                        .variableName(&quot;myVariable&quot;).singleResult();</span>
<span class="nc" id="L719">                assertThat(historicVariableInstance.getValue()).isEqualTo(42);</span>
<span class="nc" id="L720">                toDelete.add(historicVariableInstance);</span>
            }
        } finally {
<span class="nc" id="L723">            managementService.executeCommand(commandContext -&gt; {</span>
<span class="nc" id="L724">                toDelete.forEach(var -&gt; {</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">                    if (var instanceof VariableInstanceEntity) {</span>
<span class="nc" id="L726">                        CommandContextUtil.getVariableService(commandContext).deleteVariableInstance((VariableInstanceEntity) var);</span>
                    }
<span class="nc bnc" id="L728" title="All 2 branches missed.">                    if (var instanceof HistoricVariableInstance) {</span>
<span class="nc" id="L729">                        CommandContextUtil.getHistoricVariableService(commandContext).deleteHistoricVariableInstance((HistoricVariableInstanceEntity) var);</span>
                    }
<span class="nc" id="L731">                });</span>
<span class="nc" id="L732">                return null;</span>
            });
        }
<span class="nc" id="L735">    }</span>

    @Test
    @Deployment
    public void testSettingGettingMultipleTimesInSameTransaction() {

<span class="nc" id="L741">        TestSetGetVariablesDelegate.REMOVE_VARS_IN_LAST_ROUND = true;</span>

<span class="nc" id="L743">        ProcessInstance processInstance1 = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L744">                .processDefinitionKey(&quot;testSettingGettingMultipleTimesInSameTransaction&quot;)</span>
<span class="nc" id="L745">                .start();</span>
<span class="nc" id="L746">        assertThat(runtimeService.getVariables(processInstance1.getId())).isEmpty();</span>

<span class="nc" id="L748">        TestSetGetVariablesDelegate.REMOVE_VARS_IN_LAST_ROUND = false;</span>
<span class="nc" id="L749">        ProcessInstance processInstance2 = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L750">                .processDefinitionKey(&quot;testSettingGettingMultipleTimesInSameTransaction&quot;)</span>
<span class="nc" id="L751">                .start();</span>
<span class="nc" id="L752">        Map&lt;String, Object&gt; variables = runtimeService.getVariables(processInstance2.getId());</span>
<span class="nc" id="L753">        assertThat(variables).hasSize(100);</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">        for (String variableName : variables.keySet()) {</span>
<span class="nc" id="L755">            assertThat(variables.get(variableName)).isNotNull();</span>
<span class="nc" id="L756">        }</span>
<span class="nc" id="L757">    }</span>

    // Class to test variable serialization
    public static class TestSerializableVariable implements Serializable {

        private static final long serialVersionUID = 1L;
        private int number;

<span class="nc" id="L765">        public TestSerializableVariable(int number) {</span>
<span class="nc" id="L766">            this.number = number;</span>
<span class="nc" id="L767">        }</span>

        public int getNumber() {
<span class="nc" id="L770">            return number;</span>
        }

        public void setNumber(int number) {
<span class="nc" id="L774">            this.number = number;</span>
<span class="nc" id="L775">        }</span>

    }

    // Test delegates
<span class="nc" id="L780">    public static class TestJavaDelegate1 implements JavaDelegate {</span>

        @Override
        public void execute(DelegateExecution execution) {
<span class="nc" id="L784">            String var = (String) execution.getVariable(&quot;testVar&quot;);</span>
<span class="nc" id="L785">            execution.setVariable(&quot;testVar&quot;, var.toUpperCase());</span>
<span class="nc" id="L786">        }</span>
    }

<span class="nc" id="L789">    public static class TestJavaDelegate2 implements JavaDelegate {</span>

        @Override
        public void execute(DelegateExecution execution) {
<span class="nc" id="L793">            String var = (String) execution.getVariable(&quot;testVar&quot;);</span>
<span class="nc" id="L794">            execution.setVariable(&quot;testVar&quot;, var + &quot; world&quot;);</span>
<span class="nc" id="L795">        }</span>
    }

<span class="nc" id="L798">    public static class TestJavaDelegate3 implements JavaDelegate {</span>

        @Override
        public void execute(DelegateExecution execution) {

<span class="nc" id="L803">        }</span>
    }

    // ////////////////////////////////////////

<span class="nc" id="L808">    public static class TestJavaDelegate4 implements JavaDelegate {</span>

        @Override
        public void execute(DelegateExecution execution) {
<span class="nc" id="L812">            String var = (String) execution.getVariable(&quot;testVar&quot;, false);</span>
<span class="nc" id="L813">            execution.setVariable(&quot;testVar&quot;, var.toUpperCase());</span>
<span class="nc" id="L814">        }</span>
    }

<span class="nc" id="L817">    public static class TestJavaDelegate5 implements JavaDelegate {</span>

        @Override
        public void execute(DelegateExecution execution) {
<span class="nc" id="L821">            String var = (String) execution.getVariable(&quot;testVar&quot;, false);</span>
<span class="nc" id="L822">            execution.setVariable(&quot;testVar&quot;, var + &quot; world&quot;);</span>
<span class="nc" id="L823">        }</span>
    }

<span class="nc" id="L826">    public static class TestJavaDelegate6 implements JavaDelegate {</span>

        @Override
        public void execute(DelegateExecution execution) {
<span class="nc" id="L830">            String var = (String) execution.getVariable(&quot;testVar&quot;, false);</span>
<span class="nc" id="L831">            execution.setVariable(&quot;testVar&quot;, var + &quot;!&quot;);</span>
<span class="nc" id="L832">        }</span>
    }

    // ////////////////////////////////////////

<span class="nc" id="L837">    public static class TestJavaDelegate7 implements JavaDelegate {</span>

        @Override
        public void execute(DelegateExecution execution) {

            // Setting variable through 'default' way of setting variable
<span class="nc" id="L843">            execution.setVariable(&quot;testVar&quot;, &quot;test&quot;);</span>

<span class="nc" id="L845">        }</span>
    }

<span class="nc" id="L848">    public static class TestJavaDelegate8 implements JavaDelegate {</span>

        @Override
        public void execute(DelegateExecution execution) {
<span class="nc" id="L852">            String var = (String) execution.getVariable(&quot;testVar&quot;, false);</span>
<span class="nc" id="L853">            execution.setVariable(&quot;testVar&quot;, var + &quot; 1 2 3&quot;);</span>
<span class="nc" id="L854">        }</span>
    }

<span class="nc" id="L857">    public static class TestJavaDelegate9 implements JavaDelegate {</span>

        @Override
        public void execute(DelegateExecution execution) {
<span class="nc" id="L861">            execution.setVariable(&quot;testVar2&quot;, &quot;Hiya&quot;);</span>
<span class="nc" id="L862">        }</span>
    }

    // ////////////////////////////////////////

<span class="nc" id="L867">    public static class TestJavaDelegate10 implements JavaDelegate {</span>

        @Override
        public void execute(DelegateExecution execution) {
<span class="nc" id="L871">            String testVar = (String) execution.getVariable(&quot;testVar&quot;, false);</span>
<span class="nc" id="L872">            execution.setVariable(&quot;testVar&quot;, testVar + &quot;2&quot;);</span>
<span class="nc" id="L873">        }</span>
    }

<span class="nc" id="L876">    public static class TestJavaDelegate11 implements JavaDelegate {</span>

        @Override
        public void execute(DelegateExecution execution) {
<span class="nc" id="L880">            String testVar = (String) execution.getVariable(&quot;testVar&quot;, false);</span>
<span class="nc" id="L881">            execution.setVariable(&quot;testVar&quot;, testVar + &quot;3&quot;);</span>
<span class="nc" id="L882">        }</span>
    }

<span class="nc" id="L885">    public static class TestJavaDelegate12 implements JavaDelegate {</span>

        @Override
        public void execute(DelegateExecution execution) {
<span class="nc" id="L889">            String testVar = (String) execution.getVariable(&quot;testVar&quot;);</span>
<span class="nc" id="L890">            execution.setVariable(&quot;testVar&quot;, testVar + &quot;4&quot;);</span>
<span class="nc" id="L891">        }</span>
    }

    // ////////////////////////////////////////

<span class="nc" id="L896">    public static class TestJavaDelegate13 implements JavaDelegate {</span>

        @Override
        public void execute(DelegateExecution execution) {
<span class="nc" id="L900">            Map&lt;String, Object&gt; vars = execution.getVariables(Arrays.asList(&quot;testVar1&quot;, &quot;testVar2&quot;, &quot;testVar3&quot;), false);</span>

<span class="nc" id="L902">            String testVar1 = (String) vars.get(&quot;testVar1&quot;);</span>
<span class="nc" id="L903">            String testVar2 = (String) vars.get(&quot;testVar2&quot;);</span>
<span class="nc" id="L904">            String testVar3 = (String) vars.get(&quot;testVar3&quot;);</span>

<span class="nc" id="L906">            execution.setVariable(&quot;testVar1&quot;, testVar1 + &quot;-CHANGED&quot;, false);</span>
<span class="nc" id="L907">            execution.setVariable(&quot;testVar2&quot;, testVar2 + &quot;-CHANGED&quot;, false);</span>
<span class="nc" id="L908">            execution.setVariable(&quot;testVar3&quot;, testVar3 + &quot;-CHANGED&quot;, false);</span>

<span class="nc" id="L910">            execution.setVariableLocal(&quot;localVar&quot;, &quot;localValue&quot;, false);</span>
<span class="nc" id="L911">        }</span>
    }

<span class="nc" id="L914">    public static class TestJavaDelegate14 implements JavaDelegate {</span>

        @Override
        public void execute(DelegateExecution execution) {
<span class="nc" id="L918">            String value = (String) execution.getVariable(&quot;testVar2&quot;);</span>
<span class="nc" id="L919">            String localVarValue = (String) execution.getVariableLocal(&quot;localValue&quot;);</span>
<span class="nc" id="L920">            execution.setVariableLocal(&quot;testVar2&quot;, value + localVarValue);</span>
<span class="nc" id="L921">        }</span>
    }

<span class="nc" id="L924">    public static class TestJavaDelegate15 implements JavaDelegate {</span>

        @Override
        public void execute(DelegateExecution execution) {
<span class="nc" id="L928">            execution.removeVariable(&quot;testVar3&quot;);</span>
<span class="nc" id="L929">        }</span>
    }

<span class="nc" id="L932">    public static class TestSetGetVariablesDelegate implements JavaDelegate {</span>

<span class="nc" id="L934">        public static boolean REMOVE_VARS_IN_LAST_ROUND = true;</span>

        @Override
        public void execute(DelegateExecution execution) {
<span class="nc" id="L938">            String processInstanceId = execution.getProcessInstanceId();</span>
<span class="nc" id="L939">            RuntimeService runtimeService = CommandContextUtil.getProcessEngineConfiguration().getRuntimeService();</span>

<span class="nc" id="L941">            int nrOfLoops = 100;</span>
<span class="nc bnc" id="L942" title="All 2 branches missed.">            for (int nrOfRounds = 0; nrOfRounds &lt; 4; nrOfRounds++) {</span>

                // Set
<span class="nc bnc" id="L945" title="All 2 branches missed.">                for (int i = 0; i &lt; nrOfLoops; i++) {</span>
<span class="nc" id="L946">                    runtimeService.setVariable(processInstanceId, &quot;test_&quot; + i, i);</span>
                }

                // Get
<span class="nc bnc" id="L950" title="All 2 branches missed.">                for (int i = 0; i &lt; nrOfLoops; i++) {</span>
<span class="nc bnc" id="L951" title="All 2 branches missed.">                    if (runtimeService.getVariable(processInstanceId, &quot;test_&quot; + i) == null) {</span>
<span class="nc" id="L952">                        throw new RuntimeException(&quot;This exception shouldn't happen&quot;);</span>
                    }
                }

                // Remove
<span class="nc bnc" id="L957" title="All 4 branches missed.">                if (REMOVE_VARS_IN_LAST_ROUND &amp;&amp; nrOfRounds == 3) {</span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">                    for (int i = 0; i &lt; nrOfLoops; i++) {</span>
<span class="nc" id="L959">                        runtimeService.removeVariable(processInstanceId, &quot;test_&quot; + i);</span>
                    }
                }

            }
<span class="nc" id="L964">        }</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>