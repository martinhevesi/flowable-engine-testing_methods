<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>VariableInstanceValueModifierBpmnTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.variables</a> &gt; <span class="el_source">VariableInstanceValueModifierBpmnTest.java</span></div><h1>VariableInstanceValueModifierBpmnTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.engine.test.api.variables;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.assertj.core.api.Assertions.entry;
import static org.assertj.core.groups.Tuple.tuple;

import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Objects;

import org.apache.commons.lang3.StringUtils;
import org.apache.commons.lang3.tuple.Pair;
import org.flowable.common.engine.api.FlowableIllegalArgumentException;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.engine.history.HistoricProcessInstance;
import org.flowable.engine.impl.test.HistoryTestHelper;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.engine.test.api.event.TestVariableEventListener;
import org.flowable.task.api.Task;
import org.flowable.task.api.history.HistoricTaskInstance;
import org.flowable.variable.api.event.FlowableVariableEvent;
import org.flowable.variable.api.history.HistoricVariableInstance;
import org.flowable.variable.api.persistence.entity.VariableInstance;
import org.flowable.variable.api.types.ValueFields;
import org.flowable.variable.api.types.VariableType;
import org.flowable.variable.api.types.VariableTypes;
import org.flowable.variable.service.VariableServiceConfiguration;
import org.flowable.variable.service.impl.DefaultVariableInstanceValueModifier;
import org.flowable.variable.service.impl.VariableInstanceValueModifier;
import org.flowable.variable.service.impl.persistence.entity.VariableInstanceEntity;
import org.flowable.variable.service.impl.types.IntegerType;
import org.flowable.variable.service.impl.types.StringType;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import com.fasterxml.jackson.annotation.JsonProperty;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;

/**
 * @author Arthur Hupka-Merle
 */
<span class="nc" id="L62">public class VariableInstanceValueModifierBpmnTest extends PluggableFlowableTestCase {</span>

    VariableInstanceValueModifier originalModifier;

    VariableType customType;

    TestVariableEventListener eventListener;

    @BeforeEach
    public void setUp() {
<span class="nc" id="L72">        originalModifier = processEngineConfiguration.getVariableServiceConfiguration().getVariableInstanceValueModifier();</span>
<span class="nc" id="L73">        eventListener = new TestVariableEventListener();</span>
<span class="nc" id="L74">        processEngineConfiguration.getEventDispatcher().addEventListener(eventListener);</span>
<span class="nc" id="L75">    }</span>

    @AfterEach
    public void tearDown() {
<span class="nc" id="L79">        processEngineConfiguration.getVariableServiceConfiguration().setVariableInstanceValueModifier(originalModifier);</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">        if (customType != null) {</span>
<span class="nc" id="L81">            processEngineConfiguration.getVariableTypes().removeType(customType);</span>
        }
<span class="nc bnc" id="L83" title="All 2 branches missed.">        if (eventListener != null) {</span>
<span class="nc" id="L84">            eventListener.clearEventsReceived();</span>
<span class="nc" id="L85">            processEngineConfiguration.getEventDispatcher().removeEventListener(eventListener);</span>
        }
<span class="nc" id="L87">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testCompleteTaskWithExceptionInPostSetVariable() {
<span class="nc" id="L92">        processEngineConfiguration.getVariableServiceConfiguration()</span>
<span class="nc" id="L93">                .setVariableInstanceValueModifier(new TestOrderIdValidatingValueModifier(processEngineConfiguration.getVariableServiceConfiguration()));</span>

<span class="nc" id="L95">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L96">        variables.put(&quot;orderId&quot;, 1L);</span>
<span class="nc" id="L97">        variables.put(&quot;OtherVariable&quot;, &quot;Hello World&quot;);</span>

<span class="nc" id="L99">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, variables);</span>

<span class="nc" id="L101">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L102">            Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L103">            variables.put(&quot;orderId&quot;, -1L);</span>
<span class="nc" id="L104">            variables.put(&quot;OtherVariable&quot;, &quot;Hello World update&quot;);</span>
<span class="nc" id="L105">            taskService.complete(task.getId(), variables);</span>
<span class="nc" id="L106">        }).isInstanceOf(FlowableIllegalArgumentException.class).hasMessage(&quot;Invalid type: value should be larger than zero&quot;);</span>
<span class="nc" id="L107">    }</span>

    /**
     * Tests changing of the variable type for a variable.
     * First the variable is set as a string, then it is changed to an integral number, which is stored
     * as 'long' (and not as 'integer' as the default would be).
     */
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/twoTasksProcess.bpmn20.xml&quot; })
    public void testChangeVariableType() {
<span class="nc" id="L117">        DefaultVariableInstanceValueModifier variableValueModifier = new DefaultVariableInstanceValueModifier(</span>
<span class="nc" id="L118">                processEngineConfiguration.getVariableServiceConfiguration()) {</span>

            @Override
            public void setVariableValue(VariableInstance variableInstance, Object value, String tenantId) {
<span class="nc bnc" id="L122" title="All 2 branches missed.">                if (isIntegralNumber(value)) {</span>
<span class="nc" id="L123">                    super.setVariableValue(variableInstance, Long.parseLong(value.toString()), tenantId);</span>
                } else {
<span class="nc" id="L125">                    super.setVariableValue(variableInstance, value, tenantId);</span>
                }
<span class="nc" id="L127">            }</span>

            @Override
            public void updateVariableValue(VariableInstance variableInstance, Object value, String tenantId) {
<span class="nc bnc" id="L131" title="All 2 branches missed.">                if (isIntegralNumber(value)) {</span>
<span class="nc" id="L132">                    super.updateVariableValue(variableInstance, Long.parseLong(value.toString()), tenantId);</span>
                } else {
<span class="nc" id="L134">                    super.updateVariableValue(variableInstance, value, tenantId);</span>
                }
<span class="nc" id="L136">            }</span>

            boolean isIntegralNumber(Object value) {
<span class="nc" id="L139">                return StringUtils.isNumeric(Objects.toString(value));</span>
            }
        };
<span class="nc" id="L142">        processEngineConfiguration.getVariableServiceConfiguration().setVariableInstanceValueModifier(variableValueModifier);</span>

<span class="nc" id="L144">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
        // First variable is a string
<span class="nc" id="L146">        variables.put(&quot;orderId&quot;, &quot;ABC&quot;);</span>

<span class="nc" id="L148">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;twoTasksProcess&quot;, variables);</span>
<span class="nc" id="L149">        VariableInstance orderIdInstance = runtimeService.getVariableInstance(processInstance.getId(), &quot;orderId&quot;);</span>
        // type should be string
<span class="nc" id="L151">        assertThat(orderIdInstance.getTypeName()).isEqualTo(&quot;string&quot;);</span>
<span class="nc" id="L152">        assertThat(orderIdInstance.getValue()).isEqualTo(&quot;ABC&quot;);</span>

<span class="nc bnc" id="L154" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L155">            HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L156">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L157">                    .includeProcessVariables()</span>
<span class="nc" id="L158">                    .singleResult();</span>
<span class="nc" id="L159">            assertThat(historicProcessInstance).isNotNull();</span>
<span class="nc" id="L160">            assertThat(historicProcessInstance.getProcessVariables())</span>
<span class="nc" id="L161">                    .contains(entry(&quot;orderId&quot;, &quot;ABC&quot;));</span>
        }

<span class="nc" id="L164">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
        // now we change it to be an integral number
<span class="nc" id="L166">        variables.put(&quot;orderId&quot;, 1);</span>
<span class="nc" id="L167">        taskService.complete(task.getId(), variables);</span>

<span class="nc" id="L169">        VariableInstanceEntity orderIdInstanceTask = (VariableInstanceEntity) runtimeService.getVariableInstance(processInstance.getId(), &quot;orderId&quot;);</span>
        // and expect it to be stored as long, because the variable value modifier forced it to be a long
<span class="nc" id="L171">        assertThat(orderIdInstanceTask.getTypeName()).isEqualTo(&quot;long&quot;);</span>
<span class="nc" id="L172">        assertThat(orderIdInstanceTask.getValue()).isEqualTo(1L);</span>
<span class="nc" id="L173">        assertThat(eventListener.getEventsReceived())</span>
<span class="nc" id="L174">                .filteredOn(event -&gt; event instanceof FlowableVariableEvent)</span>
<span class="nc" id="L175">                .map(FlowableVariableEvent.class::cast)</span>
<span class="nc" id="L176">                .extracting(FlowableVariableEvent::getVariableName, FlowableVariableEvent::getVariableValue)</span>
<span class="nc" id="L177">                .containsExactly(tuple(&quot;orderId&quot;, &quot;ABC&quot;), tuple(&quot;orderId&quot;, 1L));</span>

<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L180">            HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L181">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L182">                    .includeProcessVariables()</span>
<span class="nc" id="L183">                    .singleResult();</span>
<span class="nc" id="L184">            assertThat(historicProcessInstance).isNotNull();</span>
<span class="nc" id="L185">            assertThat(historicProcessInstance.getProcessVariables())</span>
<span class="nc" id="L186">                    .contains(entry(&quot;orderId&quot;, 1L));</span>
        }

<span class="nc" id="L189">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/twoTasksProcess.bpmn20.xml&quot; })
    public void testWrapVariableWithCustomType() {
<span class="nc" id="L194">        VariableTypes variableTypes = processEngineConfiguration.getVariableServiceConfiguration().getVariableTypes();</span>
<span class="nc" id="L195">        customType = new WrappedIntegerCustomType();</span>
<span class="nc" id="L196">        variableTypes.addTypeBefore(customType, &quot;integer&quot;);</span>
        try {
<span class="nc" id="L198">            processEngineConfiguration.getVariableServiceConfiguration()</span>
<span class="nc" id="L199">                    .setVariableInstanceValueModifier(new WrappedIntegerValueModifier(processEngineConfiguration.getVariableServiceConfiguration()));</span>

<span class="nc" id="L201">            Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L202">            variables.put(&quot;simpleInteger&quot;, 1000);</span>
<span class="nc" id="L203">            variables.put(&quot;wrappedInteger&quot;, 1001);</span>

<span class="nc" id="L205">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;twoTasksProcess&quot;, variables);</span>

<span class="nc" id="L207">            VariableInstance simpleInteger = runtimeService.getVariableInstance(processInstance.getId(), &quot;simpleInteger&quot;);</span>
<span class="nc" id="L208">            assertThat(simpleInteger.getTypeName()).isEqualTo(&quot;integer&quot;);</span>
<span class="nc" id="L209">            assertThat(simpleInteger.getValue()).isEqualTo(Integer.parseInt(&quot;1000&quot;));</span>

<span class="nc" id="L211">            VariableInstance wrappedInteger = runtimeService.getVariableInstance(processInstance.getId(), &quot;wrappedInteger&quot;);</span>
<span class="nc" id="L212">            assertThat(wrappedInteger.getTypeName()).isEqualTo(&quot;wrappedIntegerType&quot;);</span>
<span class="nc" id="L213">            assertThat(wrappedInteger.getValue()).isInstanceOfSatisfying(WrappedIntegerValue.class, wrappedIntegerValue -&gt; {</span>
<span class="nc" id="L214">                assertThat(wrappedIntegerValue.value).isEqualTo(1001);</span>
<span class="nc" id="L215">                assertThat(wrappedIntegerValue.metaInfo).isEqualTo(&quot;1001meta&quot;);</span>
<span class="nc" id="L216">            });</span>
<span class="nc" id="L217">            Object wrappedIntegerProcessVariable = processInstance.getProcessVariables().get(&quot;wrappedInteger&quot;);</span>
<span class="nc" id="L218">            assertThat(wrappedIntegerProcessVariable).isInstanceOfSatisfying(WrappedIntegerValue.class, wrappedIntegerValue -&gt; {</span>
<span class="nc" id="L219">                assertThat(wrappedIntegerValue.value).isEqualTo(1001);</span>
<span class="nc" id="L220">                assertThat(wrappedIntegerValue.metaInfo).isEqualTo(&quot;1001meta&quot;);</span>
<span class="nc" id="L221">            });</span>

<span class="nc" id="L223">            processInstance = runtimeService.createProcessInstanceQuery()</span>
<span class="nc" id="L224">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L225">                    .includeProcessVariables()</span>
<span class="nc" id="L226">                    .singleResult();</span>

<span class="nc" id="L228">            wrappedIntegerProcessVariable = processInstance.getProcessVariables().get(&quot;wrappedInteger&quot;);</span>
<span class="nc" id="L229">            assertThat(wrappedIntegerProcessVariable).isInstanceOfSatisfying(WrappedIntegerValue.class, wrappedIntegerValue -&gt; {</span>
<span class="nc" id="L230">                assertThat(wrappedIntegerValue.value).isEqualTo(1001);</span>
<span class="nc" id="L231">                assertThat(wrappedIntegerValue.metaInfo).isEqualTo(&quot;1001meta&quot;);</span>
<span class="nc" id="L232">            });</span>

<span class="nc bnc" id="L234" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L235">                HistoricVariableInstance historicVariableInstance = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L236">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L237">                        .variableName(&quot;wrappedInteger&quot;)</span>
<span class="nc" id="L238">                        .singleResult();</span>
<span class="nc" id="L239">                assertThat(historicVariableInstance).isNotNull();</span>
<span class="nc" id="L240">                assertThat(historicVariableInstance.getValue())</span>
<span class="nc" id="L241">                        .isInstanceOfSatisfying(WrappedIntegerValue.class, wrappedIntegerValue -&gt; {</span>
<span class="nc" id="L242">                            assertThat(wrappedIntegerValue.value).isEqualTo(1001);</span>
<span class="nc" id="L243">                            assertThat(wrappedIntegerValue.metaInfo).isEqualTo(&quot;1001meta&quot;);</span>
<span class="nc" id="L244">                        });</span>
<span class="nc" id="L245">                assertThat(historicVariableInstance.getVariableTypeName()).isEqualTo(&quot;wrappedIntegerType&quot;);</span>
<span class="nc" id="L246">                assertThat(historicVariableInstance.getMetaInfo()).isEqualTo(&quot;1001meta&quot;);</span>

<span class="nc" id="L248">                HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L249">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L250">                        .includeProcessVariables()</span>
<span class="nc" id="L251">                        .singleResult();</span>

<span class="nc" id="L253">                wrappedIntegerProcessVariable = historicProcessInstance.getProcessVariables().get(&quot;wrappedInteger&quot;);</span>
<span class="nc" id="L254">                assertThat(wrappedIntegerProcessVariable).isInstanceOfSatisfying(WrappedIntegerValue.class, wrappedIntegerValue -&gt; {</span>
<span class="nc" id="L255">                    assertThat(wrappedIntegerValue.value).isEqualTo(1001);</span>
<span class="nc" id="L256">                    assertThat(wrappedIntegerValue.metaInfo).isEqualTo(&quot;1001meta&quot;);</span>
<span class="nc" id="L257">                });</span>

<span class="nc" id="L259">                HistoricTaskInstance historicTask = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L260">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L261">                        .includeProcessVariables()</span>
<span class="nc" id="L262">                        .singleResult();</span>

<span class="nc" id="L264">                wrappedIntegerProcessVariable = historicTask.getProcessVariables().get(&quot;wrappedInteger&quot;);</span>
<span class="nc" id="L265">                assertThat(wrappedIntegerProcessVariable).isInstanceOfSatisfying(WrappedIntegerValue.class, wrappedIntegerValue -&gt; {</span>
<span class="nc" id="L266">                    assertThat(wrappedIntegerValue.value).isEqualTo(1001);</span>
<span class="nc" id="L267">                    assertThat(wrappedIntegerValue.metaInfo).isEqualTo(&quot;1001meta&quot;);</span>
<span class="nc" id="L268">                });</span>
            }

<span class="nc" id="L271">            Task task = taskService.createTaskQuery()</span>
<span class="nc" id="L272">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L273">                    .includeProcessVariables()</span>
<span class="nc" id="L274">                    .singleResult();</span>

<span class="nc" id="L276">            wrappedIntegerProcessVariable = task.getProcessVariables().get(&quot;wrappedInteger&quot;);</span>
<span class="nc" id="L277">            assertThat(wrappedIntegerProcessVariable).isInstanceOfSatisfying(WrappedIntegerValue.class, wrappedIntegerValue -&gt; {</span>
<span class="nc" id="L278">                assertThat(wrappedIntegerValue.value).isEqualTo(1001);</span>
<span class="nc" id="L279">                assertThat(wrappedIntegerValue.metaInfo).isEqualTo(&quot;1001meta&quot;);</span>
<span class="nc" id="L280">            });</span>

<span class="nc" id="L282">            variables.put(&quot;wrappedInteger&quot;, 1002);</span>
<span class="nc" id="L283">            taskService.complete(task.getId(), variables);</span>

<span class="nc" id="L285">            VariableInstanceEntity wrappedIntegerTaskUpdate = (VariableInstanceEntity) runtimeService.getVariableInstance(processInstance.getId(),</span>
                    &quot;wrappedInteger&quot;);
<span class="nc" id="L287">            assertThat(wrappedIntegerTaskUpdate.getValue()).isInstanceOfSatisfying(WrappedIntegerValue.class, wrappedIntegerValue -&gt; {</span>
<span class="nc" id="L288">                assertThat(wrappedIntegerValue.value).isEqualTo(1002);</span>
<span class="nc" id="L289">                assertThat(wrappedIntegerValue.metaInfo).isEqualTo(&quot;1002meta&quot;);</span>
<span class="nc" id="L290">            });</span>

<span class="nc" id="L292">            assertThat(eventListener.getEventsReceived())</span>
<span class="nc" id="L293">                    .filteredOn(event -&gt; event instanceof FlowableVariableEvent)</span>
<span class="nc" id="L294">                    .map(FlowableVariableEvent.class::cast)</span>
<span class="nc" id="L295">                    .extracting(FlowableVariableEvent::getVariableName,</span>
<span class="nc" id="L296">                            e -&gt; e.getVariableType().getTypeName(),</span>
                            FlowableVariableEvent::getVariableValue,
<span class="nc" id="L298">                            e -&gt; e.getType().name())</span>
<span class="nc" id="L299">                    .containsExactly(</span>
<span class="nc" id="L300">                            tuple(&quot;simpleInteger&quot;, &quot;integer&quot;, 1000, &quot;VARIABLE_CREATED&quot;),</span>
<span class="nc" id="L301">                            tuple(&quot;wrappedInteger&quot;, &quot;wrappedIntegerType&quot;, wrappedInteger.getValue(), &quot;VARIABLE_CREATED&quot;),</span>
<span class="nc" id="L302">                            tuple(&quot;simpleInteger&quot;, &quot;integer&quot;, 1000, &quot;VARIABLE_UPDATED&quot;),  // task completion triggers 'update' of this variable</span>
<span class="nc" id="L303">                            tuple(&quot;wrappedInteger&quot;, &quot;wrappedIntegerType&quot;, wrappedIntegerTaskUpdate.getValue(), &quot;VARIABLE_UPDATED&quot;));</span>

<span class="nc bnc" id="L305" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L306">                HistoricVariableInstance historicVariableInstance = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L307">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L308">                        .variableName(&quot;wrappedInteger&quot;)</span>
<span class="nc" id="L309">                        .singleResult();</span>
<span class="nc" id="L310">                assertThat(historicVariableInstance).isNotNull();</span>
<span class="nc" id="L311">                assertThat(historicVariableInstance.getValue())</span>
<span class="nc" id="L312">                        .isInstanceOfSatisfying(WrappedIntegerValue.class, wrappedIntegerValue -&gt; {</span>
<span class="nc" id="L313">                            assertThat(wrappedIntegerValue.value).isEqualTo(1002);</span>
<span class="nc" id="L314">                            assertThat(wrappedIntegerValue.metaInfo).isEqualTo(&quot;1002meta&quot;);</span>
<span class="nc" id="L315">                        });</span>
<span class="nc" id="L316">                assertThat(historicVariableInstance.getVariableTypeName()).isEqualTo(&quot;wrappedIntegerType&quot;);</span>
<span class="nc" id="L317">                assertThat(historicVariableInstance.getMetaInfo()).isEqualTo(&quot;1002meta&quot;);</span>
            }
        } finally {
            // We have to delete here. Otherwise the annotation deployment delete operation will fail, due to the missing custom type
<span class="nc" id="L321">            deleteDeployments();</span>
        }
<span class="nc" id="L323">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/twoTasksProcess.bpmn20.xml&quot; })
    public void testWrapVariableWithCustomTypeChangeToSimpleType() {
<span class="nc" id="L328">        VariableTypes variableTypes = processEngineConfiguration.getVariableServiceConfiguration().getVariableTypes();</span>
<span class="nc" id="L329">        customType = new WrappedIntegerCustomType();</span>
        try {
<span class="nc" id="L331">            variableTypes.addTypeBefore(customType, &quot;integer&quot;);</span>
<span class="nc" id="L332">            processEngineConfiguration.getVariableServiceConfiguration()</span>
<span class="nc" id="L333">                    .setVariableInstanceValueModifier(new WrappedIntegerValueModifier(processEngineConfiguration.getVariableServiceConfiguration()));</span>
<span class="nc" id="L334">            Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L335">            variables.put(&quot;wrappedInteger&quot;, 1001);</span>

<span class="nc" id="L337">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;twoTasksProcess&quot;, variables);</span>

<span class="nc" id="L339">            VariableInstanceEntity wrappedInteger = (VariableInstanceEntity) runtimeService.getVariableInstance(processInstance.getId(), &quot;wrappedInteger&quot;);</span>
<span class="nc" id="L340">            assertThat(wrappedInteger.getType()).isInstanceOf(WrappedIntegerCustomType.class);</span>
<span class="nc" id="L341">            assertThat(wrappedInteger.getTypeName()).isEqualTo(WrappedIntegerCustomType.TYPE_NAME);</span>
<span class="nc" id="L342">            assertThat(wrappedInteger.getValue()).isInstanceOfSatisfying(WrappedIntegerValue.class, wrappedIntegerValue -&gt; {</span>
<span class="nc" id="L343">                assertThat(wrappedIntegerValue.value).isEqualTo(1001);</span>
<span class="nc" id="L344">                assertThat(wrappedIntegerValue.metaInfo).isEqualTo(&quot;1001meta&quot;);</span>
<span class="nc" id="L345">            });</span>

            // Use variable query API to check if the variable can be retrieved by value correctly
<span class="nc" id="L348">            VariableInstanceEntity variableInstanceResult = (VariableInstanceEntity) runtimeService.createVariableInstanceQuery()</span>
<span class="nc" id="L349">                    .variableValueEquals(&quot;wrappedInteger&quot;, new WrappedIntegerValue(1001, null)).singleResult();</span>
<span class="nc" id="L350">            assertThat(variableInstanceResult.getType()).isInstanceOf(WrappedIntegerCustomType.class);</span>
<span class="nc" id="L351">            assertThat(variableInstanceResult.getTypeName()).isEqualTo(WrappedIntegerCustomType.TYPE_NAME);</span>
<span class="nc" id="L352">            assertThat(variableInstanceResult.getValue()).isInstanceOfSatisfying(WrappedIntegerValue.class, wrappedIntegerValue -&gt; {</span>
<span class="nc" id="L353">                assertThat(wrappedIntegerValue.value).isEqualTo(1001);</span>
<span class="nc" id="L354">                assertThat(wrappedIntegerValue.metaInfo).isEqualTo(&quot;1001meta&quot;);</span>
<span class="nc" id="L355">            });</span>

<span class="nc" id="L357">            Object wrappedIntegerProcessVariable = processInstance.getProcessVariables().get(&quot;wrappedInteger&quot;);</span>
<span class="nc" id="L358">            assertThat(wrappedIntegerProcessVariable).isInstanceOfSatisfying(WrappedIntegerValue.class, wrappedIntegerValue -&gt; {</span>
<span class="nc" id="L359">                assertThat(wrappedIntegerValue.value).isEqualTo(1001);</span>
<span class="nc" id="L360">                assertThat(wrappedIntegerValue.metaInfo).isEqualTo(&quot;1001meta&quot;);</span>
<span class="nc" id="L361">            });</span>

<span class="nc bnc" id="L363" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L364">                HistoricVariableInstance historicVariableInstance = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L365">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L366">                        .variableName(&quot;wrappedInteger&quot;)</span>
<span class="nc" id="L367">                        .singleResult();</span>
<span class="nc" id="L368">                assertThat(historicVariableInstance).isNotNull();</span>
<span class="nc" id="L369">                assertThat(historicVariableInstance.getValue())</span>
<span class="nc" id="L370">                        .isInstanceOfSatisfying(WrappedIntegerValue.class, wrappedIntegerValue -&gt; {</span>
<span class="nc" id="L371">                            assertThat(wrappedIntegerValue.value).isEqualTo(1001);</span>
<span class="nc" id="L372">                            assertThat(wrappedIntegerValue.metaInfo).isEqualTo(&quot;1001meta&quot;);</span>
<span class="nc" id="L373">                        });</span>
<span class="nc" id="L374">                assertThat(historicVariableInstance.getVariableTypeName()).isEqualTo(&quot;wrappedIntegerType&quot;);</span>
<span class="nc" id="L375">                assertThat(historicVariableInstance.getMetaInfo()).isEqualTo(&quot;1001meta&quot;);</span>
            }

            // Change back to simple integer type by setting value to 1000
<span class="nc" id="L379">            Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L380">            variables.put(&quot;wrappedInteger&quot;, 1000);</span>
<span class="nc" id="L381">            taskService.complete(task.getId(), variables);</span>

<span class="nc" id="L383">            VariableInstanceEntity wrappedIntegerTaskUpdate = (VariableInstanceEntity) runtimeService.getVariableInstance(processInstance.getId(),</span>
                    &quot;wrappedInteger&quot;);
<span class="nc" id="L385">            assertThat(wrappedIntegerTaskUpdate.getValue()).isInstanceOf(Integer.class).isEqualTo(1000);</span>
<span class="nc" id="L386">            assertThat(wrappedIntegerTaskUpdate.getMetaInfo()).isNull();</span>
<span class="nc" id="L387">            assertThat(wrappedIntegerTaskUpdate.getType()).isInstanceOf(IntegerType.class);</span>
<span class="nc" id="L388">            assertThat(wrappedIntegerTaskUpdate.getTypeName()).isEqualTo(IntegerType.TYPE_NAME);</span>

<span class="nc" id="L390">            assertThat(eventListener.getEventsReceived())</span>
<span class="nc" id="L391">                    .filteredOn(event -&gt; event instanceof FlowableVariableEvent)</span>
<span class="nc" id="L392">                    .map(FlowableVariableEvent.class::cast)</span>
<span class="nc" id="L393">                    .extracting(FlowableVariableEvent::getVariableName,</span>
<span class="nc" id="L394">                            e -&gt; e.getVariableType().getTypeName(),</span>
                            FlowableVariableEvent::getVariableValue,
<span class="nc" id="L396">                            e -&gt; e.getType().name())</span>
<span class="nc" id="L397">                    .containsExactly(</span>
<span class="nc" id="L398">                            tuple(&quot;wrappedInteger&quot;, &quot;wrappedIntegerType&quot;, wrappedInteger.getValue(), &quot;VARIABLE_CREATED&quot;),</span>
<span class="nc" id="L399">                            tuple(&quot;wrappedInteger&quot;, &quot;integer&quot;, 1000, &quot;VARIABLE_UPDATED&quot;));</span>

<span class="nc bnc" id="L401" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L402">                HistoricVariableInstance historicVariableInstance = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L403">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L404">                        .variableName(&quot;wrappedInteger&quot;)</span>
<span class="nc" id="L405">                        .singleResult();</span>
<span class="nc" id="L406">                assertThat(historicVariableInstance).isNotNull();</span>
<span class="nc" id="L407">                assertThat(historicVariableInstance.getValue()).isEqualTo(1000);</span>
<span class="nc" id="L408">                assertThat(historicVariableInstance.getVariableTypeName()).isEqualTo(IntegerType.TYPE_NAME);</span>
<span class="nc" id="L409">                assertThat(historicVariableInstance.getMetaInfo()).isNull();</span>
            }

        } finally {
            // We have to delete here. Otherwise the annotation deployment delete operation will fail, due to the missing custom type
<span class="nc" id="L414">            deleteDeployments();</span>
        }
<span class="nc" id="L416">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; }, tenantId = &quot;myTenant&quot;)
    public void testCompleteTaskWithExceptionInPostSetVariableWithTenantId() {
<span class="nc" id="L421">        TestOrderIdValidatingValueModifier valueModifier = new TestOrderIdValidatingValueModifier(processEngineConfiguration.getVariableServiceConfiguration());</span>
<span class="nc" id="L422">        processEngineConfiguration.getVariableServiceConfiguration().setVariableInstanceValueModifier(valueModifier);</span>

<span class="nc" id="L424">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L425">        variables.put(&quot;orderId&quot;, 1L);</span>
<span class="nc" id="L426">        ProcessInstance processInstance = runtimeService</span>
<span class="nc" id="L427">                .startProcessInstanceByKeyAndTenantId(&quot;oneTaskProcess&quot;, variables, &quot;myTenant&quot;);</span>

<span class="nc" id="L429">        assertThat(valueModifier.setVariableTenantIds).containsExactly(&quot;myTenant&quot;);</span>

<span class="nc" id="L431">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L432">            Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L433">            variables.put(&quot;orderId&quot;, -1L);</span>
<span class="nc" id="L434">            taskService.complete(task.getId(), variables);</span>
<span class="nc" id="L435">        }).isInstanceOf(FlowableIllegalArgumentException.class).hasMessage(&quot;Invalid type: value should be larger than zero&quot;);</span>

<span class="nc" id="L437">        assertThat(valueModifier.setVariableTenantIds).containsExactly(&quot;myTenant&quot;);</span>
<span class="nc" id="L438">        assertThat(valueModifier.updateVariableTenantIds).containsExactly(&quot;myTenant&quot;);</span>
<span class="nc" id="L439">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testTransientVariables() {
<span class="nc" id="L444">        processEngineConfiguration.getVariableServiceConfiguration()</span>
<span class="nc" id="L445">                .setVariableInstanceValueModifier(new TestOrderIdValidatingValueModifier(processEngineConfiguration.getVariableServiceConfiguration()));</span>

<span class="nc" id="L447">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L448">        variables.put(&quot;orderId&quot;, -1L);</span>
<span class="nc" id="L449">        variables.put(&quot;OtherVariable&quot;, &quot;Hello World&quot;);</span>

<span class="nc" id="L451">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L452">            runtimeService.createProcessInstanceBuilder().transientVariables(variables).processDefinitionKey(&quot;oneTaskProcess&quot;).start();</span>
<span class="nc" id="L453">        }).isInstanceOf(FlowableIllegalArgumentException.class).hasMessage(&quot;Invalid type: value should be larger than zero&quot;);</span>
<span class="nc" id="L454">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot;)
    void testEnhanceVariableWithMetaInfo() {

<span class="nc" id="L460">        ObjectMapper objectMapper = processEngineConfiguration.getObjectMapper();</span>
<span class="nc" id="L461">        List&lt;Object&gt; preSetValueCalls = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L462">        DefaultVariableInstanceValueModifier modifier = new DefaultVariableInstanceValueModifier(processEngineConfiguration.getVariableServiceConfiguration()) {</span>

            @Override
            public void setVariableValue(VariableInstance variableInstance, Object value, String tenantId) {
<span class="nc" id="L466">                preSetValueCalls.add(value);</span>
<span class="nc" id="L467">                assertThat(variableInstance.getProcessInstanceId()).isNotNull();</span>
<span class="nc" id="L468">                assertThat(variableInstance.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L469">                Pair&lt;Object, String&gt; valueAndMeta = determineValueAndMetaInfo(value);</span>
<span class="nc" id="L470">                super.setVariableValue(variableInstance, valueAndMeta.getLeft(), tenantId);</span>
<span class="nc" id="L471">                variableInstance.setMetaInfo(valueAndMeta.getRight());</span>
<span class="nc" id="L472">            }</span>

            @Override
            public void updateVariableValue(VariableInstance variableInstance, Object value, String tenantId) {
<span class="nc" id="L476">                preSetValueCalls.add(value);</span>
<span class="nc" id="L477">                assertThat(variableInstance.getProcessInstanceId()).isNotNull();</span>
<span class="nc" id="L478">                assertThat(variableInstance.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L479">                Pair&lt;Object, String&gt; valueAndMeta = determineValueAndMetaInfo(value);</span>
<span class="nc" id="L480">                super.updateVariableValue(variableInstance, valueAndMeta.getLeft(), tenantId);</span>
<span class="nc" id="L481">                variableInstance.setMetaInfo(valueAndMeta.getRight());</span>
<span class="nc" id="L482">            }</span>

            Pair&lt;Object, String&gt; determineValueAndMetaInfo(Object value) {
<span class="nc bnc" id="L485" title="All 2 branches missed.">                if (value instanceof String) {</span>
<span class="nc" id="L486">                    VariableMeta variableMeta = new VariableMeta();</span>
<span class="nc" id="L487">                    variableMeta.byteLength = String.valueOf(((String) value).getBytes().length);</span>
                    String metaInfo;
                    try {
<span class="nc" id="L490">                        metaInfo = objectMapper.writeValueAsString(variableMeta);</span>
<span class="nc" id="L491">                    } catch (JsonProcessingException e) {</span>
<span class="nc" id="L492">                        throw new RuntimeException(e);</span>
<span class="nc" id="L493">                    }</span>
<span class="nc" id="L494">                    return Pair.of(value + &quot;Enhanced&quot;, metaInfo);</span>
                }

<span class="nc" id="L497">                return Pair.of(value, null);</span>
            }

        };
<span class="nc" id="L501">        processEngineConfiguration.getVariableServiceConfiguration().setVariableInstanceValueModifier(modifier);</span>

<span class="nc" id="L503">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L504">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L505">                .variable(&quot;myEnhancedStringVariable&quot;, &quot;myValue1&quot;)</span>
<span class="nc" id="L506">                .variable(&quot;myIntVariable&quot;, 1)</span>
<span class="nc" id="L507">                .start();</span>

<span class="nc" id="L509">        Map&lt;String, Object&gt; processVariables = processInstance.getProcessVariables();</span>
<span class="nc" id="L510">        assertThat(processVariables.get(&quot;myEnhancedStringVariable&quot;)).isInstanceOf(String.class);</span>
<span class="nc" id="L511">        Object stringVariableValue = runtimeService.getVariable(processInstance.getId(), &quot;myEnhancedStringVariable&quot;);</span>
<span class="nc" id="L512">        assertThat(stringVariableValue).isEqualTo(&quot;myValue1Enhanced&quot;);</span>
<span class="nc" id="L513">        VariableInstance stringVariableInstance = runtimeService.getVariableInstance(processInstance.getId(), &quot;myEnhancedStringVariable&quot;);</span>
<span class="nc" id="L514">        assertThat(stringVariableInstance.getMetaInfo()).isEqualTo(&quot;{\&quot;byteLength\&quot;:\&quot;8\&quot;}&quot;);</span>


        // Use variable query API to check if the variable can be retrieved by value correctly
<span class="nc" id="L518">        VariableInstanceEntity variableInstanceResult = (VariableInstanceEntity) runtimeService.createVariableInstanceQuery()</span>
<span class="nc" id="L519">                .variableValueLike(&quot;myEnhancedStringVariable&quot;, &quot;myValue1Enh%&quot;).singleResult();</span>
<span class="nc" id="L520">        assertThat(variableInstanceResult.getType()).isInstanceOf(StringType.class);</span>
<span class="nc" id="L521">        assertThat(variableInstanceResult.getTypeName()).isEqualTo(&quot;string&quot;);</span>
<span class="nc" id="L522">        assertThat(variableInstanceResult.getValue()).isEqualTo(&quot;myValue1Enhanced&quot;);</span>


<span class="nc" id="L525">        assertThat(processVariables.get(&quot;myIntVariable&quot;)).isInstanceOf(Integer.class);</span>
<span class="nc" id="L526">        Object intVariableValue = runtimeService.getVariable(processInstance.getId(), &quot;myIntVariable&quot;);</span>
<span class="nc" id="L527">        assertThat(intVariableValue).isEqualTo(1);</span>

<span class="nc" id="L529">        VariableInstance intVariableInstance = runtimeService.getVariableInstance(processInstance.getId(), &quot;myIntVariable&quot;);</span>
<span class="nc" id="L530">        assertThat(intVariableInstance.getMetaInfo()).isNull();</span>

<span class="nc" id="L532">        assertThat(preSetValueCalls).containsExactlyInAnyOrder(&quot;myValue1&quot;, 1);</span>

<span class="nc bnc" id="L534" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L535">            HistoricVariableInstance historicVariableInstance = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L536">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L537">                    .variableName(&quot;myEnhancedStringVariable&quot;)</span>
<span class="nc" id="L538">                    .singleResult();</span>
<span class="nc" id="L539">            assertThat(historicVariableInstance).isNotNull();</span>
<span class="nc" id="L540">            assertThat(historicVariableInstance.getValue()).isEqualTo(&quot;myValue1Enhanced&quot;);</span>
<span class="nc" id="L541">            assertThat(historicVariableInstance.getVariableTypeName()).isEqualTo(&quot;string&quot;);</span>
<span class="nc" id="L542">            assertThat(historicVariableInstance.getMetaInfo()).isEqualTo(&quot;{\&quot;byteLength\&quot;:\&quot;8\&quot;}&quot;);</span>

<span class="nc" id="L544">            historicVariableInstance = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L545">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L546">                    .variableName(&quot;myIntVariable&quot;)</span>
<span class="nc" id="L547">                    .singleResult();</span>
<span class="nc" id="L548">            assertThat(historicVariableInstance).isNotNull();</span>
<span class="nc" id="L549">            assertThat(historicVariableInstance.getValue()).isEqualTo(1);</span>
<span class="nc" id="L550">            assertThat(historicVariableInstance.getMetaInfo()).isNull();</span>
        }
<span class="nc" id="L552">    }</span>

<span class="nc" id="L554">    static class VariableMeta {</span>

        @JsonProperty(&quot;byteLength&quot;)
        public String byteLength;

    }

<span class="nc" id="L561">    public static class WrappedIntegerCustomType extends IntegerType {</span>

        public static final String TYPE_NAME = &quot;wrappedIntegerType&quot;;

        @Override
        public String getTypeName() {
<span class="nc" id="L567">            return TYPE_NAME;</span>
        }

        @Override
        public void setValue(Object value, ValueFields valueFields) {
<span class="nc bnc" id="L572" title="All 2 branches missed.">            if (value instanceof WrappedIntegerValue) {</span>
<span class="nc" id="L573">                super.setValue(((WrappedIntegerValue) value).value, valueFields);</span>
            } else {
<span class="nc" id="L575">                super.setValue(value, valueFields);</span>
            }
<span class="nc" id="L577">        }</span>

        @Override
        public Object getValue(ValueFields valueFields) {
<span class="nc bnc" id="L581" title="All 2 branches missed.">            if (valueFields instanceof VariableInstance) {</span>
<span class="nc" id="L582">                return new WrappedIntegerValue(valueFields.getLongValue(), ((VariableInstance) valueFields).getMetaInfo());</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">            } else if (valueFields instanceof HistoricVariableInstance) {</span>
<span class="nc" id="L584">                return new WrappedIntegerValue(valueFields.getLongValue(), ((HistoricVariableInstance) valueFields).getMetaInfo());</span>
            }
<span class="nc" id="L586">            return super.getValue(valueFields);</span>
        }

        @Override
        public boolean isAbleToStore(Object value) {
<span class="nc bnc" id="L591" title="All 2 branches missed.">            if (value == null) {</span>
<span class="nc" id="L592">                return true;</span>
            }
<span class="nc" id="L594">            return value instanceof WrappedIntegerValue;</span>
        }
    }

    static class WrappedIntegerValue {

        public String metaInfo;
        public Integer value;

<span class="nc" id="L603">        public WrappedIntegerValue(Number value, String metaInfo) {</span>
<span class="nc" id="L604">            this.metaInfo = metaInfo;</span>
<span class="nc" id="L605">            this.value = value.intValue();</span>
<span class="nc" id="L606">        }</span>

        @Override
        public boolean equals(Object o) {
<span class="nc bnc" id="L610" title="All 2 branches missed.">            if (this == o) {</span>
<span class="nc" id="L611">                return true;</span>
            }
<span class="nc bnc" id="L613" title="All 4 branches missed.">            if (o == null || getClass() != o.getClass()) {</span>
<span class="nc" id="L614">                return false;</span>
            }
<span class="nc" id="L616">            WrappedIntegerValue that = (WrappedIntegerValue) o;</span>
<span class="nc bnc" id="L617" title="All 4 branches missed.">            return Objects.equals(metaInfo, that.metaInfo) &amp;&amp; Objects.equals(value, that.value);</span>
        }

        @Override
        public int hashCode() {
<span class="nc" id="L622">            return Objects.hash(metaInfo, value);</span>
        }
    }

    static class TestOrderIdValidatingValueModifier extends DefaultVariableInstanceValueModifier {

<span class="nc" id="L628">        final Collection&lt;String&gt; setVariableTenantIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L629">        final Collection&lt;String&gt; updateVariableTenantIds = new ArrayList&lt;&gt;();</span>

        TestOrderIdValidatingValueModifier(VariableServiceConfiguration serviceConfiguration) {
<span class="nc" id="L632">            super(serviceConfiguration);</span>
<span class="nc" id="L633">        }</span>

        @Override
        public void setVariableValue(VariableInstance variableInstance, Object value, String tenantId) {
<span class="nc" id="L637">            setVariableTenantIds.add(tenantId);</span>
<span class="nc" id="L638">            validateValue(variableInstance, value);</span>
<span class="nc" id="L639">            super.setVariableValue(variableInstance, value, tenantId);</span>
<span class="nc" id="L640">        }</span>

        @Override
        public void updateVariableValue(VariableInstance variableInstance, Object value, String tenantId) {
<span class="nc" id="L644">            updateVariableTenantIds.add(tenantId);</span>
<span class="nc" id="L645">            validateValue(variableInstance, value);</span>
<span class="nc" id="L646">            super.updateVariableValue(variableInstance, value, tenantId);</span>
<span class="nc" id="L647">        }</span>

        protected void validateValue(VariableInstance variableInstance, Object value) {
<span class="nc bnc" id="L650" title="All 2 branches missed.">            if (variableInstance.getName().equals(&quot;orderId&quot;)) {</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">                if (((Number) value).longValue() &lt; 0) {</span>
<span class="nc" id="L652">                    throw new FlowableIllegalArgumentException(&quot;Invalid type: value should be larger than zero&quot;);</span>
                }
            }
<span class="nc" id="L655">        }</span>
    }

    static class WrappedIntegerValueModifier extends DefaultVariableInstanceValueModifier {

        WrappedIntegerValueModifier(VariableServiceConfiguration serviceConfiguration) {
<span class="nc" id="L661">            super(serviceConfiguration);</span>
<span class="nc" id="L662">        }</span>


        @Override
        public void setVariableValue(VariableInstance variableInstance, Object value, String tenantId) {
<span class="nc" id="L667">            Pair&lt;Object, String&gt; valueAndMeta = determineValueAndMeta(value);</span>
<span class="nc" id="L668">            super.setVariableValue(variableInstance, valueAndMeta.getLeft(), tenantId);</span>
<span class="nc" id="L669">            variableInstance.setMetaInfo(valueAndMeta.getRight());</span>
<span class="nc" id="L670">        }</span>

        @Override
        public void updateVariableValue(VariableInstance variableInstance, Object value, String tenantId) {
<span class="nc" id="L674">            Pair&lt;Object, String&gt; valueAndMeta = determineValueAndMeta(value);</span>
<span class="nc" id="L675">            super.updateVariableValue(variableInstance, valueAndMeta.getLeft(), tenantId);</span>
<span class="nc" id="L676">            variableInstance.setMetaInfo(valueAndMeta.getRight());</span>
<span class="nc" id="L677">        }</span>

        Pair&lt;Object, String&gt; determineValueAndMeta(Object value) {
<span class="nc bnc" id="L680" title="All 4 branches missed.">            if (value instanceof Integer &amp;&amp; ((Integer) value) &gt; 1000) {</span>
<span class="nc" id="L681">                String metaInfo = value + &quot;meta&quot;;</span>
<span class="nc" id="L682">                return Pair.of(new WrappedIntegerValue((Number) value, metaInfo), metaInfo);</span>
            }
<span class="nc" id="L684">            return Pair.of(value, null);</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>