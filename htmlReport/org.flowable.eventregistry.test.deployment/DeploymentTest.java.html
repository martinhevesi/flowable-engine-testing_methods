<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DeploymentTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.eventregistry.test.deployment</a> &gt; <span class="el_source">DeploymentTest.java</span></div><h1>DeploymentTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.eventregistry.test.deployment;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.tuple;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

import org.flowable.common.engine.impl.persistence.deploy.DeploymentCache;
import org.flowable.eventregistry.api.ChannelDefinition;
import org.flowable.eventregistry.api.ChannelModelProcessor;
import org.flowable.eventregistry.api.EventDefinition;
import org.flowable.eventregistry.api.EventDeployment;
import org.flowable.eventregistry.api.EventRepositoryService;
import org.flowable.eventregistry.api.InboundChannelModelCacheManager;
import org.flowable.eventregistry.impl.EventRegistryEngineConfiguration;
import org.flowable.eventregistry.impl.deployer.DefaultInboundChannelModelCacheManager;
import org.flowable.eventregistry.impl.persistence.deploy.ChannelDefinitionCacheEntry;
import org.flowable.eventregistry.impl.pipeline.DefaultInboundEventProcessingPipeline;
import org.flowable.eventregistry.impl.pipeline.InboundChannelModelProcessor;
import org.flowable.eventregistry.impl.tenantdetector.InboundEventStaticTenantDetector;
import org.flowable.eventregistry.impl.tenantdetector.JsonPointerBasedInboundEventTenantDetector;
import org.flowable.eventregistry.impl.tenantdetector.XpathBasedInboundEventTenantDetector;
import org.flowable.eventregistry.model.ChannelModel;
import org.flowable.eventregistry.model.EventModel;
import org.flowable.eventregistry.model.EventPayload;
import org.flowable.eventregistry.model.InboundChannelModel;
import org.flowable.eventregistry.model.JmsInboundChannelModel;
import org.flowable.eventregistry.test.AbstractFlowableEventTest;
import org.flowable.eventregistry.test.ChannelDeploymentAnnotation;
import org.flowable.eventregistry.test.EventDeploymentAnnotation;
import org.junit.jupiter.api.Test;

import com.fasterxml.jackson.databind.ObjectMapper;

<span class="nc" id="L49">public class DeploymentTest extends AbstractFlowableEventTest {</span>

    @Test
    @EventDeploymentAnnotation(resources = &quot;org/flowable/eventregistry/test/deployment/simpleEvent.event&quot;)
    public void deploySingleEventDefinition() {
<span class="nc" id="L54">        EventDefinition eventDefinition = repositoryService.createEventDefinitionQuery()</span>
<span class="nc" id="L55">                .eventDefinitionKey(&quot;myEvent&quot;)</span>
<span class="nc" id="L56">                .latestVersion()</span>
<span class="nc" id="L57">                .singleResult();</span>
<span class="nc" id="L58">        assertThat(eventDefinition).isNotNull();</span>
<span class="nc" id="L59">        assertThat(eventDefinition.getKey()).isEqualTo(&quot;myEvent&quot;);</span>
<span class="nc" id="L60">        assertThat(eventDefinition.getVersion()).isEqualTo(1);</span>
<span class="nc" id="L61">    }</span>

    @Test
    @ChannelDeploymentAnnotation(resources = &quot;org/flowable/eventregistry/test/deployment/simpleChannel.channel&quot;)
    public void deploySingleChannelDefinition() {
<span class="nc" id="L66">        ChannelDefinition channelDefinition = repositoryService.createChannelDefinitionQuery()</span>
<span class="nc" id="L67">                .channelDefinitionKey(&quot;myChannel&quot;)</span>
<span class="nc" id="L68">                .latestVersion()</span>
<span class="nc" id="L69">                .singleResult();</span>
<span class="nc" id="L70">        assertThat(channelDefinition).isNotNull();</span>
<span class="nc" id="L71">        assertThat(channelDefinition.getKey()).isEqualTo(&quot;myChannel&quot;);</span>
<span class="nc" id="L72">        assertThat(channelDefinition.getVersion()).isEqualTo(1);</span>
<span class="nc" id="L73">    }</span>

    @Test
    @ChannelDeploymentAnnotation(resources = {
            &quot;org/flowable/eventregistry/test/deployment/simpleChannelWithFixedTenant.channel&quot;,
            &quot;org/flowable/eventregistry/test/deployment/simpleChannelWithJsonPointerTenant.channel&quot;,
            &quot;org/flowable/eventregistry/test/deployment/simpleChannelWithXPathTenant.channel&quot;
    })
    public void deployChannelsWithTenantDetection() {
<span class="nc" id="L82">        InboundChannelModel channel1 = (InboundChannelModel) eventRegistryEngine.getEventRepositoryService().getChannelModelByKey(&quot;channel1&quot;);</span>
<span class="nc" id="L83">        assertThat(((DefaultInboundEventProcessingPipeline) channel1.getInboundEventProcessingPipeline()).getInboundEventTenantDetector())</span>
<span class="nc" id="L84">                .isInstanceOf(InboundEventStaticTenantDetector.class);</span>

<span class="nc" id="L86">        InboundChannelModel channel2 = (InboundChannelModel) eventRegistryEngine.getEventRepositoryService().getChannelModelByKey(&quot;channel2&quot;);</span>
<span class="nc" id="L87">        DefaultInboundEventProcessingPipeline inboundEventProcessingPipeline = (DefaultInboundEventProcessingPipeline) channel2</span>
<span class="nc" id="L88">                .getInboundEventProcessingPipeline();</span>
<span class="nc" id="L89">        assertThat(inboundEventProcessingPipeline.getInboundEventTenantDetector()).isInstanceOf(JsonPointerBasedInboundEventTenantDetector.class);</span>
<span class="nc" id="L90">        assertThat(((JsonPointerBasedInboundEventTenantDetector) inboundEventProcessingPipeline.getInboundEventTenantDetector()).getJsonPointerExpression())</span>
<span class="nc" id="L91">                .isEqualTo(&quot;/tenantId&quot;);</span>

<span class="nc" id="L93">        InboundChannelModel channel3 = (InboundChannelModel) eventRegistryEngine.getEventRepositoryService().getChannelModelByKey(&quot;channel3&quot;);</span>
<span class="nc" id="L94">        inboundEventProcessingPipeline = (DefaultInboundEventProcessingPipeline) channel3.getInboundEventProcessingPipeline();</span>
<span class="nc" id="L95">        assertThat(inboundEventProcessingPipeline.getInboundEventTenantDetector()).isInstanceOf(XpathBasedInboundEventTenantDetector.class);</span>
<span class="nc" id="L96">        assertThat(((XpathBasedInboundEventTenantDetector) inboundEventProcessingPipeline.getInboundEventTenantDetector()).getXpathExpression())</span>
<span class="nc" id="L97">                .isEqualTo(&quot;/data/tenantId&quot;);</span>
<span class="nc" id="L98">    }</span>

    @Test
    @EventDeploymentAnnotation(resources = &quot;org/flowable/eventregistry/test/deployment/simpleEvent.event&quot;)
    @ChannelDeploymentAnnotation(resources = &quot;org/flowable/eventregistry/test/deployment/simpleChannel.channel&quot;)
    public void deployEventAndChannelDefinition() {
<span class="nc" id="L104">        EventDefinition eventDefinition = repositoryService.createEventDefinitionQuery()</span>
<span class="nc" id="L105">                .eventDefinitionKey(&quot;myEvent&quot;)</span>
<span class="nc" id="L106">                .latestVersion()</span>
<span class="nc" id="L107">                .singleResult();</span>
<span class="nc" id="L108">        assertThat(eventDefinition).isNotNull();</span>
<span class="nc" id="L109">        assertThat(eventDefinition.getKey()).isEqualTo(&quot;myEvent&quot;);</span>
<span class="nc" id="L110">        assertThat(eventDefinition.getVersion()).isEqualTo(1);</span>

<span class="nc" id="L112">        ChannelDefinition channelDefinition = repositoryService.createChannelDefinitionQuery()</span>
<span class="nc" id="L113">                .channelDefinitionKey(&quot;myChannel&quot;)</span>
<span class="nc" id="L114">                .latestVersion()</span>
<span class="nc" id="L115">                .singleResult();</span>
<span class="nc" id="L116">        assertThat(channelDefinition).isNotNull();</span>
<span class="nc" id="L117">        assertThat(channelDefinition.getKey()).isEqualTo(&quot;myChannel&quot;);</span>
<span class="nc" id="L118">        assertThat(channelDefinition.getVersion()).isEqualTo(1);</span>
<span class="nc" id="L119">    }</span>

    @Test
    @EventDeploymentAnnotation(resources = &quot;org/flowable/eventregistry/test/deployment/simpleEvent.event&quot;)
    public void redeploySingleEventDefinition() {
<span class="nc" id="L124">        EventDefinition eventDefinition = repositoryService.createEventDefinitionQuery()</span>
<span class="nc" id="L125">                .eventDefinitionKey(&quot;myEvent&quot;)</span>
<span class="nc" id="L126">                .latestVersion()</span>
<span class="nc" id="L127">                .singleResult();</span>
<span class="nc" id="L128">        assertThat(eventDefinition).isNotNull();</span>
<span class="nc" id="L129">        assertThat(eventDefinition.getKey()).isEqualTo(&quot;myEvent&quot;);</span>
<span class="nc" id="L130">        assertThat(eventDefinition.getVersion()).isEqualTo(1);</span>

<span class="nc" id="L132">        EventModel eventModel = repositoryService.getEventModelById(eventDefinition.getId());</span>
<span class="nc" id="L133">        assertThat(eventModel.getKey()).isEqualTo(&quot;myEvent&quot;);</span>

<span class="nc" id="L135">        assertThat(eventModel.getCorrelationParameters())</span>
<span class="nc" id="L136">                .extracting(EventPayload::getName, EventPayload::getType)</span>
<span class="nc" id="L137">                .containsExactly(tuple(&quot;customerId&quot;, &quot;string&quot;));</span>

<span class="nc" id="L139">        assertThat(eventModel.getPayload())</span>
<span class="nc" id="L140">                .extracting(EventPayload::getName, EventPayload::getType)</span>
<span class="nc" id="L141">                .containsExactly(</span>
<span class="nc" id="L142">                        tuple(&quot;payload1&quot;, &quot;string&quot;),</span>
<span class="nc" id="L143">                        tuple(&quot;payload2&quot;, &quot;integer&quot;),</span>
<span class="nc" id="L144">                        tuple(&quot;customerId&quot;, &quot;string&quot;)</span>
                );

<span class="nc" id="L147">        EventDeployment redeployment = repositoryService.createDeployment()</span>
<span class="nc" id="L148">                .addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleEvent2.event&quot;)</span>
<span class="nc" id="L149">                .deploy();</span>

<span class="nc" id="L151">        eventDefinition = repositoryService.createEventDefinitionQuery()</span>
<span class="nc" id="L152">                .eventDefinitionKey(&quot;myEvent&quot;)</span>
<span class="nc" id="L153">                .latestVersion()</span>
<span class="nc" id="L154">                .singleResult();</span>
<span class="nc" id="L155">        assertThat(eventDefinition).isNotNull();</span>
<span class="nc" id="L156">        assertThat(eventDefinition.getKey()).isEqualTo(&quot;myEvent&quot;);</span>
<span class="nc" id="L157">        assertThat(eventDefinition.getVersion()).isEqualTo(2);</span>

<span class="nc" id="L159">        eventModel = repositoryService.getEventModelById(eventDefinition.getId());</span>
<span class="nc" id="L160">        assertThat(eventModel.getKey()).isEqualTo(&quot;myEvent&quot;);</span>

<span class="nc" id="L162">        assertThat(eventModel.getCorrelationParameters())</span>
<span class="nc" id="L163">                .extracting(EventPayload::getName, EventPayload::getType)</span>
<span class="nc" id="L164">                .containsExactly(tuple(&quot;customerId2&quot;, &quot;string&quot;));</span>

<span class="nc" id="L166">        assertThat(eventModel.getPayload())</span>
<span class="nc" id="L167">                .extracting(EventPayload::getName, EventPayload::getType)</span>
<span class="nc" id="L168">                .containsExactly(</span>
<span class="nc" id="L169">                        tuple(&quot;payload3&quot;, &quot;string&quot;),</span>
<span class="nc" id="L170">                        tuple(&quot;payload4&quot;, &quot;integer&quot;),</span>
<span class="nc" id="L171">                        tuple(&quot;customerId2&quot;, &quot;string&quot;)</span>
                );

<span class="nc" id="L174">        repositoryService.deleteDeployment(redeployment.getId());</span>
<span class="nc" id="L175">    }</span>

    @Test
    @EventDeploymentAnnotation(resources = &quot;org/flowable/eventregistry/test/deployment/simpleChannel.channel&quot;)
    public void redeploySingleChannelDefinition() {
<span class="nc" id="L180">        ChannelDefinition channelDefinition = repositoryService.createChannelDefinitionQuery()</span>
<span class="nc" id="L181">                .channelDefinitionKey(&quot;myChannel&quot;)</span>
<span class="nc" id="L182">                .latestVersion()</span>
<span class="nc" id="L183">                .singleResult();</span>
<span class="nc" id="L184">        assertThat(channelDefinition).isNotNull();</span>
<span class="nc" id="L185">        assertThat(channelDefinition.getKey()).isEqualTo(&quot;myChannel&quot;);</span>
<span class="nc" id="L186">        assertThat(channelDefinition.getVersion()).isEqualTo(1);</span>

<span class="nc" id="L188">        ChannelModel channelModel = repositoryService.getChannelModelById(channelDefinition.getId());</span>
<span class="nc" id="L189">        assertThat(channelModel)</span>
<span class="nc" id="L190">                .isInstanceOfSatisfying(JmsInboundChannelModel.class, channel -&gt; {</span>
<span class="nc" id="L191">                    assertThat(channel.getKey()).isEqualTo(&quot;myChannel&quot;);</span>
<span class="nc" id="L192">                    assertThat(channel.getChannelType()).isEqualTo(&quot;inbound&quot;);</span>
<span class="nc" id="L193">                    assertThat(channel.getType()).isEqualTo(&quot;jms&quot;);</span>

<span class="nc" id="L195">                    assertThat(channel.getDestination()).isEqualTo(&quot;testQueue&quot;);</span>
<span class="nc" id="L196">                    assertThat(channel.getDeserializerType()).isEqualTo(&quot;json&quot;);</span>
<span class="nc" id="L197">                    assertThat(channel.getChannelEventKeyDetection().getFixedValue()).isEqualTo(&quot;myEvent&quot;);</span>
<span class="nc" id="L198">                    assertThat(channel.getInboundEventProcessingPipeline()).isNotNull();</span>
<span class="nc" id="L199">                });</span>

<span class="nc" id="L201">        EventDeployment redeployment = repositoryService.createDeployment()</span>
<span class="nc" id="L202">                .addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleChannel2.channel&quot;)</span>
<span class="nc" id="L203">                .deploy();</span>

<span class="nc" id="L205">        channelDefinition = repositoryService.createChannelDefinitionQuery()</span>
<span class="nc" id="L206">                .channelDefinitionKey(&quot;myChannel&quot;)</span>
<span class="nc" id="L207">                .latestVersion()</span>
<span class="nc" id="L208">                .singleResult();</span>
<span class="nc" id="L209">        assertThat(channelDefinition).isNotNull();</span>
<span class="nc" id="L210">        assertThat(channelDefinition.getKey()).isEqualTo(&quot;myChannel&quot;);</span>
<span class="nc" id="L211">        assertThat(channelDefinition.getVersion()).isEqualTo(2);</span>

<span class="nc" id="L213">        channelModel = repositoryService.getChannelModelById(channelDefinition.getId());</span>
<span class="nc" id="L214">        assertThat(channelModel)</span>
<span class="nc" id="L215">                .isInstanceOfSatisfying(JmsInboundChannelModel.class, channel -&gt; {</span>
<span class="nc" id="L216">                    assertThat(channel.getChannelType()).isEqualTo(&quot;inbound&quot;);</span>
<span class="nc" id="L217">                    assertThat(channel.getType()).isEqualTo(&quot;jms&quot;);</span>
<span class="nc" id="L218">                    assertThat(channel.getDestination()).isEqualTo(&quot;testQueue2&quot;);</span>

<span class="nc" id="L220">                    assertThat(channel.getDeserializerType()).isEqualTo(&quot;json&quot;);</span>
<span class="nc" id="L221">                    assertThat(channel.getChannelEventKeyDetection().getFixedValue()).isEqualTo(&quot;myEvent2&quot;);</span>
<span class="nc" id="L222">                    assertThat(channel.getInboundEventProcessingPipeline()).isNotNull();</span>
<span class="nc" id="L223">                });</span>
        
<span class="nc" id="L225">        channelModel = repositoryService.getChannelModelByKey(channelDefinition.getKey());</span>
<span class="nc" id="L226">        assertThat(channelModel)</span>
<span class="nc" id="L227">                .isInstanceOfSatisfying(JmsInboundChannelModel.class, channel -&gt; {</span>
<span class="nc" id="L228">                    assertThat(channel.getChannelType()).isEqualTo(&quot;inbound&quot;);</span>
<span class="nc" id="L229">                    assertThat(channel.getType()).isEqualTo(&quot;jms&quot;);</span>
<span class="nc" id="L230">                    assertThat(channel.getDestination()).isEqualTo(&quot;testQueue2&quot;);</span>

<span class="nc" id="L232">                    assertThat(channel.getDeserializerType()).isEqualTo(&quot;json&quot;);</span>
<span class="nc" id="L233">                    assertThat(channel.getChannelEventKeyDetection().getFixedValue()).isEqualTo(&quot;myEvent2&quot;);</span>
<span class="nc" id="L234">                    assertThat(channel.getInboundEventProcessingPipeline()).isNotNull();</span>
<span class="nc" id="L235">                });</span>
        
<span class="nc" id="L237">        channelModel = repositoryService.getChannelModelByKey(channelDefinition.getKey(), null);</span>
<span class="nc" id="L238">        assertThat(channelModel)</span>
<span class="nc" id="L239">                .isInstanceOfSatisfying(JmsInboundChannelModel.class, channel -&gt; {</span>
<span class="nc" id="L240">                    assertThat(channel.getChannelType()).isEqualTo(&quot;inbound&quot;);</span>
<span class="nc" id="L241">                    assertThat(channel.getType()).isEqualTo(&quot;jms&quot;);</span>
<span class="nc" id="L242">                    assertThat(channel.getDestination()).isEqualTo(&quot;testQueue2&quot;);</span>

<span class="nc" id="L244">                    assertThat(channel.getDeserializerType()).isEqualTo(&quot;json&quot;);</span>
<span class="nc" id="L245">                    assertThat(channel.getChannelEventKeyDetection().getFixedValue()).isEqualTo(&quot;myEvent2&quot;);</span>
<span class="nc" id="L246">                    assertThat(channel.getInboundEventProcessingPipeline()).isNotNull();</span>
<span class="nc" id="L247">                });</span>

<span class="nc" id="L249">        repositoryService.deleteDeployment(redeployment.getId());</span>
<span class="nc" id="L250">    }</span>
    
    @Test
    @EventDeploymentAnnotation(resources = &quot;org/flowable/eventregistry/test/deployment/simpleChannel.channel&quot;)
    public void redeploySameChannelDefinition() {
<span class="nc" id="L255">        ChannelDefinition channelDefinition = repositoryService.createChannelDefinitionQuery()</span>
<span class="nc" id="L256">                .channelDefinitionKey(&quot;myChannel&quot;)</span>
<span class="nc" id="L257">                .latestVersion()</span>
<span class="nc" id="L258">                .singleResult();</span>
<span class="nc" id="L259">        assertThat(channelDefinition).isNotNull();</span>
<span class="nc" id="L260">        assertThat(channelDefinition.getKey()).isEqualTo(&quot;myChannel&quot;);</span>
<span class="nc" id="L261">        assertThat(channelDefinition.getVersion()).isEqualTo(1);</span>

<span class="nc" id="L263">        ChannelModel channelModel = repositoryService.getChannelModelById(channelDefinition.getId());</span>
<span class="nc" id="L264">        assertThat(channelModel)</span>
<span class="nc" id="L265">                .isInstanceOfSatisfying(JmsInboundChannelModel.class, channel -&gt; {</span>
<span class="nc" id="L266">                    assertThat(channel.getKey()).isEqualTo(&quot;myChannel&quot;);</span>
<span class="nc" id="L267">                    assertThat(channel.getChannelType()).isEqualTo(&quot;inbound&quot;);</span>
<span class="nc" id="L268">                    assertThat(channel.getType()).isEqualTo(&quot;jms&quot;);</span>

<span class="nc" id="L270">                    assertThat(channel.getDestination()).isEqualTo(&quot;testQueue&quot;);</span>
<span class="nc" id="L271">                    assertThat(channel.getDeserializerType()).isEqualTo(&quot;json&quot;);</span>
<span class="nc" id="L272">                    assertThat(channel.getChannelEventKeyDetection().getFixedValue()).isEqualTo(&quot;myEvent&quot;);</span>
<span class="nc" id="L273">                    assertThat(channel.getInboundEventProcessingPipeline()).isNotNull();</span>
<span class="nc" id="L274">                });</span>

<span class="nc" id="L276">        EventDeployment redeployment = repositoryService.createDeployment()</span>
<span class="nc" id="L277">                .addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleChannel.channel&quot;)</span>
<span class="nc" id="L278">                .deploy();</span>

<span class="nc" id="L280">        channelDefinition = repositoryService.createChannelDefinitionQuery()</span>
<span class="nc" id="L281">                .channelDefinitionKey(&quot;myChannel&quot;)</span>
<span class="nc" id="L282">                .latestVersion()</span>
<span class="nc" id="L283">                .singleResult();</span>
<span class="nc" id="L284">        assertThat(channelDefinition).isNotNull();</span>
<span class="nc" id="L285">        assertThat(channelDefinition.getKey()).isEqualTo(&quot;myChannel&quot;);</span>
<span class="nc" id="L286">        assertThat(channelDefinition.getVersion()).isEqualTo(2);</span>

<span class="nc" id="L288">        channelModel = repositoryService.getChannelModelById(channelDefinition.getId());</span>
<span class="nc" id="L289">        assertThat(channelModel)</span>
<span class="nc" id="L290">                .isInstanceOfSatisfying(JmsInboundChannelModel.class, channel -&gt; {</span>
<span class="nc" id="L291">                    assertThat(channel.getChannelType()).isEqualTo(&quot;inbound&quot;);</span>
<span class="nc" id="L292">                    assertThat(channel.getType()).isEqualTo(&quot;jms&quot;);</span>
<span class="nc" id="L293">                    assertThat(channel.getDestination()).isEqualTo(&quot;testQueue&quot;);</span>

<span class="nc" id="L295">                    assertThat(channel.getDeserializerType()).isEqualTo(&quot;json&quot;);</span>
<span class="nc" id="L296">                    assertThat(channel.getChannelEventKeyDetection().getFixedValue()).isEqualTo(&quot;myEvent&quot;);</span>
<span class="nc" id="L297">                    assertThat(channel.getInboundEventProcessingPipeline()).isNotNull();</span>
<span class="nc" id="L298">                });</span>
        
<span class="nc" id="L300">        channelModel = repositoryService.getChannelModelByKey(channelDefinition.getKey());</span>
<span class="nc" id="L301">        assertThat(channelModel)</span>
<span class="nc" id="L302">                .isInstanceOfSatisfying(JmsInboundChannelModel.class, channel -&gt; {</span>
<span class="nc" id="L303">                    assertThat(channel.getChannelType()).isEqualTo(&quot;inbound&quot;);</span>
<span class="nc" id="L304">                    assertThat(channel.getType()).isEqualTo(&quot;jms&quot;);</span>
<span class="nc" id="L305">                    assertThat(channel.getDestination()).isEqualTo(&quot;testQueue&quot;);</span>

<span class="nc" id="L307">                    assertThat(channel.getDeserializerType()).isEqualTo(&quot;json&quot;);</span>
<span class="nc" id="L308">                    assertThat(channel.getChannelEventKeyDetection().getFixedValue()).isEqualTo(&quot;myEvent&quot;);</span>
<span class="nc" id="L309">                    assertThat(channel.getInboundEventProcessingPipeline()).isNotNull();</span>
<span class="nc" id="L310">                });</span>
        
<span class="nc" id="L312">        channelModel = repositoryService.getChannelModelByKey(channelDefinition.getKey(), null);</span>
<span class="nc" id="L313">        assertThat(channelModel)</span>
<span class="nc" id="L314">                .isInstanceOfSatisfying(JmsInboundChannelModel.class, channel -&gt; {</span>
<span class="nc" id="L315">                    assertThat(channel.getChannelType()).isEqualTo(&quot;inbound&quot;);</span>
<span class="nc" id="L316">                    assertThat(channel.getType()).isEqualTo(&quot;jms&quot;);</span>
<span class="nc" id="L317">                    assertThat(channel.getDestination()).isEqualTo(&quot;testQueue&quot;);</span>

<span class="nc" id="L319">                    assertThat(channel.getDeserializerType()).isEqualTo(&quot;json&quot;);</span>
<span class="nc" id="L320">                    assertThat(channel.getChannelEventKeyDetection().getFixedValue()).isEqualTo(&quot;myEvent&quot;);</span>
<span class="nc" id="L321">                    assertThat(channel.getInboundEventProcessingPipeline()).isNotNull();</span>
<span class="nc" id="L322">                });</span>

<span class="nc" id="L324">        repositoryService.deleteDeployment(redeployment.getId());</span>
<span class="nc" id="L325">    }</span>

    @Test
    @EventDeploymentAnnotation(resources = &quot;org/flowable/eventregistry/test/deployment/simpleChannel.channel&quot;, tenantId = &quot;tenant1&quot;)
    public void redeploySingleChannelDefinitionInMultipleTenants() {
<span class="nc" id="L330">        ChannelDefinition channelDefinition = repositoryService.createChannelDefinitionQuery()</span>
<span class="nc" id="L331">                .channelDefinitionKey(&quot;myChannel&quot;)</span>
<span class="nc" id="L332">                .latestVersion()</span>
<span class="nc" id="L333">                .singleResult();</span>
<span class="nc" id="L334">        assertThat(channelDefinition).isNotNull();</span>
<span class="nc" id="L335">        assertThat(channelDefinition.getKey()).isEqualTo(&quot;myChannel&quot;);</span>
<span class="nc" id="L336">        assertThat(channelDefinition.getTenantId()).isEqualTo(&quot;tenant1&quot;);</span>
<span class="nc" id="L337">        assertThat(channelDefinition.getVersion()).isEqualTo(1);</span>

<span class="nc" id="L339">        ChannelModel channelModel = repositoryService.getChannelModelById(channelDefinition.getId());</span>
<span class="nc" id="L340">        assertThat(channelModel)</span>
<span class="nc" id="L341">                .isInstanceOfSatisfying(JmsInboundChannelModel.class, channel -&gt; {</span>
<span class="nc" id="L342">                    assertThat(channel.getKey()).isEqualTo(&quot;myChannel&quot;);</span>
<span class="nc" id="L343">                    assertThat(channel.getChannelType()).isEqualTo(&quot;inbound&quot;);</span>
<span class="nc" id="L344">                    assertThat(channel.getType()).isEqualTo(&quot;jms&quot;);</span>

<span class="nc" id="L346">                    assertThat(channel.getDestination()).isEqualTo(&quot;testQueue&quot;);</span>
<span class="nc" id="L347">                    assertThat(channel.getDeserializerType()).isEqualTo(&quot;json&quot;);</span>
<span class="nc" id="L348">                    assertThat(channel.getChannelEventKeyDetection().getFixedValue()).isEqualTo(&quot;myEvent&quot;);</span>
<span class="nc" id="L349">                });</span>

<span class="nc" id="L351">        EventDeployment redeployment = repositoryService.createDeployment()</span>
<span class="nc" id="L352">                .addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleChannel2.channel&quot;)</span>
<span class="nc" id="L353">                .tenantId(&quot;tenant2&quot;)</span>
<span class="nc" id="L354">                .deploy();</span>

<span class="nc" id="L356">        channelDefinition = repositoryService.createChannelDefinitionQuery()</span>
<span class="nc" id="L357">                .channelDefinitionKey(&quot;myChannel&quot;)</span>
<span class="nc" id="L358">                .tenantId(&quot;tenant2&quot;)</span>
<span class="nc" id="L359">                .latestVersion()</span>
<span class="nc" id="L360">                .singleResult();</span>
<span class="nc" id="L361">        assertThat(channelDefinition).isNotNull();</span>
<span class="nc" id="L362">        assertThat(channelDefinition.getKey()).isEqualTo(&quot;myChannel&quot;);</span>
<span class="nc" id="L363">        assertThat(channelDefinition.getTenantId()).isEqualTo(&quot;tenant2&quot;);</span>
<span class="nc" id="L364">        assertThat(channelDefinition.getVersion()).isEqualTo(1);</span>

<span class="nc" id="L366">        channelModel = repositoryService.getChannelModelById(channelDefinition.getId());</span>
<span class="nc" id="L367">        assertThat(channelModel)</span>
<span class="nc" id="L368">                .isInstanceOfSatisfying(JmsInboundChannelModel.class, channel -&gt; {</span>
<span class="nc" id="L369">                    assertThat(channel.getChannelType()).isEqualTo(&quot;inbound&quot;);</span>
<span class="nc" id="L370">                    assertThat(channel.getType()).isEqualTo(&quot;jms&quot;);</span>
<span class="nc" id="L371">                    assertThat(channel.getDestination()).isEqualTo(&quot;testQueue2&quot;);</span>

<span class="nc" id="L373">                    assertThat(channel.getDeserializerType()).isEqualTo(&quot;json&quot;);</span>
<span class="nc" id="L374">                    assertThat(channel.getChannelEventKeyDetection().getFixedValue()).isEqualTo(&quot;myEvent2&quot;);</span>
<span class="nc" id="L375">                });</span>

<span class="nc" id="L377">        List&lt;ChannelDefinition&gt; channelDefinitions = repositoryService.createChannelDefinitionQuery()</span>
<span class="nc" id="L378">                .channelDefinitionKey(&quot;myChannel&quot;)</span>
<span class="nc" id="L379">                .latestVersion()</span>
<span class="nc" id="L380">                .list();</span>

<span class="nc" id="L382">        assertThat(channelDefinitions)</span>
<span class="nc" id="L383">                .extracting(ChannelDefinition::getKey, ChannelDefinition::getTenantId, ChannelDefinition::getVersion)</span>
<span class="nc" id="L384">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L385">                        tuple(&quot;myChannel&quot;, &quot;tenant1&quot;, 1),</span>
<span class="nc" id="L386">                        tuple(&quot;myChannel&quot;, &quot;tenant2&quot;, 1)</span>
                );

<span class="nc" id="L389">        EventDeployment redeployment2 = repositoryService.createDeployment()</span>
<span class="nc" id="L390">                .addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleChannel2.channel&quot;)</span>
<span class="nc" id="L391">                .tenantId(&quot;tenant1&quot;)</span>
<span class="nc" id="L392">                .deploy();</span>

<span class="nc" id="L394">        channelDefinitions = repositoryService.createChannelDefinitionQuery()</span>
<span class="nc" id="L395">                .channelDefinitionKey(&quot;myChannel&quot;)</span>
<span class="nc" id="L396">                .latestVersion()</span>
<span class="nc" id="L397">                .list();</span>

<span class="nc" id="L399">        assertThat(channelDefinitions)</span>
<span class="nc" id="L400">                .extracting(ChannelDefinition::getKey, ChannelDefinition::getTenantId, ChannelDefinition::getVersion)</span>
<span class="nc" id="L401">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L402">                        tuple(&quot;myChannel&quot;, &quot;tenant1&quot;, 2),</span>
<span class="nc" id="L403">                        tuple(&quot;myChannel&quot;, &quot;tenant2&quot;, 1)</span>
                );

<span class="nc" id="L406">        repositoryService.deleteDeployment(redeployment.getId());</span>
<span class="nc" id="L407">        repositoryService.deleteDeployment(redeployment2.getId());</span>
<span class="nc" id="L408">    }</span>

    @Test
    @EventDeploymentAnnotation(resources = { &quot;org/flowable/eventregistry/test/deployment/simpleEvent.event&quot;,
            &quot;org/flowable/eventregistry/test/deployment/orderEvent.event&quot; })
    public void deploy2EventDefinitions() {
<span class="nc" id="L414">        List&lt;EventDefinition&gt; eventDefinitions = repositoryService.createEventDefinitionQuery().orderByEventDefinitionName().asc().list();</span>
<span class="nc" id="L415">        assertThat(eventDefinitions)</span>
<span class="nc" id="L416">                .extracting(EventDefinition::getName)</span>
<span class="nc" id="L417">                .containsExactly(&quot;My event&quot;, &quot;My order event&quot;);</span>
<span class="nc" id="L418">    }</span>

    @Test
    @ChannelDeploymentAnnotation(resources = { &quot;org/flowable/eventregistry/test/deployment/simpleChannel.channel&quot;,
            &quot;org/flowable/eventregistry/test/deployment/orderChannel.channel&quot; })
    public void deploy2ChannelDefinitions() {
<span class="nc" id="L424">        List&lt;ChannelDefinition&gt; channelDefinitions = repositoryService.createChannelDefinitionQuery().orderByChannelDefinitionName().asc().list();</span>
<span class="nc" id="L425">        assertThat(channelDefinitions)</span>
<span class="nc" id="L426">                .extracting(ChannelDefinition::getName)</span>
<span class="nc" id="L427">                .containsExactly(&quot;My channel&quot;, &quot;Order channel&quot;);</span>
<span class="nc" id="L428">    }</span>
    
    @Test
    public void verifyInboundChannelModelCacheManager() {
<span class="nc" id="L432">        InboundChannelModelCacheManager inboundChannelModelCacheManager = eventEngineConfiguration.getInboundChannelModelCacheManager();</span>
        try {
<span class="nc" id="L434">            TestInboundChannelModelCacheManager testInboundChannelModelCacheManager = new TestInboundChannelModelCacheManager(eventEngineConfiguration);</span>
<span class="nc" id="L435">            eventEngineConfiguration.setInboundChannelModelCacheManager(testInboundChannelModelCacheManager);</span>
<span class="nc" id="L436">            repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleChannel.channel&quot;).deploy();</span>
            
<span class="nc" id="L438">            assertThat(testInboundChannelModelCacheManager.getCache()).hasSize(1);</span>
            
<span class="nc" id="L440">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).list()).hasSize(1);</span>
<span class="nc" id="L441">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).latestVersion().singleResult().getVersion()).isEqualTo(1);</span>
            
<span class="nc" id="L443">            repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleChannel.channel&quot;).deploy();</span>
            
<span class="nc" id="L445">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).list()).hasSize(2);</span>
<span class="nc" id="L446">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).latestVersion().singleResult().getVersion()).isEqualTo(2);</span>
            
<span class="nc" id="L448">            assertThat(testInboundChannelModelCacheManager.getCache()).hasSize(1);</span>
            
        } finally {
<span class="nc" id="L451">            eventEngineConfiguration.setInboundChannelModelCacheManager(inboundChannelModelCacheManager);</span>
<span class="nc" id="L452">            repositoryService.createDeploymentQuery().list().forEach(deployment -&gt; {</span>
<span class="nc" id="L453">                repositoryService.deleteDeployment(deployment.getId());</span>
<span class="nc" id="L454">            });</span>
        }
<span class="nc" id="L456">    }</span>
    
    @Test
    public void verifyInboundChannelCacheWithCustomProcessor() {
<span class="nc" id="L460">        List&lt;ChannelModelProcessor&gt; channelModelProcessors = (List&lt;ChannelModelProcessor&gt;) eventEngineConfiguration.getChannelModelProcessors();</span>
<span class="nc" id="L461">        TestChannelModelProcessor testChannelModelProcessor = new TestChannelModelProcessor(eventEngineConfiguration.getObjectMapper());</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">        for (int i = 0; i &lt; channelModelProcessors.size(); i++) {</span>
<span class="nc" id="L463">            ChannelModelProcessor channelModelProcessor = channelModelProcessors.get(i);</span>
<span class="nc bnc" id="L464" title="All 2 branches missed.">            if (channelModelProcessor instanceof InboundChannelModelProcessor) {</span>
<span class="nc" id="L465">                channelModelProcessors.set(i, testChannelModelProcessor);</span>
            }
        }
        
<span class="nc" id="L469">        eventEngineConfiguration.getInboundChannelModelCacheManager().cleanChannelModels();</span>
        
        try {
<span class="nc" id="L472">            repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleChannel.channel&quot;).deploy();</span>
            
<span class="nc" id="L474">            assertThat(testChannelModelProcessor.registeredChannelModels).hasSize(1);</span>
<span class="nc" id="L475">            assertThat(testChannelModelProcessor.unregisteredChannelModels).hasSize(1);</span>
            
<span class="nc" id="L477">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).list()).hasSize(1);</span>
<span class="nc" id="L478">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).latestVersion().singleResult().getVersion()).isEqualTo(1);</span>
            
<span class="nc" id="L480">            repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleChannel.channel&quot;).deploy();</span>
            
<span class="nc" id="L482">            assertThat(testChannelModelProcessor.registeredChannelModels).hasSize(2);</span>
<span class="nc" id="L483">            assertThat(testChannelModelProcessor.unregisteredChannelModels).hasSize(2);</span>
            
<span class="nc" id="L485">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).list()).hasSize(2);</span>
<span class="nc" id="L486">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).latestVersion().singleResult().getVersion()).isEqualTo(2);</span>
            
<span class="nc" id="L488">            repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleChannel2.channel&quot;).deploy();</span>
            
<span class="nc" id="L490">            assertThat(testChannelModelProcessor.registeredChannelModels).hasSize(3);</span>
<span class="nc" id="L491">            assertThat(testChannelModelProcessor.unregisteredChannelModels).hasSize(3);</span>
            
<span class="nc" id="L493">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).list()).hasSize(3);</span>
<span class="nc" id="L494">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).latestVersion().singleResult().getVersion()).isEqualTo(3);</span>
            
        } finally {
<span class="nc bnc" id="L497" title="All 2 branches missed.">            for (int i = 0; i &lt; channelModelProcessors.size(); i++) {</span>
<span class="nc" id="L498">                ChannelModelProcessor channelModelProcessor = channelModelProcessors.get(i);</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">                if (channelModelProcessor instanceof TestChannelModelProcessor) {</span>
<span class="nc" id="L500">                    channelModelProcessors.set(i, new InboundChannelModelProcessor(eventEngineConfiguration, eventEngineConfiguration.getObjectMapper()));</span>
                }
            }
            
<span class="nc" id="L504">            repositoryService.createDeploymentQuery().list().forEach(deployment -&gt; {</span>
<span class="nc" id="L505">                repositoryService.deleteDeployment(deployment.getId());</span>
<span class="nc" id="L506">            });</span>
        }
<span class="nc" id="L508">    }</span>
    
    @Test
    public void verifyChangeDetectionWithCustomProcessor() {
<span class="nc" id="L512">        List&lt;ChannelModelProcessor&gt; channelModelProcessors = (List&lt;ChannelModelProcessor&gt;) eventEngineConfiguration.getChannelModelProcessors();</span>
<span class="nc" id="L513">        TestChannelModelProcessor testChannelModelProcessor = new TestChannelModelProcessor(eventEngineConfiguration.getObjectMapper());</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">        for (int i = 0; i &lt; channelModelProcessors.size(); i++) {</span>
<span class="nc" id="L515">            ChannelModelProcessor channelModelProcessor = channelModelProcessors.get(i);</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">            if (channelModelProcessor instanceof InboundChannelModelProcessor) {</span>
<span class="nc" id="L517">                channelModelProcessors.set(i, testChannelModelProcessor);</span>
            }
        }
        
<span class="nc" id="L521">        eventEngineConfiguration.getInboundChannelModelCacheManager().cleanChannelModels();</span>
        
        try {
<span class="nc" id="L524">            repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleChannel.channel&quot;).deploy();</span>
            
<span class="nc" id="L526">            assertThat(testChannelModelProcessor.registeredChannelModels).hasSize(1);</span>
<span class="nc" id="L527">            assertThat(testChannelModelProcessor.unregisteredChannelModels).hasSize(1);</span>
            
<span class="nc" id="L529">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).list()).hasSize(1);</span>
<span class="nc" id="L530">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).latestVersion().singleResult().getVersion()).isEqualTo(1);</span>
            
<span class="nc" id="L532">            eventEngineConfiguration.getEventRegistryChangeDetectionManager().detectChanges();</span>
            
<span class="nc" id="L534">            assertThat(testChannelModelProcessor.registeredChannelModels).hasSize(1);</span>
<span class="nc" id="L535">            assertThat(testChannelModelProcessor.unregisteredChannelModels).hasSize(1);</span>
            
<span class="nc" id="L537">            repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleChannel2.channel&quot;).deploy();</span>
            
<span class="nc" id="L539">            assertThat(testChannelModelProcessor.registeredChannelModels).hasSize(2);</span>
<span class="nc" id="L540">            assertThat(testChannelModelProcessor.unregisteredChannelModels).hasSize(2);</span>
            
<span class="nc" id="L542">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).list()).hasSize(2);</span>
<span class="nc" id="L543">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).latestVersion().singleResult().getVersion()).isEqualTo(2);</span>
            
<span class="nc" id="L545">            eventEngineConfiguration.getEventRegistryChangeDetectionManager().detectChanges();</span>
            
<span class="nc" id="L547">            assertThat(testChannelModelProcessor.registeredChannelModels).hasSize(2);</span>
<span class="nc" id="L548">            assertThat(testChannelModelProcessor.unregisteredChannelModels).hasSize(2);</span>
            
<span class="nc" id="L550">            eventEngineConfiguration.getInboundChannelModelCacheManager().cleanChannelModels();</span>
            
<span class="nc" id="L552">            ChannelDefinition channelDefinition = repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).latestVersion().singleResult();</span>
<span class="nc" id="L553">            eventEngineConfiguration.getDeploymentManager().removeChannelDefinitionFromCache(channelDefinition);</span>
            
<span class="nc" id="L555">            assertThat(testChannelModelProcessor.registeredChannelModels).hasSize(2);</span>
<span class="nc" id="L556">            assertThat(testChannelModelProcessor.unregisteredChannelModels).hasSize(3);</span>

<span class="nc" id="L558">            eventEngineConfiguration.getEventRegistryChangeDetectionManager().detectChanges();</span>
            
<span class="nc" id="L560">            assertThat(testChannelModelProcessor.registeredChannelModels).hasSize(3);</span>
<span class="nc" id="L561">            assertThat(testChannelModelProcessor.unregisteredChannelModels).hasSize(4);</span>
            
        } finally {
<span class="nc bnc" id="L564" title="All 2 branches missed.">            for (int i = 0; i &lt; channelModelProcessors.size(); i++) {</span>
<span class="nc" id="L565">                ChannelModelProcessor channelModelProcessor = channelModelProcessors.get(i);</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">                if (channelModelProcessor instanceof TestChannelModelProcessor) {</span>
<span class="nc" id="L567">                    channelModelProcessors.set(i, new InboundChannelModelProcessor(eventEngineConfiguration, eventEngineConfiguration.getObjectMapper()));</span>
                }
            }
            
<span class="nc" id="L571">            repositoryService.createDeploymentQuery().list().forEach(deployment -&gt; {</span>
<span class="nc" id="L572">                repositoryService.deleteDeployment(deployment.getId());</span>
<span class="nc" id="L573">            });</span>
        }
<span class="nc" id="L575">    }</span>
    
    @Test
    public void verifyMTInboundChannelCacheWithCustomProcessor() {
<span class="nc" id="L579">        List&lt;ChannelModelProcessor&gt; channelModelProcessors = (List&lt;ChannelModelProcessor&gt;) eventEngineConfiguration.getChannelModelProcessors();</span>
<span class="nc" id="L580">        TestChannelModelProcessor testChannelModelProcessor = new TestChannelModelProcessor(eventEngineConfiguration.getObjectMapper());</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">        for (int i = 0; i &lt; channelModelProcessors.size(); i++) {</span>
<span class="nc" id="L582">            ChannelModelProcessor channelModelProcessor = channelModelProcessors.get(i);</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">            if (channelModelProcessor instanceof InboundChannelModelProcessor) {</span>
<span class="nc" id="L584">                channelModelProcessors.set(i, testChannelModelProcessor);</span>
            }
        }
        
<span class="nc" id="L588">        eventEngineConfiguration.getInboundChannelModelCacheManager().cleanChannelModels();</span>
        
        try {
<span class="nc" id="L591">            repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleChannel.channel&quot;)</span>
<span class="nc" id="L592">                    .tenantId(&quot;tenantA&quot;)</span>
<span class="nc" id="L593">                    .deploy();</span>
            
<span class="nc" id="L595">            assertThat(testChannelModelProcessor.registeredChannelModels).hasSize(1);</span>
<span class="nc" id="L596">            assertThat(testChannelModelProcessor.unregisteredChannelModels).hasSize(1);</span>
            
<span class="nc" id="L598">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).tenantId(&quot;tenantA&quot;).list()).hasSize(1);</span>
<span class="nc" id="L599">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).tenantId(&quot;tenantA&quot;).latestVersion().singleResult().getVersion()).isEqualTo(1);</span>
            
<span class="nc" id="L601">            repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleChannel.channel&quot;)</span>
<span class="nc" id="L602">                    .tenantId(&quot;tenantA&quot;)</span>
<span class="nc" id="L603">                    .deploy();</span>
            
<span class="nc" id="L605">            assertThat(testChannelModelProcessor.registeredChannelModels).hasSize(2);</span>
<span class="nc" id="L606">            assertThat(testChannelModelProcessor.unregisteredChannelModels).hasSize(2);</span>
            
<span class="nc" id="L608">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).tenantId(&quot;tenantA&quot;).list()).hasSize(2);</span>
<span class="nc" id="L609">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).tenantId(&quot;tenantA&quot;).latestVersion().singleResult().getVersion()).isEqualTo(2);</span>
            
<span class="nc" id="L611">            repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleChannel.channel&quot;)</span>
<span class="nc" id="L612">                    .tenantId(&quot;tenantB&quot;)</span>
<span class="nc" id="L613">                    .deploy();</span>
    
<span class="nc" id="L615">            assertThat(testChannelModelProcessor.registeredChannelModels).hasSize(3);</span>
<span class="nc" id="L616">            assertThat(testChannelModelProcessor.unregisteredChannelModels).hasSize(3);</span>
            
<span class="nc" id="L618">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).tenantId(&quot;tenantB&quot;).list()).hasSize(1);</span>
<span class="nc" id="L619">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).tenantId(&quot;tenantB&quot;).latestVersion().singleResult().getVersion()).isEqualTo(1);</span>
            
<span class="nc" id="L621">            repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleChannel2.channel&quot;)</span>
<span class="nc" id="L622">                    .tenantId(&quot;tenantA&quot;)</span>
<span class="nc" id="L623">                    .deploy();</span>
            
<span class="nc" id="L625">            assertThat(testChannelModelProcessor.registeredChannelModels).hasSize(4);</span>
<span class="nc" id="L626">            assertThat(testChannelModelProcessor.unregisteredChannelModels).hasSize(4);</span>
            
<span class="nc" id="L628">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).tenantId(&quot;tenantA&quot;).list()).hasSize(3);</span>
<span class="nc" id="L629">            assertThat(repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).tenantId(&quot;tenantA&quot;).latestVersion().singleResult().getVersion()).isEqualTo(3);</span>
            
        } finally {
<span class="nc bnc" id="L632" title="All 2 branches missed.">            for (int i = 0; i &lt; channelModelProcessors.size(); i++) {</span>
<span class="nc" id="L633">                ChannelModelProcessor channelModelProcessor = channelModelProcessors.get(i);</span>
<span class="nc bnc" id="L634" title="All 2 branches missed.">                if (channelModelProcessor instanceof TestChannelModelProcessor) {</span>
<span class="nc" id="L635">                    channelModelProcessors.set(i, new InboundChannelModelProcessor(eventEngineConfiguration, eventEngineConfiguration.getObjectMapper()));</span>
                }
            }
            
<span class="nc" id="L639">            repositoryService.createDeploymentQuery().list().forEach(deployment -&gt; {</span>
<span class="nc" id="L640">                repositoryService.deleteDeployment(deployment.getId());</span>
<span class="nc" id="L641">            });</span>
        }
<span class="nc" id="L643">    }</span>

    @Test
    public void deployNewChannelVersion() {
<span class="nc" id="L647">        DeploymentCache&lt;ChannelDefinitionCacheEntry&gt; channelDefinitionCache = eventEngineConfiguration.getChannelDefinitionCache();</span>

<span class="nc" id="L649">        repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleChannel.channel&quot;).deploy();</span>
<span class="nc" id="L650">        ChannelDefinition channelDefinition1 = repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).latestVersion()</span>
<span class="nc" id="L651">                .singleResult();</span>
<span class="nc" id="L652">        assertThat(channelDefinition1.getName()).isEqualTo(&quot;My channel&quot;);</span>

<span class="nc" id="L654">        assertThat(channelDefinitionCache.size()).isEqualTo(1);</span>
<span class="nc" id="L655">        assertThat(channelDefinitionCache.get(channelDefinition1.getId())).isNotNull();</span>

<span class="nc" id="L657">        repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleChannel2.channel&quot;).deploy();</span>

<span class="nc" id="L659">        ChannelDefinition channelDefinition2 = repositoryService.createChannelDefinitionQuery().channelDefinitionKey(&quot;myChannel&quot;).latestVersion()</span>
<span class="nc" id="L660">                .singleResult();</span>
<span class="nc" id="L661">        assertThat(channelDefinition2.getName()).isEqualTo(&quot;My channel2&quot;);</span>

<span class="nc" id="L663">        assertThat(channelDefinitionCache.size()).isEqualTo(2);</span>
<span class="nc" id="L664">        assertThat(channelDefinitionCache.get(channelDefinition1.getId())).isNotNull();</span>
<span class="nc" id="L665">        assertThat(channelDefinitionCache.get(channelDefinition2.getId())).isNotNull();</span>

<span class="nc" id="L667">        repositoryService.deleteDeployment(channelDefinition1.getDeploymentId());</span>
<span class="nc" id="L668">        repositoryService.deleteDeployment(channelDefinition2.getDeploymentId());</span>
<span class="nc" id="L669">    }</span>

    @Test
    public void deploySingleEventDefinitionWithParentDeploymentId() {
<span class="nc" id="L673">        EventDeployment deployment = repositoryService.createDeployment()</span>
<span class="nc" id="L674">                .addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleEvent.event&quot;)</span>
<span class="nc" id="L675">                .parentDeploymentId(&quot;someDeploymentId&quot;)</span>
<span class="nc" id="L676">                .deploy();</span>

<span class="nc" id="L678">        EventDeployment newDeployment = repositoryService.createDeployment()</span>
<span class="nc" id="L679">                .addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleEvent2.event&quot;)</span>
<span class="nc" id="L680">                .deploy();</span>

        try {
<span class="nc" id="L683">            EventDefinition definition = repositoryService.createEventDefinitionQuery().deploymentId(deployment.getId()).singleResult();</span>
<span class="nc" id="L684">            assertThat(definition).isNotNull();</span>
<span class="nc" id="L685">            assertThat(definition.getKey()).isEqualTo(&quot;myEvent&quot;);</span>
<span class="nc" id="L686">            assertThat(definition.getVersion()).isEqualTo(1);</span>

<span class="nc" id="L688">            EventDefinition newDefinition = repositoryService.createEventDefinitionQuery().deploymentId(newDeployment.getId()).singleResult();</span>
<span class="nc" id="L689">            assertThat(newDefinition).isNotNull();</span>
<span class="nc" id="L690">            assertThat(newDefinition.getKey()).isEqualTo(&quot;myEvent&quot;);</span>
<span class="nc" id="L691">            assertThat(newDefinition.getVersion()).isEqualTo(2);</span>

<span class="nc" id="L693">            EventModel eventModel = repositoryService.getEventModelByKeyAndParentDeploymentId(&quot;myEvent&quot;, &quot;someDeploymentId&quot;);</span>
<span class="nc" id="L694">            assertThat(eventModel.getKey()).isEqualTo(&quot;myEvent&quot;);</span>
<span class="nc" id="L695">            assertThat(eventModel.getName()).isEqualTo(&quot;My event&quot;);</span>

<span class="nc" id="L697">            eventEngineConfiguration.setAlwaysLookupLatestDefinitionVersion(true);</span>
<span class="nc" id="L698">            eventModel = repositoryService.getEventModelByKeyAndParentDeploymentId(&quot;myEvent&quot;, &quot;someDeploymentId&quot;);</span>
<span class="nc" id="L699">            assertThat(eventModel.getKey()).isEqualTo(&quot;myEvent&quot;);</span>
<span class="nc" id="L700">            assertThat(eventModel.getName()).isEqualTo(&quot;My event2&quot;);</span>

        } finally {
<span class="nc" id="L703">            eventEngineConfiguration.setAlwaysLookupLatestDefinitionVersion(false);</span>
<span class="nc" id="L704">            repositoryService.deleteDeployment(deployment.getId());</span>
<span class="nc" id="L705">            repositoryService.deleteDeployment(newDeployment.getId());</span>
        }
<span class="nc" id="L707">    }</span>

    @Test
    public void deploySingleChannelDefinitionWithParentDeploymentId() {
<span class="nc" id="L711">        EventDeployment deployment = repositoryService.createDeployment()</span>
<span class="nc" id="L712">                .addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleChannel.channel&quot;)</span>
<span class="nc" id="L713">                .parentDeploymentId(&quot;someDeploymentId&quot;)</span>
<span class="nc" id="L714">                .deploy();</span>

<span class="nc" id="L716">        EventDeployment newDeployment = repositoryService.createDeployment()</span>
<span class="nc" id="L717">                .addClasspathResource(&quot;org/flowable/eventregistry/test/deployment/simpleChannel2.channel&quot;)</span>
<span class="nc" id="L718">                .deploy();</span>

        try {
<span class="nc" id="L721">            ChannelDefinition definition = repositoryService.createChannelDefinitionQuery().deploymentId(deployment.getId()).singleResult();</span>
<span class="nc" id="L722">            assertThat(definition).isNotNull();</span>
<span class="nc" id="L723">            assertThat(definition.getKey()).isEqualTo(&quot;myChannel&quot;);</span>
<span class="nc" id="L724">            assertThat(definition.getVersion()).isEqualTo(1);</span>

<span class="nc" id="L726">            ChannelDefinition newDefinition = repositoryService.createChannelDefinitionQuery().deploymentId(newDeployment.getId()).singleResult();</span>
<span class="nc" id="L727">            assertThat(newDefinition).isNotNull();</span>
<span class="nc" id="L728">            assertThat(newDefinition.getKey()).isEqualTo(&quot;myChannel&quot;);</span>
<span class="nc" id="L729">            assertThat(newDefinition.getVersion()).isEqualTo(2);</span>

<span class="nc" id="L731">            ChannelModel channelModel = repositoryService.getChannelModelByKeyAndParentDeploymentId(&quot;myChannel&quot;, &quot;someDeploymentId&quot;);</span>
<span class="nc" id="L732">            assertThat(channelModel.getKey()).isEqualTo(&quot;myChannel&quot;);</span>
<span class="nc" id="L733">            assertThat(channelModel.getName()).isEqualTo(&quot;My channel&quot;);</span>

<span class="nc" id="L735">            eventEngineConfiguration.setAlwaysLookupLatestDefinitionVersion(true);</span>
<span class="nc" id="L736">            channelModel = repositoryService.getChannelModelByKeyAndParentDeploymentId(&quot;myChannel&quot;, &quot;someDeploymentId&quot;);</span>
<span class="nc" id="L737">            assertThat(channelModel.getKey()).isEqualTo(&quot;myChannel&quot;);</span>
<span class="nc" id="L738">            assertThat(channelModel.getName()).isEqualTo(&quot;My channel2&quot;);</span>

        } finally {
<span class="nc" id="L741">            eventEngineConfiguration.setAlwaysLookupLatestDefinitionVersion(false);</span>
<span class="nc" id="L742">            repositoryService.deleteDeployment(deployment.getId());</span>
<span class="nc" id="L743">            repositoryService.deleteDeployment(newDeployment.getId());</span>
        }
<span class="nc" id="L745">    }</span>

    @Test
    @EventDeploymentAnnotation(resources = &quot;org/flowable/eventregistry/test/deployment/eventWithChannelKeys.event&quot;)
    public void deployEventWithChannelKeys() {

        // In 6.5.0, event models had channel keys (inbound/outbound).
        // This test validates that they still can be deployed.

<span class="nc" id="L754">        EventDefinition eventDefinition = repositoryService.createEventDefinitionQuery()</span>
<span class="nc" id="L755">                .eventDefinitionKey(&quot;myOrderEvent&quot;)</span>
<span class="nc" id="L756">                .latestVersion()</span>
<span class="nc" id="L757">                .singleResult();</span>
<span class="nc" id="L758">        assertThat(eventDefinition).isNotNull();</span>
<span class="nc" id="L759">    }</span>
    
    protected static class TestInboundChannelModelCacheManager extends DefaultInboundChannelModelCacheManager {

        protected TestInboundChannelModelCacheManager(EventRegistryEngineConfiguration engineConfiguration) {
<span class="nc" id="L764">            super(engineConfiguration);</span>
<span class="nc" id="L765">        }</span>

        protected Map&lt;CacheKey, CacheValue&gt; getCache() {
<span class="nc" id="L768">            return cache;</span>
        }
    }
    
    protected class TestChannelModelProcessor extends InboundChannelModelProcessor {
        
<span class="nc" id="L774">        protected List&lt;InboundChannelModel&gt; unregisteredChannelModels = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L775">        protected List&lt;ChannelModel&gt; registeredChannelModels = new ArrayList&lt;&gt;();</span>
        
<span class="nc" id="L777">        public TestChannelModelProcessor(ObjectMapper objectMapper) {</span>
<span class="nc" id="L778">            super(eventEngineConfiguration, objectMapper);</span>
<span class="nc" id="L779">        }</span>

        @Override
        protected void registerChannelModel(InboundChannelModel inboundChannelModel,
                EventRepositoryService eventRepositoryService,
                ObjectMapper objectMapper, boolean fallbackToDefaultTenant) {

<span class="nc" id="L786">            registeredChannelModels.add(inboundChannelModel);</span>
<span class="nc" id="L787">            super.registerChannelModel(inboundChannelModel, eventRepositoryService, objectMapper, fallbackToDefaultTenant);</span>
<span class="nc" id="L788">        }</span>

        @Override
        public void unregisterChannelModel(ChannelModel channelModel, String tenantId, EventRepositoryService eventRepositoryService) {
<span class="nc" id="L792">            InboundChannelModel inboundChannelModel = (InboundChannelModel) channelModel;</span>
<span class="nc" id="L793">            unregisteredChannelModels.add(inboundChannelModel);</span>
<span class="nc" id="L794">            super.unregisterChannelModel(channelModel, tenantId, eventRepositoryService);</span>
<span class="nc" id="L795">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>