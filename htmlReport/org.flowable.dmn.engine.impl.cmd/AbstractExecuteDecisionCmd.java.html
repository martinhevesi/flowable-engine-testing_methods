<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractExecuteDecisionCmd.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.dmn.engine.impl.cmd</a> &gt; <span class="el_source">AbstractExecuteDecisionCmd.java</span></div><h1>AbstractExecuteDecisionCmd.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.dmn.engine.impl.cmd;

import java.io.Serializable;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang3.StringUtils;
import org.flowable.common.engine.api.FlowableIllegalArgumentException;
import org.flowable.common.engine.api.FlowableObjectNotFoundException;
import org.flowable.common.engine.api.scope.ScopeTypes;
import org.flowable.common.engine.impl.interceptor.CommandContext;
import org.flowable.dmn.api.DmnDecision;
import org.flowable.dmn.api.DmnDeployment;
import org.flowable.dmn.api.ExecuteDecisionContext;
import org.flowable.dmn.engine.DmnEngineConfiguration;
import org.flowable.dmn.engine.impl.DmnDeploymentQueryImpl;
import org.flowable.dmn.engine.impl.ExecuteDecisionBuilderImpl;
import org.flowable.dmn.engine.impl.persistence.deploy.DecisionCacheEntry;
import org.flowable.dmn.engine.impl.persistence.entity.DecisionEntityManager;
import org.flowable.dmn.engine.impl.util.CommandContextUtil;
import org.flowable.dmn.model.Decision;
import org.flowable.dmn.model.DmnDefinition;

/**
 * @author Yvo Swillens
 */
public abstract class AbstractExecuteDecisionCmd implements Serializable {

    private static final long serialVersionUID = 1L;

    protected ExecuteDecisionContext executeDecisionContext;

<span class="nc" id="L45">    public AbstractExecuteDecisionCmd(ExecuteDecisionContext executeDecisionContext) {</span>
<span class="nc" id="L46">        this.executeDecisionContext = executeDecisionContext;</span>
<span class="nc" id="L47">    }</span>

<span class="nc" id="L49">    public AbstractExecuteDecisionCmd(ExecuteDecisionBuilderImpl definitionBuilder) {</span>
<span class="nc" id="L50">        executeDecisionContext = new ExecuteDecisionContext();</span>
<span class="nc" id="L51">        executeDecisionContext.setDecisionKey(definitionBuilder.getDecisionKey());</span>
<span class="nc" id="L52">        executeDecisionContext.setParentDeploymentId(definitionBuilder.getParentDeploymentId());</span>
<span class="nc" id="L53">        executeDecisionContext.setInstanceId(definitionBuilder.getInstanceId());</span>
<span class="nc" id="L54">        executeDecisionContext.setExecutionId(definitionBuilder.getExecutionId());</span>
<span class="nc" id="L55">        executeDecisionContext.setActivityId(definitionBuilder.getActivityId());</span>
<span class="nc" id="L56">        executeDecisionContext.setScopeType(definitionBuilder.getScopeType());</span>
<span class="nc" id="L57">        executeDecisionContext.setVariables(definitionBuilder.getVariables());</span>
<span class="nc" id="L58">        executeDecisionContext.setTenantId(definitionBuilder.getTenantId());</span>
<span class="nc" id="L59">        executeDecisionContext.setFallbackToDefaultTenant(definitionBuilder.isFallbackToDefaultTenant());</span>
<span class="nc" id="L60">    }</span>

<span class="nc" id="L62">    public AbstractExecuteDecisionCmd(String decisionKey, Map&lt;String, Object&gt; variables) {</span>
<span class="nc" id="L63">        executeDecisionContext = new ExecuteDecisionContext();</span>
<span class="nc" id="L64">        executeDecisionContext.setDecisionKey(decisionKey);</span>
<span class="nc" id="L65">        executeDecisionContext.setVariables(variables);</span>
<span class="nc" id="L66">    }</span>

    protected DmnDefinition resolveDefinition() {
<span class="nc" id="L69">        DmnDecision decision = null;</span>
<span class="nc" id="L70">        DmnEngineConfiguration dmnEngineConfiguration = CommandContextUtil.getDmnEngineConfiguration();</span>
<span class="nc" id="L71">        DecisionEntityManager decisionEntityManager = dmnEngineConfiguration.getDecisionEntityManager();</span>

<span class="nc" id="L73">        String decisionKey = executeDecisionContext.getDecisionKey();</span>
<span class="nc" id="L74">        String parentDeploymentId = executeDecisionContext.getParentDeploymentId();</span>
<span class="nc" id="L75">        String tenantId = executeDecisionContext.getTenantId();</span>

<span class="nc bnc" id="L77" title="All 4 branches missed.">        if (StringUtils.isNotEmpty(decisionKey) &amp;&amp; StringUtils.isNotEmpty(parentDeploymentId) &amp;&amp;</span>
<span class="nc bnc" id="L78" title="All 4 branches missed.">                        !dmnEngineConfiguration.isAlwaysLookupLatestDefinitionVersion() &amp;&amp; StringUtils.isNotEmpty(tenantId)) {</span>
            
<span class="nc" id="L80">            List&lt;DmnDeployment&gt; dmnDeployments = CommandContextUtil.getDeploymentEntityManager().findDeploymentsByQueryCriteria(</span>
<span class="nc" id="L81">                new DmnDeploymentQueryImpl().parentDeploymentId(parentDeploymentId));</span>

<span class="nc bnc" id="L83" title="All 4 branches missed.">            if (dmnDeployments != null &amp;&amp; dmnDeployments.size() != 0) {</span>
<span class="nc" id="L84">                decision = decisionEntityManager.findDecisionByDeploymentAndKeyAndTenantId(</span>
<span class="nc" id="L85">                    dmnDeployments.get(0).getId(), decisionKey, tenantId);</span>
            }

<span class="nc bnc" id="L88" title="All 2 branches missed.">            if (decision == null) {</span>
                // If there is no decision table found linked to the deployment id, try to find one without a specific deployment id.
<span class="nc" id="L90">                decision = decisionEntityManager.findLatestDecisionByKeyAndTenantId(decisionKey, tenantId);</span>

<span class="nc bnc" id="L92" title="All 2 branches missed.">                if (decision == null) {</span>
                    // if fallback to default tenant is enabled do a final lookup query
<span class="nc bnc" id="L94" title="All 4 branches missed.">                    if (executeDecisionContext.isFallbackToDefaultTenant() || dmnEngineConfiguration.isFallbackToDefaultTenant()) {</span>
<span class="nc" id="L95">                        String defaultTenant = dmnEngineConfiguration.getDefaultTenantProvider().getDefaultTenant(tenantId, ScopeTypes.DMN, decisionKey);</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">                        if (StringUtils.isNotEmpty(defaultTenant)) {</span>
<span class="nc" id="L97">                            decision = decisionEntityManager.findLatestDecisionByKeyAndTenantId(decisionKey, defaultTenant);</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                            if (decision == null) {</span>
<span class="nc" id="L99">                                throw new FlowableObjectNotFoundException(&quot;No decision found for key: &quot; + decisionKey +</span>
                                    &quot;. There was also no fall back decision found for default tenant &quot; + defaultTenant);
                            }
                            
                        } else {
<span class="nc" id="L104">                            decision = decisionEntityManager.findLatestDecisionByKey(decisionKey);</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                            if (decision == null) {</span>
<span class="nc" id="L106">                                throw new FlowableObjectNotFoundException(&quot;No decision found for key: &quot; + decisionKey +</span>
                                    &quot;. There was also no fall back decision table found without tenant.&quot;);
                            }
                        }
                        
<span class="nc" id="L111">                    } else {</span>
<span class="nc" id="L112">                        throw new FlowableObjectNotFoundException(&quot;No decision found for key: &quot; + decisionKey +</span>
                            &quot;, parent deployment id &quot; + parentDeploymentId + &quot; and tenant id: &quot; + tenantId +
                            &quot;. There was also no fall back decision found without parent deployment id.&quot;);
                    }
                }
            }
            
<span class="nc bnc" id="L119" title="All 4 branches missed.">        } else if (StringUtils.isNotEmpty(decisionKey) &amp;&amp; StringUtils.isNotEmpty(parentDeploymentId) &amp;&amp;</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">                        !dmnEngineConfiguration.isAlwaysLookupLatestDefinitionVersion()) {</span>
            
<span class="nc" id="L122">            List&lt;DmnDeployment&gt; dmnDeployments = CommandContextUtil.getDeploymentEntityManager().findDeploymentsByQueryCriteria(</span>
<span class="nc" id="L123">                new DmnDeploymentQueryImpl().parentDeploymentId(parentDeploymentId));</span>

<span class="nc bnc" id="L125" title="All 4 branches missed.">            if (dmnDeployments != null &amp;&amp; dmnDeployments.size() != 0) {</span>
<span class="nc" id="L126">                decision = decisionEntityManager.findDecisionByDeploymentAndKey(dmnDeployments.get(0).getId(), decisionKey);</span>
            }

<span class="nc bnc" id="L129" title="All 2 branches missed.">            if (decision == null) {</span>
                // If there is no decision table found linked to the deployment id, try to find one without a specific deployment id.
<span class="nc" id="L131">                decision = decisionEntityManager.findLatestDecisionByKey(decisionKey);</span>

<span class="nc bnc" id="L133" title="All 2 branches missed.">                if (decision == null) {</span>
<span class="nc" id="L134">                    throw new FlowableObjectNotFoundException(&quot;No decision found for key: &quot; + decisionKey +</span>
                        &quot; and parent deployment id &quot; + parentDeploymentId +
                        &quot;. There was also no fall back decision found without parent deployment id.&quot;);
                }
            }
            
<span class="nc bnc" id="L140" title="All 4 branches missed.">        } else if (StringUtils.isNotEmpty(decisionKey) &amp;&amp; StringUtils.isNotEmpty(tenantId)) {</span>
<span class="nc" id="L141">            decision = decisionEntityManager.findLatestDecisionByKeyAndTenantId(decisionKey, tenantId);</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">            if (decision == null) {</span>
<span class="nc bnc" id="L143" title="All 4 branches missed.">                if (executeDecisionContext.isFallbackToDefaultTenant() || dmnEngineConfiguration.isFallbackToDefaultTenant()) {</span>
<span class="nc" id="L144">                    String defaultTenant = dmnEngineConfiguration.getDefaultTenantProvider().getDefaultTenant(tenantId, ScopeTypes.DMN, decisionKey);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">                    if (StringUtils.isNotEmpty(defaultTenant)) {</span>
<span class="nc" id="L146">                        decision = decisionEntityManager.findLatestDecisionByKeyAndTenantId(decisionKey, defaultTenant);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">                        if (decision == null) {</span>
<span class="nc" id="L148">                            throw new FlowableObjectNotFoundException(&quot;No decision found for key: &quot; + decisionKey +</span>
                                &quot;. There was also no fall back decision found for default tenant &quot; +
                                defaultTenant + &quot;.&quot;);
                        }

                    } else {
<span class="nc" id="L154">                        decision = decisionEntityManager.findLatestDecisionByKey(decisionKey);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                        if (decision == null) {</span>
<span class="nc" id="L156">                            throw new FlowableObjectNotFoundException(&quot;No decision found for key: &quot; + decisionKey +</span>
                                &quot;. There was also no fall back decision found without tenant.&quot;);
                        }
                    }

<span class="nc" id="L161">                } else {</span>
<span class="nc" id="L162">                    throw new FlowableObjectNotFoundException(</span>
                        &quot;No decision found for key: &quot; + decisionKey + &quot; and tenantId: &quot; + tenantId + &quot;.&quot;);
                }
            }

<span class="nc bnc" id="L167" title="All 2 branches missed.">        } else if (StringUtils.isNotEmpty(decisionKey)) {</span>
<span class="nc" id="L168">            decision = decisionEntityManager.findLatestDecisionByKey(decisionKey);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">            if (decision == null) {</span>
<span class="nc" id="L170">                throw new FlowableObjectNotFoundException(&quot;No decision found for key: &quot; + decisionKey + &quot;.&quot;);</span>
            }
            
        } else {
<span class="nc" id="L174">            throw new FlowableIllegalArgumentException(&quot;decisionKey is null&quot;);</span>
        }

<span class="nc" id="L177">        executeDecisionContext.setDecisionId(decision.getId());</span>
<span class="nc" id="L178">        executeDecisionContext.setDecisionVersion(decision.getVersion());</span>
<span class="nc" id="L179">        executeDecisionContext.setDeploymentId(decision.getDeploymentId());</span>

<span class="nc" id="L181">        DecisionCacheEntry decisionTableCacheEntry = CommandContextUtil.getDmnEngineConfiguration().getDeploymentManager().resolveDecision(decision);</span>
<span class="nc" id="L182">        DmnDefinition dmnDefinition = decisionTableCacheEntry.getDmnDefinition();</span>

<span class="nc" id="L184">        return dmnDefinition;</span>
    }

    protected void execute(CommandContext commandContext, DmnDefinition definition) {
<span class="nc" id="L188">        Decision decision = definition.getDecisionById(executeDecisionContext.getDecisionKey());</span>

<span class="nc bnc" id="L190" title="All 2 branches missed.">        if (decision == null) {</span>
<span class="nc" id="L191">            throw new FlowableIllegalArgumentException(&quot;no decision with id: '&quot; + executeDecisionContext.getDecisionKey() + &quot;' found in definition&quot;);</span>
        }

<span class="nc" id="L194">        executeDecisionContext.setDmnElement(decision);</span>
<span class="nc" id="L195">        CommandContextUtil.getAgenda(commandContext).planExecuteDecisionOperation(executeDecisionContext, decision);</span>
<span class="nc" id="L196">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>