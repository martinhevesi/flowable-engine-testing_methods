<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DecisionTaskTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.dmn.test.runtime</a> &gt; <span class="el_source">DecisionTaskTest.java</span></div><h1>DecisionTaskTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.dmn.test.runtime;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

import java.util.List;
import java.util.Map;

import org.flowable.cmmn.api.CmmnRuntimeService;
import org.flowable.cmmn.api.DecisionTableVariableManager;
import org.flowable.cmmn.api.runtime.CaseInstance;
import org.flowable.cmmn.api.runtime.PlanItemInstance;
import org.flowable.cmmn.api.runtime.PlanItemInstanceState;
import org.flowable.cmmn.engine.CmmnEngineConfiguration;
import org.flowable.cmmn.engine.test.CmmnDeployment;
import org.flowable.cmmn.engine.test.FlowableCmmnRule;
import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.impl.DefaultTenantProvider;
import org.flowable.common.engine.impl.interceptor.EngineConfigurationConstants;
import org.flowable.dmn.api.DmnHistoricDecisionExecution;
import org.flowable.dmn.engine.DmnEngineConfiguration;
import org.flowable.dmn.engine.DmnEngines;
import org.flowable.task.api.Task;
import org.junit.After;
import org.junit.Rule;
import org.junit.Test;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.DoubleNode;
import com.fasterxml.jackson.databind.node.ObjectNode;

/**
 * @author martin.grofcik
 * @author Filip Hrisafov
 * @author Valentin Zickner
 */
<span class="nc" id="L51">public class DecisionTaskTest {</span>

<span class="nc" id="L53">    @Rule</span>
    public FlowableCmmnRule cmmnRule = new FlowableCmmnRule(&quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.cfg.xml&quot;);
    
    @After
    public void tearDown() {
<span class="nc" id="L58">        deleteAllDmnDeployments();</span>
<span class="nc" id="L59">    }</span>

    @Test
    @CmmnDeployment(
            resources = {&quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.cmmn&quot;,
                    &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.dmn&quot;
            }
    )
    public void testDecisionServiceTask() {
<span class="nc" id="L68">        CaseInstance caseInstance = cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L69">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L70">                .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L71">                .start();</span>

<span class="nc" id="L73">        assertResultVariable(caseInstance);</span>
<span class="nc" id="L74">    }</span>

    @Test
    @CmmnDeployment(
            resources = { &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.cmmn&quot;,
                          &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.dmn&quot;
            }
    )
    public void testUnknowPropertyUsedInDmn() {
<span class="nc" id="L83">        assertThatThrownBy(() -&gt; cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L84">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L85">                .start())</span>
<span class="nc" id="L86">                .isInstanceOf(FlowableException.class)</span>
<span class="nc" id="L87">                .hasMessageContaining(&quot;DMN decision with key decisionTable execution failed. Cause: Unknown property used in expression: #{testVar == \&quot;test2\&quot;}&quot;);</span>
<span class="nc" id="L88">    }</span>

    @Test
    @CmmnDeployment(
            resources = { &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.cmmn&quot;,
                          &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.dmn&quot;
            }
    )
    public void testDecisionServiceTaskWithoutHitDefaultBehavior() {
<span class="nc" id="L97">        CaseInstance caseInstance = cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L98">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L99">                .variable(&quot;testVar&quot;, &quot;noHit&quot;)</span>
<span class="nc" id="L100">                .start();</span>

<span class="nc" id="L102">        assertNoResultVariable(caseInstance);</span>
<span class="nc" id="L103">    }</span>

    @Test
    @CmmnDeployment(
            resources = { &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testHitFlag.cmmn&quot;,
                          &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.dmn&quot;
            }
    )
    public void testDoNotThrowErrorOnNoHitWithHit() {
<span class="nc" id="L112">        CaseInstance caseInstance = cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L113">                .variable(&quot;throwErrorOnNoHits&quot;, false)</span>
<span class="nc" id="L114">                .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L115">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L116">                .start();</span>

<span class="nc" id="L118">        assertResultVariable(caseInstance);</span>
<span class="nc" id="L119">    }</span>

    @Test
    @CmmnDeployment(
            resources = { &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testHitFlag.cmmn&quot;,
                          &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.dmn&quot;
            }
    )
    public void testThrowErrorOnNoHitBooleanExpression() {
<span class="nc" id="L128">        CaseInstance caseInstance = cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L129">                .variable(&quot;throwErrorOnNoHits&quot;, Boolean.FALSE)</span>
<span class="nc" id="L130">                .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L131">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L132">                .start();</span>

<span class="nc" id="L134">        assertResultVariable(caseInstance);</span>
<span class="nc" id="L135">    }</span>

    @Test
    @CmmnDeployment(
            resources = { &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testHitFlag.cmmn&quot;,
                          &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.dmn&quot;
            }
    )
    public void testThrowErrorOnNoHitWithHit() {
<span class="nc" id="L144">        CaseInstance caseInstance = cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L145">                .variable(&quot;throwErrorOnNoHits&quot;, true)</span>
<span class="nc" id="L146">                .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L147">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L148">                .start();</span>

<span class="nc" id="L150">        assertResultVariable(caseInstance);</span>
<span class="nc" id="L151">    }</span>

    @Test
    @CmmnDeployment(
            resources = { &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testHitFlag.cmmn&quot;,
                          &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.dmn&quot;
            }
    )
    public void testThrowErrorOnNoHit() {
<span class="nc" id="L160">        assertThatThrownBy(() -&gt; cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L161">                .variable(&quot;throwErrorOnNoHits&quot;, true)</span>
<span class="nc" id="L162">                .variable(&quot;testVar&quot;, &quot;noHit&quot;)</span>
<span class="nc" id="L163">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L164">                .start())</span>
<span class="nc" id="L165">                .isInstanceOf(FlowableException.class)</span>
<span class="nc" id="L166">                .hasMessageContaining(&quot;DMN decision with key decisionTable did not hit any rules for the provided input.&quot;);</span>
<span class="nc" id="L167">    }</span>

    @Test
    @CmmnDeployment(
            resources = {&quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testHitFlag.cmmn&quot;,
                    &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.dmn&quot;
            }
    )
    public void testDoNotThrowErrorOnNoHit() {
<span class="nc" id="L176">        CaseInstance caseInstance = cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L177">                .variable(&quot;throwErrorOnNoHits&quot;, false)</span>
<span class="nc" id="L178">                .variable(&quot;testVar&quot;, &quot;noHitValue&quot;)</span>
<span class="nc" id="L179">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L180">                .start();</span>

<span class="nc" id="L182">        assertNoResultVariable(caseInstance);</span>
<span class="nc" id="L183">    }</span>

    @Test
    @CmmnDeployment(
            resources = {&quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testExpressionReferenceKey.cmmn&quot;,
                    &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.dmn&quot;
            }
    )
    public void testExpressionReferenceKey() {
<span class="nc" id="L192">        CaseInstance caseInstance = cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L193">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L194">                .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L195">                .variable(&quot;referenceKey&quot;, &quot;decisionTable&quot;)</span>
<span class="nc" id="L196">                .start();</span>

<span class="nc" id="L198">        assertResultVariable(caseInstance);</span>
<span class="nc" id="L199">    }</span>

    @Test
    @CmmnDeployment(
            resources = {&quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testExpressionReferenceKey.cmmn&quot;}
    )
    public void testNullReferenceKey() {
<span class="nc" id="L206">        assertThatThrownBy(() -&gt; cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L207">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L208">                .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L209">                .variable(&quot;referenceKey&quot;, null)</span>
<span class="nc" id="L210">                .start())</span>
<span class="nc" id="L211">                .isInstanceOf(FlowableException.class)</span>
<span class="nc" id="L212">                .hasMessageContaining(&quot;Could not execute decision: no externalRef defined&quot;);</span>
<span class="nc" id="L213">    }</span>

    @Test
    @CmmnDeployment(
            resources = {&quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testExpressionReferenceKey.cmmn&quot;}
    )
    public void testNonStringReferenceKey() {
<span class="nc" id="L220">        assertThatThrownBy(() -&gt; cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L221">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L222">                .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L223">                .variable(&quot;referenceKey&quot;, 1)</span>
<span class="nc" id="L224">                .start())</span>
<span class="nc" id="L225">                .isInstanceOf(FlowableException.class)</span>
<span class="nc" id="L226">                .hasMessageContaining(&quot;No decision found for key: 1 and parent deployment id&quot;);</span>
<span class="nc" id="L227">    }</span>

    @Test
    @CmmnDeployment(
            resources = {&quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testExpressionReferenceKey.cmmn&quot;}
    )
    public void testNonExistingReferenceKey() {
<span class="nc" id="L234">        assertThatThrownBy(() -&gt; cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L235">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L236">                .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L237">                .variable(&quot;referenceKey&quot;, &quot;NonExistingReferenceKey&quot;)</span>
<span class="nc" id="L238">                .start())</span>
<span class="nc" id="L239">                .isInstanceOf(FlowableException.class)</span>
<span class="nc" id="L240">                .hasMessageContaining(&quot;No decision found for key: NonExistingReferenceKey and parent deployment id&quot;);</span>
<span class="nc" id="L241">    }</span>

    @Test
    @CmmnDeployment(
            resources = {
                    &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testBlocking.cmmn&quot;,
                    &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.dmn&quot;
            }
    )
    public void testBlocking() {
        // is blocking is not taken into the execution
<span class="nc" id="L252">        CaseInstance caseInstance = cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L253">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L254">                .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L255">                .variable(&quot;referenceKey&quot;, &quot;decisionTable&quot;)</span>
<span class="nc" id="L256">                .start();</span>

<span class="nc" id="L258">        assertResultVariable(caseInstance);</span>
<span class="nc" id="L259">    }</span>

    @Test
    @CmmnDeployment(
        resources = {
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testUseDmnOutputInEntryCriteria.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testUseDmnOutputInEntryCriteria.dmn&quot;
        }
    )
    public void testUseDmnOutputInEntryCriteria() {
<span class="nc" id="L269">        CaseInstance caseInstance = cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L270">                .caseDefinitionKey(&quot;testRules&quot;)</span>
<span class="nc" id="L271">                .variable(&quot;first&quot;, &quot;11&quot;)</span>
<span class="nc" id="L272">                .variable(&quot;second&quot;, &quot;11&quot;)</span>
<span class="nc" id="L273">                .start();</span>

        // The entry sentry on the first stage uses the output of the DMN table
<span class="nc" id="L276">        List&lt;Task&gt; tasks = cmmnRule.getCmmnTaskService().createTaskQuery().caseInstanceId(caseInstance.getId()).orderByTaskName().asc().list();</span>
<span class="nc" id="L277">        assertThat(tasks.get(0).getName()).isEqualTo(&quot;Human task&quot;);</span>
<span class="nc" id="L278">        assertThat(tasks.get(1).getName()).isEqualTo(&quot;Task One&quot;);</span>
<span class="nc" id="L279">    }</span>

    @Test
    @CmmnDeployment(
        resources = {&quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTaskFallBackToDefaultTenant.cmmn&quot;},
        tenantId = &quot;flowable&quot;
    )
    public void testDecisionServiceTaskWithFallback() {
<span class="nc" id="L287">        deployDmnTableAssertCaseStarted();</span>
<span class="nc" id="L288">    }</span>
    
    @Test
    @CmmnDeployment(
        resources = {&quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTaskFallBackToDefaultTenantFalse.cmmn&quot;},
        tenantId = &quot;flowable&quot;
    )
    public void testDecisionServiceTaskWithFallbackFalse() {
<span class="nc" id="L296">        assertThatThrownBy(this::deployDmnTableAssertCaseStarted)</span>
<span class="nc" id="L297">                .isInstanceOf(FlowableException.class)</span>
<span class="nc" id="L298">                .hasMessageContaining(&quot;and tenant id: flowable. There was also no fall back decision found without parent deployment id.&quot;);</span>
<span class="nc" id="L299">    }</span>
    
    @Test
    @CmmnDeployment(
        resources = {&quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.cmmn&quot;},
        tenantId = &quot;flowable&quot;
    )
    public void testDecisionServiceTaskWithGlobalTenantFallback() {
<span class="nc" id="L307">        deployDmnTableWithGlobalTenantFallback(&quot;defaultFlowable&quot;);</span>
<span class="nc" id="L308">    }</span>
    
    @Test
    @CmmnDeployment(
        resources = {&quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTaskFallBackToDefaultTenantFalse.cmmn&quot;},
        tenantId = &quot;flowable&quot;
    )
    public void testDecisionServiceTaskWithGlobalTenantFallbackNoDefinition() {
<span class="nc" id="L316">        assertThatThrownBy(() -&gt; deployDmnTableWithGlobalTenantFallback(&quot;otherTenant&quot;))</span>
<span class="nc" id="L317">                .isInstanceOf(FlowableException.class)</span>
<span class="nc" id="L318">                .hasMessageContaining(&quot;There was also no fall back decision found for default tenant defaultFlowable&quot;);</span>
<span class="nc" id="L319">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTaskSameDeployment.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.dmn&quot;
    })
    public void testDecisionTaskExecutionWithSameDeployment() {
<span class="nc" id="L327">        CmmnRuntimeService cmmnRuntimeService = cmmnRule.getCmmnRuntimeService();</span>
<span class="nc" id="L328">        CaseInstance caseInstance = cmmnRuntimeService</span>
<span class="nc" id="L329">                .createCaseInstanceBuilder()</span>
<span class="nc" id="L330">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L331">                .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L332">                .start();</span>

<span class="nc" id="L334">        assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;resultVar&quot;))</span>
<span class="nc" id="L335">                .isEqualTo(&quot;executed&quot;);</span>

        try {
            // Same deployment decision should be used from parent deployment
<span class="nc" id="L339">            DmnEngines.getDefaultDmnEngine()</span>
<span class="nc" id="L340">                    .getDmnRepositoryService()</span>
<span class="nc" id="L341">                    .createDeployment()</span>
<span class="nc" id="L342">                    .addClasspathResource(&quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTaskV2.dmn&quot;)</span>
<span class="nc" id="L343">                    .deploy();</span>

<span class="nc" id="L345">            caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L346">                    .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L347">                    .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L348">                    .start();</span>

<span class="nc" id="L350">            assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;resultVar&quot;))</span>
<span class="nc" id="L351">                    .isEqualTo(&quot;executed&quot;);</span>

        } finally {
<span class="nc" id="L354">            deleteAllDmnDeployments();</span>
        }
<span class="nc" id="L356">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTaskSameDeployment.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.dmn&quot;
    }, tenantId = &quot;flowable&quot;)
    public void testDecisionTaskExecutionWithSameDeploymentInTenant() {
<span class="nc" id="L364">        CmmnRuntimeService cmmnRuntimeService = cmmnRule.getCmmnRuntimeService();</span>
<span class="nc" id="L365">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L366">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L367">                .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L368">                .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L369">                .start();</span>

<span class="nc" id="L371">        assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;resultVar&quot;))</span>
<span class="nc" id="L372">                .isEqualTo(&quot;executed&quot;);</span>

        try {
            // Same deployment decision should be used from parent deployment
<span class="nc" id="L376">            DmnEngines.getDefaultDmnEngine()</span>
<span class="nc" id="L377">                    .getDmnRepositoryService()</span>
<span class="nc" id="L378">                    .createDeployment()</span>
<span class="nc" id="L379">                    .addClasspathResource(&quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTaskV2.dmn&quot;)</span>
<span class="nc" id="L380">                    .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L381">                    .deploy();</span>

<span class="nc" id="L383">            caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L384">                    .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L385">                    .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L386">                    .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L387">                    .start();</span>

<span class="nc" id="L389">            assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;resultVar&quot;))</span>
<span class="nc" id="L390">                    .isEqualTo(&quot;executed&quot;);</span>

        } finally {
<span class="nc" id="L393">            deleteAllDmnDeployments();</span>
        }
<span class="nc" id="L395">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.dmn&quot;
    })
    public void testDecisionTaskExecutionWithSameDeploymentGlobal() {
<span class="nc" id="L403">        CmmnRuntimeService cmmnRuntimeService = cmmnRule.getCmmnRuntimeService();</span>
<span class="nc" id="L404">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L405">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L406">                .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L407">                .start();</span>

<span class="nc" id="L409">        assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;resultVar&quot;))</span>
<span class="nc" id="L410">                .isEqualTo(&quot;executed&quot;);</span>

        try {
            // Same deployment decision should be used from parent deployment
<span class="nc" id="L414">            DmnEngines.getDefaultDmnEngine()</span>
<span class="nc" id="L415">                    .getDmnRepositoryService()</span>
<span class="nc" id="L416">                    .createDeployment()</span>
<span class="nc" id="L417">                    .addClasspathResource(&quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTaskV2.dmn&quot;)</span>
<span class="nc" id="L418">                    .deploy();</span>

<span class="nc" id="L420">            caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L421">                    .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L422">                    .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L423">                    .start();</span>

<span class="nc" id="L425">            assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;resultVar&quot;))</span>
<span class="nc" id="L426">                    .isEqualTo(&quot;executed&quot;);</span>

        } finally {
<span class="nc" id="L429">            deleteAllDmnDeployments();</span>
        }
<span class="nc" id="L431">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTaskSameDeploymentFalse.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.dmn&quot;
    })
    public void testDecisionTaskExecutionWithSameDeploymentFalse() {
<span class="nc" id="L439">        CmmnRuntimeService cmmnRuntimeService = cmmnRule.getCmmnRuntimeService();</span>
<span class="nc" id="L440">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L441">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L442">                .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L443">                .start();</span>

<span class="nc" id="L445">        assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;resultVar&quot;))</span>
<span class="nc" id="L446">                .isEqualTo(&quot;executed&quot;);</span>

        try {
            // Latest decision should be used
<span class="nc" id="L450">            DmnEngines.getDefaultDmnEngine()</span>
<span class="nc" id="L451">                    .getDmnRepositoryService()</span>
<span class="nc" id="L452">                    .createDeployment()</span>
<span class="nc" id="L453">                    .addClasspathResource(&quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTaskV2.dmn&quot;)</span>
<span class="nc" id="L454">                    .deploy();</span>

<span class="nc" id="L456">            caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L457">                    .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L458">                    .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L459">                    .start();</span>

<span class="nc" id="L461">            assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;resultVar&quot;))</span>
<span class="nc" id="L462">                    .isEqualTo(&quot;executedV2&quot;);</span>

        } finally {
<span class="nc" id="L465">            deleteAllDmnDeployments();</span>
        }
<span class="nc" id="L467">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTaskSameDeploymentFalse.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.dmn&quot;
    }, tenantId = &quot;flowable&quot;)
    public void testDecisionTaskExecutionWithSameDeploymentFalseInTenant() {
<span class="nc" id="L475">        CmmnRuntimeService cmmnRuntimeService = cmmnRule.getCmmnRuntimeService();</span>
<span class="nc" id="L476">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L477">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L478">                .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L479">                .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L480">                .start();</span>

<span class="nc" id="L482">        assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;resultVar&quot;))</span>
<span class="nc" id="L483">                .isEqualTo(&quot;executed&quot;);</span>

        try {
            // Latest decision should be used
<span class="nc" id="L487">            DmnEngines.getDefaultDmnEngine()</span>
<span class="nc" id="L488">                    .getDmnRepositoryService()</span>
<span class="nc" id="L489">                    .createDeployment()</span>
<span class="nc" id="L490">                    .addClasspathResource(&quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTaskV2.dmn&quot;)</span>
<span class="nc" id="L491">                    .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L492">                    .deploy();</span>

<span class="nc" id="L494">            caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L495">                    .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L496">                    .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L497">                    .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L498">                    .start();</span>

<span class="nc" id="L500">            assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;resultVar&quot;))</span>
<span class="nc" id="L501">                    .isEqualTo(&quot;executedV2&quot;);</span>

        } finally {
<span class="nc" id="L504">            deleteAllDmnDeployments();</span>
        }
<span class="nc" id="L506">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.oneDecisionTaskCase.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.outputOrder.dmn&quot;})
    public void withOutputOrder_ensureListOfItemIsReturnedEvenIfOnlyOneRowIsHit() {
<span class="nc" id="L513">        CaseInstance caseInstance = this.cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L514">                .caseDefinitionKey(&quot;oneDecisionTaskCase&quot;)</span>
<span class="nc" id="L515">                .variable(&quot;testInput&quot;, &quot;second&quot;)</span>
<span class="nc" id="L516">                .start();</span>
<span class="nc" id="L517">        Map&lt;String, Object&gt; caseVariables = caseInstance.getCaseVariables();</span>
<span class="nc" id="L518">        Object resultObject = caseVariables.get(&quot;DecisionTable&quot;);</span>
<span class="nc" id="L519">        assertThat(resultObject).isInstanceOf(ArrayNode.class);</span>
<span class="nc" id="L520">        ArrayNode result = (ArrayNode) resultObject;</span>
<span class="nc" id="L521">        assertThat(result).hasSize(1);</span>
<span class="nc" id="L522">        assertThat(result.get(0)).isInstanceOf(ObjectNode.class);</span>
<span class="nc" id="L523">        assertThat(result.get(0).get(&quot;testOutput&quot;)).isInstanceOf(DoubleNode.class);</span>
<span class="nc" id="L524">        assertThat(result.get(0).get(&quot;testOutput&quot;).asDouble()).isEqualTo(2.0);</span>
<span class="nc" id="L525">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.oneDecisionTaskCase.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.ruleOrder.dmn&quot;})
    public void withRuleOrder_ensureListOfItemIsReturnedEvenIfOnlyOneRowIsHit() {
<span class="nc" id="L532">        CaseInstance caseInstance = this.cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L533">                .caseDefinitionKey(&quot;oneDecisionTaskCase&quot;)</span>
<span class="nc" id="L534">                .variable(&quot;testInput&quot;, &quot;second&quot;)</span>
<span class="nc" id="L535">                .start();</span>
<span class="nc" id="L536">        Map&lt;String, Object&gt; caseVariables = caseInstance.getCaseVariables();</span>
<span class="nc" id="L537">        Object resultObject = caseVariables.get(&quot;DecisionTable&quot;);</span>
<span class="nc" id="L538">        assertThat(resultObject).isInstanceOf(ArrayNode.class);</span>
<span class="nc" id="L539">        ArrayNode result = (ArrayNode) resultObject;</span>
<span class="nc" id="L540">        assertThat(result).hasSize(1);</span>
<span class="nc" id="L541">        assertThat(result.get(0)).isInstanceOf(ObjectNode.class);</span>
<span class="nc" id="L542">        assertThat(result.get(0).get(&quot;testOutput&quot;)).isInstanceOf(DoubleNode.class);</span>
<span class="nc" id="L543">        assertThat(result.get(0).get(&quot;testOutput&quot;).asDouble()).isEqualTo(2.0);</span>
<span class="nc" id="L544">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.oneDecisionTaskCase.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.ruleOrder.dmn&quot;})
    public void withRuleOrderAndBackwardCompatibilityFlag_ensureListOfItemIsReturnedEvenIfOnlyOneRowIsHit() {
<span class="nc" id="L551">        this.cmmnRule.getCmmnEngineConfiguration().setAlwaysUseArraysForDmnMultiHitPolicies(false);</span>
<span class="nc" id="L552">        CaseInstance caseInstance = this.cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L553">                .caseDefinitionKey(&quot;oneDecisionTaskCase&quot;)</span>
<span class="nc" id="L554">                .variable(&quot;testInput&quot;, &quot;second&quot;)</span>
<span class="nc" id="L555">                .start();</span>
<span class="nc" id="L556">        Map&lt;String, Object&gt; caseVariables = caseInstance.getCaseVariables();</span>
<span class="nc" id="L557">        Object resultObject = caseVariables.get(&quot;DecisionTable&quot;);</span>
<span class="nc" id="L558">        assertThat(resultObject).isNull();</span>
<span class="nc" id="L559">        assertThat(caseVariables).containsEntry(&quot;testOutput&quot;, 2.0);</span>
<span class="nc" id="L560">        this.cmmnRule.getCmmnEngineConfiguration().setAlwaysUseArraysForDmnMultiHitPolicies(true);</span>
<span class="nc" id="L561">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.oneDecisionTaskCase.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.ruleOrder.dmn&quot;})
    public void withRuleOrder_ensureListOfItemIsReturnedEvenIfNoRowIsHit() {
<span class="nc" id="L568">        CaseInstance caseInstance = this.cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L569">                .caseDefinitionKey(&quot;oneDecisionTaskCase&quot;)</span>
<span class="nc" id="L570">                .variable(&quot;testInput&quot;, &quot;fourth&quot;)</span>
<span class="nc" id="L571">                .start();</span>
<span class="nc" id="L572">        Map&lt;String, Object&gt; caseVariables = caseInstance.getCaseVariables();</span>
<span class="nc" id="L573">        Object resultObject = caseVariables.get(&quot;DecisionTable&quot;);</span>
<span class="nc" id="L574">        assertThat(resultObject).isInstanceOf(ArrayNode.class);</span>
<span class="nc" id="L575">        ArrayNode result = (ArrayNode) resultObject;</span>
<span class="nc" id="L576">        assertThat(result).isEmpty();</span>
<span class="nc" id="L577">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.oneDecisionTaskCase.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.ruleOrder.dmn&quot;})
    public void withCustomDecisionTableManager_ensureDecisionTableManagerIsCalled() {
<span class="nc" id="L584">        CmmnEngineConfiguration cmmnEngineConfiguration = this.cmmnRule.getCmmnEngineConfiguration();</span>
<span class="nc" id="L585">        DecisionTableVariableManager originalDecisionTableVariableManager = cmmnEngineConfiguration.getDecisionTableVariableManager();</span>
<span class="nc" id="L586">        final boolean[] setVariableOnPlanItemCalled = {false};</span>
<span class="nc" id="L587">        cmmnEngineConfiguration.setDecisionTableVariableManager(new DecisionTableVariableManager() {</span>
            @Override
            public void setVariablesOnPlanItemInstance(List&lt;Map&lt;String, Object&gt;&gt; decisionResult, String externalRef, PlanItemInstance planItemInstance, ObjectMapper objectMapper, boolean multipleResults) {
<span class="nc" id="L590">                setVariableOnPlanItemCalled[0] = true;</span>
<span class="nc" id="L591">            }</span>

            @Override
            public void setDecisionServiceVariablesOnPlanItemInstance(Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; executionResult, String decisionKey,
                    PlanItemInstance planItemInstance, ObjectMapper objectMapper, boolean multipleResults) {

<span class="nc" id="L597">            }</span>
        });
<span class="nc" id="L599">        this.cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L600">                .caseDefinitionKey(&quot;oneDecisionTaskCase&quot;)</span>
<span class="nc" id="L601">                .variable(&quot;testInput&quot;, &quot;second&quot;)</span>
<span class="nc" id="L602">                .start();</span>
<span class="nc" id="L603">        assertThat(setVariableOnPlanItemCalled[0]).isTrue();</span>
<span class="nc" id="L604">        cmmnEngineConfiguration.setDecisionTableVariableManager(originalDecisionTableVariableManager);</span>
<span class="nc" id="L605">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.oneDecisionTaskCase.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.ruleOrder.dmn&quot;})
    public void withCustomDecisionTableManagerAndWithOldMethodMethod_ensureDecisionTableManagerIsCalled() {
<span class="nc" id="L612">        CmmnEngineConfiguration cmmnEngineConfiguration = this.cmmnRule.getCmmnEngineConfiguration();</span>
<span class="nc" id="L613">        DecisionTableVariableManager originalDecisionTableVariableManager = cmmnEngineConfiguration.getDecisionTableVariableManager();</span>
<span class="nc" id="L614">        final boolean[] setVariableOnPlanItemCalled = {false};</span>
<span class="nc" id="L615">        cmmnEngineConfiguration.setDecisionTableVariableManager(new DecisionTableVariableManager() {</span>

            @Override
            public void setVariablesOnPlanItemInstance(List&lt;Map&lt;String, Object&gt;&gt; decisionResult, String externalRef, PlanItemInstance planItemInstance,
                    ObjectMapper objectMapper, boolean multipleResults) {
<span class="nc" id="L620">                setVariableOnPlanItemCalled[0] = true;</span>
<span class="nc" id="L621">            }</span>

            @Override
            public void setDecisionServiceVariablesOnPlanItemInstance(Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; executionResult, String decisionKey,
                    PlanItemInstance planItemInstance, ObjectMapper objectMapper, boolean multipleResults) {

<span class="nc" id="L627">            }</span>
        });
<span class="nc" id="L629">        this.cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L630">                .caseDefinitionKey(&quot;oneDecisionTaskCase&quot;)</span>
<span class="nc" id="L631">                .variable(&quot;testInput&quot;, &quot;second&quot;)</span>
<span class="nc" id="L632">                .start();</span>
<span class="nc" id="L633">        assertThat(setVariableOnPlanItemCalled[0]).isTrue();</span>
<span class="nc" id="L634">        cmmnEngineConfiguration.setDecisionTableVariableManager(originalDecisionTableVariableManager);</span>
<span class="nc" id="L635">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.oneDecisionServiceTaskCase.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.multipleResults.dmn&quot;
    })
    public void withCustomDecisionTableManagerAndOldDecisionService_ensureDecisionTableManagerIsCalled() {
<span class="nc" id="L643">        DecisionTableVariableManager originalDecisionTableVariableManager = cmmnRule.getCmmnEngineConfiguration().getDecisionTableVariableManager();</span>
<span class="nc" id="L644">        final boolean[] setCalled = {false};</span>
<span class="nc" id="L645">        cmmnRule.getCmmnEngineConfiguration().setDecisionTableVariableManager(new DecisionTableVariableManager() {</span>

            @Override
            public void setVariablesOnPlanItemInstance(List&lt;Map&lt;String, Object&gt;&gt; decisionResult, String externalRef, PlanItemInstance planItemInstance,
                    ObjectMapper objectMapper, boolean multipleResults) {

<span class="nc" id="L651">            }</span>

            @Override
            public void setDecisionServiceVariablesOnPlanItemInstance(Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; executionResult, String decisionKey,
                    PlanItemInstance planItemInstance, ObjectMapper objectMapper, boolean multipleResults) {
<span class="nc" id="L656">                setCalled[0] = true;</span>
<span class="nc" id="L657">            }</span>
        });
<span class="nc" id="L659">        this.cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L660">                .caseDefinitionKey(&quot;oneDecisionTaskCase&quot;)</span>
<span class="nc" id="L661">                .variable(&quot;a&quot;, &quot;1&quot;)</span>
<span class="nc" id="L662">                .variable(&quot;b&quot;, &quot;1&quot;)</span>
<span class="nc" id="L663">                .variable(&quot;c&quot;, &quot;1&quot;)</span>
<span class="nc" id="L664">                .start();</span>
<span class="nc" id="L665">        assertThat(setCalled[0]).isTrue();</span>
<span class="nc" id="L666">        cmmnRule.getCmmnEngineConfiguration().setDecisionTableVariableManager(originalDecisionTableVariableManager);</span>
<span class="nc" id="L667">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.oneDecisionServiceTaskCase.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.multipleResults.dmn&quot;
    })
    public void withCustomDecisionTableManagerAndNewDecisionService_ensureDecisionTableManagerIsCalledAndMultipleResultsIsTrue() {
<span class="nc" id="L675">        DecisionTableVariableManager originalDecisionTableVariableManager = cmmnRule.getCmmnEngineConfiguration().getDecisionTableVariableManager();</span>
<span class="nc" id="L676">        final boolean[] setCalled = {false};</span>
<span class="nc" id="L677">        cmmnRule.getCmmnEngineConfiguration().setDecisionTableVariableManager(new DecisionTableVariableManager() {</span>

            @Override
            public void setVariablesOnPlanItemInstance(List&lt;Map&lt;String, Object&gt;&gt; decisionResult, String externalRef, PlanItemInstance planItemInstance,
                    ObjectMapper objectMapper, boolean multipleResults) {

<span class="nc" id="L683">            }</span>

            @Override
            public void setDecisionServiceVariablesOnPlanItemInstance(Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; executionResult, String decisionKey,
                    PlanItemInstance planItemInstance, ObjectMapper objectMapper, boolean multipleResults) {
<span class="nc" id="L688">                setCalled[0] = true;</span>
<span class="nc" id="L689">                assertThat(multipleResults).isTrue();</span>
<span class="nc" id="L690">            }</span>
        });
<span class="nc" id="L692">        this.cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L693">                .caseDefinitionKey(&quot;oneDecisionTaskCase&quot;)</span>
<span class="nc" id="L694">                .variable(&quot;a&quot;, &quot;1&quot;)</span>
<span class="nc" id="L695">                .variable(&quot;b&quot;, &quot;1&quot;)</span>
<span class="nc" id="L696">                .variable(&quot;c&quot;, &quot;1&quot;)</span>
<span class="nc" id="L697">                .start();</span>
<span class="nc" id="L698">        assertThat(setCalled[0]).isTrue();</span>
<span class="nc" id="L699">        cmmnRule.getCmmnEngineConfiguration().setDecisionTableVariableManager(originalDecisionTableVariableManager);</span>
<span class="nc" id="L700">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.oneDecisionServiceTaskCase.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.singleResult.dmn&quot;
    })
    public void withCustomDecisionTableManagerAndNewDecisionServiceOneResult_ensureDecisionTableManagerIsCalledAndMultipleResultsIsFalse() {
<span class="nc" id="L708">        DecisionTableVariableManager originalDecisionTableVariableManager = cmmnRule.getCmmnEngineConfiguration().getDecisionTableVariableManager();</span>
<span class="nc" id="L709">        final boolean[] setCalled = {false};</span>
<span class="nc" id="L710">        cmmnRule.getCmmnEngineConfiguration().setDecisionTableVariableManager(new DecisionTableVariableManager() {</span>

            @Override
            public void setVariablesOnPlanItemInstance(List&lt;Map&lt;String, Object&gt;&gt; decisionResult, String externalRef, PlanItemInstance planItemInstance,
                    ObjectMapper objectMapper, boolean multipleResults) {
<span class="nc" id="L715">            }</span>

            @Override
            public void setDecisionServiceVariablesOnPlanItemInstance(Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; executionResult, String decisionKey,
                    PlanItemInstance planItemInstance, ObjectMapper objectMapper, boolean multipleResults) {
<span class="nc" id="L720">                setCalled[0] = true;</span>
<span class="nc" id="L721">                assertThat(multipleResults).isFalse();</span>
<span class="nc" id="L722">            }</span>
        });
<span class="nc" id="L724">        this.cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L725">                .caseDefinitionKey(&quot;oneDecisionTaskCase&quot;)</span>
<span class="nc" id="L726">                .variable(&quot;a&quot;, &quot;1&quot;)</span>
<span class="nc" id="L727">                .variable(&quot;b&quot;, &quot;1&quot;)</span>
<span class="nc" id="L728">                .variable(&quot;c&quot;, &quot;1&quot;)</span>
<span class="nc" id="L729">                .start();</span>
<span class="nc" id="L730">        assertThat(setCalled[0]).isTrue();</span>
<span class="nc" id="L731">        cmmnRule.getCmmnEngineConfiguration().setDecisionTableVariableManager(originalDecisionTableVariableManager);</span>
<span class="nc" id="L732">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.oneDecisionServiceTaskCase.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.multipleTablesAsResult.dmn&quot;
    })
    public void withCustomDecisionTableManagerAndNewDecisionServiceMultipleResultTables_ensureDecisionTableManagerIsCalledAndMultipleResultsIsTrue() {
<span class="nc" id="L740">        DecisionTableVariableManager originalDecisionTableVariableManager = cmmnRule.getCmmnEngineConfiguration().getDecisionTableVariableManager();</span>
<span class="nc" id="L741">        final boolean[] setCalled = {false};</span>
<span class="nc" id="L742">        cmmnRule.getCmmnEngineConfiguration().setDecisionTableVariableManager(new DecisionTableVariableManager() {</span>

            @Override
            public void setVariablesOnPlanItemInstance(List&lt;Map&lt;String, Object&gt;&gt; decisionResult, String externalRef, PlanItemInstance planItemInstance,
                    ObjectMapper objectMapper, boolean multipleResults) {
<span class="nc" id="L747">            }</span>

            @Override
            public void setDecisionServiceVariablesOnPlanItemInstance(Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; executionResult, String decisionKey,
                    PlanItemInstance planItemInstance, ObjectMapper objectMapper, boolean multipleResults) {
<span class="nc" id="L752">                setCalled[0] = true;</span>
<span class="nc" id="L753">                assertThat(multipleResults).isTrue();</span>
<span class="nc" id="L754">            }</span>
        });
<span class="nc" id="L756">        this.cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L757">                .caseDefinitionKey(&quot;oneDecisionTaskCase&quot;)</span>
<span class="nc" id="L758">                .variable(&quot;a&quot;, &quot;1&quot;)</span>
<span class="nc" id="L759">                .variable(&quot;b&quot;, &quot;1&quot;)</span>
<span class="nc" id="L760">                .variable(&quot;c&quot;, &quot;1&quot;)</span>
<span class="nc" id="L761">                .start();</span>
<span class="nc" id="L762">        assertThat(setCalled[0]).isTrue();</span>
<span class="nc" id="L763">        cmmnRule.getCmmnEngineConfiguration().setDecisionTableVariableManager(originalDecisionTableVariableManager);</span>
<span class="nc" id="L764">    }</span>


    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.oneDecisionServiceTaskCase.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.multipleResults.dmn&quot;
    })
    public void withMultipleResultsAndOneTable_ensureDecisionTableIsAList() {
<span class="nc" id="L773">        Map&lt;String, Object&gt; processVariables = this.cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L774">                .caseDefinitionKey(&quot;oneDecisionTaskCase&quot;)</span>
<span class="nc" id="L775">                .variable(&quot;a&quot;, &quot;1&quot;)</span>
<span class="nc" id="L776">                .variable(&quot;b&quot;, &quot;1&quot;)</span>
<span class="nc" id="L777">                .variable(&quot;c&quot;, &quot;1&quot;)</span>
<span class="nc" id="L778">                .start()</span>
<span class="nc" id="L779">                .getCaseVariables();</span>
<span class="nc" id="L780">        Object result = processVariables.get(&quot;decisionServiceTest&quot;);</span>

<span class="nc" id="L782">        assertThat(result).isInstanceOf(ObjectNode.class);</span>
<span class="nc" id="L783">        ObjectNode resultNode = (ObjectNode) result;</span>
<span class="nc" id="L784">        JsonNode decisionResult = resultNode.get(&quot;decision3&quot;);</span>
<span class="nc" id="L785">        assertThat(decisionResult).isInstanceOf(ArrayNode.class);</span>
<span class="nc" id="L786">        assertThat(decisionResult.size()).isEqualTo(4);</span>
<span class="nc" id="L787">        assertThat(decisionResult.get(0).get(&quot;g&quot;).asText()).isEqualTo(&quot;1000&quot;);</span>
<span class="nc" id="L788">        assertThat(decisionResult.get(1).get(&quot;g&quot;).asText()).isEqualTo(&quot;100&quot;);</span>
<span class="nc" id="L789">        assertThat(decisionResult.get(2).get(&quot;g&quot;).asText()).isEqualTo(&quot;10&quot;);</span>
<span class="nc" id="L790">        assertThat(decisionResult.get(3).get(&quot;g&quot;).asText()).isEqualTo(&quot;1&quot;);</span>
<span class="nc" id="L791">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.oneDecisionServiceTaskCase.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.multipleResults.dmn&quot;
    })
    public void withMultipleResultButOnlyOneMatchesAndOneTable_ensureDecisionTableIsAList() {
<span class="nc" id="L799">        Map&lt;String, Object&gt; processVariables = this.cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L800">                .caseDefinitionKey(&quot;oneDecisionTaskCase&quot;)</span>
<span class="nc" id="L801">                .variable(&quot;a&quot;, &quot;100&quot;)</span>
<span class="nc" id="L802">                .variable(&quot;b&quot;, &quot;100&quot;)</span>
<span class="nc" id="L803">                .variable(&quot;c&quot;, &quot;100&quot;)</span>
<span class="nc" id="L804">                .start()</span>
<span class="nc" id="L805">                .getCaseVariables();</span>
<span class="nc" id="L806">        Object result = processVariables.get(&quot;decisionServiceTest&quot;);</span>

<span class="nc" id="L808">        assertThat(result).isInstanceOf(ObjectNode.class);</span>
<span class="nc" id="L809">        ObjectNode resultNode = (ObjectNode) result;</span>
<span class="nc" id="L810">        JsonNode decisionResult = resultNode.get(&quot;decision3&quot;);</span>
<span class="nc" id="L811">        assertThat(decisionResult).isInstanceOf(ArrayNode.class);</span>
<span class="nc" id="L812">        assertThat(decisionResult.size()).isEqualTo(1);</span>
<span class="nc" id="L813">        assertThat(decisionResult.get(0).get(&quot;g&quot;).asText()).isEqualTo(&quot;1&quot;);</span>
<span class="nc" id="L814">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.oneDecisionServiceTaskCase.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.singleResult.dmn&quot;
    })
    public void withSingleResult_ensureDecisionTableIsAString() {
<span class="nc" id="L822">        Map&lt;String, Object&gt; processVariables = this.cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L823">                .caseDefinitionKey(&quot;oneDecisionTaskCase&quot;)</span>
<span class="nc" id="L824">                .variable(&quot;a&quot;, &quot;1&quot;)</span>
<span class="nc" id="L825">                .variable(&quot;b&quot;, &quot;1&quot;)</span>
<span class="nc" id="L826">                .variable(&quot;c&quot;, &quot;1&quot;)</span>
<span class="nc" id="L827">                .start()</span>
<span class="nc" id="L828">                .getCaseVariables();</span>
<span class="nc" id="L829">        Object result = processVariables.get(&quot;g&quot;);</span>

<span class="nc" id="L831">        assertThat(result).isEqualTo(&quot;1000&quot;);</span>
<span class="nc" id="L832">    }</span>

    // Helper methods

    protected void deployDmnTableAssertCaseStarted() {
<span class="nc" id="L837">        org.flowable.cmmn.api.repository.CmmnDeployment cmmnDeployment = cmmnRule.getCmmnRepositoryService().createDeployment().</span>
<span class="nc" id="L838">            addClasspathResource(&quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.dmn&quot;).</span>
<span class="nc" id="L839">            tenantId(CmmnEngineConfiguration.NO_TENANT_ID).</span>
<span class="nc" id="L840">            deploy();</span>

        try {
<span class="nc" id="L843">            CaseInstance caseInstance = cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L844">                    .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L845">                    .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L846">                    .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L847">                    .start();</span>

<span class="nc" id="L849">            assertResultVariable(caseInstance);</span>

<span class="nc" id="L851">            CmmnEngineConfiguration cmmnEngineConfiguration = cmmnRule.getCmmnEngineConfiguration();</span>
<span class="nc" id="L852">            DmnEngineConfiguration dmnEngineConfiguration = (DmnEngineConfiguration) cmmnEngineConfiguration.getEngineConfigurations().get(</span>
                    EngineConfigurationConstants.KEY_DMN_ENGINE_CONFIG);

<span class="nc" id="L855">            DmnHistoricDecisionExecution decisionExecution = dmnEngineConfiguration.getDmnHistoryService()</span>
<span class="nc" id="L856">                    .createHistoricDecisionExecutionQuery()</span>
<span class="nc" id="L857">                    .instanceId(caseInstance.getId())</span>
<span class="nc" id="L858">                    .singleResult();</span>

<span class="nc" id="L860">            assertThat(decisionExecution).isNotNull();</span>
<span class="nc" id="L861">            assertThat(decisionExecution.getTenantId()).isEqualTo(&quot;flowable&quot;);</span>

        } finally {
<span class="nc" id="L864">            cmmnRule.getCmmnRepositoryService().deleteDeployment(cmmnDeployment.getId(), true);</span>
        }
<span class="nc" id="L866">    }</span>
    
    protected void deployDmnTableWithGlobalTenantFallback(String tenantId) {
<span class="nc" id="L869">        CmmnEngineConfiguration cmmnEngineConfiguration = cmmnRule.getCmmnEngineConfiguration();</span>
<span class="nc" id="L870">        DmnEngineConfiguration dmnEngineConfiguration = (DmnEngineConfiguration) cmmnEngineConfiguration.getEngineConfigurations().get(</span>
                        EngineConfigurationConstants.KEY_DMN_ENGINE_CONFIG);
        
<span class="nc" id="L873">        DefaultTenantProvider originalDefaultTenantProvider = dmnEngineConfiguration.getDefaultTenantProvider();</span>
<span class="nc" id="L874">        dmnEngineConfiguration.setFallbackToDefaultTenant(true);</span>
<span class="nc" id="L875">        dmnEngineConfiguration.setDefaultTenantValue(&quot;defaultFlowable&quot;);</span>
        
<span class="nc" id="L877">        org.flowable.cmmn.api.repository.CmmnDeployment cmmnDeployment = cmmnRule.getCmmnRepositoryService().createDeployment().</span>
<span class="nc" id="L878">            addClasspathResource(&quot;org/flowable/cmmn/test/runtime/DecisionTaskTest.testDecisionServiceTask.dmn&quot;).</span>
<span class="nc" id="L879">            tenantId(tenantId).</span>
<span class="nc" id="L880">            deploy();</span>

        try {
<span class="nc" id="L883">            CaseInstance caseInstance = cmmnRule.getCmmnRuntimeService().createCaseInstanceBuilder()</span>
<span class="nc" id="L884">                    .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L885">                    .variable(&quot;testVar&quot;, &quot;test2&quot;)</span>
<span class="nc" id="L886">                    .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L887">                    .start();</span>

<span class="nc" id="L889">            assertResultVariable(caseInstance);</span>

<span class="nc" id="L891">            DmnHistoricDecisionExecution decisionExecution = dmnEngineConfiguration.getDmnHistoryService()</span>
<span class="nc" id="L892">                    .createHistoricDecisionExecutionQuery()</span>
<span class="nc" id="L893">                    .instanceId(caseInstance.getId())</span>
<span class="nc" id="L894">                    .singleResult();</span>

<span class="nc" id="L896">            assertThat(decisionExecution).isNotNull();</span>
<span class="nc" id="L897">            assertThat(decisionExecution.getTenantId()).isEqualTo(&quot;flowable&quot;);</span>

        } finally {
<span class="nc" id="L900">            dmnEngineConfiguration.setFallbackToDefaultTenant(false);</span>
<span class="nc" id="L901">            dmnEngineConfiguration.setDefaultTenantProvider(originalDefaultTenantProvider);</span>
<span class="nc" id="L902">            cmmnRule.getCmmnRepositoryService().deleteDeployment(cmmnDeployment.getId(), true);</span>
        }
<span class="nc" id="L904">    }</span>

    protected void assertResultVariable(CaseInstance caseInstance) {
<span class="nc" id="L907">        assertThat(caseInstance).isNotNull();</span>

<span class="nc" id="L909">        PlanItemInstance planItemInstance = cmmnRule.getCmmnRuntimeService().createPlanItemInstanceQuery()</span>
<span class="nc" id="L910">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L911">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L912">                .singleResult();</span>
<span class="nc" id="L913">        assertThat(planItemInstance).isNotNull();</span>

<span class="nc" id="L915">        assertThat(cmmnRule.getCmmnRuntimeService().getVariable(caseInstance.getId(), &quot;resultVar&quot;)).isEqualTo(&quot;executed&quot;);</span>

        // Triggering the task should end the case instance
<span class="nc" id="L918">        cmmnRule.getCmmnRuntimeService().triggerPlanItemInstance(planItemInstance.getId());</span>
<span class="nc" id="L919">        assertThat(cmmnRule.getCmmnRuntimeService().createCaseInstanceQuery().count()).isZero();</span>

<span class="nc" id="L921">        assertThat(cmmnRule.getCmmnHistoryService().createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L922">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L923">                .variableName(&quot;resultVar&quot;)</span>
<span class="nc" id="L924">                .singleResult().getValue()).isEqualTo(&quot;executed&quot;);</span>
<span class="nc" id="L925">    }</span>

    protected void assertNoResultVariable(CaseInstance caseInstance) {
<span class="nc" id="L928">        assertThat(caseInstance).isNotNull();</span>

<span class="nc" id="L930">        PlanItemInstance planItemInstance = cmmnRule.getCmmnRuntimeService().createPlanItemInstanceQuery()</span>
<span class="nc" id="L931">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L932">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L933">                .singleResult();</span>
<span class="nc" id="L934">        assertThat(planItemInstance).isNotNull();</span>

<span class="nc" id="L936">        assertThat(cmmnRule.getCmmnRuntimeService().getVariable(caseInstance.getId(), &quot;resultVar&quot;)).isNull();</span>

        // Triggering the task should end the case instance
<span class="nc" id="L939">        cmmnRule.getCmmnRuntimeService().triggerPlanItemInstance(planItemInstance.getId());</span>
<span class="nc" id="L940">        assertThat(cmmnRule.getCmmnRuntimeService().createCaseInstanceQuery().count()).isZero();</span>
<span class="nc" id="L941">    }</span>

    protected void deleteAllDmnDeployments() {
<span class="nc" id="L944">        DmnEngineConfiguration dmnEngineConfiguration = (DmnEngineConfiguration) cmmnRule.getCmmnEngine()</span>
<span class="nc" id="L945">                .getCmmnEngineConfiguration()</span>
<span class="nc" id="L946">                .getEngineConfigurations()</span>
<span class="nc" id="L947">                .get(EngineConfigurationConstants.KEY_DMN_ENGINE_CONFIG);</span>
<span class="nc" id="L948">        dmnEngineConfiguration.getDmnRepositoryService().createDeploymentQuery().list().stream()</span>
<span class="nc" id="L949">                .forEach(</span>
<span class="nc" id="L950">                        deployment -&gt; dmnEngineConfiguration.getDmnRepositoryService().deleteDeployment(deployment.getId())</span>
                );
<span class="nc" id="L952">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>