<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DurationHelperTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.standalone.calendar</a> &gt; <span class="el_source">DurationHelperTest.java</span></div><h1>DurationHelperTest.java</h1><pre class="source lang-java linenums">/*
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.standalone.calendar;

import static org.assertj.core.api.Assertions.assertThat;

import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.TimeZone;

import org.apache.commons.lang3.time.DateUtils;
import org.flowable.common.engine.impl.calendar.DurationHelper;
import org.flowable.common.engine.impl.runtime.Clock;
import org.flowable.common.engine.impl.util.DefaultClockImpl;
import org.junit.jupiter.api.Test;

<span class="nc" id="L31">public class DurationHelperTest {</span>

    @Test
    public void shouldNotExceedNumber() throws Exception {
<span class="nc" id="L35">        Clock testingClock = new DefaultClockImpl();</span>
<span class="nc" id="L36">        testingClock.setCurrentTime(new Date(0));</span>
<span class="nc" id="L37">        DurationHelper dh = new DurationHelper(&quot;R2/PT10S&quot;, testingClock);</span>

<span class="nc" id="L39">        testingClock.setCurrentTime(new Date(15000));</span>
<span class="nc" id="L40">        assertThat(dh.getDateAfter().getTime()).isEqualTo(20000);</span>

<span class="nc" id="L42">        testingClock.setCurrentTime(new Date(30000));</span>
<span class="nc" id="L43">        assertThat(dh.getDateAfter().getTime()).isEqualTo(30000);</span>
<span class="nc" id="L44">    }</span>

    @Test
    public void shouldNotExceedNumberPeriods() throws Exception {
<span class="nc" id="L48">        Clock testingClock = new DefaultClockImpl();</span>
<span class="nc" id="L49">        testingClock.setCurrentTime(parse(&quot;19700101-00:00:00&quot;));</span>
<span class="nc" id="L50">        DurationHelper dh = new DurationHelper(&quot;R2/1970-01-01T00:00:00/1970-01-01T00:00:10&quot;, testingClock);</span>

<span class="nc" id="L52">        testingClock.setCurrentTime(parse(&quot;19700101-00:00:15&quot;));</span>
<span class="nc" id="L53">        assertThat(dh.getDateAfter()).isEqualTo(parse(&quot;19700101-00:00:20&quot;));</span>

<span class="nc" id="L55">        testingClock.setCurrentTime(parse(&quot;19700101-00:00:30&quot;));</span>
<span class="nc" id="L56">        assertThat(dh.getDateAfter()).isEqualTo(parse(&quot;19700101-00:00:30&quot;));</span>
<span class="nc" id="L57">    }</span>

    @Test
    public void shouldNotExceedNumberNegative() throws Exception {
<span class="nc" id="L61">        Clock testingClock = new DefaultClockImpl();</span>
<span class="nc" id="L62">        testingClock.setCurrentTime(parse(&quot;19700101-00:00:00&quot;));</span>
<span class="nc" id="L63">        DurationHelper dh = new DurationHelper(&quot;R2/PT10S/1970-01-01T00:00:50&quot;, testingClock);</span>

<span class="nc" id="L65">        testingClock.setCurrentTime(parse(&quot;19700101-00:00:20&quot;));</span>
<span class="nc" id="L66">        assertThat(dh.getDateAfter()).isEqualTo(parse(&quot;19700101-00:00:30&quot;));</span>

<span class="nc" id="L68">        testingClock.setCurrentTime(parse(&quot;19700101-00:00:35&quot;));</span>

<span class="nc" id="L70">        assertThat(dh.getDateAfter()).isEqualTo(parse(&quot;19700101-00:00:35&quot;));</span>
<span class="nc" id="L71">    }</span>

    @Test
    public void daylightSavingFall() throws Exception {
<span class="nc" id="L75">        Clock testingClock = new DefaultClockImpl();</span>
<span class="nc" id="L76">        testingClock.setCurrentCalendar(parseCalendar(&quot;20131103-04:45:00&quot;, TimeZone.getTimeZone(&quot;UTC&quot;)));</span>

<span class="nc" id="L78">        DurationHelper dh = new DurationHelper(&quot;R2/2013-11-03T00:45:00-04:00/PT1H&quot;, testingClock);</span>

<span class="nc" id="L80">        assertThat(dh.getCalendarAfter(testingClock.getCurrentCalendar(TimeZone.getTimeZone(&quot;US/Eastern&quot;))))</span>
<span class="nc" id="L81">                .isEqualTo(parseCalendar(&quot;20131103-05:45:00&quot;, TimeZone.getTimeZone(&quot;UTC&quot;)));</span>

<span class="nc" id="L83">        testingClock.setCurrentCalendar(parseCalendar(&quot;20131103-05:45:00&quot;, TimeZone.getTimeZone(&quot;UTC&quot;)));</span>

<span class="nc" id="L85">        assertThat(dh.getCalendarAfter(testingClock.getCurrentCalendar(TimeZone.getTimeZone(&quot;US/Eastern&quot;))))</span>
<span class="nc" id="L86">                .isEqualTo(parseCalendar(&quot;20131103-06:45:00&quot;, TimeZone.getTimeZone(&quot;UTC&quot;)));</span>
<span class="nc" id="L87">    }</span>

    @Test
    public void daylightSavingFallFirstHour() throws Exception {
<span class="nc" id="L91">        Clock testingClock = new DefaultClockImpl();</span>
<span class="nc" id="L92">        testingClock.setCurrentCalendar(parseCalendar(&quot;20131103-05:45:00&quot;, TimeZone.getTimeZone(&quot;UTC&quot;)));</span>
<span class="nc" id="L93">        Calendar easternTime = testingClock.getCurrentCalendar(TimeZone.getTimeZone(&quot;US/Eastern&quot;));</span>

<span class="nc" id="L95">        DurationHelper dh = new DurationHelper(&quot;R2/2013-11-03T01:45:00-04:00/PT1H&quot;, testingClock);</span>

<span class="nc" id="L97">        assertThat(dh.getCalendarAfter(easternTime)).isEqualTo(parseCalendar(&quot;20131103-06:45:00&quot;, TimeZone.getTimeZone(&quot;UTC&quot;)));</span>
<span class="nc" id="L98">    }</span>

    @Test
    public void daylightSavingFallSecondHour() throws Exception {
<span class="nc" id="L102">        Clock testingClock = new DefaultClockImpl();</span>
<span class="nc" id="L103">        testingClock.setCurrentCalendar(parseCalendar(&quot;20131103-06:45:00&quot;, TimeZone.getTimeZone(&quot;UTC&quot;)));</span>
<span class="nc" id="L104">        Calendar easternTime = testingClock.getCurrentCalendar(TimeZone.getTimeZone(&quot;US/Eastern&quot;));</span>

<span class="nc" id="L106">        DurationHelper dh = new DurationHelper(&quot;R2/2013-11-03T01:45:00-05:00/PT1H&quot;, testingClock);</span>

<span class="nc" id="L108">        assertThat(dh.getCalendarAfter(easternTime)).isEqualTo(parseCalendar(&quot;20131103-07:45:00&quot;, TimeZone.getTimeZone(&quot;UTC&quot;)));</span>
<span class="nc" id="L109">    }</span>

    @Test
    public void daylightSavingFallObservedFirstHour() throws Exception {
<span class="nc" id="L113">        Clock testingClock = new DefaultClockImpl();</span>
<span class="nc" id="L114">        testingClock.setCurrentCalendar(parseCalendar(&quot;20131103-00:45:00&quot;, TimeZone.getTimeZone(&quot;US/Eastern&quot;)));</span>

<span class="nc" id="L116">        DurationHelper dh = new DurationHelper(&quot;R2/2013-11-03T00:45:00-04:00/PT1H&quot;, testingClock);</span>
<span class="nc" id="L117">        Calendar expected = parseCalendarWithOffset(&quot;20131103-01:45:00-04:00&quot;, TimeZone.getTimeZone(&quot;US/Eastern&quot;));</span>

<span class="nc" id="L119">        assertThat(expected).isEqualByComparingTo(dh.getCalendarAfter());</span>
<span class="nc" id="L120">    }</span>

    @Test
    public void daylightSavingFallObservedSecondHour() throws Exception {
<span class="nc" id="L124">        Clock testingClock = new DefaultClockImpl();</span>
<span class="nc" id="L125">        testingClock.setCurrentCalendar(parseCalendar(&quot;20131103-00:45:00&quot;, TimeZone.getTimeZone(&quot;US/Eastern&quot;)));</span>

<span class="nc" id="L127">        DurationHelper dh = new DurationHelper(&quot;R2/2013-11-03T00:45:00-04:00/PT2H&quot;, testingClock);</span>
<span class="nc" id="L128">        Calendar expected = parseCalendarWithOffset(&quot;20131103-01:45:00-05:00&quot;, TimeZone.getTimeZone(&quot;US/Eastern&quot;));</span>

<span class="nc" id="L130">        assertThat(expected).isEqualByComparingTo(dh.getCalendarAfter());</span>
<span class="nc" id="L131">    }</span>

    @Test
    public void daylightSavingSpring() throws Exception {
<span class="nc" id="L135">        Clock testingClock = new DefaultClockImpl();</span>
<span class="nc" id="L136">        testingClock.setCurrentCalendar(parseCalendar(&quot;20140309-05:45:00&quot;, TimeZone.getTimeZone(&quot;UTC&quot;)));</span>

<span class="nc" id="L138">        DurationHelper dh = new DurationHelper(&quot;R2/2014-03-09T00:45:00-05:00/PT1H&quot;, testingClock);</span>

<span class="nc" id="L140">        assertThat(dh.getCalendarAfter(testingClock.getCurrentCalendar(TimeZone.getTimeZone(&quot;US/Eastern&quot;))))</span>
<span class="nc" id="L141">                .isEqualTo(parseCalendar(&quot;20140309-06:45:00&quot;, TimeZone.getTimeZone(&quot;UTC&quot;)));</span>
<span class="nc" id="L142">    }</span>

    @Test
    public void daylightSavingSpringObserved() throws Exception {
<span class="nc" id="L146">        Clock testingClock = new DefaultClockImpl();</span>
<span class="nc" id="L147">        testingClock.setCurrentCalendar(parseCalendar(&quot;20140309-01:45:00&quot;, TimeZone.getTimeZone(&quot;US/Eastern&quot;)));</span>

<span class="nc" id="L149">        DurationHelper dh = new DurationHelper(&quot;R2/2014-03-09T01:45:00/PT1H&quot;, testingClock);</span>
<span class="nc" id="L150">        Calendar expected = parseCalendar(&quot;20140309-03:45:00&quot;, TimeZone.getTimeZone(&quot;US/Eastern&quot;));</span>

<span class="nc" id="L152">        assertThat(dh.getCalendarAfter()).isEqualTo(expected);</span>
<span class="nc" id="L153">    }</span>

    @Test
    public void daylightSaving25HourDay() throws Exception {
<span class="nc" id="L157">        Clock testingClock = new DefaultClockImpl();</span>
<span class="nc" id="L158">        testingClock.setCurrentCalendar(parseCalendar(&quot;20131103-00:00:00&quot;, TimeZone.getTimeZone(&quot;US/Eastern&quot;)));</span>

<span class="nc" id="L160">        DurationHelper dh = new DurationHelper(&quot;R2/2013-11-03T00:00:00/P1D&quot;, testingClock);</span>

<span class="nc" id="L162">        assertThat(dh.getCalendarAfter(testingClock.getCurrentCalendar())).isEqualTo(parseCalendar(&quot;20131104-00:00:00&quot;, TimeZone.getTimeZone(&quot;US/Eastern&quot;)));</span>
<span class="nc" id="L163">    }</span>

    @Test
    public void daylightSaving23HourDay() throws Exception {
<span class="nc" id="L167">        Clock testingClock = new DefaultClockImpl();</span>
<span class="nc" id="L168">        testingClock.setCurrentCalendar(parseCalendar(&quot;20140309-00:00:00&quot;, TimeZone.getTimeZone(&quot;US/Eastern&quot;)));</span>

<span class="nc" id="L170">        DurationHelper dh = new DurationHelper(&quot;R2/2014-03-09T00:00:00/P1D&quot;, testingClock);</span>

<span class="nc" id="L172">        assertThat(dh.getCalendarAfter(testingClock.getCurrentCalendar())).isEqualTo(parseCalendar(&quot;20140310-00:00:00&quot;, TimeZone.getTimeZone(&quot;US/Eastern&quot;)));</span>
<span class="nc" id="L173">    }</span>

    @Test
    public void daylightSaving25HourDayEurope() throws Exception {
<span class="nc" id="L177">        Clock testingClock = new DefaultClockImpl();</span>
<span class="nc" id="L178">        testingClock.setCurrentCalendar(parseCalendar(&quot;20131027-00:00:00&quot;, TimeZone.getTimeZone(&quot;Europe/Amsterdam&quot;)));</span>

<span class="nc" id="L180">        DurationHelper dh = new DurationHelper(&quot;R2/2013-10-27T00:00:00/P1D&quot;, testingClock);</span>

<span class="nc" id="L182">        assertThat(dh.getCalendarAfter(testingClock.getCurrentCalendar()))</span>
<span class="nc" id="L183">                .isEqualTo(parseCalendar(&quot;20131028-00:00:00&quot;, TimeZone.getTimeZone(&quot;Europe/Amsterdam&quot;)));</span>
<span class="nc" id="L184">    }</span>

    @Test
    public void daylightSaving23HourDayEurope() throws Exception {
<span class="nc" id="L188">        Clock testingClock = new DefaultClockImpl();</span>
<span class="nc" id="L189">        testingClock.setCurrentCalendar(parseCalendar(&quot;20140330-00:00:00&quot;, TimeZone.getTimeZone(&quot;Europe/Amsterdam&quot;)));</span>

<span class="nc" id="L191">        DurationHelper dh = new DurationHelper(&quot;R2/2014-03-30T00:00:00/P1D&quot;, testingClock);</span>

<span class="nc" id="L193">        assertThat(dh.getCalendarAfter(testingClock.getCurrentCalendar()))</span>
<span class="nc" id="L194">                .isEqualTo(parseCalendar(&quot;20140331-00:00:00&quot;, TimeZone.getTimeZone(&quot;Europe/Amsterdam&quot;)));</span>
<span class="nc" id="L195">    }</span>

    private Date parse(String str) throws Exception {
<span class="nc" id="L198">        SimpleDateFormat simpleDateFormat = new SimpleDateFormat(&quot;yyyyMMdd-HH:mm:ss&quot;);</span>
<span class="nc" id="L199">        return simpleDateFormat.parse(str);</span>
    }

    private Calendar parseCalendarWithOffset(String str, TimeZone timeZone) throws Exception {

<span class="nc" id="L204">        Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L205">        cal.setTime(DateUtils.parseDate(str, &quot;yyyyMMdd-HH:mm:ssZZ&quot;));</span>
<span class="nc" id="L206">        return cal;</span>
    }

    private Calendar parseCalendar(String str, TimeZone timeZone) throws Exception {
<span class="nc" id="L210">        return parseCalendar(str, timeZone, &quot;yyyyMMdd-HH:mm:ss&quot;);</span>
    }

    private Calendar parseCalendar(String str, TimeZone timeZone, String format) throws Exception {
<span class="nc" id="L214">        Calendar date = new GregorianCalendar(timeZone);</span>
<span class="nc" id="L215">        SimpleDateFormat simpleDateFormat = new SimpleDateFormat(format);</span>
<span class="nc" id="L216">        simpleDateFormat.setTimeZone(timeZone);</span>
<span class="nc" id="L217">        date.setTime(simpleDateFormat.parse(str));</span>
<span class="nc" id="L218">        return date;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>