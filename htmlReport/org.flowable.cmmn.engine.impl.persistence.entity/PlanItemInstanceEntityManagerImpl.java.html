<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PlanItemInstanceEntityManagerImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.cmmn.engine.impl.persistence.entity</a> &gt; <span class="el_source">PlanItemInstanceEntityManagerImpl.java</span></div><h1>PlanItemInstanceEntityManagerImpl.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.cmmn.engine.impl.persistence.entity;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import org.flowable.cmmn.api.history.HistoricPlanItemInstance;
import org.flowable.cmmn.api.runtime.PlanItemDefinitionType;
import org.flowable.cmmn.api.runtime.PlanItemInstance;
import org.flowable.cmmn.api.runtime.PlanItemInstanceQuery;
import org.flowable.cmmn.api.runtime.PlanItemInstanceState;
import org.flowable.cmmn.converter.util.PlanItemDependencyUtil;
import org.flowable.cmmn.engine.CmmnEngineConfiguration;
import org.flowable.cmmn.engine.impl.persistence.entity.data.PlanItemInstanceDataManager;
import org.flowable.cmmn.engine.impl.repository.CaseDefinitionUtil;
import org.flowable.cmmn.engine.impl.runtime.PlanItemInstanceQueryImpl;
import org.flowable.cmmn.engine.impl.util.CaseInstanceUtil;
import org.flowable.cmmn.engine.impl.util.CommandContextUtil;
import org.flowable.cmmn.engine.impl.util.ExpressionUtil;
import org.flowable.cmmn.model.CmmnModel;
import org.flowable.cmmn.model.EventListener;
import org.flowable.cmmn.model.PlanFragment;
import org.flowable.cmmn.model.PlanItem;
import org.flowable.cmmn.model.PlanItemDefinition;
import org.flowable.cmmn.model.Stage;
import org.flowable.common.engine.api.delegate.Expression;
import org.flowable.common.engine.api.scope.ScopeTypes;
import org.flowable.common.engine.impl.context.Context;
import org.flowable.common.engine.impl.el.ExpressionManager;
import org.flowable.common.engine.impl.interceptor.CommandContext;
import org.flowable.common.engine.impl.persistence.entity.AbstractEngineEntityManager;
import org.flowable.identitylink.service.impl.persistence.entity.IdentityLinkEntity;
import org.flowable.identitylink.service.impl.persistence.entity.IdentityLinkEntityManager;
import org.flowable.job.service.impl.persistence.entity.ExternalWorkerJobEntity;
import org.flowable.job.service.impl.persistence.entity.ExternalWorkerJobEntityManager;
import org.flowable.job.service.impl.persistence.entity.TimerJobEntity;
import org.flowable.job.service.impl.persistence.entity.TimerJobEntityManager;
import org.flowable.variable.service.VariableService;
import org.flowable.variable.service.impl.persistence.entity.VariableInstanceEntity;

/**
 * @author Joram Barrez
 */
public class PlanItemInstanceEntityManagerImpl
        extends AbstractEngineEntityManager&lt;CmmnEngineConfiguration, PlanItemInstanceEntity, PlanItemInstanceDataManager&gt;
        implements PlanItemInstanceEntityManager {
    
    public PlanItemInstanceEntityManagerImpl(CmmnEngineConfiguration cmmnEngineConfiguration, PlanItemInstanceDataManager planItemInstanceDataManager) {
<span class="nc" id="L67">        super(cmmnEngineConfiguration, planItemInstanceDataManager);</span>
<span class="nc" id="L68">    }</span>

    @Override
    public PlanItemInstanceEntity create(HistoricPlanItemInstance historicPlanItemInstance) {
<span class="nc" id="L72">        return new PlanItemInstanceEntityImpl(historicPlanItemInstance);</span>
    }

    @Override
    public PlanItemInstanceEntityBuilder createPlanItemInstanceEntityBuilder() {
<span class="nc" id="L77">        return new PlanItemInstanceEntityBuilderImpl(this);</span>
    }

    public PlanItemInstanceEntity createChildPlanItemInstance(PlanItemInstanceEntityBuilderImpl builder) {
<span class="nc" id="L81">        ExpressionManager expressionManager = engineConfiguration.getExpressionManager();</span>

<span class="nc" id="L83">        PlanItemInstanceEntity planItemInstanceEntity = create();</span>
<span class="nc" id="L84">        planItemInstanceEntity.setCaseDefinitionId(builder.getCaseDefinitionId());</span>
<span class="nc" id="L85">        planItemInstanceEntity.setDerivedCaseDefinitionId(builder.getDerivedCaseDefinitionId());</span>
<span class="nc" id="L86">        planItemInstanceEntity.setCaseInstanceId(builder.getCaseInstanceId());</span>

<span class="nc" id="L88">        planItemInstanceEntity.setCreateTime(engineConfiguration.getClock().getCurrentTime());</span>
<span class="nc" id="L89">        planItemInstanceEntity.setElementId(builder.getPlanItem().getId());</span>
<span class="nc" id="L90">        PlanItemDefinition planItemDefinition = builder.getPlanItem().getPlanItemDefinition();</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (planItemDefinition != null) {</span>
<span class="nc" id="L92">            planItemInstanceEntity.setPlanItemDefinitionId(planItemDefinition.getId());</span>

<span class="nc" id="L94">            String planItemDefinitionType = planItemDefinition.getClass().getSimpleName().toLowerCase();</span>
<span class="nc" id="L95">            planItemInstanceEntity.setPlanItemDefinitionType(planItemDefinitionType);</span>
<span class="nc" id="L96">            planItemInstanceEntity.setStage(PlanItemDefinitionType.STAGE.equals(planItemDefinitionType));</span>
<span class="nc" id="L97">        } else {</span>
<span class="nc" id="L98">            planItemInstanceEntity.setStage(false);</span>
        }

<span class="nc" id="L101">        PlanItemInstance stagePlanItemInstance = builder.getStagePlanItemInstance();</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (stagePlanItemInstance != null) {</span>
<span class="nc" id="L103">            planItemInstanceEntity.setStageInstanceId(stagePlanItemInstance.getId());</span>

            // if the stage has a derived case definition id (e.g. was dynamically injected, we need to pass it on to child plan items, otherwise they cannot
            // load the plan item model
<span class="nc bnc" id="L107" title="All 4 branches missed.">            if (stagePlanItemInstance.getDerivedCaseDefinitionId() != null &amp;&amp; builder.getDerivedCaseDefinitionId() == null) {</span>
<span class="nc" id="L108">                planItemInstanceEntity.setDerivedCaseDefinitionId(stagePlanItemInstance.getDerivedCaseDefinitionId());</span>
            }
        }
<span class="nc" id="L111">        planItemInstanceEntity.setTenantId(builder.getTenantId());</span>

<span class="nc" id="L113">        insert(planItemInstanceEntity);</span>


        // adding variables must be done after the entity was inserted, before it does not yet have an id for the variables to be referenced
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (builder.hasLocalVariables()) {</span>
<span class="nc" id="L118">            planItemInstanceEntity.setVariablesLocal(builder.getLocalVariables());</span>
        }

        // check for an explicitly set name for the plan item instance
<span class="nc bnc" id="L122" title="All 2 branches missed.">        if (builder.getName() != null) {</span>
<span class="nc" id="L123">            planItemInstanceEntity.setName(builder.getName());</span>
        } else {
            // the name might have an expression being based on local variables, so we can only set the name after insertion
<span class="nc bnc" id="L126" title="All 2 branches missed.">            if (builder.getPlanItem().getName() != null) {</span>
<span class="nc" id="L127">                Expression nameExpression = expressionManager.createExpression(builder.getPlanItem().getName());</span>
                String name;
<span class="nc bnc" id="L129" title="All 2 branches missed.">                if (builder.isSilentNameExpressionEvaluation()) {</span>
                    try {
<span class="nc" id="L131">                        name = nameExpression.getValue(planItemInstanceEntity).toString();</span>
<span class="nc" id="L132">                    } catch (Exception e) {</span>
                        // we silently catch this exception as it is expected to a possible failure due to the state of the name evaluation
                        // we use the expression itself as a fallback in this case
<span class="nc" id="L135">                        name = builder.getPlanItem().getName();</span>
<span class="nc" id="L136">                    }</span>
                } else {
<span class="nc" id="L138">                    name = nameExpression.getValue(planItemInstanceEntity).toString();</span>
                }
<span class="nc" id="L140">                planItemInstanceEntity.setName(name);</span>
            }
        }

<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (builder.addToParent) {</span>
<span class="nc" id="L145">            addPlanItemInstanceToParent(planItemInstanceEntity);</span>
        }

<span class="nc" id="L148">        return planItemInstanceEntity;</span>
    }
    
    protected void addPlanItemInstanceToParent(PlanItemInstanceEntity planItemInstanceEntity) {
<span class="nc bnc" id="L152" title="All 2 branches missed.">        if (planItemInstanceEntity.getStageInstanceId() != null) {</span>
<span class="nc" id="L153">            PlanItemInstanceEntity stagePlanItemInstanceEntity = engineConfiguration.getPlanItemInstanceEntityManager()</span>
<span class="nc" id="L154">                    .findById(planItemInstanceEntity.getStageInstanceId());</span>
<span class="nc" id="L155">            stagePlanItemInstanceEntity.getChildPlanItemInstances().add(planItemInstanceEntity);</span>
<span class="nc" id="L156">        } else {</span>
<span class="nc" id="L157">            CaseInstanceEntity caseInstanceEntity = engineConfiguration.getCaseInstanceEntityManager().findById(planItemInstanceEntity.getCaseInstanceId());</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">            if (caseInstanceEntity.getChildPlanItemInstances() == null) {</span>
<span class="nc" id="L159">                caseInstanceEntity.setChildPlanItemInstances(new ArrayList&lt;&gt;());</span>
            }
<span class="nc" id="L161">            caseInstanceEntity.getChildPlanItemInstances().add(planItemInstanceEntity);</span>
        }
<span class="nc" id="L163">    }</span>

    @Override
    public void deleteSentryRelatedData(String planItemId) {
<span class="nc" id="L167">        PlanItemInstanceEntity planItemInstanceEntity = dataManager.findById(planItemId);</span>

<span class="nc" id="L169">        deleteSentryPartInstances(planItemInstanceEntity);</span>
<span class="nc" id="L170">        deleteOrphanEventListeners(planItemInstanceEntity);</span>
<span class="nc" id="L171">    }</span>

    /**
     * Deletes any part instance of a sentry that was satisfied before to clean it up for further evaluation cycles.
     */
    protected void deleteSentryPartInstances(PlanItemInstanceEntity planItemInstanceEntity) {
<span class="nc" id="L177">        SentryPartInstanceEntityManager sentryPartInstanceEntityManager = engineConfiguration.getSentryPartInstanceEntityManager();</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (planItemInstanceEntity.getPlanItem() != null</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">            &amp;&amp; (!planItemInstanceEntity.getPlanItem().getEntryCriteria().isEmpty()</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">            || !planItemInstanceEntity.getPlanItem().getExitCriteria().isEmpty())) {</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">            if (planItemInstanceEntity.getSatisfiedSentryPartInstances() != null) {</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">                for (SentryPartInstanceEntity sentryPartInstanceEntity : planItemInstanceEntity.getSatisfiedSentryPartInstances()) {</span>
<span class="nc" id="L183">                    sentryPartInstanceEntityManager.delete(sentryPartInstanceEntity);</span>
<span class="nc" id="L184">                }</span>
                // reset the internal satisfied sentry list, so it is not re-used again
<span class="nc" id="L186">                planItemInstanceEntity.setSatisfiedSentryPartInstances(null);</span>
            }
        }
<span class="nc" id="L189">    }</span>

    /**
     * Event listeners can become 'orphaned': when they reference sentries on plan item instances
     * that have moved to a terminal state, they would occur without anything listening to them
     * (and block completion of the parent stage). In that situation, they need to be removed.
     */
    protected void deleteOrphanEventListeners(PlanItemInstanceEntity planItemInstanceEntity) {

        /*
         * 'Orphan' event listeners are event listeners that are no longer referenced by any plan item instance that is not in a terminal state.
         * Said simpler: when they occur, nothing is listening to them anymore. As such, they have no value to keep around.
         * For example, imagine a user event listener is used to exit a stage. When the stage goes into a terminal state (via another way),
         * there is no purpose for the user event listener anymore. At that point, it is removed.
         *
         * Note that this needs to be done both on activating and terminating a plan item instance, as orphans can happen in both cases.
         *
         * The way these orphan event listeners are determined is as follows:
         * 1. Get all dependencies of the plan item that's currently being moved into a terminal state.
         *    (dependencies are all other plan items that are references through its sentries)
         * 2. Filter out the event listeners from that list.
         * 3. For those event listeners, get the dependent plan items.
         *    These dependents are the plan items that depend in their sentries on this event listener.
         * 4. Fetch the plan item instances for these dependent plan items.
         *    - If the event listener is used for an entry criterion: if they are all in a state different from available, it is an orphan.
         *    - If the event listener is used for an exit criterion: if they are all in a terminal state, the user event listener is an orphan and can be deleted.
         *    Note: if the plan item instance has a parent that is non-terminal, the plan item instance can still become active later and the event listener still is needed
         */

<span class="nc" id="L218">        PlanItem planItem = planItemInstanceEntity.getPlanItem();</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">        if (planItem != null) {</span>

            // Step 1 and 2 (gather and filter)
<span class="nc" id="L222">            List&lt;PlanItem&gt; eventListenerDependencies = gatherEventListenerDependencies(planItem, planItemInstanceEntity);</span>

            // Step 3 and 4 (determine dependent plan items for the event listener and check if it's orphaned)
<span class="nc bnc" id="L225" title="All 2 branches missed.">            if (!eventListenerDependencies.isEmpty()) {</span>
<span class="nc" id="L226">                terminateOrphanedEventListeners(planItemInstanceEntity, eventListenerDependencies);</span>
            }
        }
<span class="nc" id="L229">    }</span>


    protected List&lt;PlanItem&gt; gatherEventListenerDependencies(PlanItem planItem, PlanItemInstanceEntity planItemInstanceEntity) {
        // first collect the event listeners
        List&lt;PlanItem&gt; eventListenerDependencies;

        // if the plan item has repetition, we don't remove any event listeners for entry dependencies, as they might trigger in the future and re-create
        // the plan item as it has repetition and therefore, we also don't remove any exit sentry dependant event listeners, as if in the future, the plan
        // item becomes active again, those event listeners might trigger again to terminate it, so we need them to stay in place
        // furthermore, don't investigate into not-yet-created child plan items having event listeners as they might become active at a later state
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (ExpressionUtil.hasRepetitionRule(planItem)) {</span>
<span class="nc" id="L241">            return Collections.emptyList();</span>
        } else {
<span class="nc" id="L243">            eventListenerDependencies = Stream.concat(</span>
<span class="nc" id="L244">                planItem.getEntryDependencies().stream().filter(p -&gt; p.getPlanItemDefinition() instanceof EventListener),</span>
<span class="nc" id="L245">                planItem.getExitDependencies().stream().filter(p -&gt; p.getPlanItemDefinition() instanceof EventListener))</span>
<span class="nc" id="L246">                .collect(Collectors.toList());</span>
        }

        // Special case: if the current plan item is a stage, we need to also verify all event listeners
        // that reference a child plan item of this stage. Normally this will happen automatically, unless
        // the child plan item instances haven't been created yet (e.g with nested stages).
        // As such, we need to check all plan items for which there hasn't been a plan item instance yet.

<span class="nc bnc" id="L254" title="All 2 branches missed.">        if (planItem.getPlanItemDefinition() instanceof PlanFragment</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">            &amp;&amp; PlanItemInstanceState.isInTerminalState(planItemInstanceEntity)) { //  This is only true when stopping, not when a plan item gets activated (in that case, the child plan items can still be created and no special care is needed)</span>

<span class="nc" id="L257">            List&lt;PlanItem&gt; childPlanItemsWithDependencies = getChildPlanItemsWithDependencies((PlanFragment) planItem.getPlanItemDefinition());</span>

<span class="nc" id="L259">            CaseInstanceEntity caseInstanceEntity = engineConfiguration.getCaseInstanceEntityManager()</span>
<span class="nc" id="L260">                    .findById(planItemInstanceEntity.getCaseInstanceId());</span>
<span class="nc" id="L261">            Map&lt;String, List&lt;PlanItemInstanceEntity&gt;&gt; childPlanItemInstancesMap = CaseInstanceUtil</span>
<span class="nc" id="L262">                .findChildPlanItemInstancesMap(caseInstanceEntity, childPlanItemsWithDependencies);</span>

<span class="nc bnc" id="L264" title="All 2 branches missed.">            for (PlanItem childPlanItemWithDependencies : childPlanItemsWithDependencies) {</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">                if (!childPlanItemInstancesMap.containsKey(childPlanItemWithDependencies.getId())) {</span>
<span class="nc" id="L266">                    eventListenerDependencies.addAll(childPlanItemWithDependencies.getEntryDependencies().stream()</span>
<span class="nc" id="L267">                        .filter(p -&gt; p.getPlanItemDefinition() instanceof EventListener).collect(Collectors.toList()));</span>
<span class="nc" id="L268">                    eventListenerDependencies.addAll(childPlanItemWithDependencies.getExitDependencies().stream()</span>
<span class="nc" id="L269">                        .filter(p -&gt; p.getPlanItemDefinition() instanceof EventListener).collect(Collectors.toList()));</span>
                }
<span class="nc" id="L271">            }</span>
        }

<span class="nc" id="L274">        return eventListenerDependencies;</span>
    }

    protected void terminateOrphanedEventListeners(PlanItemInstanceEntity planItemInstanceEntity,  List&lt;PlanItem&gt; eventListenerDependencies) {

<span class="nc" id="L279">        CaseInstanceEntity caseInstanceEntity = engineConfiguration.getCaseInstanceEntityManager()</span>
<span class="nc" id="L280">                .findById(planItemInstanceEntity.getCaseInstanceId());</span>

<span class="nc bnc" id="L282" title="All 2 branches missed.">        for (PlanItem eventListenerPlanItem : eventListenerDependencies) {</span>

<span class="nc" id="L284">            List&lt;PlanItemInstanceEntity&gt; eventListenerPlanItemInstance = CaseInstanceUtil</span>
<span class="nc" id="L285">                .findNonTerminalChildPlanItemInstances(caseInstanceEntity, eventListenerPlanItem);</span>

            // Step 3
<span class="nc bnc" id="L288" title="All 2 branches missed.">            if (!eventListenerPlanItemInstance.isEmpty()) {</span>

<span class="nc" id="L290">                List&lt;PlanItem&gt; dependentPlanItems = eventListenerPlanItem.getAllDependentPlanItems();</span>
<span class="nc" id="L291">                Map&lt;String, List&lt;PlanItemInstanceEntity&gt;&gt; dependentPlanItemInstancesMap = CaseInstanceUtil</span>
<span class="nc" id="L292">                    .findChildPlanItemInstancesMap(caseInstanceEntity, dependentPlanItems);</span>

                // Step 4
<span class="nc" id="L295">                boolean isOrphan = true;</span>
<span class="nc" id="L296">                Iterator&lt;PlanItem&gt; planItemIterator = dependentPlanItems.iterator();</span>
<span class="nc bnc" id="L297" title="All 4 branches missed.">                while (isOrphan &amp;&amp; planItemIterator.hasNext()) {</span>

<span class="nc" id="L299">                    PlanItem dependentPlanItem = planItemIterator.next();</span>

<span class="nc" id="L301">                    List&lt;PlanItemInstanceEntity&gt; dependentPlanItemInstances = dependentPlanItemInstancesMap.get(dependentPlanItem.getId());</span>
<span class="nc bnc" id="L302" title="All 4 branches missed.">                    if (dependentPlanItemInstances != null &amp;&amp; !dependentPlanItemInstances.isEmpty()) {</span>

                        // In case there are instances, check the state

<span class="nc bnc" id="L306" title="All 2 branches missed.">                        for (PlanItemInstanceEntity dependentPlanItemInstance : dependentPlanItemInstances) {</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">                            if (PlanItemDependencyUtil.isEntryDependency(dependentPlanItemInstance.getPlanItem(), eventListenerPlanItem)) {</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">                                if (PlanItemInstanceState.AVAILABLE.equals(dependentPlanItemInstance.getState())</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">                                    || PlanItemInstanceState.WAITING_FOR_REPETITION.equals(dependentPlanItemInstance.getState())) {</span>
<span class="nc" id="L310">                                    isOrphan = false;</span>
                                }
                            }

<span class="nc bnc" id="L314" title="All 2 branches missed.">                            if (PlanItemDependencyUtil.isExitDependency(dependentPlanItemInstance.getPlanItem(), eventListenerPlanItem)) {</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">                                if (!PlanItemInstanceState.TERMINAL_STATES.contains(dependentPlanItemInstance.getState())) {</span>
<span class="nc" id="L316">                                    isOrphan = false;</span>
                                }
                            }
<span class="nc" id="L319">                        }</span>

                    } else {

                        // In case there are no instances, we need to check potential parents.
                        // If there is a nonterminal parent, the event listener still might be needed and cannot be terminated

<span class="nc" id="L326">                        Stage parentStage = dependentPlanItem.getParentStage();</span>
<span class="nc bnc" id="L327" title="All 6 branches missed.">                        while (isOrphan &amp;&amp; parentStage != null &amp;&amp; !parentStage.isPlanModel()) {</span>
<span class="nc" id="L328">                            List&lt;PlanItemInstanceEntity&gt; nonTerminalStagePlanItemInstances = CaseInstanceUtil</span>
<span class="nc" id="L329">                                .findNonTerminalChildPlanItemInstances(caseInstanceEntity, parentStage.getPlanItem());</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">                            if (!nonTerminalStagePlanItemInstances.isEmpty()) {</span>
<span class="nc" id="L331">                                isOrphan = false;</span>
                            } else {
<span class="nc" id="L333">                                parentStage = parentStage.getParentStage();</span>
                            }
<span class="nc" id="L335">                        }</span>

                    }

<span class="nc" id="L339">                }</span>

<span class="nc bnc" id="L341" title="All 2 branches missed.">                if (isOrphan) {</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">                    for (PlanItemInstanceEntity eventListenerPlanItemInstanceEntity : eventListenerPlanItemInstance) {</span>
                        // don't propagate the exit event type and exit type, if used on orphaned child plan items
<span class="nc" id="L344">                        CommandContextUtil.getAgenda().planTerminatePlanItemInstanceOperation(eventListenerPlanItemInstanceEntity,</span>
                            null, null);
<span class="nc" id="L346">                    }</span>
                }

            }
<span class="nc" id="L350">        }</span>
<span class="nc" id="L351">    }</span>

    protected List&lt;PlanItem&gt; getChildPlanItemsWithDependencies(PlanFragment planFragment) {
<span class="nc" id="L354">        List&lt;PlanItem&gt; childPlanItemsWithDependencies = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L355">        internalGetChildPlanItemsWithDependencies(planFragment, childPlanItemsWithDependencies);</span>
<span class="nc" id="L356">        return childPlanItemsWithDependencies;</span>
    }

    protected void internalGetChildPlanItemsWithDependencies(PlanFragment planFragment, List&lt;PlanItem&gt; childPlanItemsWithDependencies) {
<span class="nc bnc" id="L360" title="All 2 branches missed.">        for (PlanItem planItem : planFragment.getPlanItems()) {</span>
<span class="nc bnc" id="L361" title="All 4 branches missed.">            if (!planItem.getEntryDependencies().isEmpty() || !planItem.getExitDependencies().isEmpty()) {</span>
<span class="nc" id="L362">                childPlanItemsWithDependencies.add(planItem);</span>

<span class="nc bnc" id="L364" title="All 2 branches missed.">                if (planItem.getPlanItemDefinition() instanceof PlanFragment) {</span>
<span class="nc" id="L365">                    internalGetChildPlanItemsWithDependencies((PlanFragment) planItem.getPlanItemDefinition(), childPlanItemsWithDependencies);</span>
                }
            }
<span class="nc" id="L368">        }</span>
<span class="nc" id="L369">    }</span>

    @Override
    public void deleteByCaseDefinitionId(String caseDefinitionId) {
<span class="nc" id="L373">        dataManager.deleteByCaseDefinitionId(caseDefinitionId);</span>
<span class="nc" id="L374">    }</span>
    
    @Override
    public void deleteByStageInstanceId(String stageInstanceId) {
<span class="nc" id="L378">        dataManager.deleteByStageInstanceId(stageInstanceId);</span>
<span class="nc" id="L379">    }</span>
    
    @Override
    public void deleteByCaseInstanceId(String caseInstanceId) {
<span class="nc" id="L383">        dataManager.deleteByCaseInstanceId(caseInstanceId);</span>
<span class="nc" id="L384">    }</span>
    
    @Override
    public PlanItemInstanceQuery createPlanItemInstanceQuery() {
<span class="nc" id="L388">        return new PlanItemInstanceQueryImpl(engineConfiguration.getCommandExecutor(), engineConfiguration);</span>
    }

    @Override
    public long countByCriteria(PlanItemInstanceQuery planItemInstanceQuery) {
<span class="nc" id="L393">        return dataManager.countByCriteria((PlanItemInstanceQueryImpl) planItemInstanceQuery);</span>
    }

    @Override
    public List&lt;PlanItemInstance&gt; findByCriteria(PlanItemInstanceQuery planItemInstanceQuery) {
<span class="nc" id="L398">        return dataManager.findByCriteria((PlanItemInstanceQueryImpl) planItemInstanceQuery);</span>
    }
    
    @Override
    public List&lt;PlanItemInstanceEntity&gt; findByCaseInstanceId(String caseInstanceId) {
<span class="nc" id="L403">        return dataManager.findByCaseInstanceId(caseInstanceId);</span>
    }

    @Override
    public List&lt;PlanItemInstanceEntity&gt; findByStagePlanItemInstanceId(String stagePlanItemInstanceId) {
<span class="nc" id="L408">        return dataManager.findByStagePlanItemInstanceId(stagePlanItemInstanceId);</span>
    }

    @Override
    public List&lt;PlanItemInstanceEntity&gt; findByCaseInstanceIdAndPlanItemId(String caseInstanceId, String planitemId) {
<span class="nc" id="L413">        return dataManager.findByCaseInstanceIdAndPlanItemId(caseInstanceId, planitemId);</span>
    }

    @Override
    public List&lt;PlanItemInstanceEntity&gt; findByStageInstanceIdAndPlanItemId(String stageInstanceId, String planItemId) {
<span class="nc" id="L418">        return dataManager.findByStageInstanceIdAndPlanItemId(stageInstanceId, planItemId);</span>
    }

    @Override
    public void delete(PlanItemInstanceEntity planItemInstanceEntity, boolean fireEvent) {
<span class="nc" id="L423">        CountingPlanItemInstanceEntity countingPlanItemInstanceEntity = (CountingPlanItemInstanceEntity) planItemInstanceEntity;</span>
        
        // Variables
<span class="nc bnc" id="L426" title="All 2 branches missed.">        if (countingPlanItemInstanceEntity.getVariableCount() &gt; 0) {</span>

<span class="nc" id="L428">            VariableService variableService = engineConfiguration.getVariableServiceConfiguration().getVariableService();</span>
<span class="nc" id="L429">            List&lt;VariableInstanceEntity&gt; variableInstanceEntities = variableService</span>
<span class="nc" id="L430">                    .createInternalVariableInstanceQuery()</span>
<span class="nc" id="L431">                    .subScopeId(planItemInstanceEntity.getId())</span>
<span class="nc" id="L432">                    .scopeTypes(engineConfiguration.getDependentScopeTypes())</span>
<span class="nc" id="L433">                    .list();</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">            for (VariableInstanceEntity variableInstanceEntity : variableInstanceEntities) {</span>
<span class="nc" id="L435">                variableService.deleteVariableInstance(variableInstanceEntity);</span>
<span class="nc" id="L436">            }</span>
        }
        
<span class="nc bnc" id="L439" title="All 2 branches missed.">        if (planItemInstanceEntity.isStage()) {</span>
<span class="nc bnc" id="L440" title="All 4 branches missed.">            if (planItemInstanceEntity.getChildPlanItemInstances() != null &amp;&amp; !planItemInstanceEntity.getChildPlanItemInstances().isEmpty()) {</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">                for (PlanItemInstanceEntity childPlanItem : planItemInstanceEntity.getChildPlanItemInstances()) {</span>
<span class="nc" id="L442">                    delete(childPlanItem, fireEvent);</span>
<span class="nc" id="L443">                }</span>
            }
        }
        
<span class="nc bnc" id="L447" title="All 2 branches missed.">        if (planItemInstanceEntity.getPlanItemDefinitionType().equals(PlanItemDefinitionType.TIMER_EVENT_LISTENER)) {</span>
<span class="nc" id="L448">            TimerJobEntityManager timerJobEntityManager = engineConfiguration.getJobServiceConfiguration().getTimerJobEntityManager();</span>
<span class="nc" id="L449">            List&lt;TimerJobEntity&gt; timerJobsEntities = timerJobEntityManager</span>
<span class="nc" id="L450">                .findJobsByScopeIdAndSubScopeId(planItemInstanceEntity.getCaseInstanceId(), planItemInstanceEntity.getId());</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">            for (TimerJobEntity timerJobEntity : timerJobsEntities) {</span>
<span class="nc" id="L452">                timerJobEntityManager.delete(timerJobEntity);</span>
<span class="nc" id="L453">            }</span>
        }

<span class="nc bnc" id="L456" title="All 2 branches missed.">        if (planItemInstanceEntity.getPlanItemDefinitionType().equals(PlanItemDefinitionType.CASE_PAGE_TASK)) {</span>
<span class="nc" id="L457">            IdentityLinkEntityManager identityLinkEntityManager = engineConfiguration.getIdentityLinkServiceConfiguration().getIdentityLinkEntityManager();</span>
<span class="nc" id="L458">            List&lt;IdentityLinkEntity&gt; identityLinkEntities = identityLinkEntityManager</span>
<span class="nc" id="L459">                .findIdentityLinksBySubScopeIdAndType(planItemInstanceEntity.getId(), ScopeTypes.PLAN_ITEM);</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">            for (IdentityLinkEntity identityLinkEntity : identityLinkEntities) {</span>
<span class="nc" id="L461">                identityLinkEntityManager.delete(identityLinkEntity);</span>
<span class="nc" id="L462">            }</span>
        }

<span class="nc bnc" id="L465" title="All 2 branches missed.">        if (planItemInstanceEntity.getPlanItemDefinitionType().equals(PlanItemDefinitionType.EXTERNAL_WORKER_TASK)) {</span>
<span class="nc" id="L466">            ExternalWorkerJobEntityManager externalWorkerJobEntityManager = engineConfiguration</span>
<span class="nc" id="L467">                    .getJobServiceConfiguration().getExternalWorkerJobEntityManager();</span>
<span class="nc" id="L468">            List&lt;ExternalWorkerJobEntity&gt; externalWorkerJobEntities = externalWorkerJobEntityManager</span>
<span class="nc" id="L469">                    .findJobsByScopeIdAndSubScopeId(planItemInstanceEntity.getCaseInstanceId(), planItemInstanceEntity.getId());</span>

<span class="nc bnc" id="L471" title="All 2 branches missed.">            for (ExternalWorkerJobEntity externalWorkerJobEntity : externalWorkerJobEntities) {</span>
<span class="nc" id="L472">                externalWorkerJobEntityManager.delete(externalWorkerJobEntity);</span>
<span class="nc" id="L473">            }</span>
        }
        
<span class="nc" id="L476">        getDataManager().delete(planItemInstanceEntity);</span>
<span class="nc" id="L477">    }</span>

    @Override
    public void updatePlanItemInstancesCaseDefinitionId(String caseInstanceId, String caseDefinitionId) {
<span class="nc" id="L481">        CommandContext commandContext = Context.getCommandContext();</span>
<span class="nc" id="L482">        PlanItemInstanceQuery planItemQuery = new PlanItemInstanceQueryImpl(commandContext, engineConfiguration)</span>
<span class="nc" id="L483">                .caseInstanceId(caseInstanceId)</span>
<span class="nc" id="L484">                .includeEnded();</span>
<span class="nc" id="L485">        List&lt;PlanItemInstance&gt; planItemInstances = findByCriteria(planItemQuery);</span>
<span class="nc bnc" id="L486" title="All 4 branches missed.">        if (planItemInstances != null &amp;&amp; !planItemInstances.isEmpty()) {</span>
<span class="nc" id="L487">            List&lt;String&gt; endStates = Arrays.asList(PlanItemInstanceState.UNAVAILABLE, PlanItemInstanceState.DISABLED, PlanItemInstanceState.COMPLETED, PlanItemInstanceState.TERMINATED, PlanItemInstanceState.FAILED);</span>
<span class="nc" id="L488">            CmmnModel cmmnModel = CaseDefinitionUtil.getCmmnModel(caseDefinitionId);</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">            for (PlanItemInstance planItemInstance : planItemInstances) {</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">                if (!endStates.contains(planItemInstance.getState())) {</span>
<span class="nc bnc" id="L491" title="All 2 branches missed.">                    if (cmmnModel.findPlanItemByPlanItemDefinitionId(planItemInstance.getPlanItemDefinitionId()) == null) {</span>
<span class="nc" id="L492">                        PlanItemInstanceEntity planItemInstanceEntity = (PlanItemInstanceEntity) planItemInstance;</span>
<span class="nc" id="L493">                        planItemInstanceEntity.setState(PlanItemInstanceState.TERMINATED);</span>
<span class="nc" id="L494">                        planItemInstanceEntity.setEndedTime(engineConfiguration.getClock().getCurrentTime());</span>
<span class="nc" id="L495">                        planItemInstanceEntity.setTerminatedTime(planItemInstanceEntity.getEndedTime());</span>
<span class="nc" id="L496">                        CommandContextUtil.getCmmnHistoryManager(commandContext).recordPlanItemInstanceTerminated(planItemInstanceEntity);</span>
                    }
                }
                
<span class="nc" id="L500">                PlanItemInstanceEntity planItemInstanceEntity = (PlanItemInstanceEntity) planItemInstance;</span>
<span class="nc" id="L501">                planItemInstanceEntity.setCaseDefinitionId(caseDefinitionId);</span>
<span class="nc" id="L502">                update(planItemInstanceEntity);</span>
<span class="nc" id="L503">            }</span>
        }
<span class="nc" id="L505">    }</span>

    protected CaseInstanceEntityManager getCaseInstanceEntityManager() {
<span class="nc" id="L508">        return engineConfiguration.getCaseInstanceEntityManager();</span>
    }
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>