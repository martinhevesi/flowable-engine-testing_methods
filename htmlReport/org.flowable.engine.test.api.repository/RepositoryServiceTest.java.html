<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RepositoryServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.repository</a> &gt; <span class="el_source">RepositoryServiceTest.java</span></div><h1>RepositoryServiceTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.engine.test.api.repository;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatCode;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

import java.io.ByteArrayOutputStream;
import java.io.InputStream;
import java.io.ObjectOutputStream;
import java.nio.charset.StandardCharsets;
import java.util.Date;
import java.util.List;
import java.util.zip.ZipInputStream;

import org.flowable.bpmn.model.BpmnModel;
import org.flowable.bpmn.model.EndEvent;
import org.flowable.bpmn.model.ParallelGateway;
import org.flowable.bpmn.model.StartEvent;
import org.flowable.bpmn.model.UserTask;
import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.api.FlowableIllegalArgumentException;
import org.flowable.common.engine.api.FlowableObjectNotFoundException;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.repository.Model;
import org.flowable.engine.repository.ProcessDefinition;
import org.flowable.engine.test.Deployment;
import org.junit.jupiter.api.Test;

/**
 * @author Frederik Heremans
 * @author Joram Barrez
 */
<span class="nc" id="L46">public class RepositoryServiceTest extends PluggableFlowableTestCase {</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testStartProcessInstanceById() {
<span class="nc" id="L51">        List&lt;ProcessDefinition&gt; processDefinitions = repositoryService.createProcessDefinitionQuery().list();</span>
<span class="nc" id="L52">        assertThat(processDefinitions)</span>
<span class="nc" id="L53">                .extracting(ProcessDefinition::getKey)</span>
<span class="nc" id="L54">                .containsExactly(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L55">        ProcessDefinition processDefinition = processDefinitions.get(0);</span>
<span class="nc" id="L56">        assertThat(processDefinition.getId()).isNotNull();</span>
<span class="nc" id="L57">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testFindProcessDefinitionById() {
<span class="nc" id="L62">        List&lt;ProcessDefinition&gt; definitions = repositoryService.createProcessDefinitionQuery().list();</span>
<span class="nc" id="L63">        assertThat(definitions).hasSize(1);</span>

<span class="nc" id="L65">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().processDefinitionId(definitions.get(0).getId()).singleResult();</span>
<span class="nc" id="L66">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L67">        assertThat(processDefinition).isNotNull();</span>
<span class="nc" id="L68">        assertThat(processDefinition.getKey()).isEqualTo(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L69">        assertThat(processDefinition.getName()).isEqualTo(&quot;The One Task Process&quot;);</span>

<span class="nc" id="L71">        processDefinition = repositoryService.getProcessDefinition(definitions.get(0).getId());</span>
<span class="nc" id="L72">        assertThat(processDefinition.getDescription()).isEqualTo(&quot;This is a process for testing purposes&quot;);</span>
<span class="nc" id="L73">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testDeleteDeploymentWithRunningInstances() {
<span class="nc" id="L78">        List&lt;ProcessDefinition&gt; processDefinitions = repositoryService.createProcessDefinitionQuery().list();</span>
<span class="nc" id="L79">        assertThat(processDefinitions).hasSize(1);</span>
<span class="nc" id="L80">        ProcessDefinition processDefinition = processDefinitions.get(0);</span>

<span class="nc" id="L82">        runtimeService.startProcessInstanceById(processDefinition.getId());</span>

        // Try to delete the deployment
<span class="nc" id="L85">        assertThatThrownBy(() -&gt; repositoryService.deleteDeployment(processDefinition.getDeploymentId()))</span>
<span class="nc" id="L86">                .isInstanceOf(RuntimeException.class);</span>
<span class="nc" id="L87">    }</span>

    @Test
    public void testDeleteDeploymentNullDeploymentId() {
<span class="nc" id="L91">        assertThatThrownBy(() -&gt; repositoryService.deleteDeployment(null))</span>
<span class="nc" id="L92">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L93">                .hasMessageContaining(&quot;deploymentId is null&quot;);</span>
<span class="nc" id="L94">    }</span>

    @Test
    public void testDeleteDeploymentCascadeNullDeploymentId() {
<span class="nc" id="L98">        assertThatThrownBy(() -&gt; repositoryService.deleteDeployment(null, true))</span>
<span class="nc" id="L99">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L100">                .hasMessageContaining(&quot;deploymentId is null&quot;);</span>
<span class="nc" id="L101">    }</span>

    @Test
    public void testDeleteDeploymentNonExistentDeploymentId() {
<span class="nc" id="L105">        assertThatThrownBy(() -&gt; repositoryService.deleteDeployment(&quot;foobar&quot;))</span>
<span class="nc" id="L106">                .isInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L107">                .hasMessageContaining(&quot;Could not find a deployment with id 'foobar'.&quot;);</span>
<span class="nc" id="L108">    }</span>

    @Test
    public void testDeleteDeploymentCascadeNonExistentDeploymentId() {
<span class="nc" id="L112">        assertThatThrownBy(() -&gt; repositoryService.deleteDeployment(&quot;foobar&quot;, true))</span>
<span class="nc" id="L113">                .isInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L114">                .hasMessageContaining(&quot;Could not find a deployment with id 'foobar'.&quot;);</span>
<span class="nc" id="L115">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testDeleteDeploymentCascadeWithRunningInstances() {
<span class="nc" id="L120">        List&lt;ProcessDefinition&gt; processDefinitions = repositoryService.createProcessDefinitionQuery().list();</span>
<span class="nc" id="L121">        assertThat(processDefinitions).hasSize(1);</span>
<span class="nc" id="L122">        ProcessDefinition processDefinition = processDefinitions.get(0);</span>

<span class="nc" id="L124">        runtimeService.startProcessInstanceById(processDefinition.getId());</span>

        // Try to delete the deployment, no exception should be thrown
<span class="nc" id="L127">        repositoryService.deleteDeployment(processDefinition.getDeploymentId(), true);</span>
<span class="nc" id="L128">    }</span>

    @Test
    public void testFindDeploymentResourceNamesNullDeploymentId() {
<span class="nc" id="L132">        assertThatThrownBy(() -&gt; repositoryService.getDeploymentResourceNames(null))</span>
<span class="nc" id="L133">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L134">                .hasMessageContaining(&quot;deploymentId is null&quot;);</span>
<span class="nc" id="L135">    }</span>

    @Test
    public void testDeploymentWithDelayedProcessDefinitionActivation() {

<span class="nc" id="L140">        Date startTime = new Date();</span>
<span class="nc" id="L141">        processEngineConfiguration.getClock().setCurrentTime(startTime);</span>
<span class="nc" id="L142">        Date inThreeDays = new Date(startTime.getTime() + (3 * 24 * 60 * 60 * 1000));</span>

        // Deploy process, but activate after three days
<span class="nc" id="L145">        org.flowable.engine.repository.Deployment deployment = repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot;)</span>
<span class="nc" id="L146">                .addClasspathResource(&quot;org/flowable/engine/test/api/twoTasksProcess.bpmn20.xml&quot;).activateProcessDefinitionsOn(inThreeDays).deploy();</span>

<span class="nc" id="L148">        assertThat(repositoryService.createDeploymentQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L149">        assertThat(repositoryService.createProcessDefinitionQuery().count()).isEqualTo(2);</span>
<span class="nc" id="L150">        assertThat(repositoryService.createProcessDefinitionQuery().suspended().count()).isEqualTo(2);</span>
<span class="nc" id="L151">        assertThat(repositoryService.createProcessDefinitionQuery().active().count()).isZero();</span>

        // Shouldn't be able to start a process instance
<span class="nc" id="L154">        assertThatThrownBy(() -&gt; runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;))</span>
<span class="nc" id="L155">                .isInstanceOf(FlowableException.class)</span>
<span class="nc" id="L156">                .hasMessageContaining(&quot;suspended&quot;);</span>

        // Move time four days forward, the timer will fire and the process
        // definitions will be active
<span class="nc" id="L160">        Date inFourDays = new Date(startTime.getTime() + (4 * 24 * 60 * 60 * 1000));</span>
<span class="nc" id="L161">        processEngineConfiguration.getClock().setCurrentTime(inFourDays);</span>
<span class="nc" id="L162">        waitForJobExecutorToProcessAllJobsAndExecutableTimerJobs(7000L, 50L);</span>

<span class="nc" id="L164">        assertThat(repositoryService.createDeploymentQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L165">        assertThat(repositoryService.createProcessDefinitionQuery().count()).isEqualTo(2);</span>
<span class="nc" id="L166">        assertThat(repositoryService.createProcessDefinitionQuery().suspended().count()).isZero();</span>
<span class="nc" id="L167">        assertThat(repositoryService.createProcessDefinitionQuery().active().count()).isEqualTo(2);</span>

        // Should be able to start process instance
<span class="nc" id="L170">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L171">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>

        // Cleanup
<span class="nc" id="L174">        repositoryService.deleteDeployment(deployment.getId(), true);</span>
<span class="nc" id="L175">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testGetResourceAsStreamUnexistingResourceInExistingDeployment() {
        // Get hold of the deployment id
<span class="nc" id="L181">        org.flowable.engine.repository.Deployment deployment = repositoryService.createDeploymentQuery().singleResult();</span>

<span class="nc" id="L183">        assertThatThrownBy(() -&gt; repositoryService.getResourceAsStream(deployment.getId(), &quot;org/flowable/engine/test/api/unexistingProcess.bpmn.xml&quot;))</span>
<span class="nc" id="L184">                .isInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L185">                .hasMessageContaining(&quot;no resource found with name&quot;);</span>
<span class="nc" id="L186">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testGetResourceAsStreamUnexistingDeployment() {
<span class="nc" id="L191">        assertThatThrownBy(() -&gt; repositoryService.getResourceAsStream(&quot;unexistingdeployment&quot;, &quot;org/flowable/engine/test/api/unexistingProcess.bpmn.xml&quot;))</span>
<span class="nc" id="L192">                .isInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L193">                .hasMessageContaining(&quot;deployment does not exist&quot;);</span>
<span class="nc" id="L194">    }</span>

    @Test
    public void testGetResourceAsStreamNullArguments() {
<span class="nc" id="L198">        assertThatThrownBy(() -&gt; repositoryService.getResourceAsStream(null, &quot;resource&quot;))</span>
<span class="nc" id="L199">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L200">                .hasMessageContaining(&quot;deploymentId is null&quot;);</span>

<span class="nc" id="L202">        assertThatThrownBy(() -&gt; repositoryService.getResourceAsStream(&quot;deployment&quot;, null))</span>
<span class="nc" id="L203">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L204">                .hasMessageContaining(&quot;resourceName is null&quot;);</span>
<span class="nc" id="L205">    }</span>

    @Test
    public void testNewModelPersistence() {
<span class="nc" id="L209">        Model model = repositoryService.newModel();</span>
<span class="nc" id="L210">        assertThat(model).isNotNull();</span>

<span class="nc" id="L212">        model.setName(&quot;Test model&quot;);</span>
<span class="nc" id="L213">        model.setCategory(&quot;test&quot;);</span>
<span class="nc" id="L214">        model.setMetaInfo(&quot;meta&quot;);</span>
<span class="nc" id="L215">        repositoryService.saveModel(model);</span>

<span class="nc" id="L217">        assertThat(model.getId()).isNotNull();</span>
<span class="nc" id="L218">        model = repositoryService.getModel(model.getId());</span>
<span class="nc" id="L219">        assertThat(model).isNotNull();</span>
<span class="nc" id="L220">        assertThat(model.getName()).isEqualTo(&quot;Test model&quot;);</span>
<span class="nc" id="L221">        assertThat(model.getCategory()).isEqualTo(&quot;test&quot;);</span>
<span class="nc" id="L222">        assertThat(model.getMetaInfo()).isEqualTo(&quot;meta&quot;);</span>
<span class="nc" id="L223">        assertThat(model.getCreateTime()).isNotNull();</span>
<span class="nc" id="L224">        assertThat(model.getVersion()).isEqualTo(Integer.valueOf(1));</span>

<span class="nc" id="L226">        repositoryService.deleteModel(model.getId());</span>
<span class="nc" id="L227">    }</span>

    @Test
    public void testNewModelWithSource() throws Exception {
<span class="nc" id="L231">        Model model = repositoryService.newModel();</span>
<span class="nc" id="L232">        model.setName(&quot;Test model&quot;);</span>
<span class="nc" id="L233">        byte[] testSource = &quot;modelsource&quot;.getBytes(StandardCharsets.UTF_8);</span>
<span class="nc" id="L234">        repositoryService.saveModel(model);</span>

<span class="nc" id="L236">        assertThat(model.getId()).isNotNull();</span>
<span class="nc" id="L237">        repositoryService.addModelEditorSource(model.getId(), testSource);</span>

<span class="nc" id="L239">        model = repositoryService.getModel(model.getId());</span>
<span class="nc" id="L240">        assertThat(model).isNotNull();</span>
<span class="nc" id="L241">        assertThat(model.getName()).isEqualTo(&quot;Test model&quot;);</span>

<span class="nc" id="L243">        byte[] editorSourceBytes = repositoryService.getModelEditorSource(model.getId());</span>
<span class="nc" id="L244">        assertThat(new String(editorSourceBytes, StandardCharsets.UTF_8)).isEqualTo(&quot;modelsource&quot;);</span>

<span class="nc" id="L246">        repositoryService.deleteModel(model.getId());</span>
<span class="nc" id="L247">    }</span>

    @Test
    public void testUpdateModelPersistence() throws Exception {
<span class="nc" id="L251">        Model model = repositoryService.newModel();</span>
<span class="nc" id="L252">        assertThat(model).isNotNull();</span>

<span class="nc" id="L254">        model.setName(&quot;Test model&quot;);</span>
<span class="nc" id="L255">        model.setCategory(&quot;test&quot;);</span>
<span class="nc" id="L256">        model.setMetaInfo(&quot;meta&quot;);</span>
<span class="nc" id="L257">        repositoryService.saveModel(model);</span>

<span class="nc" id="L259">        assertThat(model.getId()).isNotNull();</span>
<span class="nc" id="L260">        model = repositoryService.getModel(model.getId());</span>
<span class="nc" id="L261">        assertThat(model).isNotNull();</span>

<span class="nc" id="L263">        model.setName(&quot;New name&quot;);</span>
<span class="nc" id="L264">        model.setCategory(&quot;New category&quot;);</span>
<span class="nc" id="L265">        model.setMetaInfo(&quot;test&quot;);</span>
<span class="nc" id="L266">        model.setVersion(2);</span>
<span class="nc" id="L267">        repositoryService.saveModel(model);</span>

<span class="nc" id="L269">        assertThat(model.getId()).isNotNull();</span>
<span class="nc" id="L270">        repositoryService.addModelEditorSource(model.getId(), &quot;new&quot;.getBytes(StandardCharsets.UTF_8));</span>
<span class="nc" id="L271">        repositoryService.addModelEditorSourceExtra(model.getId(), &quot;new&quot;.getBytes(StandardCharsets.UTF_8));</span>

<span class="nc" id="L273">        model = repositoryService.getModel(model.getId());</span>

<span class="nc" id="L275">        assertThat(model.getName()).isEqualTo(&quot;New name&quot;);</span>
<span class="nc" id="L276">        assertThat(model.getCategory()).isEqualTo(&quot;New category&quot;);</span>
<span class="nc" id="L277">        assertThat(model.getMetaInfo()).isEqualTo(&quot;test&quot;);</span>
<span class="nc" id="L278">        assertThat(model.getCreateTime()).isNotNull();</span>
<span class="nc" id="L279">        assertThat(model.getVersion()).isEqualTo(Integer.valueOf(2));</span>
<span class="nc" id="L280">        assertThat(new String(repositoryService.getModelEditorSource(model.getId()), StandardCharsets.UTF_8)).isEqualTo(&quot;new&quot;);</span>
<span class="nc" id="L281">        assertThat(new String(repositoryService.getModelEditorSourceExtra(model.getId()), StandardCharsets.UTF_8)).isEqualTo(&quot;new&quot;);</span>

<span class="nc" id="L283">        repositoryService.deleteModel(model.getId());</span>
<span class="nc" id="L284">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testProcessDefinitionEntitySerializable() {
<span class="nc" id="L289">        String procDefId = repositoryService.createProcessDefinitionQuery().singleResult().getId();</span>
<span class="nc" id="L290">        ProcessDefinition processDefinition = repositoryService.getProcessDefinition(procDefId);</span>

<span class="nc" id="L292">        assertThatCode(() -&gt; {</span>
<span class="nc" id="L293">            ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="nc" id="L294">            new ObjectOutputStream(baos).writeObject(processDefinition);</span>

<span class="nc" id="L296">            byte[] bytes = baos.toByteArray();</span>
<span class="nc" id="L297">            assertThat(bytes).isNotEmpty();</span>
<span class="nc" id="L298">        })</span>
<span class="nc" id="L299">                .doesNotThrowAnyException();</span>
<span class="nc" id="L300">    }</span>

    @Test
    @Deployment
    public void testGetBpmnModel() {
<span class="nc" id="L305">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span>

        // Some basic assertions
<span class="nc" id="L308">        BpmnModel bpmnModel = repositoryService.getBpmnModel(processDefinition.getId());</span>
<span class="nc" id="L309">        assertThat(bpmnModel).isNotNull();</span>
<span class="nc" id="L310">        assertThat(bpmnModel.getProcesses()).hasSize(1);</span>
<span class="nc" id="L311">        assertThat(bpmnModel.getLocationMap()).isNotEmpty();</span>
<span class="nc" id="L312">        assertThat(bpmnModel.getFlowLocationMap()).isNotEmpty();</span>

        // Test the flow
<span class="nc" id="L315">        org.flowable.bpmn.model.Process process = bpmnModel.getProcesses().get(0);</span>
<span class="nc" id="L316">        List&lt;StartEvent&gt; startEvents = process.findFlowElementsOfType(StartEvent.class);</span>
<span class="nc" id="L317">        assertThat(startEvents).hasSize(1);</span>
<span class="nc" id="L318">        StartEvent startEvent = startEvents.get(0);</span>
<span class="nc" id="L319">        assertThat(startEvent.getOutgoingFlows()).hasSize(1);</span>
<span class="nc" id="L320">        assertThat(startEvent.getIncomingFlows()).isEmpty();</span>

<span class="nc" id="L322">        String nextElementId = startEvent.getOutgoingFlows().get(0).getTargetRef();</span>
<span class="nc" id="L323">        UserTask userTask = (UserTask) process.getFlowElement(nextElementId);</span>
<span class="nc" id="L324">        assertThat(userTask.getName()).isEqualTo(&quot;First Task&quot;);</span>

<span class="nc" id="L326">        assertThat(userTask.getOutgoingFlows()).hasSize(1);</span>
<span class="nc" id="L327">        assertThat(userTask.getIncomingFlows()).hasSize(1);</span>
<span class="nc" id="L328">        nextElementId = userTask.getOutgoingFlows().get(0).getTargetRef();</span>
<span class="nc" id="L329">        ParallelGateway parallelGateway = (ParallelGateway) process.getFlowElement(nextElementId);</span>
<span class="nc" id="L330">        assertThat(parallelGateway.getOutgoingFlows()).hasSize(2);</span>

<span class="nc" id="L332">        nextElementId = parallelGateway.getOutgoingFlows().get(0).getTargetRef();</span>
<span class="nc" id="L333">        assertThat(parallelGateway.getIncomingFlows()).hasSize(1);</span>
<span class="nc" id="L334">        userTask = (UserTask) process.getFlowElement(nextElementId);</span>
<span class="nc" id="L335">        assertThat(userTask.getOutgoingFlows()).hasSize(1);</span>

<span class="nc" id="L337">        nextElementId = userTask.getOutgoingFlows().get(0).getTargetRef();</span>
<span class="nc" id="L338">        parallelGateway = (ParallelGateway) process.getFlowElement(nextElementId);</span>
<span class="nc" id="L339">        assertThat(parallelGateway.getOutgoingFlows()).hasSize(1);</span>
<span class="nc" id="L340">        assertThat(parallelGateway.getIncomingFlows()).hasSize(2);</span>

<span class="nc" id="L342">        nextElementId = parallelGateway.getOutgoingFlows().get(0).getTargetRef();</span>
<span class="nc" id="L343">        EndEvent endEvent = (EndEvent) process.getFlowElement(nextElementId);</span>
<span class="nc" id="L344">        assertThat(endEvent.getOutgoingFlows()).isEmpty();</span>
<span class="nc" id="L345">        assertThat(endEvent.getIncomingFlows()).hasSize(1);</span>
<span class="nc" id="L346">    }</span>

    /**
     * This test was added due to issues with unzip of JDK 7, where the default is changed to UTF8 instead of the platform encoding (which is, in fact, good). However, some platforms do not create
     * UTF8-compatible ZIP files.
     * 
     * The tested zip file is created on OS X (non-UTF-8).
     * 
     * See https://blogs.oracle.com/xuemingshen/entry/non_utf_8_encoding_in
     */
    @Test
    public void testDeployZipFile() {
<span class="nc" id="L358">        InputStream inputStream = this.getClass().getClassLoader().getResourceAsStream(&quot;org/flowable/engine/test/api/repository/test-processes.zip&quot;);</span>
<span class="nc" id="L359">        assertThat(inputStream).isNotNull();</span>
<span class="nc" id="L360">        ZipInputStream zipInputStream = new ZipInputStream(inputStream);</span>
<span class="nc" id="L361">        assertThat(zipInputStream).isNotNull();</span>
<span class="nc" id="L362">        repositoryService.createDeployment().addZipInputStream(zipInputStream).deploy();</span>

<span class="nc" id="L364">        assertThat(repositoryService.createProcessDefinitionQuery().count()).isEqualTo(6);</span>

        // Delete
<span class="nc bnc" id="L367" title="All 2 branches missed.">        for (org.flowable.engine.repository.Deployment deployment : repositoryService.createDeploymentQuery().list()) {</span>
<span class="nc" id="L368">            repositoryService.deleteDeployment(deployment.getId(), true);</span>
<span class="nc" id="L369">        }</span>
<span class="nc" id="L370">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>