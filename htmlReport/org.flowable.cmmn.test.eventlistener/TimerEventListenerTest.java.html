<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TimerEventListenerTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.cmmn.test.eventlistener</a> &gt; <span class="el_source">TimerEventListenerTest.java</span></div><h1>TimerEventListenerTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.cmmn.test.eventlistener;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.assertj.core.api.Assertions.tuple;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.time.Instant;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.Calendar;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.List;

import org.assertj.core.groups.Tuple;
import org.flowable.cmmn.api.history.HistoricPlanItemInstance;
import org.flowable.cmmn.api.runtime.CaseInstance;
import org.flowable.cmmn.api.runtime.PlanItemDefinitionType;
import org.flowable.cmmn.api.runtime.PlanItemInstance;
import org.flowable.cmmn.api.runtime.PlanItemInstanceState;
import org.flowable.cmmn.engine.test.CmmnDeployment;
import org.flowable.cmmn.engine.test.FlowableCmmnTestCase;
import org.flowable.cmmn.engine.test.impl.CmmnHistoryTestHelper;
import org.flowable.cmmn.engine.test.impl.CmmnJobTestHelper;
import org.flowable.cmmn.model.HumanTask;
import org.flowable.cmmn.model.Stage;
import org.flowable.cmmn.model.TimerEventListener;
import org.flowable.common.engine.api.FlowableObjectNotFoundException;
import org.flowable.common.engine.api.scope.ScopeTypes;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.job.api.Job;
import org.flowable.task.api.Task;
import org.junit.Test;

/**
 * @author Joram Barrez
 */
<span class="nc" id="L52">public class TimerEventListenerTest extends FlowableCmmnTestCase {</span>

    @Test
    @CmmnDeployment
    public void testTimerExpressionDuration() {
<span class="nc" id="L57">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTimerExpression&quot;).start();</span>
<span class="nc" id="L58">        assertThat(caseInstance).isNotNull();</span>
<span class="nc" id="L59">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L61">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemDefinitionType(PlanItemDefinitionType.TIMER_EVENT_LISTENER)</span>
<span class="nc" id="L62">                .planItemInstanceStateAvailable().singleResult()).isNotNull();</span>
<span class="nc" id="L63">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemDefinitionType(PlanItemDefinitionType.HUMAN_TASK).planItemInstanceStateAvailable()</span>
<span class="nc" id="L64">                .singleResult()).isNotNull();</span>
<span class="nc" id="L65">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().list())</span>
<span class="nc" id="L66">                .extracting(PlanItemInstance::getPlanItemDefinitionType, PlanItemInstance::getPlanItemDefinitionId, PlanItemInstance::getState)</span>
<span class="nc" id="L67">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L68">                        tuple(PlanItemDefinitionType.TIMER_EVENT_LISTENER, &quot;timerListener&quot;, PlanItemInstanceState.AVAILABLE),</span>
<span class="nc" id="L69">                        tuple(PlanItemDefinitionType.HUMAN_TASK, &quot;taskA&quot;, PlanItemInstanceState.AVAILABLE)</span>
                );

<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L73">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().list())</span>
<span class="nc" id="L74">                    .extracting(HistoricPlanItemInstance::getPlanItemDefinitionType, HistoricPlanItemInstance::getPlanItemDefinitionId, HistoricPlanItemInstance::getState)</span>
<span class="nc" id="L75">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L76">                            tuple(PlanItemDefinitionType.TIMER_EVENT_LISTENER, &quot;timerListener&quot;, PlanItemInstanceState.AVAILABLE),</span>
<span class="nc" id="L77">                            tuple(PlanItemDefinitionType.HUMAN_TASK, &quot;taskA&quot;, PlanItemInstanceState.AVAILABLE)</span>
                    );
        }

<span class="nc" id="L81">        assertThat(cmmnManagementService.createTimerJobQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L82">        assertThat(cmmnManagementService.createTimerJobQuery().scopeId(caseInstance.getId()).scopeType(ScopeTypes.CMMN).count()).isEqualTo(1);</span>

        // User task should not be active before the timer triggers
<span class="nc" id="L85">        assertThat(cmmnTaskService.createTaskQuery().count()).isZero();</span>

<span class="nc" id="L87">        Job timerJob = cmmnManagementService.createTimerJobQuery().scopeDefinitionId(caseInstance.getCaseDefinitionId()).singleResult();</span>
<span class="nc" id="L88">        assertThat(timerJob).isNotNull();</span>
<span class="nc" id="L89">        assertThat(timerJob.getElementId()).isEqualTo(&quot;timerListener&quot;);</span>
<span class="nc" id="L90">        assertThat(timerJob.getElementName()).isEqualTo(&quot;Timer listener&quot;);</span>

<span class="nc" id="L92">        cmmnManagementService.moveTimerToExecutableJob(timerJob.getId());</span>
<span class="nc" id="L93">        cmmnManagementService.executeJob(timerJob.getId());</span>

<span class="nc" id="L95">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().list())</span>
<span class="nc" id="L96">                .extracting(PlanItemInstance::getPlanItemDefinitionType, PlanItemInstance::getPlanItemDefinitionId, PlanItemInstance::getState)</span>
<span class="nc" id="L97">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L98">                        tuple(PlanItemDefinitionType.HUMAN_TASK, &quot;taskA&quot;, PlanItemInstanceState.ACTIVE)</span>
                );

<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L102">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().list())</span>
<span class="nc" id="L103">                    .extracting(HistoricPlanItemInstance::getPlanItemDefinitionType, HistoricPlanItemInstance::getPlanItemDefinitionId, HistoricPlanItemInstance::getState)</span>
<span class="nc" id="L104">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L105">                            tuple(PlanItemDefinitionType.TIMER_EVENT_LISTENER, &quot;timerListener&quot;, PlanItemInstanceState.COMPLETED),</span>
<span class="nc" id="L106">                            tuple(PlanItemDefinitionType.HUMAN_TASK, &quot;taskA&quot;, PlanItemInstanceState.ACTIVE)</span>
                    );
        }

        // User task should be active after the timer has triggered
<span class="nc" id="L111">        assertThat(cmmnTaskService.createTaskQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L112">    }</span>
    
    @Test
    @CmmnDeployment
    public void testTimerExpressionDurationWithCategory() {
<span class="nc" id="L117">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTimerExpression&quot;).start();</span>
<span class="nc" id="L118">        assertThat(caseInstance).isNotNull();</span>
<span class="nc" id="L119">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L121">        assertThat(cmmnManagementService.createTimerJobQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L122">        assertThat(cmmnManagementService.createTimerJobQuery().scopeId(caseInstance.getId()).scopeType(ScopeTypes.CMMN).count()).isEqualTo(1);</span>

<span class="nc" id="L124">        Job timerJob = cmmnManagementService.createTimerJobQuery().scopeDefinitionId(caseInstance.getCaseDefinitionId()).singleResult();</span>
<span class="nc" id="L125">        assertThat(timerJob).isNotNull();</span>
<span class="nc" id="L126">        assertThat(timerJob.getCategory()).isEqualTo(&quot;myCategory&quot;);</span>

<span class="nc" id="L128">        cmmnManagementService.moveTimerToExecutableJob(timerJob.getId());</span>
<span class="nc" id="L129">        cmmnManagementService.executeJob(timerJob.getId());</span>

        // User task should be active after the timer has triggered
<span class="nc" id="L132">        assertThat(cmmnTaskService.createTaskQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L133">    }</span>
    
    @Test
    @CmmnDeployment
    public void testTimerExpressionDurationWithCategoryExpression() {
<span class="nc" id="L138">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L139">                .caseDefinitionKey(&quot;testTimerExpression&quot;)</span>
<span class="nc" id="L140">                .variable(&quot;categoryValue&quot;, &quot;testValue&quot;)</span>
<span class="nc" id="L141">                .start();</span>
<span class="nc" id="L142">        assertThat(caseInstance).isNotNull();</span>
<span class="nc" id="L143">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L145">        assertThat(cmmnManagementService.createTimerJobQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L146">        assertThat(cmmnManagementService.createTimerJobQuery().scopeId(caseInstance.getId()).scopeType(ScopeTypes.CMMN).count()).isEqualTo(1);</span>

<span class="nc" id="L148">        Job timerJob = cmmnManagementService.createTimerJobQuery().scopeDefinitionId(caseInstance.getCaseDefinitionId()).singleResult();</span>
<span class="nc" id="L149">        assertThat(timerJob).isNotNull();</span>
<span class="nc" id="L150">        assertThat(timerJob.getCategory()).isEqualTo(&quot;testValue&quot;);</span>

<span class="nc" id="L152">        cmmnManagementService.moveTimerToExecutableJob(timerJob.getId());</span>
<span class="nc" id="L153">        cmmnManagementService.executeJob(timerJob.getId());</span>

        // User task should be active after the timer has triggered
<span class="nc" id="L156">        assertThat(cmmnTaskService.createTaskQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L157">    }</span>

    /**
     * Similar test as #testTimerExpressionDuration but with the real async executor,
     * instead of manually triggering the timer.
     */
    @Test
    @CmmnDeployment
    public void testTimerExpressionDurationWithRealAsyncExecutor() {
<span class="nc" id="L166">        Date startTime = setClockFixedToCurrentTime();</span>
<span class="nc" id="L167">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTimerExpression&quot;).start();</span>

<span class="nc" id="L169">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L170">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L171">                .planItemInstanceState(PlanItemInstanceState.AVAILABLE)</span>
<span class="nc" id="L172">                .planItemDefinitionType(PlanItemDefinitionType.TIMER_EVENT_LISTENER)</span>
<span class="nc" id="L173">                .singleResult();</span>
<span class="nc" id="L174">        assertThat(planItemInstance).isNotNull();</span>

        // User task should not be active before the timer triggers
<span class="nc" id="L177">        assertThat(cmmnTaskService.createTaskQuery().count()).isZero();</span>

        // Timer fires after 1 hour, so setting it to 1 hours + 1 second
<span class="nc" id="L180">        setClockTo(new Date(startTime.getTime() + (60 * 60 * 1000 + 1)));</span>

<span class="nc" id="L182">        CmmnJobTestHelper.waitForJobExecutorToProcessAllJobs(cmmnEngineConfiguration, 7000L, 200L, true);</span>

        // User task should be active after the timer has triggered 
<span class="nc" id="L185">        assertThat(cmmnTaskService.createTaskQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L186">    }</span>

    @Test
    @CmmnDeployment
    public void testStageAfterTimer() {
<span class="nc" id="L191">        Date startTime = setClockFixedToCurrentTime();</span>
<span class="nc" id="L192">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testStageAfterTimerEventListener&quot;).start();</span>

<span class="nc" id="L194">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L195">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L196">                .planItemInstanceState(PlanItemInstanceState.AVAILABLE)</span>
<span class="nc" id="L197">                .planItemDefinitionType(PlanItemDefinitionType.TIMER_EVENT_LISTENER)</span>
<span class="nc" id="L198">                .singleResult();</span>
<span class="nc" id="L199">        assertThat(planItemInstance).isNotNull();</span>

<span class="nc" id="L201">        assertThat(cmmnTaskService.createTaskQuery().count()).isZero();</span>

        // Timer fires after 1 day, so setting it to 1 day + 1 second
<span class="nc" id="L204">        setClockTo(new Date(startTime.getTime() + (24 * 60 * 60 * 1000 + 1)));</span>

<span class="nc" id="L206">        CmmnJobTestHelper.waitForJobExecutorToProcessAllJobs(cmmnEngineConfiguration, 7000L, 200L, true);</span>

        // User task should be active after the timer has triggered 
<span class="nc" id="L209">        assertThat(cmmnTaskService.createTaskQuery().count()).isEqualTo(2);</span>
<span class="nc" id="L210">    }</span>

    @Test
    @CmmnDeployment
    public void testTimerInStage() {
<span class="nc" id="L215">        Date startTime = setClockFixedToCurrentTime();</span>
<span class="nc" id="L216">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTimerInStage&quot;).start();</span>

<span class="nc" id="L218">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L219">                .count()).isEqualTo(1);</span>
<span class="nc" id="L220">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L221">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L222">                .planItemInstanceState(PlanItemInstanceState.AVAILABLE)</span>
<span class="nc" id="L223">                .planItemDefinitionType(PlanItemDefinitionType.TIMER_EVENT_LISTENER)</span>
<span class="nc" id="L224">                .singleResult();</span>
<span class="nc" id="L225">        assertThat(planItemInstance).isNotNull();</span>

<span class="nc" id="L227">        assertThat(cmmnTaskService.createTaskQuery().count()).isEqualTo(1);</span>

        // Timer fires after 3 hours, so setting it to 3 hours + 1 second
<span class="nc" id="L230">        setClockTo(new Date(startTime.getTime() + (3 * 60 * 60 * 1000 + 1)));</span>

<span class="nc" id="L232">        CmmnJobTestHelper.waitForJobExecutorToProcessAllJobs(cmmnEngineConfiguration, 7000L, 200L, true);</span>

        // User task should be active after the timer has triggered
<span class="nc" id="L235">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).orderByTaskName().asc().list();</span>
<span class="nc" id="L236">        assertThat(tasks)</span>
<span class="nc" id="L237">                .extracting(Task::getName)</span>
<span class="nc" id="L238">                .containsExactly(&quot;A&quot;, &quot;B&quot;);</span>
<span class="nc" id="L239">    }</span>

    @Test
    @CmmnDeployment
    public void testExitPlanModelOnTimerOccurrence() {
<span class="nc" id="L244">        Date startTime = setClockFixedToCurrentTime();</span>
<span class="nc" id="L245">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testStageExitOnTimerOccurrence&quot;).start();</span>

<span class="nc" id="L247">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L248">                .planItemInstanceState(PlanItemInstanceState.ACTIVE).planItemDefinitionType(PlanItemDefinitionType.HUMAN_TASK).count()).isEqualTo(3);</span>
<span class="nc" id="L249">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L250">                .planItemInstanceState(PlanItemInstanceState.AVAILABLE).planItemDefinitionType(PlanItemDefinitionType.TIMER_EVENT_LISTENER).count())</span>
<span class="nc" id="L251">                .isEqualTo(1);</span>
<span class="nc" id="L252">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L253">                .planItemInstanceState(PlanItemInstanceState.ACTIVE).planItemDefinitionType(PlanItemDefinitionType.STAGE).count()).isEqualTo(1);</span>
<span class="nc" id="L254">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L255">                .planItemInstanceState(PlanItemInstanceState.ACTIVE).count()).isEqualTo(4);</span>

        // Timer fires after 24 hours, so setting it to 24 hours + 1 second
<span class="nc" id="L258">        setClockTo(new Date(startTime.getTime() + (24 * 60 * 60 * 1000 + 1)));</span>

<span class="nc" id="L260">        CmmnJobTestHelper.waitForJobExecutorToProcessAllJobs(cmmnEngineConfiguration, 7000L, 200L, true);</span>

<span class="nc" id="L262">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>
<span class="nc" id="L263">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isZero();</span>
<span class="nc" id="L264">    }</span>

    @Test
    @CmmnDeployment
    public void testDateExpression() {

        // Timer will fire on 2017-12-05T10:00
        // So moving the clock to the day before
<span class="nc" id="L272">        Calendar calendar = Calendar.getInstance();</span>
<span class="nc" id="L273">        calendar.set(Calendar.YEAR, 2017);</span>
<span class="nc" id="L274">        calendar.set(Calendar.MONTH, 12);</span>
<span class="nc" id="L275">        calendar.set(Calendar.DAY_OF_MONTH, 4);</span>
<span class="nc" id="L276">        calendar.set(Calendar.HOUR, 11);</span>
<span class="nc" id="L277">        calendar.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L278">        Date dayBefore = calendar.getTime();</span>
<span class="nc" id="L279">        setClockTo(dayBefore);</span>

<span class="nc" id="L281">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testDateExpression&quot;).start();</span>

<span class="nc" id="L283">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L284">                .planItemInstanceState(PlanItemInstanceState.AVAILABLE).planItemDefinitionType(TimerEventListener.class.getSimpleName().toLowerCase()).count())</span>
<span class="nc" id="L285">                .isEqualTo(1);</span>
<span class="nc" id="L286">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L287">                .planItemInstanceState(PlanItemInstanceState.AVAILABLE).planItemDefinitionType(Stage.class.getSimpleName().toLowerCase()).count())</span>
<span class="nc" id="L288">                .isEqualTo(2);</span>
<span class="nc" id="L289">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L290">                .planItemInstanceState(PlanItemInstanceState.ACTIVE).planItemDefinitionType(Stage.class.getSimpleName().toLowerCase()).count()).isZero();</span>
<span class="nc" id="L291">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L292">                .planItemInstanceState(PlanItemInstanceState.ACTIVE).planItemDefinitionType(HumanTask.class.getSimpleName().toLowerCase()).count())</span>
<span class="nc" id="L293">                .isZero();</span>
<span class="nc" id="L294">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L295">                .planItemInstanceState(PlanItemInstanceState.AVAILABLE).planItemDefinitionType(HumanTask.class.getSimpleName().toLowerCase()).count())</span>
<span class="nc" id="L296">                .isEqualTo(1);</span>

<span class="nc" id="L298">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc" id="L300">        setClockTo(new Date(dayBefore.getTime() + (24 * 60 * 60 * 1000)));</span>
<span class="nc" id="L301">        CmmnJobTestHelper.waitForJobExecutorToProcessAllJobs(cmmnEngineConfiguration, 7000L, 200L, true);</span>

<span class="nc" id="L303">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L304">                .planItemInstanceState(PlanItemInstanceState.ACTIVE).planItemDefinitionType(TimerEventListener.class.getSimpleName().toLowerCase()).count())</span>
<span class="nc" id="L305">                .isZero();</span>

<span class="nc" id="L307">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L308">        assertThat(tasks).hasSize(3);</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">        for (Task task : tasks) {</span>
<span class="nc" id="L310">            cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L311">        }</span>

<span class="nc" id="L313">        assertCaseInstanceEnded(caseInstance);</span>
<span class="nc" id="L314">    }</span>

    @Test
    @CmmnDeployment
    public void testTimerWithBeanExpression() {
<span class="nc" id="L319">        Date startTime = setClockFixedToCurrentTime();</span>
<span class="nc" id="L320">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L321">                .caseDefinitionKey(&quot;testBean&quot;)</span>
<span class="nc" id="L322">                .variable(&quot;startTime&quot;, startTime)</span>
<span class="nc" id="L323">                .start();</span>

<span class="nc" id="L325">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(2);</span>

<span class="nc" id="L327">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L328">                .planItemInstanceState(PlanItemInstanceState.ACTIVE).planItemDefinitionType(Stage.class.getSimpleName().toLowerCase()).count()).isEqualTo(2);</span>
<span class="nc" id="L329">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L330">                .planItemInstanceState(PlanItemInstanceState.ACTIVE).planItemDefinitionType(HumanTask.class.getSimpleName().toLowerCase()).count())</span>
<span class="nc" id="L331">                .isEqualTo(2);</span>

<span class="nc" id="L333">        setClockTo(new Date(startTime.getTime() + (2 * 60 * 60 * 1000)));</span>
<span class="nc" id="L334">        CmmnJobTestHelper.waitForJobExecutorToProcessAllJobs(cmmnEngineConfiguration, 7000L, 200L, true);</span>

<span class="nc" id="L336">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L337">        assertThat(task.getName()).isEqualTo(&quot;A&quot;);</span>
<span class="nc" id="L338">        cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L339">        assertCaseInstanceEnded(caseInstance);</span>
<span class="nc" id="L340">    }</span>

    @Test
    @CmmnDeployment
    public void testTimerStartTrigger() {
        // Completing the stage will be the start trigger for the timer.
        // The timer event will exit the whole plan model

<span class="nc" id="L348">        Date startTime = setClockFixedToCurrentTime();</span>
<span class="nc" id="L349">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testStartTrigger&quot;).start();</span>

<span class="nc" id="L351">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L352">                .planItemDefinitionType(TimerEventListener.class.getSimpleName().toLowerCase()).count()).isEqualTo(1);</span>

<span class="nc" id="L354">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L355">        assertThat(task.getName()).isEqualTo(&quot;A&quot;);</span>
<span class="nc" id="L356">        cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L357">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L358">        assertThat(task.getName()).isEqualTo(&quot;B&quot;);</span>
<span class="nc" id="L359">        cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L360">        task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L361">        assertThat(task.getName()).isEqualTo(&quot;C&quot;);</span>

<span class="nc" id="L363">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L364">                .planItemInstanceState(PlanItemInstanceState.AVAILABLE).planItemDefinitionType(TimerEventListener.class.getSimpleName().toLowerCase()).count())</span>
<span class="nc" id="L365">                .isEqualTo(1);</span>

<span class="nc" id="L367">        setClockTo(new Date(startTime.getTime() + (3 * 60 * 60 * 1000)));</span>
<span class="nc" id="L368">        CmmnJobTestHelper.waitForJobExecutorToProcessAllJobs(cmmnEngineConfiguration, 7000L, 200L, true);</span>
<span class="nc" id="L369">        assertCaseInstanceEnded(caseInstance);</span>
<span class="nc" id="L370">    }</span>

    @Test
    @CmmnDeployment
    public void testExitNestedStageThroughTimer() {
<span class="nc" id="L375">        Date startTime = setClockFixedToCurrentTime();</span>
<span class="nc" id="L376">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testExitNestedStageThroughTimer&quot;).start();</span>
<span class="nc" id="L377">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).planItemDefinitionType(PlanItemDefinitionType.STAGE)</span>
<span class="nc" id="L378">                .count()).isEqualTo(3);</span>
<span class="nc" id="L379">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L380">        assertThat(task.getName()).isEqualTo(&quot;The task&quot;);</span>

<span class="nc" id="L382">        setClockTo(new Date(startTime.getTime() + (5 * 60 * 60 * 1000)));</span>
<span class="nc" id="L383">        CmmnJobTestHelper.waitForJobExecutorToProcessAllJobs(cmmnEngineConfiguration, 10000L, 100L, true);</span>
<span class="nc" id="L384">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>
<span class="nc" id="L385">        assertCaseInstanceEnded(caseInstance);</span>
<span class="nc" id="L386">    }</span>

    @Test
    @CmmnDeployment
    public void timerActivatesAndExitStages() {
<span class="nc" id="L391">        Date startTime = setClockFixedToCurrentTime();</span>
<span class="nc" id="L392">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;timerActivatesAndExitStages&quot;).start();</span>

<span class="nc" id="L394">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery()</span>
<span class="nc" id="L395">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L396">                .orderByTaskName().asc()</span>
<span class="nc" id="L397">                .list();</span>
<span class="nc" id="L398">        assertThat(tasks)</span>
<span class="nc" id="L399">                .extracting(Task::getName)</span>
<span class="nc" id="L400">                .containsExactly(&quot;A&quot;, &quot;B&quot;);</span>

<span class="nc" id="L402">        assertThat(cmmnManagementService.createTimerJobQuery().count()).isZero();</span>

        // Completing A activates the stage and the timer event listener
<span class="nc" id="L405">        cmmnTaskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L406">        cmmnTaskService.complete(tasks.get(1).getId());</span>

        // Timer event listener created a timer job
<span class="nc" id="L409">        assertThat(cmmnManagementService.createTimerJobQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L410">        tasks = cmmnTaskService.createTaskQuery()</span>
<span class="nc" id="L411">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L412">                .orderByTaskName().asc()</span>
<span class="nc" id="L413">                .list();</span>
<span class="nc" id="L414">        assertThat(tasks)</span>
<span class="nc" id="L415">                .extracting(Task::getName)</span>
<span class="nc" id="L416">                .containsExactly(&quot;Stage 1 task&quot;, &quot;Stage 3 task 1&quot;, &quot;Stage 3 task 2&quot;);</span>

        // Timer is set to 10 hours
<span class="nc" id="L419">        setClockTo(new Date(startTime.getTime() + (11 * 60 * 60 * 1000)));</span>
<span class="nc" id="L420">        CmmnJobTestHelper.waitForJobExecutorToProcessAllJobs(cmmnEngineConfiguration, 10000L, 100L, true);</span>

<span class="nc" id="L422">        tasks = cmmnTaskService.createTaskQuery()</span>
<span class="nc" id="L423">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L424">                .orderByTaskName().asc()</span>
<span class="nc" id="L425">                .list();</span>
<span class="nc" id="L426">        assertThat(tasks)</span>
<span class="nc" id="L427">                .extracting(Task::getName)</span>
<span class="nc" id="L428">                .containsExactly(&quot;Stage 1 task&quot;, &quot;Stage 2 task&quot;);</span>

<span class="nc bnc" id="L430" title="All 2 branches missed.">        for (Task task : tasks) {</span>
<span class="nc" id="L431">            cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L432">        }</span>
<span class="nc" id="L433">        assertCaseInstanceEnded(caseInstance);</span>
<span class="nc" id="L434">    }</span>

    @Test
    @CmmnDeployment
    public void timerExitStageOnCompletedTasks() {
<span class="nc" id="L439">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;timerExitStageOnCompletedTasks&quot;).start();</span>

<span class="nc" id="L441">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery()</span>
<span class="nc" id="L442">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L443">                .orderByTaskName().asc()</span>
<span class="nc" id="L444">                .list();</span>
<span class="nc" id="L445">        assertThat(tasks).hasSize(1);</span>

        // Should have a TimerJob
<span class="nc" id="L448">        assertThat(cmmnManagementService.createTimerJobQuery().count()).isEqualTo(1);</span>

<span class="nc bnc" id="L450" title="All 2 branches missed.">        for (Task task : tasks) {</span>
<span class="nc" id="L451">            cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L452">        }</span>

        // TimerJob should be deleted after all tasks have completed in the stage
<span class="nc" id="L455">        assertThat(cmmnManagementService.createTimerJobQuery().count()).isZero();</span>
<span class="nc" id="L456">    }</span>

    @Test
    @CmmnDeployment
    public void testTimerWithAvailableCondition() {
<span class="nc" id="L461">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTimerExpression&quot;).start();</span>

<span class="nc" id="L463">        assertThat(cmmnManagementService.createTimerJobQuery().count()).isZero();</span>

        // Setting the variable should make the timer available and create the timer job
<span class="nc" id="L466">        cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;timerVar&quot;, true);</span>
<span class="nc" id="L467">        assertThat(cmmnManagementService.createTimerJobQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L469">        PlanItemInstance timerPlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L470">                .planItemDefinitionType(PlanItemDefinitionType.TIMER_EVENT_LISTENER).singleResult();</span>
<span class="nc" id="L471">        assertThat(timerPlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>

        // Setting the variable to false again will dismiss the timer
<span class="nc" id="L474">        cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;timerVar&quot;, false);</span>
<span class="nc" id="L475">        assertThat(cmmnManagementService.createTimerJobQuery().count()).isZero();</span>
<span class="nc" id="L476">        timerPlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().planItemDefinitionType(PlanItemDefinitionType.TIMER_EVENT_LISTENER)</span>
<span class="nc" id="L477">                .singleResult();</span>
<span class="nc" id="L478">        assertThat(timerPlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.UNAVAILABLE);</span>

<span class="nc" id="L480">        cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;timerVar&quot;, true);</span>
<span class="nc" id="L481">        assertThat(cmmnManagementService.createTimerJobQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L482">        timerPlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().planItemDefinitionType(PlanItemDefinitionType.TIMER_EVENT_LISTENER)</span>
<span class="nc" id="L483">                .singleResult();</span>
<span class="nc" id="L484">        assertThat(timerPlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>

        // Execute the job
<span class="nc" id="L487">        Job timerJob = cmmnManagementService.createTimerJobQuery().scopeDefinitionId(caseInstance.getCaseDefinitionId()).singleResult();</span>
<span class="nc" id="L488">        assertThat(timerJob).isNotNull();</span>
<span class="nc" id="L489">        cmmnManagementService.moveTimerToExecutableJob(timerJob.getId());</span>
<span class="nc" id="L490">        cmmnManagementService.executeJob(timerJob.getId());</span>

<span class="nc" id="L492">        timerPlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().planItemDefinitionType(PlanItemDefinitionType.TIMER_EVENT_LISTENER)</span>
<span class="nc" id="L493">                .includeEnded().singleResult();</span>
<span class="nc" id="L494">        assertThat(timerPlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.COMPLETED);</span>
<span class="nc" id="L495">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/eventlistener/TimerEventListenerTest.testTimerWithVariableExpression.cmmn&quot;)
    public void testTimerWithInstantVariableExpression() {
<span class="nc" id="L500">        setClockTo(Date.from(Instant.parse(&quot;2020-10-21T08:31:45.585Z&quot;)));</span>
<span class="nc" id="L501">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L502">                .caseDefinitionKey(&quot;testVariable&quot;)</span>
<span class="nc" id="L503">                .variable(&quot;startTime&quot;, Instant.parse(&quot;2020-10-21T08:31:46.585Z&quot;))</span>
<span class="nc" id="L504">                .start();</span>

<span class="nc" id="L506">        assertThat(cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(2);</span>

<span class="nc" id="L508">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L509">                .planItemInstanceState(PlanItemInstanceState.ACTIVE).planItemDefinitionType(PlanItemDefinitionType.STAGE).count()).isEqualTo(2);</span>
<span class="nc" id="L510">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L511">                .planItemInstanceState(PlanItemInstanceState.ACTIVE).planItemDefinitionType(PlanItemDefinitionType.HUMAN_TASK).count())</span>
<span class="nc" id="L512">                .isEqualTo(2);</span>

<span class="nc" id="L514">        setClockTo(Date.from(Instant.parse(&quot;2020-10-21T08:31:47.585Z&quot;)));</span>
<span class="nc" id="L515">        waitForJobExecutorToProcessAllJobs();</span>

<span class="nc" id="L517">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L518">        assertThat(task.getName()).isEqualTo(&quot;A&quot;);</span>
<span class="nc" id="L519">        cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L520">        assertCaseInstanceEnded(caseInstance);</span>
<span class="nc" id="L521">    }</span>

    @Test
    @CmmnDeployment
    public void testRepeatingTimer() {

<span class="nc" id="L527">        Date startTime = new Date();</span>
<span class="nc" id="L528">        cmmnEngineConfiguration.getClock().setCurrentTime(startTime);</span>

<span class="nc" id="L530">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;repeatingTimer&quot;).start();</span>
<span class="nc" id="L531">        assertThat(cmmnManagementService.createTimerJobQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>

<span class="nc" id="L533">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().orderByName().asc().list();</span>
<span class="nc" id="L534">        assertThat(planItemInstances)</span>
<span class="nc" id="L535">                .extracting(PlanItemInstance::getName, PlanItemInstance::getState)</span>
<span class="nc" id="L536">                        .containsExactly(</span>
<span class="nc" id="L537">                                tuple(&quot;A&quot;, PlanItemInstanceState.AVAILABLE),</span>
<span class="nc" id="L538">                                tuple(&quot;Human task&quot;, PlanItemInstanceState.ACTIVE),</span>
<span class="nc" id="L539">                                tuple(&quot;Timer&quot;, PlanItemInstanceState.AVAILABLE)</span>
                                );

        // Repeat is set to 20S
<span class="nc" id="L543">        Date newTime = new Date(startTime.getTime() + 30_000);</span>
<span class="nc" id="L544">        cmmnEngineConfiguration.getClock().setCurrentTime(newTime);</span>

<span class="nc" id="L546">        Job job = cmmnManagementService.moveTimerToExecutableJob(cmmnManagementService.createTimerJobQuery().singleResult().getId());</span>
<span class="nc" id="L547">        cmmnManagementService.executeJob(job.getId());</span>

<span class="nc" id="L549">        assertThat(cmmnManagementService.createTimerJobQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>

<span class="nc" id="L551">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().orderByName().asc().list();</span>
<span class="nc" id="L552">        assertThat(planItemInstances)</span>
<span class="nc" id="L553">                .extracting(PlanItemInstance::getName, PlanItemInstance::getState)</span>
<span class="nc" id="L554">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L555">                        tuple(&quot;A&quot;, PlanItemInstanceState.ACTIVE),</span>
<span class="nc" id="L556">                        tuple(&quot;A&quot;, PlanItemInstanceState.WAITING_FOR_REPETITION),</span>
<span class="nc" id="L557">                        tuple(&quot;Human task&quot;, PlanItemInstanceState.ACTIVE),</span>
<span class="nc" id="L558">                        tuple(&quot;Timer&quot;, PlanItemInstanceState.AVAILABLE),</span>
<span class="nc" id="L559">                        tuple(&quot;Timer&quot;, PlanItemInstanceState.COMPLETED)</span>
                );

<span class="nc" id="L562">        job = cmmnManagementService.moveTimerToExecutableJob(cmmnManagementService.createTimerJobQuery().singleResult().getId());</span>
<span class="nc" id="L563">        cmmnManagementService.executeJob(job.getId());</span>

<span class="nc" id="L565">        assertThat(cmmnManagementService.createTimerJobQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>

<span class="nc" id="L567">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().orderByName().asc().list();</span>
<span class="nc" id="L568">        assertThat(planItemInstances)</span>
<span class="nc" id="L569">                .extracting(PlanItemInstance::getName, PlanItemInstance::getState)</span>
<span class="nc" id="L570">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L571">                        tuple(&quot;A&quot;, PlanItemInstanceState.ACTIVE),</span>
<span class="nc" id="L572">                        tuple(&quot;A&quot;, PlanItemInstanceState.ACTIVE),</span>
<span class="nc" id="L573">                        tuple(&quot;A&quot;, PlanItemInstanceState.WAITING_FOR_REPETITION),</span>
<span class="nc" id="L574">                        tuple(&quot;Human task&quot;, PlanItemInstanceState.ACTIVE),</span>
<span class="nc" id="L575">                        tuple(&quot;Timer&quot;, PlanItemInstanceState.AVAILABLE),</span>
<span class="nc" id="L576">                        tuple(&quot;Timer&quot;, PlanItemInstanceState.COMPLETED),</span>
<span class="nc" id="L577">                        tuple(&quot;Timer&quot;, PlanItemInstanceState.COMPLETED)</span>
                );
<span class="nc" id="L579">    }</span>

    @Test
    @CmmnDeployment
    public void testRepeatingTimerWithAvailableCondition() {
<span class="nc" id="L584">        Date time = new Date();</span>
<span class="nc" id="L585">        cmmnEngineConfiguration.getClock().setCurrentTime(time);</span>

<span class="nc" id="L587">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;repeatingTimer&quot;).start();</span>
<span class="nc" id="L588">        assertThat(cmmnManagementService.createTimerJobQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>

<span class="nc" id="L590">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().orderByName().asc().list();</span>
<span class="nc" id="L591">        assertThat(planItemInstances)</span>
<span class="nc" id="L592">                .extracting(PlanItemInstance::getName, PlanItemInstance::getState)</span>
<span class="nc" id="L593">                .containsExactly(</span>
<span class="nc" id="L594">                        tuple(&quot;A&quot;, PlanItemInstanceState.AVAILABLE),</span>
<span class="nc" id="L595">                        tuple(&quot;Human task&quot;, PlanItemInstanceState.ACTIVE),</span>
<span class="nc" id="L596">                        tuple(&quot;Timer&quot;, PlanItemInstanceState.AVAILABLE)</span>
                );


<span class="nc bnc" id="L600" title="All 2 branches missed.">        for (int i = 1; i &lt; 9; i++) {</span>

            // Repeat is set to 20S
<span class="nc" id="L603">            Date newTime = new Date(time.getTime() + 30_000);</span>
<span class="nc" id="L604">            cmmnEngineConfiguration.getClock().setCurrentTime(newTime);</span>
<span class="nc" id="L605">            time = newTime;</span>

<span class="nc" id="L607">            Job job = cmmnManagementService.moveTimerToExecutableJob(cmmnManagementService.createTimerJobQuery().singleResult().getId());</span>
<span class="nc" id="L608">            cmmnManagementService.executeJob(job.getId());</span>

<span class="nc" id="L610">            assertThat(cmmnManagementService.createTimerJobQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>

<span class="nc" id="L612">            Tuple[] expectedTuples = new Tuple[3 + (i * 2)];</span>
<span class="nc" id="L613">            expectedTuples[0] = tuple(&quot;A&quot;, PlanItemInstanceState.WAITING_FOR_REPETITION);</span>
<span class="nc" id="L614">            expectedTuples[1] = tuple(&quot;Human task&quot;, PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L615">            expectedTuples[2] = tuple(&quot;Timer&quot;, PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L616">            int currentIndex = 2;</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">            for (int j = 0; j &lt; i; j++) {</span>
<span class="nc" id="L618">                expectedTuples[++currentIndex] = tuple(&quot;A&quot;, PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L619">                expectedTuples[++currentIndex] = tuple(&quot;Timer&quot;, PlanItemInstanceState.COMPLETED);</span>
            }

<span class="nc" id="L622">            planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().orderByName().asc().list();</span>
<span class="nc" id="L623">            assertThat(planItemInstances)</span>
<span class="nc" id="L624">                    .extracting(PlanItemInstance::getName, PlanItemInstance::getState)</span>
<span class="nc" id="L625">                    .containsExactlyInAnyOrder(expectedTuples);</span>
        }

<span class="nc" id="L628">    }</span>

    @Test
    @CmmnDeployment
    public void testRepeatingTimerWithChangingAvailableCondition() {
<span class="nc" id="L633">        Date time = new Date();</span>
<span class="nc" id="L634">        cmmnEngineConfiguration.getClock().setCurrentTime(time);</span>

<span class="nc" id="L636">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L637">                .variable(&quot;timerActive&quot;, false)</span>
<span class="nc" id="L638">                .caseDefinitionKey(&quot;repeatingTimer&quot;)</span>
<span class="nc" id="L639">                .start();</span>
<span class="nc" id="L640">        assertThat(cmmnManagementService.createTimerJobQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(0);</span>

<span class="nc bnc" id="L642" title="All 2 branches missed.">        for (int i = 1; i &lt; 12; i++) {</span>

<span class="nc" id="L644">            cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;timerActive&quot;, true);</span>
<span class="nc" id="L645">            assertThat(cmmnManagementService.createTimerJobQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>

            // Repeat is set to 20S
<span class="nc" id="L648">            Date newTime = new Date(time.getTime() + 30_000);</span>
<span class="nc" id="L649">            cmmnEngineConfiguration.getClock().setCurrentTime(newTime);</span>
<span class="nc" id="L650">            time = newTime;</span>

<span class="nc" id="L652">            Job job = cmmnManagementService.moveTimerToExecutableJob(cmmnManagementService.createTimerJobQuery().singleResult().getId());</span>
<span class="nc" id="L653">            cmmnManagementService.executeJob(job.getId());</span>

<span class="nc" id="L655">            assertThat(cmmnManagementService.createTimerJobQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(1);</span>

<span class="nc" id="L657">            Tuple[] expectedTuples = new Tuple[3 + (i * 2)];</span>
<span class="nc" id="L658">            expectedTuples[0] = tuple(&quot;A&quot;, PlanItemInstanceState.WAITING_FOR_REPETITION);</span>
<span class="nc" id="L659">            expectedTuples[1] = tuple(&quot;Human task&quot;, PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L660">            expectedTuples[2] = tuple(&quot;Timer&quot;, PlanItemInstanceState.AVAILABLE);</span>
<span class="nc" id="L661">            int currentIndex = 2;</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">            for (int j = 0; j &lt; i; j++) {</span>
<span class="nc" id="L663">                expectedTuples[++currentIndex] = tuple(&quot;A&quot;, PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L664">                expectedTuples[++currentIndex] = tuple(&quot;Timer&quot;, PlanItemInstanceState.COMPLETED);</span>
            }

<span class="nc" id="L667">            List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().orderByName().asc().list();</span>
<span class="nc" id="L668">            assertThat(planItemInstances)</span>
<span class="nc" id="L669">                    .extracting(PlanItemInstance::getName, PlanItemInstance::getState)</span>
<span class="nc" id="L670">                    .containsExactlyInAnyOrder(expectedTuples);</span>

<span class="nc" id="L672">            cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;timerActive&quot;, false);</span>
<span class="nc" id="L673">            assertThat(cmmnManagementService.createTimerJobQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(0);</span>
        }
<span class="nc" id="L675">    }</span>

    @Test
    @CmmnDeployment
    public void testLimitedRepeatingTimerWithAvailableCondition() {

        // The repeat is limited to 4 times here

<span class="nc" id="L683">        Date time = new Date();</span>
<span class="nc" id="L684">        cmmnEngineConfiguration.getClock().setCurrentTime(time);</span>
<span class="nc" id="L685">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;repeatingTimer&quot;).start();</span>

<span class="nc" id="L687">        int nrOfTimerJobsExecuted = 0;</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">        for (int i = 0; i &lt; 10; i++) {</span>

            // Repeat is set to 20S
<span class="nc" id="L691">            Date newTime = new Date(time.getTime() + 21_000);</span>
<span class="nc" id="L692">            cmmnEngineConfiguration.getClock().setCurrentTime(newTime);</span>
<span class="nc" id="L693">            time = newTime;</span>

<span class="nc bnc" id="L695" title="All 2 branches missed.">            if (cmmnManagementService.createTimerJobQuery().count() &gt; 0) {</span>
<span class="nc" id="L696">                Job job = cmmnManagementService.moveTimerToExecutableJob(cmmnManagementService.createTimerJobQuery().singleResult().getId());</span>
<span class="nc" id="L697">                cmmnManagementService.executeJob(job.getId());</span>

<span class="nc" id="L699">                nrOfTimerJobsExecuted++;</span>
            }
        }

<span class="nc" id="L703">        assertThat(nrOfTimerJobsExecuted).isEqualTo(4);</span>
<span class="nc" id="L704">        assertThat(cmmnManagementService.createTimerJobQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(0);</span>
<span class="nc" id="L705">    }</span>

    @Test
    @CmmnDeployment
    public void testLimitedRepeatingTimerWithChangingAvailableCondition() {

        // The repeat is limited to 4 times here

<span class="nc" id="L713">        Date time = new Date();</span>
<span class="nc" id="L714">        cmmnEngineConfiguration.getClock().setCurrentTime(time);</span>
<span class="nc" id="L715">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L716">                .variable(&quot;timerActive&quot;, true)</span>
<span class="nc" id="L717">                .caseDefinitionKey(&quot;repeatingTimer&quot;)</span>
<span class="nc" id="L718">                .start();</span>

<span class="nc" id="L720">        int nrOfTimerJobsExecuted = 0;</span>
<span class="nc bnc" id="L721" title="All 2 branches missed.">        for (int i = 0; i &lt; 10; i++) {</span>

            // Repeat is set to 20S
<span class="nc" id="L724">            Date newTime = new Date(time.getTime() + 21_000);</span>
<span class="nc" id="L725">            cmmnEngineConfiguration.getClock().setCurrentTime(newTime);</span>
<span class="nc" id="L726">            time = newTime;</span>

            // When the availableCondition is true again, the repetition starts form the beginning
<span class="nc bnc" id="L729" title="All 2 branches missed.">            if (i == 2) {</span>
<span class="nc" id="L730">                cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;timerActive&quot;, false);</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">            } else if (i == 4) {</span>
<span class="nc" id="L732">                cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;timerActive&quot;, true);</span>
            }

<span class="nc bnc" id="L735" title="All 2 branches missed.">            if (cmmnManagementService.createTimerJobQuery().count() &gt; 0) {</span>
<span class="nc" id="L736">                Job job = cmmnManagementService.moveTimerToExecutableJob(cmmnManagementService.createTimerJobQuery().singleResult().getId());</span>
<span class="nc" id="L737">                cmmnManagementService.executeJob(job.getId());</span>

<span class="nc" id="L739">                nrOfTimerJobsExecuted++;</span>
            }

        }

<span class="nc" id="L744">        assertThat(nrOfTimerJobsExecuted).isEqualTo(6); // should 2 from first part and then 4, because it continued until the 4 times were used up</span>

<span class="nc" id="L746">        cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;timerActive&quot;, true);</span>
<span class="nc" id="L747">        assertThat(cmmnManagementService.createTimerJobQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(0);</span>
<span class="nc" id="L748">    }</span>

    @Test
    @CmmnDeployment
    public void testDateTypes() throws ParseException {
<span class="nc" id="L753">        Date date = new SimpleDateFormat(&quot;dd-MM-yyyy hh:mm:ss XXX&quot;).parse(&quot;30-01-2024 10:28:00 +01:00&quot;);</span>
<span class="nc" id="L754">        Instant instant = date.toInstant();</span>
<span class="nc" id="L755">        LocalDate localDate = LocalDate.of(2024, 1, 30);</span>
<span class="nc" id="L756">        LocalDateTime localDateTime = LocalDateTime.of(2024, 1, 30, 10, 22);</span>

<span class="nc" id="L758">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L759">                .caseDefinitionKey(&quot;testTimerEventDateTypes&quot;)</span>
<span class="nc" id="L760">                .variable(&quot;taskDate&quot;, date)</span>
<span class="nc" id="L761">                .variable(&quot;taskInstant&quot;, instant)</span>
<span class="nc" id="L762">                .variable(&quot;taskLocalDate&quot;, localDate)</span>
<span class="nc" id="L763">                .variable(&quot;taskLocalDateTime&quot;, localDateTime)</span>
<span class="nc" id="L764">                .variable(&quot;taskDateString&quot;, &quot;2024-01-30T10:28:00+01:00&quot;)</span>
<span class="nc" id="L765">                .start();</span>

        // The case model has 5 timer event listeners, each with a user task afer it.
        // The fact that the user task exists, means that the date variable was able to be parsed.

<span class="nc" id="L770">        cmmnManagementService.createTimerJobQuery().caseInstanceId(caseInstance.getId()).list()</span>
<span class="nc" id="L771">                .forEach(t -&gt; cmmnManagementService.moveTimerToExecutableJob(t.getId()));</span>
<span class="nc" id="L772">        cmmnManagementService.createJobQuery().list().forEach(j -&gt; cmmnManagementService.executeJob(j.getId()));</span>

<span class="nc" id="L774">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L775">        assertThat(tasks).extracting(Task::getName).containsExactlyInAnyOrder(</span>
                &quot;dateTask&quot;, &quot;instantTask&quot;, &quot;localDateTask&quot;, &quot;localDateTimeTask&quot;, &quot;dateStringTask&quot;
        );
<span class="nc" id="L778">    }</span>

    @Test
    @CmmnDeployment
    public void testTimerRescheduleWithDate() {
<span class="nc" id="L783">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTimerExpression&quot;).start();</span>
<span class="nc" id="L784">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemDefinitionType(PlanItemDefinitionType.TIMER_EVENT_LISTENER)</span>
<span class="nc" id="L785">                .planItemInstanceStateAvailable().singleResult()).isNotNull();</span>
<span class="nc" id="L786">        assertThat(cmmnManagementService.createTimerJobQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L787">        assertThat(cmmnManagementService.createTimerJobQuery().scopeId(caseInstance.getId()).scopeType(ScopeTypes.CMMN).count()).isEqualTo(1);</span>

<span class="nc" id="L789">        Job timerJob = cmmnManagementService.createTimerJobQuery().scopeId(caseInstance.getId()).singleResult();</span>
        
<span class="nc" id="L791">        Calendar newDueDateCal = new GregorianCalendar();</span>
<span class="nc" id="L792">        newDueDateCal.add(Calendar.DATE, 20);</span>
<span class="nc" id="L793">        Job newTimerJob = cmmnManagementService.rescheduleTimeDateJob(timerJob.getId(), newDueDateCal.getTime());</span>
        
<span class="nc" id="L795">        Calendar compareCal = new GregorianCalendar();</span>
<span class="nc" id="L796">        compareCal.add(Calendar.DATE, 19);</span>
        
<span class="nc" id="L798">        assertThat(newTimerJob.getId()).isNotEqualTo(timerJob.getId());</span>
<span class="nc" id="L799">        assertThat(newTimerJob.getDuedate()).isAfter(compareCal.getTime());</span>
        
<span class="nc" id="L801">        Job dbTimerJob = cmmnManagementService.createTimerJobQuery().scopeId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L802">        assertThat(dbTimerJob.getId()).isEqualTo(newTimerJob.getId());</span>
<span class="nc" id="L803">        assertThat(dbTimerJob.getDuedate()).isAfter(compareCal.getTime());</span>
        
<span class="nc bnc" id="L805" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L806">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().list())</span>
<span class="nc" id="L807">                    .extracting(HistoricPlanItemInstance::getPlanItemDefinitionType, HistoricPlanItemInstance::getPlanItemDefinitionId, HistoricPlanItemInstance::getState)</span>
<span class="nc" id="L808">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L809">                            tuple(PlanItemDefinitionType.TIMER_EVENT_LISTENER, &quot;timerListener&quot;, PlanItemInstanceState.AVAILABLE),</span>
<span class="nc" id="L810">                            tuple(PlanItemDefinitionType.HUMAN_TASK, &quot;taskA&quot;, PlanItemInstanceState.AVAILABLE)</span>
                    );
        }
<span class="nc" id="L813">    }</span>
    
    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/eventlistener/TimerEventListenerTest.testTimerRescheduleWithDate.cmmn&quot;)
    public void testWrongTimerRescheduleWithDate() {
<span class="nc" id="L818">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTimerExpression&quot;).start();</span>
<span class="nc" id="L819">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemDefinitionType(PlanItemDefinitionType.TIMER_EVENT_LISTENER)</span>
<span class="nc" id="L820">                .planItemInstanceStateAvailable().singleResult()).isNotNull();</span>
<span class="nc" id="L821">        assertThat(cmmnManagementService.createTimerJobQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L822">        assertThat(cmmnManagementService.createTimerJobQuery().scopeId(caseInstance.getId()).scopeType(ScopeTypes.CMMN).count()).isEqualTo(1);</span>

<span class="nc" id="L824">        Calendar newDueDateCal = new GregorianCalendar();</span>
<span class="nc" id="L825">        newDueDateCal.add(Calendar.DATE, 20);</span>
<span class="nc" id="L826">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L827">            cmmnManagementService.rescheduleTimeDateJob(&quot;wrongid&quot;, newDueDateCal.getTime());</span>
<span class="nc" id="L828">        }).isInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L829">            .hasMessageContaining(&quot;Timer job not found for id wrongid&quot;);</span>
<span class="nc" id="L830">    }</span>
    
    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/eventlistener/TimerEventListenerTest.testTimerRescheduleWithDate.cmmn&quot;)
    public void testTimerRescheduleWithDateValue() {
<span class="nc" id="L835">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTimerExpression&quot;).start();</span>
<span class="nc" id="L836">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemDefinitionType(PlanItemDefinitionType.TIMER_EVENT_LISTENER)</span>
<span class="nc" id="L837">                .planItemInstanceStateAvailable().singleResult()).isNotNull();</span>
<span class="nc" id="L838">        assertThat(cmmnManagementService.createTimerJobQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L839">        assertThat(cmmnManagementService.createTimerJobQuery().scopeId(caseInstance.getId()).scopeType(ScopeTypes.CMMN).count()).isEqualTo(1);</span>

<span class="nc" id="L841">        Job timerJob = cmmnManagementService.createTimerJobQuery().scopeId(caseInstance.getId()).singleResult();</span>
        
<span class="nc" id="L843">        Job newTimerJob = cmmnManagementService.rescheduleTimeDateValueJob(timerJob.getId(), &quot;P20D&quot;);</span>
        
<span class="nc" id="L845">        Calendar compareCal = new GregorianCalendar();</span>
<span class="nc" id="L846">        compareCal.add(Calendar.DATE, 19);</span>
        
<span class="nc" id="L848">        assertThat(newTimerJob.getId()).isNotEqualTo(timerJob.getId());</span>
<span class="nc" id="L849">        assertThat(newTimerJob.getDuedate()).isAfter(compareCal.getTime());</span>
        
<span class="nc" id="L851">        Job dbTimerJob = cmmnManagementService.createTimerJobQuery().scopeId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L852">        assertThat(dbTimerJob.getId()).isEqualTo(newTimerJob.getId());</span>
<span class="nc" id="L853">        assertThat(dbTimerJob.getDuedate()).isAfter(compareCal.getTime());</span>
        
<span class="nc bnc" id="L855" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L856">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().list())</span>
<span class="nc" id="L857">                    .extracting(HistoricPlanItemInstance::getPlanItemDefinitionType, HistoricPlanItemInstance::getPlanItemDefinitionId, HistoricPlanItemInstance::getState)</span>
<span class="nc" id="L858">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L859">                            tuple(PlanItemDefinitionType.TIMER_EVENT_LISTENER, &quot;timerListener&quot;, PlanItemInstanceState.AVAILABLE),</span>
<span class="nc" id="L860">                            tuple(PlanItemDefinitionType.HUMAN_TASK, &quot;taskA&quot;, PlanItemInstanceState.AVAILABLE)</span>
                    );
        }
<span class="nc" id="L863">    }</span>
    
    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/eventlistener/TimerEventListenerTest.testTimerRescheduleWithDate.cmmn&quot;)
    public void testTimerEventListenerInstanceRescheduleWithDate() {
<span class="nc" id="L868">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTimerExpression&quot;).start();</span>
<span class="nc" id="L869">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemDefinitionType(PlanItemDefinitionType.TIMER_EVENT_LISTENER)</span>
<span class="nc" id="L870">                .planItemInstanceStateAvailable().singleResult()).isNotNull();</span>
<span class="nc" id="L871">        assertThat(cmmnManagementService.createTimerJobQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L872">        assertThat(cmmnManagementService.createTimerJobQuery().scopeId(caseInstance.getId()).scopeType(ScopeTypes.CMMN).count()).isEqualTo(1);</span>

<span class="nc" id="L874">        Job timerJob = cmmnManagementService.createTimerJobQuery().scopeId(caseInstance.getId()).singleResult();</span>
        
<span class="nc" id="L876">        Calendar newDueDateCal = new GregorianCalendar();</span>
<span class="nc" id="L877">        newDueDateCal.add(Calendar.DATE, 20);</span>
<span class="nc" id="L878">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().planItemDefinitionType(PlanItemDefinitionType.TIMER_EVENT_LISTENER).caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L879">        Job newTimerJob = cmmnManagementService.rescheduleTimerEventListenerInstanceWithDate(planItemInstance.getId(), newDueDateCal.getTime());</span>
        
<span class="nc" id="L881">        Calendar compareCal = new GregorianCalendar();</span>
<span class="nc" id="L882">        compareCal.add(Calendar.DATE, 19);</span>
        
<span class="nc" id="L884">        assertThat(newTimerJob.getId()).isNotEqualTo(timerJob.getId());</span>
<span class="nc" id="L885">        assertThat(newTimerJob.getDuedate()).isAfter(compareCal.getTime());</span>
        
<span class="nc" id="L887">        Job dbTimerJob = cmmnManagementService.createTimerJobQuery().scopeId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L888">        assertThat(dbTimerJob.getId()).isEqualTo(newTimerJob.getId());</span>
<span class="nc" id="L889">        assertThat(dbTimerJob.getDuedate()).isAfter(compareCal.getTime());</span>
        
<span class="nc bnc" id="L891" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L892">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().list())</span>
<span class="nc" id="L893">                    .extracting(HistoricPlanItemInstance::getPlanItemDefinitionType, HistoricPlanItemInstance::getPlanItemDefinitionId, HistoricPlanItemInstance::getState)</span>
<span class="nc" id="L894">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L895">                            tuple(PlanItemDefinitionType.TIMER_EVENT_LISTENER, &quot;timerListener&quot;, PlanItemInstanceState.AVAILABLE),</span>
<span class="nc" id="L896">                            tuple(PlanItemDefinitionType.HUMAN_TASK, &quot;taskA&quot;, PlanItemInstanceState.AVAILABLE)</span>
                    );
        }
<span class="nc" id="L899">    }</span>
    
    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/eventlistener/TimerEventListenerTest.testTimerRescheduleWithDate.cmmn&quot;)
    public void testTimerEventListenerInstanceRescheduleWithDateValue() {
<span class="nc" id="L904">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTimerExpression&quot;).start();</span>
<span class="nc" id="L905">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemDefinitionType(PlanItemDefinitionType.TIMER_EVENT_LISTENER)</span>
<span class="nc" id="L906">                .planItemInstanceStateAvailable().singleResult()).isNotNull();</span>
<span class="nc" id="L907">        assertThat(cmmnManagementService.createTimerJobQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L908">        assertThat(cmmnManagementService.createTimerJobQuery().scopeId(caseInstance.getId()).scopeType(ScopeTypes.CMMN).count()).isEqualTo(1);</span>

<span class="nc" id="L910">        Job timerJob = cmmnManagementService.createTimerJobQuery().scopeId(caseInstance.getId()).singleResult();</span>
        
<span class="nc" id="L912">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().planItemDefinitionType(PlanItemDefinitionType.TIMER_EVENT_LISTENER).caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L913">        Job newTimerJob = cmmnManagementService.rescheduleTimerEventListenerInstanceWithDateValue(planItemInstance.getId(), &quot;P20D&quot;);</span>
        
<span class="nc" id="L915">        Calendar compareCal = new GregorianCalendar();</span>
<span class="nc" id="L916">        compareCal.add(Calendar.DATE, 19);</span>
        
<span class="nc" id="L918">        assertThat(newTimerJob.getId()).isNotEqualTo(timerJob.getId());</span>
<span class="nc" id="L919">        assertThat(newTimerJob.getDuedate()).isAfter(compareCal.getTime());</span>
        
<span class="nc" id="L921">        Job dbTimerJob = cmmnManagementService.createTimerJobQuery().scopeId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L922">        assertThat(dbTimerJob.getId()).isEqualTo(newTimerJob.getId());</span>
<span class="nc" id="L923">        assertThat(dbTimerJob.getDuedate()).isAfter(compareCal.getTime());</span>
        
<span class="nc bnc" id="L925" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L926">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().list())</span>
<span class="nc" id="L927">                    .extracting(HistoricPlanItemInstance::getPlanItemDefinitionType, HistoricPlanItemInstance::getPlanItemDefinitionId, HistoricPlanItemInstance::getState)</span>
<span class="nc" id="L928">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L929">                            tuple(PlanItemDefinitionType.TIMER_EVENT_LISTENER, &quot;timerListener&quot;, PlanItemInstanceState.AVAILABLE),</span>
<span class="nc" id="L930">                            tuple(PlanItemDefinitionType.HUMAN_TASK, &quot;taskA&quot;, PlanItemInstanceState.AVAILABLE)</span>
                    );
        }
<span class="nc" id="L933">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>