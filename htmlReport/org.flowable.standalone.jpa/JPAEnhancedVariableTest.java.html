<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JPAEnhancedVariableTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.standalone.jpa</a> &gt; <span class="el_source">JPAEnhancedVariableTest.java</span></div><h1>JPAEnhancedVariableTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.standalone.jpa;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.assertj.core.api.Assertions.fail;

import java.util.Arrays;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import jakarta.persistence.EntityManager;
import jakarta.persistence.EntityManagerFactory;

import org.flowable.engine.impl.test.ResourceFlowableTestCase;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.variable.service.impl.types.EntityManagerSession;
import org.flowable.variable.service.impl.types.EntityManagerSessionFactory;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Tag;
import org.junit.jupiter.api.Test;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Test for JPA enhancement support
 *
 * @author &lt;a href=&quot;mailto:eugene.khrustalev@gmail.com&quot;&gt;Eugene Khrustalev&lt;/a&gt;
 */
@Tag(&quot;jpa&quot;)
public class JPAEnhancedVariableTest extends ResourceFlowableTestCase {

<span class="nc" id="L47">    private static final Logger LOGGER = LoggerFactory.getLogger(JPAEnhancedVariableTest.class);</span>
    private EntityManagerFactory entityManagerFactory;

    private FieldAccessJPAEntity fieldEntity;
    private FieldAccessJPAEntity fieldEntity2;
    private PropertyAccessJPAEntity propertyEntity;

    public JPAEnhancedVariableTest() {
<span class="nc" id="L55">        super(&quot;org/flowable/standalone/jpa/flowable.cfg.xml&quot;);</span>
<span class="nc" id="L56">    }</span>

    @BeforeEach
    protected void setUp() {
<span class="nc" id="L60">        entityManagerFactory = ((EntityManagerSessionFactory) processEngineConfiguration.getSessionFactories().get(EntityManagerSession.class))</span>
<span class="nc" id="L61">                .getEntityManagerFactory();</span>
<span class="nc" id="L62">        setupJPAVariables();</span>
<span class="nc" id="L63">    }</span>

    private void setupJPAVariables() {
<span class="nc" id="L66">        EntityManager em = entityManagerFactory.createEntityManager();</span>
<span class="nc" id="L67">        em.getTransaction().begin();</span>

<span class="nc" id="L69">        fieldEntity = new FieldAccessJPAEntity();</span>
<span class="nc" id="L70">        fieldEntity.setId(1L);</span>
<span class="nc" id="L71">        fieldEntity.setValue(&quot;fieldEntity&quot;);</span>
<span class="nc" id="L72">        em.persist(fieldEntity);</span>

<span class="nc" id="L74">        propertyEntity = new PropertyAccessJPAEntity();</span>
<span class="nc" id="L75">        propertyEntity.setId(1L);</span>
<span class="nc" id="L76">        propertyEntity.setValue(&quot;propertyEntity&quot;);</span>
<span class="nc" id="L77">        em.persist(propertyEntity);</span>

<span class="nc" id="L79">        em.flush();</span>
<span class="nc" id="L80">        em.getTransaction().commit();</span>
<span class="nc" id="L81">        em.close();</span>

        // load enhanced versions of entities
<span class="nc" id="L84">        em = entityManagerFactory.createEntityManager();</span>

<span class="nc" id="L86">        fieldEntity = em.find(FieldAccessJPAEntity.class, fieldEntity.getId());</span>
<span class="nc" id="L87">        propertyEntity = em.find(PropertyAccessJPAEntity.class, propertyEntity.getId());</span>

<span class="nc" id="L89">        em.getTransaction().begin();</span>

<span class="nc" id="L91">        fieldEntity2 = new FieldAccessJPAEntity();</span>
<span class="nc" id="L92">        fieldEntity2.setId(2L);</span>
<span class="nc" id="L93">        fieldEntity2.setValue(&quot;fieldEntity2&quot;);</span>
<span class="nc" id="L94">        em.persist(fieldEntity2);</span>

<span class="nc" id="L96">        em.flush();</span>
<span class="nc" id="L97">        em.getTransaction().commit();</span>
<span class="nc" id="L98">        em.close();</span>
<span class="nc" id="L99">    }</span>

    private org.flowable.task.api.Task getTask(ProcessInstance instance) {
<span class="nc" id="L102">        return processEngine.getTaskService().createTaskQuery().processInstanceId(instance.getProcessInstanceId()).includeProcessVariables().singleResult();</span>
    }

    @Test
    @Deployment(resources = { &quot;org/flowable/standalone/jpa/JPAVariableTest.testStoreJPAEntityAsVariable.bpmn20.xml&quot; })
    public void testEnhancedEntityVariables() throws Exception {
        // test if enhancement is used
<span class="nc bnc" id="L109" title="All 4 branches missed.">        if (FieldAccessJPAEntity.class == fieldEntity.getClass() || PropertyAccessJPAEntity.class == propertyEntity.getClass()) {</span>
<span class="nc" id="L110">            LOGGER.warn(&quot;Entity enhancement is not used&quot;);</span>
<span class="nc" id="L111">            return;</span>
        }

        // start process with enhanced jpa variables
<span class="nc" id="L115">        Map&lt;String, Object&gt; params = new HashMap&lt;&gt;();</span>
<span class="nc" id="L116">        params.put(&quot;fieldEntity&quot;, fieldEntity);</span>
<span class="nc" id="L117">        params.put(&quot;propertyEntity&quot;, propertyEntity);</span>
<span class="nc" id="L118">        ProcessInstance instance = processEngine.getRuntimeService().startProcessInstanceByKey(&quot;JPAVariableProcess&quot;, params);</span>

<span class="nc" id="L120">        org.flowable.task.api.Task task = getTask(instance);</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">        for (Map.Entry&lt;String, Object&gt; entry : task.getProcessVariables().entrySet()) {</span>
<span class="nc" id="L122">            String name = entry.getKey();</span>
<span class="nc" id="L123">            Object value = entry.getValue();</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">            if (&quot;fieldEntity&quot;.equals(name)) {</span>
<span class="nc" id="L125">                assertThat(value).isInstanceOf(FieldAccessJPAEntity.class);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">            } else if (&quot;propertyEntity&quot;.equals(name)) {</span>
<span class="nc" id="L127">                assertThat(value).isInstanceOf(PropertyAccessJPAEntity.class);</span>
            } else {
<span class="nc" id="L129">                fail(&quot;Unknown 'name' field&quot;);</span>
            }
<span class="nc" id="L131">        }</span>
<span class="nc" id="L132">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/standalone/jpa/JPAVariableTest.testStoreJPAEntityAsVariable.bpmn20.xml&quot; })
    public void testEnhancedEntityListVariables() throws Exception {
        // test if enhancement is used
<span class="nc bnc" id="L138" title="All 4 branches missed.">        if (FieldAccessJPAEntity.class == fieldEntity.getClass() || PropertyAccessJPAEntity.class == propertyEntity.getClass()) {</span>
<span class="nc" id="L139">            LOGGER.warn(&quot;Entity enhancement is not used&quot;);</span>
<span class="nc" id="L140">            return;</span>
        }

        // start process with lists of enhanced jpa variables
<span class="nc" id="L144">        Map&lt;String, Object&gt; params = new HashMap&lt;&gt;();</span>
<span class="nc" id="L145">        params.put(&quot;list1&quot;, Arrays.asList(fieldEntity, fieldEntity));</span>
<span class="nc" id="L146">        params.put(&quot;list2&quot;, Arrays.asList(propertyEntity, propertyEntity));</span>
<span class="nc" id="L147">        ProcessInstance instance = processEngine.getRuntimeService().startProcessInstanceByKey(&quot;JPAVariableProcess&quot;, params);</span>

<span class="nc" id="L149">        org.flowable.task.api.Task task = getTask(instance);</span>
<span class="nc" id="L150">        List list = (List) task.getProcessVariables().get(&quot;list1&quot;);</span>
<span class="nc" id="L151">        assertThat(list).hasSize(2);</span>
<span class="nc" id="L152">        assertThat(list.get(0)).isInstanceOf(FieldAccessJPAEntity.class);</span>
<span class="nc" id="L153">        assertThat(list.get(1)).isInstanceOf(FieldAccessJPAEntity.class);</span>

<span class="nc" id="L155">        list = (List) task.getProcessVariables().get(&quot;list2&quot;);</span>
<span class="nc" id="L156">        assertThat(list).hasSize(2);</span>
<span class="nc" id="L157">        assertThat(list.get(0)).isInstanceOf(PropertyAccessJPAEntity.class);</span>
<span class="nc" id="L158">        assertThat(list.get(1)).isInstanceOf(PropertyAccessJPAEntity.class);</span>

        // start process with enhanced and persisted only jpa variables in the
        // same list
<span class="nc" id="L162">        params.putAll(Collections.singletonMap(&quot;list&quot;, Arrays.asList(fieldEntity, fieldEntity2)));</span>
<span class="nc" id="L163">        instance = processEngine.getRuntimeService().startProcessInstanceByKey(&quot;JPAVariableProcess&quot;, params);</span>

<span class="nc" id="L165">        task = getTask(instance);</span>
<span class="nc" id="L166">        list = (List) task.getProcessVariables().get(&quot;list&quot;);</span>
<span class="nc" id="L167">        assertThat(list).hasSize(2);</span>
<span class="nc" id="L168">        assertThat(list.get(0)).isInstanceOf(FieldAccessJPAEntity.class);</span>
<span class="nc" id="L169">        assertThat((long) ((FieldAccessJPAEntity) list.get(0)).getId()).isEqualTo(1L);</span>
<span class="nc" id="L170">        assertThat(list.get(1)).isInstanceOf(FieldAccessJPAEntity.class);</span>
<span class="nc" id="L171">        assertThat((long) ((FieldAccessJPAEntity) list.get(1)).getId()).isEqualTo(2L);</span>

        // shuffle list and start a new process
<span class="nc" id="L174">        params.putAll(Collections.singletonMap(&quot;list&quot;, Arrays.asList(fieldEntity2, fieldEntity)));</span>
<span class="nc" id="L175">        instance = processEngine.getRuntimeService().startProcessInstanceByKey(&quot;JPAVariableProcess&quot;, params);</span>

<span class="nc" id="L177">        task = getTask(instance);</span>
<span class="nc" id="L178">        list = (List) task.getProcessVariables().get(&quot;list&quot;);</span>
<span class="nc" id="L179">        assertThat(list).hasSize(2);</span>
<span class="nc" id="L180">        assertThat(list.get(0)).isInstanceOf(FieldAccessJPAEntity.class);</span>
<span class="nc" id="L181">        assertThat((long) ((FieldAccessJPAEntity) list.get(0)).getId()).isEqualTo(2L);</span>
<span class="nc" id="L182">        assertThat(list.get(1)).isInstanceOf(FieldAccessJPAEntity.class);</span>
<span class="nc" id="L183">        assertThat((long) ((FieldAccessJPAEntity) list.get(1)).getId()).isEqualTo(1L);</span>

        // start process with mixed jpa entities in list
<span class="nc" id="L186">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L187">            Map&lt;String, Object&gt; params2 = new HashMap&lt;&gt;();</span>
<span class="nc" id="L188">            params2.put(&quot;list&quot;, Arrays.asList(fieldEntity, propertyEntity));</span>
<span class="nc" id="L189">            processEngine.getRuntimeService().startProcessInstanceByKey(&quot;JPAVariableProcess&quot;, params2);</span>
<span class="nc" id="L190">        })</span>
<span class="nc" id="L191">                .isExactlyInstanceOf(Exception.class);</span>
<span class="nc" id="L192">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>