<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JPAVariableTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.standalone.jpa</a> &gt; <span class="el_source">JPAVariableTest.java</span></div><h1>JPAVariableTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.standalone.jpa;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

import java.math.BigDecimal;
import java.math.BigInteger;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import jakarta.persistence.EntityManager;
import jakarta.persistence.EntityManagerFactory;

import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.api.FlowableIllegalArgumentException;
import org.flowable.engine.impl.test.ResourceFlowableTestCase;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.variable.service.impl.types.EntityManagerSession;
import org.flowable.variable.service.impl.types.EntityManagerSessionFactory;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Tag;
import org.junit.jupiter.api.Test;

/**
 * @author Frederik Heremans
 */
@Tag(&quot;jpa&quot;)
public class JPAVariableTest extends ResourceFlowableTestCase {

    private FieldAccessJPAEntity simpleEntityFieldAccess;
    private PropertyAccessJPAEntity simpleEntityPropertyAccess;
    private SubclassFieldAccessJPAEntity subclassFieldAccess;
    private SubclassPropertyAccessJPAEntity subclassPropertyAccess;

    private ByteIdJPAEntity byteIdJPAEntity;
    private ShortIdJPAEntity shortIdJPAEntity;
    private IntegerIdJPAEntity integerIdJPAEntity;
    private LongIdJPAEntity longIdJPAEntity;
    private FloatIdJPAEntity floatIdJPAEntity;
    private DoubleIdJPAEntity doubleIdJPAEntity;
    private CharIdJPAEntity charIdJPAEntity;
    private StringIdJPAEntity stringIdJPAEntity;
    private DateIdJPAEntity dateIdJPAEntity;
    private SQLDateIdJPAEntity sqlDateIdJPAEntity;
    private BigDecimalIdJPAEntity bigDecimalIdJPAEntity;
    private BigIntegerIdJPAEntity bigIntegerIdJPAEntity;
    private CompoundIdJPAEntity compoundIdJPAEntity;

    private FieldAccessJPAEntity entityToQuery;
    private FieldAccessJPAEntity entityToUpdate;

    private EntityManagerFactory entityManagerFactory;

    public JPAVariableTest() {
<span class="nc" id="L73">        super(&quot;org/flowable/standalone/jpa/flowable.cfg.xml&quot;);</span>
<span class="nc" id="L74">    }</span>

    @BeforeEach
    protected void setUp() {
<span class="nc" id="L78">        entityManagerFactory = ((EntityManagerSessionFactory) processEngineConfiguration.getSessionFactories().get(EntityManagerSession.class))</span>
<span class="nc" id="L79">                .getEntityManagerFactory();</span>
<span class="nc" id="L80">        setupJPAEntities();</span>
<span class="nc" id="L81">    }</span>

    public void setupJPAEntities() {

<span class="nc" id="L85">        EntityManager manager = entityManagerFactory.createEntityManager();</span>
<span class="nc" id="L86">        manager.getTransaction().begin();</span>

        // Simple test data
<span class="nc" id="L89">        simpleEntityFieldAccess = new FieldAccessJPAEntity();</span>
<span class="nc" id="L90">        simpleEntityFieldAccess.setId(1L);</span>
<span class="nc" id="L91">        simpleEntityFieldAccess.setValue(&quot;value1&quot;);</span>
<span class="nc" id="L92">        manager.persist(simpleEntityFieldAccess);</span>

<span class="nc" id="L94">        simpleEntityPropertyAccess = new PropertyAccessJPAEntity();</span>
<span class="nc" id="L95">        simpleEntityPropertyAccess.setId(1L);</span>
<span class="nc" id="L96">        simpleEntityPropertyAccess.setValue(&quot;value2&quot;);</span>
<span class="nc" id="L97">        manager.persist(simpleEntityPropertyAccess);</span>

<span class="nc" id="L99">        subclassFieldAccess = new SubclassFieldAccessJPAEntity();</span>
<span class="nc" id="L100">        subclassFieldAccess.setId(1L);</span>
<span class="nc" id="L101">        subclassFieldAccess.setValue(&quot;value3&quot;);</span>
<span class="nc" id="L102">        manager.persist(subclassFieldAccess);</span>

<span class="nc" id="L104">        subclassPropertyAccess = new SubclassPropertyAccessJPAEntity();</span>
<span class="nc" id="L105">        subclassPropertyAccess.setId(1L);</span>
<span class="nc" id="L106">        subclassPropertyAccess.setValue(&quot;value4&quot;);</span>
<span class="nc" id="L107">        manager.persist(subclassPropertyAccess);</span>

        // Test entities with all possible ID types
<span class="nc" id="L110">        byteIdJPAEntity = new ByteIdJPAEntity();</span>
<span class="nc" id="L111">        byteIdJPAEntity.setByteId((byte) 1);</span>
<span class="nc" id="L112">        manager.persist(byteIdJPAEntity);</span>

<span class="nc" id="L114">        shortIdJPAEntity = new ShortIdJPAEntity();</span>
<span class="nc" id="L115">        shortIdJPAEntity.setShortId((short) 123);</span>
<span class="nc" id="L116">        manager.persist(shortIdJPAEntity);</span>

<span class="nc" id="L118">        integerIdJPAEntity = new IntegerIdJPAEntity();</span>
<span class="nc" id="L119">        integerIdJPAEntity.setIntId(123);</span>
<span class="nc" id="L120">        manager.persist(integerIdJPAEntity);</span>

<span class="nc" id="L122">        longIdJPAEntity = new LongIdJPAEntity();</span>
<span class="nc" id="L123">        longIdJPAEntity.setLongId(123456789L);</span>
<span class="nc" id="L124">        manager.persist(longIdJPAEntity);</span>

<span class="nc" id="L126">        floatIdJPAEntity = new FloatIdJPAEntity();</span>
<span class="nc" id="L127">        floatIdJPAEntity.setFloatId((float) 123.45678);</span>
<span class="nc" id="L128">        manager.persist(floatIdJPAEntity);</span>

<span class="nc" id="L130">        doubleIdJPAEntity = new DoubleIdJPAEntity();</span>
<span class="nc" id="L131">        doubleIdJPAEntity.setDoubleId(12345678.987654);</span>
<span class="nc" id="L132">        manager.persist(doubleIdJPAEntity);</span>

<span class="nc" id="L134">        charIdJPAEntity = new CharIdJPAEntity();</span>
<span class="nc" id="L135">        charIdJPAEntity.setCharId('g');</span>
<span class="nc" id="L136">        manager.persist(charIdJPAEntity);</span>

<span class="nc" id="L138">        dateIdJPAEntity = new DateIdJPAEntity();</span>
<span class="nc" id="L139">        dateIdJPAEntity.setDateId(new java.util.Date());</span>
<span class="nc" id="L140">        manager.persist(dateIdJPAEntity);</span>

<span class="nc" id="L142">        sqlDateIdJPAEntity = new SQLDateIdJPAEntity();</span>
<span class="nc" id="L143">        sqlDateIdJPAEntity.setDateId(new java.sql.Date(Calendar.getInstance().getTimeInMillis()));</span>
<span class="nc" id="L144">        manager.persist(sqlDateIdJPAEntity);</span>

<span class="nc" id="L146">        stringIdJPAEntity = new StringIdJPAEntity();</span>
<span class="nc" id="L147">        stringIdJPAEntity.setStringId(&quot;azertyuiop&quot;);</span>
<span class="nc" id="L148">        manager.persist(stringIdJPAEntity);</span>

<span class="nc" id="L150">        bigDecimalIdJPAEntity = new BigDecimalIdJPAEntity();</span>
<span class="nc" id="L151">        bigDecimalIdJPAEntity.setBigDecimalId(new BigDecimal(&quot;12345678912345678900000.123456789123456789&quot;));</span>
<span class="nc" id="L152">        manager.persist(bigDecimalIdJPAEntity);</span>

<span class="nc" id="L154">        bigIntegerIdJPAEntity = new BigIntegerIdJPAEntity();</span>
<span class="nc" id="L155">        bigIntegerIdJPAEntity.setBigIntegerId(new BigInteger(&quot;12345678912345678912345678900000&quot;));</span>
<span class="nc" id="L156">        manager.persist(bigIntegerIdJPAEntity);</span>

<span class="nc" id="L158">        manager.flush();</span>
<span class="nc" id="L159">        manager.getTransaction().commit();</span>
<span class="nc" id="L160">        manager.close();</span>

<span class="nc" id="L162">    }</span>

    public void setupIllegalJPAEntities() {
<span class="nc" id="L165">        EntityManager manager = entityManagerFactory.createEntityManager();</span>
<span class="nc" id="L166">        manager.getTransaction().begin();</span>

<span class="nc" id="L168">        compoundIdJPAEntity = new CompoundIdJPAEntity();</span>
<span class="nc" id="L169">        EmbeddableCompoundId id = new EmbeddableCompoundId();</span>
<span class="nc" id="L170">        id.setIdPart1(123L);</span>
<span class="nc" id="L171">        id.setIdPart2(&quot;part2&quot;);</span>
<span class="nc" id="L172">        compoundIdJPAEntity.setId(id);</span>
<span class="nc" id="L173">        manager.persist(compoundIdJPAEntity);</span>

<span class="nc" id="L175">        manager.flush();</span>
<span class="nc" id="L176">        manager.getTransaction().commit();</span>
<span class="nc" id="L177">        manager.close();</span>
<span class="nc" id="L178">    }</span>

    public void setupQueryJPAEntity() {
<span class="nc" id="L181">        EntityManager manager = entityManagerFactory.createEntityManager();</span>
<span class="nc" id="L182">        manager.getTransaction().begin();</span>

<span class="nc" id="L184">        entityToQuery = new FieldAccessJPAEntity();</span>
<span class="nc" id="L185">        entityToQuery.setId(2L);</span>
<span class="nc" id="L186">        manager.persist(entityToQuery);</span>

<span class="nc" id="L188">        manager.flush();</span>
<span class="nc" id="L189">        manager.getTransaction().commit();</span>
<span class="nc" id="L190">        manager.close();</span>
<span class="nc" id="L191">    }</span>

    public void setupJPAEntityToUpdate() {
<span class="nc" id="L194">        EntityManager manager = entityManagerFactory.createEntityManager();</span>
<span class="nc" id="L195">        manager.getTransaction().begin();</span>

<span class="nc" id="L197">        entityToUpdate = new FieldAccessJPAEntity();</span>
<span class="nc" id="L198">        entityToUpdate.setId(3L);</span>
<span class="nc" id="L199">        manager.persist(entityToUpdate);</span>
<span class="nc" id="L200">        manager.flush();</span>
<span class="nc" id="L201">        manager.getTransaction().commit();</span>
<span class="nc" id="L202">        manager.close();</span>
<span class="nc" id="L203">    }</span>

    @Test
    @Deployment
    public void testStoreJPAEntityAsVariable() {
        // -----------------------------------------------------------------------------
        // Simple test, Start process with JPA entities as variables
        // -----------------------------------------------------------------------------
<span class="nc" id="L211">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L212">        variables.put(&quot;simpleEntityFieldAccess&quot;, simpleEntityFieldAccess);</span>
<span class="nc" id="L213">        variables.put(&quot;simpleEntityPropertyAccess&quot;, simpleEntityPropertyAccess);</span>
<span class="nc" id="L214">        variables.put(&quot;subclassFieldAccess&quot;, subclassFieldAccess);</span>
<span class="nc" id="L215">        variables.put(&quot;subclassPropertyAccess&quot;, subclassPropertyAccess);</span>

        // Start the process with the JPA-entities as variables. They will be
        // stored in the DB.
<span class="nc" id="L219">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;JPAVariableProcess&quot;, variables);</span>

        // Read entity with @Id on field
<span class="nc" id="L222">        Object fieldAccessResult = runtimeService.getVariable(processInstance.getId(), &quot;simpleEntityFieldAccess&quot;);</span>
<span class="nc" id="L223">        assertThat(fieldAccessResult).isInstanceOf(FieldAccessJPAEntity.class);</span>
<span class="nc" id="L224">        assertThat(((FieldAccessJPAEntity) fieldAccessResult).getId().longValue()).isEqualTo(1L);</span>
<span class="nc" id="L225">        assertThat(((FieldAccessJPAEntity) fieldAccessResult).getValue()).isEqualTo(&quot;value1&quot;);</span>

        // Read entity with @Id on property
<span class="nc" id="L228">        Object propertyAccessResult = runtimeService.getVariable(processInstance.getId(), &quot;simpleEntityPropertyAccess&quot;);</span>
<span class="nc" id="L229">        assertThat(propertyAccessResult).isInstanceOf(PropertyAccessJPAEntity.class);</span>
<span class="nc" id="L230">        assertThat(((PropertyAccessJPAEntity) propertyAccessResult).getId().longValue()).isEqualTo(1L);</span>
<span class="nc" id="L231">        assertThat(((PropertyAccessJPAEntity) propertyAccessResult).getValue()).isEqualTo(&quot;value2&quot;);</span>

        // Read entity with @Id on field of mapped superclass
<span class="nc" id="L234">        Object subclassFieldResult = runtimeService.getVariable(processInstance.getId(), &quot;subclassFieldAccess&quot;);</span>
<span class="nc" id="L235">        assertThat(subclassFieldResult).isInstanceOf(SubclassFieldAccessJPAEntity.class);</span>
<span class="nc" id="L236">        assertThat(((SubclassFieldAccessJPAEntity) subclassFieldResult).getId().longValue()).isEqualTo(1L);</span>
<span class="nc" id="L237">        assertThat(((SubclassFieldAccessJPAEntity) subclassFieldResult).getValue()).isEqualTo(&quot;value3&quot;);</span>

        // Read entity with @Id on property of mapped superclass
<span class="nc" id="L240">        Object subclassPropertyResult = runtimeService.getVariable(processInstance.getId(), &quot;subclassPropertyAccess&quot;);</span>
<span class="nc" id="L241">        assertThat(subclassPropertyResult).isInstanceOf(SubclassPropertyAccessJPAEntity.class);</span>
<span class="nc" id="L242">        assertThat(((SubclassPropertyAccessJPAEntity) subclassPropertyResult).getId().longValue()).isEqualTo(1L);</span>
<span class="nc" id="L243">        assertThat(((SubclassPropertyAccessJPAEntity) subclassPropertyResult).getValue()).isEqualTo(&quot;value4&quot;);</span>

        // -----------------------------------------------------------------------------
        // Test updating JPA-entity to null-value and back again
        // -----------------------------------------------------------------------------
<span class="nc" id="L248">        Object currentValue = runtimeService.getVariable(processInstance.getId(), &quot;simpleEntityFieldAccess&quot;);</span>
<span class="nc" id="L249">        assertThat(currentValue).isNotNull();</span>
        // Set to null
<span class="nc" id="L251">        runtimeService.setVariable(processInstance.getId(), &quot;simpleEntityFieldAccess&quot;, null);</span>
<span class="nc" id="L252">        currentValue = runtimeService.getVariable(processInstance.getId(), &quot;simpleEntityFieldAccess&quot;);</span>
<span class="nc" id="L253">        assertThat(currentValue).isNull();</span>
        // Set to JPA-entity again
<span class="nc" id="L255">        runtimeService.setVariable(processInstance.getId(), &quot;simpleEntityFieldAccess&quot;, simpleEntityFieldAccess);</span>
<span class="nc" id="L256">        currentValue = runtimeService.getVariable(processInstance.getId(), &quot;simpleEntityFieldAccess&quot;);</span>
<span class="nc" id="L257">        assertThat(currentValue).isInstanceOf(FieldAccessJPAEntity.class);</span>
<span class="nc" id="L258">        assertThat(((FieldAccessJPAEntity) currentValue).getId().longValue()).isEqualTo(1L);</span>

        // -----------------------------------------------------------------------------
        // Test all allowed types of ID values
        // -----------------------------------------------------------------------------

<span class="nc" id="L264">        variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L265">        variables.put(&quot;byteIdJPAEntity&quot;, byteIdJPAEntity);</span>
<span class="nc" id="L266">        variables.put(&quot;shortIdJPAEntity&quot;, shortIdJPAEntity);</span>
<span class="nc" id="L267">        variables.put(&quot;integerIdJPAEntity&quot;, integerIdJPAEntity);</span>
<span class="nc" id="L268">        variables.put(&quot;longIdJPAEntity&quot;, longIdJPAEntity);</span>
<span class="nc" id="L269">        variables.put(&quot;floatIdJPAEntity&quot;, floatIdJPAEntity);</span>
<span class="nc" id="L270">        variables.put(&quot;doubleIdJPAEntity&quot;, doubleIdJPAEntity);</span>
<span class="nc" id="L271">        variables.put(&quot;charIdJPAEntity&quot;, charIdJPAEntity);</span>
<span class="nc" id="L272">        variables.put(&quot;stringIdJPAEntity&quot;, stringIdJPAEntity);</span>
<span class="nc" id="L273">        variables.put(&quot;dateIdJPAEntity&quot;, dateIdJPAEntity);</span>
<span class="nc" id="L274">        variables.put(&quot;sqlDateIdJPAEntity&quot;, sqlDateIdJPAEntity);</span>
<span class="nc" id="L275">        variables.put(&quot;bigDecimalIdJPAEntity&quot;, bigDecimalIdJPAEntity);</span>
<span class="nc" id="L276">        variables.put(&quot;bigIntegerIdJPAEntity&quot;, bigIntegerIdJPAEntity);</span>

        // Start the process with the JPA-entities as variables. They will be
        // stored in the DB.
<span class="nc" id="L280">        ProcessInstance processInstanceAllTypes = runtimeService.startProcessInstanceByKey(&quot;JPAVariableProcess&quot;, variables);</span>
<span class="nc" id="L281">        Object byteIdResult = runtimeService.getVariable(processInstanceAllTypes.getId(), &quot;byteIdJPAEntity&quot;);</span>
<span class="nc" id="L282">        assertThat(byteIdResult).isInstanceOf(ByteIdJPAEntity.class);</span>
<span class="nc" id="L283">        assertThat(((ByteIdJPAEntity) byteIdResult).getByteId()).isEqualTo(byteIdJPAEntity.getByteId());</span>

<span class="nc" id="L285">        Object shortIdResult = runtimeService.getVariable(processInstanceAllTypes.getId(), &quot;shortIdJPAEntity&quot;);</span>
<span class="nc" id="L286">        assertThat(shortIdResult).isInstanceOf(ShortIdJPAEntity.class);</span>
<span class="nc" id="L287">        assertThat(((ShortIdJPAEntity) shortIdResult).getShortId()).isEqualTo(shortIdJPAEntity.getShortId());</span>

<span class="nc" id="L289">        Object integerIdResult = runtimeService.getVariable(processInstanceAllTypes.getId(), &quot;integerIdJPAEntity&quot;);</span>
<span class="nc" id="L290">        assertThat(integerIdResult).isInstanceOf(IntegerIdJPAEntity.class);</span>
<span class="nc" id="L291">        assertThat(((IntegerIdJPAEntity) integerIdResult).getIntId()).isEqualTo(integerIdJPAEntity.getIntId());</span>

<span class="nc" id="L293">        Object longIdResult = runtimeService.getVariable(processInstanceAllTypes.getId(), &quot;longIdJPAEntity&quot;);</span>
<span class="nc" id="L294">        assertThat(longIdResult).isInstanceOf(LongIdJPAEntity.class);</span>
<span class="nc" id="L295">        assertThat(((LongIdJPAEntity) longIdResult).getLongId()).isEqualTo(longIdJPAEntity.getLongId());</span>

<span class="nc" id="L297">        Object floatIdResult = runtimeService.getVariable(processInstanceAllTypes.getId(), &quot;floatIdJPAEntity&quot;);</span>
<span class="nc" id="L298">        assertThat(floatIdResult).isInstanceOf(FloatIdJPAEntity.class);</span>
<span class="nc" id="L299">        assertThat(((FloatIdJPAEntity) floatIdResult).getFloatId()).isEqualTo(floatIdJPAEntity.getFloatId());</span>

<span class="nc" id="L301">        Object doubleIdResult = runtimeService.getVariable(processInstanceAllTypes.getId(), &quot;doubleIdJPAEntity&quot;);</span>
<span class="nc" id="L302">        assertThat(doubleIdResult).isInstanceOf(DoubleIdJPAEntity.class);</span>
<span class="nc" id="L303">        assertThat(((DoubleIdJPAEntity) doubleIdResult).getDoubleId()).isEqualTo(doubleIdJPAEntity.getDoubleId());</span>

<span class="nc" id="L305">        Object charIdResult = runtimeService.getVariable(processInstanceAllTypes.getId(), &quot;charIdJPAEntity&quot;);</span>
<span class="nc" id="L306">        assertThat(charIdResult).isInstanceOf(CharIdJPAEntity.class);</span>
<span class="nc" id="L307">        assertThat(((CharIdJPAEntity) charIdResult).getCharId()).isEqualTo(charIdJPAEntity.getCharId());</span>

<span class="nc" id="L309">        Object stringIdResult = runtimeService.getVariable(processInstanceAllTypes.getId(), &quot;stringIdJPAEntity&quot;);</span>
<span class="nc" id="L310">        assertThat(stringIdResult).isInstanceOf(StringIdJPAEntity.class);</span>
<span class="nc" id="L311">        assertThat(((StringIdJPAEntity) stringIdResult).getStringId()).isEqualTo(stringIdJPAEntity.getStringId());</span>

<span class="nc" id="L313">        Object dateIdResult = runtimeService.getVariable(processInstanceAllTypes.getId(), &quot;dateIdJPAEntity&quot;);</span>
<span class="nc" id="L314">        assertThat(dateIdResult).isInstanceOf(DateIdJPAEntity.class);</span>
<span class="nc" id="L315">        assertThat(new java.util.Date(((DateIdJPAEntity) dateIdResult).getDateId().getTime())).isEqualTo(dateIdJPAEntity.getDateId());</span>

<span class="nc" id="L317">        Object sqlDateIdResult = runtimeService.getVariable(processInstanceAllTypes.getId(), &quot;sqlDateIdJPAEntity&quot;);</span>
<span class="nc" id="L318">        assertThat(sqlDateIdResult).isInstanceOf(SQLDateIdJPAEntity.class);</span>
<span class="nc" id="L319">        assertThat(((SQLDateIdJPAEntity) sqlDateIdResult).getDateId()).isEqualTo(sqlDateIdJPAEntity.getDateId());</span>

<span class="nc" id="L321">        Object bigDecimalIdResult = runtimeService.getVariable(processInstanceAllTypes.getId(), &quot;bigDecimalIdJPAEntity&quot;);</span>
<span class="nc" id="L322">        assertThat(bigDecimalIdResult).isInstanceOf(BigDecimalIdJPAEntity.class);</span>
<span class="nc" id="L323">        assertThat(((BigDecimalIdJPAEntity) bigDecimalIdResult).getBigDecimalId()).isEqualTo(bigDecimalIdJPAEntity.getBigDecimalId());</span>

<span class="nc" id="L325">        Object bigIntegerIdResult = runtimeService.getVariable(processInstanceAllTypes.getId(), &quot;bigIntegerIdJPAEntity&quot;);</span>
<span class="nc" id="L326">        assertThat(bigIntegerIdResult).isInstanceOf(BigIntegerIdJPAEntity.class);</span>
<span class="nc" id="L327">        assertThat(((BigIntegerIdJPAEntity) bigIntegerIdResult).getBigIntegerId()).isEqualTo(bigIntegerIdJPAEntity.getBigIntegerId());</span>
<span class="nc" id="L328">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/standalone/jpa/JPAVariableTest.testStoreJPAEntityAsVariable.bpmn20.xml&quot; })
    public void testStoreJPAEntityListAsVariable() {
        // -----------------------------------------------------------------------------
        // Simple test, Start process with lists of JPA entities as variables
        // -----------------------------------------------------------------------------
<span class="nc" id="L336">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L337">        variables.put(&quot;simpleEntityFieldAccess&quot;, Arrays.asList(simpleEntityFieldAccess, simpleEntityFieldAccess, simpleEntityFieldAccess));</span>
<span class="nc" id="L338">        variables.put(&quot;simpleEntityPropertyAccess&quot;, Arrays.asList(simpleEntityPropertyAccess, simpleEntityPropertyAccess, simpleEntityPropertyAccess));</span>
<span class="nc" id="L339">        variables.put(&quot;subclassFieldAccess&quot;, Arrays.asList(subclassFieldAccess, subclassFieldAccess, subclassFieldAccess));</span>
<span class="nc" id="L340">        variables.put(&quot;subclassPropertyAccess&quot;, Arrays.asList(subclassPropertyAccess, subclassPropertyAccess, subclassPropertyAccess));</span>

        // Start the process with the JPA-entities as variables. They will be
        // stored in the DB.
<span class="nc" id="L344">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;JPAVariableProcess&quot;, variables);</span>

        // Read entity with @Id on field
<span class="nc" id="L347">        Object fieldAccessResult = runtimeService.getVariable(processInstance.getId(), &quot;simpleEntityFieldAccess&quot;);</span>
<span class="nc" id="L348">        assertThat(fieldAccessResult).isInstanceOf(List.class);</span>
<span class="nc" id="L349">        List&lt;?&gt; list = (List&lt;?&gt;) fieldAccessResult;</span>
<span class="nc" id="L350">        assertThat(list).hasSize(3);</span>
<span class="nc" id="L351">        assertThat(list.get(0)).isInstanceOf(FieldAccessJPAEntity.class);</span>
<span class="nc" id="L352">        assertThat(simpleEntityFieldAccess.getId()).isEqualTo(((FieldAccessJPAEntity) list.get(0)).getId());</span>

        // Read entity with @Id on property
<span class="nc" id="L355">        Object propertyAccessResult = runtimeService.getVariable(processInstance.getId(), &quot;simpleEntityPropertyAccess&quot;);</span>
<span class="nc" id="L356">        assertThat(propertyAccessResult).isInstanceOf(List.class);</span>
<span class="nc" id="L357">        list = (List&lt;?&gt;) propertyAccessResult;</span>
<span class="nc" id="L358">        assertThat(list).hasSize(3);</span>
<span class="nc" id="L359">        assertThat(list.get(0)).isInstanceOf(PropertyAccessJPAEntity.class);</span>
<span class="nc" id="L360">        assertThat(simpleEntityPropertyAccess.getId()).isEqualTo(((PropertyAccessJPAEntity) list.get(0)).getId());</span>

        // Read entity with @Id on field of mapped superclass
<span class="nc" id="L363">        Object subclassFieldResult = runtimeService.getVariable(processInstance.getId(), &quot;subclassFieldAccess&quot;);</span>
<span class="nc" id="L364">        assertThat(subclassFieldResult).isInstanceOf(List.class);</span>
<span class="nc" id="L365">        list = (List&lt;?&gt;) subclassFieldResult;</span>
<span class="nc" id="L366">        assertThat(list).hasSize(3);</span>
<span class="nc" id="L367">        assertThat(list.get(0)).isInstanceOf(SubclassFieldAccessJPAEntity.class);</span>
<span class="nc" id="L368">        assertThat(simpleEntityPropertyAccess.getId()).isEqualTo(((SubclassFieldAccessJPAEntity) list.get(0)).getId());</span>

        // Read entity with @Id on property of mapped superclass
<span class="nc" id="L371">        Object subclassPropertyResult = runtimeService.getVariable(processInstance.getId(), &quot;subclassPropertyAccess&quot;);</span>
<span class="nc" id="L372">        assertThat(subclassPropertyResult).isInstanceOf(List.class);</span>
<span class="nc" id="L373">        list = (List&lt;?&gt;) subclassPropertyResult;</span>
<span class="nc" id="L374">        assertThat(list).hasSize(3);</span>
<span class="nc" id="L375">        assertThat(list.get(0)).isInstanceOf(SubclassPropertyAccessJPAEntity.class);</span>
<span class="nc" id="L376">        assertThat(simpleEntityPropertyAccess.getId()).isEqualTo(((SubclassPropertyAccessJPAEntity) list.get(0)).getId());</span>
<span class="nc" id="L377">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/standalone/jpa/JPAVariableTest.testStoreJPAEntityAsVariable.bpmn20.xml&quot; })
    public void testStoreJPAEntityListAsVariableEdgeCases() {

        // Test using mixed JPA-entities which are not serializable, should not
        // be picked up by JPA list type and therefore fail due to serialization error
<span class="nc" id="L385">        assertThatThrownBy(() -&gt;</span>
        {
<span class="nc" id="L387">            Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L388">            variables.put(&quot;simpleEntityFieldAccess&quot;, Arrays.asList(simpleEntityFieldAccess, simpleEntityPropertyAccess));</span>
<span class="nc" id="L389">            runtimeService.startProcessInstanceByKey(&quot;JPAVariableProcess&quot;, variables);</span>
<span class="nc" id="L390">        })</span>
<span class="nc" id="L391">                .isExactlyInstanceOf(FlowableException.class);</span>

        // Test updating value to an empty list and back
<span class="nc" id="L394">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L395">        variables.put(&quot;list&quot;, Arrays.asList(simpleEntityFieldAccess, simpleEntityFieldAccess));</span>

<span class="nc" id="L397">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;JPAVariableProcess&quot;, variables);</span>

<span class="nc" id="L399">        runtimeService.setVariable(processInstance.getId(), &quot;list&quot;, new ArrayList&lt;String&gt;());</span>
<span class="nc" id="L400">        assertThat(((List&lt;?&gt;) runtimeService.getVariable(processInstance.getId(), &quot;list&quot;))).isEmpty();</span>

<span class="nc" id="L402">        runtimeService.setVariable(processInstance.getId(), &quot;list&quot;, Arrays.asList(simpleEntityFieldAccess, simpleEntityFieldAccess));</span>
<span class="nc" id="L403">        assertThat(((List&lt;?&gt;) runtimeService.getVariable(processInstance.getId(), &quot;list&quot;))).hasSize(2);</span>
<span class="nc" id="L404">        assertThat(((List&lt;?&gt;) runtimeService.getVariable(processInstance.getId(), &quot;list&quot;)).get(0)).isInstanceOf(FieldAccessJPAEntity.class);</span>

        // Test updating to list of Strings
<span class="nc" id="L407">        runtimeService.setVariable(processInstance.getId(), &quot;list&quot;, Arrays.asList(&quot;TEST&quot;, &quot;TESTING&quot;));</span>
<span class="nc" id="L408">        assertThat(((List&lt;?&gt;) runtimeService.getVariable(processInstance.getId(), &quot;list&quot;))).hasSize(2);</span>
<span class="nc" id="L409">        assertThat(((List&lt;?&gt;) runtimeService.getVariable(processInstance.getId(), &quot;list&quot;)).get(0)).isInstanceOf(String.class);</span>

<span class="nc" id="L411">        runtimeService.setVariable(processInstance.getId(), &quot;list&quot;, Arrays.asList(simpleEntityFieldAccess, simpleEntityFieldAccess));</span>
<span class="nc" id="L412">        assertThat(((List&lt;?&gt;) runtimeService.getVariable(processInstance.getId(), &quot;list&quot;))).hasSize(2);</span>
<span class="nc" id="L413">        assertThat(((List&lt;?&gt;) runtimeService.getVariable(processInstance.getId(), &quot;list&quot;)).get(0)).isInstanceOf(FieldAccessJPAEntity.class);</span>

        // Test updating to null
<span class="nc" id="L416">        runtimeService.setVariable(processInstance.getId(), &quot;list&quot;, null);</span>
<span class="nc" id="L417">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;list&quot;)).isNull();</span>

<span class="nc" id="L419">        runtimeService.setVariable(processInstance.getId(), &quot;list&quot;, Arrays.asList(simpleEntityFieldAccess, simpleEntityFieldAccess));</span>
<span class="nc" id="L420">        assertThat(((List&lt;?&gt;) runtimeService.getVariable(processInstance.getId(), &quot;list&quot;))).hasSize(2);</span>
<span class="nc" id="L421">        assertThat(((List&lt;?&gt;) runtimeService.getVariable(processInstance.getId(), &quot;list&quot;)).get(0)).isInstanceOf(FieldAccessJPAEntity.class);</span>
<span class="nc" id="L422">    }</span>

    // https://activiti.atlassian.net/browse/ACT-995
    @Test
    @Deployment(resources = &quot;org/flowable/standalone/jpa/JPAVariableTest.testQueryJPAVariable.bpmn20.xml&quot;)
    public void testReplaceExistingJPAEntityWithAnotherOfSameType() {
<span class="nc" id="L428">        EntityManager manager = entityManagerFactory.createEntityManager();</span>
<span class="nc" id="L429">        manager.getTransaction().begin();</span>

        // Old variable that gets replaced
<span class="nc" id="L432">        FieldAccessJPAEntity oldVariable = new FieldAccessJPAEntity();</span>
<span class="nc" id="L433">        oldVariable.setId(11L);</span>
<span class="nc" id="L434">        oldVariable.setValue(&quot;value1&quot;);</span>
<span class="nc" id="L435">        manager.persist(oldVariable);</span>

        // New variable
<span class="nc" id="L438">        FieldAccessJPAEntity newVariable = new FieldAccessJPAEntity();</span>
<span class="nc" id="L439">        newVariable.setId(12L);</span>
<span class="nc" id="L440">        newVariable.setValue(&quot;value2&quot;);</span>
<span class="nc" id="L441">        manager.persist(newVariable);</span>

<span class="nc" id="L443">        manager.flush();</span>
<span class="nc" id="L444">        manager.getTransaction().commit();</span>
<span class="nc" id="L445">        manager.close();</span>

<span class="nc" id="L447">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;JPAVariableProcess&quot;);</span>

<span class="nc" id="L449">        String executionId = processInstance.getId();</span>
<span class="nc" id="L450">        String variableName = &quot;testVariable&quot;;</span>
<span class="nc" id="L451">        runtimeService.setVariable(executionId, variableName, oldVariable);</span>

<span class="nc" id="L453">        runtimeService.setVariable(executionId, variableName, newVariable);</span>

<span class="nc" id="L455">        Object variable = runtimeService.getVariable(executionId, variableName);</span>
<span class="nc" id="L456">        assertThat(((FieldAccessJPAEntity) variable).getId()).isEqualTo(newVariable.getId());</span>
<span class="nc" id="L457">    }</span>

    @Test
    @Deployment
    public void testIllegalEntities() {
<span class="nc" id="L462">        setupIllegalJPAEntities();</span>
        // Starting process instance with a variable that has a compound primary
        // key, which is not supported.
<span class="nc" id="L465">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L466">            Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L467">            variables.put(&quot;compoundIdJPAEntity&quot;, compoundIdJPAEntity);</span>
<span class="nc" id="L468">            runtimeService.startProcessInstanceByKey(&quot;JPAVariableProcessExceptions&quot;, variables);</span>
<span class="nc" id="L469">        })</span>
<span class="nc" id="L470">                .isExactlyInstanceOf(FlowableException.class)</span>
<span class="nc" id="L471">                .hasMessageContaining(&quot;Cannot find field or method with annotation @Id on class&quot;)</span>
<span class="nc" id="L472">                .hasMessageContaining(&quot;only single-valued primary keys are supported on JPA-entities&quot;);</span>

        // Starting process instance with a variable that has null as ID-value
<span class="nc" id="L475">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L476">            Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L477">            variables.put(&quot;nullValueEntity&quot;, new FieldAccessJPAEntity());</span>
<span class="nc" id="L478">            runtimeService.startProcessInstanceByKey(&quot;JPAVariableProcessExceptions&quot;, variables);</span>
<span class="nc" id="L479">        })</span>
<span class="nc" id="L480">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L481">                .hasMessageContaining(&quot;Value of primary key for JPA-Entity cannot be null&quot;);</span>

        // Starting process instance with an invalid type of ID
        // Under normal circumstances, JPA will throw an exception for this of
        // the class is present in the PU when creating EntityManagerFactory, but we test it
        // *just in case*
<span class="nc" id="L487">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L488">            Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L489">            IllegalIdClassJPAEntity illegalIdTypeEntity = new IllegalIdClassJPAEntity();</span>
<span class="nc" id="L490">            illegalIdTypeEntity.setId(Calendar.getInstance());</span>
<span class="nc" id="L491">            variables.put(&quot;illegalTypeId&quot;, illegalIdTypeEntity);</span>
<span class="nc" id="L492">            runtimeService.startProcessInstanceByKey(&quot;JPAVariableProcessExceptions&quot;, variables);</span>
<span class="nc" id="L493">        })</span>
<span class="nc" id="L494">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L495">                .hasMessageContaining(&quot;Unsupported Primary key type for JPA-Entity&quot;);</span>

        // Start process instance with JPA-entity which has an ID but isn't
        // persisted. When reading the variable we should get an exception.
<span class="nc" id="L499">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L500">            Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L501">            FieldAccessJPAEntity nonPersistentEntity = new FieldAccessJPAEntity();</span>
<span class="nc" id="L502">            nonPersistentEntity.setId(9999L);</span>
<span class="nc" id="L503">            variables.put(&quot;nonPersistentEntity&quot;, nonPersistentEntity);</span>

<span class="nc" id="L505">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;JPAVariableProcessExceptions&quot;, variables);</span>
<span class="nc" id="L506">            runtimeService.getVariable(processInstance.getId(), &quot;nonPersistentEntity&quot;);</span>
<span class="nc" id="L507">        })</span>
<span class="nc" id="L508">                .isExactlyInstanceOf(FlowableException.class)</span>
<span class="nc" id="L509">                .hasMessageContaining(&quot;Entity does not exist: &quot; + FieldAccessJPAEntity.class.getName() + &quot; - 9999&quot;);</span>
<span class="nc" id="L510">    }</span>

    @Test
    @Deployment
    public void testQueryJPAVariable() {
<span class="nc" id="L515">        setupQueryJPAEntity();</span>

<span class="nc" id="L517">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L518">        variables.put(&quot;entityToQuery&quot;, entityToQuery);</span>

<span class="nc" id="L520">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;JPAVariableProcess&quot;, variables);</span>

        // Query the processInstance
<span class="nc" id="L523">        ProcessInstance result = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;entityToQuery&quot;, entityToQuery).singleResult();</span>
<span class="nc" id="L524">        assertThat(result).isNotNull();</span>
<span class="nc" id="L525">        assertThat(processInstance.getId()).isEqualTo(result.getId());</span>

        // Query with the same entity-type but with different ID should have no
        // result
<span class="nc" id="L529">        FieldAccessJPAEntity unexistingEntity = new FieldAccessJPAEntity();</span>
<span class="nc" id="L530">        unexistingEntity.setId(8888L);</span>

<span class="nc" id="L532">        result = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;entityToQuery&quot;, unexistingEntity).singleResult();</span>
<span class="nc" id="L533">        assertThat(result).isNull();</span>

        // All other operators are unsupported
<span class="nc" id="L536">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueNotEquals(&quot;entityToQuery&quot;, entityToQuery).singleResult())</span>
<span class="nc" id="L537">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L538">                .hasMessageContaining(&quot;JPA entity variables can only be used in 'variableValueEquals'&quot;);</span>
<span class="nc" id="L539">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;entityToQuery&quot;, entityToQuery).singleResult())</span>
<span class="nc" id="L540">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L541">                .hasMessageContaining(&quot;JPA entity variables can only be used in 'variableValueEquals'&quot;);</span>
<span class="nc" id="L542">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;entityToQuery&quot;, entityToQuery).singleResult())</span>
<span class="nc" id="L543">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L544">                .hasMessageContaining(&quot;JPA entity variables can only be used in 'variableValueEquals'&quot;);</span>
<span class="nc" id="L545">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueLessThan(&quot;entityToQuery&quot;, entityToQuery).singleResult())</span>
<span class="nc" id="L546">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L547">                .hasMessageContaining(&quot;JPA entity variables can only be used in 'variableValueEquals'&quot;);</span>
<span class="nc" id="L548">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueLessThanOrEqual(&quot;entityToQuery&quot;, entityToQuery).singleResult())</span>
<span class="nc" id="L549">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L550">                .hasMessageContaining(&quot;JPA entity variables can only be used in 'variableValueEquals'&quot;);</span>
<span class="nc" id="L551">    }</span>

    @Test
    @Deployment
    public void testUpdateJPAEntityValues() {
<span class="nc" id="L556">        setupJPAEntityToUpdate();</span>
<span class="nc" id="L557">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L558">        variables.put(&quot;entityToUpdate&quot;, entityToUpdate);</span>

<span class="nc" id="L560">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;UpdateJPAValuesProcess&quot;, variables);</span>

        // Servicetask in process 'UpdateJPAValuesProcess' should have set value
        // on entityToUpdate.
<span class="nc" id="L564">        Object updatedEntity = runtimeService.getVariable(processInstance.getId(), &quot;entityToUpdate&quot;);</span>
<span class="nc" id="L565">        assertThat(updatedEntity).isInstanceOf(FieldAccessJPAEntity.class);</span>
<span class="nc" id="L566">        assertThat(((FieldAccessJPAEntity) updatedEntity).getValue()).isEqualTo(&quot;updatedValue&quot;);</span>
<span class="nc" id="L567">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>