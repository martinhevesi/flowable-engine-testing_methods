<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultCmmnHistoryManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.cmmn.engine.impl.history</a> &gt; <span class="el_source">DefaultCmmnHistoryManager.java</span></div><h1>DefaultCmmnHistoryManager.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.cmmn.engine.impl.history;

import java.util.Collection;
import java.util.Date;
import java.util.List;
import java.util.function.Consumer;

import org.apache.commons.lang3.StringUtils;
import org.flowable.cmmn.api.history.HistoricMilestoneInstance;
import org.flowable.cmmn.api.history.HistoricPlanItemInstance;
import org.flowable.cmmn.api.repository.CaseDefinition;
import org.flowable.cmmn.engine.CmmnEngineConfiguration;
import org.flowable.cmmn.engine.impl.persistence.entity.CaseInstanceEntity;
import org.flowable.cmmn.engine.impl.persistence.entity.HistoricCaseInstanceEntity;
import org.flowable.cmmn.engine.impl.persistence.entity.HistoricCaseInstanceEntityManager;
import org.flowable.cmmn.engine.impl.persistence.entity.HistoricMilestoneInstanceEntity;
import org.flowable.cmmn.engine.impl.persistence.entity.HistoricMilestoneInstanceEntityManager;
import org.flowable.cmmn.engine.impl.persistence.entity.HistoricPlanItemInstanceEntity;
import org.flowable.cmmn.engine.impl.persistence.entity.HistoricPlanItemInstanceEntityManager;
import org.flowable.cmmn.engine.impl.persistence.entity.MilestoneInstanceEntity;
import org.flowable.cmmn.engine.impl.persistence.entity.PlanItemInstanceEntity;
import org.flowable.cmmn.engine.impl.task.TaskHelper;
import org.flowable.cmmn.model.Milestone;
import org.flowable.cmmn.model.PlanItemDefinition;
import org.flowable.cmmn.model.Stage;
import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.api.delegate.Expression;
import org.flowable.entitylink.api.history.HistoricEntityLinkService;
import org.flowable.entitylink.service.impl.persistence.entity.EntityLinkEntity;
import org.flowable.entitylink.service.impl.persistence.entity.HistoricEntityLinkEntity;
import org.flowable.identitylink.service.HistoricIdentityLinkService;
import org.flowable.identitylink.service.impl.persistence.entity.HistoricIdentityLinkEntity;
import org.flowable.identitylink.service.impl.persistence.entity.IdentityLinkEntity;
import org.flowable.task.api.Task;
import org.flowable.task.api.history.HistoricTaskInstance;
import org.flowable.task.api.history.HistoricTaskLogEntryBuilder;
import org.flowable.task.service.HistoricTaskService;
import org.flowable.task.service.impl.HistoricTaskInstanceQueryImpl;
import org.flowable.task.service.impl.persistence.entity.HistoricTaskInstanceEntity;
import org.flowable.task.service.impl.persistence.entity.TaskEntity;
import org.flowable.variable.service.impl.persistence.entity.VariableInstanceEntity;

/**
 * @author Joram Barrez
 */
public class DefaultCmmnHistoryManager implements CmmnHistoryManager {

    protected CmmnEngineConfiguration cmmnEngineConfiguration;

<span class="nc" id="L62">    public DefaultCmmnHistoryManager(CmmnEngineConfiguration cmmnEngineConfiguration) {</span>
<span class="nc" id="L63">        this.cmmnEngineConfiguration = cmmnEngineConfiguration;</span>
<span class="nc" id="L64">    }</span>
    
    protected CmmnHistoryConfigurationSettings getHistoryConfigurationSettings() {
<span class="nc" id="L67">        return cmmnEngineConfiguration.getCmmnHistoryConfigurationSettings();</span>
    }

    @Override
    public void recordCaseInstanceStart(CaseInstanceEntity caseInstanceEntity) {
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabledForCaseInstance(caseInstanceEntity)) {</span>
<span class="nc" id="L73">            HistoricCaseInstanceEntityManager historicCaseInstanceEntityManager = cmmnEngineConfiguration.getHistoricCaseInstanceEntityManager();</span>
<span class="nc" id="L74">            HistoricCaseInstanceEntity historicCaseInstanceEntity = cmmnEngineConfiguration.getHistoricCaseInstanceEntityManager().create(caseInstanceEntity);</span>
<span class="nc" id="L75">            historicCaseInstanceEntityManager.insert(historicCaseInstanceEntity);</span>
        }
<span class="nc" id="L77">    }</span>

    @Override
    public void recordCaseInstanceEnd(CaseInstanceEntity caseInstanceEntity, String state, Date endTime) {
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabledForCaseInstance(caseInstanceEntity)) {</span>
<span class="nc" id="L82">            HistoricCaseInstanceEntityManager historicCaseInstanceEntityManager = cmmnEngineConfiguration.getHistoricCaseInstanceEntityManager();</span>
<span class="nc" id="L83">            HistoricCaseInstanceEntity historicCaseInstanceEntity = historicCaseInstanceEntityManager.findById(caseInstanceEntity.getId());</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">            if (historicCaseInstanceEntity != null) {</span>
<span class="nc" id="L85">                historicCaseInstanceEntity.setEndTime(endTime);</span>
<span class="nc" id="L86">                historicCaseInstanceEntity.setState(state);</span>
            }
        }
<span class="nc" id="L89">    }</span>

    @Override
    public void recordHistoricCaseInstanceReactivated(CaseInstanceEntity caseInstanceEntity) {
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabledForCaseInstance(caseInstanceEntity)) {</span>
            // Update the historic one to NOT be ended anymore as we reactivated it again
<span class="nc" id="L95">            HistoricCaseInstanceEntityManager historicCaseInstanceEntityManager = cmmnEngineConfiguration.getHistoricCaseInstanceEntityManager();</span>
<span class="nc" id="L96">            HistoricCaseInstanceEntity historicCaseInstanceEntity = historicCaseInstanceEntityManager.findById(caseInstanceEntity.getId());</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">            if (historicCaseInstanceEntity != null) {</span>
<span class="nc" id="L98">                historicCaseInstanceEntity.setEndTime(null);</span>
<span class="nc" id="L99">                historicCaseInstanceEntity.setState(caseInstanceEntity.getState());</span>
<span class="nc" id="L100">                historicCaseInstanceEntity.setLastReactivationTime(caseInstanceEntity.getLastReactivationTime());</span>
<span class="nc" id="L101">                historicCaseInstanceEntity.setLastReactivationUserId(caseInstanceEntity.getLastReactivationUserId());</span>
            }
        }
<span class="nc" id="L104">    }</span>

    @Override
    public void recordUpdateCaseInstanceName(CaseInstanceEntity caseInstanceEntity, String name) {
<span class="nc bnc" id="L108" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabledForCaseInstance(caseInstanceEntity)) {</span>
<span class="nc" id="L109">            HistoricCaseInstanceEntityManager historicCaseInstanceEntityManager = cmmnEngineConfiguration.getHistoricCaseInstanceEntityManager();</span>
<span class="nc" id="L110">            HistoricCaseInstanceEntity historicCaseInstanceEntity = historicCaseInstanceEntityManager.findById(caseInstanceEntity.getId());</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">            if (historicCaseInstanceEntity != null) {</span>
<span class="nc" id="L112">                historicCaseInstanceEntity.setName(name);</span>
            }
        }
<span class="nc" id="L115">    }</span>

    @Override
    public void recordUpdateBusinessKey(CaseInstanceEntity caseInstanceEntity, String businessKey) {
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (caseInstanceEntity != null) {</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">            if (getHistoryConfigurationSettings().isHistoryEnabledForCaseInstance(caseInstanceEntity)) {</span>
<span class="nc" id="L121">                HistoricCaseInstanceEntityManager historicCaseInstanceEntityManager = cmmnEngineConfiguration.getHistoricCaseInstanceEntityManager();</span>
<span class="nc" id="L122">                HistoricCaseInstanceEntity historicCaseInstanceEntity = historicCaseInstanceEntityManager.findById(caseInstanceEntity.getId());</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">                if (historicCaseInstanceEntity != null) {</span>
<span class="nc" id="L124">                    historicCaseInstanceEntity.setBusinessKey(businessKey);</span>
                }
            }
        }
<span class="nc" id="L128">    }</span>
    
    @Override
    public void recordUpdateBusinessStatus(CaseInstanceEntity caseInstanceEntity, String businessStatus) {
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (caseInstanceEntity != null) {</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">            if (getHistoryConfigurationSettings().isHistoryEnabledForCaseInstance(caseInstanceEntity)) {</span>
<span class="nc" id="L134">                HistoricCaseInstanceEntityManager historicCaseInstanceEntityManager = cmmnEngineConfiguration.getHistoricCaseInstanceEntityManager();</span>
<span class="nc" id="L135">                HistoricCaseInstanceEntity historicCaseInstanceEntity = historicCaseInstanceEntityManager.findById(caseInstanceEntity.getId());</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">                if (historicCaseInstanceEntity != null) {</span>
<span class="nc" id="L137">                    historicCaseInstanceEntity.setBusinessStatus(businessStatus);</span>
                }
            }
        }
<span class="nc" id="L141">    }</span>

    @Override
    public void recordMilestoneReached(MilestoneInstanceEntity milestoneInstance) {
<span class="nc bnc" id="L145" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabledForMilestone(milestoneInstance)) {</span>
<span class="nc" id="L146">            HistoricMilestoneInstanceEntityManager historicMilestoneInstanceEntityManager = cmmnEngineConfiguration.getHistoricMilestoneInstanceEntityManager();</span>
<span class="nc" id="L147">            HistoricMilestoneInstanceEntity historicMilestoneInstanceEntity = historicMilestoneInstanceEntityManager.create();</span>
<span class="nc" id="L148">            historicMilestoneInstanceEntity.setId(milestoneInstance.getId());</span>
<span class="nc" id="L149">            historicMilestoneInstanceEntity.setName(milestoneInstance.getName());</span>
<span class="nc" id="L150">            historicMilestoneInstanceEntity.setCaseInstanceId(milestoneInstance.getCaseInstanceId());</span>
<span class="nc" id="L151">            historicMilestoneInstanceEntity.setCaseDefinitionId(milestoneInstance.getCaseDefinitionId());</span>
<span class="nc" id="L152">            historicMilestoneInstanceEntity.setElementId(milestoneInstance.getElementId());</span>
<span class="nc" id="L153">            historicMilestoneInstanceEntity.setTimeStamp(cmmnEngineConfiguration.getClock().getCurrentTime());</span>
<span class="nc" id="L154">            historicMilestoneInstanceEntity.setTenantId(milestoneInstance.getTenantId());</span>
<span class="nc" id="L155">            historicMilestoneInstanceEntityManager.insert(historicMilestoneInstanceEntity);</span>
        }
<span class="nc" id="L157">    }</span>

    @Override
    public void recordHistoricCaseInstanceDeleted(String caseInstanceId, String tenantId) {
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabled()) {</span>
<span class="nc" id="L162">            CmmnHistoryHelper.deleteHistoricCaseInstance(cmmnEngineConfiguration, caseInstanceId);</span>
        }
<span class="nc" id="L164">    } </span>

    @Override
    public void recordBulkDeleteHistoricCaseInstances(Collection&lt;String&gt; caseInstanceIds) {
<span class="nc bnc" id="L168" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabled()) {</span>
<span class="nc" id="L169">            CmmnHistoryHelper.bulkDeleteHistoricCaseInstances(caseInstanceIds, cmmnEngineConfiguration);</span>
        }
<span class="nc" id="L171">    }</span>

    @Override
    public void recordIdentityLinkCreated(IdentityLinkEntity identityLink) {
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabledForIdentityLink(identityLink)</span>
<span class="nc bnc" id="L176" title="All 4 branches missed.">                &amp;&amp; (identityLink.getScopeId() != null || identityLink.getTaskId() != null)) {</span>
<span class="nc" id="L177">            HistoricIdentityLinkService historicIdentityLinkService = cmmnEngineConfiguration.getIdentityLinkServiceConfiguration().getHistoricIdentityLinkService();</span>
<span class="nc" id="L178">            HistoricIdentityLinkEntity historicIdentityLinkEntity = historicIdentityLinkService.createHistoricIdentityLink();</span>
<span class="nc" id="L179">            historicIdentityLinkEntity.setId(identityLink.getId());</span>
<span class="nc" id="L180">            historicIdentityLinkEntity.setGroupId(identityLink.getGroupId());</span>
<span class="nc" id="L181">            historicIdentityLinkEntity.setScopeDefinitionId(identityLink.getScopeDefinitionId());</span>
<span class="nc" id="L182">            historicIdentityLinkEntity.setScopeId(identityLink.getScopeId());</span>
<span class="nc" id="L183">            historicIdentityLinkEntity.setSubScopeId(identityLink.getSubScopeId());</span>
<span class="nc" id="L184">            historicIdentityLinkEntity.setScopeType(identityLink.getScopeType());</span>
<span class="nc" id="L185">            historicIdentityLinkEntity.setTaskId(identityLink.getTaskId());</span>
<span class="nc" id="L186">            historicIdentityLinkEntity.setType(identityLink.getType());</span>
<span class="nc" id="L187">            historicIdentityLinkEntity.setUserId(identityLink.getUserId());</span>
<span class="nc" id="L188">            historicIdentityLinkService.insertHistoricIdentityLink(historicIdentityLinkEntity, false);</span>
        }
<span class="nc" id="L190">    }</span>

    @Override
    public void recordIdentityLinkDeleted(IdentityLinkEntity identityLink) {
<span class="nc bnc" id="L194" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabledForIdentityLink(identityLink)) {</span>
<span class="nc" id="L195">            cmmnEngineConfiguration.getIdentityLinkServiceConfiguration().getHistoricIdentityLinkService().deleteHistoricIdentityLink(identityLink.getId());</span>
        }
<span class="nc" id="L197">    }</span>
    
    @Override
    public void recordEntityLinkCreated(EntityLinkEntity entityLink) {
<span class="nc bnc" id="L201" title="All 4 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabledForEntityLink(entityLink) &amp;&amp; entityLink.getScopeId() != null) {</span>
<span class="nc" id="L202">            HistoricEntityLinkService historicEntityLinkService = cmmnEngineConfiguration.getEntityLinkServiceConfiguration().getHistoricEntityLinkService();</span>
<span class="nc" id="L203">            HistoricEntityLinkEntity historicEntityLinkEntity = (HistoricEntityLinkEntity) historicEntityLinkService.createHistoricEntityLink();</span>
<span class="nc" id="L204">            historicEntityLinkEntity.setId(entityLink.getId());</span>
<span class="nc" id="L205">            historicEntityLinkEntity.setLinkType(entityLink.getLinkType());</span>
<span class="nc" id="L206">            historicEntityLinkEntity.setCreateTime(entityLink.getCreateTime());</span>
<span class="nc" id="L207">            historicEntityLinkEntity.setScopeId(entityLink.getScopeId());</span>
<span class="nc" id="L208">            historicEntityLinkEntity.setSubScopeId(entityLink.getSubScopeId());</span>
<span class="nc" id="L209">            historicEntityLinkEntity.setScopeType(entityLink.getScopeType());</span>
<span class="nc" id="L210">            historicEntityLinkEntity.setScopeDefinitionId(entityLink.getScopeDefinitionId());</span>
<span class="nc" id="L211">            historicEntityLinkEntity.setParentElementId(entityLink.getParentElementId());</span>
<span class="nc" id="L212">            historicEntityLinkEntity.setReferenceScopeId(entityLink.getReferenceScopeId());</span>
<span class="nc" id="L213">            historicEntityLinkEntity.setReferenceScopeType(entityLink.getReferenceScopeType());</span>
<span class="nc" id="L214">            historicEntityLinkEntity.setReferenceScopeDefinitionId(entityLink.getReferenceScopeDefinitionId());</span>
<span class="nc" id="L215">            historicEntityLinkEntity.setRootScopeId(entityLink.getRootScopeId());</span>
<span class="nc" id="L216">            historicEntityLinkEntity.setRootScopeType(entityLink.getRootScopeType());</span>
<span class="nc" id="L217">            historicEntityLinkEntity.setHierarchyType(entityLink.getHierarchyType());</span>
<span class="nc" id="L218">            historicEntityLinkService.insertHistoricEntityLink(historicEntityLinkEntity, false);</span>
        }
<span class="nc" id="L220">    }</span>

    @Override
    public void recordEntityLinkDeleted(EntityLinkEntity entityLink) {
<span class="nc bnc" id="L224" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabledForEntityLink(entityLink)) {</span>
<span class="nc" id="L225">            cmmnEngineConfiguration.getEntityLinkServiceConfiguration().getHistoricEntityLinkService().deleteHistoricEntityLink(entityLink.getId());</span>
        }
<span class="nc" id="L227">    }</span>

    @Override
    public void recordVariableCreate(VariableInstanceEntity variableInstanceEntity, Date createTime) {
<span class="nc bnc" id="L231" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabledForVariableInstance(variableInstanceEntity)) {</span>
<span class="nc" id="L232">            cmmnEngineConfiguration.getVariableServiceConfiguration().getHistoricVariableService().createAndInsert(variableInstanceEntity, createTime);</span>
        }
<span class="nc" id="L234">    }</span>

    @Override
    public void recordVariableUpdate(VariableInstanceEntity variableInstanceEntity, Date updateTime) {
<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabledForVariableInstance(variableInstanceEntity)) {</span>
<span class="nc" id="L239">            cmmnEngineConfiguration.getVariableServiceConfiguration().getHistoricVariableService().recordVariableUpdate(variableInstanceEntity, updateTime);</span>
        }
<span class="nc" id="L241">    }</span>

    @Override
    public void recordVariableRemoved(VariableInstanceEntity variableInstanceEntity) {
<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabledForVariableInstance(variableInstanceEntity)) {</span>
<span class="nc" id="L246">            cmmnEngineConfiguration.getVariableServiceConfiguration().getHistoricVariableService().recordVariableRemoved(variableInstanceEntity);</span>
        }
<span class="nc" id="L248">    }</span>

    @Override
    public void recordTaskCreated(TaskEntity task) {
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabledForUserTask(task)) {</span>
<span class="nc" id="L253">            cmmnEngineConfiguration.getTaskServiceConfiguration().getHistoricTaskService().recordTaskCreated(task);</span>
        }
<span class="nc" id="L255">    }</span>

    @Override
    public void recordTaskEnd(TaskEntity task, String userId, String deleteReason, Date endTime) {
<span class="nc bnc" id="L259" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabledForUserTask(task)) {</span>
<span class="nc" id="L260">            HistoricTaskInstanceEntity historicTaskInstance = cmmnEngineConfiguration.getTaskServiceConfiguration().getHistoricTaskService().recordTaskEnd(task, deleteReason, endTime);</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">            if (historicTaskInstance != null) {</span>
<span class="nc" id="L262">                historicTaskInstance.setState(Task.COMPLETED);</span>
<span class="nc" id="L263">                historicTaskInstance.setCompletedBy(userId);</span>
<span class="nc" id="L264">                historicTaskInstance.setLastUpdateTime(endTime);</span>
            }
        }
<span class="nc" id="L267">    }</span>

    @Override
    public void recordTaskInfoChange(TaskEntity task, Date changeTime) {
<span class="nc bnc" id="L271" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabledForUserTask(task)) {</span>
<span class="nc" id="L272">            cmmnEngineConfiguration.getTaskServiceConfiguration().getHistoricTaskService().recordTaskInfoChange(task, changeTime, cmmnEngineConfiguration);</span>
        }
<span class="nc" id="L274">    }</span>

    @Override
    public void recordHistoricTaskDeleted(HistoricTaskInstance task) {
<span class="nc bnc" id="L278" title="All 4 branches missed.">        if (task != null &amp;&amp; getHistoryConfigurationSettings().isHistoryEnabledForUserTask(task)) {</span>
<span class="nc" id="L279">            TaskHelper.deleteHistoricTask(task.getId(), cmmnEngineConfiguration);</span>
        }
<span class="nc" id="L281">    }</span>

    @Override
    public void recordPlanItemInstanceCreated(PlanItemInstanceEntity planItemInstanceEntity) {
<span class="nc bnc" id="L285" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabledForPlanItemInstance(planItemInstanceEntity)) {</span>
<span class="nc" id="L286">            HistoricPlanItemInstanceEntityManager historicPlanItemInstanceEntityManager = cmmnEngineConfiguration.getHistoricPlanItemInstanceEntityManager();</span>
<span class="nc" id="L287">            HistoricPlanItemInstanceEntity historicPlanItemInstanceEntity = historicPlanItemInstanceEntityManager.create(planItemInstanceEntity);</span>
<span class="nc" id="L288">            historicPlanItemInstanceEntity.setShowInOverview(evaluateShowInOverview(planItemInstanceEntity));</span>
            
<span class="nc" id="L290">            historicPlanItemInstanceEntityManager.insert(historicPlanItemInstanceEntity);</span>
        }
<span class="nc" id="L292">    }</span>

    @Override
    public void recordPlanItemInstanceReactivated(PlanItemInstanceEntity planItemInstanceEntity) {
<span class="nc bnc" id="L296" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabledForPlanItemInstance(planItemInstanceEntity)) {</span>
<span class="nc" id="L297">            HistoricPlanItemInstanceEntityManager historicPlanItemInstanceEntityManager = cmmnEngineConfiguration.getHistoricPlanItemInstanceEntityManager();</span>
<span class="nc" id="L298">            HistoricPlanItemInstanceEntity historicPlanItemInstanceEntity = historicPlanItemInstanceEntityManager.create(planItemInstanceEntity);</span>
<span class="nc" id="L299">            historicPlanItemInstanceEntity.setShowInOverview(evaluateShowInOverview(planItemInstanceEntity));</span>

<span class="nc" id="L301">            historicPlanItemInstanceEntityManager.insert(historicPlanItemInstanceEntity);</span>
            // TODO: do we need a specific flag to mark this entity being created because of a reactivation?
        }
<span class="nc" id="L304">    }</span>

    @Override
    public void recordPlanItemInstanceUpdated(PlanItemInstanceEntity planItemInstanceEntity) {
<span class="nc bnc" id="L308" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabledForPlanItemInstance(planItemInstanceEntity)) {</span>
<span class="nc" id="L309">            HistoricPlanItemInstanceEntityManager historicPlanItemInstanceEntityManager = cmmnEngineConfiguration.getHistoricPlanItemInstanceEntityManager();</span>
<span class="nc" id="L310">            HistoricPlanItemInstanceEntity historicPlanItemInstanceEntity = historicPlanItemInstanceEntityManager.findById(planItemInstanceEntity.getId());</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">            if (historicPlanItemInstanceEntity != null) {</span>
<span class="nc" id="L312">                historicPlanItemInstanceEntity.setFormKey(planItemInstanceEntity.getFormKey());</span>
<span class="nc" id="L313">                historicPlanItemInstanceEntity.setElementId(planItemInstanceEntity.getElementId());</span>
<span class="nc" id="L314">                historicPlanItemInstanceEntity.setPlanItemDefinitionId(planItemInstanceEntity.getPlanItemDefinitionId());</span>
            }
        }
<span class="nc" id="L317">    }</span>

    @Override
    public void recordPlanItemInstanceAvailable(PlanItemInstanceEntity planItemInstanceEntity) {
<span class="nc" id="L321">        recordHistoricPlanItemInstanceEntity(planItemInstanceEntity, planItemInstanceEntity.getLastAvailableTime(),</span>
<span class="nc" id="L322">            h -&gt; h.setLastAvailableTime(planItemInstanceEntity.getLastAvailableTime()));</span>
<span class="nc" id="L323">    }</span>

    @Override
    public void recordPlanItemInstanceUnavailable(PlanItemInstanceEntity planItemInstanceEntity) {
<span class="nc" id="L327">        recordHistoricPlanItemInstanceEntity(planItemInstanceEntity, planItemInstanceEntity.getLastUnavailableTime(),</span>
<span class="nc" id="L328">            h -&gt; h.setLastUnavailableTime(planItemInstanceEntity.getLastUnavailableTime()));</span>
<span class="nc" id="L329">    }</span>

    @Override
    public void recordPlanItemInstanceEnabled(PlanItemInstanceEntity planItemInstanceEntity) {
<span class="nc" id="L333">        recordHistoricPlanItemInstanceEntity(planItemInstanceEntity, planItemInstanceEntity.getLastEnabledTime(),</span>
<span class="nc" id="L334">            h -&gt; h.setLastEnabledTime(planItemInstanceEntity.getLastEnabledTime()));</span>
<span class="nc" id="L335">    }</span>

    @Override
    public void recordPlanItemInstanceDisabled(PlanItemInstanceEntity planItemInstanceEntity) {
<span class="nc" id="L339">        recordHistoricPlanItemInstanceEntity(planItemInstanceEntity, planItemInstanceEntity.getLastDisabledTime(),</span>
<span class="nc" id="L340">            h -&gt; h.setLastDisabledTime(planItemInstanceEntity.getLastDisabledTime()));</span>
<span class="nc" id="L341">    }</span>

    @Override
    public void recordPlanItemInstanceStarted(PlanItemInstanceEntity planItemInstanceEntity) {
<span class="nc" id="L345">        recordHistoricPlanItemInstanceEntity(planItemInstanceEntity, planItemInstanceEntity.getLastStartedTime(),</span>
            h -&gt; {
<span class="nc" id="L347">                h.setLastStartedTime(planItemInstanceEntity.getLastStartedTime());</span>
<span class="nc" id="L348">                h.setShowInOverview(evaluateShowInOverview(planItemInstanceEntity));</span>

                // Can be updated when the plan item instance starts
<span class="nc" id="L351">                h.setReferenceId(planItemInstanceEntity.getReferenceId());</span>
<span class="nc" id="L352">                h.setReferenceType(planItemInstanceEntity.getReferenceType());</span>
<span class="nc" id="L353">            });</span>
<span class="nc" id="L354">    }</span>

    @Override
    public void recordPlanItemInstanceSuspended(PlanItemInstanceEntity planItemInstanceEntity) {
<span class="nc" id="L358">        recordHistoricPlanItemInstanceEntity(planItemInstanceEntity, planItemInstanceEntity.getLastSuspendedTime(),</span>
<span class="nc" id="L359">            h -&gt; h.setLastSuspendedTime(planItemInstanceEntity.getLastSuspendedTime()));</span>
<span class="nc" id="L360">    }</span>

    @Override
    public void recordPlanItemInstanceCompleted(PlanItemInstanceEntity planItemInstanceEntity) {
<span class="nc" id="L364">        Date completedTime = planItemInstanceEntity.getCompletedTime();</span>
<span class="nc" id="L365">        recordHistoricPlanItemInstanceEntity(planItemInstanceEntity, completedTime,</span>
            h -&gt; {
<span class="nc" id="L367">                h.setEndedTime(completedTime);</span>
<span class="nc" id="L368">                h.setCompletedTime(completedTime);</span>
<span class="nc" id="L369">                h.setShowInOverview(evaluateShowInOverview(planItemInstanceEntity));</span>
<span class="nc" id="L370">            });</span>
<span class="nc" id="L371">    }</span>

    @Override
    public void recordPlanItemInstanceTerminated(PlanItemInstanceEntity planItemInstanceEntity) {
<span class="nc" id="L375">        Date terminatedTime = planItemInstanceEntity.getTerminatedTime();</span>
<span class="nc" id="L376">        recordHistoricPlanItemInstanceEntity(planItemInstanceEntity, terminatedTime,</span>
            h -&gt; {
<span class="nc" id="L378">                h.setEndedTime(terminatedTime);</span>
<span class="nc" id="L379">                h.setTerminatedTime(terminatedTime);</span>
<span class="nc" id="L380">                h.setShowInOverview(evaluateShowInOverview(planItemInstanceEntity));</span>
<span class="nc" id="L381">            });</span>
<span class="nc" id="L382">    }</span>

    @Override
    public void recordPlanItemInstanceOccurred(PlanItemInstanceEntity planItemInstanceEntity) {
<span class="nc" id="L386">        Date occurredTime = planItemInstanceEntity.getOccurredTime();</span>
<span class="nc" id="L387">        recordHistoricPlanItemInstanceEntity(planItemInstanceEntity, occurredTime,</span>
            h -&gt; {
<span class="nc" id="L389">                h.setEndedTime(occurredTime);</span>
<span class="nc" id="L390">                h.setOccurredTime(occurredTime);</span>
<span class="nc" id="L391">                h.setShowInOverview(evaluateShowInOverview(planItemInstanceEntity));</span>
<span class="nc" id="L392">        });</span>
<span class="nc" id="L393">    }</span>

    @Override
    public void recordPlanItemInstanceExit(PlanItemInstanceEntity planItemInstanceEntity) {
<span class="nc" id="L397">        Date exitTime = planItemInstanceEntity.getExitTime();</span>
<span class="nc" id="L398">        recordHistoricPlanItemInstanceEntity(planItemInstanceEntity, exitTime,</span>
            h -&gt; {
<span class="nc" id="L400">                h.setEndedTime(exitTime);</span>
<span class="nc" id="L401">                h.setExitTime(exitTime);</span>
<span class="nc" id="L402">            });</span>
<span class="nc" id="L403">    }</span>
    
    @Override
    public void updateCaseDefinitionIdInHistory(CaseDefinition caseDefinition, CaseInstanceEntity caseInstance) {
<span class="nc bnc" id="L407" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabled(caseDefinition.getId())) {</span>
<span class="nc" id="L408">            HistoricCaseInstanceEntityManager historicCaseInstanceEntityManager = cmmnEngineConfiguration.getHistoricCaseInstanceEntityManager();</span>
<span class="nc" id="L409">            HistoricCaseInstanceEntity historicCaseInstance = historicCaseInstanceEntityManager.findById(caseInstance.getId());</span>
<span class="nc" id="L410">            historicCaseInstance.setCaseDefinitionId(caseDefinition.getId());</span>
<span class="nc" id="L411">            historicCaseInstanceEntityManager.update(historicCaseInstance);</span>
    
<span class="nc" id="L413">            HistoricTaskService historicTaskService = cmmnEngineConfiguration.getTaskServiceConfiguration().getHistoricTaskService();</span>
<span class="nc" id="L414">            HistoricTaskInstanceQueryImpl taskQuery = new HistoricTaskInstanceQueryImpl();</span>
<span class="nc" id="L415">            taskQuery.caseInstanceId(caseInstance.getId());</span>
<span class="nc" id="L416">            List&lt;HistoricTaskInstance&gt; historicTasks = historicTaskService.findHistoricTaskInstancesByQueryCriteria(taskQuery);</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">            if (historicTasks != null) {</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">                for (HistoricTaskInstance historicTaskInstance : historicTasks) {</span>
<span class="nc" id="L419">                    HistoricTaskInstanceEntity taskEntity = (HistoricTaskInstanceEntity) historicTaskInstance;</span>
<span class="nc" id="L420">                    taskEntity.setScopeDefinitionId(caseDefinition.getId());</span>
<span class="nc" id="L421">                    historicTaskService.updateHistoricTask(taskEntity, true);</span>
<span class="nc" id="L422">                }</span>
            }

            // because of upgrade runtimeActivity instances can be only subset of historicActivity instances
<span class="nc" id="L426">            HistoricPlanItemInstanceQueryImpl historicPlanItemQuery = new HistoricPlanItemInstanceQueryImpl();</span>
<span class="nc" id="L427">            historicPlanItemQuery.planItemInstanceCaseInstanceId(caseInstance.getId());</span>
<span class="nc" id="L428">            HistoricPlanItemInstanceEntityManager historicPlanItemInstanceEntityManager = cmmnEngineConfiguration.getHistoricPlanItemInstanceEntityManager();</span>
<span class="nc" id="L429">            List&lt;HistoricPlanItemInstance&gt; historicPlanItems = historicPlanItemInstanceEntityManager.findByCriteria(historicPlanItemQuery);</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">            if (historicPlanItems != null) {</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">                for (HistoricPlanItemInstance historicPlanItemInstance : historicPlanItems) {</span>
<span class="nc" id="L432">                    HistoricPlanItemInstanceEntity planItemEntity = (HistoricPlanItemInstanceEntity) historicPlanItemInstance;</span>
<span class="nc" id="L433">                    planItemEntity.setCaseDefinitionId(caseDefinition.getId());</span>
<span class="nc" id="L434">                    historicPlanItemInstanceEntityManager.update(planItemEntity);</span>
<span class="nc" id="L435">                }</span>
            }
            
<span class="nc" id="L438">            HistoricMilestoneInstanceQueryImpl historicMilestoneInstanceQuery = new HistoricMilestoneInstanceQueryImpl();</span>
<span class="nc" id="L439">            historicMilestoneInstanceQuery.milestoneInstanceCaseInstanceId(caseInstance.getId());</span>
<span class="nc" id="L440">            HistoricMilestoneInstanceEntityManager historicMilestoneInstanceEntityManager = cmmnEngineConfiguration.getHistoricMilestoneInstanceEntityManager();</span>
<span class="nc" id="L441">            List&lt;HistoricMilestoneInstance&gt; historicMilestoneInstances = historicMilestoneInstanceEntityManager.findHistoricMilestoneInstancesByQueryCriteria(historicMilestoneInstanceQuery);</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">            if (historicMilestoneInstances != null) {</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">                for (HistoricMilestoneInstance historicMilestoneInstance : historicMilestoneInstances) {</span>
<span class="nc" id="L444">                    HistoricMilestoneInstanceEntity milestoneEntity = (HistoricMilestoneInstanceEntity) historicMilestoneInstance;</span>
<span class="nc" id="L445">                    milestoneEntity.setCaseDefinitionId(caseDefinition.getId());</span>
<span class="nc" id="L446">                    historicMilestoneInstanceEntityManager.update(milestoneEntity);</span>
<span class="nc" id="L447">                }</span>
            }
        }
<span class="nc" id="L450">    }</span>

    @Override
    public void recordHistoricUserTaskLogEntry(HistoricTaskLogEntryBuilder taskLogEntryBuilder) {
<span class="nc" id="L454">        cmmnEngineConfiguration.getTaskServiceConfiguration().getHistoricTaskService().createHistoricTaskLogEntry(taskLogEntryBuilder);</span>
<span class="nc" id="L455">    }</span>

    @Override
    public void deleteHistoricUserTaskLogEntry(long logNumber) {
<span class="nc" id="L459">        cmmnEngineConfiguration.getTaskServiceConfiguration().getHistoricTaskService().deleteHistoricTaskLogEntry(logNumber);</span>
<span class="nc" id="L460">    }</span>

    protected void recordHistoricPlanItemInstanceEntity(PlanItemInstanceEntity planItemInstanceEntity, Date lastUpdatedTime, Consumer&lt;HistoricPlanItemInstanceEntity&gt; changes) {
<span class="nc bnc" id="L463" title="All 2 branches missed.">        if (getHistoryConfigurationSettings().isHistoryEnabledForPlanItemInstance(planItemInstanceEntity)) {</span>
<span class="nc" id="L464">            HistoricPlanItemInstanceEntityManager historicPlanItemInstanceEntityManager = cmmnEngineConfiguration.getHistoricPlanItemInstanceEntityManager();</span>
<span class="nc" id="L465">            HistoricPlanItemInstanceEntity historicPlanItemInstanceEntity = historicPlanItemInstanceEntityManager.findById(planItemInstanceEntity.getId());</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">            if (historicPlanItemInstanceEntity != null) {</span>

<span class="nc" id="L468">                historicPlanItemInstanceEntity.setState(planItemInstanceEntity.getState());</span>
<span class="nc" id="L469">                historicPlanItemInstanceEntity.setLastUpdatedTime(lastUpdatedTime);</span>
<span class="nc" id="L470">                changes.accept(historicPlanItemInstanceEntity);</span>

                // Can be updated on state change
<span class="nc" id="L473">                historicPlanItemInstanceEntity.setEntryCriterionId(planItemInstanceEntity.getEntryCriterionId());</span>
<span class="nc" id="L474">                historicPlanItemInstanceEntity.setExitCriterionId(planItemInstanceEntity.getExitCriterionId());</span>
            }
        }
<span class="nc" id="L477">    }</span>
    
    public boolean evaluateShowInOverview(PlanItemInstanceEntity planItemInstanceEntity) {
<span class="nc" id="L480">        boolean showInOverview = false;</span>
        
<span class="nc bnc" id="L482" title="All 2 branches missed.">        if (planItemInstanceEntity.getPlanItem() != null) {</span>
<span class="nc" id="L483">            PlanItemDefinition planItemDefinition = planItemInstanceEntity.getPlanItem().getPlanItemDefinition();</span>
<span class="nc" id="L484">            String includeInStageOverviewValue = null;</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">            if (planItemInstanceEntity.isStage()) {</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">                if (planItemDefinition instanceof Stage) {</span>
<span class="nc" id="L487">                    Stage stage = (Stage) planItemDefinition;</span>
<span class="nc" id="L488">                    includeInStageOverviewValue = stage.getIncludeInStageOverview();</span>
<span class="nc" id="L489">                }</span>
                
<span class="nc bnc" id="L491" title="All 2 branches missed.">            } else if (planItemDefinition instanceof Milestone) {</span>
<span class="nc" id="L492">                Milestone milestone = (Milestone) planItemDefinition;</span>
<span class="nc" id="L493">                includeInStageOverviewValue = milestone.getIncludeInStageOverview();</span>
            }
            
<span class="nc bnc" id="L496" title="All 2 branches missed.">            if (StringUtils.isNotEmpty(includeInStageOverviewValue)) {</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">                if (&quot;true&quot;.equalsIgnoreCase(includeInStageOverviewValue)) {</span>
<span class="nc" id="L498">                    showInOverview = true;</span>
                
<span class="nc bnc" id="L500" title="All 2 branches missed.">                } else if (!&quot;false&quot;.equalsIgnoreCase(includeInStageOverviewValue)) {</span>
<span class="nc" id="L501">                    Expression stageExpression = cmmnEngineConfiguration.getExpressionManager().createExpression(includeInStageOverviewValue);</span>
<span class="nc" id="L502">                    Object stageValueObject = stageExpression.getValue(planItemInstanceEntity);</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">                    if (!(stageValueObject instanceof Boolean)) {</span>
<span class="nc" id="L504">                        throw new FlowableException(&quot;Include in stage overview expression does not resolve to a boolean value &quot; + </span>
                                        includeInStageOverviewValue + &quot;: &quot; + stageValueObject + &quot; for &quot; + planItemInstanceEntity);
                    }
                    
<span class="nc" id="L508">                    showInOverview = (Boolean) stageValueObject;</span>
                }
            }
        }
        
<span class="nc" id="L513">        return showInOverview;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>