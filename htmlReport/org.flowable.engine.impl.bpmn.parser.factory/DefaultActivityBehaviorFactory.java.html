<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultActivityBehaviorFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.impl.bpmn.parser.factory</a> &gt; <span class="el_source">DefaultActivityBehaviorFactory.java</span></div><h1>DefaultActivityBehaviorFactory.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.engine.impl.bpmn.parser.factory;

import java.util.List;

import org.apache.commons.lang3.StringUtils;
import org.flowable.bpmn.model.Activity;
import org.flowable.bpmn.model.BoundaryEvent;
import org.flowable.bpmn.model.BpmnModel;
import org.flowable.bpmn.model.BusinessRuleTask;
import org.flowable.bpmn.model.CallActivity;
import org.flowable.bpmn.model.CancelEventDefinition;
import org.flowable.bpmn.model.CaseServiceTask;
import org.flowable.bpmn.model.CompensateEventDefinition;
import org.flowable.bpmn.model.ConditionalEventDefinition;
import org.flowable.bpmn.model.EndEvent;
import org.flowable.bpmn.model.ErrorEventDefinition;
import org.flowable.bpmn.model.Escalation;
import org.flowable.bpmn.model.EscalationEventDefinition;
import org.flowable.bpmn.model.EventGateway;
import org.flowable.bpmn.model.EventSubProcess;
import org.flowable.bpmn.model.ExclusiveGateway;
import org.flowable.bpmn.model.ExternalWorkerServiceTask;
import org.flowable.bpmn.model.FieldExtension;
import org.flowable.bpmn.model.ImplementationType;
import org.flowable.bpmn.model.InclusiveGateway;
import org.flowable.bpmn.model.IntermediateCatchEvent;
import org.flowable.bpmn.model.ManualTask;
import org.flowable.bpmn.model.MapExceptionEntry;
import org.flowable.bpmn.model.MessageEventDefinition;
import org.flowable.bpmn.model.ParallelGateway;
import org.flowable.bpmn.model.ReceiveTask;
import org.flowable.bpmn.model.ScriptTask;
import org.flowable.bpmn.model.SendEventServiceTask;
import org.flowable.bpmn.model.SendTask;
import org.flowable.bpmn.model.ServiceTask;
import org.flowable.bpmn.model.Signal;
import org.flowable.bpmn.model.SignalEventDefinition;
import org.flowable.bpmn.model.StartEvent;
import org.flowable.bpmn.model.SubProcess;
import org.flowable.bpmn.model.Task;
import org.flowable.bpmn.model.TaskWithFieldExtensions;
import org.flowable.bpmn.model.TerminateEventDefinition;
import org.flowable.bpmn.model.ThrowEvent;
import org.flowable.bpmn.model.TimerEventDefinition;
import org.flowable.bpmn.model.Transaction;
import org.flowable.bpmn.model.UserTask;
import org.flowable.bpmn.model.VariableListenerEventDefinition;
import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.api.delegate.Expression;
import org.flowable.common.engine.impl.scripting.ScriptingEngines;
import org.flowable.engine.delegate.BusinessRuleTaskDelegate;
import org.flowable.engine.impl.bpmn.behavior.AbstractBpmnActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.AdhocSubProcessActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.BoundaryCancelEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.BoundaryCompensateEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.BoundaryConditionalEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.BoundaryEscalationEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.BoundaryEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.BoundaryEventRegistryEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.BoundaryMessageEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.BoundarySignalEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.BoundaryTimerEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.BoundaryVariableListenerEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.BusinessRuleTaskActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.CallActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.CancelEndEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.CaseTaskActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.DmnActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.ErrorEndEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.EscalationEndEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.EventBasedGatewayActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.EventSubProcessActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.EventSubProcessConditionalStartEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.EventSubProcessErrorStartEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.EventSubProcessEscalationStartEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.EventSubProcessEventRegistryStartEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.EventSubProcessMessageStartEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.EventSubProcessSignalStartEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.EventSubProcessTimerStartEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.EventSubProcessVariableListenerlStartEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.ExclusiveGatewayActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.ExternalWorkerTaskActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.InclusiveGatewayActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.IntermediateCatchConditionalEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.IntermediateCatchEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.IntermediateCatchEventRegistryEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.IntermediateCatchMessageEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.IntermediateCatchSignalEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.IntermediateCatchTimerEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.IntermediateCatchVariableListenerEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.IntermediateThrowCompensationEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.IntermediateThrowEscalationEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.IntermediateThrowNoneEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.IntermediateThrowSignalEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.ManualTaskActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.NoneEndEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.NoneStartEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.ParallelGatewayActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.ParallelMultiInstanceBehavior;
import org.flowable.engine.impl.bpmn.behavior.ReceiveEventTaskActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.ReceiveTaskActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.ScriptTaskActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.SendEventTaskActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.SequentialMultiInstanceBehavior;
import org.flowable.engine.impl.bpmn.behavior.ServiceTaskDelegateExpressionActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.ServiceTaskExpressionActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.ShellActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.SubProcessActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.TaskActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.TerminateEndEventActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.TransactionActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.UserTaskActivityBehavior;
import org.flowable.engine.impl.bpmn.behavior.WebServiceActivityBehavior;
import org.flowable.engine.impl.bpmn.helper.ClassDelegate;
import org.flowable.engine.impl.bpmn.helper.ClassDelegateFactory;
import org.flowable.engine.impl.bpmn.helper.DefaultClassDelegateFactory;
import org.flowable.engine.impl.bpmn.http.DefaultBpmnHttpActivityDelegate;
import org.flowable.engine.impl.bpmn.mail.BpmnMailActivityDelegate;
import org.flowable.engine.impl.bpmn.parser.FieldDeclaration;
import org.flowable.engine.impl.cfg.ProcessEngineConfigurationImpl;
import org.flowable.engine.impl.delegate.ActivityBehavior;

/**
 * Default implementation of the {@link ActivityBehaviorFactory}. Used when no custom {@link ActivityBehaviorFactory} is injected on the {@link ProcessEngineConfigurationImpl}.
 *
 * @author Joram Barrez
 */
public class DefaultActivityBehaviorFactory extends AbstractBehaviorFactory implements ActivityBehaviorFactory {
    private final ClassDelegateFactory classDelegateFactory;

<span class="nc" id="L143">    public DefaultActivityBehaviorFactory(ClassDelegateFactory classDelegateFactory) {</span>
<span class="nc" id="L144">        this.classDelegateFactory = classDelegateFactory;</span>
<span class="nc" id="L145">    }</span>

    public DefaultActivityBehaviorFactory() {
<span class="nc" id="L148">        this(new DefaultClassDelegateFactory());</span>
<span class="nc" id="L149">    }</span>

    // Start event
    public static final String EXCEPTION_MAP_FIELD = &quot;mapExceptions&quot;;

    @Override
    public NoneStartEventActivityBehavior createNoneStartEventActivityBehavior(StartEvent startEvent) {
<span class="nc" id="L156">        return new NoneStartEventActivityBehavior();</span>
    }

    // Task

    @Override
    public TaskActivityBehavior createTaskActivityBehavior(Task task) {
<span class="nc" id="L163">        return new TaskActivityBehavior();</span>
    }

    @Override
    public ManualTaskActivityBehavior createManualTaskActivityBehavior(ManualTask manualTask) {
<span class="nc" id="L168">        return new ManualTaskActivityBehavior();</span>
    }

    @Override
    public ReceiveTaskActivityBehavior createReceiveTaskActivityBehavior(ReceiveTask receiveTask) {
<span class="nc" id="L173">        return new ReceiveTaskActivityBehavior();</span>
    }

    @Override
    public ReceiveEventTaskActivityBehavior createReceiveEventTaskActivityBehavior(ReceiveTask receiveTask, String eventDefinitionKey) {
<span class="nc" id="L178">        return new ReceiveEventTaskActivityBehavior(eventDefinitionKey);</span>
    }

    @Override
    public UserTaskActivityBehavior createUserTaskActivityBehavior(UserTask userTask) {
<span class="nc" id="L183">        return new UserTaskActivityBehavior(userTask);</span>
    }

    // Service task

    protected Expression getSkipExpressionFromServiceTask(ServiceTask serviceTask) {
<span class="nc" id="L189">        return createExpression(serviceTask.getSkipExpression());</span>
    }

    protected Expression createExpression(String expressionValue) {
<span class="nc" id="L193">        Expression expression = null;</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(expressionValue)) {</span>
<span class="nc" id="L195">            expression = expressionManager.createExpression(expressionValue);</span>
        }

<span class="nc" id="L198">        return expression;</span>
    }

    @Override
    public ClassDelegate createClassDelegateServiceTask(ServiceTask serviceTask) {
<span class="nc" id="L203">        return classDelegateFactory.create(serviceTask.getId(), serviceTask.getImplementation(),</span>
<span class="nc" id="L204">                createFieldDeclarations(serviceTask.getFieldExtensions()),</span>
<span class="nc" id="L205">                serviceTask.isTriggerable(),</span>
<span class="nc" id="L206">                getSkipExpressionFromServiceTask(serviceTask), serviceTask.getMapExceptions());</span>
    }

    @Override
    public ServiceTaskDelegateExpressionActivityBehavior createServiceTaskDelegateExpressionActivityBehavior(ServiceTask serviceTask) {
<span class="nc" id="L211">        Expression delegateExpression = expressionManager.createExpression(serviceTask.getImplementation());</span>
<span class="nc" id="L212">        return new ServiceTaskDelegateExpressionActivityBehavior(serviceTask.getId(), delegateExpression,</span>
<span class="nc" id="L213">                getSkipExpressionFromServiceTask(serviceTask), createFieldDeclarations(serviceTask.getFieldExtensions()),</span>
<span class="nc" id="L214">                serviceTask.getMapExceptions(), serviceTask.isTriggerable());</span>
    }

    @Override
    public ServiceTaskExpressionActivityBehavior createServiceTaskExpressionActivityBehavior(ServiceTask serviceTask) {
<span class="nc" id="L219">        Expression expression = expressionManager.createExpression(serviceTask.getImplementation());</span>
<span class="nc" id="L220">        return new ServiceTaskExpressionActivityBehavior(serviceTask, expression, getSkipExpressionFromServiceTask(serviceTask));</span>
    }

    @Override
    public WebServiceActivityBehavior createWebServiceActivityBehavior(ServiceTask serviceTask, BpmnModel bpmnModel) {
<span class="nc" id="L225">        return new WebServiceActivityBehavior(bpmnModel);</span>
    }

    @Override
    public WebServiceActivityBehavior createWebServiceActivityBehavior(SendTask sendTask, BpmnModel bpmnModel) {
<span class="nc" id="L230">        return new WebServiceActivityBehavior(bpmnModel);</span>
    }

    @Override
    public ActivityBehavior createMailActivityBehavior(ServiceTask serviceTask) {
<span class="nc" id="L235">        return classDelegateFactory.create(serviceTask.getId(), BpmnMailActivityDelegate.class.getName(),</span>
<span class="nc" id="L236">                createFieldDeclarations(serviceTask.getFieldExtensions()),</span>
                false, // Mail activity is never triggerable
<span class="nc" id="L238">                getSkipExpressionFromServiceTask(serviceTask), serviceTask.getMapExceptions());</span>
    }

    @Override
    public ActivityBehavior createMailActivityBehavior(SendTask sendTask) {
<span class="nc" id="L243">        return classDelegateFactory.create(BpmnMailActivityDelegate.class.getName(), createFieldDeclarations(sendTask.getFieldExtensions()));</span>
    }

    @Override
    public DmnActivityBehavior createDmnActivityBehavior(ServiceTask serviceTask) {
<span class="nc" id="L248">        return new DmnActivityBehavior(serviceTask);</span>
    }

    @Override
    public DmnActivityBehavior createDmnActivityBehavior(SendTask sendTask) {
<span class="nc" id="L253">        return new DmnActivityBehavior(sendTask);</span>
    }

    // We do not want a hard dependency on Camel, hence we return
    // ActivityBehavior and instantiate the delegate instance using a string instead of the Class itself.
    @Override
    public ActivityBehavior createCamelActivityBehavior(ServiceTask serviceTask) {
<span class="nc" id="L260">        return createCamelActivityBehavior(serviceTask, serviceTask.getFieldExtensions());</span>
    }

    @Override
    public ActivityBehavior createCamelActivityBehavior(SendTask sendTask) {
<span class="nc" id="L265">        return createCamelActivityBehavior(sendTask, sendTask.getFieldExtensions());</span>
    }

    protected ActivityBehavior createCamelActivityBehavior(TaskWithFieldExtensions task, List&lt;FieldExtension&gt; fieldExtensions) {
        try {
<span class="nc" id="L270">            Class&lt;?&gt; theClass = null;</span>
<span class="nc" id="L271">            FieldExtension behaviorExtension = null;</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">            for (FieldExtension fieldExtension : fieldExtensions) {</span>
<span class="nc bnc" id="L273" title="All 4 branches missed.">                if (&quot;camelBehaviorClass&quot;.equals(fieldExtension.getFieldName()) &amp;&amp; StringUtils.isNotEmpty(fieldExtension.getStringValue())) {</span>
<span class="nc" id="L274">                    theClass = Class.forName(fieldExtension.getStringValue());</span>
<span class="nc" id="L275">                    behaviorExtension = fieldExtension;</span>
<span class="nc" id="L276">                    break;</span>
                }
<span class="nc" id="L278">            }</span>

<span class="nc bnc" id="L280" title="All 2 branches missed.">            if (behaviorExtension != null) {</span>
<span class="nc" id="L281">                fieldExtensions.remove(behaviorExtension);</span>
            }

<span class="nc bnc" id="L284" title="All 2 branches missed.">            if (theClass == null) {</span>
                // Default Camel behavior class
<span class="nc" id="L286">                theClass = Class.forName(getDefaultCamelBehaviorClassName());</span>
            }

<span class="nc" id="L289">            List&lt;FieldDeclaration&gt; fieldDeclarations = createFieldDeclarations(fieldExtensions);</span>
<span class="nc" id="L290">            addExceptionMapAsFieldDeclaration(fieldDeclarations, task.getMapExceptions());</span>
<span class="nc" id="L291">            return (ActivityBehavior) ClassDelegate.defaultInstantiateDelegate(</span>
                    theClass, fieldDeclarations);

<span class="nc" id="L294">        } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L295">            throw new FlowableException(&quot;Could not find org.flowable.camel.CamelBehavior: &quot;, e);</span>
        }
    }

	protected String getDefaultCamelBehaviorClassName() {
<span class="nc" id="L300">		return &quot;org.flowable.camel.impl.CamelBehaviorDefaultImpl&quot;;</span>
	}

    private void addExceptionMapAsFieldDeclaration(List&lt;FieldDeclaration&gt; fieldDeclarations, List&lt;MapExceptionEntry&gt; mapExceptions) {
<span class="nc" id="L304">        FieldDeclaration exceptionMapsFieldDeclaration = new FieldDeclaration(EXCEPTION_MAP_FIELD, mapExceptions.getClass().toString(), mapExceptions);</span>
<span class="nc" id="L305">        fieldDeclarations.add(exceptionMapsFieldDeclaration);</span>

<span class="nc" id="L307">    }</span>

    @Override
    public ShellActivityBehavior createShellActivityBehavior(ServiceTask serviceTask) {
<span class="nc" id="L311">        List&lt;FieldDeclaration&gt; fieldDeclarations = createFieldDeclarations(serviceTask.getFieldExtensions());</span>
<span class="nc" id="L312">        return (ShellActivityBehavior) ClassDelegate.defaultInstantiateDelegate(</span>
                ShellActivityBehavior.class, fieldDeclarations);
    }

    @Override
    public ActivityBehavior createHttpActivityBehavior(ServiceTask serviceTask) {
        try {
<span class="nc" id="L319">            Class&lt;?&gt; theClass = null;</span>
<span class="nc" id="L320">            FieldExtension behaviorExtension = null;</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">            for (FieldExtension fieldExtension : serviceTask.getFieldExtensions()) {</span>
<span class="nc bnc" id="L322" title="All 4 branches missed.">                if (&quot;httpActivityBehaviorClass&quot;.equals(fieldExtension.getFieldName()) &amp;&amp; StringUtils.isNotEmpty(fieldExtension.getStringValue())) {</span>
<span class="nc" id="L323">                    theClass = Class.forName(fieldExtension.getStringValue());</span>
<span class="nc" id="L324">                    behaviorExtension = fieldExtension;</span>
<span class="nc" id="L325">                    break;</span>
                }
<span class="nc" id="L327">            }</span>

<span class="nc bnc" id="L329" title="All 2 branches missed.">            if (behaviorExtension != null) {</span>
<span class="nc" id="L330">                serviceTask.getFieldExtensions().remove(behaviorExtension);</span>
            }

<span class="nc bnc" id="L333" title="All 2 branches missed.">            if (theClass == null) {</span>
<span class="nc" id="L334">                return createDefaultActivityBehaviour(serviceTask);</span>
            }

<span class="nc" id="L337">            return classDelegateFactory.create(serviceTask.getId(), theClass.getName(),</span>
<span class="nc" id="L338">                    createFieldDeclarations(serviceTask.getFieldExtensions()),</span>
<span class="nc" id="L339">                    serviceTask.isTriggerable(),</span>
<span class="nc" id="L340">                    getSkipExpressionFromServiceTask(serviceTask), serviceTask.getMapExceptions());</span>

<span class="nc" id="L342">        } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L343">            throw new FlowableException(&quot;Could not find org.flowable.http.HttpActivityBehavior: &quot;, e);</span>
        }
    }

    protected ActivityBehavior createDefaultActivityBehaviour(ServiceTask serviceTask) {
<span class="nc bnc" id="L348" title="All 2 branches missed.">        if (ImplementationType.IMPLEMENTATION_TYPE_CLASS.equals(serviceTask.getImplementationType())) {</span>
<span class="nc" id="L349">            return createClassDelegateServiceTask(serviceTask);</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">        } else if (ImplementationType.IMPLEMENTATION_TYPE_DELEGATEEXPRESSION.equals(serviceTask.getImplementationType())) {</span>
<span class="nc" id="L351">            return createServiceTaskDelegateExpressionActivityBehavior(serviceTask);</span>
        } else {
<span class="nc" id="L353">            return classDelegateFactory.create(serviceTask.getId(), DefaultBpmnHttpActivityDelegate.class.getName(),</span>
<span class="nc" id="L354">                    createFieldDeclarations(serviceTask.getFieldExtensions()),</span>
<span class="nc" id="L355">                    serviceTask.isTriggerable(),</span>
<span class="nc" id="L356">                    getSkipExpressionFromServiceTask(serviceTask), serviceTask.getMapExceptions());</span>
        }
    }

    @Override
    public ActivityBehavior createBusinessRuleTaskActivityBehavior(BusinessRuleTask businessRuleTask) {
<span class="nc" id="L362">        BusinessRuleTaskDelegate ruleActivity = null;</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(businessRuleTask.getClassName())) {</span>
            try {
<span class="nc" id="L365">                Class&lt;?&gt; clazz = Class.forName(businessRuleTask.getClassName());</span>
<span class="nc" id="L366">                ruleActivity = (BusinessRuleTaskDelegate) clazz.getConstructor().newInstance();</span>
<span class="nc" id="L367">            } catch (Exception e) {</span>
<span class="nc" id="L368">                throw new FlowableException(&quot;Could not instantiate businessRuleTask (id:&quot; + businessRuleTask.getId() + &quot;) class: &quot; +</span>
<span class="nc" id="L369">                        businessRuleTask.getClassName(), e);</span>
<span class="nc" id="L370">            }</span>
        } else {
<span class="nc" id="L372">            ruleActivity = new BusinessRuleTaskActivityBehavior();</span>
        }

<span class="nc bnc" id="L375" title="All 2 branches missed.">        for (String ruleVariableInputObject : businessRuleTask.getInputVariables()) {</span>
<span class="nc" id="L376">            ruleActivity.addRuleVariableInputIdExpression(expressionManager.createExpression(ruleVariableInputObject.trim()));</span>
<span class="nc" id="L377">        }</span>

<span class="nc bnc" id="L379" title="All 2 branches missed.">        for (String rule : businessRuleTask.getRuleNames()) {</span>
<span class="nc" id="L380">            ruleActivity.addRuleIdExpression(expressionManager.createExpression(rule.trim()));</span>
<span class="nc" id="L381">        }</span>

<span class="nc" id="L383">        ruleActivity.setExclude(businessRuleTask.isExclude());</span>

<span class="nc bnc" id="L385" title="All 4 branches missed.">        if (businessRuleTask.getResultVariableName() != null &amp;&amp; businessRuleTask.getResultVariableName().length() &gt; 0) {</span>
<span class="nc" id="L386">            ruleActivity.setResultVariable(businessRuleTask.getResultVariableName());</span>
        } else {
<span class="nc" id="L388">            ruleActivity.setResultVariable(&quot;org.flowable.engine.rules.OUTPUT&quot;);</span>
        }

<span class="nc" id="L391">        return ruleActivity;</span>
    }

    // Script task

    @Override
    public ScriptTaskActivityBehavior createScriptTaskActivityBehavior(ScriptTask scriptTask) {
<span class="nc" id="L398">        String language = scriptTask.getScriptFormat();</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">        if (language == null) {</span>
<span class="nc" id="L400">            language = ScriptingEngines.DEFAULT_SCRIPTING_LANGUAGE;</span>
        }
<span class="nc" id="L402">        return new ScriptTaskActivityBehavior(scriptTask.getId(), scriptTask.getScript(), language, scriptTask.getResultVariable(), scriptTask.getSkipExpression(), scriptTask.isAutoStoreVariables());</span>
    }
    
    @Override
    public SendEventTaskActivityBehavior createSendEventTaskBehavior(SendEventServiceTask sendEventServiceTask) {
<span class="nc" id="L407">        return new SendEventTaskActivityBehavior(sendEventServiceTask);</span>
    }

    @Override
    public ExternalWorkerTaskActivityBehavior createExternalWorkerTaskBehavior(ExternalWorkerServiceTask externalWorkerServiceTask) {
<span class="nc" id="L412">        Expression topicExpression = createExpression(externalWorkerServiceTask.getTopic());</span>
<span class="nc" id="L413">        Expression skipExpression = getSkipExpressionFromServiceTask(externalWorkerServiceTask);</span>
<span class="nc" id="L414">        return new ExternalWorkerTaskActivityBehavior(externalWorkerServiceTask, topicExpression, skipExpression);</span>
    }

    // Gateways

    @Override
    public ExclusiveGatewayActivityBehavior createExclusiveGatewayActivityBehavior(ExclusiveGateway exclusiveGateway) {
<span class="nc" id="L421">        return new ExclusiveGatewayActivityBehavior();</span>
    }

    @Override
    public ParallelGatewayActivityBehavior createParallelGatewayActivityBehavior(ParallelGateway parallelGateway) {
<span class="nc" id="L426">        return new ParallelGatewayActivityBehavior();</span>
    }

    @Override
    public InclusiveGatewayActivityBehavior createInclusiveGatewayActivityBehavior(InclusiveGateway inclusiveGateway) {
<span class="nc" id="L431">        return new InclusiveGatewayActivityBehavior();</span>
    }

    @Override
    public EventBasedGatewayActivityBehavior createEventBasedGatewayActivityBehavior(EventGateway eventGateway) {
<span class="nc" id="L436">        return new EventBasedGatewayActivityBehavior();</span>
    }

    // Multi Instance

    @Override
    public SequentialMultiInstanceBehavior createSequentialMultiInstanceBehavior(Activity activity, AbstractBpmnActivityBehavior innerActivityBehavior) {
<span class="nc" id="L443">        return new SequentialMultiInstanceBehavior(activity, innerActivityBehavior);</span>
    }

    @Override
    public ParallelMultiInstanceBehavior createParallelMultiInstanceBehavior(Activity activity, AbstractBpmnActivityBehavior innerActivityBehavior) {
<span class="nc" id="L448">        return new ParallelMultiInstanceBehavior(activity, innerActivityBehavior);</span>
    }

    // Subprocess

    @Override
    public SubProcessActivityBehavior createSubprocessActivityBehavior(SubProcess subProcess) {
<span class="nc" id="L455">        return new SubProcessActivityBehavior();</span>
    }

    @Override
    public EventSubProcessActivityBehavior createEventSubprocessActivityBehavior(EventSubProcess eventSubProcess) {
<span class="nc" id="L460">        return new EventSubProcessActivityBehavior();</span>
    }
    
    @Override
    public EventSubProcessConditionalStartEventActivityBehavior createEventSubProcessConditionalStartEventActivityBehavior(StartEvent startEvent,
                    ConditionalEventDefinition conditionalEventDefinition, String conditionExpression) {
        
<span class="nc" id="L467">        return new EventSubProcessConditionalStartEventActivityBehavior(conditionalEventDefinition, conditionExpression);</span>
    }

    @Override
    public EventSubProcessErrorStartEventActivityBehavior createEventSubProcessErrorStartEventActivityBehavior(StartEvent startEvent) {
<span class="nc" id="L472">        return new EventSubProcessErrorStartEventActivityBehavior();</span>
    }
    
    @Override
    public EventSubProcessEscalationStartEventActivityBehavior createEventSubProcessEscalationStartEventActivityBehavior(StartEvent startEvent) {
<span class="nc" id="L477">        return new EventSubProcessEscalationStartEventActivityBehavior();</span>
    }

    @Override
    public EventSubProcessMessageStartEventActivityBehavior createEventSubProcessMessageStartEventActivityBehavior(StartEvent startEvent, MessageEventDefinition messageEventDefinition) {
<span class="nc" id="L482">        return new EventSubProcessMessageStartEventActivityBehavior(messageEventDefinition);</span>
    }

    @Override
    public EventSubProcessSignalStartEventActivityBehavior createEventSubProcessSignalStartEventActivityBehavior(StartEvent startEvent, SignalEventDefinition signalEventDefinition, Signal signal) {
<span class="nc" id="L487">        return new EventSubProcessSignalStartEventActivityBehavior(signalEventDefinition, signal);</span>
    }

    @Override
    public EventSubProcessTimerStartEventActivityBehavior createEventSubProcessTimerStartEventActivityBehavior(StartEvent startEvent, TimerEventDefinition timerEventDefinition) {
<span class="nc" id="L492">        return new EventSubProcessTimerStartEventActivityBehavior(timerEventDefinition);</span>
    }

    @Override
    public EventSubProcessEventRegistryStartEventActivityBehavior createEventSubProcessEventRegistryStartEventActivityBehavior(StartEvent startEvent, String eventDefinitionKey) {
<span class="nc" id="L497">        return new EventSubProcessEventRegistryStartEventActivityBehavior(eventDefinitionKey);</span>
    }
    
    @Override
    public EventSubProcessVariableListenerlStartEventActivityBehavior createEventSubProcessVariableListenerlStartEventActivityBehavior(StartEvent startEvent, VariableListenerEventDefinition variableListenerEventDefinition) {
<span class="nc" id="L502">        return new EventSubProcessVariableListenerlStartEventActivityBehavior(variableListenerEventDefinition);</span>
    }

    @Override
    public AdhocSubProcessActivityBehavior createAdhocSubprocessActivityBehavior(SubProcess subProcess) {
<span class="nc" id="L507">        return new AdhocSubProcessActivityBehavior();</span>
    }

    // Call activity

    @Override
    public CallActivityBehavior createCallActivityBehavior(CallActivity callActivity) {
<span class="nc" id="L514">        return new CallActivityBehavior(callActivity);</span>
    }
    
    @Override
    public CaseTaskActivityBehavior createCaseTaskBehavior(CaseServiceTask caseServiceTask) {
<span class="nc" id="L519">        return new CaseTaskActivityBehavior();</span>
    }

    // Transaction

    @Override
    public TransactionActivityBehavior createTransactionActivityBehavior(Transaction transaction) {
<span class="nc" id="L526">        return new TransactionActivityBehavior();</span>
    }

    // Intermediate Events

    @Override
    public IntermediateCatchEventActivityBehavior createIntermediateCatchEventActivityBehavior(IntermediateCatchEvent intermediateCatchEvent) {
<span class="nc" id="L533">        return new IntermediateCatchEventActivityBehavior();</span>
    }
    
    @Override
    public IntermediateCatchConditionalEventActivityBehavior createIntermediateCatchConditionalEventActivityBehavior(IntermediateCatchEvent intermediateCatchEvent, 
                    ConditionalEventDefinition conditionalEventDefinition, String conditionExpression) {
        
<span class="nc" id="L540">        return new IntermediateCatchConditionalEventActivityBehavior(conditionalEventDefinition, conditionExpression);</span>
    }

    @Override
    public IntermediateCatchMessageEventActivityBehavior createIntermediateCatchMessageEventActivityBehavior(IntermediateCatchEvent intermediateCatchEvent, MessageEventDefinition messageEventDefinition) {
<span class="nc" id="L545">        return new IntermediateCatchMessageEventActivityBehavior(messageEventDefinition);</span>
    }

    @Override
    public IntermediateCatchTimerEventActivityBehavior createIntermediateCatchTimerEventActivityBehavior(IntermediateCatchEvent intermediateCatchEvent, TimerEventDefinition timerEventDefinition) {
<span class="nc" id="L550">        return new IntermediateCatchTimerEventActivityBehavior(timerEventDefinition);</span>
    }

    @Override
    public IntermediateCatchEventRegistryEventActivityBehavior createIntermediateCatchEventRegistryEventActivityBehavior(IntermediateCatchEvent intermediateCatchEvent, String eventDefinitionKey) {
<span class="nc" id="L555">        return new IntermediateCatchEventRegistryEventActivityBehavior(eventDefinitionKey);</span>
    }

    @Override
    public IntermediateCatchSignalEventActivityBehavior createIntermediateCatchSignalEventActivityBehavior(IntermediateCatchEvent intermediateCatchEvent, 
                    SignalEventDefinition signalEventDefinition, Signal signal) {

<span class="nc" id="L562">        return new IntermediateCatchSignalEventActivityBehavior(signalEventDefinition, signal);</span>
    }
    
    @Override
    public IntermediateCatchVariableListenerEventActivityBehavior createIntermediateCatchVariableListenerEventActivityBehavior(IntermediateCatchEvent intermediateCatchEvent, 
            VariableListenerEventDefinition variableListenerEventDefinition) {
        
<span class="nc" id="L569">        return new IntermediateCatchVariableListenerEventActivityBehavior(variableListenerEventDefinition);</span>
    }
    
    @Override
    public IntermediateThrowNoneEventActivityBehavior createIntermediateThrowNoneEventActivityBehavior(ThrowEvent throwEvent) {
<span class="nc" id="L574">        return new IntermediateThrowNoneEventActivityBehavior();</span>
    }

    @Override
    public IntermediateThrowSignalEventActivityBehavior createIntermediateThrowSignalEventActivityBehavior(ThrowEvent throwEvent, 
                    SignalEventDefinition signalEventDefinition, Signal signal) {
        
<span class="nc" id="L581">        return new IntermediateThrowSignalEventActivityBehavior(throwEvent, signalEventDefinition, signal);</span>
    }
    
    @Override
    public IntermediateThrowEscalationEventActivityBehavior createIntermediateThrowEscalationEventActivityBehavior(ThrowEvent throwEvent, 
                    EscalationEventDefinition escalationEventDefinition, Escalation escalation) {
        
<span class="nc" id="L588">        return new IntermediateThrowEscalationEventActivityBehavior(throwEvent, escalationEventDefinition, escalation);</span>
    }

    @Override
    public IntermediateThrowCompensationEventActivityBehavior createIntermediateThrowCompensationEventActivityBehavior(ThrowEvent throwEvent, CompensateEventDefinition compensateEventDefinition) {
<span class="nc" id="L593">        return new IntermediateThrowCompensationEventActivityBehavior(compensateEventDefinition);</span>
    }

    // End events

    @Override
    public NoneEndEventActivityBehavior createNoneEndEventActivityBehavior(EndEvent endEvent) {
<span class="nc" id="L600">        return new NoneEndEventActivityBehavior();</span>
    }

    @Override
    public ErrorEndEventActivityBehavior createErrorEndEventActivityBehavior(EndEvent endEvent, ErrorEventDefinition errorEventDefinition) {
<span class="nc" id="L605">        return new ErrorEndEventActivityBehavior(errorEventDefinition.getErrorCode(), endEvent.getOutParameters());</span>
    }
    
    @Override
    public EscalationEndEventActivityBehavior createEscalationEndEventActivityBehavior(EndEvent endEvent, EscalationEventDefinition escalationEventDefinition, Escalation escalation) {
<span class="nc" id="L610">        return new EscalationEndEventActivityBehavior(escalationEventDefinition, escalation);</span>
    }

    @Override
    public CancelEndEventActivityBehavior createCancelEndEventActivityBehavior(EndEvent endEvent) {
<span class="nc" id="L615">        return new CancelEndEventActivityBehavior();</span>
    }

    @Override
    public TerminateEndEventActivityBehavior createTerminateEndEventActivityBehavior(EndEvent endEvent) {
<span class="nc" id="L620">        boolean terminateAll = false;</span>
<span class="nc" id="L621">        boolean terminateMultiInstance = false;</span>

<span class="nc bnc" id="L623" title="All 2 branches missed.">        if (endEvent.getEventDefinitions() != null</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">                &amp;&amp; endEvent.getEventDefinitions().size() &gt; 0</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">                &amp;&amp; endEvent.getEventDefinitions().get(0) instanceof TerminateEventDefinition) {</span>
<span class="nc" id="L626">            terminateAll = ((TerminateEventDefinition) endEvent.getEventDefinitions().get(0)).isTerminateAll();</span>
<span class="nc" id="L627">            terminateMultiInstance = ((TerminateEventDefinition) endEvent.getEventDefinitions().get(0)).isTerminateMultiInstance();</span>
        }

<span class="nc" id="L630">        TerminateEndEventActivityBehavior terminateEndEventActivityBehavior = new TerminateEndEventActivityBehavior();</span>
<span class="nc" id="L631">        terminateEndEventActivityBehavior.setTerminateAll(terminateAll);</span>
<span class="nc" id="L632">        terminateEndEventActivityBehavior.setTerminateMultiInstance(terminateMultiInstance);</span>
<span class="nc" id="L633">        return terminateEndEventActivityBehavior;</span>
    }

    // Boundary Events

    @Override
    public BoundaryEventActivityBehavior createBoundaryEventActivityBehavior(BoundaryEvent boundaryEvent, boolean interrupting) {
<span class="nc" id="L640">        return new BoundaryEventActivityBehavior(interrupting);</span>
    }

    @Override
    public BoundaryCancelEventActivityBehavior createBoundaryCancelEventActivityBehavior(CancelEventDefinition cancelEventDefinition) {
<span class="nc" id="L645">        return new BoundaryCancelEventActivityBehavior();</span>
    }

    @Override
    public BoundaryCompensateEventActivityBehavior createBoundaryCompensateEventActivityBehavior(BoundaryEvent boundaryEvent,
            CompensateEventDefinition compensateEventDefinition, boolean interrupting) {

<span class="nc" id="L652">        return new BoundaryCompensateEventActivityBehavior(compensateEventDefinition, interrupting);</span>
    }
    
    @Override
    public BoundaryConditionalEventActivityBehavior createBoundaryConditionalEventActivityBehavior(BoundaryEvent boundaryEvent,
            ConditionalEventDefinition conditionalEventDefinition, String conditionExpression, boolean interrupting) {

<span class="nc" id="L659">        return new BoundaryConditionalEventActivityBehavior(conditionalEventDefinition, conditionExpression, interrupting);</span>
    }

    @Override
    public BoundaryTimerEventActivityBehavior createBoundaryTimerEventActivityBehavior(BoundaryEvent boundaryEvent, TimerEventDefinition timerEventDefinition, boolean interrupting) {
<span class="nc" id="L664">        return new BoundaryTimerEventActivityBehavior(timerEventDefinition, interrupting);</span>
    }

    @Override
    public BoundarySignalEventActivityBehavior createBoundarySignalEventActivityBehavior(BoundaryEvent boundaryEvent, SignalEventDefinition signalEventDefinition, Signal signal, boolean interrupting) {
<span class="nc" id="L669">        return new BoundarySignalEventActivityBehavior(signalEventDefinition, signal, interrupting);</span>
    }

    @Override
    public BoundaryMessageEventActivityBehavior createBoundaryMessageEventActivityBehavior(BoundaryEvent boundaryEvent, MessageEventDefinition messageEventDefinition, boolean interrupting) {
<span class="nc" id="L674">        return new BoundaryMessageEventActivityBehavior(messageEventDefinition, interrupting);</span>
    }
    
    @Override
    public BoundaryEscalationEventActivityBehavior createBoundaryEscalationEventActivityBehavior(BoundaryEvent boundaryEvent, EscalationEventDefinition escalationEventDefinition, Escalation escalation, boolean interrupting) {
<span class="nc" id="L679">        return new BoundaryEscalationEventActivityBehavior(escalationEventDefinition, escalation, interrupting);</span>
    }
    
    @Override
    public BoundaryEventRegistryEventActivityBehavior createBoundaryEventRegistryEventActivityBehavior(BoundaryEvent boundaryEvent, String eventDefinitionKey, boolean interrupting) {
<span class="nc" id="L684">        return new BoundaryEventRegistryEventActivityBehavior(eventDefinitionKey, interrupting);</span>
    }

    @Override
    public BoundaryVariableListenerEventActivityBehavior createBoundaryVariableListenerEventActivityBehavior(BoundaryEvent boundaryEvent, VariableListenerEventDefinition variableListenerEventDefinition, boolean interrupting) {
<span class="nc" id="L689">        return new BoundaryVariableListenerEventActivityBehavior(variableListenerEventDefinition, interrupting);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>