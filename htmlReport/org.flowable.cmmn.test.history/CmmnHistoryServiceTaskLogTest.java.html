<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CmmnHistoryServiceTaskLogTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.cmmn.test.history</a> &gt; <span class="el_source">CmmnHistoryServiceTaskLogTest.java</span></div><h1>CmmnHistoryServiceTaskLogTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.cmmn.test.history;

import static net.javacrumbs.jsonunit.assertj.JsonAssertions.assertThatJson;
import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.tuple;

import java.util.Calendar;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.List;
import java.util.function.Consumer;

import org.flowable.cmmn.api.runtime.CaseInstance;
import org.flowable.cmmn.engine.CmmnEngineConfiguration;
import org.flowable.cmmn.engine.test.impl.CmmnHistoryTestHelper;
import org.flowable.cmmn.engine.test.impl.CmmnTestHelper;
import org.flowable.cmmn.test.impl.CustomCmmnConfigurationFlowableTestCase;
import org.flowable.common.engine.api.scope.ScopeTypes;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.common.engine.impl.identity.Authentication;
import org.flowable.identitylink.api.IdentityLinkType;
import org.flowable.task.api.Task;
import org.flowable.task.api.history.HistoricTaskLogEntry;
import org.flowable.task.api.history.HistoricTaskLogEntryBuilder;
import org.flowable.task.api.history.HistoricTaskLogEntryQuery;
import org.junit.After;
import org.junit.Test;

/**
 * @author martin.grofcik
 */
<span class="nc" id="L44">public class CmmnHistoryServiceTaskLogTest extends CustomCmmnConfigurationFlowableTestCase {</span>

    protected Task task;

    @Override
    protected String getEngineName() {
<span class="nc" id="L50">        return &quot;cmmnEngineWithUserTaskEventLogging&quot;;</span>
    }

    @Override
    protected void configureConfiguration(CmmnEngineConfiguration cmmnEngineConfiguration) {
<span class="nc" id="L55">        cmmnEngineConfiguration.setEnableHistoricTaskLogging(true);</span>
<span class="nc" id="L56">    }</span>

    @After
    public void deleteTasks() {
<span class="nc bnc" id="L60" title="All 2 branches missed.">        if (task != null) {</span>
<span class="nc" id="L61">            deleteTaskWithLogEntries(task.getId());</span>
        }
<span class="nc" id="L63">    }</span>

    protected void deleteTaskWithLogEntries(String taskId) {
<span class="nc" id="L66">        cmmnTaskService.deleteTask(taskId, true);</span>
<span class="nc" id="L67">    }</span>

    @Test
    public void createTaskEvent() {
<span class="nc" id="L71">        task = cmmnTaskService.createTaskBuilder()</span>
<span class="nc" id="L72">                .assignee(&quot;testAssignee&quot;)</span>
<span class="nc" id="L73">                .create();</span>

<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L76">            List&lt;HistoricTaskLogEntry&gt; taskLogsByTaskInstanceId = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L77">            assertThat(taskLogsByTaskInstanceId)</span>
<span class="nc" id="L78">                .extracting(HistoricTaskLogEntry::getTaskId, HistoricTaskLogEntry::getType)</span>
<span class="nc" id="L79">                .containsExactly(tuple(task.getId(), &quot;USER_TASK_CREATED&quot;));</span>
<span class="nc" id="L80">            assertThat(taskLogsByTaskInstanceId)</span>
<span class="nc" id="L81">                .extracting(HistoricTaskLogEntry::getTimeStamp)</span>
<span class="nc" id="L82">                .isNotNull();</span>
<span class="nc" id="L83">            assertThat(taskLogsByTaskInstanceId)</span>
<span class="nc" id="L84">                .extracting(HistoricTaskLogEntry::getUserId)</span>
<span class="nc" id="L85">                .containsOnlyNulls();</span>
        }
<span class="nc" id="L87">    }</span>

    @Test
    public void createTaskEventAsAuthenticatedUser() {
<span class="nc" id="L91">        String previousUserId = Authentication.getAuthenticatedUserId();</span>
<span class="nc" id="L92">        Authentication.setAuthenticatedUserId(&quot;testUser&quot;);</span>
        try {
<span class="nc" id="L94">            task = cmmnTaskService.createTaskBuilder()</span>
<span class="nc" id="L95">                    .assignee(&quot;testAssignee&quot;)</span>
<span class="nc" id="L96">                    .create();</span>

<span class="nc bnc" id="L98" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L99">                List&lt;HistoricTaskLogEntry&gt; taskLogsByTaskInstanceId = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L100">                assertThat(taskLogsByTaskInstanceId)</span>
<span class="nc" id="L101">                    .extracting(HistoricTaskLogEntry::getUserId)</span>
<span class="nc" id="L102">                    .containsExactly(&quot;testUser&quot;);</span>
            }
        } finally {
<span class="nc" id="L105">            Authentication.setAuthenticatedUserId(previousUserId);</span>
        }
<span class="nc" id="L107">    }</span>

    @Test
    public void queryForNonExistingTaskLogEntries() {
<span class="nc" id="L111">        task = cmmnTaskService.createTaskBuilder().create();</span>

<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L114">            List&lt;HistoricTaskLogEntry&gt; taskLogsByTaskInstanceId = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(&quot;NON-EXISTING-TASK-ID&quot;).list();</span>
<span class="nc" id="L115">            assertThat(taskLogsByTaskInstanceId).isEmpty();</span>
        }
<span class="nc" id="L117">    }</span>

    @Test
    public void queryForNullTaskLogEntries_returnsAll() {
<span class="nc" id="L121">        Task taskA = cmmnTaskService.createTaskBuilder().create();</span>
<span class="nc" id="L122">        Task taskB = cmmnTaskService.createTaskBuilder().create();</span>
<span class="nc" id="L123">        Task taskC = cmmnTaskService.createTaskBuilder().create();</span>

        try {
<span class="nc bnc" id="L126" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L127">                List&lt;HistoricTaskLogEntry&gt; taskLogsByTaskInstanceId = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(null).list();</span>
<span class="nc" id="L128">                assertThat(taskLogsByTaskInstanceId).hasSize(3);</span>
            }

        } finally {
<span class="nc" id="L132">            deleteTaskWithLogEntries(taskC.getId());</span>
<span class="nc" id="L133">            deleteTaskWithLogEntries(taskB.getId());</span>
<span class="nc" id="L134">            deleteTaskWithLogEntries(taskA.getId());</span>
        }
<span class="nc" id="L136">    }</span>

    @Test
    public void deleteTaskEventLogEntry() {
<span class="nc" id="L140">        task = cmmnTaskService.createTaskBuilder()</span>
<span class="nc" id="L141">                .assignee(&quot;testAssignee&quot;)</span>
<span class="nc" id="L142">                .create();</span>

<span class="nc" id="L144">        List&lt;HistoricTaskLogEntry&gt; taskLogsByTaskInstanceId = null;</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L146">            taskLogsByTaskInstanceId = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L147">            assertThat(taskLogsByTaskInstanceId).hasSize(1);</span>
        }

<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (taskLogsByTaskInstanceId != null) {</span>
<span class="nc" id="L151">            cmmnHistoryService.deleteHistoricTaskLogEntry(taskLogsByTaskInstanceId.get(0).getLogNumber());</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>

<span class="nc" id="L154">                taskLogsByTaskInstanceId = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L155">                assertThat(taskLogsByTaskInstanceId).isEmpty();</span>
            }
        }
<span class="nc" id="L158">    }</span>

    @Test
    public void deleteNonExistingTaskEventLogEntry() {
<span class="nc" id="L162">        task = cmmnTaskService.createTaskBuilder().create();</span>

        // non existing log entry delete should be successful
<span class="nc" id="L165">        cmmnHistoryService.deleteHistoricTaskLogEntry(9999);</span>

<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L168">            assertThat(cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list()).hasSize(1);</span>
        }
<span class="nc" id="L170">    }</span>

    @Test
    public void taskAssigneeEvent() {
<span class="nc" id="L174">        task = cmmnTaskService.createTaskBuilder()</span>
<span class="nc" id="L175">                .assignee(&quot;initialAssignee&quot;)</span>
<span class="nc" id="L176">                .create();</span>

<span class="nc" id="L178">        cmmnTaskService.setAssignee(task.getId(), &quot;newAssignee&quot;);</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L180">            List&lt;HistoricTaskLogEntry&gt; taskLogEntries = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>

<span class="nc" id="L182">            assertThat(taskLogEntries).hasSize(2);</span>
<span class="nc" id="L183">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L184">                .extracting(HistoricTaskLogEntry::getData)</span>
<span class="nc" id="L185">                .isEqualTo(&quot;{\&quot;newAssigneeId\&quot;:\&quot;newAssignee\&quot;,\&quot;previousAssigneeId\&quot;:\&quot;initialAssignee\&quot;}&quot;);</span>
<span class="nc" id="L186">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L187">                .extracting(HistoricTaskLogEntry::getTimeStamp)</span>
<span class="nc" id="L188">                .isNotNull();</span>
<span class="nc" id="L189">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L190">                .extracting(HistoricTaskLogEntry::getTaskId)</span>
<span class="nc" id="L191">                .isEqualTo(task.getId());</span>
<span class="nc" id="L192">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L193">                .extracting(HistoricTaskLogEntry::getUserId)</span>
<span class="nc" id="L194">                .isNull();</span>
<span class="nc" id="L195">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L196">                .extracting(HistoricTaskLogEntry::getType)</span>
<span class="nc" id="L197">                .isEqualTo(&quot;USER_TASK_ASSIGNEE_CHANGED&quot;);</span>
        }
<span class="nc" id="L199">    }</span>

    @Test
    public void changeAssigneeTaskEventAsAuthenticatedUser() {
<span class="nc" id="L203">        assertThatAuthenticatedUserIsSet(</span>
<span class="nc" id="L204">                taskId -&gt; cmmnTaskService.setAssignee(taskId, &quot;newAssignee&quot;)</span>
        );
<span class="nc" id="L206">    }</span>

    @Test
    public void taskOwnerEvent() {
<span class="nc" id="L210">        task = cmmnTaskService.createTaskBuilder()</span>
<span class="nc" id="L211">                .assignee(&quot;initialAssignee&quot;)</span>
<span class="nc" id="L212">                .create();</span>

<span class="nc" id="L214">        cmmnTaskService.setOwner(task.getId(), &quot;newOwner&quot;);</span>

<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L217">            List&lt;HistoricTaskLogEntry&gt; taskLogEntries = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>

<span class="nc" id="L219">            assertThat(taskLogEntries).hasSize(2);</span>
<span class="nc" id="L220">            assertThatJson(taskLogEntries.get(1).getData())</span>
<span class="nc" id="L221">                .isEqualTo(&quot;{ previousOwnerId: null, newOwnerId: 'newOwner' }&quot;);</span>
<span class="nc" id="L222">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L223">                .extracting(HistoricTaskLogEntry::getTimeStamp)</span>
<span class="nc" id="L224">                .isNotNull();</span>
<span class="nc" id="L225">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L226">                .extracting(HistoricTaskLogEntry::getTaskId)</span>
<span class="nc" id="L227">                .isEqualTo(task.getId());</span>
<span class="nc" id="L228">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L229">                .extracting(HistoricTaskLogEntry::getUserId)</span>
<span class="nc" id="L230">                .isNull();</span>
<span class="nc" id="L231">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L232">                .extracting(HistoricTaskLogEntry::getType)</span>
<span class="nc" id="L233">                .isEqualTo(&quot;USER_TASK_OWNER_CHANGED&quot;);</span>
        }
<span class="nc" id="L235">    }</span>

    @Test
    public void changeOwnerTaskEventAsAuthenticatedUser() {
<span class="nc" id="L239">        assertThatAuthenticatedUserIsSet(</span>
<span class="nc" id="L240">                taskId -&gt; cmmnTaskService.setOwner(taskId, &quot;newOwner&quot;)</span>
        );
<span class="nc" id="L242">    }</span>

    @Test
    public void claimTaskEvent() {
<span class="nc" id="L246">        task = cmmnTaskService.createTaskBuilder().create();</span>

<span class="nc" id="L248">        cmmnTaskService.claim(task.getId(), &quot;testUser&quot;);</span>

<span class="nc bnc" id="L250" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L251">            List&lt;HistoricTaskLogEntry&gt; taskLogEntries = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L252">            assertThat(taskLogEntries).hasSize(2);</span>
<span class="nc" id="L253">            assertThatJson(taskLogEntries.get(1).getData())</span>
<span class="nc" id="L254">                .isEqualTo(&quot;{ newAssigneeId: 'testUser', previousAssigneeId: null }&quot;);</span>
<span class="nc" id="L255">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L256">                .extracting(HistoricTaskLogEntry::getTimeStamp)</span>
<span class="nc" id="L257">                .isNotNull();</span>
<span class="nc" id="L258">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L259">                .extracting(HistoricTaskLogEntry::getTaskId)</span>
<span class="nc" id="L260">                .isEqualTo(task.getId());</span>
<span class="nc" id="L261">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L262">                .extracting(HistoricTaskLogEntry::getUserId)</span>
<span class="nc" id="L263">                .isNull();</span>
<span class="nc" id="L264">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L265">                .extracting(HistoricTaskLogEntry::getType)</span>
<span class="nc" id="L266">                .isEqualTo(&quot;USER_TASK_ASSIGNEE_CHANGED&quot;);</span>
        }
<span class="nc" id="L268">    }</span>

    @Test
    public void unClaimTaskEvent() {
<span class="nc" id="L272">        task = cmmnTaskService.createTaskBuilder()</span>
<span class="nc" id="L273">                .assignee(&quot;initialAssignee&quot;)</span>
<span class="nc" id="L274">                .create();</span>

<span class="nc" id="L276">        cmmnTaskService.unclaim(task.getId());</span>

<span class="nc bnc" id="L278" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L279">            List&lt;HistoricTaskLogEntry&gt; taskLogEntries = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L280">            assertThat(taskLogEntries).hasSize(2);</span>
<span class="nc" id="L281">            assertThatJson(taskLogEntries.get(1).getData())</span>
<span class="nc" id="L282">                .isEqualTo(&quot;{ newAssigneeId: null, previousAssigneeId: 'initialAssignee' }&quot;);</span>
<span class="nc" id="L283">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L284">                .extracting(HistoricTaskLogEntry::getTimeStamp)</span>
<span class="nc" id="L285">                .isNotNull();</span>
<span class="nc" id="L286">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L287">                .extracting(HistoricTaskLogEntry::getTaskId)</span>
<span class="nc" id="L288">                .isEqualTo(task.getId());</span>
<span class="nc" id="L289">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L290">                .extracting(HistoricTaskLogEntry::getUserId)</span>
<span class="nc" id="L291">                .isNull();</span>
<span class="nc" id="L292">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L293">                .extracting(HistoricTaskLogEntry::getType)</span>
<span class="nc" id="L294">                .isEqualTo(&quot;USER_TASK_ASSIGNEE_CHANGED&quot;);</span>
        }
<span class="nc" id="L296">    }</span>

    @Test
    public void changePriority() {
<span class="nc" id="L300">        task = cmmnTaskService.createTaskBuilder().create();</span>

<span class="nc" id="L302">        cmmnTaskService.setPriority(task.getId(), Integer.MAX_VALUE);</span>

<span class="nc bnc" id="L304" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L305">            List&lt;HistoricTaskLogEntry&gt; taskLogEntries = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>

<span class="nc" id="L307">            assertThat(taskLogEntries).hasSize(2);</span>
<span class="nc" id="L308">            assertThatJson(taskLogEntries.get(1).getData())</span>
<span class="nc" id="L309">                .isEqualTo(&quot;{ newPriority: 2147483647, previousPriority: 50 }&quot;);</span>
<span class="nc" id="L310">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L311">                .extracting(HistoricTaskLogEntry::getTimeStamp)</span>
<span class="nc" id="L312">                .isNotNull();</span>
<span class="nc" id="L313">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L314">                .extracting(HistoricTaskLogEntry::getTaskId)</span>
<span class="nc" id="L315">                .isEqualTo(task.getId());</span>
<span class="nc" id="L316">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L317">                .extracting(HistoricTaskLogEntry::getUserId)</span>
<span class="nc" id="L318">                .isNull();</span>
<span class="nc" id="L319">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L320">                .extracting(HistoricTaskLogEntry::getType)</span>
<span class="nc" id="L321">                .isEqualTo(&quot;USER_TASK_PRIORITY_CHANGED&quot;);</span>
        }
<span class="nc" id="L323">    }</span>

    @Test
    public void changePriorityEventAsAuthenticatedUser() {
<span class="nc" id="L327">        assertThatAuthenticatedUserIsSet(</span>
<span class="nc" id="L328">                taskId -&gt; cmmnTaskService.setPriority(taskId, Integer.MAX_VALUE)</span>
        );
<span class="nc" id="L330">    }</span>

    protected void assertThatAuthenticatedUserIsSet(Consumer&lt;String&gt; functionToAssert) {
<span class="nc" id="L333">        String previousUserId = Authentication.getAuthenticatedUserId();</span>
<span class="nc" id="L334">        task = cmmnTaskService.createTaskBuilder()</span>
<span class="nc" id="L335">                .assignee(&quot;testAssignee&quot;)</span>
<span class="nc" id="L336">                .create();</span>
<span class="nc" id="L337">        Authentication.setAuthenticatedUserId(&quot;testUser&quot;);</span>
        try {
<span class="nc" id="L339">            functionToAssert.accept(task.getId());</span>

<span class="nc bnc" id="L341" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L342">                List&lt;HistoricTaskLogEntry&gt; taskLogsByTaskInstanceId = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L343">                assertThat(taskLogsByTaskInstanceId).hasSize(2);</span>
<span class="nc" id="L344">                assertThat(taskLogsByTaskInstanceId.get(1))</span>
<span class="nc" id="L345">                    .extracting(HistoricTaskLogEntry::getUserId)</span>
<span class="nc" id="L346">                    .isEqualTo(&quot;testUser&quot;);</span>
            }
        } finally {
<span class="nc" id="L349">            Authentication.setAuthenticatedUserId(previousUserId);</span>
        }
<span class="nc" id="L351">    }</span>

    @Test
    public void changeDueDate() {
<span class="nc" id="L355">        task = cmmnTaskService.createTaskBuilder().create();</span>

<span class="nc" id="L357">        Date dueDate = new Date();</span>
<span class="nc" id="L358">        cmmnTaskService.setDueDate(task.getId(), dueDate);</span>

<span class="nc bnc" id="L360" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L361">            List&lt;HistoricTaskLogEntry&gt; taskLogEntries = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>

<span class="nc" id="L363">            assertThat(taskLogEntries).hasSize(2);</span>
<span class="nc" id="L364">            assertThatJson(taskLogEntries.get(1).getData())</span>
<span class="nc" id="L365">                .isEqualTo(&quot;{ newDueDate: &quot; + dueDate.getTime() + &quot;, previousDueDate: null }&quot;);</span>
<span class="nc" id="L366">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L367">                .extracting(HistoricTaskLogEntry::getTimeStamp)</span>
<span class="nc" id="L368">                .isNotNull();</span>
<span class="nc" id="L369">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L370">                .extracting(HistoricTaskLogEntry::getTaskId)</span>
<span class="nc" id="L371">                .isEqualTo(task.getId());</span>
<span class="nc" id="L372">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L373">                .extracting(HistoricTaskLogEntry::getUserId)</span>
<span class="nc" id="L374">                .isNull();</span>
<span class="nc" id="L375">            assertThat(taskLogEntries.get(1))</span>
<span class="nc" id="L376">                .extracting(HistoricTaskLogEntry::getType)</span>
<span class="nc" id="L377">                .isEqualTo(&quot;USER_TASK_DUEDATE_CHANGED&quot;);</span>
        }
<span class="nc" id="L379">    }</span>

    @Test
    public void saveTask() {
<span class="nc" id="L383">        task = cmmnTaskService.createTaskBuilder().create();</span>

<span class="nc" id="L385">        task.setAssignee(&quot;newAssignee&quot;);</span>
<span class="nc" id="L386">        task.setOwner(&quot;newOwner&quot;);</span>
<span class="nc" id="L387">        task.setPriority(Integer.MAX_VALUE);</span>
<span class="nc" id="L388">        task.setDueDate(new Date());</span>
<span class="nc" id="L389">        cmmnTaskService.saveTask(task);</span>

<span class="nc bnc" id="L391" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L392">            List&lt;HistoricTaskLogEntry&gt; taskLogEntries = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L393">            assertThat(taskLogEntries).as(&quot;Only User task created log entry is expected&quot;).hasSize(1);</span>
        }
<span class="nc" id="L395">    }</span>

    @Test
    public void changeDueDateEventAsAuthenticatedUser() {
<span class="nc" id="L399">        assertThatAuthenticatedUserIsSet(</span>
<span class="nc" id="L400">                taskId -&gt; cmmnTaskService.setDueDate(taskId, new Date())</span>
        );
<span class="nc" id="L402">    }</span>

    @Test
    public void createCustomTaskEventLog() {
<span class="nc" id="L406">        task = cmmnTaskService.createTaskBuilder().create();</span>

<span class="nc" id="L408">        HistoricTaskLogEntryBuilder historicTaskLogEntryBuilder = cmmnHistoryService.createHistoricTaskLogEntryBuilder(task);</span>
<span class="nc" id="L409">        historicTaskLogEntryBuilder.timeStamp(getInsertDate());</span>
<span class="nc" id="L410">        historicTaskLogEntryBuilder.userId(&quot;testUser&quot;);</span>
<span class="nc" id="L411">        historicTaskLogEntryBuilder.type(&quot;customType&quot;);</span>
<span class="nc" id="L412">        historicTaskLogEntryBuilder.data(&quot;testData&quot;);</span>
<span class="nc" id="L413">        historicTaskLogEntryBuilder.create();</span>

<span class="nc bnc" id="L415" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>

<span class="nc" id="L417">            List&lt;HistoricTaskLogEntry&gt; logEntries = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>

<span class="nc" id="L419">            assertThat(logEntries).hasSize(2);</span>
<span class="nc" id="L420">            HistoricTaskLogEntry historicTaskLogEntry = logEntries.get(1);</span>
<span class="nc" id="L421">            assertThat(historicTaskLogEntry.getLogNumber()).isNotNull();</span>
<span class="nc" id="L422">            assertThat(historicTaskLogEntry)</span>
<span class="nc" id="L423">                .extracting(</span>
                    HistoricTaskLogEntry::getUserId,
                    HistoricTaskLogEntry::getTaskId,
                    HistoricTaskLogEntry::getType,
                    HistoricTaskLogEntry::getTimeStamp,
                    HistoricTaskLogEntry::getData)
<span class="nc" id="L429">                .containsExactly(</span>
                    &quot;testUser&quot;,
<span class="nc" id="L431">                    task.getId(),</span>
                    &quot;customType&quot;,
<span class="nc" id="L433">                    getInsertDate(),</span>
                    &quot;testData&quot;
                );
<span class="nc" id="L436">            cmmnHistoryService.deleteHistoricTaskLogEntry(logEntries.get(0).getLogNumber());</span>
        }
<span class="nc" id="L438">    }</span>

    @Test
    public void createCustomTaskEventLog_taskIdIsEnoughToCreateTaskLogEntry() {
<span class="nc" id="L442">        task = cmmnTaskService.createTaskBuilder().create();</span>

<span class="nc" id="L444">        HistoricTaskLogEntryBuilder historicTaskLogEntryBuilder = cmmnHistoryService.createHistoricTaskLogEntryBuilder(task);</span>
<span class="nc" id="L445">        historicTaskLogEntryBuilder.create();</span>

<span class="nc bnc" id="L447" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L448">            List&lt;HistoricTaskLogEntry&gt; logEntries = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>

<span class="nc" id="L450">            assertThat(logEntries).hasSize(2);</span>
<span class="nc" id="L451">            HistoricTaskLogEntry historicTaskLogEntry = logEntries.get(1);</span>
<span class="nc" id="L452">            assertThat(historicTaskLogEntry)</span>
<span class="nc" id="L453">                .extracting(HistoricTaskLogEntry::getLogNumber, HistoricTaskLogEntry::getTimeStamp)</span>
<span class="nc" id="L454">                .doesNotContainNull();</span>
<span class="nc" id="L455">            assertThat(historicTaskLogEntry)</span>
<span class="nc" id="L456">                .extracting(HistoricTaskLogEntry::getUserId, HistoricTaskLogEntry::getType, HistoricTaskLogEntry::getData)</span>
<span class="nc" id="L457">                .containsNull();</span>
<span class="nc" id="L458">            assertThat(historicTaskLogEntry.getTaskId()).isEqualTo(task.getId());</span>
        }
<span class="nc" id="L460">    }</span>

    @Test
    public void createCustomTaskEventLog_withoutTimeStamp_addsDefault() {
<span class="nc" id="L464">        task = cmmnTaskService.createTaskBuilder().create();</span>

<span class="nc" id="L466">        HistoricTaskLogEntryBuilder historicTaskLogEntryBuilder = cmmnHistoryService.createHistoricTaskLogEntryBuilder(task);</span>
<span class="nc" id="L467">        historicTaskLogEntryBuilder.userId(&quot;testUser&quot;);</span>
<span class="nc" id="L468">        historicTaskLogEntryBuilder.type(&quot;customType&quot;);</span>
<span class="nc" id="L469">        historicTaskLogEntryBuilder.data(&quot;testData&quot;);</span>
<span class="nc" id="L470">        historicTaskLogEntryBuilder.create();</span>

<span class="nc bnc" id="L472" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L473">            List&lt;HistoricTaskLogEntry&gt; logEntries = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>

<span class="nc" id="L475">            assertThat(logEntries).hasSize(2);</span>
<span class="nc" id="L476">            HistoricTaskLogEntry historicTaskLogEntry = logEntries.get(1);</span>
<span class="nc" id="L477">            assertThat(historicTaskLogEntry)</span>
<span class="nc" id="L478">                .extracting(HistoricTaskLogEntry::getLogNumber, HistoricTaskLogEntry::getTimeStamp)</span>
<span class="nc" id="L479">                .doesNotContainNull();</span>
        }
<span class="nc" id="L481">    }</span>

    @Test
    public void logCaseTaskEvents() {
<span class="nc" id="L485">        deployOneHumanTaskCaseModel();</span>
<span class="nc" id="L486">        CaseInstance oneTaskCase = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;oneTaskCase&quot;).start();</span>
<span class="nc" id="L487">        assertThat(oneTaskCase).isNotNull();</span>

<span class="nc" id="L489">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(oneTaskCase.getId()).singleResult();</span>
<span class="nc" id="L490">        assertThat(task).isNotNull();</span>
        try {
<span class="nc" id="L492">            cmmnTaskService.setAssignee(task.getId(), &quot;newAssignee&quot;);</span>
<span class="nc" id="L493">            cmmnTaskService.setOwner(task.getId(), &quot;newOwner&quot;);</span>
<span class="nc" id="L494">            cmmnTaskService.complete(task.getId());</span>

<span class="nc bnc" id="L496" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L497">                List&lt;HistoricTaskLogEntry&gt; logEntries = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>

<span class="nc" id="L499">                assertThat(logEntries.get(0))</span>
<span class="nc" id="L500">                    .extracting(</span>
                        HistoricTaskLogEntry::getType,
                        HistoricTaskLogEntry::getScopeType,
                        HistoricTaskLogEntry::getScopeId,
                        HistoricTaskLogEntry::getSubScopeId,
                        HistoricTaskLogEntry::getScopeDefinitionId
                    )
<span class="nc" id="L507">                    .containsExactly(</span>
                        &quot;USER_TASK_CREATED&quot;,
                        ScopeTypes.CMMN,
<span class="nc" id="L510">                        oneTaskCase.getId(),</span>
<span class="nc" id="L511">                        task.getSubScopeId(),</span>
<span class="nc" id="L512">                        oneTaskCase.getCaseDefinitionId()</span>
                    );

<span class="nc" id="L515">                assertThat(logEntries)</span>
<span class="nc" id="L516">                    .extracting(HistoricTaskLogEntry::getType)</span>
<span class="nc" id="L517">                    .containsExactly(&quot;USER_TASK_CREATED&quot;, &quot;USER_TASK_ASSIGNEE_CHANGED&quot;, &quot;USER_TASK_OWNER_CHANGED&quot;, &quot;USER_TASK_COMPLETED&quot;);</span>
            }
        } finally {
<span class="nc" id="L520">            deleteTaskWithLogEntries(task.getId());</span>
        }
<span class="nc" id="L522">    }</span>

    @Test
    public void logCaseTaskEventsInSameTransaction() {
<span class="nc" id="L526">        deployOneHumanTaskCaseModel();</span>
<span class="nc" id="L527">        CaseInstance oneTaskCase = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;oneTaskCase&quot;).start();</span>
<span class="nc" id="L528">        assertThat(oneTaskCase).isNotNull();</span>

<span class="nc" id="L530">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(oneTaskCase.getId()).singleResult();</span>
<span class="nc" id="L531">        assertThat(task).isNotNull();</span>
        try {
<span class="nc" id="L533">            cmmnEngineConfiguration.getCommandExecutor().execute(commandContext -&gt; {</span>
<span class="nc" id="L534">                cmmnTaskService.setAssignee(task.getId(), &quot;newAssignee&quot;);</span>
<span class="nc" id="L535">                cmmnTaskService.setOwner(task.getId(), &quot;newOwner&quot;);</span>
<span class="nc" id="L536">                cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L538">                return null;</span>
            });

<span class="nc bnc" id="L541" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L542">                List&lt;HistoricTaskLogEntry&gt; logEntries = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>

<span class="nc" id="L544">                assertThat(logEntries.get(0))</span>
<span class="nc" id="L545">                    .extracting(</span>
                        HistoricTaskLogEntry::getType,
                        HistoricTaskLogEntry::getScopeType,
                        HistoricTaskLogEntry::getScopeId,
                        HistoricTaskLogEntry::getSubScopeId,
                        HistoricTaskLogEntry::getScopeDefinitionId
                    )
<span class="nc" id="L552">                    .containsExactly(</span>
                        &quot;USER_TASK_CREATED&quot;,
                        ScopeTypes.CMMN,
<span class="nc" id="L555">                        oneTaskCase.getId(),</span>
<span class="nc" id="L556">                        task.getSubScopeId(),</span>
<span class="nc" id="L557">                        oneTaskCase.getCaseDefinitionId()</span>
                    );

<span class="nc" id="L560">                assertThat(logEntries)</span>
<span class="nc" id="L561">                    .extracting(HistoricTaskLogEntry::getType)</span>
<span class="nc" id="L562">                    .containsExactly(</span>
                            &quot;USER_TASK_CREATED&quot;,
                            &quot;USER_TASK_ASSIGNEE_CHANGED&quot;,
                            &quot;USER_TASK_ASSIGNEE_CHANGED&quot;,
                            &quot;USER_TASK_OWNER_CHANGED&quot;,
                            &quot;USER_TASK_COMPLETED&quot;
                    );
            }
        } finally {
<span class="nc" id="L571">            deleteTaskWithLogEntries(task.getId());</span>
        }
<span class="nc" id="L573">    }</span>

    @Test
    public void logAddCandidateUser() {
<span class="nc" id="L577">        deployOneHumanTaskCaseModel();</span>
<span class="nc" id="L578">        CaseInstance oneTaskCase = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;oneTaskCase&quot;).start();</span>
<span class="nc" id="L579">        assertThat(oneTaskCase).isNotNull();</span>
<span class="nc" id="L580">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(oneTaskCase.getId()).singleResult();</span>

        try {
<span class="nc" id="L583">            assertThat(oneTaskCase).isNotNull();</span>
<span class="nc" id="L584">            assertThat(task).isNotNull();</span>

<span class="nc" id="L586">            cmmnTaskService.addUserIdentityLink(task.getId(), &quot;newCandidateUser&quot;, IdentityLinkType.CANDIDATE);</span>

<span class="nc bnc" id="L588" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L589">                List&lt;HistoricTaskLogEntry&gt; logEntries = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L590">                assertThat(logEntries).hasSize(2);</span>
<span class="nc" id="L591">                assertThat(logEntries.get(1))</span>
<span class="nc" id="L592">                    .extracting(HistoricTaskLogEntry::getType)</span>
<span class="nc" id="L593">                    .isEqualTo(&quot;USER_TASK_IDENTITY_LINK_ADDED&quot;);</span>
<span class="nc" id="L594">                assertThatJson(logEntries.get(1).getData())</span>
<span class="nc" id="L595">                    .isEqualTo(&quot;{ type: 'candidate', userId: 'newCandidateUser' }&quot;);</span>
            }
        } finally {
<span class="nc" id="L598">            cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L599">            deleteTaskWithLogEntries(task.getId());</span>
        }
<span class="nc" id="L601">    }</span>

    @Test
    public void logAddCandidateGroup() {
<span class="nc" id="L605">        deployOneHumanTaskCaseModel();</span>
<span class="nc" id="L606">        CaseInstance oneTaskCase = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;oneTaskCase&quot;).start();</span>
<span class="nc" id="L607">        assertThat(oneTaskCase).isNotNull();</span>
<span class="nc" id="L608">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(oneTaskCase.getId()).singleResult();</span>
<span class="nc" id="L609">        assertThat(task).isNotNull();</span>
        try {
<span class="nc" id="L611">            cmmnTaskService.addGroupIdentityLink(task.getId(), &quot;newCandidateGroup&quot;, IdentityLinkType.CANDIDATE);</span>

<span class="nc bnc" id="L613" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L614">                List&lt;HistoricTaskLogEntry&gt; logEntries = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L615">                assertThat(logEntries).hasSize(2);</span>
<span class="nc" id="L616">                assertThat(logEntries.get(1))</span>
<span class="nc" id="L617">                    .extracting(HistoricTaskLogEntry::getType)</span>
<span class="nc" id="L618">                    .isEqualTo(&quot;USER_TASK_IDENTITY_LINK_ADDED&quot;);</span>
<span class="nc" id="L619">                assertThatJson(logEntries.get(1).getData())</span>
<span class="nc" id="L620">                    .isEqualTo(&quot;{ type: 'candidate', groupId: 'newCandidateGroup' }&quot;);</span>
            }
        } finally {
<span class="nc" id="L623">            cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L624">            deleteTaskWithLogEntries(task.getId());</span>
        }
<span class="nc" id="L626">    }</span>

    @Test
    public void logDeleteCandidateGroup() {
<span class="nc" id="L630">        deployOneHumanTaskCaseModel();</span>
<span class="nc" id="L631">        CaseInstance oneTaskCase = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;oneTaskCase&quot;).start();</span>
<span class="nc" id="L632">        assertThat(oneTaskCase).isNotNull();</span>
<span class="nc" id="L633">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(oneTaskCase.getId()).singleResult();</span>
<span class="nc" id="L634">        assertThat(task).isNotNull();</span>

<span class="nc" id="L636">        cmmnTaskService.addGroupIdentityLink(task.getId(), &quot;newCandidateGroup&quot;, IdentityLinkType.CANDIDATE);</span>
        try {
<span class="nc" id="L638">            cmmnTaskService.deleteGroupIdentityLink(task.getId(), &quot;newCandidateGroup&quot;, IdentityLinkType.CANDIDATE);</span>

<span class="nc bnc" id="L640" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L641">                List&lt;HistoricTaskLogEntry&gt; logEntries = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L642">                assertThat(logEntries).hasSize(3);</span>
<span class="nc" id="L643">                assertThat(logEntries.get(2))</span>
<span class="nc" id="L644">                    .extracting(HistoricTaskLogEntry::getType)</span>
<span class="nc" id="L645">                    .isEqualTo(&quot;USER_TASK_IDENTITY_LINK_REMOVED&quot;);</span>
<span class="nc" id="L646">                assertThatJson(logEntries.get(2).getData())</span>
<span class="nc" id="L647">                    .isEqualTo(&quot;{ type: 'candidate', groupId: 'newCandidateGroup' }&quot;);</span>
            }
        } finally {
<span class="nc" id="L650">            cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L651">            deleteTaskWithLogEntries(task.getId());</span>
        }
<span class="nc" id="L653">    }</span>

    @Test
    public void logDeleteCandidateUser() {
<span class="nc" id="L657">        deployOneHumanTaskCaseModel();</span>
<span class="nc" id="L658">        CaseInstance oneTaskCase = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;oneTaskCase&quot;).start();</span>
<span class="nc" id="L659">        assertThat(oneTaskCase).isNotNull();</span>
<span class="nc" id="L660">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(oneTaskCase.getId()).singleResult();</span>
<span class="nc" id="L661">        assertThat(task).isNotNull();</span>
<span class="nc" id="L662">        cmmnTaskService.addUserIdentityLink(task.getId(), &quot;newCandidateUser&quot;, IdentityLinkType.CANDIDATE);</span>

        try {
<span class="nc" id="L665">            cmmnTaskService.deleteUserIdentityLink(task.getId(), &quot;newCandidateUser&quot;, IdentityLinkType.CANDIDATE);</span>

<span class="nc bnc" id="L667" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L668">                List&lt;HistoricTaskLogEntry&gt; logEntries = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L669">                assertThat(logEntries).hasSize(3);</span>
<span class="nc" id="L670">                assertThat(logEntries.get(2))</span>
<span class="nc" id="L671">                    .extracting(HistoricTaskLogEntry::getType)</span>
<span class="nc" id="L672">                    .isEqualTo(&quot;USER_TASK_IDENTITY_LINK_REMOVED&quot;);</span>
<span class="nc" id="L673">                assertThatJson(logEntries.get(2).getData())</span>
<span class="nc" id="L674">                    .isEqualTo(&quot;{ type: 'candidate', userId: 'newCandidateUser' }&quot;);</span>
            }
        } finally {
<span class="nc" id="L677">            cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L678">            deleteTaskWithLogEntries(task.getId());</span>
        }
<span class="nc" id="L680">    }</span>

    @Test
    public void queryForTaskLogEntriesByTaskId() {
<span class="nc" id="L684">        task = cmmnTaskService.createTaskBuilder()</span>
<span class="nc" id="L685">                .assignee(&quot;testAssignee&quot;)</span>
<span class="nc" id="L686">                .create();</span>
<span class="nc" id="L687">        Task anotherTask = cmmnTaskService.createTaskBuilder().create();</span>

        try {
<span class="nc bnc" id="L690" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L691">                List&lt;HistoricTaskLogEntry&gt; logEntries = cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L692">                assertThat(logEntries)</span>
<span class="nc" id="L693">                    .extracting(HistoricTaskLogEntry::getTaskId)</span>
<span class="nc" id="L694">                    .containsExactly(task.getId());</span>
<span class="nc" id="L695">                assertThat(cmmnHistoryService.createHistoricTaskLogEntryQuery().taskId(task.getId()).count()).isEqualTo(1);</span>
            }
        } finally {
<span class="nc" id="L698">            deleteTaskWithLogEntries(anotherTask.getId());</span>
        }
<span class="nc" id="L700">    }</span>

    @Test
    public void queryForTaskLogEntriesByUserId() {
<span class="nc bnc" id="L704" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L705">            assertThatTaskLogIsFetched(</span>
<span class="nc" id="L706">                cmmnHistoryService.createHistoricTaskLogEntryBuilder().userId(&quot;testUser&quot;),</span>
<span class="nc" id="L707">                cmmnHistoryService.createHistoricTaskLogEntryQuery().userId(&quot;testUser&quot;)</span>
            );
        }
<span class="nc" id="L710">    }</span>

    protected void assertThatTaskLogIsFetched(HistoricTaskLogEntryBuilder historicTaskLogEntryBuilder, HistoricTaskLogEntryQuery historicTaskLogEntryQuery) {
<span class="nc" id="L713">        task = cmmnTaskService.createTaskBuilder()</span>
<span class="nc" id="L714">                .assignee(&quot;testAssignee&quot;)</span>
<span class="nc" id="L715">                .create();</span>
<span class="nc" id="L716">        Task anotherTask = cmmnTaskService.createTaskBuilder().create();</span>
<span class="nc" id="L717">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>
<span class="nc" id="L718">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>
<span class="nc" id="L719">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>

        try {
<span class="nc" id="L722">            List&lt;HistoricTaskLogEntry&gt; logEntries = historicTaskLogEntryQuery.list();</span>
<span class="nc" id="L723">            assertThat(logEntries).hasSize(3);</span>
<span class="nc" id="L724">            assertThat(logEntries).extracting(HistoricTaskLogEntry::getTaskId).containsExactly(task.getId(), task.getId(), task.getId());</span>

<span class="nc" id="L726">            assertThat(historicTaskLogEntryQuery.count()).isEqualTo(3);</span>

<span class="nc" id="L728">            List&lt;HistoricTaskLogEntry&gt; pagedLogEntries = historicTaskLogEntryQuery.listPage(1, 1);</span>
<span class="nc" id="L729">            assertThat(pagedLogEntries).hasSize(1);</span>
<span class="nc" id="L730">            assertThat(pagedLogEntries.get(0))</span>
<span class="nc" id="L731">                    .usingRecursiveComparison()</span>
<span class="nc" id="L732">                    .isEqualTo(logEntries.get(1));</span>

        } finally {
<span class="nc" id="L735">            deleteTaskWithLogEntries(anotherTask.getId());</span>
<span class="nc" id="L736">            cmmnTaskService.deleteTask(anotherTask.getId());</span>
        }
<span class="nc" id="L738">    }</span>
    
    protected void assertThatAllTaskLogIsFetched(HistoricTaskLogEntryBuilder historicTaskLogEntryBuilder, HistoricTaskLogEntryQuery historicTaskLogEntryQuery) {
<span class="nc" id="L741">        task = cmmnTaskService.createTaskBuilder()</span>
<span class="nc" id="L742">                .assignee(&quot;testAssignee&quot;)</span>
<span class="nc" id="L743">                .create();</span>
<span class="nc" id="L744">        Task anotherTask = cmmnTaskService.createTaskBuilder().create();</span>
<span class="nc" id="L745">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>
<span class="nc" id="L746">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>
<span class="nc" id="L747">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>

        try {
<span class="nc" id="L750">            List&lt;HistoricTaskLogEntry&gt; logEntries = historicTaskLogEntryQuery.list();</span>
<span class="nc" id="L751">            assertThat(logEntries).hasSize(5);</span>
<span class="nc" id="L752">            assertThat(logEntries).extracting(HistoricTaskLogEntry::getTaskId).containsExactly(task.getId(), anotherTask.getId(), task.getId(), task.getId(), task.getId());</span>

<span class="nc" id="L754">            assertThat(historicTaskLogEntryQuery.count()).isEqualTo(5);</span>

<span class="nc" id="L756">            List&lt;HistoricTaskLogEntry&gt; pagedLogEntries = historicTaskLogEntryQuery.listPage(1, 1);</span>
<span class="nc" id="L757">            assertThat(pagedLogEntries).hasSize(1);</span>
<span class="nc" id="L758">            assertThat(pagedLogEntries.get(0))</span>
<span class="nc" id="L759">                    .usingRecursiveComparison()</span>
<span class="nc" id="L760">                    .isEqualTo(logEntries.get(1));</span>

        } finally {
<span class="nc" id="L763">            deleteTaskWithLogEntries(anotherTask.getId());</span>
<span class="nc" id="L764">            cmmnTaskService.deleteTask(anotherTask.getId());</span>
        }
<span class="nc" id="L766">    }</span>

    @Test
    public void queryForTaskLogEntriesByType() {
<span class="nc bnc" id="L770" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L771">            assertThatTaskLogIsFetched(</span>
<span class="nc" id="L772">                cmmnHistoryService.createHistoricTaskLogEntryBuilder().type(&quot;testType&quot;),</span>
<span class="nc" id="L773">                cmmnHistoryService.createHistoricTaskLogEntryQuery().type(&quot;testType&quot;)</span>
            );
        }
<span class="nc" id="L776">    }</span>

    @Test
    public void queryForTaskLogEntriesByProcessInstanceId() {
<span class="nc bnc" id="L780" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L781">            assertThatTaskLogIsFetched(</span>
<span class="nc" id="L782">                cmmnHistoryService.createHistoricTaskLogEntryBuilder().processInstanceId(&quot;testProcess&quot;),</span>
<span class="nc" id="L783">                cmmnHistoryService.createHistoricTaskLogEntryQuery().processInstanceId(&quot;testProcess&quot;)</span>
            );
        }
<span class="nc" id="L786">    }</span>

    @Test
    public void queryForTaskLogEntriesByScopeId() {
<span class="nc bnc" id="L790" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L791">            assertThatTaskLogIsFetched(</span>
<span class="nc" id="L792">                cmmnHistoryService.createHistoricTaskLogEntryBuilder().scopeId(&quot;testScopeId&quot;),</span>
<span class="nc" id="L793">                cmmnHistoryService.createHistoricTaskLogEntryQuery().scopeId(&quot;testScopeId&quot;)</span>
            );
        }
<span class="nc" id="L796">    }</span>

    @Test
    public void queryForTaskLogEntriesBySubScopeId() {
<span class="nc bnc" id="L800" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L801">            assertThatTaskLogIsFetched(</span>
<span class="nc" id="L802">                cmmnHistoryService.createHistoricTaskLogEntryBuilder().subScopeId(&quot;testSubScopeId&quot;),</span>
<span class="nc" id="L803">                cmmnHistoryService.createHistoricTaskLogEntryQuery().subScopeId(&quot;testSubScopeId&quot;)</span>
            );
        }
<span class="nc" id="L806">    }</span>

    @Test
    public void queryForTaskLogEntriesByScopeType() {
<span class="nc bnc" id="L810" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L811">            assertThatTaskLogIsFetched(</span>
<span class="nc" id="L812">                cmmnHistoryService.createHistoricTaskLogEntryBuilder().scopeType(&quot;testScopeType&quot;),</span>
<span class="nc" id="L813">                cmmnHistoryService.createHistoricTaskLogEntryQuery().scopeType(&quot;testScopeType&quot;)</span>
            );
        }
<span class="nc" id="L816">    }</span>

    @Test
    public void queryForTaskLogEntriesByFromTimeStamp() {
<span class="nc" id="L820">        assertThatAllTaskLogIsFetched(</span>
<span class="nc" id="L821">            cmmnHistoryService.createHistoricTaskLogEntryBuilder().timeStamp(getInsertDate()),</span>
<span class="nc" id="L822">            cmmnHistoryService.createHistoricTaskLogEntryQuery().from(getCompareBeforeDate())</span>
        );
<span class="nc" id="L824">    }</span>

    @Test
    public void queryForTaskLogEntriesByFromIncludedTimeStamp() {
<span class="nc" id="L828">        assertThatAllTaskLogIsFetched(</span>
<span class="nc" id="L829">            cmmnHistoryService.createHistoricTaskLogEntryBuilder().timeStamp(getInsertDate()),</span>
<span class="nc" id="L830">            cmmnHistoryService.createHistoricTaskLogEntryQuery().from(getInsertDate())</span>
        );
<span class="nc" id="L832">    }</span>

    @Test
    public void queryForTaskLogEntriesByToIncludedTimeStamp() {
<span class="nc" id="L836">        HistoricTaskLogEntryBuilder historicTaskLogEntryBuilder = cmmnHistoryService.createHistoricTaskLogEntryBuilder().timeStamp(getInsertDate());</span>
<span class="nc" id="L837">        HistoricTaskLogEntryQuery historicTaskLogEntryQuery = cmmnHistoryService.createHistoricTaskLogEntryQuery().to(getCompareAfterDate());</span>

<span class="nc" id="L839">        task = cmmnTaskService.createTaskBuilder()</span>
<span class="nc" id="L840">                .assignee(&quot;testAssignee&quot;)</span>
<span class="nc" id="L841">                .create();</span>
<span class="nc" id="L842">        Task anotherTask = cmmnTaskService.createTaskBuilder().create();</span>
<span class="nc" id="L843">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>
<span class="nc" id="L844">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>
<span class="nc" id="L845">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>

<span class="nc bnc" id="L847" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
            try {
<span class="nc" id="L849">                List&lt;HistoricTaskLogEntry&gt; logEntries = historicTaskLogEntryQuery.list();</span>
<span class="nc" id="L850">                assertThat(logEntries)</span>
<span class="nc" id="L851">                    .extracting(HistoricTaskLogEntry::getTaskId)</span>
<span class="nc" id="L852">                    .containsExactly(</span>
<span class="nc" id="L853">                        task.getId(),</span>
<span class="nc" id="L854">                        task.getId(),</span>
<span class="nc" id="L855">                        task.getId()</span>
                    );

<span class="nc" id="L858">                assertThat(historicTaskLogEntryQuery.count()).isEqualTo(3);</span>

<span class="nc" id="L860">                List&lt;HistoricTaskLogEntry&gt; pagedLogEntries = historicTaskLogEntryQuery.listPage(1, 1);</span>
<span class="nc" id="L861">                assertThat(pagedLogEntries).hasSize(1);</span>
<span class="nc" id="L862">                assertThat(pagedLogEntries.get(0))</span>
<span class="nc" id="L863">                        .usingRecursiveComparison()</span>
<span class="nc" id="L864">                        .isEqualTo(logEntries.get(1));</span>

            } finally {
<span class="nc" id="L867">                deleteTaskWithLogEntries(anotherTask.getId());</span>
            }
        }

<span class="nc" id="L871">        cmmnTaskService.deleteTask(anotherTask.getId());</span>
<span class="nc" id="L872">    }</span>

    @Test
    public void queryForTaskLogEntriesByFromToTimeStamp() {
<span class="nc bnc" id="L876" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L877">            assertThatTaskLogIsFetched(</span>
<span class="nc" id="L878">                cmmnHistoryService.createHistoricTaskLogEntryBuilder().timeStamp(getInsertDate()),</span>
<span class="nc" id="L879">                cmmnHistoryService.createHistoricTaskLogEntryQuery().from(getCompareBeforeDate()).to(getCompareAfterDate())</span>
            );
        }
<span class="nc" id="L882">    }</span>

    @Test
    public void queryForTaskLogEntriesByTenantId() {
<span class="nc bnc" id="L886" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L887">            assertThatTaskLogIsFetched(</span>
<span class="nc" id="L888">                cmmnHistoryService.createHistoricTaskLogEntryBuilder().timeStamp(getInsertDate()),</span>
<span class="nc" id="L889">                cmmnHistoryService.createHistoricTaskLogEntryQuery().from(getCompareBeforeDate()).to(getCompareAfterDate())</span>
            );
        }
<span class="nc" id="L892">    }</span>

    @Test
    public void queryForTaskLogEntriesByProcessDefinitionId() {
<span class="nc bnc" id="L896" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L897">            assertThatTaskLogIsFetched(</span>
<span class="nc" id="L898">                cmmnHistoryService.createHistoricTaskLogEntryBuilder().processDefinitionId(&quot;testProcessDefinitionId&quot;),</span>
<span class="nc" id="L899">                cmmnHistoryService.createHistoricTaskLogEntryQuery().processDefinitionId(&quot;testProcessDefinitionId&quot;)</span>
            );
        }
<span class="nc" id="L902">    }</span>

    @Test
    public void queryForTaskLogEntriesByScopeDefinitionId() {
<span class="nc bnc" id="L906" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L907">            assertThatTaskLogIsFetched(</span>
<span class="nc" id="L908">                cmmnHistoryService.createHistoricTaskLogEntryBuilder().scopeDefinitionId(&quot;testScopeDefinitionId&quot;),</span>
<span class="nc" id="L909">                cmmnHistoryService.createHistoricTaskLogEntryQuery().scopeDefinitionId(&quot;testScopeDefinitionId&quot;)</span>
            );
        }
<span class="nc" id="L912">    }</span>

    @Test
    public void queryForTaskLogEntriesByLogNumber() {
<span class="nc" id="L916">        task = cmmnTaskService.createTaskBuilder()</span>
<span class="nc" id="L917">            .assignee(&quot;testAssignee&quot;)</span>
<span class="nc" id="L918">            .create();</span>
<span class="nc" id="L919">        Task anotherTask = cmmnTaskService.createTaskBuilder().create();</span>
<span class="nc" id="L920">        HistoricTaskLogEntryBuilder historicTaskLogEntryBuilder = cmmnHistoryService.createHistoricTaskLogEntryBuilder();</span>
<span class="nc" id="L921">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>
<span class="nc" id="L922">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>
<span class="nc" id="L923">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>

<span class="nc bnc" id="L925" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>

<span class="nc" id="L927">            List&lt;HistoricTaskLogEntry&gt; allLogEntries = cmmnHistoryService.createHistoricTaskLogEntryQuery().list();</span>

            try {
<span class="nc" id="L930">                HistoricTaskLogEntryQuery historicTaskLogEntryQuery = cmmnHistoryService.createHistoricTaskLogEntryQuery()</span>
<span class="nc" id="L931">                    .fromLogNumber(allLogEntries.get(1).getLogNumber())</span>
<span class="nc" id="L932">                    .toLogNumber(allLogEntries.get(allLogEntries.size() - 2).getLogNumber());</span>

<span class="nc" id="L934">                List&lt;HistoricTaskLogEntry&gt; logEntries = historicTaskLogEntryQuery.list();</span>
<span class="nc" id="L935">                assertThat(logEntries)</span>
<span class="nc" id="L936">                    .extracting(HistoricTaskLogEntry::getTaskId)</span>
<span class="nc" id="L937">                    .containsExactly(anotherTask.getId(), task.getId(), task.getId());</span>

<span class="nc" id="L939">                assertThat(historicTaskLogEntryQuery.count()).isEqualTo(3);</span>

<span class="nc" id="L941">                List&lt;HistoricTaskLogEntry&gt; pagedLogEntries = historicTaskLogEntryQuery.listPage(1, 1);</span>
<span class="nc" id="L942">                assertThat(pagedLogEntries).hasSize(1);</span>
<span class="nc" id="L943">                assertThat(pagedLogEntries.get(0))</span>
<span class="nc" id="L944">                        .usingRecursiveComparison()</span>
<span class="nc" id="L945">                        .isEqualTo(logEntries.get(1));</span>

            } finally {
<span class="nc" id="L948">                deleteTaskWithLogEntries(anotherTask.getId());</span>
            }
        }

<span class="nc" id="L952">        cmmnTaskService.deleteTask(anotherTask.getId(), true);</span>
<span class="nc" id="L953">    }</span>

    @Test
    public void queryForTaskLogEntriesByNativeQuery() {

<span class="nc" id="L958">        HistoricTaskLogEntryBuilder historicTaskLogEntryBuilder = cmmnHistoryService.createHistoricTaskLogEntryBuilder();</span>
<span class="nc" id="L959">        historicTaskLogEntryBuilder.taskId(&quot;1&quot;).create();</span>
<span class="nc" id="L960">        historicTaskLogEntryBuilder.taskId(&quot;2&quot;).create();</span>
<span class="nc" id="L961">        historicTaskLogEntryBuilder.taskId(&quot;3&quot;).create();</span>

<span class="nc bnc" id="L963" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
            try {
<span class="nc" id="L965">                assertThat(cmmnHistoryService.createNativeHistoricTaskLogEntryQuery().sql(&quot;SELECT * FROM ACT_HI_TSK_LOG&quot;).list())</span>
<span class="nc" id="L966">                    .hasSize(3);</span>
<span class="nc" id="L967">                assertThat(cmmnHistoryService.createNativeHistoricTaskLogEntryQuery().sql(&quot;SELECT count(*) FROM ACT_HI_TSK_LOG&quot;).count())</span>
<span class="nc" id="L968">                    .isEqualTo(3);</span>

<span class="nc" id="L970">                assertThat(cmmnHistoryService.createNativeHistoricTaskLogEntryQuery().parameter(&quot;taskId&quot;, &quot;1&quot;)</span>
<span class="nc" id="L971">                    .sql(&quot;SELECT * FROM ACT_HI_TSK_LOG WHERE TASK_ID_ = #{taskId}&quot;).list())</span>
<span class="nc" id="L972">                    .hasSize(1);</span>
<span class="nc" id="L973">                assertThat(cmmnHistoryService.createNativeHistoricTaskLogEntryQuery().parameter(&quot;taskId&quot;, &quot;1&quot;)</span>
<span class="nc" id="L974">                    .sql(&quot;SELECT count(*) FROM ACT_HI_TSK_LOG WHERE TASK_ID_ = #{taskId}&quot;).count())</span>
<span class="nc" id="L975">                    .isEqualTo(1);</span>
            } finally {
<span class="nc" id="L977">                deleteTaskWithLogEntries(&quot;1&quot;);</span>
<span class="nc" id="L978">                deleteTaskWithLogEntries(&quot;2&quot;);</span>
<span class="nc" id="L979">                deleteTaskWithLogEntries(&quot;3&quot;);</span>
            }
        }
<span class="nc" id="L982">    }</span>

    @Test
    public void testTaskLogEntriesDeletedOnDeploymentDelete() {
<span class="nc" id="L986">        CaseInstance caseInstance = null;</span>
        try {
<span class="nc" id="L988">            cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L989">                    .addClasspathResource(&quot;org/flowable/cmmn/test/history/CmmnHistoryServiceTaskLogTest.testTaskLogEntriesDeletedOnDeploymentDelete.cmmn&quot;)</span>
<span class="nc" id="L990">                    .deploy();</span>
<span class="nc" id="L991">            caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L992">            Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L993">            cmmnTaskService.complete(task.getId());</span>

<span class="nc bnc" id="L995" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L996">                assertThat(cmmnHistoryService.createHistoricTaskLogEntryQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(6);</span>
<span class="nc" id="L997">                assertThat(cmmnHistoryService.createHistoricTaskLogEntryQuery().caseDefinitionId(caseInstance.getCaseDefinitionId()).count()).isEqualTo(6);</span>
            }

        } finally {
<span class="nc" id="L1001">            CmmnTestHelper.deleteDeployment(cmmnEngineConfiguration,</span>
<span class="nc" id="L1002">                cmmnRepositoryService.createCaseDefinitionQuery().caseDefinitionId(caseInstance.getCaseDefinitionId()).singleResult().getDeploymentId());</span>

<span class="nc bnc" id="L1004" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1005">                assertThat(cmmnHistoryService.createHistoricTaskLogEntryQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>
<span class="nc" id="L1006">                assertThat(cmmnHistoryService.createHistoricTaskLogEntryQuery().caseDefinitionId(caseInstance.getCaseDefinitionId()).count()).isZero();</span>
            }
        }
<span class="nc" id="L1009">    }</span>

    protected Date getInsertDate() {
<span class="nc" id="L1012">        Calendar cal = new GregorianCalendar(2019, 3, 10);</span>
<span class="nc" id="L1013">        return cal.getTime();</span>
    }

    protected Date getCompareBeforeDate() {
<span class="nc" id="L1017">        Calendar cal = new GregorianCalendar(2019, 3, 9);</span>
<span class="nc" id="L1018">        return cal.getTime();</span>
    }

    protected Date getCompareAfterDate() {
<span class="nc" id="L1022">        Calendar cal = new GregorianCalendar(2019, 3, 11);</span>
<span class="nc" id="L1023">        return cal.getTime();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>