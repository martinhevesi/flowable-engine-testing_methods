<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PlanItemInstanceHistoryServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.cmmn.test.history</a> &gt; <span class="el_source">PlanItemInstanceHistoryServiceTest.java</span></div><h1>PlanItemInstanceHistoryServiceTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.cmmn.test.history;

import static org.assertj.core.api.Assertions.assertThat;

import java.time.Instant;
import java.time.temporal.ChronoUnit;
import java.util.Calendar;
import java.util.Collections;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.concurrent.TimeUnit;
import java.util.function.Consumer;
import java.util.stream.Collectors;

import org.flowable.cmmn.api.history.HistoricMilestoneInstance;
import org.flowable.cmmn.api.history.HistoricPlanItemInstance;
import org.flowable.cmmn.api.runtime.CaseInstance;
import org.flowable.cmmn.api.runtime.PlanItemDefinitionType;
import org.flowable.cmmn.api.runtime.PlanItemInstance;
import org.flowable.cmmn.api.runtime.PlanItemInstanceState;
import org.flowable.cmmn.engine.test.CmmnDeployment;
import org.flowable.cmmn.engine.test.FlowableCmmnTestCase;
import org.flowable.cmmn.engine.test.impl.CmmnHistoryTestHelper;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.task.api.Task;
import org.flowable.variable.api.history.HistoricVariableInstance;
import org.junit.Test;

/**
 * @author Dennis Federico
 */
<span class="nc" id="L46">public class PlanItemInstanceHistoryServiceTest extends FlowableCmmnTestCase {</span>

<span class="nc" id="L48">    private static Consumer&lt;HistoricPlanItemInstance&gt; assertCreateTimeHistoricPlanItemInstance = h -&gt; {</span>
<span class="nc" id="L49">        assertThat(h.getCreateTime()).isNotNull();</span>
<span class="nc" id="L50">        assertThat(h.getCreateTime().getTime()).isGreaterThanOrEqualTo(0L);</span>
        //        if (!PlanItemInstanceState.WAITING_FOR_REPETITION.equalsIgnoreCase(h.getState())) {
        //            assertThat(h.getLastAvailableTime()).isNotNull();
        //        }
<span class="nc" id="L54">    };</span>

<span class="nc" id="L56">    private static Consumer&lt;HistoricPlanItemInstance&gt; assertStartedTimeHistoricPlanItemInstance = h -&gt; {</span>
<span class="nc" id="L57">        assertThat(h.getLastStartedTime()).isNotNull();</span>
<span class="nc" id="L58">        assertThat(h.getLastStartedTime().getTime()).isGreaterThanOrEqualTo(h.getCreateTime().getTime());</span>
<span class="nc" id="L59">    };</span>

<span class="nc" id="L61">    private static Consumer&lt;HistoricPlanItemInstance&gt; assertEndedTimeHistoricPlanItemInstance = h -&gt; {</span>
<span class="nc" id="L62">        assertThat(h.getEndedTime()).isNotNull();</span>
<span class="nc" id="L63">        assertThat(h.getEndedTime().getTime()).isGreaterThanOrEqualTo(h.getLastStartedTime().getTime());</span>
<span class="nc" id="L64">    };</span>

<span class="nc" id="L66">    private static Consumer&lt;HistoricPlanItemInstance&gt; assertEndStateHistoricPlanItemInstance = h -&gt; {</span>
<span class="nc" id="L67">        assertThat(h.getState()).isNotNull();</span>
<span class="nc" id="L68">        assertThat(PlanItemInstanceState.END_STATES).contains(h.getState());</span>
<span class="nc" id="L69">    };</span>

<span class="nc" id="L71">    private static Consumer&lt;HistoricPlanItemInstance&gt; assertStartedStateHistoricPlanItemInstance = h -&gt; {</span>
<span class="nc" id="L72">        assertThat(h.getState())</span>
<span class="nc" id="L73">                .isIn(PlanItemInstanceState.ACTIVE, PlanItemInstanceState.ENABLED, PlanItemInstanceState.ASYNC_ACTIVE);</span>
<span class="nc" id="L74">    };</span>

    @Test
    @CmmnDeployment
    public void testSimpleCaseFlow() {
<span class="nc" id="L79">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testSimpleCaseFlow&quot;).start();</span>

        //one Task, one Stage, one Milestone
<span class="nc" id="L82">        List&lt;PlanItemInstance&gt; currentPlanItems = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L83">        assertThat(currentPlanItems).hasSize(3);</span>
<span class="nc" id="L84">        assertThat(currentPlanItems.stream().map(PlanItemInstance::getPlanItemDefinitionType).anyMatch(PlanItemDefinitionType.STAGE::equalsIgnoreCase))</span>
<span class="nc" id="L85">                .isTrue();</span>
<span class="nc" id="L86">        assertThat(currentPlanItems.stream().map(PlanItemInstance::getPlanItemDefinitionType).anyMatch(PlanItemDefinitionType.MILESTONE::equalsIgnoreCase))</span>
<span class="nc" id="L87">                .isTrue();</span>
<span class="nc" id="L88">        assertThat(currentPlanItems.stream().map(PlanItemInstance::getPlanItemDefinitionType).anyMatch(&quot;task&quot;::equalsIgnoreCase)).isTrue();</span>

        //Milestone are just another planItem too, so it will appear in the planItemInstance History
<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L92">            List&lt;HistoricPlanItemInstance&gt; historicPlanItems = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L93">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L94">            assertThat(historicPlanItems).hasSize(3);</span>
<span class="nc" id="L95">            assertThat(</span>
<span class="nc" id="L96">                historicPlanItems.stream().map(HistoricPlanItemInstance::getPlanItemDefinitionType).anyMatch(PlanItemDefinitionType.STAGE::equalsIgnoreCase))</span>
<span class="nc" id="L97">                .isTrue();</span>
<span class="nc" id="L98">            assertThat(historicPlanItems.stream().map(HistoricPlanItemInstance::getPlanItemDefinitionType)</span>
<span class="nc" id="L99">                .anyMatch(PlanItemDefinitionType.MILESTONE::equalsIgnoreCase)).isTrue();</span>
<span class="nc" id="L100">            assertThat(historicPlanItems.stream()</span>
<span class="nc bnc" id="L101" title="All 4 branches missed.">                .anyMatch(h -&gt; &quot;task&quot;.equalsIgnoreCase(h.getPlanItemDefinitionType()) &amp;&amp; &quot;planItemTaskA&quot;.equalsIgnoreCase(h.getElementId()))).isTrue();</span>

            //Check Start timeStamp within the second of its original creation
<span class="nc" id="L104">            historicPlanItems.forEach(assertCreateTimeHistoricPlanItemInstance);</span>
<span class="nc" id="L105">            checkHistoryCreateTimestamp(currentPlanItems, historicPlanItems, 1000L);</span>

            //Check activation timestamp... for those &quot;live&quot; instances not in &quot;Waiting&quot; state (i.e. AVAILABLE)
<span class="nc" id="L108">            List&lt;String&gt; nonWaitingPlanInstanceIds = getIdsOfNonWaitingPlanItemInstances(currentPlanItems);</span>
<span class="nc" id="L109">            assertThat(nonWaitingPlanInstanceIds).isNotEmpty();</span>
<span class="nc" id="L110">            List&lt;HistoricPlanItemInstance&gt; filteredHistoricPlanItemInstances = historicPlanItems.stream()</span>
<span class="nc" id="L111">                .filter(h -&gt; nonWaitingPlanInstanceIds.contains(h.getId()))</span>
<span class="nc" id="L112">                .collect(Collectors.toList());</span>
<span class="nc" id="L113">            assertThat(filteredHistoricPlanItemInstances).isNotEmpty();</span>
<span class="nc" id="L114">            filteredHistoricPlanItemInstances.forEach(assertCreateTimeHistoricPlanItemInstance</span>
<span class="nc" id="L115">                .andThen(assertStartedTimeHistoricPlanItemInstance)</span>
<span class="nc" id="L116">                .andThen(assertStartedTimeHistoricPlanItemInstance)</span>
<span class="nc" id="L117">                .andThen(assertStartedStateHistoricPlanItemInstance));</span>

            //No planItemInstance has &quot;ended&quot; yet, so no historicPlanItemInstance should have endTime timestamp
<span class="nc" id="L120">            historicPlanItems.forEach(h -&gt; assertThat(h.getEndedTime()).isNull());</span>

            //Milestone history is only filled when the milestone occurs
<span class="nc" id="L123">            List&lt;HistoricMilestoneInstance&gt; historicMilestones = cmmnHistoryService.createHistoricMilestoneInstanceQuery()</span>
<span class="nc" id="L124">                .milestoneInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L125">            assertThat(historicMilestones).isEmpty();</span>

            //////////////////////////////////////////////////////////////////
            //Trigger the task to reach the milestone and activate the stage//
<span class="nc" id="L129">            assertCaseInstanceNotEnded(caseInstance);</span>
<span class="nc" id="L130">            PlanItemInstance task = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceElementId(&quot;planItemTaskA&quot;).singleResult();</span>
<span class="nc" id="L131">            assertThat(task).isNotNull();</span>
<span class="nc" id="L132">            cmmnRuntimeService.triggerPlanItemInstance(task.getId());</span>
<span class="nc" id="L133">            assertCaseInstanceNotEnded(caseInstance);</span>

            //Now there are 2 plan items in a non-final state, a Stage and its containing task (only 1 new planItem)
<span class="nc" id="L136">            currentPlanItems = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L137">            assertThat(currentPlanItems).hasSize(2);</span>
<span class="nc" id="L138">            assertThat(currentPlanItems.stream().map(PlanItemInstance::getPlanItemDefinitionType).anyMatch(PlanItemDefinitionType.STAGE::equalsIgnoreCase))</span>
<span class="nc" id="L139">                .isTrue();</span>
<span class="nc" id="L140">            assertThat(currentPlanItems.stream()</span>
<span class="nc bnc" id="L141" title="All 4 branches missed.">                .anyMatch(p -&gt; &quot;task&quot;.equalsIgnoreCase(p.getPlanItemDefinitionType()) &amp;&amp; &quot;planItemTaskB&quot;.equalsIgnoreCase(p.getElementId()))).isTrue();</span>

<span class="nc" id="L143">            historicPlanItems = cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L144">            assertThat(historicPlanItems).hasSize(4);</span>
<span class="nc" id="L145">            assertThat(</span>
<span class="nc" id="L146">                cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceId(historicPlanItems.get(0).getId()).planItemInstanceWithoutTenantId()</span>
<span class="nc" id="L147">                    .list()).hasSize(1);</span>
<span class="nc" id="L148">            assertThat(</span>
<span class="nc" id="L149">                cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceId(historicPlanItems.get(0).getId()).planItemInstanceWithoutTenantId()</span>
<span class="nc" id="L150">                    .count()).isEqualTo(1);</span>

            //Check start timestamps of newly added timeStamp within the second of its original creation
<span class="nc" id="L153">            checkHistoryCreateTimestamp(currentPlanItems, historicPlanItems, 1000L);</span>

            //Check activationTime if applies and the endTime for not &quot;live&quot; instances
<span class="nc" id="L156">            List&lt;String&gt; livePlanItemInstanceIds = currentPlanItems.stream().map(PlanItemInstance::getId).collect(Collectors.toList());</span>
<span class="nc" id="L157">            assertThat(livePlanItemInstanceIds).isNotEmpty();</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">            filteredHistoricPlanItemInstances = historicPlanItems.stream().filter(h -&gt; !livePlanItemInstanceIds.contains(h.getId()))</span>
<span class="nc" id="L159">                .collect(Collectors.toList());</span>
<span class="nc" id="L160">            filteredHistoricPlanItemInstances.forEach(assertCreateTimeHistoricPlanItemInstance</span>
<span class="nc" id="L161">                .andThen(assertStartedTimeHistoricPlanItemInstance)</span>
<span class="nc" id="L162">                .andThen(assertEndedTimeHistoricPlanItemInstance)</span>
<span class="nc" id="L163">                .andThen(assertEndStateHistoricPlanItemInstance));</span>

            //Milestone appears now in the MilestoneHistory
<span class="nc" id="L166">            historicMilestones = cmmnHistoryService.createHistoricMilestoneInstanceQuery().milestoneInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L167">            assertThat(historicMilestones).hasSize(1);</span>

            //////////////////////////////////////////////////
            //Trigger the last planItem to complete the Case//
<span class="nc" id="L171">            assertCaseInstanceNotEnded(caseInstance);</span>
<span class="nc" id="L172">            task = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceElementId(&quot;planItemTaskB&quot;).singleResult();</span>
<span class="nc" id="L173">            assertThat(task).isNotNull();</span>
<span class="nc" id="L174">            cmmnRuntimeService.triggerPlanItemInstance(task.getId());</span>
<span class="nc" id="L175">            assertCaseInstanceEnded(caseInstance);</span>

            //History remains
<span class="nc" id="L178">            historicPlanItems = cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L179">            assertThat(historicPlanItems).hasSize(4);</span>
<span class="nc" id="L180">            historicPlanItems.forEach(assertCreateTimeHistoricPlanItemInstance</span>
<span class="nc" id="L181">                .andThen(assertStartedTimeHistoricPlanItemInstance)</span>
<span class="nc" id="L182">                .andThen(assertEndedTimeHistoricPlanItemInstance)</span>
<span class="nc" id="L183">                .andThen(assertEndStateHistoricPlanItemInstance)</span>
            );

<span class="nc" id="L186">            historicMilestones = cmmnHistoryService.createHistoricMilestoneInstanceQuery().milestoneInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L187">            assertThat(historicMilestones).hasSize(1);</span>
        }
<span class="nc" id="L189">    }</span>

    @Test
    @CmmnDeployment
    public void testSimpleStage() {
<span class="nc" id="L194">        setClockFixedToCurrentTime();</span>
<span class="nc" id="L195">        Calendar beforeCaseCalendar = cmmnEngineConfiguration.getClock().getCurrentCalendar();</span>
<span class="nc" id="L196">        beforeCaseCalendar.add(Calendar.HOUR, -1);</span>
<span class="nc" id="L197">        Date beforeCaseInstance = beforeCaseCalendar.getTime();</span>
<span class="nc" id="L198">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testSimpleStage&quot;).start();</span>
<span class="nc" id="L199">        Calendar afterCaseCalendar = cmmnEngineConfiguration.getClock().getCurrentCalendar();</span>
<span class="nc" id="L200">        afterCaseCalendar.add(Calendar.HOUR, 1);</span>
<span class="nc" id="L201">        Date afterCaseInstance = afterCaseCalendar.getTime();</span>

        //Basic case setup check
<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L205">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery().list();</span>
<span class="nc" id="L206">            assertThat(historicPlanItemInstances).hasSize(2);</span>
<span class="nc" id="L207">            assertThat(historicPlanItemInstances.stream().filter(h -&gt; PlanItemDefinitionType.STAGE.equals(h.getPlanItemDefinitionType())).count()).isEqualTo(1);</span>
<span class="nc" id="L208">            assertThat(historicPlanItemInstances.stream().filter(h -&gt; PlanItemDefinitionType.HUMAN_TASK.equals(h.getPlanItemDefinitionType())).count())</span>
<span class="nc" id="L209">                .isEqualTo(1);</span>

            //Check by different criteria
<span class="nc" id="L212">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L213">                .planItemInstanceCaseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L214">                .createdBefore(afterCaseInstance)</span>
<span class="nc" id="L215">                .createdAfter(beforeCaseInstance)</span>
<span class="nc" id="L216">                .lastAvailableBefore(afterCaseInstance)</span>
<span class="nc" id="L217">                .lastAvailableAfter(beforeCaseInstance)</span>
<span class="nc" id="L218">                .lastStartedBefore(afterCaseInstance)</span>
<span class="nc" id="L219">                .lastStartedAfter(beforeCaseInstance)</span>
<span class="nc" id="L220">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L221">                .count()).isEqualTo(2);</span>
        }

<span class="nc" id="L224">        Calendar beforeCompleteCalendar = cmmnEngineConfiguration.getClock().getCurrentCalendar();</span>
<span class="nc" id="L225">        beforeCompleteCalendar.add(Calendar.HOUR, -1);</span>
<span class="nc" id="L226">        Date beforeComplete = beforeCompleteCalendar.getTime();</span>
<span class="nc" id="L227">        PlanItemInstance planItemTask = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceElementId(&quot;planItemTaskA&quot;).singleResult();</span>
<span class="nc" id="L228">        Task task = cmmnTaskService.createTaskQuery().subScopeId(planItemTask.getId()).singleResult();</span>
<span class="nc" id="L229">        cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L230">        Date afterComplete = forwardClock(60_000L);</span>

<span class="nc bnc" id="L232" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L233">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L234">                .planItemInstanceCaseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L235">                .completedBefore(afterComplete)</span>
<span class="nc" id="L236">                .completedAfter(beforeComplete)</span>
<span class="nc" id="L237">                .list();</span>
<span class="nc" id="L238">            assertThat(historicPlanItemInstances).hasSize(2);</span>
<span class="nc" id="L239">            assertThat(historicPlanItemInstances)</span>
<span class="nc" id="L240">                .extracting(HistoricPlanItemInstance::getExitTime)</span>
<span class="nc" id="L241">                .containsOnlyNulls();</span>
<span class="nc" id="L242">            assertThat(historicPlanItemInstances)</span>
<span class="nc" id="L243">                .extracting(HistoricPlanItemInstance::getTerminatedTime)</span>
<span class="nc" id="L244">                .containsOnlyNulls();</span>
<span class="nc" id="L245">            assertThat(historicPlanItemInstances)</span>
<span class="nc" id="L246">                .extracting(HistoricPlanItemInstance::getOccurredTime)</span>
<span class="nc" id="L247">                .containsOnlyNulls();</span>
<span class="nc" id="L248">            assertThat(historicPlanItemInstances)</span>
<span class="nc" id="L249">                .extracting(HistoricPlanItemInstance::getLastDisabledTime)</span>
<span class="nc" id="L250">                .containsOnlyNulls();</span>
<span class="nc" id="L251">            assertThat(historicPlanItemInstances)</span>
<span class="nc" id="L252">                .extracting(HistoricPlanItemInstance::getLastEnabledTime)</span>
<span class="nc" id="L253">                .containsOnlyNulls();</span>
<span class="nc" id="L254">            assertThat(historicPlanItemInstances)</span>
<span class="nc" id="L255">                .extracting(HistoricPlanItemInstance::getLastSuspendedTime)</span>
<span class="nc" id="L256">                .containsOnlyNulls();</span>
<span class="nc" id="L257">            assertThat(historicPlanItemInstances)</span>
<span class="nc" id="L258">                .extracting(HistoricPlanItemInstance::getCreateTime)</span>
<span class="nc" id="L259">                .isNotNull();</span>

<span class="nc" id="L261">            historicPlanItemInstances.forEach(h -&gt; {</span>
<span class="nc" id="L262">                assertThat(h.getCreateTime().getTime()).isLessThanOrEqualTo(h.getLastAvailableTime().getTime());</span>
<span class="nc" id="L263">                assertThat(h.getLastAvailableTime().getTime()).isLessThanOrEqualTo(h.getCompletedTime().getTime());</span>
<span class="nc" id="L264">                assertThat(h.getCompletedTime().getTime()).isLessThanOrEqualTo(h.getEndedTime().getTime());</span>
<span class="nc" id="L265">            });</span>
        }

<span class="nc" id="L268">        assertCaseInstanceEnded(caseInstance);</span>
<span class="nc" id="L269">    }</span>

    @Test
    @CmmnDeployment
    public void testEntryAndExitPropagate() {
<span class="nc" id="L274">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testEntryAndExitPropagate&quot;).start();</span>

<span class="nc" id="L276">        List&lt;PlanItemInstance&gt; currentPlanItems = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L277">        assertThat(currentPlanItems).hasSize(3);</span>
<span class="nc" id="L278">        assertThat(currentPlanItems.stream()</span>
<span class="nc" id="L279">                .filter(p -&gt; PlanItemDefinitionType.STAGE.equalsIgnoreCase(p.getPlanItemDefinitionType()))</span>
<span class="nc" id="L280">                .filter(p -&gt; PlanItemInstanceState.AVAILABLE.equalsIgnoreCase(p.getState()))</span>
<span class="nc" id="L281">                .count()).isEqualTo(1);</span>
<span class="nc" id="L282">        assertThat(currentPlanItems.stream()</span>
<span class="nc" id="L283">                .filter(p -&gt; PlanItemDefinitionType.USER_EVENT_LISTENER.equalsIgnoreCase(p.getPlanItemDefinitionType()))</span>
<span class="nc" id="L284">                .filter(p -&gt; PlanItemInstanceState.AVAILABLE.equalsIgnoreCase(p.getState()))</span>
<span class="nc" id="L285">                .count()).isEqualTo(2);</span>

<span class="nc bnc" id="L287" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L288">            List&lt;HistoricPlanItemInstance&gt; historicPlanItems = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L289">                .planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L290">            assertThat(historicPlanItems).hasSize(3);</span>
<span class="nc" id="L291">            checkHistoryCreateTimestamp(currentPlanItems, historicPlanItems, 1000L);</span>
<span class="nc" id="L292">            assertThat(historicPlanItems.stream().filter(h -&gt; PlanItemDefinitionType.STAGE.equalsIgnoreCase(h.getPlanItemDefinitionType()))</span>
<span class="nc" id="L293">                .filter(h -&gt; PlanItemInstanceState.AVAILABLE.equalsIgnoreCase(h.getState()))</span>
<span class="nc bnc" id="L294" title="All 4 branches missed.">                .filter(h -&gt; h.getLastAvailableTime() != null &amp;&amp; h.getCreateTime().getTime() &lt;= h.getLastAvailableTime().getTime())</span>
<span class="nc" id="L295">                .count()).isEqualTo(1);</span>

            //QUERY FOR STAGES
<span class="nc" id="L298">            historicPlanItems = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L299">                .planItemInstanceDefinitionType(PlanItemDefinitionType.STAGE)</span>
<span class="nc" id="L300">                .planItemInstanceState(PlanItemInstanceState.AVAILABLE)</span>
<span class="nc" id="L301">                .list();</span>
<span class="nc" id="L302">            assertThat(historicPlanItems).hasSize(1);</span>
<span class="nc" id="L303">            historicPlanItems.forEach(h -&gt; {</span>
<span class="nc" id="L304">                assertThat(h.getLastAvailableTime()).isNotNull();</span>
<span class="nc" id="L305">                assertThat(h.getCreateTime().getTime()).isLessThanOrEqualTo(h.getLastAvailableTime().getTime());</span>
<span class="nc" id="L306">            });</span>

            //QUERY FOR USER_EVENT_LISTENERS
<span class="nc" id="L309">            historicPlanItems = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L310">                .planItemInstanceDefinitionType(PlanItemDefinitionType.USER_EVENT_LISTENER)</span>
<span class="nc" id="L311">                .planItemInstanceState(PlanItemInstanceState.AVAILABLE)</span>
<span class="nc" id="L312">                .list();</span>
<span class="nc" id="L313">            assertThat(historicPlanItems).hasSize(2);</span>
<span class="nc" id="L314">            historicPlanItems.forEach(h -&gt; {</span>
<span class="nc" id="L315">                assertThat(h.getLastAvailableTime()).isNotNull();</span>
<span class="nc" id="L316">                assertThat(h.getCreateTime().getTime()).isLessThanOrEqualTo(h.getLastAvailableTime().getTime());</span>
<span class="nc" id="L317">            });</span>
        }

        //Fulfill stages entryCriteria - keep date marks for query criteria

<span class="nc" id="L322">        Date occurredAfter = setClockFixedToCurrentTime();</span>
<span class="nc" id="L323">        forwardClock(TimeUnit.MINUTES.toMillis(1));</span>
<span class="nc" id="L324">        PlanItemInstance event = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceElementId(&quot;planItemStartStageOneEvent&quot;).singleResult();</span>
<span class="nc" id="L325">        cmmnRuntimeService.triggerPlanItemInstance(event.getId());</span>
<span class="nc" id="L326">        assertCaseInstanceNotEnded(caseInstance);</span>
<span class="nc" id="L327">        forwardClock(TimeUnit.MINUTES.toMillis(1));</span>
<span class="nc" id="L328">        Date occurredBefore = cmmnEngineConfiguration.getClock().getCurrentTime();</span>

        //A userEventListeners is removed and two human task are instanced
<span class="nc" id="L331">        currentPlanItems = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L332">        assertThat(currentPlanItems).hasSize(4);</span>

        //Two more planItemInstances in the history
<span class="nc bnc" id="L335" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L336">            List&lt;HistoricPlanItemInstance&gt; historicPlanItems = cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceCaseInstanceId(caseInstance.getId()).list();</span>
<span class="nc" id="L337">            assertThat(historicPlanItems).hasSize(5);</span>
<span class="nc" id="L338">            checkHistoryCreateTimestamp(currentPlanItems, historicPlanItems, 1000L);</span>

            //Both stages should be active now
<span class="nc" id="L341">            historicPlanItems = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L342">                .planItemInstanceDefinitionType(PlanItemDefinitionType.STAGE)</span>
<span class="nc" id="L343">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L344">                .list();</span>
<span class="nc" id="L345">            assertThat(historicPlanItems).hasSize(1);</span>
<span class="nc" id="L346">            historicPlanItems.forEach(h -&gt; {</span>
<span class="nc" id="L347">                assertThat(h.getLastStartedTime()).isNotNull();</span>
<span class="nc" id="L348">                assertThat(h.getCreateTime().getTime()).isLessThanOrEqualTo(h.getLastAvailableTime().getTime());</span>
<span class="nc" id="L349">                assertThat(h.getLastAvailableTime().getTime()).isLessThanOrEqualTo(h.getLastStartedTime().getTime());</span>
<span class="nc" id="L350">            });</span>

            //3 new Human Tasks
<span class="nc" id="L353">            historicPlanItems = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L354">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L355">                .planItemInstanceDefinitionType(PlanItemDefinitionType.HUMAN_TASK)</span>
<span class="nc" id="L356">                .list();</span>
<span class="nc" id="L357">            assertThat(historicPlanItems).hasSize(2);</span>
<span class="nc" id="L358">            historicPlanItems.forEach(h -&gt; {</span>
                //These are already started/active, but before that should also have available timestamp
<span class="nc" id="L360">                assertThat(h.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L361">                assertThat(h.getLastAvailableTime()).isNotNull();</span>
<span class="nc" id="L362">                assertThat(h.getLastStartedTime()).isNotNull();</span>
<span class="nc" id="L363">                assertThat(h.getCreateTime().getTime()).isLessThanOrEqualTo(h.getLastAvailableTime().getTime());</span>
<span class="nc" id="L364">                assertThat(h.getLastAvailableTime().getTime()).isLessThanOrEqualTo(h.getLastStartedTime().getTime());</span>
<span class="nc" id="L365">            });</span>

            //There should be 2 eventListeners the history, one of them &quot;occurred&quot; and is completed (user event listener plan item instance) and one should still be available
<span class="nc" id="L368">            historicPlanItems = cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceDefinitionType(PlanItemDefinitionType.USER_EVENT_LISTENER).list();</span>
<span class="nc" id="L369">            assertThat(</span>
<span class="nc" id="L370">                cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceDefinitionType(PlanItemDefinitionType.USER_EVENT_LISTENER).count())</span>
<span class="nc" id="L371">                .isEqualTo(2);</span>
<span class="nc" id="L372">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery().planItemInstanceDefinitionType(PlanItemDefinitionType.USER_EVENT_LISTENER)</span>
<span class="nc" id="L373">                .planItemInstanceState(PlanItemInstanceState.AVAILABLE).count()).isEqualTo(1);</span>
<span class="nc" id="L374">            historicPlanItems = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L375">                .planItemInstanceDefinitionType(PlanItemDefinitionType.USER_EVENT_LISTENER)</span>
<span class="nc" id="L376">                .occurredAfter(occurredAfter)</span>
<span class="nc" id="L377">                .occurredBefore(occurredBefore)</span>
<span class="nc" id="L378">                .list();</span>
<span class="nc" id="L379">            assertThat(historicPlanItems).hasSize(1);</span>
<span class="nc" id="L380">            historicPlanItems.forEach(h -&gt; {</span>
                //These are &quot;completed&quot; planItemInstance with occurred timestamp and ended timestamp
<span class="nc" id="L382">                assertThat(h.getState()).isEqualTo(PlanItemInstanceState.COMPLETED);</span>
<span class="nc" id="L383">                assertThat(h.getLastAvailableTime()).isNotNull();</span>
<span class="nc" id="L384">                assertThat(h.getOccurredTime()).isNotNull();</span>
<span class="nc" id="L385">                assertThat(h.getEndedTime()).isNotNull();</span>
<span class="nc" id="L386">                assertThat(h.getCreateTime().getTime()).isLessThanOrEqualTo(h.getLastAvailableTime().getTime());</span>
<span class="nc" id="L387">                assertThat(h.getLastAvailableTime().getTime()).isLessThanOrEqualTo(h.getOccurredTime().getTime());</span>
<span class="nc" id="L388">                assertThat(h.getOccurredTime().getTime()).isLessThanOrEqualTo(h.getEndedTime().getTime());</span>
<span class="nc" id="L389">            });</span>
        }

        //Complete one of the Tasks on stageOne
<span class="nc" id="L393">        Date completedAfter = cmmnEngineConfiguration.getClock().getCurrentTime();</span>
<span class="nc" id="L394">        forwardClock(TimeUnit.MINUTES.toMillis(1));</span>
<span class="nc" id="L395">        PlanItemInstance planItemTask = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceElementId(&quot;planItemTaskA&quot;).singleResult();</span>
<span class="nc" id="L396">        Task task = cmmnTaskService.createTaskQuery().subScopeId(planItemTask.getId()).singleResult();</span>
<span class="nc" id="L397">        cmmnTaskService.complete(task.getId());</span>
<span class="nc" id="L398">        forwardClock(TimeUnit.MINUTES.toMillis(1));</span>
<span class="nc" id="L399">        Date completedBefore = cmmnEngineConfiguration.getClock().getCurrentTime();</span>

        //one completed task, fetched with completeTime queryCriteria
<span class="nc bnc" id="L402" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L403">            HistoricPlanItemInstance historicPlanItem = cmmnHistoryService.createHistoricPlanItemInstanceQuery().completedBefore(completedBefore)</span>
<span class="nc" id="L404">                .completedAfter(completedAfter).singleResult();</span>
<span class="nc" id="L405">            assertThat(historicPlanItem).isNotNull();</span>
<span class="nc" id="L406">            assertThat(historicPlanItem.getElementId()).isEqualTo(&quot;planItemTaskA&quot;);</span>
<span class="nc" id="L407">            assertThat(historicPlanItem.getState()).isEqualTo(PlanItemInstanceState.COMPLETED);</span>
<span class="nc" id="L408">            assertThat(historicPlanItem.getLastAvailableTime()).isNotNull();</span>
<span class="nc" id="L409">            assertThat(historicPlanItem.getCompletedTime()).isNotNull();</span>
<span class="nc" id="L410">            assertThat(historicPlanItem.getEndedTime()).isNotNull();</span>
<span class="nc" id="L411">            assertThat(historicPlanItem.getCreateTime().getTime()).isLessThanOrEqualTo(historicPlanItem.getLastAvailableTime().getTime());</span>
<span class="nc" id="L412">            assertThat(historicPlanItem.getLastAvailableTime().getTime()).isLessThanOrEqualTo(historicPlanItem.getCompletedTime().getTime());</span>
<span class="nc" id="L413">            assertThat(historicPlanItem.getCompletedTime().getTime()).isLessThanOrEqualTo(historicPlanItem.getEndedTime().getTime());</span>

            // one task still active
<span class="nc" id="L416">            List&lt;HistoricPlanItemInstance&gt; historicPlanItems = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L417">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L418">                .planItemInstanceDefinitionType(PlanItemDefinitionType.HUMAN_TASK)</span>
<span class="nc" id="L419">                .list();</span>
<span class="nc" id="L420">            assertThat(historicPlanItems).hasSize(1);</span>
        }

        //Trigger exit criteria of stage one
<span class="nc" id="L424">        Date endedAfter = cmmnEngineConfiguration.getClock().getCurrentTime();</span>
<span class="nc" id="L425">        forwardClock(TimeUnit.MINUTES.toMillis(1));</span>
<span class="nc" id="L426">        event = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceElementId(&quot;planItemExitStageOneEvent&quot;).singleResult();</span>
<span class="nc" id="L427">        cmmnRuntimeService.triggerPlanItemInstance(event.getId());</span>
<span class="nc" id="L428">        forwardClock(TimeUnit.MINUTES.toMillis(1));</span>
<span class="nc" id="L429">        Date endedBefore = cmmnEngineConfiguration.getClock().getCurrentTime();</span>

        //Exit condition should have propagated to the remaining task
<span class="nc bnc" id="L432" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L433">            List&lt;HistoricPlanItemInstance&gt; historicPlanItems = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L434">                .exitBefore(endedBefore)</span>
<span class="nc" id="L435">                .exitAfter(endedAfter)</span>
<span class="nc" id="L436">                .list();</span>
            //The stage and the remaining containing task
<span class="nc" id="L438">            assertThat(historicPlanItems).hasSize(2);</span>
<span class="nc" id="L439">            assertThat(historicPlanItems.stream().anyMatch(h -&gt; PlanItemDefinitionType.STAGE.equalsIgnoreCase(h.getPlanItemDefinitionType()))).isTrue();</span>
<span class="nc" id="L440">            assertThat(historicPlanItems.stream().anyMatch(h -&gt; PlanItemDefinitionType.HUMAN_TASK.equalsIgnoreCase(h.getPlanItemDefinitionType()))).isTrue();</span>

<span class="nc" id="L442">            historicPlanItems.forEach(h -&gt; {</span>
<span class="nc" id="L443">                assertThat(h.getState()).isEqualTo(PlanItemInstanceState.TERMINATED);</span>
<span class="nc" id="L444">                assertThat(h.getLastAvailableTime()).isNotNull();</span>
<span class="nc" id="L445">                assertThat(h.getExitTime()).isNotNull();</span>
<span class="nc" id="L446">                assertThat(h.getEndedTime()).isNotNull();</span>
<span class="nc" id="L447">                assertThat(h.getCreateTime().getTime()).isLessThanOrEqualTo(h.getLastAvailableTime().getTime());</span>
<span class="nc" id="L448">                assertThat(h.getLastAvailableTime().getTime()).isLessThanOrEqualTo(h.getExitTime().getTime());</span>
<span class="nc" id="L449">                assertThat(h.getExitTime().getTime()).isLessThanOrEqualTo(h.getEndedTime().getTime());</span>
<span class="nc" id="L450">            });</span>
        }

<span class="nc" id="L453">        assertCaseInstanceEnded(caseInstance);</span>
<span class="nc" id="L454">    }</span>

    @Test
    @CmmnDeployment
    @SuppressWarnings(&quot;unchecked&quot;)
    public void testSimpleRepetitionHistory() {
<span class="nc" id="L460">        int totalRepetitions = 5;</span>
<span class="nc" id="L461">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L462">                .caseDefinitionKey(&quot;testSimpleRepetitionHistory&quot;)</span>
<span class="nc" id="L463">                .variable(&quot;totalRepetitions&quot;, totalRepetitions)</span>
<span class="nc" id="L464">                .start();</span>

<span class="nc bnc" id="L466" title="All 2 branches missed.">        for (int i = 1; i &lt;= totalRepetitions; i++) {</span>
<span class="nc" id="L467">            PlanItemInstance repeatingTaskPlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceElementId(&quot;repeatingTaskPlanItem&quot;)</span>
<span class="nc" id="L468">                    .singleResult();</span>
<span class="nc" id="L469">            assertThat(repeatingTaskPlanItemInstance).isNotNull();</span>
<span class="nc" id="L470">            assertThat(repeatingTaskPlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>

            //History Before task execution
<span class="nc bnc" id="L473" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L474">                List&lt;HistoricPlanItemInstance&gt; historyBefore = cmmnHistoryService.createHistoricPlanItemInstanceQuery().list();</span>
<span class="nc" id="L475">                Map&lt;String, List&lt;HistoricPlanItemInstance&gt;&gt; historyBeforeByState = historyBefore.stream()</span>
<span class="nc" id="L476">                    .collect(Collectors.groupingBy(HistoricPlanItemInstance::getState));</span>
<span class="nc" id="L477">                assertThat(historyBeforeByState.get(PlanItemInstanceState.ACTIVE)).hasSize(1);</span>
<span class="nc" id="L478">                assertThat(historyBeforeByState.getOrDefault(PlanItemInstanceState.COMPLETED, Collections.EMPTY_LIST)).hasSize(i - 1);</span>

                //Sanity check Active planItemInstance
<span class="nc" id="L481">                assertThat(historyBeforeByState.get(PlanItemInstanceState.ACTIVE).get(0).getId()).isEqualTo(repeatingTaskPlanItemInstance.getId());</span>
                //Sanity check repetition counter
<span class="nc" id="L483">                HistoricVariableInstance historicRepetitionCounter = cmmnHistoryService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L484">                    .planItemInstanceId(repeatingTaskPlanItemInstance.getId()).singleResult();</span>
<span class="nc" id="L485">                assertThat(historicRepetitionCounter).isNotNull();</span>
<span class="nc" id="L486">                assertThat(historicRepetitionCounter.getValue()).isEqualTo(i);</span>
            }

            //Execute the repetition
<span class="nc" id="L490">            Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).subScopeId(repeatingTaskPlanItemInstance.getId()).singleResult();</span>
<span class="nc" id="L491">            assertThat(task).isNotNull();</span>
<span class="nc" id="L492">            cmmnTaskService.complete(task.getId());</span>

            //History Before task execution
<span class="nc bnc" id="L495" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L496">                List&lt;HistoricPlanItemInstance&gt; historyAfter = cmmnHistoryService.createHistoricPlanItemInstanceQuery().list();</span>
<span class="nc" id="L497">                Map&lt;String, List&lt;HistoricPlanItemInstance&gt;&gt; historyAfterByState = historyAfter.stream()</span>
<span class="nc" id="L498">                    .collect(Collectors.groupingBy(HistoricPlanItemInstance::getState));</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">                assertThat(historyAfterByState.getOrDefault(PlanItemInstanceState.ACTIVE, Collections.EMPTY_LIST)).hasSize(i == totalRepetitions ? 0 : 1);</span>
<span class="nc" id="L500">                assertThat(historyAfterByState.getOrDefault(PlanItemInstanceState.COMPLETED, Collections.EMPTY_LIST)).hasSize(i);</span>
            }
        }

        //Check history in sequence
<span class="nc bnc" id="L505" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L506">            List&lt;HistoricPlanItemInstance&gt; history = cmmnHistoryService.createHistoricPlanItemInstanceQuery().list();</span>
<span class="nc" id="L507">            history.sort((o1, o2) -&gt; {</span>
<span class="nc" id="L508">                int order1 = (int) cmmnHistoryService.createHistoricVariableInstanceQuery().planItemInstanceId(o1.getId()).singleResult().getValue();</span>
<span class="nc" id="L509">                int order2 = (int) cmmnHistoryService.createHistoricVariableInstanceQuery().planItemInstanceId(o2.getId()).singleResult().getValue();</span>
<span class="nc" id="L510">                return Integer.compare(order1, order2);</span>
            });

<span class="nc" id="L513">            long previousCreateTime = 0L;</span>
<span class="nc" id="L514">            long previousActivateTime = 0L;</span>
<span class="nc" id="L515">            long previousEndTime = 0L;</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">            for (HistoricPlanItemInstance h : history) {</span>
<span class="nc" id="L517">                assertCreateTimeHistoricPlanItemInstance</span>
<span class="nc" id="L518">                    .andThen(assertStartedTimeHistoricPlanItemInstance)</span>
<span class="nc" id="L519">                    .andThen(assertEndedTimeHistoricPlanItemInstance)</span>
<span class="nc" id="L520">                    .andThen(assertEndStateHistoricPlanItemInstance)</span>
<span class="nc" id="L521">                    .accept(h);</span>
<span class="nc" id="L522">                assertThat(previousCreateTime).isLessThanOrEqualTo(h.getCreateTime().getTime());</span>
<span class="nc" id="L523">                assertThat(previousActivateTime).isLessThanOrEqualTo(h.getLastStartedTime().getTime());</span>
<span class="nc" id="L524">                assertThat(previousEndTime).isLessThanOrEqualTo(h.getEndedTime().getTime());</span>
<span class="nc" id="L525">                previousCreateTime = h.getCreateTime().getTime();</span>
<span class="nc" id="L526">                previousActivateTime = h.getLastStartedTime().getTime();</span>
<span class="nc" id="L527">                previousEndTime = h.getEndedTime().getTime();</span>
<span class="nc" id="L528">            }</span>
        }

<span class="nc" id="L531">        assertCaseInstanceEnded(caseInstance);</span>
<span class="nc" id="L532">    }</span>

    @Test
    @CmmnDeployment
    public void testQueryByUnavailableState() {
<span class="nc" id="L537">        Date startTime = Date.from(Instant.now().truncatedTo(ChronoUnit.SECONDS));</span>
<span class="nc" id="L538">        setClockTo(startTime);</span>

<span class="nc" id="L540">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testAvailableCondition&quot;).start();</span>

<span class="nc" id="L542">        PlanItemInstance eventListenerPlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L543">            .planItemDefinitionType(PlanItemDefinitionType.GENERIC_EVENT_LISTENER).singleResult();</span>
<span class="nc" id="L544">        assertThat(eventListenerPlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.UNAVAILABLE);</span>

<span class="nc" id="L546">        Task taskA = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L547">        cmmnTaskService.complete(taskA.getId());</span>
<span class="nc" id="L548">        cmmnRuntimeService.startPlanItemInstance(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult().getId());</span>

<span class="nc" id="L550">        eventListenerPlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L551">            .planItemDefinitionType(PlanItemDefinitionType.GENERIC_EVENT_LISTENER).singleResult();</span>
<span class="nc" id="L552">        assertThat(eventListenerPlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.UNAVAILABLE);</span>

<span class="nc bnc" id="L554" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L555">            assertThat(cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L556">                .planItemInstanceId(eventListenerPlanItemInstance.getId()).singleResult().getState()).isEqualTo(PlanItemInstanceState.UNAVAILABLE);</span>

<span class="nc" id="L558">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L559">                .planItemInstanceState(PlanItemInstanceState.UNAVAILABLE).list();</span>
<span class="nc" id="L560">            assertThat(historicPlanItemInstances).extracting(HistoricPlanItemInstance::getName).containsExactly(&quot;myEventListener&quot;);</span>
        }

<span class="nc" id="L563">        Date afterStartTime = new Date(startTime.getTime() + 10000L);</span>
<span class="nc" id="L564">        setClockTo(afterStartTime);</span>

        // UnavailableAfter

<span class="nc" id="L568">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastUnavailableAfter(startTime).list();</span>
<span class="nc" id="L569">        assertThat(planItemInstances).extracting(PlanItemInstance::getName).containsExactly(&quot;myEventListener&quot;);</span>

<span class="nc bnc" id="L571" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L572">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery().lastUnavailableAfter(startTime).list();</span>
<span class="nc" id="L573">            assertThat(historicPlanItemInstances).extracting(HistoricPlanItemInstance::getName).containsExactly(&quot;myEventListener&quot;);</span>
        }

<span class="nc" id="L576">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastUnavailableAfter(afterStartTime).list();</span>
<span class="nc" id="L577">        assertThat(planItemInstances).extracting(PlanItemInstance::getName).isEmpty();</span>

<span class="nc bnc" id="L579" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L580">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery().lastUnavailableAfter(afterStartTime).list();</span>
<span class="nc" id="L581">            assertThat(historicPlanItemInstances).extracting(HistoricPlanItemInstance::getName).isEmpty();</span>
        }

        // UnavailableBefore
<span class="nc" id="L585">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastUnavailableBefore(afterStartTime).list();</span>
<span class="nc" id="L586">        assertThat(planItemInstances).extracting(PlanItemInstance::getName).containsExactly(&quot;myEventListener&quot;);</span>

<span class="nc bnc" id="L588" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L589">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery().lastUnavailableBefore(afterStartTime).list();</span>
<span class="nc" id="L590">            assertThat(historicPlanItemInstances).extracting(HistoricPlanItemInstance::getName).containsExactly(&quot;myEventListener&quot;);</span>
        }

<span class="nc" id="L593">        Date beforeStartTime = new Date(startTime.getTime() - 10000);</span>
<span class="nc" id="L594">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastUnavailableBefore(beforeStartTime).list();</span>
<span class="nc" id="L595">        assertThat(planItemInstances).extracting(PlanItemInstance::getName).isEmpty();</span>

<span class="nc bnc" id="L597" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L598">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery().lastUnavailableBefore(beforeStartTime).list();</span>
<span class="nc" id="L599">            assertThat(historicPlanItemInstances).extracting(HistoricPlanItemInstance::getName).isEmpty();</span>
        }
<span class="nc" id="L601">    }</span>

    private List&lt;String&gt; getIdsOfNonWaitingPlanItemInstances(List&lt;PlanItemInstance&gt; currentPlanItems) {
<span class="nc" id="L604">        return currentPlanItems.stream()</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">                .filter(p -&gt; !PlanItemInstanceState.AVAILABLE.equals(p.getState()))</span>
<span class="nc" id="L606">                .map(PlanItemInstance::getId)</span>
<span class="nc" id="L607">                .collect(Collectors.toList());</span>
    }

    private void checkHistoryCreateTimestamp(final List&lt;PlanItemInstance&gt; currentPlanItems, final List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances,
            long threshold) {
<span class="nc" id="L612">        currentPlanItems.forEach(p -&gt; {</span>
<span class="nc" id="L613">            Optional&lt;Long&gt; createTimestamp = historicPlanItemInstances.stream()</span>
<span class="nc" id="L614">                    .filter(h -&gt; h.getId().equals(p.getId()))</span>
<span class="nc" id="L615">                    .findFirst()</span>
<span class="nc" id="L616">                    .map(HistoricPlanItemInstance::getCreateTime)</span>
<span class="nc" id="L617">                    .map(Date::getTime);</span>
<span class="nc" id="L618">            assertThat(createTimestamp).isPresent();</span>
<span class="nc" id="L619">            long delta = createTimestamp.orElse(Long.MAX_VALUE) - p.getCreateTime().getTime();</span>
<span class="nc" id="L620">            assertThat(delta).isLessThanOrEqualTo(threshold);</span>
<span class="nc" id="L621">        });</span>
<span class="nc" id="L622">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>