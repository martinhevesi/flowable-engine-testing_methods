<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TerminateEndEventTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.bpmn.event.end</a> &gt; <span class="el_source">TerminateEndEventTest.java</span></div><h1>TerminateEndEventTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.engine.test.bpmn.event.end;

import static org.assertj.core.api.Assertions.assertThat;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.flowable.bpmn.model.BpmnModel;
import org.flowable.bpmn.model.EndEvent;
import org.flowable.bpmn.model.ExtensionAttribute;
import org.flowable.bpmn.model.ExtensionElement;
import org.flowable.common.engine.api.delegate.event.FlowableEngineEventType;
import org.flowable.common.engine.api.delegate.event.FlowableEvent;
import org.flowable.common.engine.api.delegate.event.FlowableEventType;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.engine.delegate.DelegateExecution;
import org.flowable.engine.delegate.JavaDelegate;
import org.flowable.engine.delegate.event.AbstractFlowableEngineEventListener;
import org.flowable.engine.history.DeleteReason;
import org.flowable.engine.history.HistoricActivityInstance;
import org.flowable.engine.history.HistoricProcessInstance;
import org.flowable.engine.impl.context.Context;
import org.flowable.engine.impl.test.HistoryTestHelper;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.repository.ProcessDefinition;
import org.flowable.engine.runtime.Execution;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.task.api.Task;
import org.flowable.task.api.history.HistoricTaskInstance;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

/**
 * @author Nico Rehwaldt
 * @author Joram Barrez
 */
<span class="nc" id="L54">public class TerminateEndEventTest extends PluggableFlowableTestCase {</span>

    public static int serviceTaskInvokedCount;

    @BeforeEach
    protected void setUp() throws Exception {
<span class="nc" id="L60">        serviceTaskInvokedCount = 0;</span>
<span class="nc" id="L61">        serviceTaskInvokedCount2 = 0;</span>
<span class="nc" id="L62">    }</span>

<span class="nc" id="L64">    public static class CountDelegate implements JavaDelegate {</span>

        @Override
        public void execute(DelegateExecution execution) {
<span class="nc" id="L68">            serviceTaskInvokedCount++;</span>

            // leave only 3 out of n subprocesses
<span class="nc bnc" id="L71" title="All 2 branches missed.">            execution.setVariableLocal(&quot;terminate&quot;, serviceTaskInvokedCount &gt; 3);</span>
<span class="nc" id="L72">        }</span>
    }

    public static int serviceTaskInvokedCount2;

<span class="nc" id="L77">    public static class CountDelegate2 implements JavaDelegate {</span>

        @Override
        public void execute(DelegateExecution execution) {
<span class="nc" id="L81">            serviceTaskInvokedCount2++;</span>
<span class="nc" id="L82">        }</span>
    }

    @Test
    @Deployment
    public void testProcessTerminate() throws Exception {
<span class="nc" id="L88">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

<span class="nc" id="L90">        long executionEntities = runtimeService.createExecutionQuery().processInstanceId(pi.getId()).count();</span>
<span class="nc" id="L91">        assertThat(executionEntities).isEqualTo(3);</span>

<span class="nc" id="L93">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preTerminateTask&quot;).singleResult();</span>
<span class="nc" id="L94">        taskService.complete(task.getId());</span>

<span class="nc" id="L96">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L97">        assertHistoricProcessInstanceDetails(pi);</span>

<span class="nc" id="L99">        assertHistoricProcessInstanceDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT);</span>
<span class="nc" id="L100">        assertHistoricTasksDeleteReason(pi, null, &quot;check before termination&quot;);</span>
<span class="nc" id="L101">        assertHistoricTasksDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT, &quot;check before end&quot;);</span>
<span class="nc" id="L102">        assertHistoricActivitiesDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT, &quot;preNormalTerminateTask&quot;);</span>
<span class="nc" id="L103">        assertHistoricActivitiesDeleteReason(pi, null, &quot;preTerminateTask&quot;);</span>
<span class="nc" id="L104">    }</span>
    
    @Test
    @Deployment
    public void testTerminateExecutionListener() throws Exception {
<span class="nc" id="L109">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

<span class="nc" id="L111">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preTerminateTask&quot;).singleResult();</span>
<span class="nc" id="L112">        taskService.complete(task.getId());</span>

<span class="nc" id="L114">        assertProcessEnded(pi.getId());</span>
        
<span class="nc" id="L116">        assertThat(TerminateExecutionListener.startCalled).isEqualTo(1);</span>
<span class="nc" id="L117">        assertThat(TerminateExecutionListener.endCalled).isEqualTo(1);</span>
<span class="nc" id="L118">    }</span>

    @Test
    @Deployment
    public void testProcessTerminateAll() throws Exception {
<span class="nc" id="L123">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

<span class="nc" id="L125">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preTerminateTask&quot;).singleResult();</span>
<span class="nc" id="L126">        taskService.complete(task.getId());</span>

<span class="nc" id="L128">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L129">        assertHistoricProcessInstanceDetails(pi);</span>

<span class="nc" id="L131">        assertHistoricProcessInstanceDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT);</span>
<span class="nc" id="L132">        assertHistoricTasksDeleteReason(pi, null, &quot;check before termination&quot;);</span>
<span class="nc" id="L133">        assertHistoricTasksDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT, &quot;check before end&quot;);</span>
<span class="nc" id="L134">        assertHistoricActivitiesDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT, &quot;preNormalTerminateTask&quot;);</span>
<span class="nc" id="L135">        assertHistoricActivitiesDeleteReason(pi, null, &quot;preTerminateTask&quot;);</span>
<span class="nc" id="L136">    }</span>

    @Test
    @Deployment
    public void testTerminateWithSubProcess() throws Exception {
<span class="nc" id="L141">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

        // should terminate the process and
<span class="nc" id="L144">        long executionEntities = runtimeService.createExecutionQuery().processInstanceId(pi.getId()).count();</span>
<span class="nc" id="L145">        assertThat(executionEntities).isEqualTo(4);</span>

<span class="nc" id="L147">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preTerminateEnd&quot;).singleResult();</span>
<span class="nc" id="L148">        taskService.complete(task.getId());</span>

<span class="nc" id="L150">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L151">        assertHistoricProcessInstanceDetails(pi);</span>

<span class="nc" id="L153">        assertHistoricProcessInstanceDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT);</span>
<span class="nc" id="L154">        assertHistoricTasksDeleteReason(pi, null, &quot;check before termination&quot;);</span>
<span class="nc" id="L155">        assertHistoricTasksDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT, &quot;check before end&quot;);</span>
<span class="nc" id="L156">        assertHistoricActivitiesDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT, &quot;preNormalEnd&quot;);</span>
<span class="nc" id="L157">        assertHistoricActivitiesDeleteReason(pi, null, &quot;preTerminateEnd&quot;);</span>
<span class="nc" id="L158">    }</span>

    @Test
    @Deployment
    public void testTerminateWithSubProcess2() throws Exception {
<span class="nc" id="L163">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

        // Completing the task -&gt; terminal end event -&gt; subprocess ends
<span class="nc" id="L166">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preNormalEnd&quot;).singleResult();</span>
<span class="nc" id="L167">        taskService.complete(task.getId());</span>

<span class="nc" id="L169">        task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preTerminateEnd&quot;).singleResult();</span>
<span class="nc" id="L170">        assertThat(task).isNotNull();</span>
<span class="nc" id="L171">        taskService.complete(task.getId());</span>

<span class="nc" id="L173">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L174">        assertHistoricProcessInstanceDetails(pi);</span>

<span class="nc" id="L176">        assertHistoricProcessInstanceDeleteReason(pi, null);</span>
<span class="nc" id="L177">        assertHistoricTasksDeleteReason(pi, null, &quot;check before termination&quot;, &quot;check before end&quot;);</span>
<span class="nc" id="L178">        assertHistoricActivitiesDeleteReason(pi, null, &quot;preNormalEnd&quot;, &quot;preTerminateEnd&quot;);</span>
<span class="nc" id="L179">        assertHistoricActivitiesDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT, &quot;SubProcess_1&quot;);</span>
<span class="nc" id="L180">    }</span>

    @Test
    @Deployment
    public void testTerminateWithSubProcessTerminateAll() throws Exception {
<span class="nc" id="L185">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

        // Completing the task -&gt; terminal end event -&gt; all ends (terminate all)
<span class="nc" id="L188">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preNormalEnd&quot;).singleResult();</span>
<span class="nc" id="L189">        taskService.complete(task.getId());</span>

<span class="nc" id="L191">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L192">        assertHistoricProcessInstanceDetails(pi);</span>

<span class="nc" id="L194">        assertHistoricProcessInstanceDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT);</span>
<span class="nc" id="L195">        assertHistoricTasksDeleteReason(pi, null, &quot;check before end&quot;);</span>
<span class="nc" id="L196">        assertHistoricTasksDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT, &quot;check before termination&quot;);</span>
<span class="nc" id="L197">        assertHistoricActivitiesDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT, &quot;preTerminateEnd&quot;);</span>
<span class="nc" id="L198">        assertHistoricActivitiesDeleteReason(pi, null, &quot;preNormalEnd&quot;);</span>
<span class="nc" id="L199">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.testTerminateWithCallActivity.bpmn&quot;,
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.subProcessNoTerminate.bpmn&quot;
    })
    public void testTerminateWithCallActivity() throws Exception {
<span class="nc" id="L207">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

<span class="nc" id="L209">        ProcessInstance subProcessInstance = runtimeService.createProcessInstanceQuery().superProcessInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L210">        assertThat(subProcessInstance).isNotNull();</span>

<span class="nc" id="L212">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preTerminateEnd&quot;).singleResult();</span>
<span class="nc" id="L213">        taskService.complete(task.getId());</span>

<span class="nc" id="L215">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L216">        assertHistoricProcessInstanceDetails(pi);</span>

<span class="nc" id="L218">        assertHistoricProcessInstanceDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT);</span>
<span class="nc" id="L219">        assertHistoricTasksDeleteReason(pi, null, &quot;check before termination&quot;);</span>
<span class="nc" id="L220">        assertHistoricTasksDeleteReason(subProcessInstance, DeleteReason.TERMINATE_END_EVENT, &quot;Perform Sample&quot;);</span>
<span class="nc" id="L221">        assertHistoricActivitiesDeleteReason(pi, null, &quot;preTerminateEnd&quot;);</span>
<span class="nc" id="L222">        assertHistoricActivitiesDeleteReason(subProcessInstance, DeleteReason.TERMINATE_END_EVENT, &quot;task&quot;);</span>
<span class="nc" id="L223">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.testTerminateWithCallActivityTerminateAll.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.subProcessNoTerminate.bpmn&quot; })
    public void testTerminateWithCallActivityTerminateAll() throws Exception {
<span class="nc" id="L230">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

<span class="nc" id="L232">        ProcessInstance subProcessInstance = runtimeService.createProcessInstanceQuery().superProcessInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L233">        assertThat(subProcessInstance).isNotNull();</span>

<span class="nc" id="L235">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId())</span>
<span class="nc" id="L236">                .taskDefinitionKey(&quot;preTerminateEnd&quot;).singleResult();</span>
<span class="nc" id="L237">        taskService.complete(task.getId());</span>

<span class="nc" id="L239">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L240">        assertHistoricProcessInstanceDetails(pi);</span>

<span class="nc" id="L242">        assertHistoricProcessInstanceDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT);</span>
<span class="nc" id="L243">        assertHistoricTasksDeleteReason(pi, null, &quot;check before termination&quot;);</span>
<span class="nc" id="L244">        assertHistoricTasksDeleteReason(subProcessInstance, DeleteReason.TERMINATE_END_EVENT, &quot;Perform Sample&quot;);</span>
<span class="nc" id="L245">        assertHistoricActivitiesDeleteReason(pi, null, &quot;preTerminateEnd&quot;);</span>
<span class="nc" id="L246">        assertHistoricActivitiesDeleteReason(subProcessInstance, DeleteReason.TERMINATE_END_EVENT, &quot;task&quot;);</span>
<span class="nc" id="L247">    }</span>
    
    @Test
    @Deployment
    public void testTerminateInEventSubProcess() throws Exception {
<span class="nc" id="L252">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminate&quot;);</span>

<span class="nc" id="L254">        Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;task&quot;).singleResult();</span>
<span class="nc" id="L255">        assertThat(task).isNotNull();</span>
        
<span class="nc" id="L257">        runtimeService.signalEventReceived(&quot;signal&quot;);</span>

<span class="nc" id="L259">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L260">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.testTerminateInExclusiveGatewayWithCallActivity.bpmn&quot;,
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.subProcessNoTerminate.bpmn&quot;
    })
    public void testTerminateInExclusiveGatewayWithCallActivity() throws Exception {
<span class="nc" id="L268">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample-terminateAfterExclusiveGateway&quot;);</span>

<span class="nc" id="L270">        ProcessInstance subProcessInstance = runtimeService.createProcessInstanceQuery().superProcessInstanceId(pi.getId()).singleResult();</span>
<span class="nc" id="L271">        assertThat(subProcessInstance).isNotNull();</span>

<span class="nc" id="L273">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preTerminateEnd&quot;).singleResult();</span>
<span class="nc" id="L274">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L275">        variables.put(&quot;input&quot;, 1);</span>
<span class="nc" id="L276">        taskService.complete(task.getId(), variables);</span>

<span class="nc" id="L278">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L279">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L280">    }</span>

    @Test
    @Deployment
    public void testTerminateInExclusiveGatewayWithMultiInstanceSubProcess() throws Exception {
<span class="nc" id="L285">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample-terminateAfterExclusiveGateway&quot;);</span>

<span class="nc" id="L287">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preTerminateEnd&quot;).singleResult();</span>
<span class="nc" id="L288">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L289">        variables.put(&quot;input&quot;, 1);</span>
<span class="nc" id="L290">        taskService.complete(task.getId(), variables);</span>

<span class="nc" id="L292">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L293">        assertHistoricProcessInstanceDetails(pi);</span>

<span class="nc" id="L295">        assertHistoricProcessInstanceDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT);</span>
<span class="nc" id="L296">        assertHistoricTasksDeleteReason(pi, null, &quot;check before termination&quot;);</span>
<span class="nc" id="L297">        assertHistoricTasksDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT, &quot;User Task&quot;);</span>
<span class="nc" id="L298">        assertHistoricActivitiesDeleteReason(pi, null, &quot;preTerminateEnd&quot;);</span>
<span class="nc" id="L299">        assertHistoricActivitiesDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT, &quot;task&quot;);</span>
<span class="nc" id="L300">    }</span>

    @Test
    @Deployment
    public void testTerminateInExclusiveGatewayWithMultiInstanceSubProcessTerminateAll() throws Exception {
<span class="nc" id="L305">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample-terminateAfterExclusiveGateway&quot;);</span>

        // Completing the task once should only destroy ONE multi instance
<span class="nc" id="L308">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;task&quot;).list();</span>
<span class="nc" id="L309">        assertThat(tasks).hasSize(5);</span>

<span class="nc bnc" id="L311" title="All 2 branches missed.">        for (int i = 0; i &lt; 5; i++) {</span>
<span class="nc" id="L312">            taskService.complete(tasks.get(i).getId());</span>
<span class="nc" id="L313">            assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(pi.getId()).count()).isGreaterThan(0);</span>
        }

        // Other task will now finish the process instance
<span class="nc" id="L317">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preTerminateEnd&quot;).singleResult();</span>
<span class="nc" id="L318">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L319">        variables.put(&quot;input&quot;, 1);</span>
<span class="nc" id="L320">        taskService.complete(task.getId(), variables);</span>

<span class="nc" id="L322">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(pi.getId()).count()).isZero();</span>
<span class="nc" id="L323">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L324">    }</span>
    
    @Test
    @Deployment
    public void testTerminateParallelGateway() throws Exception {
<span class="nc" id="L329">        final List&lt;FlowableEventType&gt; events = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L330">        processEngine.getRuntimeService().addEventListener(new AbstractFlowableEngineEventListener() {</span>
            
            @Override
            public void onEvent(FlowableEvent event) {
<span class="nc bnc" id="L334" title="All 4 branches missed.">                if (FlowableEngineEventType.PROCESS_COMPLETED_WITH_TERMINATE_END_EVENT == event.getType() || FlowableEngineEventType.TASK_CREATED == event.getType()) {</span>
<span class="nc" id="L335">                    events.add(event.getType());</span>
                }
                
<span class="nc bnc" id="L338" title="All 2 branches missed.">                if (FlowableEngineEventType.ACTIVITY_CANCELLED == event.getType()) {</span>
<span class="nc" id="L339">                    List&lt;org.flowable.task.api.Task&gt; list = Context.getProcessEngineConfiguration().getTaskService().createTaskQuery().list();</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">                    if (!list.isEmpty()) {</span>
<span class="nc" id="L341">                        events.add(event.getType());</span>
                    }
                }
<span class="nc" id="L344">            }</span>
            
            @Override
            public boolean isFailOnException() {
<span class="nc" id="L348">                return false;</span>
            }
        });
<span class="nc" id="L351">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateParallel&quot;);</span>
<span class="nc" id="L352">        assertThat(events)</span>
<span class="nc" id="L353">                .contains(FlowableEngineEventType.PROCESS_COMPLETED_WITH_TERMINATE_END_EVENT);</span>
        
<span class="nc" id="L355">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L356">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L357">    }</span>

    @Test
    @Deployment
    public void testTerminateInSubProcess() throws Exception {
<span class="nc" id="L362">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

        // should terminate the subprocess and continue the parent
<span class="nc" id="L365">        long executionEntities = runtimeService.createExecutionQuery().processInstanceId(pi.getId()).count();</span>
<span class="nc" id="L366">        assertThat(executionEntities).isGreaterThan(0);</span>

<span class="nc" id="L368">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preNormalEnd&quot;).singleResult();</span>
<span class="nc" id="L369">        taskService.complete(task.getId());</span>

<span class="nc" id="L371">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L372">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L373">    }</span>

    @Test
    @Deployment
    public void testTerminateInSubProcessTerminateAll() throws Exception {
<span class="nc" id="L378">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>
<span class="nc" id="L379">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L380">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L381">    }</span>

    @Test
    @Deployment
    public void testTerminateInSubProcessWithBoundary() throws Exception {
<span class="nc" id="L386">        Date startTime = new Date();</span>

        // Test terminating process via boundary timer

<span class="nc" id="L390">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventWithBoundary&quot;);</span>

<span class="nc" id="L392">        assertThat(taskService.createTaskQuery().processInstanceId(pi.getId()).count()).isEqualTo(3);</span>

        // Set clock time to '1 hour and 5 seconds' ahead to fire timer
<span class="nc" id="L395">        processEngineConfiguration.getClock().setCurrentTime(new Date(startTime.getTime() + ((60 * 60 * 1000) + 5000)));</span>
<span class="nc" id="L396">        waitForJobExecutorToProcessAllJobsAndExecutableTimerJobs(7000L, 25L);</span>

        // timer has fired
<span class="nc" id="L399">        assertThat(managementService.createJobQuery().count()).isZero();</span>

<span class="nc" id="L401">        assertProcessEnded(pi.getId());</span>

<span class="nc" id="L403">        assertHistoricProcessInstanceDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT);</span>
<span class="nc" id="L404">        assertHistoricTasksDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT, &quot;check before normal end&quot;);</span>
<span class="nc" id="L405">        assertHistoricActivitiesDeleteReason(pi, DeleteReason.TERMINATE_END_EVENT, &quot;outerTask&quot;);</span>

        // Test terminating subprocess

<span class="nc" id="L409">        pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventWithBoundary&quot;);</span>

<span class="nc" id="L411">        assertThat(taskService.createTaskQuery().processInstanceId(pi.getId()).count()).isEqualTo(3);</span>

        // a job for boundary event timer should exist
<span class="nc" id="L414">        assertThat(managementService.createTimerJobQuery().count()).isEqualTo(1L);</span>

        // Complete sub process task that leads to a terminate end event
<span class="nc" id="L417">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preTermInnerTask&quot;).singleResult();</span>
<span class="nc" id="L418">        taskService.complete(task.getId());</span>

        // 'preEndInnerTask' task in subprocess should have been terminated, only outerTask should exist
<span class="nc" id="L421">        assertThat(taskService.createTaskQuery().processInstanceId(pi.getId()).count()).isEqualTo(1);</span>

        // job for boundary event timer should have been removed
<span class="nc" id="L424">        assertThat(managementService.createTimerJobQuery().count()).isZero();</span>

        // complete outerTask
<span class="nc" id="L427">        task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;outerTask&quot;).singleResult();</span>
<span class="nc" id="L428">        taskService.complete(task.getId());</span>
        
<span class="nc" id="L430">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L431">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L432">    }</span>

    @Test
    @Deployment
    public void testTerminateInSubProcessWithBoundaryTerminateAll() throws Exception {
        // Test terminating subprocess

<span class="nc" id="L439">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventWithBoundary&quot;);</span>

<span class="nc" id="L441">        assertThat(taskService.createTaskQuery().processInstanceId(pi.getId()).count()).isEqualTo(3);</span>

        // Complete sub process task that leads to a terminate end event
<span class="nc" id="L444">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preTermInnerTask&quot;).singleResult();</span>
<span class="nc" id="L445">        taskService.complete(task.getId());</span>

<span class="nc" id="L447">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L448">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L449">    }</span>

    @Test
    @Deployment
    public void testTerminateInSubProcessConcurrent() throws Exception {
<span class="nc" id="L454">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

<span class="nc" id="L456">        long executionEntities = runtimeService.createExecutionQuery().count();</span>
<span class="nc" id="L457">        assertThat(executionEntities).isGreaterThan(0);</span>

<span class="nc" id="L459">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preNormalEnd&quot;).singleResult();</span>
<span class="nc" id="L460">        taskService.complete(task.getId());</span>

<span class="nc" id="L462">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L463">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L464">    }</span>

    @Test
    @Deployment
    public void testTerminateInSubProcessConcurrentTerminateAll() throws Exception {
<span class="nc" id="L469">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>
<span class="nc" id="L470">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L471">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L472">    }</span>

    @Test
    @Deployment
    public void testTerminateInSubProcessConcurrentTerminateAll2() throws Exception {
<span class="nc" id="L477">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

<span class="nc" id="L479">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(pi.getId()).list();</span>
<span class="nc" id="L480">        assertThat(tasks).hasSize(2);</span>

<span class="nc" id="L482">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskName(&quot;User Task&quot;).singleResult();</span>
<span class="nc" id="L483">        taskService.complete(task.getId());</span>

<span class="nc" id="L485">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L486">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L487">    }</span>

    @Test
    @Deployment
    public void testTerminateInSubProcessConcurrentMultiInstance() throws Exception {
<span class="nc" id="L492">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

<span class="nc" id="L494">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(pi.getId()).list();</span>
<span class="nc" id="L495">        assertThat(tasks).hasSize(4); // 3 user tasks in MI +1 (preNormalEnd) = 4 (2 were killed because it went directly to the terminate end event)</span>

<span class="nc" id="L497">        long executionEntitiesCount = runtimeService.createExecutionQuery().count();</span>
<span class="nc" id="L498">        assertThat(executionEntitiesCount).isEqualTo(9);</span>

<span class="nc" id="L500">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preNormalEnd&quot;).singleResult();</span>
<span class="nc" id="L501">        taskService.complete(task.getId());</span>

<span class="nc" id="L503">        executionEntitiesCount = runtimeService.createExecutionQuery().count();</span>
<span class="nc" id="L504">        assertThat(executionEntitiesCount).isEqualTo(8);</span>

<span class="nc" id="L506">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">        for (org.flowable.task.api.Task t : tasks) {</span>
<span class="nc" id="L508">            taskService.complete(t.getId());</span>
<span class="nc" id="L509">        }</span>

<span class="nc" id="L511">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L512">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L513">    }</span>

    @Test
    @Deployment
    public void testTerminateInSubProcessConcurrentMultiInstance2() throws Exception {
<span class="nc" id="L518">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

<span class="nc" id="L520">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preNormalEnd&quot;).singleResult();</span>
<span class="nc" id="L521">        taskService.complete(task.getId());</span>

<span class="nc" id="L523">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(pi.getId()).taskName(&quot;User Task&quot;).list();</span>
<span class="nc" id="L524">        assertThat(tasks).hasSize(3);</span>

<span class="nc bnc" id="L526" title="All 2 branches missed.">        for (org.flowable.task.api.Task t : tasks) {</span>
<span class="nc" id="L527">            taskService.complete(t.getId());</span>
<span class="nc" id="L528">        }</span>

<span class="nc" id="L530">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L531">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L532">    }</span>

    @Test
    @Deployment
    public void testTerminateInSubProcessConcurrentMultiInstanceTerminateAll() throws Exception {
<span class="nc" id="L537">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>
<span class="nc" id="L538">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L539">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L540">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.testTerminateInCallActivityConcurrentCallActivity.bpmn&quot;,
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.testTerminateAfterUserTask.bpmn&quot;,
            &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testTerminateInCallActivityConcurrentCallActivity() throws Exception {
        // GIVEN - process instance starts and creates 2 subProcessInstances (with 2 user tasks - preTerminate and my task)
<span class="nc" id="L548">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventInCallActivityConcurrentCallActivity&quot;);</span>
<span class="nc" id="L549">        assertThat(runtimeService.createProcessInstanceQuery().superProcessInstanceId(pi.getId()).list()).hasSize(2);</span>

        // WHEN - complete -&gt; terminate end event
<span class="nc" id="L552">        org.flowable.task.api.Task preTerminate = taskService.createTaskQuery().taskName(&quot;preTerminate&quot;).singleResult();</span>
<span class="nc" id="L553">        taskService.complete(preTerminate.getId());</span>

        // THEN - super process is not finished together
<span class="nc" id="L556">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(pi.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L557">    }</span>

    @Test
    @Deployment
    public void testTerminateInSubProcessMultiInstance() throws Exception {
<span class="nc" id="L562">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

<span class="nc" id="L564">        long executionEntities = runtimeService.createExecutionQuery().count();</span>
<span class="nc" id="L565">        assertThat(executionEntities).isGreaterThan(0);</span>

<span class="nc" id="L567">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preNormalEnd&quot;).singleResult();</span>
<span class="nc" id="L568">        taskService.complete(task.getId());</span>

<span class="nc" id="L570">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L571">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L572">    }</span>

    @Test
    @Deployment
    public void testTerminateInSubProcessSequentialConcurrentMultiInstance() throws Exception {

        // Starting multi instance with 5 instances; terminating 2, finishing 3
<span class="nc" id="L579">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

<span class="nc" id="L581">        long remainingExecutions = runtimeService.createExecutionQuery().count();</span>
<span class="nc" id="L582">        assertThat(remainingExecutions).isGreaterThan(0);</span>

        // three finished
<span class="nc" id="L585">        assertThat(serviceTaskInvokedCount2).isEqualTo(3);</span>

<span class="nc" id="L587">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preNormalEnd&quot;).singleResult();</span>
<span class="nc" id="L588">        taskService.complete(task.getId());</span>

        // last task remaining
<span class="nc" id="L591">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L592">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L593">    }</span>

    @Test
    @Deployment
    public void testTerminateInSubProcessSequentialConcurrentMultiInstanceTerminateAll() throws Exception {
<span class="nc" id="L598">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>
<span class="nc" id="L599">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L600">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L601">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.testTerminateInCallActivity.bpmn&quot;,
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.subProcessTerminate.bpmn&quot;
    })
    public void testTerminateInCallActivity() throws Exception {
<span class="nc" id="L609">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

        // should terminate the called process and continue the parent
<span class="nc" id="L612">        long executionEntities = runtimeService.createExecutionQuery().count();</span>
<span class="nc" id="L613">        assertThat(executionEntities).isGreaterThan(0);</span>

<span class="nc" id="L615">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preNormalEnd&quot;).singleResult();</span>
<span class="nc" id="L616">        taskService.complete(task.getId());</span>

<span class="nc" id="L618">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L619">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L620">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.testTerminateInCallActivityMulitInstance.bpmn&quot;,
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.subProcessTerminate.bpmn&quot;
    })
    public void testTerminateInCallActivityMultiInstance() throws Exception {
<span class="nc" id="L628">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

        // should terminate the called process and continue the parent
<span class="nc" id="L631">        long executionEntities = runtimeService.createExecutionQuery().count();</span>
<span class="nc" id="L632">        assertThat(executionEntities).isGreaterThan(0);</span>

<span class="nc" id="L634">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preNormalEnd&quot;).singleResult();</span>
<span class="nc" id="L635">        taskService.complete(task.getId());</span>

<span class="nc" id="L637">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L638">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L639">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.testTerminateInCallActivityMulitInstance.bpmn&quot;,
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.subProcessTerminateTerminateAll.bpmn20.xml&quot; })
    public void testTerminateInCallActivityMultiInstanceTerminateAll() throws Exception {
<span class="nc" id="L646">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>
<span class="nc" id="L647">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L648">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L649">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.testTerminateInCallActivityConcurrent.bpmn&quot;,
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.subProcessConcurrentTerminate.bpmn&quot;
    })
    public void testTerminateInCallActivityConcurrent() throws Exception {
<span class="nc" id="L657">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

        // should terminate the called process and continue the parent
<span class="nc" id="L660">        long executionEntities = runtimeService.createExecutionQuery().count();</span>
<span class="nc" id="L661">        assertThat(executionEntities).isGreaterThan(0);</span>

<span class="nc" id="L663">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preNormalEnd&quot;).singleResult();</span>
<span class="nc" id="L664">        taskService.complete(task.getId());</span>

<span class="nc" id="L666">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L667">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L668">    }</span>

    @Test
    @Deployment
    public void testMiCallActivityParallel() {
<span class="nc" id="L673">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;testMiCallActivity&quot;);</span>

<span class="nc" id="L675">        List&lt;org.flowable.task.api.Task&gt; aTasks = taskService.createTaskQuery().taskName(&quot;A&quot;).list();</span>
<span class="nc" id="L676">        assertThat(aTasks).hasSize(5);</span>

<span class="nc" id="L678">        List&lt;org.flowable.task.api.Task&gt; bTasks = taskService.createTaskQuery().taskName(&quot;B&quot;).list();</span>
<span class="nc" id="L679">        assertThat(bTasks).hasSize(5);</span>

        // Completing B should terminate one instance (it goes to a terminate end event)
<span class="nc" id="L682">        int bTasksCompleted = 0;</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">        for (org.flowable.task.api.Task bTask : bTasks) {</span>

<span class="nc" id="L685">            taskService.complete(bTask.getId());</span>
<span class="nc" id="L686">            bTasksCompleted++;</span>

<span class="nc" id="L688">            aTasks = taskService.createTaskQuery().taskName(&quot;A&quot;).list();</span>
<span class="nc" id="L689">            assertThat(aTasks).hasSize(5 - bTasksCompleted);</span>
<span class="nc" id="L690">        }</span>

<span class="nc" id="L692">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L693">        assertThat(task.getName()).isEqualTo(&quot;After call activity&quot;);</span>

<span class="nc" id="L695">        taskService.complete(task.getId());</span>
        
<span class="nc" id="L697">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>
        
<span class="nc" id="L699">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L700">        assertHistoricProcessInstanceDetails(processInstance);</span>
<span class="nc" id="L701">    }</span>

    @Test
    @Deployment
    public void testMiCallActivitySequential() {
<span class="nc" id="L706">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;testMiCallActivity&quot;);</span>

<span class="nc" id="L708">        List&lt;org.flowable.task.api.Task&gt; aTasks = taskService.createTaskQuery().taskName(&quot;A&quot;).list();</span>
<span class="nc" id="L709">        assertThat(aTasks).hasSize(1);</span>

<span class="nc" id="L711">        List&lt;org.flowable.task.api.Task&gt; bTasks = taskService.createTaskQuery().taskName(&quot;B&quot;).list();</span>
<span class="nc" id="L712">        assertThat(bTasks).hasSize(1);</span>

        // Completing B should terminate one instance (it goes to a terminate end event)
<span class="nc bnc" id="L715" title="All 2 branches missed.">        for (int i = 0; i &lt; 9; i++) {</span>

<span class="nc" id="L717">            org.flowable.task.api.Task bTask = taskService.createTaskQuery().taskName(&quot;B&quot;).singleResult();</span>

<span class="nc" id="L719">            taskService.complete(bTask.getId());</span>
            
<span class="nc" id="L721">            HistoryTestHelper.waitForJobExecutorToProcessAllHistoryJobs(processEngineConfiguration, managementService, 20000, 200);</span>

<span class="nc bnc" id="L723" title="All 2 branches missed.">            if (i != 8) {</span>
<span class="nc" id="L724">                aTasks = taskService.createTaskQuery().taskName(&quot;A&quot;).list();</span>
<span class="nc" id="L725">                assertThat(aTasks).hasSize(1);</span>

<span class="nc" id="L727">                bTasks = taskService.createTaskQuery().taskName(&quot;B&quot;).list();</span>
<span class="nc" id="L728">                assertThat(bTasks).hasSize(1);</span>
            }
        }

<span class="nc" id="L732">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L733">        assertThat(task.getName()).isEqualTo(&quot;After call activity&quot;);</span>

<span class="nc" id="L735">        taskService.complete(task.getId());</span>
        
<span class="nc" id="L737">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L738">        assertHistoricProcessInstanceDetails(processInstance);</span>

<span class="nc" id="L740">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.testTerminateInCallActivityConcurrent.bpmn&quot;,
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.subProcessConcurrentTerminateTerminateAll.bpmn20.xml&quot;
    })
    public void testTerminateInCallActivityConcurrentTerminateAll() throws Exception {
<span class="nc" id="L748">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>
<span class="nc" id="L749">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L750">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L751">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.testTerminateInCallActivityConcurrentMulitInstance.bpmn&quot;,
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.subProcessConcurrentTerminate.bpmn&quot;
    })
    public void testTerminateInCallActivityConcurrentMulitInstance() throws Exception {
<span class="nc" id="L759">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>

        // should terminate the called process and continue the parent
<span class="nc" id="L762">        long executionEntities = runtimeService.createExecutionQuery().count();</span>
<span class="nc" id="L763">        assertThat(executionEntities).isGreaterThan(0);</span>

<span class="nc" id="L765">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(pi.getId()).taskDefinitionKey(&quot;preNormalEnd&quot;).singleResult();</span>
<span class="nc" id="L766">        taskService.complete(task.getId());</span>

<span class="nc" id="L768">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L769">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L770">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.testTerminateInCallActivityConcurrentMulitInstance.bpmn&quot;,
            &quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.subProcessConcurrentTerminateTerminateAll.bpmn20.xml&quot; })
    public void testTerminateInCallActivityConcurrentMulitInstanceTerminateALl() throws Exception {
<span class="nc" id="L777">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;terminateEndEventExample&quot;);</span>
<span class="nc" id="L778">        assertProcessEnded(pi.getId());</span>
<span class="nc" id="L779">        assertHistoricProcessInstanceDetails(pi);</span>
<span class="nc" id="L780">    }</span>

    @Test
    @Deployment
    public void testTerminateNestedSubprocesses() {
<span class="nc" id="L785">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;TestTerminateNestedSubprocesses&quot;);</span>

<span class="nc" id="L787">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).orderByTaskName().asc().list();</span>
<span class="nc" id="L788">        assertThat(tasks)</span>
<span class="nc" id="L789">                .extracting(Task::getName)</span>
<span class="nc" id="L790">                .containsExactly(&quot;A&quot;, &quot;B&quot;, &quot;D&quot;, &quot;E&quot;, &quot;F&quot;);</span>

        // Completing E should finish the lower subprocess and make 'H' active
<span class="nc" id="L793">        taskService.complete(tasks.get(3).getId());</span>
<span class="nc" id="L794">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;H&quot;).singleResult();</span>
<span class="nc" id="L795">        assertThat(task).isNotNull();</span>

        // Completing A should make C active
<span class="nc" id="L798">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L799">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;C&quot;).singleResult();</span>
<span class="nc" id="L800">        assertThat(task).isNotNull();</span>

        // Completing C should make I active
<span class="nc" id="L803">        taskService.complete(task.getId());</span>
<span class="nc" id="L804">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;I&quot;).singleResult();</span>
<span class="nc" id="L805">        assertThat(task).isNotNull();</span>

        // Completing I and B should make G active
<span class="nc" id="L808">        taskService.complete(task.getId());</span>
<span class="nc" id="L809">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;G&quot;).singleResult();</span>
<span class="nc" id="L810">        assertThat(task).isNull();</span>
<span class="nc" id="L811">        taskService.complete(tasks.get(1).getId());</span>
<span class="nc" id="L812">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;G&quot;).singleResult();</span>
<span class="nc" id="L813">        assertThat(task).isNotNull();</span>
<span class="nc" id="L814">    }</span>

    @Test
    @Deployment
    public void testTerminateNestedSubprocessesTerminateAll1() {
<span class="nc" id="L819">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;TestTerminateNestedSubprocesses&quot;);</span>
<span class="nc" id="L820">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;E&quot;).singleResult();</span>

        // Completing E leads to a terminate end event with terminate all set to true
<span class="nc" id="L823">        taskService.complete(task.getId());</span>
<span class="nc" id="L824">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L825">        assertHistoricProcessInstanceDetails(processInstance);</span>
<span class="nc" id="L826">    }</span>

    @Test
    @Deployment
    public void testTerminateNestedSubprocessesTerminateAll2() {
<span class="nc" id="L831">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;TestTerminateNestedSubprocesses&quot;);</span>
<span class="nc" id="L832">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;A&quot;).singleResult();</span>

        // Completing A and C leads to a terminate end event with terminate all set to true
<span class="nc" id="L835">        taskService.complete(task.getId());</span>
<span class="nc" id="L836">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;C&quot;).singleResult();</span>
<span class="nc" id="L837">        taskService.complete(task.getId());</span>

<span class="nc" id="L839">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L840">    }</span>

    @Test
    @Deployment
    public void testTerminateNestedMiSubprocesses() {
<span class="nc" id="L845">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;TestTerminateNestedMiSubprocesses&quot;);</span>

<span class="nc" id="L847">        taskService.complete(taskService.createTaskQuery().taskName(&quot;A&quot;).singleResult().getId());</span>

        // Should have 7 tasks C active
<span class="nc" id="L850">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;C&quot;).list();</span>
<span class="nc" id="L851">        assertThat(tasks).hasSize(7);</span>

        // Completing these should lead to task I being active
<span class="nc bnc" id="L854" title="All 2 branches missed.">        for (org.flowable.task.api.Task task : tasks) {</span>
<span class="nc" id="L855">            taskService.complete(task.getId());</span>
<span class="nc" id="L856">        }</span>

<span class="nc" id="L858">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;I&quot;).singleResult();</span>
<span class="nc" id="L859">        assertThat(task).isNotNull();</span>

        // Should have 3 instances of E active
<span class="nc" id="L862">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;E&quot;).list();</span>
<span class="nc" id="L863">        assertThat(tasks).hasSize(3);</span>

        // Completing these should make H active
<span class="nc bnc" id="L866" title="All 2 branches missed.">        for (org.flowable.task.api.Task t : tasks) {</span>
<span class="nc" id="L867">            taskService.complete(t.getId());</span>
<span class="nc" id="L868">        }</span>
<span class="nc" id="L869">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;H&quot;).singleResult();</span>
<span class="nc" id="L870">        assertThat(task).isNotNull();</span>
<span class="nc" id="L871">    }</span>

    @Test
    @Deployment
    public void testTerminateNestedMiSubprocessesSequential() {
<span class="nc" id="L876">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;TestTerminateNestedMiSubprocesses&quot;);</span>

<span class="nc" id="L878">        taskService.complete(taskService.createTaskQuery().taskName(&quot;A&quot;).singleResult().getId());</span>

        // Should have 7 tasks C active after each other
<span class="nc bnc" id="L881" title="All 2 branches missed.">        for (int i = 0; i &lt; 7; i++) {</span>
<span class="nc" id="L882">            org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;C&quot;).singleResult();</span>
<span class="nc" id="L883">            assertThat(task).isNotNull();</span>
<span class="nc" id="L884">            taskService.complete(task.getId());</span>
        }

        // I should be active now
<span class="nc" id="L888">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;I&quot;).singleResult()).isNotNull();</span>

        // Should have 3 instances of E active after each other
<span class="nc bnc" id="L891" title="All 2 branches missed.">        for (int i = 0; i &lt; 3; i++) {</span>
<span class="nc" id="L892">            assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;D&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L893">            assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;F&quot;).count()).isEqualTo(1);</span>

            // Completing F should not finish the subprocess
<span class="nc" id="L896">            taskService.complete(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;F&quot;).singleResult().getId());</span>

<span class="nc" id="L898">            org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;E&quot;).singleResult();</span>
<span class="nc" id="L899">            taskService.complete(task.getId());</span>
        }

<span class="nc" id="L902">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;H&quot;).singleResult()).isNotNull();</span>
<span class="nc" id="L903">    }</span>

    @Test
    @Deployment
    public void testTerminateNestedMiSubprocessesTerminateAll1() {
<span class="nc" id="L908">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;TestTerminateNestedMiSubprocesses&quot;);</span>
<span class="nc" id="L909">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;E&quot;).list().get(0);</span>
<span class="nc" id="L910">        taskService.complete(task.getId());</span>
<span class="nc" id="L911">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L912">        assertHistoricProcessInstanceDetails(processInstance);</span>
<span class="nc" id="L913">    }</span>

    @Test
    @Deployment
    public void testTerminateNestedMiSubprocessesTerminateAll2() {
<span class="nc" id="L918">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;TestTerminateNestedMiSubprocesses&quot;);</span>
<span class="nc" id="L919">        taskService.complete(taskService.createTaskQuery().taskName(&quot;A&quot;).singleResult().getId());</span>
<span class="nc" id="L920">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;C&quot;).list().get(0);</span>
<span class="nc" id="L921">        taskService.complete(task.getId());</span>
<span class="nc" id="L922">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L923">        assertHistoricProcessInstanceDetails(processInstance);</span>
<span class="nc" id="L924">    }</span>

    @Test
    @Deployment
    public void testTerminateNestedMiSubprocessesTerminateAll3() { // Same as 1, but sequential Multi-Instance
<span class="nc" id="L929">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;TestTerminateNestedMiSubprocesses&quot;);</span>
<span class="nc" id="L930">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;E&quot;).list().get(0);</span>
<span class="nc" id="L931">        taskService.complete(task.getId());</span>
<span class="nc" id="L932">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L933">        assertHistoricProcessInstanceDetails(processInstance);</span>
<span class="nc" id="L934">    }</span>

    @Test
    @Deployment
    public void testTerminateNestedMiSubprocessesTerminateAll4() { // Same as 2, but sequential Multi-Instance
<span class="nc" id="L939">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;TestTerminateNestedMiSubprocesses&quot;);</span>
<span class="nc" id="L940">        taskService.complete(taskService.createTaskQuery().taskName(&quot;A&quot;).singleResult().getId());</span>
<span class="nc" id="L941">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;C&quot;).list().get(0);</span>
<span class="nc" id="L942">        taskService.complete(task.getId());</span>
<span class="nc" id="L943">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L944">        assertHistoricProcessInstanceDetails(processInstance);</span>
<span class="nc" id="L945">    }</span>

    @Test
    @Deployment
    public void testNestedCallActivities() {
<span class="nc" id="L950">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;TestNestedCallActivities&quot;);</span>

        // Verify the tasks
<span class="nc" id="L953">        List&lt;org.flowable.task.api.Task&gt; tasks = assertTaskNames(processInstance,</span>
<span class="nc" id="L954">                Arrays.asList(&quot;B&quot;, &quot;B&quot;, &quot;B&quot;, &quot;B&quot;, &quot;Before A&quot;, &quot;Before A&quot;, &quot;Before A&quot;, &quot;Before A&quot;, &quot;Before B&quot;, &quot;Before C&quot;));</span>

        // Completing 'before c'
<span class="nc" id="L957">        taskService.complete(tasks.get(9).getId());</span>
<span class="nc" id="L958">        tasks = assertTaskNames(processInstance,</span>
<span class="nc" id="L959">                Arrays.asList(&quot;After C&quot;, &quot;B&quot;, &quot;B&quot;, &quot;B&quot;, &quot;B&quot;, &quot;Before A&quot;, &quot;Before A&quot;, &quot;Before A&quot;, &quot;Before A&quot;, &quot;Before B&quot;));</span>

        // Completing 'before A' of one instance
<span class="nc" id="L962">        org.flowable.task.api.Task task = taskService.createTaskQuery().taskName(&quot;task_subprocess_1&quot;).singleResult();</span>
<span class="nc" id="L963">        assertThat(task).isNull();</span>
<span class="nc" id="L964">        taskService.complete(tasks.get(5).getId());</span>

        // Multi instance call activity is sequential, so expecting 5 more times the same task
<span class="nc bnc" id="L967" title="All 2 branches missed.">        for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L968">            task = taskService.createTaskQuery().taskName(&quot;subprocess1_task&quot;).singleResult();</span>
<span class="nc" id="L969">            assertThat(task).isNotNull();</span>
<span class="nc" id="L970">            taskService.complete(task.getId());</span>
        }

<span class="nc" id="L973">        tasks = assertTaskNames(processInstance,</span>
<span class="nc" id="L974">                Arrays.asList(&quot;After A&quot;, &quot;After C&quot;, &quot;B&quot;, &quot;B&quot;, &quot;B&quot;, &quot;B&quot;, &quot;Before A&quot;, &quot;Before A&quot;, &quot;Before A&quot;, &quot;Before B&quot;));</span>

<span class="nc" id="L976">    }</span>

    @Test
    @Deployment
    public void testNestedCallActivitiesTerminateAll() {
<span class="nc" id="L981">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;TestNestedCallActivities&quot;);</span>

        // Verify the tasks
<span class="nc" id="L984">        List&lt;org.flowable.task.api.Task&gt; tasks = assertTaskNames(processInstance,</span>
<span class="nc" id="L985">                Arrays.asList(&quot;B&quot;, &quot;B&quot;, &quot;B&quot;, &quot;B&quot;, &quot;Before A&quot;, &quot;Before A&quot;, &quot;Before A&quot;, &quot;Before A&quot;, &quot;Before B&quot;, &quot;Before C&quot;));</span>

        // Completing 'Before B' should lead to process instance termination
<span class="nc" id="L988">        taskService.complete(tasks.get(8).getId());</span>
<span class="nc" id="L989">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L990">        assertHistoricProcessInstanceDetails(processInstance);</span>

        // Completing 'Before C' too
<span class="nc" id="L993">        processInstance = runtimeService.startProcessInstanceByKey(&quot;TestNestedCallActivities&quot;);</span>
<span class="nc" id="L994">        tasks = assertTaskNames(processInstance,</span>
<span class="nc" id="L995">                Arrays.asList(&quot;B&quot;, &quot;B&quot;, &quot;B&quot;, &quot;B&quot;, &quot;Before A&quot;, &quot;Before A&quot;, &quot;Before A&quot;, &quot;Before A&quot;, &quot;Before B&quot;, &quot;Before C&quot;));</span>
<span class="nc" id="L996">        taskService.complete(tasks.get(9).getId());</span>
<span class="nc" id="L997">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L998">        assertHistoricProcessInstanceDetails(processInstance);</span>

        // Now the tricky one. 'Before A' leads to 'callActivity A', which calls subprocess02 which terminates
<span class="nc" id="L1001">        processInstance = runtimeService.startProcessInstanceByKey(&quot;TestNestedCallActivities&quot;);</span>
<span class="nc" id="L1002">        tasks = assertTaskNames(processInstance,</span>
<span class="nc" id="L1003">                Arrays.asList(&quot;B&quot;, &quot;B&quot;, &quot;B&quot;, &quot;B&quot;, &quot;Before A&quot;, &quot;Before A&quot;, &quot;Before A&quot;, &quot;Before A&quot;, &quot;Before B&quot;, &quot;Before C&quot;));</span>
<span class="nc" id="L1004">        taskService.complete(tasks.get(5).getId());</span>
<span class="nc" id="L1005">        org.flowable.task.api.Task task = taskService.createTaskQuery().taskName(&quot;subprocess1_task&quot;).singleResult();</span>
<span class="nc" id="L1006">        assertThat(task).isNotNull();</span>
<span class="nc" id="L1007">        taskService.complete(task.getId());</span>
<span class="nc" id="L1008">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1009">        assertHistoricProcessInstanceDetails(processInstance);</span>

<span class="nc" id="L1011">    }</span>

    private List&lt;org.flowable.task.api.Task&gt; assertTaskNames(ProcessInstance processInstance, List&lt;String&gt; taskNames) {
<span class="nc" id="L1014">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).orderByTaskName().asc().list();</span>
<span class="nc bnc" id="L1015" title="All 2 branches missed.">        for (int i = 0; i &lt; taskNames.size(); i++) {</span>
<span class="nc" id="L1016">            assertThat(tasks.get(i).getName()).as(&quot;Task name at index &quot; + i + &quot; does not match&quot;).isEqualTo(taskNames.get(i));</span>
        }
<span class="nc" id="L1018">        return tasks;</span>
    }

    @Test
    public void testParseTerminateEndEventDefinitionWithExtensions() {
<span class="nc" id="L1023">        org.flowable.engine.repository.Deployment deployment = repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/engine/test/bpmn/event/end/TerminateEndEventTest.parseExtensionElements.bpmn20.xml&quot;).deploy();</span>
<span class="nc" id="L1024">        ProcessDefinition processDefinitionQuery = repositoryService.createProcessDefinitionQuery().deploymentId(deployment.getId()).singleResult();</span>
<span class="nc" id="L1025">        BpmnModel bpmnModel = this.processEngineConfiguration.getProcessDefinitionCache()</span>
<span class="nc" id="L1026">                .get(processDefinitionQuery.getId()).getBpmnModel();</span>

<span class="nc" id="L1028">        Map&lt;String, List&lt;ExtensionElement&gt;&gt; extensionElements = bpmnModel.getProcesses().get(0)</span>
<span class="nc" id="L1029">                .findFlowElementsOfType(EndEvent.class).get(0).getExtensionElements();</span>
<span class="nc" id="L1030">        assertThat(extensionElements).hasSize(1);</span>
<span class="nc" id="L1031">        List&lt;ExtensionElement&gt; strangeProperties = extensionElements.get(&quot;strangeProperty&quot;);</span>
<span class="nc" id="L1032">        assertThat(strangeProperties).hasSize(1);</span>
<span class="nc" id="L1033">        ExtensionElement strangeProperty = strangeProperties.get(0);</span>
<span class="nc" id="L1034">        assertThat(strangeProperty.getNamespace()).isEqualTo(&quot;http://activiti.org/bpmn&quot;);</span>
<span class="nc" id="L1035">        assertThat(strangeProperty.getElementText()).isEqualTo(&quot;value&quot;);</span>
<span class="nc" id="L1036">        assertThat(strangeProperty.getAttributes()).hasSize(1);</span>
<span class="nc" id="L1037">        ExtensionAttribute id = strangeProperty.getAttributes().get(&quot;id&quot;).get(0);</span>
<span class="nc" id="L1038">        assertThat(id.getName()).isEqualTo(&quot;id&quot;);</span>
<span class="nc" id="L1039">        assertThat(id.getValue()).isEqualTo(&quot;strangeId&quot;);</span>

<span class="nc" id="L1041">        repositoryService.deleteDeployment(deployment.getId());</span>
<span class="nc" id="L1042">    }</span>

    // Unit test for ACT-4101 : NPE when there are multiple routes to terminateEndEvent, and both are reached
    @Test
    @Deployment
    public void testThreeExecutionsArrivingInTerminateEndEvent() {
<span class="nc" id="L1048">        Map&lt;String, Object&gt; variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1049">        variableMap.put(&quot;passed_QC&quot;, false);</span>
<span class="nc" id="L1050">        variableMap.put(&quot;has_bad_pixel_pattern&quot;, true);</span>
<span class="nc" id="L1051">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;skybox_image_pull_request&quot;, variableMap);</span>
<span class="nc" id="L1052">        String processInstanceId = processInstance.getId();</span>
<span class="nc" id="L1053">        assertThat(processInstance).isNotNull();</span>
<span class="nc bnc" id="L1054" title="All 2 branches missed.">        while (processInstance != null) {</span>
<span class="nc" id="L1055">            List&lt;Execution&gt; executionList = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1056">            String activityId = &quot;&quot;;</span>
<span class="nc bnc" id="L1057" title="All 2 branches missed.">            for (Execution execution : executionList) {</span>
<span class="nc" id="L1058">                activityId = execution.getActivityId();</span>
<span class="nc bnc" id="L1059" title="All 2 branches missed.">                if (activityId == null</span>
<span class="nc bnc" id="L1060" title="All 2 branches missed.">                        || &quot;quality_control_passed_gateway&quot;.equalsIgnoreCase(activityId)</span>
<span class="nc bnc" id="L1061" title="All 2 branches missed.">                        || &quot;parallelgateway1&quot;.equalsIgnoreCase(activityId)</span>
<span class="nc bnc" id="L1062" title="All 2 branches missed.">                        || &quot;catch_bad_pixel_signal&quot;.equalsIgnoreCase(activityId)</span>
<span class="nc bnc" id="L1063" title="All 2 branches missed.">                        || &quot;throw_bad_pixel_signal&quot;.equalsIgnoreCase(activityId)</span>
<span class="nc bnc" id="L1064" title="All 2 branches missed.">                        || &quot;has_bad_pixel_pattern&quot;.equalsIgnoreCase(activityId)</span>
<span class="nc bnc" id="L1065" title="All 2 branches missed.">                        || &quot;&quot;.equalsIgnoreCase(activityId)) {</span>
<span class="nc" id="L1066">                    continue;</span>
                }
<span class="nc" id="L1068">                runtimeService.trigger(execution.getId());</span>
<span class="nc" id="L1069">            }</span>
<span class="nc" id="L1070">            processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1071">        }</span>

<span class="nc" id="L1073">        assertProcessEnded(processInstanceId);</span>
<span class="nc" id="L1074">        assertHistoricProcessInstanceDetails(processInstanceId);</span>
<span class="nc" id="L1075">    }</span>

    protected void assertHistoricProcessInstanceDetails(ProcessInstance pi) {
<span class="nc" id="L1078">        assertHistoricProcessInstanceDetails(pi.getId());</span>
<span class="nc" id="L1079">    }</span>

    protected void assertHistoricProcessInstanceDetails(String processInstanceId) {
<span class="nc bnc" id="L1082" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L1083">            HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L1084">                    .processInstanceId(processInstanceId).singleResult();</span>

<span class="nc" id="L1086">            assertThat(historicProcessInstance.getEndTime()).isNotNull();</span>
<span class="nc" id="L1087">            assertThat(historicProcessInstance.getDurationInMillis()).isNotNull();</span>
<span class="nc" id="L1088">            assertThat(historicProcessInstance.getEndActivityId()).isNotNull();</span>
        }
<span class="nc" id="L1090">    }</span>

    protected void assertHistoricProcessInstanceDeleteReason(ProcessInstance processInstance, String expectedDeleteReason) {
<span class="nc bnc" id="L1093" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1094">            HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L1095">                    .processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc bnc" id="L1096" title="All 2 branches missed.">            if (expectedDeleteReason == null) {</span>
<span class="nc" id="L1097">                assertThat(historicProcessInstance.getDeleteReason()).isNull();</span>
            } else {
<span class="nc" id="L1099">                assertThat(historicProcessInstance.getDeleteReason()).startsWith(expectedDeleteReason);</span>
            }
        }
<span class="nc" id="L1102">    }</span>

    @Override
    protected void assertHistoricTasksDeleteReason(ProcessInstance processInstance, String expectedDeleteReason, String... taskNames) {
<span class="nc bnc" id="L1106" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">            for (String taskName : taskNames) {</span>
<span class="nc" id="L1108">                List&lt;HistoricTaskInstance&gt; historicTaskInstances = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1109">                        .processInstanceId(processInstance.getId()).taskName(taskName).list();</span>
<span class="nc" id="L1110">                assertThat(historicTaskInstances).isNotEmpty();</span>
<span class="nc bnc" id="L1111" title="All 2 branches missed.">                for (HistoricTaskInstance historicTaskInstance : historicTaskInstances) {</span>
<span class="nc" id="L1112">                    assertThat(historicTaskInstance.getEndTime()).isNotNull();</span>
<span class="nc bnc" id="L1113" title="All 2 branches missed.">                    if (expectedDeleteReason == null) {</span>
<span class="nc" id="L1114">                        assertThat(historicTaskInstance.getDeleteReason()).isNull();</span>
                    } else {
<span class="nc" id="L1116">                        assertThat(historicTaskInstance.getDeleteReason()).startsWith(expectedDeleteReason);</span>
                    }
<span class="nc" id="L1118">                }</span>
            }
        }
<span class="nc" id="L1121">    }</span>

    @Override
    protected void assertHistoricActivitiesDeleteReason(ProcessInstance processInstance, String expectedDeleteReason, String... activityIds) {
<span class="nc bnc" id="L1125" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc bnc" id="L1126" title="All 2 branches missed.">            for (String activityId : activityIds) {</span>
<span class="nc" id="L1127">                List&lt;HistoricActivityInstance&gt; historicActiviyInstances = historyService.createHistoricActivityInstanceQuery()</span>
<span class="nc" id="L1128">                        .activityId(activityId).processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1129">                assertThat(historicActiviyInstances).isNotEmpty();</span>
<span class="nc bnc" id="L1130" title="All 2 branches missed.">                for (HistoricActivityInstance historicActiviyInstance : historicActiviyInstances) {</span>
<span class="nc" id="L1131">                    assertThat(historicActiviyInstance.getEndTime()).isNotNull();</span>
<span class="nc bnc" id="L1132" title="All 2 branches missed.">                    if (expectedDeleteReason == null) {</span>
<span class="nc" id="L1133">                        assertThat(historicActiviyInstance.getDeleteReason()).isNull();</span>
                    } else {
<span class="nc" id="L1135">                        assertThat(historicActiviyInstance.getDeleteReason()).startsWith(expectedDeleteReason);</span>
                    }
<span class="nc" id="L1137">                }</span>
            }
        }
<span class="nc" id="L1140">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>