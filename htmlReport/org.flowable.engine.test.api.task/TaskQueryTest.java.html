<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TaskQueryTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.task</a> &gt; <span class="el_source">TaskQueryTest.java</span></div><h1>TaskQueryTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.engine.test.api.task;

import static java.util.Arrays.asList;
import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.assertj.core.api.Assertions.entry;
import static org.assertj.core.api.Assertions.tuple;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.api.FlowableIllegalArgumentException;
import org.flowable.common.engine.impl.AbstractEngineConfiguration;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.engine.impl.test.HistoryTestHelper;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.runtime.Execution;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.identitylink.api.IdentityLinkInfo;
import org.flowable.identitylink.api.IdentityLinkType;
import org.flowable.task.api.DelegationState;
import org.flowable.task.api.Task;
import org.flowable.task.api.TaskInfo;
import org.flowable.task.api.TaskQuery;
import org.flowable.task.api.history.HistoricTaskInstance;
import org.flowable.task.api.history.HistoricTaskInstanceQuery;
import org.flowable.task.service.impl.persistence.entity.TaskEntity;
import org.flowable.variable.service.impl.persistence.entity.VariableInstanceEntity;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import com.fasterxml.jackson.databind.node.ObjectNode;

/**
 * @author Joram Barrez
 * @author Frederik Heremans
 * @author Falko Menge
 * @author Filip Hrisafov
 * @author Christopher Welsch
 */
<span class="nc" id="L63">public class TaskQueryTest extends PluggableFlowableTestCase {</span>

    private List&lt;String&gt; taskIds;

    @BeforeEach
    public void setUp() throws Exception {

<span class="nc" id="L70">        identityService.saveUser(identityService.newUser(&quot;kermit&quot;));</span>
<span class="nc" id="L71">        identityService.saveUser(identityService.newUser(&quot;gonzo&quot;));</span>
<span class="nc" id="L72">        identityService.saveUser(identityService.newUser(&quot;fozzie&quot;));</span>

<span class="nc" id="L74">        identityService.saveGroup(identityService.newGroup(&quot;management&quot;));</span>
<span class="nc" id="L75">        identityService.saveGroup(identityService.newGroup(&quot;accountancy&quot;));</span>

<span class="nc" id="L77">        identityService.createMembership(&quot;kermit&quot;, &quot;management&quot;);</span>
<span class="nc" id="L78">        identityService.createMembership(&quot;kermit&quot;, &quot;accountancy&quot;);</span>
<span class="nc" id="L79">        identityService.createMembership(&quot;fozzie&quot;, &quot;management&quot;);</span>

<span class="nc" id="L81">        taskIds = generateTestTasks();</span>
<span class="nc" id="L82">    }</span>

    @AfterEach
    public void tearDown() throws Exception {
<span class="nc" id="L86">        identityService.deleteGroup(&quot;accountancy&quot;);</span>
<span class="nc" id="L87">        identityService.deleteGroup(&quot;management&quot;);</span>
<span class="nc" id="L88">        identityService.deleteUser(&quot;fozzie&quot;);</span>
<span class="nc" id="L89">        identityService.deleteUser(&quot;gonzo&quot;);</span>
<span class="nc" id="L90">        identityService.deleteUser(&quot;kermit&quot;);</span>
<span class="nc" id="L91">        taskService.deleteTasks(taskIds, true);</span>
<span class="nc" id="L92">    }</span>

    @Test
    public void testBasicTaskPropertiesNotNull() {
<span class="nc" id="L96">        org.flowable.task.api.Task task = taskService.createTaskQuery().taskId(taskIds.get(0)).singleResult();</span>
<span class="nc" id="L97">        assertThat(task.getDescription()).isNotNull();</span>
<span class="nc" id="L98">        assertThat(task.getId()).isNotNull();</span>
<span class="nc" id="L99">        assertThat(task.getName()).isNotNull();</span>
<span class="nc" id="L100">        assertThat(task.getCreateTime()).isNotNull();</span>
<span class="nc" id="L101">    }</span>

    @Test
    public void testQueryNoCriteria() {
<span class="nc" id="L105">        TaskQuery query = taskService.createTaskQuery();</span>
<span class="nc" id="L106">        assertThat(query.count()).isEqualTo(12);</span>
<span class="nc" id="L107">        assertThat(query.list()).hasSize(12);</span>
<span class="nc" id="L108">        assertThatThrownBy(() -&gt; query.singleResult())</span>
<span class="nc" id="L109">                .isExactlyInstanceOf(FlowableException.class);</span>
<span class="nc" id="L110">    }</span>

    @Test
    public void testQueryByTaskId() {
<span class="nc" id="L114">        TaskQuery query = taskService.createTaskQuery().taskId(taskIds.get(0));</span>
<span class="nc" id="L115">        assertThat(query.singleResult()).isNotNull();</span>
<span class="nc" id="L116">        assertThat(query.list()).hasSize(1);</span>
<span class="nc" id="L117">        assertThat(query.count()).isEqualTo(1);</span>
<span class="nc" id="L118">    }</span>

    @Test
    public void testQueryByTaskIdOr() {
<span class="nc" id="L122">        TaskQuery query = taskService.createTaskQuery().or().taskId(taskIds.get(0)).taskName(&quot;INVALID NAME&quot;).endOr();</span>
<span class="nc" id="L123">        assertThat(query.singleResult()).isNotNull();</span>
<span class="nc" id="L124">        assertThat(query.list()).hasSize(1);</span>
<span class="nc" id="L125">        assertThat(query.count()).isEqualTo(1);</span>
<span class="nc" id="L126">    }</span>

    @Test
    public void testQueryByTaskIds() {
<span class="nc" id="L130">        List&lt;String&gt; testIdList = new ArrayList&lt;&gt;(taskIds);</span>
<span class="nc" id="L131">        testIdList.remove(10);</span>
<span class="nc" id="L132">        testIdList.remove(8);</span>
<span class="nc" id="L133">        testIdList.add(&quot;invalid&quot;);</span>

<span class="nc" id="L135">        TaskQuery query = taskService.createTaskQuery().taskIds(testIdList);</span>
<span class="nc" id="L136">        assertThat(query.list()).hasSize(testIdList.size() - 1);</span>
<span class="nc" id="L137">        assertThat(query.count()).isEqualTo(testIdList.size() - 1);</span>

<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.TASK, processEngineConfiguration)) {</span>
<span class="nc" id="L140">            HistoricTaskInstanceQuery historyQuery = historyService.createHistoricTaskInstanceQuery().taskIds(Arrays.asList(taskIds.get(0), &quot;dummy&quot;));</span>
<span class="nc" id="L141">            assertThat(historyQuery.singleResult()).isNotNull();</span>
<span class="nc" id="L142">            assertThat(historyQuery.list())</span>
<span class="nc" id="L143">                    .extracting(HistoricTaskInstance::getId)</span>
<span class="nc" id="L144">                    .containsExactlyInAnyOrder(taskIds.get(0));</span>
<span class="nc" id="L145">            assertThat(historyQuery.count()).isEqualTo(1);</span>

<span class="nc" id="L147">            historyQuery = historyService.createHistoricTaskInstanceQuery().taskIds(Arrays.asList(taskIds.get(0), taskIds.get(1)));</span>
<span class="nc" id="L148">            assertThat(historyQuery.list())</span>
<span class="nc" id="L149">                    .extracting(HistoricTaskInstance::getId)</span>
<span class="nc" id="L150">                    .containsExactlyInAnyOrder(taskIds.get(0), taskIds.get(1));</span>
<span class="nc" id="L151">            assertThat(historyQuery.count()).isEqualTo(2);</span>
        }
<span class="nc" id="L153">    }</span>

    @Test
    public void testQueryByInvalidTaskIds() {
<span class="nc" id="L157">        List&lt;String&gt; invalidTaskIdList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L158">        invalidTaskIdList.add(&quot;invalid&quot;);</span>
<span class="nc" id="L159">        TaskQuery query = taskService.createTaskQuery().taskIds(invalidTaskIdList);</span>
<span class="nc" id="L160">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L161">        assertThat(query.count()).isZero();</span>

<span class="nc" id="L163">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().taskIds(null))</span>
<span class="nc" id="L164">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L165">    }</span>

    @Test
    public void testQueryByTaskIdsOr() {
<span class="nc" id="L169">        TaskQuery query = taskService.createTaskQuery().or().taskIds(Arrays.asList(taskIds.get(0), &quot;dummy&quot;)).taskName(&quot;INVALID NAME&quot;).endOr();</span>
<span class="nc" id="L170">        assertThat(query.singleResult()).isNotNull();</span>
<span class="nc" id="L171">        assertThat(query.list())</span>
<span class="nc" id="L172">                .extracting(Task::getId)</span>
<span class="nc" id="L173">                .containsExactlyInAnyOrder(taskIds.get(0));</span>
<span class="nc" id="L174">        assertThat(query.count()).isEqualTo(1);</span>

<span class="nc" id="L176">        query = taskService.createTaskQuery().or().taskIds(Arrays.asList(taskIds.get(0), taskIds.get(1))).taskName(&quot;INVALID NAME&quot;).endOr();</span>
<span class="nc" id="L177">        assertThat(query.list())</span>
<span class="nc" id="L178">                .extracting(Task::getId)</span>
<span class="nc" id="L179">                .containsExactlyInAnyOrder(taskIds.get(0), taskIds.get(1));</span>
<span class="nc" id="L180">        assertThat(query.count()).isEqualTo(2);</span>

<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.TASK, processEngineConfiguration)) {</span>
<span class="nc" id="L183">            HistoricTaskInstanceQuery historyQuery = historyService.createHistoricTaskInstanceQuery().or().taskIds(Arrays.asList(taskIds.get(0), &quot;dummy&quot;)).taskName(&quot;INVALID NAME&quot;).endOr();</span>
<span class="nc" id="L184">            assertThat(historyQuery.singleResult()).isNotNull();</span>
<span class="nc" id="L185">            assertThat(historyQuery.list())</span>
<span class="nc" id="L186">                    .extracting(HistoricTaskInstance::getId)</span>
<span class="nc" id="L187">                    .containsExactlyInAnyOrder(taskIds.get(0));</span>
<span class="nc" id="L188">            assertThat(historyQuery.count()).isEqualTo(1);</span>

<span class="nc" id="L190">            historyQuery = historyService.createHistoricTaskInstanceQuery().or().taskIds(Arrays.asList(taskIds.get(0), taskIds.get(1))).taskName(&quot;INVALID NAME&quot;).endOr();</span>
<span class="nc" id="L191">            assertThat(historyQuery.list())</span>
<span class="nc" id="L192">                    .extracting(HistoricTaskInstance::getId)</span>
<span class="nc" id="L193">                    .containsExactlyInAnyOrder(taskIds.get(0), taskIds.get(1));</span>
<span class="nc" id="L194">            assertThat(historyQuery.count()).isEqualTo(2);</span>
        }
<span class="nc" id="L196">    }</span>

    @Test
    public void testQueryByInvalidTaskId() {
<span class="nc" id="L200">        TaskQuery query = taskService.createTaskQuery().taskId(&quot;invalid&quot;);</span>
<span class="nc" id="L201">        assertThat(query.singleResult()).isNull();</span>
<span class="nc" id="L202">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L203">        assertThat(query.count()).isZero();</span>

<span class="nc" id="L205">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().taskId(null))</span>
<span class="nc" id="L206">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L207">    }</span>

    @Test
    public void testQueryByInvalidTaskIdOr() {
<span class="nc" id="L211">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskName(&quot;invalid&quot;);</span>
<span class="nc" id="L212">        assertThat(query.singleResult()).isNull();</span>
<span class="nc" id="L213">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L214">        assertThat(query.count()).isZero();</span>

<span class="nc" id="L216">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().taskId(null))</span>
<span class="nc" id="L217">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L218">    }</span>

    @Test
    public void testQueryByName() {
<span class="nc" id="L222">        TaskQuery query = taskService.createTaskQuery().taskName(&quot;testTask&quot;);</span>
<span class="nc" id="L223">        assertThat(query.list()).hasSize(6);</span>
<span class="nc" id="L224">        assertThat(query.count()).isEqualTo(6);</span>

<span class="nc" id="L226">        assertThatThrownBy(() -&gt; query.singleResult())</span>
<span class="nc" id="L227">                .isExactlyInstanceOf(FlowableException.class);</span>
<span class="nc" id="L228">    }</span>

    @Test
    public void testQueryByNameOr() {
<span class="nc" id="L232">        TaskQuery query = taskService.createTaskQuery().or().taskName(&quot;testTask&quot;).taskId(&quot;invalid&quot;);</span>
<span class="nc" id="L233">        assertThat(query.list()).hasSize(6);</span>
<span class="nc" id="L234">        assertThat(query.count()).isEqualTo(6);</span>

<span class="nc" id="L236">        assertThatThrownBy(() -&gt; query.singleResult())</span>
<span class="nc" id="L237">                .isExactlyInstanceOf(FlowableException.class);</span>
<span class="nc" id="L238">    }</span>

    @Test
    public void testQueryByInvalidName() {
<span class="nc" id="L242">        TaskQuery query = taskService.createTaskQuery().taskName(&quot;invalid&quot;);</span>
<span class="nc" id="L243">        assertThat(query.singleResult()).isNull();</span>
<span class="nc" id="L244">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L245">        assertThat(query.count()).isZero();</span>

<span class="nc" id="L247">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskName(null).singleResult())</span>
<span class="nc" id="L248">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L249">    }</span>

    @Test
    public void testQueryByInvalidNameOr() {
<span class="nc" id="L253">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskName(&quot;invalid&quot;);</span>
<span class="nc" id="L254">        assertThat(query.singleResult()).isNull();</span>
<span class="nc" id="L255">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L256">        assertThat(query.count()).isZero();</span>

<span class="nc" id="L258">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskName(null).singleResult())</span>
<span class="nc" id="L259">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L260">    }</span>

    @Test
    public void testQueryByNameIn() {
<span class="nc" id="L264">        List&lt;String&gt; taskNameList = Arrays.asList(&quot;testTask&quot;, &quot;gonzoTask&quot;);</span>

<span class="nc" id="L266">        TaskQuery query = taskService.createTaskQuery().taskNameIn(taskNameList);</span>
<span class="nc" id="L267">        assertThat(query.list()).hasSize(7);</span>
<span class="nc" id="L268">        assertThat(query.count()).isEqualTo(7);</span>

<span class="nc" id="L270">        assertThatThrownBy(() -&gt; query.singleResult())</span>
<span class="nc" id="L271">                .isExactlyInstanceOf(FlowableException.class);</span>
<span class="nc" id="L272">    }</span>

    @Test
    public void testQueryByNameInIgnoreCase() {
<span class="nc" id="L276">        List&lt;String&gt; taskNameList = Arrays.asList(&quot;testtask&quot;, &quot;gonzotask&quot;);</span>

<span class="nc" id="L278">        TaskQuery query = taskService.createTaskQuery().taskNameInIgnoreCase(taskNameList);</span>
<span class="nc" id="L279">        assertThat(query.list()).hasSize(7);</span>
<span class="nc" id="L280">        assertThat(query.count()).isEqualTo(7);</span>

<span class="nc" id="L282">        assertThatThrownBy(() -&gt; query.singleResult())</span>
<span class="nc" id="L283">                .isExactlyInstanceOf(FlowableException.class);</span>
<span class="nc" id="L284">    }</span>

    @Test
    public void testQueryByNameInOr() {
<span class="nc" id="L288">        List&lt;String&gt; taskNameList = asList(&quot;testTask&quot;, &quot;gonzoTask&quot;);</span>

<span class="nc" id="L290">        TaskQuery query = taskService.createTaskQuery().or().taskNameIn(taskNameList).taskId(&quot;invalid&quot;);</span>
<span class="nc" id="L291">        assertThat(query.list()).hasSize(7);</span>
<span class="nc" id="L292">        assertThat(query.count()).isEqualTo(7);</span>

<span class="nc" id="L294">        assertThatThrownBy(() -&gt; query.singleResult())</span>
<span class="nc" id="L295">                .isExactlyInstanceOf(FlowableException.class);</span>
<span class="nc" id="L296">    }</span>

    @Test
    public void testQueryByNameInIgnoreCaseOr() {
<span class="nc" id="L300">        List&lt;String&gt; taskNameList = asList(&quot;testtask&quot;, &quot;gonzotask&quot;);</span>

<span class="nc" id="L302">        TaskQuery query = taskService.createTaskQuery().or().taskNameInIgnoreCase(taskNameList).taskId(&quot;invalid&quot;);</span>
<span class="nc" id="L303">        assertThat(query.list()).hasSize(7);</span>
<span class="nc" id="L304">        assertThat(query.count()).isEqualTo(7);</span>

<span class="nc" id="L306">        assertThatThrownBy(() -&gt; query.singleResult())</span>
<span class="nc" id="L307">                .isExactlyInstanceOf(FlowableException.class);</span>
<span class="nc" id="L308">    }</span>

    @Test
    public void testQueryByInvalidNameIn() {
<span class="nc" id="L312">        List&lt;String&gt; taskNameList = Collections.singletonList(&quot;invalid&quot;);</span>

<span class="nc" id="L314">        TaskQuery query = taskService.createTaskQuery().taskNameIn(taskNameList);</span>
<span class="nc" id="L315">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L316">        assertThat(query.count()).isZero();</span>

<span class="nc" id="L318">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskNameIn(null).singleResult())</span>
<span class="nc" id="L319">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L320">    }</span>

    @Test
    public void testQueryByInvalidNameInIgnoreCase() {
<span class="nc" id="L324">        List&lt;String&gt; taskNameList = Collections.singletonList(&quot;invalid&quot;);</span>

<span class="nc" id="L326">        TaskQuery query = taskService.createTaskQuery().taskNameInIgnoreCase(taskNameList);</span>
<span class="nc" id="L327">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L328">        assertThat(query.count()).isZero();</span>

<span class="nc" id="L330">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskNameIn(null).singleResult())</span>
<span class="nc" id="L331">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L332">    }</span>

    @Test
    public void testQueryByInvalidNameInOr() {
<span class="nc" id="L336">        List&lt;String&gt; taskNameList = Collections.singletonList(&quot;invalid&quot;);</span>

<span class="nc" id="L338">        TaskQuery query = taskService.createTaskQuery().or().taskNameIn(taskNameList).taskId(&quot;invalid&quot;);</span>
<span class="nc" id="L339">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L340">        assertThat(query.count()).isZero();</span>

<span class="nc" id="L342">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskNameIn(null).singleResult())</span>
<span class="nc" id="L343">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L344">    }</span>

    @Test
    public void testQueryByInvalidNameInIgnoreCaseOr() {
<span class="nc" id="L348">        List&lt;String&gt; taskNameList = Collections.singletonList(&quot;invalid&quot;);</span>

<span class="nc" id="L350">        TaskQuery query = taskService.createTaskQuery().or().taskNameInIgnoreCase(taskNameList).taskId(&quot;invalid&quot;);</span>
<span class="nc" id="L351">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L352">        assertThat(query.count()).isZero();</span>

<span class="nc" id="L354">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskNameIn(null).singleResult())</span>
<span class="nc" id="L355">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L356">    }</span>

    @Test
    public void testQueryByNameLike() {
<span class="nc" id="L360">        TaskQuery query = taskService.createTaskQuery().taskNameLike(&quot;gonzo%&quot;);</span>
<span class="nc" id="L361">        assertThat(query.singleResult()).isNotNull();</span>
<span class="nc" id="L362">        assertThat(query.list()).hasSize(1);</span>
<span class="nc" id="L363">        assertThat(query.count()).isEqualTo(1);</span>
<span class="nc" id="L364">    }</span>

    @Test
    public void testQueryByNameLikeOr() {
<span class="nc" id="L368">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskNameLike(&quot;gonzo%&quot;);</span>
<span class="nc" id="L369">        assertThat(query.singleResult()).isNotNull();</span>
<span class="nc" id="L370">        assertThat(query.list()).hasSize(1);</span>
<span class="nc" id="L371">        assertThat(query.count()).isEqualTo(1);</span>
<span class="nc" id="L372">    }</span>

    @Test
    public void testQueryByInvalidNameLike() {
<span class="nc" id="L376">        TaskQuery query = taskService.createTaskQuery().taskNameLike(&quot;1&quot;);</span>
<span class="nc" id="L377">        assertThat(query.singleResult()).isNull();</span>
<span class="nc" id="L378">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L379">        assertThat(query.count()).isZero();</span>

<span class="nc" id="L381">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskNameLike(null).singleResult())</span>
<span class="nc" id="L382">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L383">    }</span>

    @Test
    public void testQueryByInvalidNameLikeOr() {
<span class="nc" id="L387">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskNameLike(&quot;1&quot;);</span>
<span class="nc" id="L388">        assertThat(query.singleResult()).isNull();</span>
<span class="nc" id="L389">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L390">        assertThat(query.count()).isZero();</span>

<span class="nc" id="L392">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskNameLike(null).singleResult())</span>
<span class="nc" id="L393">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L394">    }</span>

    @Test
    public void testQueryByDescription() {
<span class="nc" id="L398">        TaskQuery query = taskService.createTaskQuery().taskDescription(&quot;testTask description&quot;);</span>
<span class="nc" id="L399">        assertThat(query.list()).hasSize(6);</span>
<span class="nc" id="L400">        assertThat(query.count()).isEqualTo(6);</span>

<span class="nc" id="L402">        assertThatThrownBy(() -&gt; query.singleResult())</span>
<span class="nc" id="L403">                .isExactlyInstanceOf(FlowableException.class);</span>
<span class="nc" id="L404">    }</span>

    @Test
    public void testQueryByDescriptionOr() {
<span class="nc" id="L408">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDescription(&quot;testTask description&quot;);</span>
<span class="nc" id="L409">        assertThat(query.list()).hasSize(6);</span>
<span class="nc" id="L410">        assertThat(query.count()).isEqualTo(6);</span>

<span class="nc" id="L412">        assertThatThrownBy(() -&gt; query.singleResult())</span>
<span class="nc" id="L413">                .isExactlyInstanceOf(FlowableException.class);</span>
<span class="nc" id="L414">    }</span>

    @Test
    public void testQueryByInvalidDescription() {
<span class="nc" id="L418">        TaskQuery query = taskService.createTaskQuery().taskDescription(&quot;invalid&quot;);</span>
<span class="nc" id="L419">        assertThat(query.singleResult()).isNull();</span>
<span class="nc" id="L420">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L421">        assertThat(query.count()).isZero();</span>

<span class="nc" id="L423">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDescription(null).list())</span>
<span class="nc" id="L424">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L425">    }</span>

    @Test
    public void testQueryByInvalidDescriptionOr() {
<span class="nc" id="L429">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDescription(&quot;invalid&quot;);</span>
<span class="nc" id="L430">        assertThat(query.singleResult()).isNull();</span>
<span class="nc" id="L431">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L432">        assertThat(query.count()).isZero();</span>

<span class="nc" id="L434">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDescription(null).list())</span>
<span class="nc" id="L435">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L436">    }</span>

    @Test
    public void testQueryByDescriptionLike() {
<span class="nc" id="L440">        TaskQuery query = taskService.createTaskQuery().taskDescriptionLike(&quot;%gonzo%&quot;);</span>
<span class="nc" id="L441">        assertThat(query.singleResult()).isNotNull();</span>
<span class="nc" id="L442">        assertThat(query.list()).hasSize(1);</span>
<span class="nc" id="L443">        assertThat(query.count()).isEqualTo(1);</span>
<span class="nc" id="L444">    }</span>

    @Test
    public void testQueryByDescriptionLikeOr() {
<span class="nc" id="L448">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDescriptionLike(&quot;%gonzo%&quot;);</span>
<span class="nc" id="L449">        assertThat(query.singleResult()).isNotNull();</span>
<span class="nc" id="L450">        assertThat(query.list()).hasSize(1);</span>
<span class="nc" id="L451">        assertThat(query.count()).isEqualTo(1);</span>
<span class="nc" id="L452">    }</span>

    @Test
    public void testQueryByInvalidDescriptionLike() {
<span class="nc" id="L456">        TaskQuery query = taskService.createTaskQuery().taskDescriptionLike(&quot;invalid&quot;);</span>
<span class="nc" id="L457">        assertThat(query.singleResult()).isNull();</span>
<span class="nc" id="L458">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L459">        assertThat(query.count()).isZero();</span>

<span class="nc" id="L461">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDescriptionLike(null).list())</span>
<span class="nc" id="L462">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L463">    }</span>

    @Test
    public void testQueryByInvalidDescriptionLikeOr() {
<span class="nc" id="L467">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDescriptionLike(&quot;invalid&quot;);</span>
<span class="nc" id="L468">        assertThat(query.singleResult()).isNull();</span>
<span class="nc" id="L469">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L470">        assertThat(query.count()).isZero();</span>

<span class="nc" id="L472">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDescriptionLike(null).list())</span>
<span class="nc" id="L473">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L474">    }</span>

    @Test
    public void testQueryByFormKey() {
<span class="nc" id="L478">        Task task = taskService.newTask();</span>
<span class="nc" id="L479">        task.setFormKey(&quot;testFormKey&quot;);</span>
<span class="nc" id="L480">        taskService.saveTask(task);</span>
<span class="nc" id="L481">        taskIds.add(task.getId());</span>

<span class="nc" id="L483">        List&lt;Task&gt; tasks = taskService.createTaskQuery().taskFormKey(&quot;testFormKey&quot;).list();</span>
<span class="nc" id="L484">        assertThat(tasks)</span>
<span class="nc" id="L485">                .extracting(Task::getFormKey)</span>
<span class="nc" id="L486">                .containsExactly(&quot;testFormKey&quot;);</span>

<span class="nc bnc" id="L488" title="All 2 branches missed.">        if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L489">            List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L490">                    .taskFormKey(&quot;testFormKey&quot;)</span>
<span class="nc" id="L491">                    .list();</span>
<span class="nc" id="L492">            assertThat(historicTasks)</span>
<span class="nc" id="L493">                    .extracting(HistoricTaskInstance::getFormKey)</span>
<span class="nc" id="L494">                    .containsExactly(&quot;testFormKey&quot;);</span>
        }
<span class="nc" id="L496">    }</span>

    @Test
    public void testQueryByFormKeyOr() {
<span class="nc" id="L500">        Task task = taskService.newTask();</span>
<span class="nc" id="L501">        task.setFormKey(&quot;testFormKey&quot;);</span>
<span class="nc" id="L502">        taskService.saveTask(task);</span>
<span class="nc" id="L503">        taskIds.add(task.getId());</span>

<span class="nc" id="L505">        List&lt;Task&gt; tasks = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskFormKey(&quot;testFormKey&quot;).list();</span>
<span class="nc" id="L506">        assertThat(tasks)</span>
<span class="nc" id="L507">                .extracting(Task::getFormKey)</span>
<span class="nc" id="L508">                .containsExactly(&quot;testFormKey&quot;);</span>

<span class="nc bnc" id="L510" title="All 2 branches missed.">        if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L511">            List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery().or()</span>
<span class="nc" id="L512">                    .taskFormKey(&quot;testFormKey&quot;)</span>
<span class="nc" id="L513">                    .list();</span>
<span class="nc" id="L514">            assertThat(historicTasks)</span>
<span class="nc" id="L515">                    .extracting(HistoricTaskInstance::getFormKey)</span>
<span class="nc" id="L516">                    .containsExactly(&quot;testFormKey&quot;);</span>
        }
<span class="nc" id="L518">    }</span>

    @Test
    public void testQueryWithFormKey() {
<span class="nc" id="L522">        Task task = taskService.newTask();</span>
<span class="nc" id="L523">        task.setFormKey(&quot;testFormKey&quot;);</span>
<span class="nc" id="L524">        taskService.saveTask(task);</span>
<span class="nc" id="L525">        taskIds.add(task.getId());</span>

<span class="nc" id="L527">        List&lt;Task&gt; tasks = taskService.createTaskQuery().taskWithFormKey().list();</span>
<span class="nc" id="L528">        assertThat(tasks)</span>
<span class="nc" id="L529">                .extracting(Task::getFormKey)</span>
<span class="nc" id="L530">                .containsExactly(&quot;testFormKey&quot;);</span>

<span class="nc bnc" id="L532" title="All 2 branches missed.">        if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L533">            List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L534">                    .taskWithFormKey()</span>
<span class="nc" id="L535">                    .list();</span>
<span class="nc" id="L536">            assertThat(historicTasks)</span>
<span class="nc" id="L537">                    .extracting(HistoricTaskInstance::getFormKey)</span>
<span class="nc" id="L538">                    .containsExactly(&quot;testFormKey&quot;);</span>
        }
<span class="nc" id="L540">    }</span>

    @Test
    public void testQueryByPriority() {
<span class="nc" id="L544">        TaskQuery query = taskService.createTaskQuery().taskPriority(10);</span>
<span class="nc" id="L545">        assertThat(query.list()).hasSize(2);</span>
<span class="nc" id="L546">        assertThat(query.count()).isEqualTo(2);</span>

<span class="nc" id="L548">        TaskQuery finalQuery = query;</span>
<span class="nc" id="L549">        assertThatThrownBy(() -&gt; finalQuery.singleResult())</span>
<span class="nc" id="L550">                .isExactlyInstanceOf(FlowableException.class);</span>

<span class="nc" id="L552">        query = taskService.createTaskQuery().taskPriority(100);</span>
<span class="nc" id="L553">        assertThat(query.singleResult()).isNull();</span>
<span class="nc" id="L554">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L555">        assertThat(query.count()).isZero();</span>

<span class="nc" id="L557">        query = taskService.createTaskQuery().taskMinPriority(50);</span>
<span class="nc" id="L558">        assertThat(query.list()).hasSize(3);</span>

<span class="nc" id="L560">        query = taskService.createTaskQuery().taskMinPriority(10);</span>
<span class="nc" id="L561">        assertThat(query.list()).hasSize(5);</span>

<span class="nc" id="L563">        query = taskService.createTaskQuery().taskMaxPriority(10);</span>
<span class="nc" id="L564">        assertThat(query.list()).hasSize(9);</span>

<span class="nc" id="L566">        query = taskService.createTaskQuery().taskMaxPriority(3);</span>
<span class="nc" id="L567">        assertThat(query.list()).hasSize(6);</span>
<span class="nc" id="L568">    }</span>

    @Test
    public void testQueryByPriorityOr() {
<span class="nc" id="L572">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskPriority(10);</span>
<span class="nc" id="L573">        assertThat(query.list()).hasSize(2);</span>
<span class="nc" id="L574">        assertThat(query.count()).isEqualTo(2);</span>

<span class="nc" id="L576">        TaskQuery finalQuery = query;</span>
<span class="nc" id="L577">        assertThatThrownBy(() -&gt; finalQuery.singleResult())</span>
<span class="nc" id="L578">                .isExactlyInstanceOf(FlowableException.class);</span>

<span class="nc" id="L580">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskPriority(100);</span>
<span class="nc" id="L581">        assertThat(query.singleResult()).isNull();</span>
<span class="nc" id="L582">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L583">        assertThat(query.count()).isZero();</span>

<span class="nc" id="L585">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskMinPriority(50);</span>
<span class="nc" id="L586">        assertThat(query.list()).hasSize(3);</span>

<span class="nc" id="L588">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskMinPriority(10);</span>
<span class="nc" id="L589">        assertThat(query.list()).hasSize(5);</span>

<span class="nc" id="L591">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskMaxPriority(10);</span>
<span class="nc" id="L592">        assertThat(query.list()).hasSize(9);</span>

<span class="nc" id="L594">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskMaxPriority(3);</span>
<span class="nc" id="L595">        assertThat(query.list()).hasSize(6);</span>
<span class="nc" id="L596">    }</span>

    @Test
    public void testQueryByInvalidPriority() {
<span class="nc" id="L600">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().taskPriority(null))</span>
<span class="nc" id="L601">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L602">    }</span>

    @Test
    public void testQueryByInvalidPriorityOr() {
<span class="nc" id="L606">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskPriority(null))</span>
<span class="nc" id="L607">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L608">    }</span>

    @Test
    public void testQueryByAssignee() {
<span class="nc" id="L612">        TaskQuery query = taskService.createTaskQuery().taskAssignee(&quot;gonzo&quot;);</span>
<span class="nc" id="L613">        assertThat(query.count()).isEqualTo(1);</span>
<span class="nc" id="L614">        assertThat(query.list()).hasSize(1);</span>
<span class="nc" id="L615">        assertThat(query.singleResult()).isNotNull();</span>

<span class="nc" id="L617">        query = taskService.createTaskQuery().taskAssignee(&quot;kermit&quot;);</span>
<span class="nc" id="L618">        assertThat(query.count()).isZero();</span>
<span class="nc" id="L619">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L620">        assertThat(query.singleResult()).isNull();</span>
<span class="nc" id="L621">    }</span>

    @Test
    public void testQueryByAssigneeOr() {
<span class="nc" id="L625">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskAssignee(&quot;gonzo&quot;);</span>
<span class="nc" id="L626">        assertThat(query.count()).isEqualTo(1);</span>
<span class="nc" id="L627">        assertThat(query.list()).hasSize(1);</span>
<span class="nc" id="L628">        assertThat(query.singleResult()).isNotNull();</span>

<span class="nc" id="L630">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskAssignee(&quot;kermit&quot;);</span>
<span class="nc" id="L631">        assertThat(query.count()).isZero();</span>
<span class="nc" id="L632">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L633">        assertThat(query.singleResult()).isNull();</span>
<span class="nc" id="L634">    }</span>

    @Test
    public void testQueryByAssigneeIds() {
<span class="nc" id="L638">        TaskQuery query = taskService.createTaskQuery().taskAssigneeIds(asList(&quot;gonzo&quot;, &quot;kermit&quot;));</span>
<span class="nc" id="L639">        assertThat(query.count()).isEqualTo(1);</span>
<span class="nc" id="L640">        assertThat(query.list()).hasSize(1);</span>
<span class="nc" id="L641">        assertThat(query.singleResult()).isNotNull();</span>

<span class="nc" id="L643">        query = taskService.createTaskQuery().taskAssigneeIds(asList(&quot;kermit&quot;, &quot;kermit2&quot;));</span>
<span class="nc" id="L644">        assertThat(query.count()).isZero();</span>
<span class="nc" id="L645">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L646">        assertThat(query.singleResult()).isNull();</span>

<span class="nc bnc" id="L648" title="All 2 branches missed.">        if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
            // History
<span class="nc" id="L650">            assertThat(historyService.createHistoricTaskInstanceQuery().taskAssigneeIds(asList(&quot;gonzo&quot;, &quot;kermit&quot;)).count()).isEqualTo(1);</span>
<span class="nc" id="L651">            assertThat(historyService.createHistoricTaskInstanceQuery().taskAssigneeIds(asList(&quot;kermit&quot;, &quot;kermit2&quot;)).count()).isZero();</span>
        }

<span class="nc" id="L654">        org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L655">        adhocTask.setName(&quot;test&quot;);</span>
<span class="nc" id="L656">        adhocTask.setAssignee(&quot;testAssignee&quot;);</span>
<span class="nc" id="L657">        taskService.saveTask(adhocTask);</span>

<span class="nc" id="L659">        query = taskService.createTaskQuery().taskAssigneeIds(asList(&quot;gonzo&quot;, &quot;testAssignee&quot;));</span>
<span class="nc" id="L660">        assertThat(query.count()).isEqualTo(2);</span>
<span class="nc" id="L661">        assertThat(query.list()).hasSize(2);</span>

<span class="nc bnc" id="L663" title="All 2 branches missed.">        if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
            // History
<span class="nc" id="L665">            assertThat(historyService.createHistoricTaskInstanceQuery().taskAssigneeIds(asList(&quot;gonzo&quot;, &quot;testAssignee&quot;)).count()).isEqualTo(2);</span>
        }

<span class="nc" id="L668">        taskService.deleteTask(adhocTask.getId(), true);</span>
<span class="nc" id="L669">    }</span>

    @Test
    public void testQueryByAssigneeIdsOr() {
<span class="nc" id="L673">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskAssigneeIds(asList(&quot;gonzo&quot;, &quot;kermit&quot;));</span>
<span class="nc" id="L674">        assertThat(query.count()).isEqualTo(1);</span>
<span class="nc" id="L675">        assertThat(query.list()).hasSize(1);</span>
<span class="nc" id="L676">        assertThat(query.singleResult()).isNotNull();</span>

<span class="nc" id="L678">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskAssigneeIds(asList(&quot;kermit&quot;, &quot;kermit2&quot;));</span>
<span class="nc" id="L679">        assertThat(query.count()).isZero();</span>
<span class="nc" id="L680">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L681">        assertThat(query.singleResult()).isNull();</span>

<span class="nc bnc" id="L683" title="All 2 branches missed.">        if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
            // History
<span class="nc" id="L685">            assertThat(historyService.createHistoricTaskInstanceQuery().or().taskId(&quot;invalid&quot;).taskAssigneeIds(asList(&quot;gonzo&quot;, &quot;kermit&quot;)).count())</span>
<span class="nc" id="L686">                    .isEqualTo(1);</span>
<span class="nc" id="L687">            assertThat(historyService.createHistoricTaskInstanceQuery().or().taskId(&quot;invalid&quot;).taskAssigneeIds(asList(&quot;kermit&quot;, &quot;kermit2&quot;)).count())</span>
<span class="nc" id="L688">                    .isZero();</span>
        }

<span class="nc" id="L691">        org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L692">        adhocTask.setName(&quot;test&quot;);</span>
<span class="nc" id="L693">        adhocTask.setAssignee(&quot;testAssignee&quot;);</span>
<span class="nc" id="L694">        taskService.saveTask(adhocTask);</span>

<span class="nc" id="L696">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskAssigneeIds(asList(&quot;gonzo&quot;, &quot;testAssignee&quot;));</span>
<span class="nc" id="L697">        assertThat(query.count()).isEqualTo(2);</span>
<span class="nc" id="L698">        assertThat(query.list()).hasSize(2);</span>

<span class="nc bnc" id="L700" title="All 2 branches missed.">        if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
            // History
<span class="nc" id="L702">            assertThat(historyService.createHistoricTaskInstanceQuery().or().taskId(&quot;invalid&quot;).taskAssigneeIds(asList(&quot;gonzo&quot;, &quot;testAssignee&quot;)).count())</span>
<span class="nc" id="L703">                    .isEqualTo(2);</span>
        }

<span class="nc" id="L706">        taskService.deleteTask(adhocTask.getId(), true);</span>
<span class="nc" id="L707">    }</span>

    @Test
    public void testQueryByInvolvedUser() {
        try {
<span class="nc" id="L712">            org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L713">            adhocTask.setAssignee(&quot;kermit&quot;);</span>
<span class="nc" id="L714">            adhocTask.setOwner(&quot;fozzie&quot;);</span>
<span class="nc" id="L715">            taskService.saveTask(adhocTask);</span>
<span class="nc" id="L716">            taskService.addUserIdentityLink(adhocTask.getId(), &quot;gonzo&quot;, &quot;customType&quot;);</span>

<span class="nc" id="L718">            assertThat(taskService.getIdentityLinksForTask(adhocTask.getId())).hasSize(3);</span>

<span class="nc" id="L720">            assertThat(taskService.createTaskQuery().taskId(adhocTask.getId()).taskInvolvedUser(&quot;gonzo&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L721">            assertThat(taskService.createTaskQuery().taskId(adhocTask.getId()).taskInvolvedUser(&quot;kermit&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L722">            assertThat(taskService.createTaskQuery().taskId(adhocTask.getId()).taskInvolvedUser(&quot;fozzie&quot;).count()).isEqualTo(1);</span>

<span class="nc bnc" id="L724" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L725">                assertThat(historyService.getHistoricIdentityLinksForTask(adhocTask.getId())).hasSize(3);</span>

<span class="nc" id="L727">                assertThat(historyService.createHistoricTaskInstanceQuery().taskId(adhocTask.getId()).taskInvolvedUser(&quot;gonzo&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L728">                assertThat(historyService.createHistoricTaskInstanceQuery().taskId(adhocTask.getId()).taskInvolvedUser(&quot;kermit&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L729">                assertThat(historyService.createHistoricTaskInstanceQuery().taskId(adhocTask.getId()).taskInvolvedUser(&quot;fozzie&quot;).count()).isEqualTo(1);</span>
            }

        } finally {
<span class="nc" id="L733">            deleteAllTasks();</span>
        }
<span class="nc" id="L735">    }</span>

    @Test
    public void testQueryByInvolvedUserOr() {
        try {
<span class="nc" id="L740">            org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L741">            adhocTask.setAssignee(&quot;kermit&quot;);</span>
<span class="nc" id="L742">            adhocTask.setOwner(&quot;fozzie&quot;);</span>
<span class="nc" id="L743">            taskService.saveTask(adhocTask);</span>
<span class="nc" id="L744">            taskService.addUserIdentityLink(adhocTask.getId(), &quot;gonzo&quot;, &quot;customType&quot;);</span>

<span class="nc" id="L746">            assertThat(taskService.getIdentityLinksForTask(adhocTask.getId())).hasSize(3);</span>

<span class="nc" id="L748">            assertThat(taskService.createTaskQuery().taskId(adhocTask.getId()).or().taskId(&quot;invalid&quot;).taskInvolvedUser(&quot;gonzo&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L749">            assertThat(taskService.createTaskQuery().taskId(adhocTask.getId()).or().taskId(&quot;invalid&quot;).taskInvolvedUser(&quot;kermit&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L750">            assertThat(taskService.createTaskQuery().taskId(adhocTask.getId()).or().taskId(&quot;invalid&quot;).taskInvolvedUser(&quot;fozzie&quot;).count()).isEqualTo(1);</span>

<span class="nc bnc" id="L752" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L753">                assertThat(historyService.createHistoricTaskInstanceQuery().taskId(adhocTask.getId())</span>
<span class="nc" id="L754">                        .or().taskId(&quot;invalid&quot;).taskInvolvedUser(&quot;fozzie&quot;).count()).isEqualTo(1);</span>
            }

        } finally {
<span class="nc" id="L758">            deleteAllTasks();</span>
        }
<span class="nc" id="L760">    }</span>

    @Test
    public void testQueryByInvolvedGroups() {
        try {
<span class="nc" id="L765">            org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L766">            taskService.saveTask(adhocTask);</span>
<span class="nc" id="L767">            taskService.addGroupIdentityLink(adhocTask.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>

<span class="nc" id="L769">            assertThat(taskService.getIdentityLinksForTask(adhocTask.getId())).hasSize(1);</span>

<span class="nc" id="L771">            assertThat(taskService.createTaskQuery().taskId(adhocTask.getId()).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;)).count()).isEqualTo(1);</span>

            // SQL Server has a limit of 2100 on how many parameters a query might have
<span class="nc bnc" id="L774" title="All 2 branches missed.">            int maxGroups = AbstractEngineConfiguration.DATABASE_TYPE_MSSQL.equals(processEngineConfiguration.getDatabaseType()) ? 2050 : 2100;</span>

<span class="nc" id="L776">            List&lt;String&gt; testCandidateGroups = new ArrayList&lt;&gt;(maxGroups);</span>
<span class="nc bnc" id="L777" title="All 2 branches missed.">            for (int i = 0; i &lt; maxGroups; i++) {</span>
<span class="nc" id="L778">                testCandidateGroups.add(&quot;group&quot; + i);</span>
            }
            
<span class="nc" id="L781">            TaskQuery query = taskService.createTaskQuery().taskInvolvedGroups(testCandidateGroups);</span>
<span class="nc" id="L782">            assertThat(query.count()).isEqualTo(0);</span>
<span class="nc" id="L783">            assertThat(query.list()).hasSize(0);</span>
            
<span class="nc" id="L785">            testCandidateGroups.add(&quot;testGroup&quot;);</span>
<span class="nc" id="L786">            query = taskService.createTaskQuery().taskInvolvedGroups(testCandidateGroups);</span>
<span class="nc" id="L787">            assertThat(query.count()).isEqualTo(1);</span>
<span class="nc" id="L788">            assertThat(query.list()).hasSize(1);</span>

<span class="nc bnc" id="L790" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L791">                assertThat(historyService.getHistoricIdentityLinksForTask(adhocTask.getId())).hasSize(1);</span>

<span class="nc" id="L793">                assertThat(historyService.createHistoricTaskInstanceQuery().taskId(adhocTask.getId()).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;)).count()).isEqualTo(1);</span>
            }

        } finally {
<span class="nc" id="L797">            deleteAllTasks();</span>
        }
<span class="nc" id="L799">    }</span>

    @Test
    public void testQueryByInvolvedGroupOr() {
        try {
<span class="nc" id="L804">            org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L805">            adhocTask.setName(&quot;testtask&quot;);</span>
<span class="nc" id="L806">            taskService.saveTask(adhocTask);</span>
<span class="nc" id="L807">            taskService.addGroupIdentityLink(adhocTask.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>

<span class="nc" id="L809">            assertThat(taskService.getIdentityLinksForTask(adhocTask.getId())).hasSize(1);</span>

<span class="nc" id="L811">            assertThat(taskService.createTaskQuery().taskId(adhocTask.getId()).or().taskId(&quot;invalid&quot;).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;))</span>
<span class="nc" id="L812">                    .count()).isEqualTo(1);</span>

            // SQL Server has a limit of 2100 on how many parameters a query might have
<span class="nc bnc" id="L815" title="All 2 branches missed.">            int maxGroups = AbstractEngineConfiguration.DATABASE_TYPE_MSSQL.equals(processEngineConfiguration.getDatabaseType()) ? 2050 : 2100;</span>

<span class="nc" id="L817">            List&lt;String&gt; testCandidateGroups = new ArrayList&lt;&gt;(maxGroups);</span>
<span class="nc bnc" id="L818" title="All 2 branches missed.">            for (int i = 0; i &lt; maxGroups; i++) {</span>
<span class="nc" id="L819">                testCandidateGroups.add(&quot;group&quot; + i);</span>
            }
            
<span class="nc" id="L822">            TaskQuery query = taskService.createTaskQuery().or().taskName(&quot;testtask&quot;).taskInvolvedGroups(testCandidateGroups).endOr();</span>
<span class="nc" id="L823">            assertThat(query.count()).isEqualTo(1);</span>
<span class="nc" id="L824">            assertThat(query.list()).hasSize(1);</span>
            
<span class="nc" id="L826">            query = taskService.createTaskQuery().or().taskName(&quot;undefined&quot;).taskInvolvedGroups(testCandidateGroups).endOr();</span>
<span class="nc" id="L827">            assertThat(query.count()).isEqualTo(0);</span>
<span class="nc" id="L828">            assertThat(query.list()).hasSize(0);</span>

<span class="nc bnc" id="L830" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L831">                assertThat(historyService.createHistoricTaskInstanceQuery().taskId(adhocTask.getId()).or().taskId(&quot;invalid&quot;)</span>
<span class="nc" id="L832">                        .taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;)).count()).isEqualTo(1);</span>
            }

        } finally {
<span class="nc" id="L836">            deleteAllTasks();</span>
        }
<span class="nc" id="L838">    }</span>

    private void deleteAllTasks() {
<span class="nc" id="L841">        List&lt;org.flowable.task.api.Task&gt; allTasks = taskService.createTaskQuery().list();</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">        for (org.flowable.task.api.Task task : allTasks) {</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">            if (task.getExecutionId() == null) {</span>
<span class="nc" id="L844">                taskService.deleteTask(task.getId(), true);</span>
            }
<span class="nc" id="L846">        }</span>

        // Needed for async history mode
<span class="nc" id="L849">        waitForHistoryJobExecutorToProcessAllJobs(10000, 200);</span>
<span class="nc" id="L850">    }</span>

    @Test
    public void testQueryByInvolvedGroupOrAssignee() {
        try {
<span class="nc" id="L855">            org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L856">            taskService.saveTask(adhocTask);</span>
<span class="nc" id="L857">            org.flowable.task.api.Task adhocTask2 = taskService.newTask();</span>
<span class="nc" id="L858">            adhocTask2.setAssignee(&quot;kermit&quot;);</span>
<span class="nc" id="L859">            taskService.saveTask(adhocTask2);</span>
<span class="nc" id="L860">            org.flowable.task.api.Task adhocTask3 = taskService.newTask();</span>
<span class="nc" id="L861">            taskService.saveTask(adhocTask3);</span>
<span class="nc" id="L862">            taskService.addGroupIdentityLink(adhocTask.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>

<span class="nc" id="L864">            assertThat(taskService.getIdentityLinksForTask(adhocTask.getId())).hasSize(1);</span>

<span class="nc" id="L866">            assertThat(taskService.createTaskQuery().or().taskAssignee(&quot;kermit&quot;).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;)).endOr().count())</span>
<span class="nc" id="L867">                    .isEqualTo(2);</span>

<span class="nc bnc" id="L869" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L870">                assertThat(historyService.createHistoricTaskInstanceQuery().</span>
<span class="nc" id="L871">                        or().taskAssignee(&quot;kermit&quot;).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;)).endOr().count()).isEqualTo(2);</span>
            }

        } finally {
<span class="nc" id="L875">            deleteAllTasks();</span>
        }
<span class="nc" id="L877">    }</span>

    @Test
    public void testQueryByInvolvedGroupOrOwner() {
        try {
<span class="nc" id="L882">            org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L883">            taskService.saveTask(adhocTask);</span>
<span class="nc" id="L884">            org.flowable.task.api.Task adhocTask2 = taskService.newTask();</span>
<span class="nc" id="L885">            adhocTask2.setOwner(&quot;kermit&quot;);</span>
<span class="nc" id="L886">            taskService.saveTask(adhocTask2);</span>
<span class="nc" id="L887">            org.flowable.task.api.Task adhocTask3 = taskService.newTask();</span>
<span class="nc" id="L888">            taskService.saveTask(adhocTask3);</span>
<span class="nc" id="L889">            taskService.addGroupIdentityLink(adhocTask.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>

<span class="nc" id="L891">            assertThat(taskService.getIdentityLinksForTask(adhocTask.getId())).hasSize(1);</span>

<span class="nc" id="L893">            assertThat(taskService.createTaskQuery().or().taskOwner(&quot;kermit&quot;).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;)).endOr().count())</span>
<span class="nc" id="L894">                    .isEqualTo(2);</span>

<span class="nc bnc" id="L896" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L897">                assertThat(</span>
<span class="nc" id="L898">                        historyService.createHistoricTaskInstanceQuery().or().taskOwner(&quot;kermit&quot;).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;)).endOr()</span>
<span class="nc" id="L899">                                .count()).isEqualTo(2);</span>
            }

        } finally {
<span class="nc" id="L903">            deleteAllTasks();</span>
        }
<span class="nc" id="L905">    }</span>

    @Test
    public void testQueryByInvolvedGroupAndAssignee() {
        try {
<span class="nc" id="L910">            org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L911">            taskService.saveTask(adhocTask);</span>
<span class="nc" id="L912">            org.flowable.task.api.Task adhocTask2 = taskService.newTask();</span>
<span class="nc" id="L913">            adhocTask2.setAssignee(&quot;kermit&quot;);</span>
<span class="nc" id="L914">            taskService.saveTask(adhocTask2);</span>
<span class="nc" id="L915">            org.flowable.task.api.Task adhocTask3 = taskService.newTask();</span>
<span class="nc" id="L916">            adhocTask3.setAssignee(&quot;kermit&quot;);</span>
<span class="nc" id="L917">            taskService.saveTask(adhocTask3);</span>
<span class="nc" id="L918">            taskService.addGroupIdentityLink(adhocTask.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>
<span class="nc" id="L919">            taskService.addGroupIdentityLink(adhocTask3.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>

<span class="nc" id="L921">            assertThat(taskService.createTaskQuery().taskAssignee(&quot;kermit&quot;).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;)).count()).isEqualTo(1);</span>

<span class="nc bnc" id="L923" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L924">                assertThat(</span>
<span class="nc" id="L925">                        historyService.createHistoricTaskInstanceQuery().taskAssignee(&quot;kermit&quot;).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;)).count())</span>
<span class="nc" id="L926">                        .isEqualTo(1);</span>
            }

        } finally {
<span class="nc" id="L930">            deleteAllTasks();</span>
        }
<span class="nc" id="L932">    }</span>

    @Test
    public void testQueryByInvolvedGroupAndOwner() {
        try {
<span class="nc" id="L937">            org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L938">            taskService.saveTask(adhocTask);</span>
<span class="nc" id="L939">            org.flowable.task.api.Task adhocTask2 = taskService.newTask();</span>
<span class="nc" id="L940">            adhocTask2.setOwner(&quot;kermit&quot;);</span>
<span class="nc" id="L941">            taskService.saveTask(adhocTask2);</span>
<span class="nc" id="L942">            org.flowable.task.api.Task adhocTask3 = taskService.newTask();</span>
<span class="nc" id="L943">            adhocTask3.setOwner(&quot;kermit&quot;);</span>
<span class="nc" id="L944">            taskService.saveTask(adhocTask3);</span>
<span class="nc" id="L945">            taskService.addGroupIdentityLink(adhocTask.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>
<span class="nc" id="L946">            taskService.addGroupIdentityLink(adhocTask3.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>

<span class="nc" id="L948">            assertThat(taskService.getIdentityLinksForTask(adhocTask.getId())).hasSize(1);</span>

<span class="nc" id="L950">            assertThat(taskService.createTaskQuery().taskOwner(&quot;kermit&quot;).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;)).count()).isEqualTo(1);</span>

<span class="nc bnc" id="L952" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L953">                assertThat(historyService.createHistoricTaskInstanceQuery().taskOwner(&quot;kermit&quot;).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;)).count())</span>
<span class="nc" id="L954">                        .isEqualTo(1);</span>
            }

        } finally {
<span class="nc" id="L958">            deleteAllTasks();</span>
        }
<span class="nc" id="L960">    }</span>

    @Test
    public void testQueryByInvolvedGroupAndOwnerLike() {
        try {
<span class="nc" id="L965">            org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L966">            taskService.saveTask(adhocTask);</span>
<span class="nc" id="L967">            org.flowable.task.api.Task adhocTask2 = taskService.newTask();</span>
<span class="nc" id="L968">            adhocTask2.setOwner(&quot;kermit&quot;);</span>
<span class="nc" id="L969">            taskService.saveTask(adhocTask2);</span>
<span class="nc" id="L970">            org.flowable.task.api.Task adhocTask3 = taskService.newTask();</span>
<span class="nc" id="L971">            adhocTask3.setOwner(&quot;kermit&quot;);</span>
<span class="nc" id="L972">            taskService.saveTask(adhocTask3);</span>
<span class="nc" id="L973">            taskService.addGroupIdentityLink(adhocTask.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>
<span class="nc" id="L974">            taskService.addGroupIdentityLink(adhocTask3.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>

<span class="nc" id="L976">            assertThat(taskService.getIdentityLinksForTask(adhocTask.getId())).hasSize(1);</span>

<span class="nc" id="L978">            assertThat(taskService.createTaskQuery().taskOwnerLike(&quot;ker%&quot;).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;)).count()).isEqualTo(1);</span>
<span class="nc bnc" id="L979" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L980">                assertThat(</span>
<span class="nc" id="L981">                        historyService.createHistoricTaskInstanceQuery().taskOwnerLike(&quot;ker%&quot;).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;)).count())</span>
<span class="nc" id="L982">                        .isEqualTo(1);</span>
            }

        } finally {
<span class="nc" id="L986">            deleteAllTasks();</span>
        }
<span class="nc" id="L988">    }</span>

    @Test
    public void testQueryByInvolvedGroupAndAssigneeLike() {
        try {
<span class="nc" id="L993">            org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L994">            taskService.saveTask(adhocTask);</span>
<span class="nc" id="L995">            org.flowable.task.api.Task adhocTask2 = taskService.newTask();</span>
<span class="nc" id="L996">            adhocTask2.setAssignee(&quot;kermit&quot;);</span>
<span class="nc" id="L997">            taskService.saveTask(adhocTask2);</span>
<span class="nc" id="L998">            org.flowable.task.api.Task adhocTask3 = taskService.newTask();</span>
<span class="nc" id="L999">            adhocTask3.setAssignee(&quot;kermit&quot;);</span>
<span class="nc" id="L1000">            taskService.saveTask(adhocTask3);</span>
<span class="nc" id="L1001">            taskService.addGroupIdentityLink(adhocTask.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>
<span class="nc" id="L1002">            taskService.addGroupIdentityLink(adhocTask3.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>

<span class="nc" id="L1004">            assertThat(taskService.getIdentityLinksForTask(adhocTask.getId())).hasSize(1);</span>

<span class="nc" id="L1006">            assertThat(taskService.createTaskQuery().taskAssigneeLike(&quot;ker%&quot;).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;)).count()).isEqualTo(1);</span>

<span class="nc bnc" id="L1008" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L1009">                assertThat(historyService.createHistoricTaskInstanceQuery().taskAssigneeLike(&quot;ker%&quot;).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;))</span>
<span class="nc" id="L1010">                        .count()).isEqualTo(1);</span>
            }

        } finally {
<span class="nc" id="L1014">            deleteAllTasks();</span>
        }
<span class="nc" id="L1016">    }</span>

    @Test
    public void testQueryByInvolvedGroupAndAssigneeIds() {
        try {
<span class="nc" id="L1021">            org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L1022">            taskService.saveTask(adhocTask);</span>
<span class="nc" id="L1023">            org.flowable.task.api.Task adhocTask2 = taskService.newTask();</span>
<span class="nc" id="L1024">            adhocTask2.setAssignee(&quot;kermit&quot;);</span>
<span class="nc" id="L1025">            taskService.saveTask(adhocTask2);</span>
<span class="nc" id="L1026">            org.flowable.task.api.Task adhocTask3 = taskService.newTask();</span>
<span class="nc" id="L1027">            adhocTask3.setAssignee(&quot;kermit&quot;);</span>
<span class="nc" id="L1028">            taskService.saveTask(adhocTask3);</span>
<span class="nc" id="L1029">            taskService.addGroupIdentityLink(adhocTask.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>
<span class="nc" id="L1030">            taskService.addGroupIdentityLink(adhocTask3.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>

<span class="nc" id="L1032">            assertThat(taskService.getIdentityLinksForTask(adhocTask.getId())).hasSize(1);</span>

<span class="nc" id="L1034">            assertThat(taskService.createTaskQuery().taskAssigneeIds(Collections.singletonList(&quot;kermit&quot;)).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;))</span>
<span class="nc" id="L1035">                    .count()).isEqualTo(1);</span>

<span class="nc bnc" id="L1037" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L1038">                assertThat(historyService.createHistoricTaskInstanceQuery().taskAssigneeIds(Collections.singletonList(&quot;kermit&quot;))</span>
<span class="nc" id="L1039">                        .taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;)).count()).isEqualTo(1);</span>
            }

        } finally {
<span class="nc" id="L1043">            deleteAllTasks();</span>
        }
<span class="nc" id="L1045">    }</span>

    @Test
    public void testQueryByInvolvedGroupOrOwnerLike() {
        try {
<span class="nc" id="L1050">            org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L1051">            taskService.saveTask(adhocTask);</span>
<span class="nc" id="L1052">            org.flowable.task.api.Task adhocTask2 = taskService.newTask();</span>
<span class="nc" id="L1053">            adhocTask2.setOwner(&quot;kermit&quot;);</span>
<span class="nc" id="L1054">            taskService.saveTask(adhocTask2);</span>
<span class="nc" id="L1055">            org.flowable.task.api.Task adhocTask3 = taskService.newTask();</span>
<span class="nc" id="L1056">            adhocTask3.setOwner(&quot;kermit&quot;);</span>
<span class="nc" id="L1057">            taskService.saveTask(adhocTask3);</span>
<span class="nc" id="L1058">            taskService.addGroupIdentityLink(adhocTask.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>
<span class="nc" id="L1059">            taskService.addGroupIdentityLink(adhocTask3.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>

<span class="nc" id="L1061">            assertThat(taskService.createTaskQuery()</span>
<span class="nc" id="L1062">                    .or()</span>
<span class="nc" id="L1063">                    .taskOwnerLike(&quot;ker%&quot;).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;))</span>
<span class="nc" id="L1064">                    .endOr()</span>
<span class="nc" id="L1065">                    .count()).isEqualTo(3);</span>

<span class="nc bnc" id="L1067" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L1068">                assertThat(historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1069">                        .or()</span>
<span class="nc" id="L1070">                        .taskOwnerLike(&quot;ker%&quot;).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;))</span>
<span class="nc" id="L1071">                        .endOr()</span>
<span class="nc" id="L1072">                        .count()).isEqualTo(3);</span>
            }

        } finally {
<span class="nc" id="L1076">            deleteAllTasks();</span>
        }
<span class="nc" id="L1078">    }</span>

    @Test
    public void testQueryByInvolvedGroupOrAssigneeLike() {
        try {
<span class="nc" id="L1083">            org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L1084">            taskService.saveTask(adhocTask);</span>
<span class="nc" id="L1085">            org.flowable.task.api.Task adhocTask2 = taskService.newTask();</span>
<span class="nc" id="L1086">            adhocTask2.setAssignee(&quot;kermit&quot;);</span>
<span class="nc" id="L1087">            taskService.saveTask(adhocTask2);</span>
<span class="nc" id="L1088">            org.flowable.task.api.Task adhocTask3 = taskService.newTask();</span>
<span class="nc" id="L1089">            adhocTask3.setAssignee(&quot;kermit&quot;);</span>
<span class="nc" id="L1090">            taskService.saveTask(adhocTask3);</span>
<span class="nc" id="L1091">            taskService.addGroupIdentityLink(adhocTask.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>
<span class="nc" id="L1092">            taskService.addGroupIdentityLink(adhocTask3.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>

<span class="nc" id="L1094">            assertThat(taskService.createTaskQuery()</span>
<span class="nc" id="L1095">                    .or()</span>
<span class="nc" id="L1096">                    .taskAssigneeLike(&quot;ker%&quot;).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;))</span>
<span class="nc" id="L1097">                    .endOr()</span>
<span class="nc" id="L1098">                    .count()).isEqualTo(3);</span>

<span class="nc bnc" id="L1100" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L1101">                assertThat(historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1102">                        .or()</span>
<span class="nc" id="L1103">                        .taskAssigneeLike(&quot;ker%&quot;).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;))</span>
<span class="nc" id="L1104">                        .endOr()</span>
<span class="nc" id="L1105">                        .count()).isEqualTo(3);</span>
            }

        } finally {
<span class="nc" id="L1109">            deleteAllTasks();</span>
        }
<span class="nc" id="L1111">    }</span>

    @Test
    public void testQueryByInvolvedGroupOrAssigneeIds() {
        try {
<span class="nc" id="L1116">            org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L1117">            taskService.saveTask(adhocTask);</span>
<span class="nc" id="L1118">            org.flowable.task.api.Task adhocTask2 = taskService.newTask();</span>
<span class="nc" id="L1119">            adhocTask2.setAssignee(&quot;kermit&quot;);</span>
<span class="nc" id="L1120">            taskService.saveTask(adhocTask2);</span>
<span class="nc" id="L1121">            org.flowable.task.api.Task adhocTask3 = taskService.newTask();</span>
<span class="nc" id="L1122">            adhocTask3.setAssignee(&quot;kermit&quot;);</span>
<span class="nc" id="L1123">            taskService.saveTask(adhocTask3);</span>
<span class="nc" id="L1124">            taskService.addGroupIdentityLink(adhocTask.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>
<span class="nc" id="L1125">            taskService.addGroupIdentityLink(adhocTask3.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>

<span class="nc" id="L1127">            assertThat(taskService.createTaskQuery()</span>
<span class="nc" id="L1128">                    .or()</span>
<span class="nc" id="L1129">                    .taskAssigneeIds(Collections.singletonList(&quot;kermit&quot;)).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;))</span>
<span class="nc" id="L1130">                    .endOr()</span>
<span class="nc" id="L1131">                    .count()).isEqualTo(3);</span>

<span class="nc bnc" id="L1133" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L1134">                assertThat(historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1135">                        .or()</span>
<span class="nc" id="L1136">                        .taskAssigneeIds(Collections.singletonList(&quot;kermit&quot;)).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;))</span>
<span class="nc" id="L1137">                        .endOr()</span>
<span class="nc" id="L1138">                        .count()).isEqualTo(3);</span>
            }

        } finally {
<span class="nc" id="L1142">            deleteAllTasks();</span>
        }
<span class="nc" id="L1144">    }</span>

    @Test
    public void testQueryByInvolvedGroupOrAssigneeId() {
        try {
<span class="nc" id="L1149">            org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L1150">            taskService.saveTask(adhocTask);</span>
<span class="nc" id="L1151">            org.flowable.task.api.Task adhocTask2 = taskService.newTask();</span>
<span class="nc" id="L1152">            adhocTask2.setAssignee(&quot;kermit&quot;);</span>
<span class="nc" id="L1153">            taskService.saveTask(adhocTask2);</span>
<span class="nc" id="L1154">            org.flowable.task.api.Task adhocTask3 = taskService.newTask();</span>
<span class="nc" id="L1155">            adhocTask3.setAssignee(&quot;kermit&quot;);</span>
<span class="nc" id="L1156">            taskService.saveTask(adhocTask3);</span>
<span class="nc" id="L1157">            taskService.addGroupIdentityLink(adhocTask.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>
<span class="nc" id="L1158">            taskService.addGroupIdentityLink(adhocTask3.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>

<span class="nc" id="L1160">            assertThat(taskService.createTaskQuery()</span>
<span class="nc" id="L1161">                    .or()</span>
<span class="nc" id="L1162">                    .taskAssignee(&quot;kermit&quot;).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;))</span>
<span class="nc" id="L1163">                    .endOr()</span>
<span class="nc" id="L1164">                    .count()).isEqualTo(3);</span>

<span class="nc bnc" id="L1166" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L1167">                assertThat(historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1168">                        .or()</span>
<span class="nc" id="L1169">                        .taskAssignee(&quot;kermit&quot;).taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;))</span>
<span class="nc" id="L1170">                        .endOr()</span>
<span class="nc" id="L1171">                        .count()).isEqualTo(3);</span>
            }

        } finally {
<span class="nc" id="L1175">            deleteAllTasks();</span>
        }
<span class="nc" id="L1177">    }</span>

    @Test
    public void testQueryByInvolvedGroupTaskName() {
        try {
<span class="nc" id="L1182">            org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L1183">            taskService.saveTask(adhocTask);</span>
<span class="nc" id="L1184">            org.flowable.task.api.Task adhocTask2 = taskService.newTask();</span>
<span class="nc" id="L1185">            adhocTask2.setName(&quot;testName&quot;);</span>
<span class="nc" id="L1186">            taskService.saveTask(adhocTask2);</span>
<span class="nc" id="L1187">            org.flowable.task.api.Task adhocTask3 = taskService.newTask();</span>
<span class="nc" id="L1188">            taskService.saveTask(adhocTask3);</span>
<span class="nc" id="L1189">            org.flowable.task.api.Task adhocTask4 = taskService.newTask();</span>
<span class="nc" id="L1190">            adhocTask4.setName(&quot;testName&quot;);</span>
<span class="nc" id="L1191">            taskService.saveTask(adhocTask4);</span>
<span class="nc" id="L1192">            taskService.addGroupIdentityLink(adhocTask.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>
<span class="nc" id="L1193">            taskService.addGroupIdentityLink(adhocTask3.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>
<span class="nc" id="L1194">            taskService.addGroupIdentityLink(adhocTask4.getId(), &quot;testGroup&quot;, &quot;customType&quot;);</span>

<span class="nc" id="L1196">            assertThat(taskService.createTaskQuery().</span>
<span class="nc" id="L1197">                    or().</span>
<span class="nc" id="L1198">                    taskName(&quot;testName&quot;).</span>
<span class="nc" id="L1199">                    taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;)).</span>
<span class="nc" id="L1200">                    endOr().</span>
<span class="nc" id="L1201">                    count()).isEqualTo(4);</span>
<span class="nc" id="L1202">            assertThat(taskService.createTaskQuery().</span>
<span class="nc" id="L1203">                    taskName(&quot;testName&quot;).</span>
<span class="nc" id="L1204">                    taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;)).</span>
<span class="nc" id="L1205">                    count()).isEqualTo(1);</span>
<span class="nc bnc" id="L1206" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L1207">                assertThat(historyService.createHistoricTaskInstanceQuery().</span>
<span class="nc" id="L1208">                        or().</span>
<span class="nc" id="L1209">                        taskName(&quot;testName&quot;).</span>
<span class="nc" id="L1210">                        taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;)).</span>
<span class="nc" id="L1211">                        endOr().</span>
<span class="nc" id="L1212">                        count()).isEqualTo(4);</span>
<span class="nc" id="L1213">                assertThat(historyService.createHistoricTaskInstanceQuery().</span>
<span class="nc" id="L1214">                        taskName(&quot;testName&quot;).</span>
<span class="nc" id="L1215">                        taskInvolvedGroups(Collections.singleton(&quot;testGroup&quot;)).</span>
<span class="nc" id="L1216">                        count()).isEqualTo(1);</span>
            }

        } finally {
<span class="nc" id="L1220">            deleteAllTasks();</span>
        }
<span class="nc" id="L1222">    }</span>

    @Test
    public void testQueryByCandidateGroupsTaskName() {
        try {
<span class="nc" id="L1227">            org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L1228">            taskService.saveTask(adhocTask);</span>
<span class="nc" id="L1229">            org.flowable.task.api.Task adhocTask2 = taskService.newTask();</span>
<span class="nc" id="L1230">            adhocTask2.setName(&quot;testName&quot;);</span>
<span class="nc" id="L1231">            taskService.saveTask(adhocTask2);</span>
<span class="nc" id="L1232">            org.flowable.task.api.Task adhocTask3 = taskService.newTask();</span>
<span class="nc" id="L1233">            taskService.saveTask(adhocTask3);</span>
<span class="nc" id="L1234">            org.flowable.task.api.Task adhocTask4 = taskService.newTask();</span>
<span class="nc" id="L1235">            adhocTask4.setName(&quot;testName&quot;);</span>
<span class="nc" id="L1236">            taskService.saveTask(adhocTask4);</span>
<span class="nc" id="L1237">            taskService.addGroupIdentityLink(adhocTask.getId(), &quot;testGroup&quot;, IdentityLinkType.CANDIDATE);</span>
<span class="nc" id="L1238">            taskService.addGroupIdentityLink(adhocTask3.getId(), &quot;testGroup&quot;, IdentityLinkType.CANDIDATE);</span>
<span class="nc" id="L1239">            taskService.addGroupIdentityLink(adhocTask4.getId(), &quot;testGroup&quot;, IdentityLinkType.CANDIDATE);</span>

<span class="nc" id="L1241">            assertThat(taskService.createTaskQuery().</span>
<span class="nc" id="L1242">                    or().</span>
<span class="nc" id="L1243">                    taskName(&quot;testName&quot;).</span>
<span class="nc" id="L1244">                    taskCandidateGroupIn(Collections.singletonList(&quot;testGroup&quot;)).</span>
<span class="nc" id="L1245">                    endOr().</span>
<span class="nc" id="L1246">                    count()).isEqualTo(4);</span>
<span class="nc" id="L1247">            assertThat(taskService.createTaskQuery().</span>
<span class="nc" id="L1248">                    taskName(&quot;testName&quot;).</span>
<span class="nc" id="L1249">                    taskCandidateGroupIn(Collections.singletonList(&quot;testGroup&quot;)).</span>
<span class="nc" id="L1250">                    count()).isEqualTo(1);</span>

<span class="nc bnc" id="L1252" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L1253">                assertThat(historyService.createHistoricTaskInstanceQuery().</span>
<span class="nc" id="L1254">                        or().</span>
<span class="nc" id="L1255">                        taskName(&quot;testName&quot;).</span>
<span class="nc" id="L1256">                        taskCandidateGroupIn(Collections.singletonList(&quot;testGroup&quot;)).</span>
<span class="nc" id="L1257">                        endOr().</span>
<span class="nc" id="L1258">                        count()).isEqualTo(4);</span>
<span class="nc" id="L1259">                assertThat(historyService.createHistoricTaskInstanceQuery().</span>
<span class="nc" id="L1260">                        taskName(&quot;testName&quot;).</span>
<span class="nc" id="L1261">                        taskCandidateGroupIn(Collections.singletonList(&quot;testGroup&quot;)).</span>
<span class="nc" id="L1262">                        count()).isEqualTo(1);</span>
            }

        } finally {
<span class="nc" id="L1266">            deleteAllTasks();</span>
        }
<span class="nc" id="L1268">    }</span>

    @Test
    public void testQueryByCandidateUserTaskName() {
        try {
<span class="nc" id="L1273">            org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L1274">            taskService.saveTask(adhocTask);</span>
<span class="nc" id="L1275">            org.flowable.task.api.Task adhocTask2 = taskService.newTask();</span>
<span class="nc" id="L1276">            adhocTask2.setName(&quot;testName&quot;);</span>
<span class="nc" id="L1277">            taskService.saveTask(adhocTask2);</span>
<span class="nc" id="L1278">            org.flowable.task.api.Task adhocTask3 = taskService.newTask();</span>
<span class="nc" id="L1279">            taskService.saveTask(adhocTask3);</span>
<span class="nc" id="L1280">            org.flowable.task.api.Task adhocTask4 = taskService.newTask();</span>
<span class="nc" id="L1281">            adhocTask4.setName(&quot;testName&quot;);</span>
<span class="nc" id="L1282">            taskService.saveTask(adhocTask4);</span>
<span class="nc" id="L1283">            taskService.addUserIdentityLink(adhocTask.getId(), &quot;homer&quot;, IdentityLinkType.CANDIDATE);</span>
<span class="nc" id="L1284">            taskService.addUserIdentityLink(adhocTask3.getId(), &quot;homer&quot;, IdentityLinkType.CANDIDATE);</span>
<span class="nc" id="L1285">            taskService.addUserIdentityLink(adhocTask4.getId(), &quot;homer&quot;, IdentityLinkType.CANDIDATE);</span>

<span class="nc" id="L1287">            assertThat(taskService.createTaskQuery().</span>
<span class="nc" id="L1288">                    or().</span>
<span class="nc" id="L1289">                    taskName(&quot;testName&quot;).</span>
<span class="nc" id="L1290">                    taskCandidateUser(&quot;homer&quot;).</span>
<span class="nc" id="L1291">                    endOr().</span>
<span class="nc" id="L1292">                    count()).isEqualTo(4);</span>
<span class="nc" id="L1293">            assertThat(taskService.createTaskQuery().</span>
<span class="nc" id="L1294">                    taskName(&quot;testName&quot;).</span>
<span class="nc" id="L1295">                    taskCandidateUser(&quot;homer&quot;).</span>
<span class="nc" id="L1296">                    count()).isEqualTo(1);</span>

<span class="nc bnc" id="L1298" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L1299">                assertThat(historyService.createHistoricTaskInstanceQuery().</span>
<span class="nc" id="L1300">                        or().</span>
<span class="nc" id="L1301">                        taskName(&quot;testName&quot;).</span>
<span class="nc" id="L1302">                        taskCandidateUser(&quot;homer&quot;).</span>
<span class="nc" id="L1303">                        endOr().</span>
<span class="nc" id="L1304">                        count()).isEqualTo(4);</span>
<span class="nc" id="L1305">                assertThat(historyService.createHistoricTaskInstanceQuery().</span>
<span class="nc" id="L1306">                        taskName(&quot;testName&quot;).</span>
<span class="nc" id="L1307">                        taskCandidateUser(&quot;homer&quot;).</span>
<span class="nc" id="L1308">                        count()).isEqualTo(1);</span>
            }

        } finally {
<span class="nc" id="L1312">            deleteAllTasks();</span>
        }
<span class="nc" id="L1314">    }</span>

    @Test
    public void testWithoutCategory() {
<span class="nc" id="L1318">        deleteAllTasks();</span>
        try {
<span class="nc" id="L1320">            saveTaskWithCategory(&quot;t1&quot;, &quot;Cat 1&quot;);</span>
<span class="nc" id="L1321">            saveTaskWithCategory(&quot;t2&quot;, &quot;Cat 1&quot;);</span>
<span class="nc" id="L1322">            saveTaskWithCategory(&quot;t3&quot;, &quot;Cat 2&quot;);</span>
<span class="nc" id="L1323">            saveTaskWithCategory(&quot;t4&quot;, null);</span>
<span class="nc" id="L1324">            saveTaskWithCategory(&quot;t5&quot;, null);</span>

<span class="nc" id="L1326">            List&lt;Task&gt; noResult = taskService.createTaskQuery().taskName(&quot;t1&quot;).taskWithoutCategory().orderByTaskName().asc().list();</span>
<span class="nc" id="L1327">            assertThat(noResult).extracting(Task::getName).isEmpty();</span>

<span class="nc" id="L1329">            List&lt;Task&gt; noCategory = taskService.createTaskQuery().taskWithoutCategory().orderByTaskName().asc().list();</span>
<span class="nc" id="L1330">            assertThat(noCategory).extracting(Task::getName).containsExactly(&quot;t4&quot;, &quot;t5&quot;);</span>

<span class="nc" id="L1332">            List&lt;Task&gt; likeAndNull = taskService.createTaskQuery().taskNameLike(&quot;t%&quot;).taskWithoutCategory().orderByTaskName().asc().list();</span>
<span class="nc" id="L1333">            assertThat(likeAndNull).extracting(Task::getName).containsExactly(&quot;t4&quot;, &quot;t5&quot;);</span>

<span class="nc" id="L1335">            List&lt;Task&gt; t1AndNull = taskService.createTaskQuery().or().taskName(&quot;t1&quot;).taskWithoutCategory().endOr().orderByTaskName().asc().list();</span>
<span class="nc" id="L1336">            assertThat(t1AndNull).extracting(Task::getName).containsExactly(&quot;t1&quot;, &quot;t4&quot;, &quot;t5&quot;);</span>

<span class="nc bnc" id="L1338" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L1339">                assertThat(historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1340">                        .taskName(&quot;t1&quot;)</span>
<span class="nc" id="L1341">                        .taskWithoutCategory()</span>
<span class="nc" id="L1342">                        .orderByTaskName().asc().list())</span>
<span class="nc" id="L1343">                        .extracting(HistoricTaskInstance::getName).isEmpty();</span>

<span class="nc" id="L1345">                assertThat(historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1346">                        .taskWithoutCategory()</span>
<span class="nc" id="L1347">                        .orderByTaskName().asc().list())</span>
<span class="nc" id="L1348">                        .extracting(HistoricTaskInstance::getName).containsExactly(&quot;t4&quot;, &quot;t5&quot;);</span>

<span class="nc" id="L1350">                assertThat(historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1351">                        .taskNameLike(&quot;t%&quot;)</span>
<span class="nc" id="L1352">                        .taskWithoutCategory()</span>
<span class="nc" id="L1353">                        .orderByTaskName().asc().list())</span>
<span class="nc" id="L1354">                        .extracting(HistoricTaskInstance::getName).containsExactly(&quot;t4&quot;, &quot;t5&quot;);</span>

<span class="nc" id="L1356">                assertThat(historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1357">                        .or().taskName(&quot;t1&quot;).taskWithoutCategory().endOr()</span>
<span class="nc" id="L1358">                        .orderByTaskName().asc().list())</span>
<span class="nc" id="L1359">                        .extracting(HistoricTaskInstance::getName).containsExactly(&quot;t1&quot;, &quot;t4&quot;, &quot;t5&quot;);</span>
            }

        } finally {
<span class="nc" id="L1363">            deleteAllTasks();</span>
        }
<span class="nc" id="L1365">    }</span>

    @Test
    public void testQueryByCategoryIn() {
<span class="nc" id="L1369">        deleteAllTasks();</span>
        try {
<span class="nc" id="L1371">            saveTaskWithCategory(&quot;t1&quot;, &quot;Cat 1&quot;);</span>
<span class="nc" id="L1372">            saveTaskWithCategory(&quot;t2&quot;, &quot;Cat 1&quot;);</span>
<span class="nc" id="L1373">            saveTaskWithCategory(&quot;t3&quot;, &quot;Cat 2&quot;);</span>
<span class="nc" id="L1374">            saveTaskWithCategory(&quot;t4&quot;, null);</span>
<span class="nc" id="L1375">            saveTaskWithCategory(&quot;t5&quot;, &quot;Cat 3&quot;);</span>

<span class="nc" id="L1377">            assertThat(taskService.createTaskQuery()</span>
<span class="nc" id="L1378">                    .taskCategoryIn(asList(&quot;Cat 1&quot;))</span>
<span class="nc" id="L1379">                    .orderByTaskName().asc().list())</span>
<span class="nc" id="L1380">                    .extracting(Task::getName)</span>
<span class="nc" id="L1381">                    .containsExactly(&quot;t1&quot;, &quot;t2&quot;);</span>

<span class="nc" id="L1383">            assertThat(taskService.createTaskQuery()</span>
<span class="nc" id="L1384">                    .taskCategoryIn(asList(&quot;Cat 1&quot;, &quot;Cat 2&quot;))</span>
<span class="nc" id="L1385">                    .orderByTaskName().asc().list())</span>
<span class="nc" id="L1386">                    .extracting(Task::getName)</span>
<span class="nc" id="L1387">                    .containsExactly(&quot;t1&quot;, &quot;t2&quot;, &quot;t3&quot;);</span>

<span class="nc" id="L1389">            assertThat(taskService.createTaskQuery()</span>
<span class="nc" id="L1390">                    .taskCategoryIn(asList(&quot;Cat 2&quot;))</span>
<span class="nc" id="L1391">                    .taskWithoutCategory()</span>
<span class="nc" id="L1392">                    .orderByTaskName().asc().list())</span>
<span class="nc" id="L1393">                    .extracting(Task::getName)</span>
<span class="nc" id="L1394">                    .isEmpty();</span>

            // Verify or cases behave like expected
<span class="nc" id="L1397">            assertThat(taskService.createTaskQuery()</span>
<span class="nc" id="L1398">                    .or()</span>
<span class="nc" id="L1399">                    .taskCategory(&quot;Cat 1&quot;)</span>
<span class="nc" id="L1400">                    .taskCategoryIn(asList(&quot;Cat 2&quot;))</span>
<span class="nc" id="L1401">                    .endOr()</span>
<span class="nc" id="L1402">                    .orderByTaskName().asc().list())</span>
<span class="nc" id="L1403">                    .extracting(Task::getName)</span>
<span class="nc" id="L1404">                    .containsExactly(&quot;t1&quot;, &quot;t2&quot;, &quot;t3&quot;);</span>

<span class="nc" id="L1406">            assertThat(taskService.createTaskQuery()</span>
<span class="nc" id="L1407">                    .or()</span>
<span class="nc" id="L1408">                    .taskCategoryIn(asList(&quot;Cat 2&quot;))</span>
<span class="nc" id="L1409">                    .taskName(&quot;t4&quot;)</span>
<span class="nc" id="L1410">                    .endOr()</span>
<span class="nc" id="L1411">                    .orderByTaskName().asc().list())</span>
<span class="nc" id="L1412">                    .extracting(Task::getName).containsExactly(&quot;t3&quot;, &quot;t4&quot;);</span>

<span class="nc" id="L1414">            assertThat(taskService.createTaskQuery()</span>
<span class="nc" id="L1415">                    .or()</span>
<span class="nc" id="L1416">                    .taskWithoutCategory()</span>
<span class="nc" id="L1417">                    .taskCategoryIn(asList(&quot;Cat 2&quot;))</span>
<span class="nc" id="L1418">                    .endOr()</span>
<span class="nc" id="L1419">                    .orderByTaskName().asc().list())</span>
<span class="nc" id="L1420">                    .extracting(Task::getName)</span>
<span class="nc" id="L1421">                    .containsExactly(&quot;t3&quot;, &quot;t4&quot;);</span>

<span class="nc bnc" id="L1423" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L1424">                assertThat(historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1425">                        .taskCategoryIn(asList(&quot;Cat 1&quot;))</span>
<span class="nc" id="L1426">                        .orderByTaskName().asc().list())</span>
<span class="nc" id="L1427">                        .extracting(HistoricTaskInstance::getName)</span>
<span class="nc" id="L1428">                        .containsExactly(&quot;t1&quot;, &quot;t2&quot;);</span>

<span class="nc" id="L1430">                assertThat(historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1431">                        .taskCategoryIn(asList(&quot;Cat 1&quot;, &quot;Cat 2&quot;))</span>
<span class="nc" id="L1432">                        .orderByTaskName().asc().list())</span>
<span class="nc" id="L1433">                        .extracting(HistoricTaskInstance::getName)</span>
<span class="nc" id="L1434">                        .containsExactly(&quot;t1&quot;, &quot;t2&quot;, &quot;t3&quot;);</span>

<span class="nc" id="L1436">                assertThat(historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1437">                        .taskCategoryIn(asList(&quot;Cat 2&quot;))</span>
<span class="nc" id="L1438">                        .taskWithoutCategory()</span>
<span class="nc" id="L1439">                        .orderByTaskName().asc().list())</span>
<span class="nc" id="L1440">                        .extracting(HistoricTaskInstance::getName)</span>
<span class="nc" id="L1441">                        .isEmpty();</span>

                // Verify or cases behave like expected
<span class="nc" id="L1444">                assertThat(historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1445">                        .or()</span>
<span class="nc" id="L1446">                        .taskCategory(&quot;Cat 1&quot;)</span>
<span class="nc" id="L1447">                        .taskCategoryIn(asList(&quot;Cat 2&quot;))</span>
<span class="nc" id="L1448">                        .endOr()</span>
<span class="nc" id="L1449">                        .orderByTaskName().asc().list())</span>
<span class="nc" id="L1450">                        .extracting(HistoricTaskInstance::getName)</span>
<span class="nc" id="L1451">                        .containsExactly(&quot;t1&quot;, &quot;t2&quot;, &quot;t3&quot;);</span>

<span class="nc" id="L1453">                assertThat(historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1454">                        .or()</span>
<span class="nc" id="L1455">                        .taskCategoryIn(asList(&quot;Cat 2&quot;))</span>
<span class="nc" id="L1456">                        .taskName(&quot;t4&quot;)</span>
<span class="nc" id="L1457">                        .endOr()</span>
<span class="nc" id="L1458">                        .orderByTaskName().asc().list())</span>
<span class="nc" id="L1459">                        .extracting(HistoricTaskInstance::getName).containsExactly(&quot;t3&quot;, &quot;t4&quot;);</span>

<span class="nc" id="L1461">                assertThat(historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1462">                        .or()</span>
<span class="nc" id="L1463">                        .taskWithoutCategory()</span>
<span class="nc" id="L1464">                        .taskCategoryIn(asList(&quot;Cat 2&quot;))</span>
<span class="nc" id="L1465">                        .endOr()</span>
<span class="nc" id="L1466">                        .orderByTaskName().asc().list())</span>
<span class="nc" id="L1467">                        .extracting(HistoricTaskInstance::getName)</span>
<span class="nc" id="L1468">                        .containsExactly(&quot;t3&quot;, &quot;t4&quot;);</span>
            }
        } finally {
<span class="nc" id="L1471">            deleteAllTasks();</span>
        }
<span class="nc" id="L1473">    }</span>

    @Test
    public void testQueryByCategoryInIllegalArguments() {
<span class="nc" id="L1477">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().taskCategoryIn(null))</span>
<span class="nc" id="L1478">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L1479">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().taskCategoryIn(Collections.emptyList()))</span>
<span class="nc" id="L1480">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L1481">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().taskCategoryIn(Arrays.asList(&quot;val&quot;, null)))</span>
<span class="nc" id="L1482">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L1483">    }</span>

    @Test
    public void testQueryByCategoryInIllegalArgumentsHistory() {
<span class="nc" id="L1487">        assertThatThrownBy(() -&gt; historyService.createHistoricTaskInstanceQuery().taskCategoryIn(null))</span>
<span class="nc" id="L1488">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L1489">        assertThatThrownBy(() -&gt; historyService.createHistoricTaskInstanceQuery().taskCategoryIn(Collections.emptyList()))</span>
<span class="nc" id="L1490">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L1491">        assertThatThrownBy(() -&gt; historyService.createHistoricTaskInstanceQuery().taskCategoryIn(Arrays.asList(&quot;val&quot;, null)))</span>
<span class="nc" id="L1492">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L1493">    }</span>

    @Test
    public void testQueryByCategoryNotIn() {
<span class="nc" id="L1497">        deleteAllTasks();</span>
        try {
<span class="nc" id="L1499">            saveTaskWithCategory(&quot;t1&quot;, &quot;Cat 1&quot;);</span>
<span class="nc" id="L1500">            saveTaskWithCategory(&quot;t2&quot;, &quot;Cat 1&quot;);</span>
<span class="nc" id="L1501">            saveTaskWithCategory(&quot;t3&quot;, &quot;Cat 2&quot;);</span>
<span class="nc" id="L1502">            saveTaskWithCategory(&quot;t4&quot;, null);</span>
<span class="nc" id="L1503">            saveTaskWithCategory(&quot;t5&quot;, &quot;Cat 3&quot;);</span>

<span class="nc" id="L1505">            assertThat(taskService.createTaskQuery()</span>
<span class="nc" id="L1506">                    .taskCategoryNotIn(asList(&quot;Cat 1&quot;))</span>
<span class="nc" id="L1507">                    .orderByTaskName().asc().list())</span>
<span class="nc" id="L1508">                    .extracting(Task::getName)</span>
<span class="nc" id="L1509">                    .containsExactly(&quot;t3&quot;, &quot;t5&quot;);</span>

<span class="nc" id="L1511">            assertThat(taskService.createTaskQuery()</span>
<span class="nc" id="L1512">                    .taskCategoryNotIn(asList(&quot;Cat 1&quot;, &quot;Cat 2&quot;))</span>
<span class="nc" id="L1513">                    .orderByTaskName().asc().list())</span>
<span class="nc" id="L1514">                    .extracting(Task::getName)</span>
<span class="nc" id="L1515">                    .containsExactly(&quot;t5&quot;);</span>

<span class="nc" id="L1517">            assertThat(taskService.createTaskQuery()</span>
<span class="nc" id="L1518">                    .or()</span>
<span class="nc" id="L1519">                    .taskCategoryNotIn(asList(&quot;Cat 1&quot;, &quot;Cat 2&quot;))</span>
<span class="nc" id="L1520">                    .taskWithoutCategory()</span>
<span class="nc" id="L1521">                    .endOr()</span>
<span class="nc" id="L1522">                    .orderByTaskName().asc().list())</span>
<span class="nc" id="L1523">                    .extracting(Task::getName)</span>
<span class="nc" id="L1524">                    .containsExactly(&quot;t4&quot;, &quot;t5&quot;);</span>

<span class="nc" id="L1526">            assertThat(taskService.createTaskQuery()</span>
<span class="nc" id="L1527">                    .or()</span>
<span class="nc" id="L1528">                    .taskCategoryIn(asList(&quot;Cat 1&quot;))</span>
<span class="nc" id="L1529">                    .taskCategoryNotIn(asList(&quot;Cat 2&quot;))</span>
<span class="nc" id="L1530">                    .endOr()</span>
<span class="nc" id="L1531">                    .orderByTaskName().asc().list())</span>
<span class="nc" id="L1532">                    .extracting(Task::getName)</span>
<span class="nc" id="L1533">                    .containsExactly(&quot;t1&quot;, &quot;t2&quot;, &quot;t5&quot;);</span>

<span class="nc bnc" id="L1535" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L1536">                assertThat(historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1537">                        .taskCategoryNotIn(asList(&quot;Cat 1&quot;))</span>
<span class="nc" id="L1538">                        .orderByTaskName().asc().list())</span>
<span class="nc" id="L1539">                        .extracting(HistoricTaskInstance::getName)</span>
<span class="nc" id="L1540">                        .containsExactly(&quot;t3&quot;, &quot;t5&quot;);</span>

<span class="nc" id="L1542">                assertThat(historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1543">                        .taskCategoryNotIn(asList(&quot;Cat 1&quot;, &quot;Cat 2&quot;))</span>
<span class="nc" id="L1544">                        .orderByTaskName().asc().list())</span>
<span class="nc" id="L1545">                        .extracting(HistoricTaskInstance::getName)</span>
<span class="nc" id="L1546">                        .containsExactly(&quot;t5&quot;);</span>

<span class="nc" id="L1548">                assertThat(historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1549">                        .or()</span>
<span class="nc" id="L1550">                        .taskCategoryNotIn(asList(&quot;Cat 1&quot;, &quot;Cat 2&quot;))</span>
<span class="nc" id="L1551">                        .taskWithoutCategory()</span>
<span class="nc" id="L1552">                        .endOr()</span>
<span class="nc" id="L1553">                        .orderByTaskName().asc().list())</span>
<span class="nc" id="L1554">                        .extracting(HistoricTaskInstance::getName)</span>
<span class="nc" id="L1555">                        .containsExactly(&quot;t4&quot;, &quot;t5&quot;);</span>

<span class="nc" id="L1557">                assertThat(historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L1558">                        .or()</span>
<span class="nc" id="L1559">                        .taskCategoryIn(asList(&quot;Cat 1&quot;))</span>
<span class="nc" id="L1560">                        .taskCategoryNotIn(asList(&quot;Cat 2&quot;))</span>
<span class="nc" id="L1561">                        .endOr()</span>
<span class="nc" id="L1562">                        .orderByTaskName().asc().list())</span>
<span class="nc" id="L1563">                        .extracting(HistoricTaskInstance::getName)</span>
<span class="nc" id="L1564">                        .containsExactly(&quot;t1&quot;, &quot;t2&quot;, &quot;t5&quot;);</span>
            }

        } finally {
<span class="nc" id="L1568">            deleteAllTasks();</span>
        }
<span class="nc" id="L1570">    }</span>

    @Test
    public void testQueryByCategoryNotInIllegalArguments() {
<span class="nc" id="L1574">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().taskCategoryNotIn(null))</span>
<span class="nc" id="L1575">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L1576">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().taskCategoryNotIn(Collections.emptyList()))</span>
<span class="nc" id="L1577">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L1578">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().taskCategoryNotIn(Arrays.asList(&quot;val&quot;, null)))</span>
<span class="nc" id="L1579">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L1580">    }</span>

    private void saveTaskWithCategory(String t1, String category) {
<span class="nc" id="L1583">        Task t1Cat1 = taskService.newTask();</span>
<span class="nc" id="L1584">        t1Cat1.setName(t1);</span>
<span class="nc" id="L1585">        t1Cat1.setCategory(category);</span>
<span class="nc" id="L1586">        taskService.saveTask(t1Cat1);</span>
<span class="nc" id="L1587">    }</span>

    @Test
    public void testQueryByCandidateGroupTaskName() {
        try {
<span class="nc" id="L1592">            org.flowable.task.api.Task adhocTask = taskService.newTask();</span>
<span class="nc" id="L1593">            taskService.saveTask(adhocTask);</span>
<span class="nc" id="L1594">            org.flowable.task.api.Task adhocTask2 = taskService.newTask();</span>
<span class="nc" id="L1595">            adhocTask2.setName(&quot;testName&quot;);</span>
<span class="nc" id="L1596">            taskService.saveTask(adhocTask2);</span>
<span class="nc" id="L1597">            org.flowable.task.api.Task adhocTask3 = taskService.newTask();</span>
<span class="nc" id="L1598">            taskService.saveTask(adhocTask3);</span>
<span class="nc" id="L1599">            org.flowable.task.api.Task adhocTask4 = taskService.newTask();</span>
<span class="nc" id="L1600">            adhocTask4.setName(&quot;testName&quot;);</span>
<span class="nc" id="L1601">            taskService.saveTask(adhocTask4);</span>
<span class="nc" id="L1602">            taskService.addGroupIdentityLink(adhocTask.getId(), &quot;testGroup&quot;, IdentityLinkType.CANDIDATE);</span>
<span class="nc" id="L1603">            taskService.addGroupIdentityLink(adhocTask3.getId(), &quot;testGroup&quot;, IdentityLinkType.CANDIDATE);</span>
<span class="nc" id="L1604">            taskService.addGroupIdentityLink(adhocTask4.getId(), &quot;testGroup&quot;, IdentityLinkType.CANDIDATE);</span>

<span class="nc" id="L1606">            assertThat(taskService.createTaskQuery().</span>
<span class="nc" id="L1607">                    or().</span>
<span class="nc" id="L1608">                    taskName(&quot;testName&quot;).</span>
<span class="nc" id="L1609">                    taskCandidateGroup(&quot;testGroup&quot;).</span>
<span class="nc" id="L1610">                    endOr().</span>
<span class="nc" id="L1611">                    count()).isEqualTo(4);</span>
<span class="nc" id="L1612">            assertThat(taskService.createTaskQuery().</span>
<span class="nc" id="L1613">                    taskName(&quot;testName&quot;).</span>
<span class="nc" id="L1614">                    taskCandidateGroup(&quot;testGroup&quot;).</span>
<span class="nc" id="L1615">                    count()).isEqualTo(1);</span>

<span class="nc bnc" id="L1617" title="All 2 branches missed.">            if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L1618">                assertThat(historyService.createHistoricTaskInstanceQuery().</span>
<span class="nc" id="L1619">                        or().</span>
<span class="nc" id="L1620">                        taskName(&quot;testName&quot;).</span>
<span class="nc" id="L1621">                        taskCandidateGroup(&quot;testGroup&quot;).</span>
<span class="nc" id="L1622">                        endOr().</span>
<span class="nc" id="L1623">                        count()).isEqualTo(4);</span>
<span class="nc" id="L1624">                assertThat(historyService.createHistoricTaskInstanceQuery().</span>
<span class="nc" id="L1625">                        taskName(&quot;testName&quot;).</span>
<span class="nc" id="L1626">                        taskCandidateGroup(&quot;testGroup&quot;).</span>
<span class="nc" id="L1627">                        count()).isEqualTo(1);</span>
            }

        } finally {
<span class="nc" id="L1631">            deleteAllTasks();</span>
        }
<span class="nc" id="L1633">    }</span>

    @Test
    public void testQueryByNullAssignee() {
<span class="nc" id="L1637">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().taskAssignee(null).list())</span>
<span class="nc" id="L1638">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L1639">    }</span>

    @Test
    public void testQueryByNullAssigneeOr() {
<span class="nc" id="L1643">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskAssignee(null).list())</span>
<span class="nc" id="L1644">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L1645">    }</span>

    @Test
    public void testQueryByUnassigned() {
<span class="nc" id="L1649">        TaskQuery query = taskService.createTaskQuery().taskUnassigned();</span>
<span class="nc" id="L1650">        assertThat(query.count()).isEqualTo(11);</span>
<span class="nc" id="L1651">        assertThat(query.list()).hasSize(11);</span>
<span class="nc" id="L1652">    }</span>

    @Test
    public void testQueryByUnassignedOr() {
<span class="nc" id="L1656">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskUnassigned();</span>
<span class="nc" id="L1657">        assertThat(query.count()).isEqualTo(11);</span>
<span class="nc" id="L1658">        assertThat(query.list()).hasSize(11);</span>
<span class="nc" id="L1659">    }</span>
    
    @Test
    public void testQueryByAssigned() {
<span class="nc" id="L1663">        TaskQuery query = taskService.createTaskQuery().taskAssigned();</span>
<span class="nc" id="L1664">        assertThat(query.count()).isEqualTo(1);</span>
<span class="nc" id="L1665">        assertThat(query.list()).hasSize(1);</span>
<span class="nc" id="L1666">    }</span>

    @Test
    public void testQueryByAssignedOr() {
<span class="nc" id="L1670">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskAssigned();</span>
<span class="nc" id="L1671">        assertThat(query.count()).isEqualTo(1);</span>
<span class="nc" id="L1672">        assertThat(query.list()).hasSize(1);</span>
<span class="nc" id="L1673">    }</span>

    @Test
    public void testQueryByCandidateUser() {
<span class="nc" id="L1677">        TaskQuery query = taskService.createTaskQuery().taskCandidateUser(&quot;kermit&quot;);</span>
<span class="nc" id="L1678">        assertThat(query.count()).isEqualTo(11);</span>
<span class="nc" id="L1679">        assertThat(query.list()).hasSize(11);</span>
<span class="nc" id="L1680">        TaskQuery finalQuery = query;</span>
<span class="nc" id="L1681">        assertThatThrownBy(() -&gt; finalQuery.singleResult())</span>
<span class="nc" id="L1682">                .isExactlyInstanceOf(FlowableException.class);</span>

<span class="nc" id="L1684">        query = taskService.createTaskQuery().taskCandidateUser(&quot;fozzie&quot;);</span>
<span class="nc" id="L1685">        assertThat(query.count()).isEqualTo(3);</span>
<span class="nc" id="L1686">        assertThat(query.list()).hasSize(3);</span>
<span class="nc" id="L1687">        TaskQuery finalQuery2 = query;</span>
<span class="nc" id="L1688">        assertThatThrownBy(() -&gt; finalQuery2.singleResult())</span>
<span class="nc" id="L1689">                .isExactlyInstanceOf(FlowableException.class);</span>
<span class="nc" id="L1690">    }</span>

    @Test
    public void testQueryByCandidateUserOr() {
<span class="nc" id="L1694">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskCandidateUser(&quot;kermit&quot;);</span>
<span class="nc" id="L1695">        assertThat(query.count()).isEqualTo(11);</span>
<span class="nc" id="L1696">        assertThat(query.list()).hasSize(11);</span>
<span class="nc" id="L1697">        TaskQuery finalQuery = query;</span>
<span class="nc" id="L1698">        assertThatThrownBy(() -&gt; finalQuery.singleResult())</span>
<span class="nc" id="L1699">                .isExactlyInstanceOf(FlowableException.class);</span>

<span class="nc" id="L1701">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskCandidateUser(&quot;fozzie&quot;);</span>
<span class="nc" id="L1702">        assertThat(query.count()).isEqualTo(3);</span>
<span class="nc" id="L1703">        assertThat(query.list()).hasSize(3);</span>
<span class="nc" id="L1704">        TaskQuery finalQuery2 = query;</span>
<span class="nc" id="L1705">        assertThatThrownBy(() -&gt; finalQuery2.singleResult())</span>
<span class="nc" id="L1706">                .isExactlyInstanceOf(FlowableException.class);</span>
<span class="nc" id="L1707">    }</span>

    @Test
    public void testQueryByNullCandidateUser() {
<span class="nc" id="L1711">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().taskCandidateUser(null).list())</span>
<span class="nc" id="L1712">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L1713">    }</span>

    @Test
    public void testQueryByNullCandidateUserOr() {
<span class="nc" id="L1717">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskCandidateUser(null).list())</span>
<span class="nc" id="L1718">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L1719">    }</span>

    @Test
    public void testQueryByCandidateGroup() {
<span class="nc" id="L1723">        TaskQuery query = taskService.createTaskQuery().taskCandidateGroup(&quot;management&quot;);</span>
<span class="nc" id="L1724">        assertThat(query.count()).isEqualTo(3);</span>
<span class="nc" id="L1725">        assertThat(query.list()).hasSize(3);</span>
<span class="nc" id="L1726">        TaskQuery finalQuery = query;</span>
<span class="nc" id="L1727">        assertThatThrownBy(() -&gt; finalQuery.singleResult())</span>
<span class="nc" id="L1728">                .isExactlyInstanceOf(FlowableException.class);</span>

<span class="nc" id="L1730">        query = taskService.createTaskQuery().taskCandidateGroup(&quot;sales&quot;);</span>
<span class="nc" id="L1731">        assertThat(query.count()).isZero();</span>
<span class="nc" id="L1732">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L1733">    }</span>

    @Test
    public void testQueryByCandidateGroupOr() {
<span class="nc" id="L1737">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskCandidateGroup(&quot;management&quot;);</span>
<span class="nc" id="L1738">        assertThat(query.count()).isEqualTo(3);</span>
<span class="nc" id="L1739">        assertThat(query.list()).hasSize(3);</span>
<span class="nc" id="L1740">        TaskQuery finalQuery = query;</span>
<span class="nc" id="L1741">        assertThatThrownBy(() -&gt; finalQuery.singleResult())</span>
<span class="nc" id="L1742">                .isExactlyInstanceOf(FlowableException.class);</span>

<span class="nc" id="L1744">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskCandidateGroup(&quot;sales&quot;);</span>
<span class="nc" id="L1745">        assertThat(query.count()).isZero();</span>
<span class="nc" id="L1746">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L1747">    }</span>

    @Test
    public void testQueryByCandidateOrAssigned() {
<span class="nc" id="L1751">        TaskQuery query = taskService.createTaskQuery().taskCandidateOrAssigned(&quot;kermit&quot;);</span>
<span class="nc" id="L1752">        assertThat(query.count()).isEqualTo(11);</span>
<span class="nc" id="L1753">        List&lt;org.flowable.task.api.Task&gt; tasks = query.list();</span>
<span class="nc" id="L1754">        assertThat(tasks).hasSize(11);</span>

        // if dbIdentityUsed set false in process engine configuration of using
        // custom session factory of GroupIdentityManager
<span class="nc" id="L1758">        List&lt;String&gt; candidateGroups = Arrays.asList(&quot;management&quot;, &quot;accountancy&quot;, &quot;noexist&quot;);</span>
<span class="nc" id="L1759">        query = taskService.createTaskQuery().taskCandidateGroupIn(candidateGroups).taskCandidateOrAssigned(&quot;kermit&quot;);</span>
<span class="nc" id="L1760">        assertThat(query.count()).isEqualTo(11);</span>
<span class="nc" id="L1761">        tasks = query.list();</span>
<span class="nc" id="L1762">        assertThat(tasks).hasSize(11);</span>

<span class="nc" id="L1764">        query = taskService.createTaskQuery().taskCandidateOrAssigned(&quot;fozzie&quot;);</span>
<span class="nc" id="L1765">        assertThat(query.count()).isEqualTo(3);</span>
<span class="nc" id="L1766">        assertThat(query.list()).hasSize(3);</span>

        // create a new task that no identity link and assignee to kermit
<span class="nc" id="L1769">        org.flowable.task.api.Task task = taskService.newTask();</span>
<span class="nc" id="L1770">        task.setName(&quot;assigneeToKermit&quot;);</span>
<span class="nc" id="L1771">        task.setDescription(&quot;testTask description&quot;);</span>
<span class="nc" id="L1772">        task.setPriority(3);</span>
<span class="nc" id="L1773">        task.setAssignee(&quot;kermit&quot;);</span>
<span class="nc" id="L1774">        taskService.saveTask(task);</span>

<span class="nc" id="L1776">        query = taskService.createTaskQuery().taskCandidateOrAssigned(&quot;kermit&quot;);</span>
<span class="nc" id="L1777">        assertThat(query.count()).isEqualTo(12);</span>
<span class="nc" id="L1778">        tasks = query.list();</span>
<span class="nc" id="L1779">        assertThat(tasks).hasSize(12);</span>

<span class="nc" id="L1781">        query = taskService.createTaskQuery().taskCandidateOrAssigned(&quot;invalid&quot;);</span>
<span class="nc" id="L1782">        assertThat(query.count()).isEqualTo(0);</span>
<span class="nc" id="L1783">        tasks = query.list();</span>
<span class="nc" id="L1784">        assertThat(tasks).isEmpty();</span>

        // SQL Server has a limit of 2100 on how many parameters a query might have
<span class="nc bnc" id="L1787" title="All 2 branches missed.">        int maxGroups = AbstractEngineConfiguration.DATABASE_TYPE_MSSQL.equals(processEngineConfiguration.getDatabaseType()) ? 2050 : 2100;</span>

<span class="nc" id="L1789">        List&lt;String&gt; testCandidateGroups = new ArrayList&lt;&gt;(maxGroups);</span>
<span class="nc bnc" id="L1790" title="All 2 branches missed.">        for (int i = 0; i &lt; maxGroups; i++) {</span>
<span class="nc" id="L1791">            testCandidateGroups.add(&quot;group&quot; + i);</span>
        }
        
<span class="nc" id="L1794">        query = taskService.createTaskQuery().taskCandidateGroupIn(testCandidateGroups).taskCandidateOrAssigned(&quot;kermit&quot;);</span>
<span class="nc" id="L1795">        assertThat(query.count()).isEqualTo(7);</span>
<span class="nc" id="L1796">        assertThat(query.list()).hasSize(7);</span>
        
<span class="nc" id="L1798">        testCandidateGroups.add(&quot;management&quot;);</span>
<span class="nc" id="L1799">        query = taskService.createTaskQuery().taskCandidateGroupIn(testCandidateGroups).taskCandidateOrAssigned(&quot;kermit&quot;);</span>
<span class="nc" id="L1800">        assertThat(query.count()).isEqualTo(10);</span>
<span class="nc" id="L1801">        assertThat(query.list()).hasSize(10);</span>

<span class="nc" id="L1803">        org.flowable.task.api.Task assigneeToKermit = taskService.createTaskQuery().taskName(&quot;assigneeToKermit&quot;).singleResult();</span>
<span class="nc" id="L1804">        taskService.deleteTask(assigneeToKermit.getId(), true);</span>
<span class="nc" id="L1805">    }</span>

    @Test
    public void testQueryByCandidateOrAssignedOr() {
<span class="nc" id="L1809">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskCandidateOrAssigned(&quot;kermit&quot;);</span>
<span class="nc" id="L1810">        assertThat(query.count()).isEqualTo(11);</span>
<span class="nc" id="L1811">        List&lt;org.flowable.task.api.Task&gt; tasks = query.list();</span>
<span class="nc" id="L1812">        assertThat(tasks).hasSize(11);</span>

        // if dbIdentityUsed set false in process engine configuration of using
        // custom session factory of GroupIdentityManager
<span class="nc" id="L1816">        List&lt;String&gt; candidateGroups = Arrays.asList(&quot;management&quot;, &quot;accountancy&quot;, &quot;noexist&quot;);</span>
<span class="nc" id="L1817">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskCandidateGroupIn(candidateGroups).taskCandidateOrAssigned(&quot;kermit&quot;);</span>
<span class="nc" id="L1818">        assertThat(query.count()).isEqualTo(11);</span>
<span class="nc" id="L1819">        tasks = query.list();</span>
<span class="nc" id="L1820">        assertThat(tasks).hasSize(11);</span>

<span class="nc" id="L1822">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskCandidateOrAssigned(&quot;fozzie&quot;);</span>
<span class="nc" id="L1823">        assertThat(query.count()).isEqualTo(3);</span>
<span class="nc" id="L1824">        assertThat(query.list()).hasSize(3);</span>

        // create a new task that no identity link and assignee to kermit
<span class="nc" id="L1827">        org.flowable.task.api.Task task = taskService.newTask();</span>
<span class="nc" id="L1828">        task.setName(&quot;assigneeToKermit&quot;);</span>
<span class="nc" id="L1829">        task.setDescription(&quot;testTask description&quot;);</span>
<span class="nc" id="L1830">        task.setPriority(3);</span>
<span class="nc" id="L1831">        task.setAssignee(&quot;kermit&quot;);</span>
<span class="nc" id="L1832">        taskService.saveTask(task);</span>

<span class="nc" id="L1834">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskCandidateOrAssigned(&quot;kermit&quot;);</span>
<span class="nc" id="L1835">        assertThat(query.count()).isEqualTo(12);</span>
<span class="nc" id="L1836">        tasks = query.list();</span>
<span class="nc" id="L1837">        assertThat(tasks).hasSize(12);</span>

<span class="nc" id="L1839">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskCandidateOrAssigned(&quot;invalid&quot;);</span>
<span class="nc" id="L1840">        assertThat(query.count()).isEqualTo(0);</span>
<span class="nc" id="L1841">        tasks = query.list();</span>
<span class="nc" id="L1842">        assertThat(tasks).isEmpty();</span>

        // SQL Server has a limit of 2100 on how many parameters a query might have
<span class="nc bnc" id="L1845" title="All 2 branches missed.">        int maxGroups = AbstractEngineConfiguration.DATABASE_TYPE_MSSQL.equals(processEngineConfiguration.getDatabaseType()) ? 2050 : 2100;</span>

<span class="nc" id="L1847">        List&lt;String&gt; testCandidateGroups = new ArrayList&lt;&gt;(maxGroups);</span>
<span class="nc bnc" id="L1848" title="All 2 branches missed.">        for (int i = 0; i &lt; maxGroups; i++) {</span>
<span class="nc" id="L1849">            testCandidateGroups.add(&quot;group&quot; + i);</span>
        }
        
<span class="nc" id="L1852">        query = taskService.createTaskQuery().or().taskName(&quot;testTask&quot;).taskCandidateGroupIn(testCandidateGroups).taskCandidateOrAssigned(&quot;kermit&quot;).endOr();</span>
<span class="nc" id="L1853">        assertThat(query.count()).isEqualTo(7);</span>
<span class="nc" id="L1854">        assertThat(query.list()).hasSize(7);</span>
        
<span class="nc" id="L1856">        testCandidateGroups.add(&quot;management&quot;);</span>
<span class="nc" id="L1857">        query = taskService.createTaskQuery().or().taskName(&quot;unexisting&quot;).taskCandidateGroupIn(testCandidateGroups).taskCandidateOrAssigned(&quot;kermit&quot;).endOr();</span>
<span class="nc" id="L1858">        assertThat(query.count()).isEqualTo(10);</span>
<span class="nc" id="L1859">        assertThat(query.list()).hasSize(10);</span>

<span class="nc" id="L1861">        org.flowable.task.api.Task assigneeToKermit = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskName(&quot;assigneeToKermit&quot;).singleResult();</span>
<span class="nc" id="L1862">        taskService.deleteTask(assigneeToKermit.getId(), true);</span>
<span class="nc" id="L1863">    }</span>
    
    @Test
    public void testQueryIgnoreAssigneeValue() {
<span class="nc" id="L1867">        List&lt;String&gt; createdTasks = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1868">        Task kermitAssigneeTask = taskService.newTask();</span>
<span class="nc" id="L1869">        kermitAssigneeTask.setName(&quot;new kermit assignee task&quot;);</span>
<span class="nc" id="L1870">        taskService.saveTask(kermitAssigneeTask);</span>
<span class="nc" id="L1871">        taskService.setAssignee(kermitAssigneeTask.getId(), &quot;kermit&quot;);</span>
<span class="nc" id="L1872">        createdTasks.add(kermitAssigneeTask.getId());</span>

<span class="nc" id="L1874">        Task managementTask = taskService.newTask();</span>
<span class="nc" id="L1875">        managementTask.setName(&quot;new management task&quot;);</span>
<span class="nc" id="L1876">        taskService.saveTask(managementTask);</span>
<span class="nc" id="L1877">        taskService.setAssignee(managementTask.getId(), &quot;gozzie&quot;);</span>
<span class="nc" id="L1878">        taskService.addCandidateGroup(managementTask.getId(), &quot;management&quot;);</span>
<span class="nc" id="L1879">        createdTasks.add(managementTask.getId());</span>


<span class="nc" id="L1882">        List&lt;Task&gt; kermitCandidateTasks = taskService.createTaskQuery()</span>
<span class="nc" id="L1883">                .taskCandidateUser(&quot;kermit&quot;)</span>
<span class="nc" id="L1884">                .taskName(&quot;testTask&quot;)</span>
<span class="nc" id="L1885">                .list();</span>

<span class="nc bnc" id="L1887" title="All 2 branches missed.">        for (Task t : kermitCandidateTasks) {</span>
<span class="nc" id="L1888">            taskService.setAssignee(t.getId(), &quot;gonzo&quot;);</span>
<span class="nc" id="L1889">        }</span>

<span class="nc" id="L1891">        List&lt;Task&gt; tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L1892">                .taskCandidateUser(&quot;kermit&quot;)</span>
<span class="nc" id="L1893">                .list();</span>
<span class="nc" id="L1894">        assertThat(tasks).hasSize(5);</span>

<span class="nc" id="L1896">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L1897">                .taskCandidateUser(&quot;kermit&quot;)</span>
<span class="nc" id="L1898">                .ignoreAssigneeValue()</span>
<span class="nc" id="L1899">                .list();</span>
<span class="nc" id="L1900">        assertThat(tasks).hasSize(12);</span>
        
<span class="nc" id="L1902">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L1903">                .taskCandidateGroup(&quot;management&quot;)</span>
<span class="nc" id="L1904">                .ignoreAssigneeValue()</span>
<span class="nc" id="L1905">                .list();</span>
<span class="nc" id="L1906">        assertThat(tasks).hasSize(4);</span>
        
<span class="nc" id="L1908">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L1909">                .taskCandidateGroup(&quot;management&quot;)</span>
<span class="nc" id="L1910">                .list();</span>
<span class="nc" id="L1911">        assertThat(tasks).hasSize(3);</span>
        
<span class="nc" id="L1913">        List&lt;String&gt; candidateGroups = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1914">        candidateGroups.add(&quot;management&quot;);</span>
<span class="nc" id="L1915">        candidateGroups.add(&quot;accountancy&quot;);</span>
<span class="nc" id="L1916">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L1917">                .taskCandidateGroupIn(candidateGroups)</span>
<span class="nc" id="L1918">                .ignoreAssigneeValue()</span>
<span class="nc" id="L1919">                .list();</span>
<span class="nc" id="L1920">        assertThat(tasks).hasSize(6);</span>
        
<span class="nc" id="L1922">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L1923">                .taskCandidateGroupIn(candidateGroups)</span>
<span class="nc" id="L1924">                .list();</span>
<span class="nc" id="L1925">        assertThat(tasks).hasSize(5);</span>

<span class="nc" id="L1927">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L1928">                .taskCandidateOrAssigned(&quot;kermit&quot;)</span>
<span class="nc" id="L1929">                .list();</span>
<span class="nc" id="L1930">        assertThat(tasks).hasSize(6);</span>

<span class="nc" id="L1932">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L1933">                .taskCandidateOrAssigned(&quot;kermit&quot;)</span>
<span class="nc" id="L1934">                .ignoreAssigneeValue()</span>
<span class="nc" id="L1935">                .list();</span>
<span class="nc" id="L1936">        assertThat(tasks).hasSize(13);</span>

<span class="nc" id="L1938">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L1939">                .taskCandidateOrAssigned(&quot;gonzo&quot;)</span>
<span class="nc" id="L1940">                .taskCandidateGroup(&quot;management&quot;)</span>
<span class="nc" id="L1941">                .list();</span>
<span class="nc" id="L1942">        assertThat(tasks).hasSize(10);</span>

<span class="nc" id="L1944">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L1945">                .taskCandidateOrAssigned(&quot;gonzo&quot;)</span>
<span class="nc" id="L1946">                .taskCandidateGroup(&quot;management&quot;)</span>
<span class="nc" id="L1947">                .ignoreAssigneeValue()</span>
<span class="nc" id="L1948">                .list();</span>
<span class="nc" id="L1949">        assertThat(tasks).hasSize(11);</span>

<span class="nc" id="L1951">        taskService.deleteTasks(createdTasks, true);</span>
<span class="nc" id="L1952">    }</span>

    @Test
    public void testQueryIgnoreAssigneeValueOr() {
<span class="nc" id="L1956">        List&lt;String&gt; createdTasks = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1957">        Task kermitAssigneeTask = taskService.newTask();</span>
<span class="nc" id="L1958">        kermitAssigneeTask.setName(&quot;new kermit assignee task&quot;);</span>
<span class="nc" id="L1959">        taskService.saveTask(kermitAssigneeTask);</span>
<span class="nc" id="L1960">        taskService.setAssignee(kermitAssigneeTask.getId(), &quot;kermit&quot;);</span>
<span class="nc" id="L1961">        createdTasks.add(kermitAssigneeTask.getId());</span>

<span class="nc" id="L1963">        Task magementTask = taskService.newTask();</span>
<span class="nc" id="L1964">        magementTask.setName(&quot;new management task&quot;);</span>
<span class="nc" id="L1965">        taskService.saveTask(magementTask);</span>
<span class="nc" id="L1966">        taskService.setAssignee(magementTask.getId(), &quot;gozzie&quot;);</span>
<span class="nc" id="L1967">        taskService.addCandidateGroup(magementTask.getId(), &quot;management&quot;);</span>
<span class="nc" id="L1968">        createdTasks.add(magementTask.getId());</span>

<span class="nc" id="L1970">        List&lt;Task&gt; kermitCandidateTasks = taskService.createTaskQuery()</span>
<span class="nc" id="L1971">                .taskCandidateUser(&quot;kermit&quot;)</span>
<span class="nc" id="L1972">                .taskName(&quot;testTask&quot;)</span>
<span class="nc" id="L1973">                .list();</span>

<span class="nc bnc" id="L1975" title="All 2 branches missed.">        for (Task t : kermitCandidateTasks) {</span>
<span class="nc" id="L1976">            taskService.setAssignee(t.getId(), &quot;gonzo&quot;);</span>
<span class="nc" id="L1977">        }</span>

<span class="nc" id="L1979">        List&lt;Task&gt; tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L1980">                .or()</span>
<span class="nc" id="L1981">                .taskCandidateUser(&quot;kermit&quot;)</span>
<span class="nc" id="L1982">                .taskCandidateGroup(&quot;management&quot;)</span>
<span class="nc" id="L1983">                .endOr()</span>
<span class="nc" id="L1984">                .list();</span>
<span class="nc" id="L1985">        assertThat(tasks).hasSize(3);</span>

<span class="nc" id="L1987">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L1988">                .or()</span>
<span class="nc" id="L1989">                .taskCandidateUser(&quot;kermit&quot;)</span>
<span class="nc" id="L1990">                .taskCandidateGroup(&quot;management&quot;)</span>
<span class="nc" id="L1991">                .ignoreAssigneeValue()</span>
<span class="nc" id="L1992">                .endOr()</span>
<span class="nc" id="L1993">                .list();</span>
<span class="nc" id="L1994">        assertThat(tasks).hasSize(10);</span>

<span class="nc" id="L1996">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L1997">                .or()</span>
<span class="nc" id="L1998">                .taskCandidateOrAssigned(&quot;kermit&quot;)</span>
<span class="nc" id="L1999">                .endOr()</span>
<span class="nc" id="L2000">                .list();</span>
<span class="nc" id="L2001">        assertThat(tasks).hasSize(6);</span>

<span class="nc" id="L2003">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L2004">                .or()</span>
<span class="nc" id="L2005">                .taskCandidateOrAssigned(&quot;kermit&quot;)</span>
<span class="nc" id="L2006">                .ignoreAssigneeValue()</span>
<span class="nc" id="L2007">                .endOr()</span>
<span class="nc" id="L2008">                .list();</span>
<span class="nc" id="L2009">        assertThat(tasks).hasSize(13);</span>

<span class="nc" id="L2011">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L2012">                .or()</span>
<span class="nc" id="L2013">                .taskCandidateOrAssigned(&quot;gonzo&quot;)</span>
<span class="nc" id="L2014">                .taskCandidateGroup(&quot;management&quot;)</span>
<span class="nc" id="L2015">                .endOr()</span>
<span class="nc" id="L2016">                .list();</span>
<span class="nc" id="L2017">        assertThat(tasks).hasSize(10);</span>

<span class="nc" id="L2019">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L2020">                .or()</span>
<span class="nc" id="L2021">                .taskCandidateOrAssigned(&quot;gonzo&quot;)</span>
<span class="nc" id="L2022">                .taskCandidateGroup(&quot;management&quot;)</span>
<span class="nc" id="L2023">                .ignoreAssigneeValue()</span>
<span class="nc" id="L2024">                .endOr()</span>
<span class="nc" id="L2025">                .list();</span>
<span class="nc" id="L2026">        assertThat(tasks).hasSize(11);</span>

<span class="nc" id="L2028">        taskService.deleteTasks(createdTasks, true);</span>
<span class="nc" id="L2029">    }</span>

    @Test
    public void testQueryByNullCandidateGroup() {
<span class="nc" id="L2033">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().taskCandidateGroup(null).list())</span>
<span class="nc" id="L2034">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L2035">    }</span>

    @Test
    public void testQueryByNullCandidateGroupOr() {
<span class="nc" id="L2039">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskCandidateGroup(null).list())</span>
<span class="nc" id="L2040">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L2041">    }</span>

    @Test
    public void testQueryByCandidateGroupIn() {
<span class="nc" id="L2045">        List&lt;String&gt; groups = Arrays.asList(&quot;management&quot;, &quot;accountancy&quot;);</span>
<span class="nc" id="L2046">        TaskQuery query = taskService.createTaskQuery().taskCandidateGroupIn(groups);</span>
<span class="nc" id="L2047">        assertThat(query.count()).isEqualTo(5);</span>
<span class="nc" id="L2048">        assertThat(query.list()).hasSize(5);</span>

<span class="nc" id="L2050">        TaskQuery finalQuery = query;</span>
<span class="nc" id="L2051">        assertThatThrownBy(() -&gt; finalQuery.singleResult())</span>
<span class="nc" id="L2052">                .isExactlyInstanceOf(FlowableException.class);</span>

<span class="nc" id="L2054">        query = taskService.createTaskQuery().taskCandidateUser(&quot;kermit&quot;).taskCandidateGroupIn(groups);</span>
<span class="nc" id="L2055">        assertThat(query.count()).isEqualTo(11);</span>
<span class="nc" id="L2056">        assertThat(query.list()).hasSize(11);</span>

<span class="nc" id="L2058">        query = taskService.createTaskQuery().taskCandidateUser(&quot;kermit&quot;).taskCandidateGroup(&quot;unexisting&quot;);</span>
<span class="nc" id="L2059">        assertThat(query.count()).isEqualTo(6);</span>
<span class="nc" id="L2060">        assertThat(query.list()).hasSize(6);</span>

<span class="nc" id="L2062">        query = taskService.createTaskQuery().taskCandidateUser(&quot;unexisting&quot;).taskCandidateGroup(&quot;unexisting&quot;);</span>
<span class="nc" id="L2063">        assertThat(query.count()).isZero();</span>
<span class="nc" id="L2064">        assertThat(query.list()).isEmpty();</span>

        // Unexisting groups or groups that don't have candidate tasks shouldn't influence other results
<span class="nc" id="L2067">        groups = asList(&quot;management&quot;, &quot;accountancy&quot;, &quot;sales&quot;, &quot;unexising&quot;);</span>
<span class="nc" id="L2068">        query = taskService.createTaskQuery().taskCandidateGroupIn(groups);</span>
<span class="nc" id="L2069">        assertThat(query.count()).isEqualTo(5);</span>
<span class="nc" id="L2070">        assertThat(query.list()).hasSize(5);</span>

        // SQL Server has a limit of 2100 on how many parameters a query might have
<span class="nc bnc" id="L2073" title="All 2 branches missed.">        int maxGroups = AbstractEngineConfiguration.DATABASE_TYPE_MSSQL.equals(processEngineConfiguration.getDatabaseType()) ? 2050 : 2100;</span>

<span class="nc" id="L2075">        List&lt;String&gt; testCandidateGroups = new ArrayList&lt;&gt;(maxGroups);</span>
<span class="nc bnc" id="L2076" title="All 2 branches missed.">        for (int i = 0; i &lt; maxGroups; i++) {</span>
<span class="nc" id="L2077">            testCandidateGroups.add(&quot;group&quot; + i);</span>
        }
        
<span class="nc" id="L2080">        query = taskService.createTaskQuery().taskCandidateGroupIn(testCandidateGroups);</span>
<span class="nc" id="L2081">        assertThat(query.count()).isEqualTo(0);</span>
<span class="nc" id="L2082">        assertThat(query.list()).hasSize(0);</span>
        
<span class="nc" id="L2084">        testCandidateGroups.add(&quot;management&quot;);</span>
<span class="nc" id="L2085">        query = taskService.createTaskQuery().taskCandidateGroupIn(testCandidateGroups);</span>
<span class="nc" id="L2086">        assertThat(query.count()).isEqualTo(3);</span>
<span class="nc" id="L2087">        assertThat(query.list()).hasSize(3);</span>
<span class="nc" id="L2088">    }</span>

    @Test
    public void testQueryByCandidateGroupInOr() {
<span class="nc" id="L2092">        List&lt;String&gt; groups = asList(&quot;management&quot;, &quot;accountancy&quot;);</span>
<span class="nc" id="L2093">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskCandidateGroupIn(groups);</span>
<span class="nc" id="L2094">        assertThat(query.count()).isEqualTo(5);</span>
<span class="nc" id="L2095">        assertThat(query.list()).hasSize(5);</span>

<span class="nc" id="L2097">        TaskQuery finalQuery = query;</span>
<span class="nc" id="L2098">        assertThatThrownBy(() -&gt; finalQuery.singleResult())</span>
<span class="nc" id="L2099">                .isExactlyInstanceOf(FlowableException.class);</span>

<span class="nc" id="L2101">        query = taskService.createTaskQuery().or().taskCandidateUser(&quot;kermit&quot;).taskCandidateGroupIn(groups).endOr();</span>
<span class="nc" id="L2102">        assertThat(query.count()).isEqualTo(11);</span>
<span class="nc" id="L2103">        assertThat(query.list()).hasSize(11);</span>

<span class="nc" id="L2105">        query = taskService.createTaskQuery().or().taskCandidateUser(&quot;kermit&quot;).taskCandidateGroup(&quot;unexisting&quot;).endOr();</span>
<span class="nc" id="L2106">        assertThat(query.count()).isEqualTo(6);</span>
<span class="nc" id="L2107">        assertThat(query.list()).hasSize(6);</span>

<span class="nc" id="L2109">        query = taskService.createTaskQuery().or().taskCandidateUser(&quot;unexisting&quot;).taskCandidateGroup(&quot;unexisting&quot;).endOr();</span>
<span class="nc" id="L2110">        assertThat(query.count()).isZero();</span>
<span class="nc" id="L2111">        assertThat(query.list()).isEmpty();</span>

<span class="nc" id="L2113">        query = taskService.createTaskQuery().or().taskCandidateUser(&quot;kermit&quot;).taskCandidateGroupIn(groups).endOr()</span>
<span class="nc" id="L2114">                .or().taskCandidateUser(&quot;gonzo&quot;).taskCandidateGroupIn(groups);</span>
<span class="nc" id="L2115">        assertThat(query.count()).isEqualTo(5);</span>
<span class="nc" id="L2116">        assertThat(query.list()).hasSize(5);</span>

        // Unexisting groups or groups that don't have candidate tasks shouldn't influence other results
<span class="nc" id="L2119">        groups = asList(&quot;management&quot;, &quot;accountancy&quot;, &quot;sales&quot;, &quot;unexising&quot;);</span>
<span class="nc" id="L2120">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskCandidateGroupIn(groups);</span>
<span class="nc" id="L2121">        assertThat(query.count()).isEqualTo(5);</span>
<span class="nc" id="L2122">        assertThat(query.list()).hasSize(5);</span>

        // SQL Server has a limit of 2100 on how many parameters a query might have
<span class="nc bnc" id="L2125" title="All 2 branches missed.">        int maxGroups = AbstractEngineConfiguration.DATABASE_TYPE_MSSQL.equals(processEngineConfiguration.getDatabaseType()) ? 2050 : 2100;</span>

<span class="nc" id="L2127">        List&lt;String&gt; testCandidateGroups = new ArrayList&lt;&gt;(maxGroups);</span>
<span class="nc bnc" id="L2128" title="All 2 branches missed.">        for (int i = 0; i &lt; maxGroups; i++) {</span>
<span class="nc" id="L2129">            testCandidateGroups.add(&quot;group&quot; + i);</span>
        }
        
<span class="nc" id="L2132">        query = taskService.createTaskQuery().or().taskName(&quot;testTask&quot;).taskCandidateGroupIn(testCandidateGroups).endOr();</span>
<span class="nc" id="L2133">        assertThat(query.count()).isEqualTo(6);</span>
<span class="nc" id="L2134">        assertThat(query.list()).hasSize(6);</span>
        
<span class="nc" id="L2136">        testCandidateGroups.add(&quot;management&quot;);</span>
<span class="nc" id="L2137">        query = taskService.createTaskQuery().or().taskName(&quot;undefined&quot;).taskCandidateGroupIn(testCandidateGroups);</span>
<span class="nc" id="L2138">        assertThat(query.count()).isEqualTo(3);</span>
<span class="nc" id="L2139">        assertThat(query.list()).hasSize(3);</span>
<span class="nc" id="L2140">    }</span>

    @Test
    public void testQueryByNullCandidateGroupIn() {
<span class="nc" id="L2144">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().taskCandidateGroupIn(null).list())</span>
<span class="nc" id="L2145">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L2146">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().taskCandidateGroupIn(new ArrayList&lt;&gt;()).list())</span>
<span class="nc" id="L2147">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L2148">    }</span>

    @Test
    public void testQueryByNullCandidateGroupInOr() {
<span class="nc" id="L2152">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskCandidateGroupIn(null).list())</span>
<span class="nc" id="L2153">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L2154">        assertThatThrownBy(() -&gt; taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskCandidateGroupIn(new ArrayList&lt;&gt;()).list())</span>
<span class="nc" id="L2155">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L2156">    }</span>

    @Test
    public void testQueryByDelegationState() {
<span class="nc" id="L2160">        TaskQuery query = taskService.createTaskQuery().taskDelegationState(null);</span>
<span class="nc" id="L2161">        assertThat(query.count()).isEqualTo(12);</span>
<span class="nc" id="L2162">        assertThat(query.list()).hasSize(12);</span>
<span class="nc" id="L2163">        query = taskService.createTaskQuery().taskDelegationState(DelegationState.PENDING);</span>
<span class="nc" id="L2164">        assertThat(query.count()).isZero();</span>
<span class="nc" id="L2165">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L2166">        query = taskService.createTaskQuery().taskDelegationState(DelegationState.RESOLVED);</span>
<span class="nc" id="L2167">        assertThat(query.count()).isZero();</span>
<span class="nc" id="L2168">        assertThat(query.list()).isEmpty();</span>

<span class="nc" id="L2170">        String taskId = taskService.createTaskQuery().taskAssignee(&quot;gonzo&quot;).singleResult().getId();</span>
<span class="nc" id="L2171">        taskService.delegateTask(taskId, &quot;kermit&quot;);</span>

<span class="nc" id="L2173">        query = taskService.createTaskQuery().taskDelegationState(null);</span>
<span class="nc" id="L2174">        assertThat(query.count()).isEqualTo(11);</span>
<span class="nc" id="L2175">        assertThat(query.list()).hasSize(11);</span>
<span class="nc" id="L2176">        query = taskService.createTaskQuery().taskDelegationState(DelegationState.PENDING);</span>
<span class="nc" id="L2177">        assertThat(query.count()).isEqualTo(1);</span>
<span class="nc" id="L2178">        assertThat(query.list()).hasSize(1);</span>
<span class="nc" id="L2179">        query = taskService.createTaskQuery().taskDelegationState(DelegationState.RESOLVED);</span>
<span class="nc" id="L2180">        assertThat(query.count()).isZero();</span>
<span class="nc" id="L2181">        assertThat(query.list()).isEmpty();</span>

<span class="nc" id="L2183">        taskService.resolveTask(taskId);</span>

<span class="nc" id="L2185">        query = taskService.createTaskQuery().taskDelegationState(null);</span>
<span class="nc" id="L2186">        assertThat(query.count()).isEqualTo(11);</span>
<span class="nc" id="L2187">        assertThat(query.list()).hasSize(11);</span>
<span class="nc" id="L2188">        query = taskService.createTaskQuery().taskDelegationState(DelegationState.PENDING);</span>
<span class="nc" id="L2189">        assertThat(query.count()).isZero();</span>
<span class="nc" id="L2190">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L2191">        query = taskService.createTaskQuery().taskDelegationState(DelegationState.RESOLVED);</span>
<span class="nc" id="L2192">        assertThat(query.count()).isEqualTo(1);</span>
<span class="nc" id="L2193">        assertThat(query.list()).hasSize(1);</span>
<span class="nc" id="L2194">    }</span>

    @Test
    public void testQueryByDelegationStateOr() {
<span class="nc" id="L2198">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDelegationState(null);</span>
<span class="nc" id="L2199">        assertThat(query.count()).isEqualTo(12);</span>
<span class="nc" id="L2200">        assertThat(query.list()).hasSize(12);</span>
<span class="nc" id="L2201">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDelegationState(DelegationState.PENDING);</span>
<span class="nc" id="L2202">        assertThat(query.count()).isZero();</span>
<span class="nc" id="L2203">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L2204">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDelegationState(DelegationState.RESOLVED);</span>
<span class="nc" id="L2205">        assertThat(query.count()).isZero();</span>
<span class="nc" id="L2206">        assertThat(query.list()).isEmpty();</span>

<span class="nc" id="L2208">        String taskId = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskAssignee(&quot;gonzo&quot;).singleResult().getId();</span>
<span class="nc" id="L2209">        taskService.delegateTask(taskId, &quot;kermit&quot;);</span>

<span class="nc" id="L2211">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDelegationState(null);</span>
<span class="nc" id="L2212">        assertThat(query.count()).isEqualTo(11);</span>
<span class="nc" id="L2213">        assertThat(query.list()).hasSize(11);</span>
<span class="nc" id="L2214">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDelegationState(DelegationState.PENDING);</span>
<span class="nc" id="L2215">        assertThat(query.count()).isEqualTo(1);</span>
<span class="nc" id="L2216">        assertThat(query.list()).hasSize(1);</span>
<span class="nc" id="L2217">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDelegationState(DelegationState.RESOLVED);</span>
<span class="nc" id="L2218">        assertThat(query.count()).isZero();</span>
<span class="nc" id="L2219">        assertThat(query.list()).isEmpty();</span>

<span class="nc" id="L2221">        taskService.resolveTask(taskId);</span>

<span class="nc" id="L2223">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDelegationState(null);</span>
<span class="nc" id="L2224">        assertThat(query.count()).isEqualTo(11);</span>
<span class="nc" id="L2225">        assertThat(query.list()).hasSize(11);</span>
<span class="nc" id="L2226">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDelegationState(DelegationState.PENDING);</span>
<span class="nc" id="L2227">        assertThat(query.count()).isZero();</span>
<span class="nc" id="L2228">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L2229">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDelegationState(DelegationState.RESOLVED);</span>
<span class="nc" id="L2230">        assertThat(query.count()).isEqualTo(1);</span>
<span class="nc" id="L2231">        assertThat(query.list()).hasSize(1);</span>
<span class="nc" id="L2232">    }</span>

    @Test
    public void testQueryCreatedOn() throws Exception {
<span class="nc" id="L2236">        SimpleDateFormat sdf = new SimpleDateFormat(&quot;dd/MM/yyyy hh:mm:ss.SSS&quot;);</span>

        // Exact matching of createTime, should result in 6 tasks
<span class="nc" id="L2239">        Date createTime = sdf.parse(&quot;01/01/2001 01:01:01.000&quot;);</span>

<span class="nc" id="L2241">        TaskQuery query = taskService.createTaskQuery().taskCreatedOn(createTime);</span>
<span class="nc" id="L2242">        assertThat(query.count()).isEqualTo(6);</span>
<span class="nc" id="L2243">        assertThat(query.list()).hasSize(6);</span>
<span class="nc" id="L2244">    }</span>

    @Test
    public void testQueryCreatedOnOr() throws Exception {
<span class="nc" id="L2248">        SimpleDateFormat sdf = new SimpleDateFormat(&quot;dd/MM/yyyy hh:mm:ss.SSS&quot;);</span>

        // Exact matching of createTime, should result in 6 tasks
<span class="nc" id="L2251">        Date createTime = sdf.parse(&quot;01/01/2001 01:01:01.000&quot;);</span>

<span class="nc" id="L2253">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskCreatedOn(createTime);</span>
<span class="nc" id="L2254">        assertThat(query.count()).isEqualTo(6);</span>
<span class="nc" id="L2255">        assertThat(query.list()).hasSize(6);</span>
<span class="nc" id="L2256">    }</span>

    @Test
    public void testQueryCreatedBefore() throws Exception {
<span class="nc" id="L2260">        SimpleDateFormat sdf = new SimpleDateFormat(&quot;dd/MM/yyyy hh:mm:ss.SSS&quot;);</span>

        // Should result in 7 tasks
<span class="nc" id="L2263">        Date before = sdf.parse(&quot;03/02/2002 02:02:02.000&quot;);</span>

<span class="nc" id="L2265">        TaskQuery query = taskService.createTaskQuery().taskCreatedBefore(before);</span>
<span class="nc" id="L2266">        assertThat(query.count()).isEqualTo(7);</span>
<span class="nc" id="L2267">        assertThat(query.list()).hasSize(7);</span>

<span class="nc" id="L2269">        before = sdf.parse(&quot;01/01/2001 01:01:01.000&quot;);</span>
<span class="nc" id="L2270">        query = taskService.createTaskQuery().taskCreatedBefore(before);</span>
<span class="nc" id="L2271">        assertThat(query.count()).isZero();</span>
<span class="nc" id="L2272">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L2273">    }</span>

    @Test
    public void testQueryCreatedBeforeOr() throws Exception {
<span class="nc" id="L2277">        SimpleDateFormat sdf = new SimpleDateFormat(&quot;dd/MM/yyyy hh:mm:ss.SSS&quot;);</span>

        // Should result in 7 tasks
<span class="nc" id="L2280">        Date before = sdf.parse(&quot;03/02/2002 02:02:02.000&quot;);</span>

<span class="nc" id="L2282">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskCreatedBefore(before);</span>
<span class="nc" id="L2283">        assertThat(query.count()).isEqualTo(7);</span>
<span class="nc" id="L2284">        assertThat(query.list()).hasSize(7);</span>

<span class="nc" id="L2286">        before = sdf.parse(&quot;01/01/2001 01:01:01.000&quot;);</span>
<span class="nc" id="L2287">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskCreatedBefore(before);</span>
<span class="nc" id="L2288">        assertThat(query.count()).isZero();</span>
<span class="nc" id="L2289">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L2290">    }</span>

    @Test
    public void testQueryCreatedAfter() throws Exception {
<span class="nc" id="L2294">        SimpleDateFormat sdf = new SimpleDateFormat(&quot;dd/MM/yyyy hh:mm:ss.SSS&quot;);</span>

        // Should result in 3 tasks
<span class="nc" id="L2297">        Date after = sdf.parse(&quot;03/03/2003 03:03:03.000&quot;);</span>

<span class="nc" id="L2299">        TaskQuery query = taskService.createTaskQuery().taskCreatedAfter(after);</span>
<span class="nc" id="L2300">        assertThat(query.count()).isEqualTo(3);</span>
<span class="nc" id="L2301">        assertThat(query.list()).hasSize(3);</span>

<span class="nc" id="L2303">        after = sdf.parse(&quot;05/05/2005 05:05:05.000&quot;);</span>
<span class="nc" id="L2304">        query = taskService.createTaskQuery().taskCreatedAfter(after);</span>
<span class="nc" id="L2305">        assertThat(query.count()).isZero();</span>
<span class="nc" id="L2306">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L2307">    }</span>

    @Test
    public void testQueryCreatedAfterOr() throws Exception {
<span class="nc" id="L2311">        SimpleDateFormat sdf = new SimpleDateFormat(&quot;dd/MM/yyyy hh:mm:ss.SSS&quot;);</span>

        // Should result in 3 tasks
<span class="nc" id="L2314">        Date after = sdf.parse(&quot;03/03/2003 03:03:03.000&quot;);</span>

<span class="nc" id="L2316">        TaskQuery query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskCreatedAfter(after);</span>
<span class="nc" id="L2317">        assertThat(query.count()).isEqualTo(3);</span>
<span class="nc" id="L2318">        assertThat(query.list()).hasSize(3);</span>

<span class="nc" id="L2320">        after = sdf.parse(&quot;05/05/2005 05:05:05.000&quot;);</span>
<span class="nc" id="L2321">        query = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskCreatedAfter(after);</span>
<span class="nc" id="L2322">        assertThat(query.count()).isZero();</span>
<span class="nc" id="L2323">        assertThat(query.list()).isEmpty();</span>
<span class="nc" id="L2324">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/task/taskDefinitionProcess.bpmn20.xml&quot;)
    public void testTaskDefinitionKey() throws Exception {

        // Start process instance, 2 tasks will be available
<span class="nc" id="L2331">        runtimeService.startProcessInstanceByKey(&quot;taskDefinitionKeyProcess&quot;);</span>

        // 1 task should exist with key &quot;taskKey1&quot;
<span class="nc" id="L2334">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().taskDefinitionKey(&quot;taskKey1&quot;).list();</span>
<span class="nc" id="L2335">        assertThat(tasks).isNotNull();</span>
<span class="nc" id="L2336">        assertThat(tasks)</span>
<span class="nc" id="L2337">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2338">                .containsExactly(&quot;taskKey1&quot;);</span>

        // No task should be found with unexisting key
<span class="nc" id="L2341">        long count = taskService.createTaskQuery().taskDefinitionKey(&quot;unexistingKey&quot;).count();</span>
<span class="nc" id="L2342">        assertThat(count).isZero();</span>
<span class="nc" id="L2343">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/task/taskDefinitionProcess.bpmn20.xml&quot;)
    public void testTaskDefinitionKeyOr() throws Exception {

        // Start process instance, 2 tasks will be available
<span class="nc" id="L2350">        runtimeService.startProcessInstanceByKey(&quot;taskDefinitionKeyProcess&quot;);</span>

        // 1 task should exist with key &quot;taskKey1&quot;
<span class="nc" id="L2353">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDefinitionKey(&quot;taskKey1&quot;).list();</span>
<span class="nc" id="L2354">        assertThat(tasks).isNotNull();</span>
<span class="nc" id="L2355">        assertThat(tasks)</span>
<span class="nc" id="L2356">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2357">                .containsExactly(&quot;taskKey1&quot;);</span>

        // No task should be found with unexisting key
<span class="nc" id="L2360">        long count = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDefinitionKey(&quot;unexistingKey&quot;).count();</span>
<span class="nc" id="L2361">        assertThat(count).isZero();</span>
<span class="nc" id="L2362">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/task/taskDefinitionProcess.bpmn20.xml&quot;)
    public void testTaskDefinitionKeys() throws Exception {

        // Start process instance, 2 tasks will be available
<span class="nc" id="L2369">        runtimeService.startProcessInstanceByKey(&quot;taskDefinitionKeyProcess&quot;);</span>

<span class="nc" id="L2371">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().taskDefinitionKeys(Arrays.asList(&quot;taskKey1&quot;, &quot;taskKey123&quot;, &quot;invalid&quot;)).list();</span>
<span class="nc" id="L2372">        assertThat(tasks)</span>
<span class="nc" id="L2373">                .extracting(TaskInfo::getTaskDefinitionKey, TaskInfo::getName)</span>
<span class="nc" id="L2374">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2375">                        tuple(&quot;taskKey1&quot;, &quot;Task A&quot;),</span>
<span class="nc" id="L2376">                        tuple(&quot;taskKey123&quot;, &quot;Task B&quot;)</span>
                );

<span class="nc" id="L2379">        assertThat(taskService.createTaskQuery().taskDefinitionKeys(asList(&quot;taskKey1&quot;, &quot;taskKey123&quot;, &quot;invalid&quot;)).count()).isEqualTo(2);</span>

<span class="nc" id="L2381">        assertThat(taskService.createTaskQuery().taskDefinitionKeys(asList(&quot;invalid1&quot;, &quot;invalid2&quot;)).count()).isZero();</span>
<span class="nc" id="L2382">        assertThat(taskService.createTaskQuery().taskDefinitionKeys(asList(&quot;invalid1&quot;, &quot;invalid2&quot;)).list()).isEmpty();</span>
<span class="nc" id="L2383">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/task/taskDefinitionProcess.bpmn20.xml&quot;)
    public void testTaskDefinitionKeysOr() throws Exception {

        // Start process instance, 2 tasks will be available
<span class="nc" id="L2390">        runtimeService.startProcessInstanceByKey(&quot;taskDefinitionKeyProcess&quot;);</span>

<span class="nc" id="L2392">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;)</span>
<span class="nc" id="L2393">            .taskDefinitionKeys(Arrays.asList(&quot;taskKey1&quot;, &quot;taskKey123&quot;, &quot;invalid&quot;)).list();</span>
<span class="nc" id="L2394">        assertThat(tasks)</span>
<span class="nc" id="L2395">            .extracting(TaskInfo::getTaskDefinitionKey, TaskInfo::getName)</span>
<span class="nc" id="L2396">            .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2397">                tuple(&quot;taskKey1&quot;, &quot;Task A&quot;),</span>
<span class="nc" id="L2398">                tuple(&quot;taskKey123&quot;, &quot;Task B&quot;)</span>
            );

<span class="nc" id="L2401">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDefinitionKeys(asList(&quot;taskKey1&quot;, &quot;taskKey123&quot;, &quot;invalid&quot;)).endOr().count())</span>
<span class="nc" id="L2402">                .isEqualTo(2);</span>

<span class="nc" id="L2404">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDefinitionKeys(asList(&quot;invalid1&quot;, &quot;invalid2&quot;)).endOr().count())</span>
<span class="nc" id="L2405">                .isZero();</span>

<span class="nc" id="L2407">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDefinitionKeys(Arrays.asList(&quot;invalid1&quot;, &quot;invalid2&quot;)).endOr().list())</span>
<span class="nc" id="L2408">            .isEmpty();</span>
<span class="nc" id="L2409">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/task/taskDefinitionProcess.bpmn20.xml&quot;)
    public void testTaskDefinitionKeyLike() throws Exception {

        // Start process instance, 2 tasks will be available
<span class="nc" id="L2416">        runtimeService.startProcessInstanceByKey(&quot;taskDefinitionKeyProcess&quot;);</span>

        // Ends with matching, TaskKey1 and TaskKey123 match
<span class="nc" id="L2419">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().taskDefinitionKeyLike(&quot;taskKey1%&quot;).orderByTaskName().asc().list();</span>
<span class="nc" id="L2420">        assertThat(tasks).isNotNull();</span>
<span class="nc" id="L2421">        assertThat(tasks)</span>
<span class="nc" id="L2422">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2423">                .containsExactly(&quot;taskKey1&quot;, &quot;taskKey123&quot;);</span>

        // Starts with matching, TaskKey123 matches
<span class="nc" id="L2426">        tasks = taskService.createTaskQuery().taskDefinitionKeyLike(&quot;%123&quot;).orderByTaskName().asc().list();</span>
<span class="nc" id="L2427">        assertThat(tasks).isNotNull();</span>
<span class="nc" id="L2428">        assertThat(tasks)</span>
<span class="nc" id="L2429">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2430">                .containsExactly(&quot;taskKey123&quot;);</span>

        // Contains matching, TaskKey123 matches
<span class="nc" id="L2433">        tasks = taskService.createTaskQuery().taskDefinitionKeyLike(&quot;%Key12%&quot;).orderByTaskName().asc().list();</span>
<span class="nc" id="L2434">        assertThat(tasks).isNotNull();</span>
<span class="nc" id="L2435">        assertThat(tasks)</span>
<span class="nc" id="L2436">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2437">                .containsExactly(&quot;taskKey123&quot;);</span>

        // No task should be found with unexisting key
<span class="nc" id="L2440">        long count = taskService.createTaskQuery().taskDefinitionKeyLike(&quot;%unexistingKey%&quot;).count();</span>
<span class="nc" id="L2441">        assertThat(count).isZero();</span>
<span class="nc" id="L2442">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/task/taskDefinitionProcess.bpmn20.xml&quot;)
    public void testTaskDefinitionKeyLikeOr() throws Exception {

        // Start process instance, 2 tasks will be available
<span class="nc" id="L2449">        runtimeService.startProcessInstanceByKey(&quot;taskDefinitionKeyProcess&quot;);</span>

        // Ends with matching, TaskKey1 and TaskKey123 match
<span class="nc" id="L2452">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDefinitionKeyLike(&quot;taskKey1%&quot;).orderByTaskName().asc()</span>
<span class="nc" id="L2453">                .list();</span>
<span class="nc" id="L2454">        assertThat(tasks).isNotNull();</span>
<span class="nc" id="L2455">        assertThat(tasks)</span>
<span class="nc" id="L2456">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2457">                .containsExactly(&quot;taskKey1&quot;, &quot;taskKey123&quot;);</span>

        // Starts with matching, TaskKey123 matches
<span class="nc" id="L2460">        tasks = taskService.createTaskQuery().or().taskDefinitionKeyLike(&quot;%123&quot;).taskId(&quot;invalid&quot;).orderByTaskName().asc().list();</span>
<span class="nc" id="L2461">        assertThat(tasks).isNotNull();</span>
<span class="nc" id="L2462">        assertThat(tasks)</span>
<span class="nc" id="L2463">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2464">                .containsExactly(&quot;taskKey123&quot;);</span>

        // Contains matching, TaskKey123 matches
<span class="nc" id="L2467">        tasks = taskService.createTaskQuery().or().taskDefinitionKeyLike(&quot;%Key12%&quot;).taskId(&quot;invalid&quot;).orderByTaskName().asc().list();</span>
<span class="nc" id="L2468">        assertThat(tasks).isNotNull();</span>
<span class="nc" id="L2469">        assertThat(tasks)</span>
<span class="nc" id="L2470">                .extracting(Task::getTaskDefinitionKey)</span>
<span class="nc" id="L2471">                .containsExactly(&quot;taskKey123&quot;);</span>

        // No task should be found with unexisting key
<span class="nc" id="L2474">        long count = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskDefinitionKeyLike(&quot;%unexistingKey%&quot;).count();</span>
<span class="nc" id="L2475">        assertThat(count).isZero();</span>
<span class="nc" id="L2476">    }</span>

    @Test
    @Deployment
    public void testTaskVariableValueEquals() throws Exception {
<span class="nc" id="L2481">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L2482">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

        // No task should be found for an unexisting var
<span class="nc" id="L2485">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;unexistingVar&quot;, &quot;value&quot;).count()).isZero();</span>

        // Create a map with a variable for all default types
<span class="nc" id="L2488">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2489">        variables.put(&quot;longVar&quot;, 928374L);</span>
<span class="nc" id="L2490">        variables.put(&quot;shortVar&quot;, (short) 123);</span>
<span class="nc" id="L2491">        variables.put(&quot;integerVar&quot;, 1234);</span>
<span class="nc" id="L2492">        variables.put(&quot;stringVar&quot;, &quot;stringValue&quot;);</span>
<span class="nc" id="L2493">        variables.put(&quot;booleanVar&quot;, true);</span>
<span class="nc" id="L2494">        Date date = Calendar.getInstance().getTime();</span>
<span class="nc" id="L2495">        variables.put(&quot;dateVar&quot;, date);</span>
<span class="nc" id="L2496">        variables.put(&quot;nullVar&quot;, null);</span>

<span class="nc" id="L2498">        taskService.setVariablesLocal(task.getId(), variables);</span>

        // Test query matches
<span class="nc" id="L2501">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;longVar&quot;, 928374L).count()).isEqualTo(1);</span>
<span class="nc" id="L2502">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;shortVar&quot;, (short) 123).count()).isEqualTo(1);</span>
<span class="nc" id="L2503">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;integerVar&quot;, 1234).count()).isEqualTo(1);</span>
<span class="nc" id="L2504">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;stringVar&quot;, &quot;stringValue&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2505">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;booleanVar&quot;, true).count()).isEqualTo(1);</span>
<span class="nc" id="L2506">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;dateVar&quot;, date).count()).isEqualTo(1);</span>
<span class="nc" id="L2507">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;nullVar&quot;, null).count()).isEqualTo(1);</span>

        // Test query for other values on existing variables
<span class="nc" id="L2510">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;longVar&quot;, 999L).count()).isZero();</span>
<span class="nc" id="L2511">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;shortVar&quot;, (short) 999).count()).isZero();</span>
<span class="nc" id="L2512">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;integerVar&quot;, 999).count()).isZero();</span>
<span class="nc" id="L2513">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;stringVar&quot;, &quot;999&quot;).count()).isZero();</span>
<span class="nc" id="L2514">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;booleanVar&quot;, false).count()).isZero();</span>
<span class="nc" id="L2515">        Calendar otherDate = Calendar.getInstance();</span>
<span class="nc" id="L2516">        otherDate.add(Calendar.YEAR, 1);</span>
<span class="nc" id="L2517">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;dateVar&quot;, otherDate.getTime()).count()).isZero();</span>
<span class="nc" id="L2518">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;nullVar&quot;, &quot;999&quot;).count()).isZero();</span>

        // Test query for not equals
<span class="nc" id="L2521">        assertThat(taskService.createTaskQuery().taskVariableValueNotEquals(&quot;longVar&quot;, 999L).count()).isEqualTo(1);</span>
<span class="nc" id="L2522">        assertThat(taskService.createTaskQuery().taskVariableValueNotEquals(&quot;shortVar&quot;, (short) 999).count()).isEqualTo(1);</span>
<span class="nc" id="L2523">        assertThat(taskService.createTaskQuery().taskVariableValueNotEquals(&quot;integerVar&quot;, 999).count()).isEqualTo(1);</span>
<span class="nc" id="L2524">        assertThat(taskService.createTaskQuery().taskVariableValueNotEquals(&quot;stringVar&quot;, &quot;999&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2525">        assertThat(taskService.createTaskQuery().taskVariableValueNotEquals(&quot;booleanVar&quot;, false).count()).isEqualTo(1);</span>

        // Test value-only variable equals
<span class="nc" id="L2528">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(928374L).count()).isEqualTo(1);</span>
<span class="nc" id="L2529">        assertThat(taskService.createTaskQuery().taskVariableValueEquals((short) 123).count()).isEqualTo(1);</span>
<span class="nc" id="L2530">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(1234).count()).isEqualTo(1);</span>
<span class="nc" id="L2531">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;stringValue&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2532">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(true).count()).isEqualTo(1);</span>
<span class="nc" id="L2533">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(date).count()).isEqualTo(1);</span>
<span class="nc" id="L2534">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(null).count()).isEqualTo(1);</span>

<span class="nc" id="L2536">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(999999L).count()).isZero();</span>
<span class="nc" id="L2537">        assertThat(taskService.createTaskQuery().taskVariableValueEquals((short) 999).count()).isZero();</span>
<span class="nc" id="L2538">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(9999).count()).isZero();</span>
<span class="nc" id="L2539">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;unexistingstringvalue&quot;).count()).isZero();</span>
<span class="nc" id="L2540">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(false).count()).isZero();</span>
<span class="nc" id="L2541">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(otherDate.getTime()).count()).isZero();</span>

<span class="nc" id="L2543">        assertThat(taskService.createTaskQuery().taskVariableValueLike(&quot;stringVar&quot;, &quot;string%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2544">        assertThat(taskService.createTaskQuery().taskVariableValueLike(&quot;stringVar&quot;, &quot;String%&quot;).count()).isZero();</span>
<span class="nc" id="L2545">        assertThat(taskService.createTaskQuery().taskVariableValueLike(&quot;stringVar&quot;, &quot;%Value&quot;).count()).isEqualTo(1);</span>

<span class="nc" id="L2547">        assertThat(taskService.createTaskQuery().taskVariableValueGreaterThan(&quot;integerVar&quot;, 1000).count()).isEqualTo(1);</span>
<span class="nc" id="L2548">        assertThat(taskService.createTaskQuery().taskVariableValueGreaterThan(&quot;integerVar&quot;, 1234).count()).isZero();</span>
<span class="nc" id="L2549">        assertThat(taskService.createTaskQuery().taskVariableValueGreaterThan(&quot;integerVar&quot;, 1240).count()).isZero();</span>

<span class="nc" id="L2551">        assertThat(taskService.createTaskQuery().taskVariableValueGreaterThanOrEqual(&quot;integerVar&quot;, 1000).count()).isEqualTo(1);</span>
<span class="nc" id="L2552">        assertThat(taskService.createTaskQuery().taskVariableValueGreaterThanOrEqual(&quot;integerVar&quot;, 1234).count()).isEqualTo(1);</span>
<span class="nc" id="L2553">        assertThat(taskService.createTaskQuery().taskVariableValueGreaterThanOrEqual(&quot;integerVar&quot;, 1240).count()).isZero();</span>

<span class="nc" id="L2555">        assertThat(taskService.createTaskQuery().taskVariableValueLessThan(&quot;integerVar&quot;, 1240).count()).isEqualTo(1);</span>
<span class="nc" id="L2556">        assertThat(taskService.createTaskQuery().taskVariableValueLessThan(&quot;integerVar&quot;, 1234).count()).isZero();</span>
<span class="nc" id="L2557">        assertThat(taskService.createTaskQuery().taskVariableValueLessThan(&quot;integerVar&quot;, 1000).count()).isZero();</span>

<span class="nc" id="L2559">        assertThat(taskService.createTaskQuery().taskVariableValueLessThanOrEqual(&quot;integerVar&quot;, 1240).count()).isEqualTo(1);</span>
<span class="nc" id="L2560">        assertThat(taskService.createTaskQuery().taskVariableValueLessThanOrEqual(&quot;integerVar&quot;, 1234).count()).isEqualTo(1);</span>
<span class="nc" id="L2561">        assertThat(taskService.createTaskQuery().taskVariableValueLessThanOrEqual(&quot;integerVar&quot;, 1000).count()).isZero();</span>
<span class="nc" id="L2562">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testTaskVariableValueEquals.bpmn20.xml&quot; })
    public void testTaskVariableValueEqualsOr() throws Exception {
<span class="nc" id="L2567">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L2568">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

        // No task should be found for an unexisting var
<span class="nc" id="L2571">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;unexistingVar&quot;, &quot;value&quot;).count()).isZero();</span>

        // Create a map with a variable for all default types
<span class="nc" id="L2574">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2575">        variables.put(&quot;longVar&quot;, 928374L);</span>
<span class="nc" id="L2576">        variables.put(&quot;shortVar&quot;, (short) 123);</span>
<span class="nc" id="L2577">        variables.put(&quot;integerVar&quot;, 1234);</span>
<span class="nc" id="L2578">        variables.put(&quot;stringVar&quot;, &quot;stringValue&quot;);</span>
<span class="nc" id="L2579">        variables.put(&quot;booleanVar&quot;, true);</span>
<span class="nc" id="L2580">        Date date = Calendar.getInstance().getTime();</span>
<span class="nc" id="L2581">        variables.put(&quot;dateVar&quot;, date);</span>
<span class="nc" id="L2582">        variables.put(&quot;nullVar&quot;, null);</span>

<span class="nc" id="L2584">        taskService.setVariablesLocal(task.getId(), variables);</span>

        // Test query matches
<span class="nc" id="L2587">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;longVar&quot;, 928374L).count()).isEqualTo(1);</span>
<span class="nc" id="L2588">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;shortVar&quot;, (short) 123).count()).isEqualTo(1);</span>
<span class="nc" id="L2589">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;integerVar&quot;, 1234).count()).isEqualTo(1);</span>
<span class="nc" id="L2590">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;stringVar&quot;, &quot;stringValue&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2591">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;booleanVar&quot;, true).count()).isEqualTo(1);</span>
<span class="nc" id="L2592">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;dateVar&quot;, date).count()).isEqualTo(1);</span>
<span class="nc" id="L2593">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;nullVar&quot;, null).count()).isEqualTo(1);</span>

        // Test query for other values on existing variables
<span class="nc" id="L2596">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;longVar&quot;, 999L).count()).isZero();</span>
<span class="nc" id="L2597">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;shortVar&quot;, (short) 999).count()).isZero();</span>
<span class="nc" id="L2598">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;integerVar&quot;, 999).count()).isZero();</span>
<span class="nc" id="L2599">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;stringVar&quot;, &quot;999&quot;).count()).isZero();</span>
<span class="nc" id="L2600">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;booleanVar&quot;, false).count()).isZero();</span>
<span class="nc" id="L2601">        Calendar otherDate = Calendar.getInstance();</span>
<span class="nc" id="L2602">        otherDate.add(Calendar.YEAR, 1);</span>
<span class="nc" id="L2603">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;dateVar&quot;, otherDate.getTime()).count()).isZero();</span>
<span class="nc" id="L2604">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;nullVar&quot;, &quot;999&quot;).count()).isZero();</span>

        // Test query for not equals
<span class="nc" id="L2607">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueNotEquals(&quot;longVar&quot;, 999L).count()).isEqualTo(1);</span>
<span class="nc" id="L2608">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueNotEquals(&quot;shortVar&quot;, (short) 999).count()).isEqualTo(1);</span>
<span class="nc" id="L2609">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueNotEquals(&quot;integerVar&quot;, 999).count()).isEqualTo(1);</span>
<span class="nc" id="L2610">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueNotEquals(&quot;stringVar&quot;, &quot;999&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2611">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueNotEquals(&quot;booleanVar&quot;, false).count()).isEqualTo(1);</span>

        // Test value-only variable equals
<span class="nc" id="L2614">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(928374L).count()).isEqualTo(1);</span>
<span class="nc" id="L2615">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals((short) 123).count()).isEqualTo(1);</span>
<span class="nc" id="L2616">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(1234).count()).isEqualTo(1);</span>
<span class="nc" id="L2617">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;stringValue&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2618">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(true).count()).isEqualTo(1);</span>
<span class="nc" id="L2619">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(date).count()).isEqualTo(1);</span>
<span class="nc" id="L2620">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(null).count()).isEqualTo(1);</span>

<span class="nc" id="L2622">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(999999L).count()).isZero();</span>
<span class="nc" id="L2623">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals((short) 999).count()).isZero();</span>
<span class="nc" id="L2624">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(9999).count()).isZero();</span>
<span class="nc" id="L2625">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;unexistingstringvalue&quot;).count()).isZero();</span>
<span class="nc" id="L2626">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(false).count()).isZero();</span>
<span class="nc" id="L2627">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(otherDate.getTime()).count()).isZero();</span>

<span class="nc" id="L2629">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueLike(&quot;stringVar&quot;, &quot;string%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2630">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueLike(&quot;stringVar&quot;, &quot;String%&quot;).count()).isZero();</span>
<span class="nc" id="L2631">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueLike(&quot;stringVar&quot;, &quot;%Value&quot;).count()).isEqualTo(1);</span>

<span class="nc" id="L2633">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueGreaterThan(&quot;integerVar&quot;, 1000).count()).isEqualTo(1);</span>
<span class="nc" id="L2634">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueGreaterThan(&quot;integerVar&quot;, 1234).count()).isZero();</span>
<span class="nc" id="L2635">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueGreaterThan(&quot;integerVar&quot;, 1240).count()).isZero();</span>

<span class="nc" id="L2637">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueGreaterThanOrEqual(&quot;integerVar&quot;, 1000).count()).isEqualTo(1);</span>
<span class="nc" id="L2638">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueGreaterThanOrEqual(&quot;integerVar&quot;, 1234).count()).isEqualTo(1);</span>
<span class="nc" id="L2639">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueGreaterThanOrEqual(&quot;integerVar&quot;, 1240).count()).isZero();</span>

<span class="nc" id="L2641">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueLessThan(&quot;integerVar&quot;, 1240).count()).isEqualTo(1);</span>
<span class="nc" id="L2642">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueLessThan(&quot;integerVar&quot;, 1234).count()).isZero();</span>
<span class="nc" id="L2643">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueLessThan(&quot;integerVar&quot;, 1000).count()).isZero();</span>

<span class="nc" id="L2645">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueLessThanOrEqual(&quot;integerVar&quot;, 1240).count()).isEqualTo(1);</span>
<span class="nc" id="L2646">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueLessThanOrEqual(&quot;integerVar&quot;, 1234).count()).isEqualTo(1);</span>
<span class="nc" id="L2647">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueLessThanOrEqual(&quot;integerVar&quot;, 1000).count()).isZero();</span>
<span class="nc" id="L2648">    }</span>

    @Test
    @Deployment
    public void testProcessVariableValueEquals() throws Exception {
<span class="nc" id="L2653">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2654">        variables.put(&quot;longVar&quot;, 928374L);</span>
<span class="nc" id="L2655">        variables.put(&quot;shortVar&quot;, (short) 123);</span>
<span class="nc" id="L2656">        variables.put(&quot;integerVar&quot;, 1234);</span>
<span class="nc" id="L2657">        variables.put(&quot;stringVar&quot;, &quot;stringValue&quot;);</span>
<span class="nc" id="L2658">        variables.put(&quot;booleanVar&quot;, true);</span>
<span class="nc" id="L2659">        Date date = Calendar.getInstance().getTime();</span>
<span class="nc" id="L2660">        variables.put(&quot;dateVar&quot;, date);</span>
<span class="nc" id="L2661">        variables.put(&quot;nullVar&quot;, null);</span>

        // Start process-instance with all types of variables
<span class="nc" id="L2664">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, variables);</span>

        // Test query matches
<span class="nc" id="L2667">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;longVar&quot;, 928374L).count()).isEqualTo(1);</span>
<span class="nc" id="L2668">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;shortVar&quot;, (short) 123).count()).isEqualTo(1);</span>
<span class="nc" id="L2669">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;integerVar&quot;, 1234).count()).isEqualTo(1);</span>
<span class="nc" id="L2670">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;stringVar&quot;, &quot;stringValue&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2671">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;booleanVar&quot;, true).count()).isEqualTo(1);</span>
<span class="nc" id="L2672">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;dateVar&quot;, date).count()).isEqualTo(1);</span>
<span class="nc" id="L2673">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;nullVar&quot;, null).count()).isEqualTo(1);</span>

        // Test query for other values on existing variables
<span class="nc" id="L2676">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;longVar&quot;, 999L).count()).isZero();</span>
<span class="nc" id="L2677">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;shortVar&quot;, (short) 999).count()).isZero();</span>
<span class="nc" id="L2678">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;integerVar&quot;, 999).count()).isZero();</span>
<span class="nc" id="L2679">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;stringVar&quot;, &quot;999&quot;).count()).isZero();</span>
<span class="nc" id="L2680">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;booleanVar&quot;, false).count()).isZero();</span>
<span class="nc" id="L2681">        Calendar otherDate = Calendar.getInstance();</span>
<span class="nc" id="L2682">        otherDate.add(Calendar.YEAR, 1);</span>
<span class="nc" id="L2683">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;dateVar&quot;, otherDate.getTime()).count()).isZero();</span>
<span class="nc" id="L2684">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;nullVar&quot;, &quot;999&quot;).count()).isZero();</span>

        // Test querying for task variables don't match the process-variables
<span class="nc" id="L2687">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;longVar&quot;, 928374L).count()).isZero();</span>
<span class="nc" id="L2688">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;shortVar&quot;, (short) 123).count()).isZero();</span>
<span class="nc" id="L2689">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;integerVar&quot;, 1234).count()).isZero();</span>
<span class="nc" id="L2690">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;stringVar&quot;, &quot;stringValue&quot;).count()).isZero();</span>
<span class="nc" id="L2691">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;booleanVar&quot;, true).count()).isZero();</span>
<span class="nc" id="L2692">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;dateVar&quot;, date).count()).isZero();</span>
<span class="nc" id="L2693">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;nullVar&quot;, null).count()).isZero();</span>

        // Test querying for task variables not equals
<span class="nc" id="L2696">        assertThat(taskService.createTaskQuery().processVariableValueNotEquals(&quot;longVar&quot;, 999L).count()).isEqualTo(1);</span>
<span class="nc" id="L2697">        assertThat(taskService.createTaskQuery().processVariableValueNotEquals(&quot;shortVar&quot;, (short) 999).count()).isEqualTo(1);</span>
<span class="nc" id="L2698">        assertThat(taskService.createTaskQuery().processVariableValueNotEquals(&quot;integerVar&quot;, 999).count()).isEqualTo(1);</span>
<span class="nc" id="L2699">        assertThat(taskService.createTaskQuery().processVariableValueNotEquals(&quot;stringVar&quot;, &quot;999&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2700">        assertThat(taskService.createTaskQuery().processVariableValueNotEquals(&quot;booleanVar&quot;, false).count()).isEqualTo(1);</span>

        // and query for the existing variable with NOT should result in nothing found:
<span class="nc" id="L2703">        assertThat(taskService.createTaskQuery().processVariableValueNotEquals(&quot;longVar&quot;, 928374L).count()).isZero();</span>

        // Test value-only variable equals
<span class="nc" id="L2706">        assertThat(taskService.createTaskQuery().processVariableValueEquals(928374L).count()).isEqualTo(1);</span>
<span class="nc" id="L2707">        assertThat(taskService.createTaskQuery().processVariableValueEquals((short) 123).count()).isEqualTo(1);</span>
<span class="nc" id="L2708">        assertThat(taskService.createTaskQuery().processVariableValueEquals(1234).count()).isEqualTo(1);</span>
<span class="nc" id="L2709">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;stringValue&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2710">        assertThat(taskService.createTaskQuery().processVariableValueEquals(true).count()).isEqualTo(1);</span>
<span class="nc" id="L2711">        assertThat(taskService.createTaskQuery().processVariableValueEquals(date).count()).isEqualTo(1);</span>
<span class="nc" id="L2712">        assertThat(taskService.createTaskQuery().processVariableValueEquals(null).count()).isEqualTo(1);</span>

<span class="nc" id="L2714">        assertThat(taskService.createTaskQuery().processVariableValueEquals(999999L).count()).isZero();</span>
<span class="nc" id="L2715">        assertThat(taskService.createTaskQuery().processVariableValueEquals((short) 999).count()).isZero();</span>
<span class="nc" id="L2716">        assertThat(taskService.createTaskQuery().processVariableValueEquals(9999).count()).isZero();</span>
<span class="nc" id="L2717">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;unexistingstringvalue&quot;).count()).isZero();</span>
<span class="nc" id="L2718">        assertThat(taskService.createTaskQuery().processVariableValueEquals(false).count()).isZero();</span>
<span class="nc" id="L2719">        assertThat(taskService.createTaskQuery().processVariableValueEquals(otherDate.getTime()).count()).isZero();</span>

        // Test combination of task-variable and process-variable
<span class="nc" id="L2722">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2723">        taskService.setVariableLocal(task.getId(), &quot;taskVar&quot;, &quot;theValue&quot;);</span>
<span class="nc" id="L2724">        taskService.setVariableLocal(task.getId(), &quot;longVar&quot;, 928374L);</span>

<span class="nc" id="L2726">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;longVar&quot;, 928374L).taskVariableValueEquals(&quot;taskVar&quot;, &quot;theValue&quot;).count())</span>
<span class="nc" id="L2727">                .isEqualTo(1);</span>

<span class="nc" id="L2729">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;longVar&quot;, 928374L).taskVariableValueEquals(&quot;longVar&quot;, 928374L).count())</span>
<span class="nc" id="L2730">                .isEqualTo(1);</span>

<span class="nc" id="L2732">        assertThat(taskService.createTaskQuery().processVariableValueEquals(928374L).taskVariableValueEquals(&quot;theValue&quot;).count()).isEqualTo(1);</span>

<span class="nc" id="L2734">        assertThat(taskService.createTaskQuery().processVariableValueEquals(928374L).taskVariableValueEquals(928374L).count()).isEqualTo(1);</span>
<span class="nc" id="L2735">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessVariableValueEquals.bpmn20.xml&quot; })
    public void testProcessVariableValueEqualsOr() throws Exception {
<span class="nc" id="L2740">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2741">        variables.put(&quot;longVar&quot;, 928374L);</span>
<span class="nc" id="L2742">        variables.put(&quot;shortVar&quot;, (short) 123);</span>
<span class="nc" id="L2743">        variables.put(&quot;integerVar&quot;, 1234);</span>
<span class="nc" id="L2744">        variables.put(&quot;stringVar&quot;, &quot;stringValue&quot;);</span>
<span class="nc" id="L2745">        variables.put(&quot;booleanVar&quot;, true);</span>
<span class="nc" id="L2746">        Date date = Calendar.getInstance().getTime();</span>
<span class="nc" id="L2747">        variables.put(&quot;dateVar&quot;, date);</span>
<span class="nc" id="L2748">        variables.put(&quot;nullVar&quot;, null);</span>

        // Start process-instance with all types of variables
<span class="nc" id="L2751">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, variables);</span>

        // Test query matches
<span class="nc" id="L2754">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(&quot;longVar&quot;, 928374L).count()).isEqualTo(1);</span>
<span class="nc" id="L2755">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(&quot;shortVar&quot;, (short) 123).count()).isEqualTo(1);</span>
<span class="nc" id="L2756">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(&quot;integerVar&quot;, 1234).count()).isEqualTo(1);</span>
<span class="nc" id="L2757">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(&quot;stringVar&quot;, &quot;stringValue&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2758">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(&quot;booleanVar&quot;, true).count()).isEqualTo(1);</span>
<span class="nc" id="L2759">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(&quot;dateVar&quot;, date).count()).isEqualTo(1);</span>
<span class="nc" id="L2760">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(&quot;nullVar&quot;, null).count()).isEqualTo(1);</span>

        // Test query for other values on existing variables
<span class="nc" id="L2763">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(&quot;longVar&quot;, 999L).count()).isZero();</span>
<span class="nc" id="L2764">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(&quot;shortVar&quot;, (short) 999).count()).isZero();</span>
<span class="nc" id="L2765">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(&quot;integerVar&quot;, 999).count()).isZero();</span>
<span class="nc" id="L2766">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(&quot;stringVar&quot;, &quot;999&quot;).count()).isZero();</span>
<span class="nc" id="L2767">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(&quot;booleanVar&quot;, false).count()).isZero();</span>
<span class="nc" id="L2768">        Calendar otherDate = Calendar.getInstance();</span>
<span class="nc" id="L2769">        otherDate.add(Calendar.YEAR, 1);</span>
<span class="nc" id="L2770">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(&quot;dateVar&quot;, otherDate.getTime()).count()).isZero();</span>
<span class="nc" id="L2771">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(&quot;nullVar&quot;, &quot;999&quot;).count()).isZero();</span>

        // Test querying for task variables don't match the process-variables
<span class="nc" id="L2774">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;longVar&quot;, 928374L).count()).isZero();</span>
<span class="nc" id="L2775">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;shortVar&quot;, (short) 123).count()).isZero();</span>
<span class="nc" id="L2776">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;integerVar&quot;, 1234).count()).isZero();</span>
<span class="nc" id="L2777">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;stringVar&quot;, &quot;stringValue&quot;).count()).isZero();</span>
<span class="nc" id="L2778">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;booleanVar&quot;, true).count()).isZero();</span>
<span class="nc" id="L2779">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;dateVar&quot;, date).count()).isZero();</span>
<span class="nc" id="L2780">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).taskVariableValueEquals(&quot;nullVar&quot;, null).count()).isZero();</span>

        // Test querying for task variables not equals
<span class="nc" id="L2783">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueNotEquals(&quot;longVar&quot;, 999L).count()).isEqualTo(1);</span>
<span class="nc" id="L2784">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueNotEquals(&quot;shortVar&quot;, (short) 999).count()).isEqualTo(1);</span>
<span class="nc" id="L2785">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueNotEquals(&quot;integerVar&quot;, 999).count()).isEqualTo(1);</span>
<span class="nc" id="L2786">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueNotEquals(&quot;stringVar&quot;, &quot;999&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2787">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueNotEquals(&quot;booleanVar&quot;, false).count()).isEqualTo(1);</span>

        // and query for the existing variable with NOT should result in nothing found:
<span class="nc" id="L2790">        assertThat(taskService.createTaskQuery().processVariableValueNotEquals(&quot;longVar&quot;, 928374L).count()).isZero();</span>

        // Test value-only variable equals
<span class="nc" id="L2793">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(928374L).count()).isEqualTo(1);</span>
<span class="nc" id="L2794">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals((short) 123).count()).isEqualTo(1);</span>
<span class="nc" id="L2795">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(1234).count()).isEqualTo(1);</span>
<span class="nc" id="L2796">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(&quot;stringValue&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2797">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(true).count()).isEqualTo(1);</span>
<span class="nc" id="L2798">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(date).count()).isEqualTo(1);</span>
<span class="nc" id="L2799">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(null).count()).isEqualTo(1);</span>

<span class="nc" id="L2801">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(999999L).count()).isZero();</span>
<span class="nc" id="L2802">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals((short) 999).count()).isZero();</span>
<span class="nc" id="L2803">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(9999).count()).isZero();</span>
<span class="nc" id="L2804">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(&quot;unexistingstringvalue&quot;).count()).isZero();</span>
<span class="nc" id="L2805">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(false).count()).isZero();</span>
<span class="nc" id="L2806">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processVariableValueEquals(otherDate.getTime()).count()).isZero();</span>
<span class="nc" id="L2807">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot;)
    public void testVariableValueEqualsIgnoreCase() throws Exception {
<span class="nc" id="L2812">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L2814">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2815">        assertThat(task).isNotNull();</span>

<span class="nc" id="L2817">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2818">        variables.put(&quot;mixed&quot;, &quot;AzerTY&quot;);</span>
<span class="nc" id="L2819">        variables.put(&quot;upper&quot;, &quot;AZERTY&quot;);</span>
<span class="nc" id="L2820">        variables.put(&quot;lower&quot;, &quot;azerty&quot;);</span>
<span class="nc" id="L2821">        taskService.setVariablesLocal(task.getId(), variables);</span>

<span class="nc" id="L2823">        assertThat(taskService.createTaskQuery().taskVariableValueEqualsIgnoreCase(&quot;mixed&quot;, &quot;azerTY&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2824">        assertThat(taskService.createTaskQuery().taskVariableValueEqualsIgnoreCase(&quot;mixed&quot;, &quot;azerty&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2825">        assertThat(taskService.createTaskQuery().taskVariableValueEqualsIgnoreCase(&quot;mixed&quot;, &quot;uiop&quot;).count()).isZero();</span>

<span class="nc" id="L2827">        assertThat(taskService.createTaskQuery().taskVariableValueEqualsIgnoreCase(&quot;upper&quot;, &quot;azerTY&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2828">        assertThat(taskService.createTaskQuery().taskVariableValueEqualsIgnoreCase(&quot;upper&quot;, &quot;azerty&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2829">        assertThat(taskService.createTaskQuery().taskVariableValueEqualsIgnoreCase(&quot;upper&quot;, &quot;uiop&quot;).count()).isZero();</span>

<span class="nc" id="L2831">        assertThat(taskService.createTaskQuery().taskVariableValueEqualsIgnoreCase(&quot;lower&quot;, &quot;azerTY&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2832">        assertThat(taskService.createTaskQuery().taskVariableValueEqualsIgnoreCase(&quot;lower&quot;, &quot;azerty&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2833">        assertThat(taskService.createTaskQuery().taskVariableValueEqualsIgnoreCase(&quot;lower&quot;, &quot;uiop&quot;).count()).isZero();</span>

        // Test not-equals
<span class="nc" id="L2836">        assertThat(taskService.createTaskQuery().taskVariableValueNotEqualsIgnoreCase(&quot;mixed&quot;, &quot;azerTY&quot;).count()).isZero();</span>
<span class="nc" id="L2837">        assertThat(taskService.createTaskQuery().taskVariableValueNotEqualsIgnoreCase(&quot;mixed&quot;, &quot;azerty&quot;).count()).isZero();</span>
<span class="nc" id="L2838">        assertThat(taskService.createTaskQuery().taskVariableValueNotEqualsIgnoreCase(&quot;mixed&quot;, &quot;uiop&quot;).count()).isEqualTo(1);</span>

<span class="nc" id="L2840">        assertThat(taskService.createTaskQuery().taskVariableValueNotEqualsIgnoreCase(&quot;upper&quot;, &quot;azerTY&quot;).count()).isZero();</span>
<span class="nc" id="L2841">        assertThat(taskService.createTaskQuery().taskVariableValueNotEqualsIgnoreCase(&quot;upper&quot;, &quot;azerty&quot;).count()).isZero();</span>
<span class="nc" id="L2842">        assertThat(taskService.createTaskQuery().taskVariableValueNotEqualsIgnoreCase(&quot;upper&quot;, &quot;uiop&quot;).count()).isEqualTo(1);</span>

<span class="nc" id="L2844">        assertThat(taskService.createTaskQuery().taskVariableValueNotEqualsIgnoreCase(&quot;lower&quot;, &quot;azerTY&quot;).count()).isZero();</span>
<span class="nc" id="L2845">        assertThat(taskService.createTaskQuery().taskVariableValueNotEqualsIgnoreCase(&quot;lower&quot;, &quot;azerty&quot;).count()).isZero();</span>
<span class="nc" id="L2846">        assertThat(taskService.createTaskQuery().taskVariableValueNotEqualsIgnoreCase(&quot;lower&quot;, &quot;uiop&quot;).count()).isEqualTo(1);</span>

<span class="nc" id="L2848">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot;)
    public void testProcessVariableValueEqualsIgnoreCase() throws Exception {
<span class="nc" id="L2853">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2854">        variables.put(&quot;mixed&quot;, &quot;AzerTY&quot;);</span>
<span class="nc" id="L2855">        variables.put(&quot;upper&quot;, &quot;AZERTY&quot;);</span>
<span class="nc" id="L2856">        variables.put(&quot;lower&quot;, &quot;azerty&quot;);</span>

<span class="nc" id="L2858">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, variables);</span>

<span class="nc" id="L2860">        assertThat(taskService.createTaskQuery().processVariableValueEqualsIgnoreCase(&quot;mixed&quot;, &quot;azerTY&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2861">        assertThat(taskService.createTaskQuery().processVariableValueEqualsIgnoreCase(&quot;mixed&quot;, &quot;azerty&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2862">        assertThat(taskService.createTaskQuery().processVariableValueEqualsIgnoreCase(&quot;mixed&quot;, &quot;uiop&quot;).count()).isZero();</span>

<span class="nc" id="L2864">        assertThat(taskService.createTaskQuery().processVariableValueEqualsIgnoreCase(&quot;upper&quot;, &quot;azerTY&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2865">        assertThat(taskService.createTaskQuery().processVariableValueEqualsIgnoreCase(&quot;upper&quot;, &quot;azerty&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2866">        assertThat(taskService.createTaskQuery().processVariableValueEqualsIgnoreCase(&quot;upper&quot;, &quot;uiop&quot;).count()).isZero();</span>

<span class="nc" id="L2868">        assertThat(taskService.createTaskQuery().processVariableValueEqualsIgnoreCase(&quot;lower&quot;, &quot;azerTY&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2869">        assertThat(taskService.createTaskQuery().processVariableValueEqualsIgnoreCase(&quot;lower&quot;, &quot;azerty&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2870">        assertThat(taskService.createTaskQuery().processVariableValueEqualsIgnoreCase(&quot;lower&quot;, &quot;uiop&quot;).count()).isZero();</span>
<span class="nc" id="L2871">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot;)
    public void testProcessVariableValueLike() throws Exception {
<span class="nc" id="L2876">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2877">        variables.put(&quot;mixed&quot;, &quot;AzerTY&quot;);</span>

<span class="nc" id="L2879">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, variables);</span>

<span class="nc" id="L2881">        assertThat(taskService.createTaskQuery().processVariableValueLike(&quot;mixed&quot;, &quot;Azer%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2882">        assertThat(taskService.createTaskQuery().processVariableValueLike(&quot;mixed&quot;, &quot;A%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2883">        assertThat(taskService.createTaskQuery().processVariableValueLike(&quot;mixed&quot;, &quot;a%&quot;).count()).isZero();</span>
<span class="nc" id="L2884">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot;)
    public void testProcessVariableValueLikeIgnoreCase() throws Exception {
<span class="nc" id="L2889">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2890">        variables.put(&quot;mixed&quot;, &quot;AzerTY&quot;);</span>

<span class="nc" id="L2892">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, variables);</span>

<span class="nc" id="L2894">        assertThat(taskService.createTaskQuery().processVariableValueLikeIgnoreCase(&quot;mixed&quot;, &quot;azer%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2895">        assertThat(taskService.createTaskQuery().processVariableValueLikeIgnoreCase(&quot;mixed&quot;, &quot;a%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L2896">        assertThat(taskService.createTaskQuery().processVariableValueLikeIgnoreCase(&quot;mixed&quot;, &quot;Azz%&quot;).count()).isZero();</span>
<span class="nc" id="L2897">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot;)
    public void testProcessVariableValueGreaterThan() throws Exception {
<span class="nc" id="L2902">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2903">        variables.put(&quot;number&quot;, 10);</span>

<span class="nc" id="L2905">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, variables);</span>

<span class="nc" id="L2907">        assertThat(taskService.createTaskQuery().processVariableValueGreaterThan(&quot;number&quot;, 5).count()).isEqualTo(1);</span>
<span class="nc" id="L2908">        assertThat(taskService.createTaskQuery().processVariableValueGreaterThan(&quot;number&quot;, 10).count()).isZero();</span>
<span class="nc" id="L2909">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot;)
    public void testProcessVariableValueGreaterThanOrEquals() throws Exception {
<span class="nc" id="L2914">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2915">        variables.put(&quot;number&quot;, 10);</span>

<span class="nc" id="L2917">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, variables);</span>

<span class="nc" id="L2919">        assertThat(taskService.createTaskQuery().processVariableValueGreaterThanOrEqual(&quot;number&quot;, 5).count()).isEqualTo(1);</span>
<span class="nc" id="L2920">        assertThat(taskService.createTaskQuery().processVariableValueGreaterThanOrEqual(&quot;number&quot;, 10).count()).isEqualTo(1);</span>
<span class="nc" id="L2921">        assertThat(taskService.createTaskQuery().processVariableValueGreaterThanOrEqual(&quot;number&quot;, 11).count()).isZero();</span>
<span class="nc" id="L2922">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot;)
    public void testProcessVariableValueLessThan() throws Exception {
<span class="nc" id="L2927">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2928">        variables.put(&quot;number&quot;, 10);</span>

<span class="nc" id="L2930">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, variables);</span>

<span class="nc" id="L2932">        assertThat(taskService.createTaskQuery().processVariableValueLessThan(&quot;number&quot;, 12).count()).isEqualTo(1);</span>
<span class="nc" id="L2933">        assertThat(taskService.createTaskQuery().processVariableValueLessThan(&quot;number&quot;, 10).count()).isZero();</span>
<span class="nc" id="L2934">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot;)
    public void testProcessVariableValueLessThanOrEquals() throws Exception {
<span class="nc" id="L2939">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2940">        variables.put(&quot;number&quot;, 10);</span>

<span class="nc" id="L2942">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, variables);</span>

<span class="nc" id="L2944">        assertThat(taskService.createTaskQuery().processVariableValueLessThanOrEqual(&quot;number&quot;, 12).count()).isEqualTo(1);</span>
<span class="nc" id="L2945">        assertThat(taskService.createTaskQuery().processVariableValueLessThanOrEqual(&quot;number&quot;, 10).count()).isEqualTo(1);</span>
<span class="nc" id="L2946">        assertThat(taskService.createTaskQuery().processVariableValueLessThanOrEqual(&quot;number&quot;, 8).count()).isZero();</span>
<span class="nc" id="L2947">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testProcessDefinitionId() throws Exception {
<span class="nc" id="L2952">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L2954">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processDefinitionId(processInstance.getProcessDefinitionId()).list();</span>
<span class="nc" id="L2955">        assertThat(tasks)</span>
<span class="nc" id="L2956">                .extracting(Task::getProcessInstanceId)</span>
<span class="nc" id="L2957">                .containsExactly(processInstance.getId());</span>

<span class="nc" id="L2959">        assertThat(taskService.createTaskQuery().processDefinitionId(&quot;unexisting&quot;).count()).isZero();</span>
<span class="nc" id="L2960">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testProcessDefinitionIdOr() throws Exception {
<span class="nc" id="L2965">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L2967">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;)</span>
<span class="nc" id="L2968">                .processDefinitionId(processInstance.getProcessDefinitionId()).list();</span>
<span class="nc" id="L2969">        assertThat(tasks)</span>
<span class="nc" id="L2970">                .extracting(Task::getProcessInstanceId)</span>
<span class="nc" id="L2971">                .containsExactly(processInstance.getId());</span>

<span class="nc" id="L2973">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L2974">                .or()</span>
<span class="nc" id="L2975">                .taskId(&quot;invalid&quot;)</span>
<span class="nc" id="L2976">                .processDefinitionId(processInstance.getProcessDefinitionId())</span>
<span class="nc" id="L2977">                .endOr()</span>
<span class="nc" id="L2978">                .or()</span>
<span class="nc" id="L2979">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L2980">                .processDefinitionId(&quot;invalid&quot;)</span>
<span class="nc" id="L2981">                .endOr()</span>
<span class="nc" id="L2982">                .list();</span>
<span class="nc" id="L2983">        assertThat(tasks)</span>
<span class="nc" id="L2984">                .extracting(Task::getProcessInstanceId)</span>
<span class="nc" id="L2985">                .containsExactly(processInstance.getId());</span>

<span class="nc" id="L2987">        assertThat(taskService.createTaskQuery()</span>
<span class="nc" id="L2988">                .or()</span>
<span class="nc" id="L2989">                .taskId(&quot;invalid&quot;)</span>
<span class="nc" id="L2990">                .processDefinitionId(&quot;unexisting&quot;)</span>
<span class="nc" id="L2991">                .count()).isZero();</span>
<span class="nc" id="L2992">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testProcessDefinitionKey() throws Exception {
<span class="nc" id="L2997">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L2999">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).list();</span>
<span class="nc" id="L3000">        assertThat(tasks)</span>
<span class="nc" id="L3001">                .extracting(Task::getProcessInstanceId)</span>
<span class="nc" id="L3002">                .containsExactly(processInstance.getId());</span>

<span class="nc" id="L3004">        assertThat(taskService.createTaskQuery().processDefinitionKey(&quot;unexisting&quot;).count()).isZero();</span>
<span class="nc" id="L3005">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testProcessDefinitionKeyOr() throws Exception {
<span class="nc" id="L3010">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L3012">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processDefinitionKey(&quot;oneTaskProcess&quot;).list();</span>
<span class="nc" id="L3013">        assertThat(tasks)</span>
<span class="nc" id="L3014">                .extracting(Task::getProcessInstanceId)</span>
<span class="nc" id="L3015">                .containsExactly(processInstance.getId());</span>

<span class="nc" id="L3017">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processDefinitionKey(&quot;unexisting&quot;).count()).isZero();</span>

<span class="nc" id="L3019">        assertThat(taskService.createTaskQuery().or().taskId(taskIds.get(0)).processDefinitionKey(&quot;unexisting&quot;).endOr().count()).isEqualTo(1);</span>
<span class="nc" id="L3020">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testProcessDefinitionKeyIn() throws Exception {
<span class="nc" id="L3025">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L3026">        List&lt;String&gt; includeIds = Collections.emptyList();</span>

<span class="nc" id="L3028">        assertThat(taskService.createTaskQuery().processDefinitionKeyIn(includeIds).count()).isEqualTo(13);</span>
<span class="nc" id="L3029">        includeIds = Collections.singletonList(&quot;unexisting&quot;);</span>
<span class="nc" id="L3030">        assertThat(taskService.createTaskQuery().processDefinitionKeyIn(includeIds).count()).isZero();</span>
<span class="nc" id="L3031">        includeIds = asList(&quot;unexisting&quot;, &quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L3032">        assertThat(taskService.createTaskQuery().processDefinitionKeyIn(includeIds).count()).isEqualTo(1);</span>
<span class="nc" id="L3033">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testProcessDefinitionKeyInOr() throws Exception {
<span class="nc" id="L3038">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L3040">        List&lt;String&gt; includeIds = Collections.emptyList();</span>
<span class="nc" id="L3041">        assertThat(taskService.createTaskQuery()</span>
<span class="nc" id="L3042">                .or().taskId(&quot;invalid&quot;)</span>
<span class="nc" id="L3043">                .processDefinitionKeyIn(includeIds)</span>
<span class="nc" id="L3044">                .count()).isZero();</span>

<span class="nc" id="L3046">        includeIds = Collections.singletonList(&quot;unexisting&quot;);</span>
<span class="nc" id="L3047">        assertThat(taskService.createTaskQuery()</span>
<span class="nc" id="L3048">                .or().taskId(&quot;invalid&quot;)</span>
<span class="nc" id="L3049">                .processDefinitionKeyIn(includeIds)</span>
<span class="nc" id="L3050">                .count()).isZero();</span>

<span class="nc" id="L3052">        includeIds = asList(&quot;unexisting&quot;, &quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L3053">        assertThat(taskService.createTaskQuery()</span>
<span class="nc" id="L3054">                .or().taskId(&quot;invalid&quot;)</span>
<span class="nc" id="L3055">                .processDefinitionKeyIn(includeIds)</span>
<span class="nc" id="L3056">                .count()).isEqualTo(1);</span>
<span class="nc" id="L3057">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testProcessDefinitionName() throws Exception {
<span class="nc" id="L3062">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L3064">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processDefinitionName(&quot;The One Task Process&quot;).list();</span>
<span class="nc" id="L3065">        assertThat(tasks)</span>
<span class="nc" id="L3066">                .extracting(Task::getProcessInstanceId)</span>
<span class="nc" id="L3067">                .containsExactly(processInstance.getId());</span>

<span class="nc" id="L3069">        assertThat(taskService.createTaskQuery().processDefinitionName(&quot;unexisting&quot;).count()).isZero();</span>
<span class="nc" id="L3070">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testProcessDefinitionNameOr() throws Exception {
<span class="nc" id="L3075">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L3077">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processDefinitionName(&quot;The One Task Process&quot;).list();</span>
<span class="nc" id="L3078">        assertThat(tasks)</span>
<span class="nc" id="L3079">                .extracting(Task::getProcessInstanceId)</span>
<span class="nc" id="L3080">                .containsExactly(processInstance.getId());</span>

<span class="nc" id="L3082">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processDefinitionName(&quot;unexisting&quot;).count()).isZero();</span>
<span class="nc" id="L3083">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testProcessCategoryIn() throws Exception {
<span class="nc" id="L3088">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L3090">        final org.flowable.task.api.Task task = taskService.createTaskQuery().processCategoryIn(Collections.singletonList(&quot;Examples&quot;)).singleResult();</span>
<span class="nc" id="L3091">        assertThat(task).isNotNull();</span>
<span class="nc" id="L3092">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;theTask&quot;);</span>
<span class="nc" id="L3093">        assertThat(task.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>

<span class="nc" id="L3095">        assertThat(taskService.createTaskQuery().processCategoryIn(Collections.singletonList(&quot;unexisting&quot;)).count()).isZero();</span>
<span class="nc" id="L3096">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testProcessCategoryInOr() throws Exception {
<span class="nc" id="L3101">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L3103">        org.flowable.task.api.Task task = taskService.createTaskQuery()</span>
<span class="nc" id="L3104">                .or()</span>
<span class="nc" id="L3105">                .taskId(&quot;invalid&quot;)</span>
<span class="nc" id="L3106">                .processCategoryIn(Collections.singletonList(&quot;Examples&quot;)).singleResult();</span>
<span class="nc" id="L3107">        assertThat(task).isNotNull();</span>
<span class="nc" id="L3108">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;theTask&quot;);</span>
<span class="nc" id="L3109">        assertThat(task.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>

<span class="nc" id="L3111">        task = taskService.createTaskQuery()</span>
<span class="nc" id="L3112">                .or()</span>
<span class="nc" id="L3113">                .taskId(&quot;invalid&quot;)</span>
<span class="nc" id="L3114">                .processCategoryIn(Collections.singletonList(&quot;Examples&quot;))</span>
<span class="nc" id="L3115">                .endOr()</span>
<span class="nc" id="L3116">                .or()</span>
<span class="nc" id="L3117">                .taskId(task.getId())</span>
<span class="nc" id="L3118">                .processCategoryIn(Collections.singletonList(&quot;Examples2&quot;))</span>
<span class="nc" id="L3119">                .endOr()</span>
<span class="nc" id="L3120">                .singleResult();</span>
<span class="nc" id="L3121">        assertThat(task).isNotNull();</span>
<span class="nc" id="L3122">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;theTask&quot;);</span>
<span class="nc" id="L3123">        assertThat(task.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>

<span class="nc" id="L3125">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processCategoryIn(Collections.singletonList(&quot;unexisting&quot;)).count()).isZero();</span>
<span class="nc" id="L3126">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testProcessCategoryNotIn() throws Exception {
<span class="nc" id="L3131">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L3133">        final org.flowable.task.api.Task task = taskService.createTaskQuery().processCategoryNotIn(Collections.singletonList(&quot;unexisting&quot;)).singleResult();</span>
<span class="nc" id="L3134">        assertThat(task).isNotNull();</span>
<span class="nc" id="L3135">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;theTask&quot;);</span>
<span class="nc" id="L3136">        assertThat(task.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>

<span class="nc" id="L3138">        assertThat(taskService.createTaskQuery().processCategoryNotIn(Collections.singletonList(&quot;Examples&quot;)).count()).isZero();</span>
<span class="nc" id="L3139">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testProcessCategoryNotInOr() throws Exception {
<span class="nc" id="L3144">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L3146">        final org.flowable.task.api.Task task = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;)</span>
<span class="nc" id="L3147">                .processCategoryNotIn(Collections.singletonList(&quot;unexisting&quot;)).singleResult();</span>
<span class="nc" id="L3148">        assertThat(task).isNotNull();</span>
<span class="nc" id="L3149">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;theTask&quot;);</span>
<span class="nc" id="L3150">        assertThat(task.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>

<span class="nc" id="L3152">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processCategoryNotIn(Collections.singletonList(&quot;Examples&quot;)).count()).isZero();</span>
<span class="nc" id="L3153">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testProcessInstanceIdIn() throws Exception {
<span class="nc" id="L3158">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L3160">        final org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceIdIn(Collections.singletonList(processInstance.getId()))</span>
<span class="nc" id="L3161">                .singleResult();</span>
<span class="nc" id="L3162">        assertThat(task).isNotNull();</span>
<span class="nc" id="L3163">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;theTask&quot;);</span>
<span class="nc" id="L3164">        assertThat(task.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>

<span class="nc" id="L3166">        assertThat(taskService.createTaskQuery().processInstanceIdIn(Collections.singletonList(&quot;unexisting&quot;)).count()).isZero();</span>
<span class="nc" id="L3167">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testProcessInstanceIdInOr() throws Exception {
<span class="nc" id="L3172">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L3174">        final org.flowable.task.api.Task task = taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processInstanceIdIn(Collections.singletonList(</span>
<span class="nc" id="L3175">                processInstance.getId())).singleResult();</span>
<span class="nc" id="L3176">        assertThat(task).isNotNull();</span>
<span class="nc" id="L3177">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;theTask&quot;);</span>
<span class="nc" id="L3178">        assertThat(task.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>

<span class="nc" id="L3180">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processInstanceIdIn(Collections.singletonList(&quot;unexisting&quot;)).count()).isZero();</span>
<span class="nc" id="L3181">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testProcessInstanceIdInMultiple() throws Exception {
<span class="nc" id="L3186">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L3187">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L3189">        assertThat(taskService.createTaskQuery().processInstanceIdIn(asList(processInstance1.getId(), processInstance2.getId())).count()).isEqualTo(2);</span>
<span class="nc" id="L3190">        assertThat(taskService.createTaskQuery().processInstanceIdIn(asList(processInstance1.getId(), processInstance2.getId(), &quot;unexisting&quot;)).count())</span>
<span class="nc" id="L3191">                .isEqualTo(2);</span>

<span class="nc" id="L3193">        assertThat(taskService.createTaskQuery().processInstanceIdIn(asList(&quot;unexisting1&quot;, &quot;unexisting2&quot;)).count()).isZero();</span>
<span class="nc" id="L3194">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testProcessInstanceIdInOrMultiple() throws Exception {
<span class="nc" id="L3199">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L3200">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L3202">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processInstanceIdIn(asList(processInstance1.getId(), processInstance2.getId()))</span>
<span class="nc" id="L3203">                .count()).isEqualTo(2);</span>
<span class="nc" id="L3204">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;)</span>
<span class="nc" id="L3205">                .processInstanceIdIn(asList(processInstance1.getId(), processInstance2.getId(), &quot;unexisting&quot;)).count()).isEqualTo(2);</span>

<span class="nc" id="L3207">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processInstanceIdIn(asList(&quot;unexisting1&quot;, &quot;unexisting2&quot;)).count()).isZero();</span>
<span class="nc" id="L3208">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testWithoutProcessInstanceId() throws Exception {
<span class="nc" id="L3213">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L3215">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L3216">        assertThat(taskService.createTaskQuery().withoutProcessInstanceId().count()).isEqualTo(12);</span>
<span class="nc" id="L3217">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testProcessInstanceBusinessKey() throws Exception {
<span class="nc" id="L3222">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, &quot;BUSINESS-KEY-1&quot;);</span>

<span class="nc" id="L3224">        assertThat(taskService.createTaskQuery().processDefinitionName(&quot;The One Task Process&quot;).processInstanceBusinessKey(&quot;BUSINESS-KEY-1&quot;).list()).hasSize(1);</span>
<span class="nc" id="L3225">        assertThat(taskService.createTaskQuery().processInstanceBusinessKey(&quot;BUSINESS-KEY-1&quot;).list()).hasSize(1);</span>
<span class="nc" id="L3226">        assertThat(taskService.createTaskQuery().processInstanceBusinessKey(&quot;NON-EXISTING&quot;).count()).isZero();</span>
<span class="nc" id="L3227">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testProcessInstanceBusinessKeyOr() throws Exception {
<span class="nc" id="L3232">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, &quot;BUSINESS-KEY-1&quot;);</span>

<span class="nc" id="L3234">        assertThat(</span>
<span class="nc" id="L3235">                taskService.createTaskQuery().processDefinitionName(&quot;The One Task Process&quot;).or().taskId(&quot;invalid&quot;).processInstanceBusinessKey(&quot;BUSINESS-KEY-1&quot;)</span>
<span class="nc" id="L3236">                        .list()).hasSize(1);</span>
<span class="nc" id="L3237">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processInstanceBusinessKey(&quot;BUSINESS-KEY-1&quot;).list()).hasSize(1);</span>
<span class="nc" id="L3238">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).processInstanceBusinessKey(&quot;NON-EXISTING&quot;).count()).isZero();</span>
<span class="nc" id="L3239">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testTaskDueDate() throws Exception {
<span class="nc" id="L3244">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L3245">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

        // Set due-date on task
<span class="nc" id="L3248">        Date dueDate = new SimpleDateFormat(&quot;dd/MM/yyyy hh:mm:ss&quot;).parse(&quot;01/02/2003 01:12:13&quot;);</span>
<span class="nc" id="L3249">        task.setDueDate(dueDate);</span>
<span class="nc" id="L3250">        taskService.saveTask(task);</span>

<span class="nc" id="L3252">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDueDate(dueDate).count()).isEqualTo(1);</span>

<span class="nc" id="L3254">        Calendar otherDate = Calendar.getInstance();</span>
<span class="nc" id="L3255">        otherDate.add(Calendar.YEAR, 1);</span>
<span class="nc" id="L3256">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDueDate(otherDate.getTime()).count()).isZero();</span>

<span class="nc" id="L3258">        Calendar priorDate = Calendar.getInstance();</span>
<span class="nc" id="L3259">        priorDate.setTime(dueDate);</span>
<span class="nc" id="L3260">        priorDate.roll(Calendar.YEAR, -1);</span>

<span class="nc" id="L3262">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDueAfter(priorDate.getTime()).count()).isEqualTo(1);</span>

<span class="nc" id="L3264">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDueBefore(otherDate.getTime()).count()).isEqualTo(1);</span>
<span class="nc" id="L3265">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testTaskDueDateOr() throws Exception {
<span class="nc" id="L3270">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L3271">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

        // Set due-date on task
<span class="nc" id="L3274">        Date dueDate = new SimpleDateFormat(&quot;dd/MM/yyyy hh:mm:ss&quot;).parse(&quot;01/02/2003 01:12:13&quot;);</span>
<span class="nc" id="L3275">        task.setDueDate(dueDate);</span>
<span class="nc" id="L3276">        taskService.saveTask(task);</span>

<span class="nc" id="L3278">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).or().taskId(&quot;invalid&quot;).taskDueDate(dueDate).count()).isEqualTo(1);</span>

<span class="nc" id="L3280">        Calendar otherDate = Calendar.getInstance();</span>
<span class="nc" id="L3281">        otherDate.add(Calendar.YEAR, 1);</span>
<span class="nc" id="L3282">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).or().taskId(&quot;invalid&quot;).taskDueDate(otherDate.getTime()).count())</span>
<span class="nc" id="L3283">                .isZero();</span>

<span class="nc" id="L3285">        Calendar priorDate = Calendar.getInstance();</span>
<span class="nc" id="L3286">        priorDate.setTime(dueDate);</span>
<span class="nc" id="L3287">        priorDate.roll(Calendar.YEAR, -1);</span>

<span class="nc" id="L3289">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).or().taskId(&quot;invalid&quot;).taskDueAfter(priorDate.getTime()).count())</span>
<span class="nc" id="L3290">                .isEqualTo(1);</span>

<span class="nc" id="L3292">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDueBefore(otherDate.getTime()).count()).isEqualTo(1);</span>
<span class="nc" id="L3293">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testTaskDueBefore() throws Exception {
<span class="nc" id="L3298">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L3299">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

        // Set due-date on task
<span class="nc" id="L3302">        Calendar dueDateCal = Calendar.getInstance();</span>
<span class="nc" id="L3303">        task.setDueDate(dueDateCal.getTime());</span>
<span class="nc" id="L3304">        taskService.saveTask(task);</span>

<span class="nc" id="L3306">        Calendar oneHourAgo = Calendar.getInstance();</span>
<span class="nc" id="L3307">        oneHourAgo.setTime(dueDateCal.getTime());</span>
<span class="nc" id="L3308">        oneHourAgo.add(Calendar.HOUR, -1);</span>

<span class="nc" id="L3310">        Calendar oneHourLater = Calendar.getInstance();</span>
<span class="nc" id="L3311">        oneHourLater.setTime(dueDateCal.getTime());</span>
<span class="nc" id="L3312">        oneHourLater.add(Calendar.HOUR, 1);</span>

<span class="nc" id="L3314">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDueBefore(oneHourLater.getTime()).count()).isEqualTo(1);</span>
<span class="nc" id="L3315">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDueBefore(oneHourAgo.getTime()).count()).isZero();</span>

        // Update due-date to null, shouldn't show up anymore in query that
        // matched before
<span class="nc" id="L3319">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3320">        task.setDueDate(null);</span>
<span class="nc" id="L3321">        taskService.saveTask(task);</span>

<span class="nc" id="L3323">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDueBefore(oneHourLater.getTime()).count()).isZero();</span>
<span class="nc" id="L3324">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDueBefore(oneHourAgo.getTime()).count()).isZero();</span>
<span class="nc" id="L3325">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testTaskDueBeforeOr() throws Exception {
<span class="nc" id="L3330">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L3331">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

        // Set due-date on task
<span class="nc" id="L3334">        Calendar dueDateCal = Calendar.getInstance();</span>
<span class="nc" id="L3335">        task.setDueDate(dueDateCal.getTime());</span>
<span class="nc" id="L3336">        taskService.saveTask(task);</span>

<span class="nc" id="L3338">        Calendar oneHourAgo = Calendar.getInstance();</span>
<span class="nc" id="L3339">        oneHourAgo.setTime(dueDateCal.getTime());</span>
<span class="nc" id="L3340">        oneHourAgo.add(Calendar.HOUR, -1);</span>

<span class="nc" id="L3342">        Calendar oneHourLater = Calendar.getInstance();</span>
<span class="nc" id="L3343">        oneHourLater.setTime(dueDateCal.getTime());</span>
<span class="nc" id="L3344">        oneHourLater.add(Calendar.HOUR, 1);</span>

<span class="nc" id="L3346">        assertThat(</span>
<span class="nc" id="L3347">                taskService.createTaskQuery().processInstanceId(processInstance.getId()).or().taskId(&quot;invalid&quot;).taskDueBefore(oneHourLater.getTime()).count())</span>
<span class="nc" id="L3348">                .isEqualTo(1);</span>
<span class="nc" id="L3349">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).or().taskId(&quot;invalid&quot;).taskDueBefore(oneHourAgo.getTime()).count())</span>
<span class="nc" id="L3350">                .isZero();</span>

        // Update due-date to null, shouldn't show up anymore in query that
        // matched before
<span class="nc" id="L3354">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3355">        task.setDueDate(null);</span>
<span class="nc" id="L3356">        taskService.saveTask(task);</span>

<span class="nc" id="L3358">        assertThat(</span>
<span class="nc" id="L3359">                taskService.createTaskQuery().processInstanceId(processInstance.getId()).or().taskId(&quot;invalid&quot;).taskDueBefore(oneHourLater.getTime()).count())</span>
<span class="nc" id="L3360">                .isZero();</span>
<span class="nc" id="L3361">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).or().taskId(&quot;invalid&quot;).taskDueBefore(oneHourAgo.getTime()).count())</span>
<span class="nc" id="L3362">                .isZero();</span>
<span class="nc" id="L3363">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testTaskDueAfter() throws Exception {
<span class="nc" id="L3368">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L3369">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

        // Set due-date on task
<span class="nc" id="L3372">        Calendar dueDateCal = Calendar.getInstance();</span>
<span class="nc" id="L3373">        task.setDueDate(dueDateCal.getTime());</span>
<span class="nc" id="L3374">        taskService.saveTask(task);</span>

<span class="nc" id="L3376">        Calendar oneHourAgo = Calendar.getInstance();</span>
<span class="nc" id="L3377">        oneHourAgo.setTime(dueDateCal.getTime());</span>
<span class="nc" id="L3378">        oneHourAgo.add(Calendar.HOUR, -1);</span>

<span class="nc" id="L3380">        Calendar oneHourLater = Calendar.getInstance();</span>
<span class="nc" id="L3381">        oneHourLater.setTime(dueDateCal.getTime());</span>
<span class="nc" id="L3382">        oneHourLater.add(Calendar.HOUR, 1);</span>

<span class="nc" id="L3384">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDueAfter(oneHourAgo.getTime()).count()).isEqualTo(1);</span>
<span class="nc" id="L3385">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDueAfter(oneHourLater.getTime()).count()).isZero();</span>

        // Update due-date to null, shouldn't show up anymore in query that
        // matched before
<span class="nc" id="L3389">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3390">        task.setDueDate(null);</span>
<span class="nc" id="L3391">        taskService.saveTask(task);</span>

<span class="nc" id="L3393">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDueAfter(oneHourLater.getTime()).count()).isZero();</span>
<span class="nc" id="L3394">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDueAfter(oneHourAgo.getTime()).count()).isZero();</span>
<span class="nc" id="L3395">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testTaskDueAfterOn() throws Exception {
<span class="nc" id="L3400">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L3401">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

        // Set due-date on task
<span class="nc" id="L3404">        Calendar dueDateCal = Calendar.getInstance();</span>
<span class="nc" id="L3405">        task.setDueDate(dueDateCal.getTime());</span>
<span class="nc" id="L3406">        taskService.saveTask(task);</span>

<span class="nc" id="L3408">        Calendar oneHourAgo = Calendar.getInstance();</span>
<span class="nc" id="L3409">        oneHourAgo.setTime(dueDateCal.getTime());</span>
<span class="nc" id="L3410">        oneHourAgo.add(Calendar.HOUR, -1);</span>

<span class="nc" id="L3412">        Calendar oneHourLater = Calendar.getInstance();</span>
<span class="nc" id="L3413">        oneHourLater.setTime(dueDateCal.getTime());</span>
<span class="nc" id="L3414">        oneHourLater.add(Calendar.HOUR, 1);</span>

<span class="nc" id="L3416">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).or().taskId(&quot;invalid&quot;).taskDueAfter(oneHourAgo.getTime()).count())</span>
<span class="nc" id="L3417">                .isEqualTo(1);</span>
<span class="nc" id="L3418">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).or().taskId(&quot;invalid&quot;).taskDueAfter(oneHourLater.getTime()).count())</span>
<span class="nc" id="L3419">                .isZero();</span>

        // Update due-date to null, shouldn't show up anymore in query that
        // matched before
<span class="nc" id="L3423">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3424">        task.setDueDate(null);</span>
<span class="nc" id="L3425">        taskService.saveTask(task);</span>

<span class="nc" id="L3427">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).or().taskId(&quot;invalid&quot;).taskDueAfter(oneHourLater.getTime()).count())</span>
<span class="nc" id="L3428">                .isZero();</span>
<span class="nc" id="L3429">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).or().taskId(&quot;invalid&quot;).taskDueAfter(oneHourAgo.getTime()).count())</span>
<span class="nc" id="L3430">                .isZero();</span>
<span class="nc" id="L3431">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testTaskWithoutDueDate() throws Exception {
<span class="nc" id="L3436">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L3437">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).withoutTaskDueDate().singleResult();</span>

        // Set due-date on task
<span class="nc" id="L3440">        Date dueDate = new SimpleDateFormat(&quot;dd/MM/yyyy hh:mm:ss&quot;).parse(&quot;01/02/2003 01:12:13&quot;);</span>
<span class="nc" id="L3441">        task.setDueDate(dueDate);</span>
<span class="nc" id="L3442">        taskService.saveTask(task);</span>

<span class="nc" id="L3444">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).withoutTaskDueDate().count()).isZero();</span>

<span class="nc" id="L3446">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

        // Clear due-date on task
<span class="nc" id="L3449">        task.setDueDate(null);</span>
<span class="nc" id="L3450">        taskService.saveTask(task);</span>

<span class="nc" id="L3452">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).withoutTaskDueDate().count()).isEqualTo(1);</span>
<span class="nc" id="L3453">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testTaskWithoutDueDateOr() throws Exception {
<span class="nc" id="L3458">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L3459">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).or().taskId(&quot;invalid&quot;).withoutTaskDueDate().singleResult();</span>

        // Set due-date on task
<span class="nc" id="L3462">        Date dueDate = new SimpleDateFormat(&quot;dd/MM/yyyy hh:mm:ss&quot;).parse(&quot;01/02/2003 01:12:13&quot;);</span>
<span class="nc" id="L3463">        task.setDueDate(dueDate);</span>
<span class="nc" id="L3464">        taskService.saveTask(task);</span>

<span class="nc" id="L3466">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).or().taskId(&quot;invalid&quot;).withoutTaskDueDate().count()).isZero();</span>

<span class="nc" id="L3468">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

        // Clear due-date on task
<span class="nc" id="L3471">        task.setDueDate(null);</span>
<span class="nc" id="L3472">        taskService.saveTask(task);</span>

<span class="nc" id="L3474">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).or().taskId(&quot;invalid&quot;).withoutTaskDueDate().count()).isEqualTo(1);</span>
<span class="nc" id="L3475">    }</span>

    @Test
    public void testQueryPaging() {
<span class="nc" id="L3479">        TaskQuery query = taskService.createTaskQuery().taskCandidateUser(&quot;kermit&quot;);</span>

<span class="nc" id="L3481">        assertThat(query.listPage(0, Integer.MAX_VALUE)).hasSize(11);</span>

        // Verifying the un-paged results
<span class="nc" id="L3484">        assertThat(query.count()).isEqualTo(11);</span>
<span class="nc" id="L3485">        assertThat(query.list()).hasSize(11);</span>

        // Verifying paged results
<span class="nc" id="L3488">        assertThat(query.listPage(0, 2)).hasSize(2);</span>
<span class="nc" id="L3489">        assertThat(query.listPage(2, 2)).hasSize(2);</span>
<span class="nc" id="L3490">        assertThat(query.listPage(4, 3)).hasSize(3);</span>
<span class="nc" id="L3491">        assertThat(query.listPage(10, 3)).hasSize(1);</span>
<span class="nc" id="L3492">        assertThat(query.listPage(10, 1)).hasSize(1);</span>

        // Verifying odd usages
<span class="nc" id="L3495">        assertThat(query.listPage(0, 0)).isEmpty();</span>
<span class="nc" id="L3496">        assertThat(query.listPage(11, 2)).isEmpty(); // 10 is the last index</span>
        // with a result
<span class="nc" id="L3498">        assertThat(query.listPage(0, 15)).hasSize(11); // there are only 11</span>
        // tasks
<span class="nc" id="L3500">    }</span>

    @Test
    public void testQuerySorting() {
<span class="nc" id="L3504">        assertThat(taskService.createTaskQuery().orderByTaskId().asc().list()).hasSize(12);</span>
<span class="nc" id="L3505">        assertThat(taskService.createTaskQuery().orderByTaskDefinitionKey().asc().list()).hasSize(12);</span>
<span class="nc" id="L3506">        assertThat(taskService.createTaskQuery().orderByTaskName().asc().list()).hasSize(12);</span>
<span class="nc" id="L3507">        assertThat(taskService.createTaskQuery().orderByTaskPriority().asc().list()).hasSize(12);</span>
<span class="nc" id="L3508">        assertThat(taskService.createTaskQuery().orderByTaskAssignee().asc().list()).hasSize(12);</span>
<span class="nc" id="L3509">        assertThat(taskService.createTaskQuery().orderByTaskOwner().asc().list()).hasSize(12);</span>
<span class="nc" id="L3510">        assertThat(taskService.createTaskQuery().orderByTaskDescription().asc().list()).hasSize(12);</span>
<span class="nc" id="L3511">        assertThat(taskService.createTaskQuery().orderByProcessInstanceId().asc().list()).hasSize(12);</span>
<span class="nc" id="L3512">        assertThat(taskService.createTaskQuery().orderByProcessDefinitionId().asc().list()).hasSize(12);</span>
<span class="nc" id="L3513">        assertThat(taskService.createTaskQuery().orderByExecutionId().asc().list()).hasSize(12);</span>
<span class="nc" id="L3514">        assertThat(taskService.createTaskQuery().orderByTaskCreateTime().asc().list()).hasSize(12);</span>
<span class="nc" id="L3515">        assertThat(taskService.createTaskQuery().orderByTaskDueDate().asc().list()).hasSize(12);</span>
<span class="nc" id="L3516">        assertThat(taskService.createTaskQuery().orderByCategory().asc().list()).hasSize(12);</span>

<span class="nc" id="L3518">        assertThat(taskService.createTaskQuery().orderByTaskId().desc().list()).hasSize(12);</span>
<span class="nc" id="L3519">        assertThat(taskService.createTaskQuery().orderByTaskDefinitionKey().desc().list()).hasSize(12);</span>
<span class="nc" id="L3520">        assertThat(taskService.createTaskQuery().orderByTaskName().desc().list()).hasSize(12);</span>
<span class="nc" id="L3521">        assertThat(taskService.createTaskQuery().orderByTaskPriority().desc().list()).hasSize(12);</span>
<span class="nc" id="L3522">        assertThat(taskService.createTaskQuery().orderByTaskAssignee().desc().list()).hasSize(12);</span>
<span class="nc" id="L3523">        assertThat(taskService.createTaskQuery().orderByTaskOwner().desc().list()).hasSize(12);</span>
<span class="nc" id="L3524">        assertThat(taskService.createTaskQuery().orderByTaskDescription().desc().list()).hasSize(12);</span>
<span class="nc" id="L3525">        assertThat(taskService.createTaskQuery().orderByProcessInstanceId().desc().list()).hasSize(12);</span>
<span class="nc" id="L3526">        assertThat(taskService.createTaskQuery().orderByProcessDefinitionId().desc().list()).hasSize(12);</span>
<span class="nc" id="L3527">        assertThat(taskService.createTaskQuery().orderByExecutionId().desc().list()).hasSize(12);</span>
<span class="nc" id="L3528">        assertThat(taskService.createTaskQuery().orderByTaskCreateTime().desc().list()).hasSize(12);</span>
<span class="nc" id="L3529">        assertThat(taskService.createTaskQuery().orderByTaskDueDate().desc().list()).hasSize(12);</span>
<span class="nc" id="L3530">        assertThat(taskService.createTaskQuery().orderByCategory().desc().list()).hasSize(12);</span>

<span class="nc" id="L3532">        assertThat(taskService.createTaskQuery().orderByTaskId().taskName(&quot;testTask&quot;).asc().list()).hasSize(6);</span>
<span class="nc" id="L3533">        assertThat(taskService.createTaskQuery().orderByTaskId().taskName(&quot;testTask&quot;).desc().list()).hasSize(6);</span>
<span class="nc" id="L3534">    }</span>

    @Test
    public void testNativeQueryPaging() {
<span class="nc" id="L3538">        assertThat(managementService.getTableName(org.flowable.task.api.Task.class, false)).isEqualTo(&quot;ACT_RU_TASK&quot;);</span>
<span class="nc" id="L3539">        assertThat(managementService.getTableName(TaskEntity.class, false)).isEqualTo(&quot;ACT_RU_TASK&quot;);</span>
<span class="nc" id="L3540">        assertThat(taskService.createNativeTaskQuery().sql(&quot;SELECT * FROM &quot; + managementService.getTableName(org.flowable.task.api.Task.class)).listPage(0, 5))</span>
<span class="nc" id="L3541">                .hasSize(5);</span>
<span class="nc" id="L3542">        assertThat(</span>
<span class="nc" id="L3543">                taskService.createNativeTaskQuery().sql(&quot;SELECT * FROM &quot; + managementService.getTableName(org.flowable.task.api.Task.class)).listPage(10, 12))</span>
<span class="nc" id="L3544">                .hasSize(2);</span>
<span class="nc" id="L3545">    }</span>

    @Test
    public void testNativeQuery() {
<span class="nc" id="L3549">        assertThat(managementService.getTableName(org.flowable.task.api.Task.class, false)).isEqualTo(&quot;ACT_RU_TASK&quot;);</span>
<span class="nc" id="L3550">        assertThat(managementService.getTableName(TaskEntity.class, false)).isEqualTo(&quot;ACT_RU_TASK&quot;);</span>
<span class="nc" id="L3551">        assertThat(taskService.createNativeTaskQuery().sql(&quot;SELECT * FROM &quot; + managementService.getTableName(org.flowable.task.api.Task.class)).list())</span>
<span class="nc" id="L3552">                .hasSize(12);</span>
<span class="nc" id="L3553">        assertThat(taskService.createNativeTaskQuery().sql(&quot;SELECT count(*) FROM &quot; + managementService.getTableName(org.flowable.task.api.Task.class)).count())</span>
<span class="nc" id="L3554">                .isEqualTo(12);</span>

<span class="nc" id="L3556">        assertThat(taskService.createNativeTaskQuery().sql(&quot;SELECT count(*) FROM &quot;</span>
<span class="nc" id="L3557">                + managementService.getTableName(Task.class) + &quot; T1, &quot; + managementService.getTableName(Task.class) + &quot; T2&quot;).count()).isEqualTo(144);</span>

        // join task and variable instances
<span class="nc" id="L3560">        assertThat(taskService.createNativeTaskQuery()</span>
<span class="nc" id="L3561">                .sql(&quot;SELECT count(*) FROM &quot; + managementService.getTableName(org.flowable.task.api.Task.class) + &quot; T1, &quot; + managementService</span>
<span class="nc" id="L3562">                        .getTableName(VariableInstanceEntity.class) + &quot; V1 WHERE V1.TASK_ID_ = T1.ID_&quot;)</span>
<span class="nc" id="L3563">                .count()).isEqualTo(1);</span>
<span class="nc" id="L3564">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createNativeTaskQuery()</span>
<span class="nc" id="L3565">                .sql(&quot;SELECT * FROM &quot; + managementService.getTableName(org.flowable.task.api.Task.class) + &quot; T1, &quot; + managementService</span>
<span class="nc" id="L3566">                        .getTableName(VariableInstanceEntity.class) + &quot; V1 WHERE V1.TASK_ID_ = T1.ID_&quot;).list();</span>
<span class="nc" id="L3567">        assertThat(tasks)</span>
<span class="nc" id="L3568">                .extracting(Task::getName)</span>
<span class="nc" id="L3569">                .containsExactly(&quot;gonzoTask&quot;);</span>

        // select with distinct
<span class="nc" id="L3572">        assertThat(taskService.createNativeTaskQuery().sql(&quot;SELECT DISTINCT T1.* FROM &quot; + managementService.getTableName(Task.class) + &quot; T1&quot;).list())</span>
<span class="nc" id="L3573">                .hasSize(12);</span>

<span class="nc" id="L3575">        assertThat(taskService.createNativeTaskQuery()</span>
<span class="nc" id="L3576">                .sql(&quot;SELECT count(*) FROM &quot; + managementService.getTableName(org.flowable.task.api.Task.class) + &quot; T WHERE T.NAME_ = 'gonzoTask'&quot;).count())</span>
<span class="nc" id="L3577">                .isEqualTo(1);</span>
<span class="nc" id="L3578">        assertThat(taskService.createNativeTaskQuery()</span>
<span class="nc" id="L3579">                .sql(&quot;SELECT * FROM &quot; + managementService.getTableName(org.flowable.task.api.Task.class) + &quot; T WHERE T.NAME_ = 'gonzoTask'&quot;).list()).hasSize(1);</span>

        // use parameters
<span class="nc" id="L3582">        assertThat(taskService.createNativeTaskQuery().sql(&quot;SELECT count(*) FROM &quot; + managementService.getTableName(org.flowable.task.api.Task.class)</span>
<span class="nc" id="L3583">                + &quot; T WHERE T.NAME_ = #{taskName}&quot;).parameter(&quot;taskName&quot;, &quot;gonzoTask&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L3584">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testIncludeIdentityLinks() throws Exception {
        // Start process with a binary variable
<span class="nc" id="L3590">        ProcessInstance processInstance = runtimeService</span>
<span class="nc" id="L3591">                .startProcessInstanceByKey(&quot;oneTaskProcess&quot;, Collections.singletonMap(&quot;binaryVariable&quot;, (Object) &quot;It is I, le binary&quot;.getBytes()));</span>
<span class="nc" id="L3592">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3593">        assertThat(task).isNotNull();</span>
<span class="nc" id="L3594">        taskService.setVariableLocal(task.getId(), &quot;binaryTaskVariable&quot;, (Object) &quot;It is I, le binary&quot;.getBytes());</span>

<span class="nc" id="L3596">        taskService.addCandidateGroup(task.getId(), &quot;group1&quot;);</span>

        // Query task, including identity links
<span class="nc" id="L3599">        task = taskService.createTaskQuery().taskId(task.getId()).includeIdentityLinks().singleResult();</span>
<span class="nc" id="L3600">        assertThat(task).isNotNull();</span>
<span class="nc" id="L3601">        assertThat(task.getIdentityLinks()).hasSize(1);</span>

        // Query task, including identity links, process variables, and task variables
<span class="nc" id="L3604">        task = taskService.createTaskQuery().taskId(task.getId()).includeIdentityLinks().includeProcessVariables().includeTaskLocalVariables().singleResult();</span>
<span class="nc" id="L3605">        assertThat(task).isNotNull();</span>
<span class="nc" id="L3606">        assertThat(task.getIdentityLinks()).hasSize(1);</span>
<span class="nc" id="L3607">        IdentityLinkInfo identityLink = task.getIdentityLinks().get(0);</span>
<span class="nc" id="L3608">        assertThat(identityLink.getProcessInstanceId()).isNull();</span>
<span class="nc" id="L3609">        assertThat(identityLink.getType()).isEqualTo(&quot;candidate&quot;);</span>
<span class="nc" id="L3610">        assertThat(identityLink.getGroupId()).isEqualTo(&quot;group1&quot;);</span>
<span class="nc" id="L3611">        assertThat(identityLink.getUserId()).isNull();</span>
<span class="nc" id="L3612">        assertThat(identityLink.getTaskId()).isEqualTo(task.getId());</span>

<span class="nc" id="L3614">        assertThat(task.getProcessVariables()).isNotNull();</span>
<span class="nc" id="L3615">        byte[] bytes = (byte[]) task.getProcessVariables().get(&quot;binaryVariable&quot;);</span>
<span class="nc" id="L3616">        assertThat(new String(bytes)).isEqualTo(&quot;It is I, le binary&quot;);</span>

<span class="nc" id="L3618">        assertThat(task.getTaskLocalVariables()).isNotNull();</span>
<span class="nc" id="L3619">        bytes = (byte[]) task.getTaskLocalVariables().get(&quot;binaryTaskVariable&quot;);</span>
<span class="nc" id="L3620">        assertThat(new String(bytes)).isEqualTo(&quot;It is I, le binary&quot;);</span>
<span class="nc" id="L3621">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testIncludeIdentityLinksWithPaging() {
<span class="nc bnc" id="L3626" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3627">            assertThat(historyService.createHistoricTaskInstanceQuery().count()).isEqualTo(12);</span>
        }
        
        // We don't need the existing tasks for this test
<span class="nc" id="L3631">        taskService.deleteTasks(taskIds, true);</span>
        
<span class="nc bnc" id="L3633" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3634">            assertThat(historyService.createHistoricTaskInstanceQuery().count()).isEqualTo(0);</span>
        }
        
<span class="nc" id="L3637">        taskIds.clear();</span>

<span class="nc bnc" id="L3639" title="All 2 branches missed.">        for (int i = 0; i &lt; 10; i++) {</span>
<span class="nc" id="L3640">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L3641">            Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3642">            assertThat(task).isNotNull();</span>

<span class="nc" id="L3644">            task.setName(&quot;task&quot; + i);</span>
<span class="nc" id="L3645">            taskService.saveTask(task);</span>
            
<span class="nc bnc" id="L3647" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3648">                assertThat(historyService.createHistoricTaskInstanceQuery().taskId(task.getId()).singleResult()).isNotNull();</span>
            }
            
<span class="nc" id="L3651">            taskService.setPriority(task.getId(), i);</span>
            
<span class="nc" id="L3653">            taskService.addCandidateGroup(task.getId(), &quot;group&quot; + i);</span>
<span class="nc" id="L3654">            taskService.addCandidateGroup(task.getId(), &quot;otherGroup&quot; + i);</span>
<span class="nc" id="L3655">            taskService.addCandidateUser(task.getId(), &quot;user&quot; + i);</span>
        }

<span class="nc" id="L3658">        assertThat(taskService.createTaskQuery().count()).isEqualTo(10);</span>
<span class="nc" id="L3659">        assertThat(taskService.createTaskQuery().list()).hasSize(10);</span>

<span class="nc" id="L3661">        List&lt;Task&gt; tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L3662">                .orderByTaskPriority().asc()</span>
<span class="nc" id="L3663">                .listPage(0, 4);</span>
<span class="nc" id="L3664">        assertThat(tasks)</span>
<span class="nc" id="L3665">                .extracting(TaskInfo::getName)</span>
<span class="nc" id="L3666">                .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L3668">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L3669">                .includeIdentityLinks()</span>
<span class="nc" id="L3670">                .orderByTaskPriority().asc()</span>
<span class="nc" id="L3671">                .listPage(0, 4);</span>
<span class="nc" id="L3672">        assertThat(tasks)</span>
<span class="nc" id="L3673">                .extracting(TaskInfo::getName)</span>
<span class="nc" id="L3674">                .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L3676">        Task task = tasks.get(1);</span>
<span class="nc" id="L3677">        assertThat(task).isNotNull();</span>
<span class="nc" id="L3678">        assertThat(task.getIdentityLinks())</span>
<span class="nc" id="L3679">                .extracting(IdentityLinkInfo::getGroupId, IdentityLinkInfo::getUserId)</span>
<span class="nc" id="L3680">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L3681">                        tuple(&quot;group1&quot;, null),</span>
<span class="nc" id="L3682">                        tuple(&quot;otherGroup1&quot;, null),</span>
<span class="nc" id="L3683">                        tuple(null, &quot;user1&quot;)</span>
                );

<span class="nc bnc" id="L3686" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3687">            assertThat(historyService.createHistoricTaskInstanceQuery().count()).isEqualTo(10);</span>
<span class="nc" id="L3688">            assertThat(historyService.createHistoricTaskInstanceQuery().list()).hasSize(10);</span>

<span class="nc" id="L3690">            List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L3691">                    .orderByTaskPriority().asc()</span>
<span class="nc" id="L3692">                    .listPage(0, 4);</span>
<span class="nc" id="L3693">            assertThat(historicTasks)</span>
<span class="nc" id="L3694">                    .extracting(TaskInfo::getName)</span>
<span class="nc" id="L3695">                    .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L3697">            historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L3698">                    .includeIdentityLinks()</span>
<span class="nc" id="L3699">                    .orderByTaskPriority().asc()</span>
<span class="nc" id="L3700">                    .listPage(0, 4);</span>
<span class="nc" id="L3701">            assertThat(historicTasks)</span>
<span class="nc" id="L3702">                    .extracting(TaskInfo::getName)</span>
<span class="nc" id="L3703">                    .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L3705">            HistoricTaskInstance historicTask = historicTasks.get(1);</span>
<span class="nc" id="L3706">            assertThat(historicTask).isNotNull();</span>
<span class="nc" id="L3707">            assertThat(historicTask.getIdentityLinks())</span>
<span class="nc" id="L3708">                    .extracting(IdentityLinkInfo::getGroupId, IdentityLinkInfo::getUserId)</span>
<span class="nc" id="L3709">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L3710">                            tuple(&quot;group1&quot;, null),</span>
<span class="nc" id="L3711">                            tuple(&quot;otherGroup1&quot;, null),</span>
<span class="nc" id="L3712">                            tuple(null, &quot;user1&quot;)</span>
                    );
        }
<span class="nc" id="L3715">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testIncludeProcessVariablesWithPaging() {
<span class="nc bnc" id="L3720" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3721">            assertThat(historyService.createHistoricTaskInstanceQuery().count()).isEqualTo(12);</span>
        }
        
        // We don't need the existing tasks for this test
<span class="nc" id="L3725">        taskService.deleteTasks(taskIds, true);</span>
        
<span class="nc bnc" id="L3727" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3728">            assertThat(historyService.createHistoricTaskInstanceQuery().count()).isEqualTo(0);</span>
        }
        
<span class="nc" id="L3731">        taskIds.clear();</span>

<span class="nc bnc" id="L3733" title="All 2 branches missed.">        for (int i = 0; i &lt; 10; i++) {</span>
<span class="nc" id="L3734">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, Collections.singletonMap(&quot;processVar&quot;, &quot;value&quot; + i));</span>
<span class="nc" id="L3735">            Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3736">            assertThat(task).isNotNull();</span>

<span class="nc" id="L3738">            task.setName(&quot;task&quot; + i);</span>
<span class="nc" id="L3739">            taskService.saveTask(task);</span>
            
<span class="nc bnc" id="L3741" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3742">                assertThat(historyService.createHistoricTaskInstanceQuery().taskId(task.getId()).singleResult()).isNotNull();</span>
            }
            
<span class="nc" id="L3745">            taskService.setPriority(task.getId(), i);</span>
        }

<span class="nc" id="L3748">        assertThat(taskService.createTaskQuery().count()).isEqualTo(10);</span>
<span class="nc" id="L3749">        assertThat(taskService.createTaskQuery().list()).hasSize(10);</span>

<span class="nc" id="L3751">        List&lt;Task&gt; tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L3752">                .orderByTaskPriority().asc()</span>
<span class="nc" id="L3753">                .listPage(0, 4);</span>
<span class="nc" id="L3754">        assertThat(tasks)</span>
<span class="nc" id="L3755">                .extracting(TaskInfo::getName)</span>
<span class="nc" id="L3756">                .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L3758">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L3759">                .includeProcessVariables()</span>
<span class="nc" id="L3760">                .orderByTaskPriority().asc()</span>
<span class="nc" id="L3761">                .listPage(0, 4);</span>
<span class="nc" id="L3762">        assertThat(tasks)</span>
<span class="nc" id="L3763">                .extracting(TaskInfo::getName)</span>
<span class="nc" id="L3764">                .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L3766">        Task task = tasks.get(1);</span>
<span class="nc" id="L3767">        assertThat(task).isNotNull();</span>
<span class="nc" id="L3768">        assertThat(task.getProcessVariables())</span>
<span class="nc" id="L3769">                .containsOnly(entry(&quot;processVar&quot;, &quot;value1&quot;));</span>

<span class="nc bnc" id="L3771" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3772">            assertThat(historyService.createHistoricTaskInstanceQuery().count()).isEqualTo(10);</span>
<span class="nc" id="L3773">            assertThat(historyService.createHistoricTaskInstanceQuery().list()).hasSize(10);</span>

<span class="nc" id="L3775">            List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L3776">                    .orderByTaskPriority().asc()</span>
<span class="nc" id="L3777">                    .listPage(0, 4);</span>
<span class="nc" id="L3778">            assertThat(historicTasks)</span>
<span class="nc" id="L3779">                    .extracting(TaskInfo::getName)</span>
<span class="nc" id="L3780">                    .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L3782">            historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L3783">                    .includeProcessVariables()</span>
<span class="nc" id="L3784">                    .orderByTaskPriority().asc()</span>
<span class="nc" id="L3785">                    .listPage(0, 4);</span>
<span class="nc" id="L3786">            assertThat(historicTasks)</span>
<span class="nc" id="L3787">                    .extracting(TaskInfo::getName)</span>
<span class="nc" id="L3788">                    .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L3790">            HistoricTaskInstance historicTask = historicTasks.get(1);</span>
<span class="nc" id="L3791">            assertThat(historicTask).isNotNull();</span>
<span class="nc" id="L3792">            assertThat(historicTask.getProcessVariables())</span>
<span class="nc" id="L3793">                    .containsOnly(entry(&quot;processVar&quot;, &quot;value1&quot;));</span>
        }
<span class="nc" id="L3795">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testIncludeProcessVariablesAndTaskLocalVariablesWithPaging() {
<span class="nc bnc" id="L3800" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3801">            assertThat(historyService.createHistoricTaskInstanceQuery().count()).isEqualTo(12);</span>
        }
        
        // We don't need the existing tasks for this test
<span class="nc" id="L3805">        taskService.deleteTasks(taskIds, true);</span>
        
<span class="nc bnc" id="L3807" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3808">            assertThat(historyService.createHistoricTaskInstanceQuery().count()).isEqualTo(0);</span>
        }
        
<span class="nc" id="L3811">        taskIds.clear();</span>

<span class="nc bnc" id="L3813" title="All 2 branches missed.">        for (int i = 0; i &lt; 10; i++) {</span>
<span class="nc" id="L3814">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, Collections.singletonMap(&quot;processVar&quot;, &quot;value&quot; + i));</span>
<span class="nc" id="L3815">            Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3816">            assertThat(task).isNotNull();</span>

<span class="nc" id="L3818">            task.setName(&quot;task&quot; + i);</span>
<span class="nc" id="L3819">            taskService.saveTask(task);</span>
            
<span class="nc bnc" id="L3821" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3822">                assertThat(historyService.createHistoricTaskInstanceQuery().taskId(task.getId()).singleResult()).isNotNull();</span>
            }
            
<span class="nc" id="L3825">            taskService.setPriority(task.getId(), i);</span>
<span class="nc" id="L3826">            taskService.setVariableLocal(task.getId(), &quot;taskVar&quot;, &quot;taskValue&quot; + i);</span>
        }

<span class="nc" id="L3829">        assertThat(taskService.createTaskQuery().count()).isEqualTo(10);</span>
<span class="nc" id="L3830">        assertThat(taskService.createTaskQuery().list()).hasSize(10);</span>

<span class="nc" id="L3832">        List&lt;Task&gt; tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L3833">                .orderByTaskPriority().asc()</span>
<span class="nc" id="L3834">                .listPage(0, 4);</span>
<span class="nc" id="L3835">        assertThat(tasks)</span>
<span class="nc" id="L3836">                .extracting(TaskInfo::getName)</span>
<span class="nc" id="L3837">                .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L3839">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L3840">                .includeProcessVariables()</span>
<span class="nc" id="L3841">                .orderByTaskPriority().asc()</span>
<span class="nc" id="L3842">                .listPage(0, 4);</span>
<span class="nc" id="L3843">        assertThat(tasks)</span>
<span class="nc" id="L3844">                .extracting(TaskInfo::getName)</span>
<span class="nc" id="L3845">                .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L3847">        Task task = tasks.get(1);</span>
<span class="nc" id="L3848">        assertThat(task).isNotNull();</span>
<span class="nc" id="L3849">        assertThat(task.getProcessVariables())</span>
<span class="nc" id="L3850">                .containsOnly(entry(&quot;processVar&quot;, &quot;value1&quot;));</span>
<span class="nc" id="L3851">        assertThat(task.getTaskLocalVariables()).isEmpty();</span>

<span class="nc" id="L3853">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L3854">                .includeProcessVariables()</span>
<span class="nc" id="L3855">                .includeTaskLocalVariables()</span>
<span class="nc" id="L3856">                .orderByTaskPriority().asc()</span>
<span class="nc" id="L3857">                .listPage(0, 4);</span>
<span class="nc" id="L3858">        assertThat(tasks)</span>
<span class="nc" id="L3859">                .extracting(TaskInfo::getName)</span>
<span class="nc" id="L3860">                .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L3862">        task = tasks.get(1);</span>
<span class="nc" id="L3863">        assertThat(task).isNotNull();</span>
<span class="nc" id="L3864">        assertThat(task.getProcessVariables())</span>
<span class="nc" id="L3865">                .containsOnly(entry(&quot;processVar&quot;, &quot;value1&quot;));</span>
<span class="nc" id="L3866">        assertThat(task.getTaskLocalVariables())</span>
<span class="nc" id="L3867">                .containsOnly(entry(&quot;taskVar&quot;, &quot;taskValue1&quot;));</span>

<span class="nc bnc" id="L3869" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3870">            assertThat(historyService.createHistoricTaskInstanceQuery().count()).isEqualTo(10);</span>
<span class="nc" id="L3871">            assertThat(historyService.createHistoricTaskInstanceQuery().list()).hasSize(10);</span>

<span class="nc" id="L3873">            List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L3874">                    .orderByTaskPriority().asc()</span>
<span class="nc" id="L3875">                    .listPage(0, 4);</span>
<span class="nc" id="L3876">            assertThat(historicTasks)</span>
<span class="nc" id="L3877">                    .extracting(TaskInfo::getName)</span>
<span class="nc" id="L3878">                    .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L3880">            historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L3881">                    .includeProcessVariables()</span>
<span class="nc" id="L3882">                    .orderByTaskPriority().asc()</span>
<span class="nc" id="L3883">                    .listPage(0, 4);</span>
<span class="nc" id="L3884">            assertThat(historicTasks)</span>
<span class="nc" id="L3885">                    .extracting(TaskInfo::getName)</span>
<span class="nc" id="L3886">                    .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L3888">            HistoricTaskInstance historicTask = historicTasks.get(1);</span>
<span class="nc" id="L3889">            assertThat(historicTask).isNotNull();</span>
<span class="nc" id="L3890">            assertThat(historicTask.getProcessVariables())</span>
<span class="nc" id="L3891">                    .containsOnly(entry(&quot;processVar&quot;, &quot;value1&quot;));</span>
<span class="nc" id="L3892">            assertThat(historicTask.getTaskLocalVariables()).isEmpty();</span>

<span class="nc" id="L3894">            historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L3895">                    .includeProcessVariables()</span>
<span class="nc" id="L3896">                    .includeTaskLocalVariables()</span>
<span class="nc" id="L3897">                    .orderByTaskPriority().asc()</span>
<span class="nc" id="L3898">                    .listPage(0, 4);</span>
<span class="nc" id="L3899">            assertThat(historicTasks)</span>
<span class="nc" id="L3900">                    .extracting(TaskInfo::getName)</span>
<span class="nc" id="L3901">                    .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L3903">            historicTask = historicTasks.get(1);</span>
<span class="nc" id="L3904">            assertThat(historicTask).isNotNull();</span>
<span class="nc" id="L3905">            assertThat(historicTask.getProcessVariables())</span>
<span class="nc" id="L3906">                    .containsOnly(entry(&quot;processVar&quot;, &quot;value1&quot;));</span>
<span class="nc" id="L3907">            assertThat(historicTask.getTaskLocalVariables())</span>
<span class="nc" id="L3908">                    .containsOnly(entry(&quot;taskVar&quot;, &quot;taskValue1&quot;));</span>
        }
<span class="nc" id="L3910">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testIncludeProcessVariablesAndTaskLocalVariablesAndIncludeIdentityLinksWithPaging() {
<span class="nc bnc" id="L3915" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3916">            assertThat(historyService.createHistoricTaskInstanceQuery().count()).isEqualTo(12);</span>
        }
        
        // We don't need the existing tasks for this test
<span class="nc" id="L3920">        taskService.deleteTasks(taskIds, true);</span>
        
<span class="nc bnc" id="L3922" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3923">            assertThat(historyService.createHistoricTaskInstanceQuery().count()).isEqualTo(0);</span>
        }
        
<span class="nc" id="L3926">        taskIds.clear();</span>

<span class="nc bnc" id="L3928" title="All 2 branches missed.">        for (int i = 0; i &lt; 10; i++) {</span>
<span class="nc" id="L3929">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, Collections.singletonMap(&quot;processVar&quot;, &quot;value&quot; + i));</span>
<span class="nc" id="L3930">            Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L3931">            assertThat(task).isNotNull();</span>

<span class="nc" id="L3933">            task.setName(&quot;task&quot; + i);</span>
<span class="nc" id="L3934">            taskService.saveTask(task);</span>
            
<span class="nc bnc" id="L3936" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L3937">                assertThat(historyService.createHistoricTaskInstanceQuery().taskId(task.getId()).singleResult()).isNotNull();</span>
            }
            
<span class="nc" id="L3940">            taskService.setPriority(task.getId(), i);</span>
            
<span class="nc" id="L3942">            taskService.setVariableLocal(task.getId(), &quot;taskVar&quot;, &quot;taskValue&quot; + i);</span>
<span class="nc" id="L3943">            taskService.addCandidateGroup(task.getId(), &quot;group&quot; + i);</span>
<span class="nc" id="L3944">            taskService.addCandidateGroup(task.getId(), &quot;otherGroup&quot; + i);</span>
<span class="nc" id="L3945">            taskService.addCandidateUser(task.getId(), &quot;user&quot; + i);</span>
        }

<span class="nc" id="L3948">        assertThat(taskService.createTaskQuery().count()).isEqualTo(10);</span>
<span class="nc" id="L3949">        assertThat(taskService.createTaskQuery().list()).hasSize(10);</span>

<span class="nc" id="L3951">        List&lt;Task&gt; tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L3952">                .orderByTaskPriority().asc()</span>
<span class="nc" id="L3953">                .listPage(0, 4);</span>
<span class="nc" id="L3954">        assertThat(tasks)</span>
<span class="nc" id="L3955">                .extracting(TaskInfo::getName)</span>
<span class="nc" id="L3956">                .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L3958">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L3959">                .includeProcessVariables()</span>
<span class="nc" id="L3960">                .orderByTaskPriority().asc()</span>
<span class="nc" id="L3961">                .listPage(0, 4);</span>
<span class="nc" id="L3962">        assertThat(tasks)</span>
<span class="nc" id="L3963">                .extracting(TaskInfo::getName)</span>
<span class="nc" id="L3964">                .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L3966">        Task task = tasks.get(1);</span>
<span class="nc" id="L3967">        assertThat(task).isNotNull();</span>
<span class="nc" id="L3968">        assertThat(task.getProcessVariables())</span>
<span class="nc" id="L3969">                .containsOnly(entry(&quot;processVar&quot;, &quot;value1&quot;));</span>
<span class="nc" id="L3970">        assertThat(task.getTaskLocalVariables()).isEmpty();</span>
<span class="nc" id="L3971">        assertThat(task.getIdentityLinks()).isEmpty();</span>

<span class="nc" id="L3973">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L3974">                .includeProcessVariables()</span>
<span class="nc" id="L3975">                .includeTaskLocalVariables()</span>
<span class="nc" id="L3976">                .orderByTaskPriority().asc()</span>
<span class="nc" id="L3977">                .listPage(0, 4);</span>
<span class="nc" id="L3978">        assertThat(tasks)</span>
<span class="nc" id="L3979">                .extracting(TaskInfo::getName)</span>
<span class="nc" id="L3980">                .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L3982">        task = tasks.get(1);</span>
<span class="nc" id="L3983">        assertThat(task).isNotNull();</span>
<span class="nc" id="L3984">        assertThat(task.getProcessVariables())</span>
<span class="nc" id="L3985">                .containsOnly(entry(&quot;processVar&quot;, &quot;value1&quot;));</span>
<span class="nc" id="L3986">        assertThat(task.getTaskLocalVariables())</span>
<span class="nc" id="L3987">                .containsOnly(entry(&quot;taskVar&quot;, &quot;taskValue1&quot;));</span>
<span class="nc" id="L3988">        assertThat(task.getIdentityLinks()).isEmpty();</span>

<span class="nc" id="L3990">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L3991">                .includeProcessVariables()</span>
<span class="nc" id="L3992">                .includeTaskLocalVariables()</span>
<span class="nc" id="L3993">                .includeIdentityLinks()</span>
<span class="nc" id="L3994">                .orderByTaskPriority().asc()</span>
<span class="nc" id="L3995">                .listPage(0, 4);</span>
<span class="nc" id="L3996">        assertThat(tasks)</span>
<span class="nc" id="L3997">                .extracting(TaskInfo::getName)</span>
<span class="nc" id="L3998">                .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L4000">        task = tasks.get(1);</span>
<span class="nc" id="L4001">        assertThat(task).isNotNull();</span>
<span class="nc" id="L4002">        assertThat(task.getProcessVariables())</span>
<span class="nc" id="L4003">                .containsOnly(entry(&quot;processVar&quot;, &quot;value1&quot;));</span>
<span class="nc" id="L4004">        assertThat(task.getTaskLocalVariables())</span>
<span class="nc" id="L4005">                .containsOnly(entry(&quot;taskVar&quot;, &quot;taskValue1&quot;));</span>
<span class="nc" id="L4006">        assertThat(task.getIdentityLinks())</span>
<span class="nc" id="L4007">                .extracting(IdentityLinkInfo::getGroupId, IdentityLinkInfo::getUserId)</span>
<span class="nc" id="L4008">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4009">                        tuple(&quot;group1&quot;, null),</span>
<span class="nc" id="L4010">                        tuple(&quot;otherGroup1&quot;, null),</span>
<span class="nc" id="L4011">                        tuple(null, &quot;user1&quot;)</span>
                );

<span class="nc bnc" id="L4014" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L4015">            assertThat(historyService.createHistoricTaskInstanceQuery().count()).isEqualTo(10);</span>
<span class="nc" id="L4016">            assertThat(historyService.createHistoricTaskInstanceQuery().list()).hasSize(10);</span>

<span class="nc" id="L4018">            List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L4019">                    .orderByTaskPriority().asc()</span>
<span class="nc" id="L4020">                    .listPage(0, 4);</span>
<span class="nc" id="L4021">            assertThat(historicTasks)</span>
<span class="nc" id="L4022">                    .extracting(TaskInfo::getName)</span>
<span class="nc" id="L4023">                    .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L4025">            historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L4026">                    .includeProcessVariables()</span>
<span class="nc" id="L4027">                    .orderByTaskPriority().asc()</span>
<span class="nc" id="L4028">                    .listPage(0, 4);</span>
<span class="nc" id="L4029">            assertThat(historicTasks)</span>
<span class="nc" id="L4030">                    .extracting(TaskInfo::getName)</span>
<span class="nc" id="L4031">                    .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L4033">            HistoricTaskInstance historicTask = historicTasks.get(1);</span>
<span class="nc" id="L4034">            assertThat(historicTask).isNotNull();</span>
<span class="nc" id="L4035">            assertThat(historicTask.getProcessVariables())</span>
<span class="nc" id="L4036">                    .containsOnly(entry(&quot;processVar&quot;, &quot;value1&quot;));</span>
<span class="nc" id="L4037">            assertThat(historicTask.getTaskLocalVariables()).isEmpty();</span>
<span class="nc" id="L4038">            assertThat(historicTask.getIdentityLinks()).isEmpty();</span>

<span class="nc" id="L4040">            historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L4041">                    .includeProcessVariables()</span>
<span class="nc" id="L4042">                    .includeTaskLocalVariables()</span>
<span class="nc" id="L4043">                    .orderByTaskPriority().asc()</span>
<span class="nc" id="L4044">                    .listPage(0, 4);</span>
<span class="nc" id="L4045">            assertThat(historicTasks)</span>
<span class="nc" id="L4046">                    .extracting(TaskInfo::getName)</span>
<span class="nc" id="L4047">                    .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L4049">            historicTask = historicTasks.get(1);</span>
<span class="nc" id="L4050">            assertThat(historicTask).isNotNull();</span>
<span class="nc" id="L4051">            assertThat(historicTask.getProcessVariables())</span>
<span class="nc" id="L4052">                    .containsOnly(entry(&quot;processVar&quot;, &quot;value1&quot;));</span>
<span class="nc" id="L4053">            assertThat(historicTask.getTaskLocalVariables())</span>
<span class="nc" id="L4054">                    .containsOnly(entry(&quot;taskVar&quot;, &quot;taskValue1&quot;));</span>
<span class="nc" id="L4055">            assertThat(historicTask.getIdentityLinks()).isEmpty();</span>

<span class="nc" id="L4057">            historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L4058">                    .includeProcessVariables()</span>
<span class="nc" id="L4059">                    .includeTaskLocalVariables()</span>
<span class="nc" id="L4060">                    .includeIdentityLinks()</span>
<span class="nc" id="L4061">                    .orderByTaskPriority().asc()</span>
<span class="nc" id="L4062">                    .listPage(0, 4);</span>
<span class="nc" id="L4063">            assertThat(historicTasks)</span>
<span class="nc" id="L4064">                    .extracting(TaskInfo::getName)</span>
<span class="nc" id="L4065">                    .containsExactly(&quot;task0&quot;, &quot;task1&quot;, &quot;task2&quot;, &quot;task3&quot;);</span>

<span class="nc" id="L4067">            historicTask = historicTasks.get(1);</span>
<span class="nc" id="L4068">            assertThat(historicTask).isNotNull();</span>
<span class="nc" id="L4069">            assertThat(historicTask.getProcessVariables())</span>
<span class="nc" id="L4070">                    .containsOnly(entry(&quot;processVar&quot;, &quot;value1&quot;));</span>
<span class="nc" id="L4071">            assertThat(historicTask.getTaskLocalVariables())</span>
<span class="nc" id="L4072">                    .containsOnly(entry(&quot;taskVar&quot;, &quot;taskValue1&quot;));</span>
<span class="nc" id="L4073">            assertThat(historicTask.getIdentityLinks())</span>
<span class="nc" id="L4074">                    .extracting(IdentityLinkInfo::getGroupId, IdentityLinkInfo::getUserId)</span>
<span class="nc" id="L4075">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4076">                            tuple(&quot;group1&quot;, null),</span>
<span class="nc" id="L4077">                            tuple(&quot;otherGroup1&quot;, null),</span>
<span class="nc" id="L4078">                            tuple(null, &quot;user1&quot;)</span>
                    );
        }
<span class="nc" id="L4081">    }</span>

    /**
     * Test confirming fix for ACT-1731
     */
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testIncludeBinaryVariables() throws Exception {
        // Start process with a binary variable
<span class="nc" id="L4090">        ProcessInstance processInstance = runtimeService</span>
<span class="nc" id="L4091">                .startProcessInstanceByKey(&quot;oneTaskProcess&quot;, Collections.singletonMap(&quot;binaryVariable&quot;, (Object) &quot;It is I, le binary&quot;.getBytes()));</span>
<span class="nc" id="L4092">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L4093">        assertThat(task).isNotNull();</span>
<span class="nc" id="L4094">        taskService.setVariableLocal(task.getId(), &quot;binaryTaskVariable&quot;, (Object) &quot;It is I, le binary&quot;.getBytes());</span>

        // Query task, including processVariables
<span class="nc" id="L4097">        task = taskService.createTaskQuery().taskId(task.getId()).includeProcessVariables().singleResult();</span>
<span class="nc" id="L4098">        assertThat(task).isNotNull();</span>
<span class="nc" id="L4099">        assertThat(task.getProcessVariables()).isNotNull();</span>
<span class="nc" id="L4100">        byte[] bytes = (byte[]) task.getProcessVariables().get(&quot;binaryVariable&quot;);</span>
<span class="nc" id="L4101">        assertThat(new String(bytes)).isEqualTo(&quot;It is I, le binary&quot;);</span>

        // Query task, including taskVariables
<span class="nc" id="L4104">        task = taskService.createTaskQuery().taskId(task.getId()).includeTaskLocalVariables().singleResult();</span>
<span class="nc" id="L4105">        assertThat(task).isNotNull();</span>
<span class="nc" id="L4106">        assertThat(task.getTaskLocalVariables()).isNotNull();</span>
<span class="nc" id="L4107">        bytes = (byte[]) task.getTaskLocalVariables().get(&quot;binaryTaskVariable&quot;);</span>
<span class="nc" id="L4108">        assertThat(new String(bytes)).isEqualTo(&quot;It is I, le binary&quot;);</span>
<span class="nc" id="L4109">    }</span>

    /**
     * Test confirming fix for ACT-1731
     */
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testIncludeBinaryVariablesOr() throws Exception {
        // Start process with a binary variable
<span class="nc" id="L4118">        ProcessInstance processInstance = runtimeService</span>
<span class="nc" id="L4119">                .startProcessInstanceByKey(&quot;oneTaskProcess&quot;, Collections.singletonMap(&quot;binaryVariable&quot;, (Object) &quot;It is I, le binary&quot;.getBytes()));</span>
<span class="nc" id="L4120">        org.flowable.task.api.Task task = taskService.createTaskQuery().or().taskName(&quot;invalid&quot;).processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L4121">        assertThat(task).isNotNull();</span>
<span class="nc" id="L4122">        taskService.setVariableLocal(task.getId(), &quot;binaryTaskVariable&quot;, (Object) &quot;It is I, le binary&quot;.getBytes());</span>

        // Query task, including processVariables
<span class="nc" id="L4125">        task = taskService.createTaskQuery().or().taskName(&quot;invalid&quot;).taskId(task.getId()).includeProcessVariables().singleResult();</span>
<span class="nc" id="L4126">        assertThat(task).isNotNull();</span>
<span class="nc" id="L4127">        assertThat(task.getProcessVariables()).isNotNull();</span>
<span class="nc" id="L4128">        byte[] bytes = (byte[]) task.getProcessVariables().get(&quot;binaryVariable&quot;);</span>
<span class="nc" id="L4129">        assertThat(new String(bytes)).isEqualTo(&quot;It is I, le binary&quot;);</span>

        // Query task, including taskVariables
<span class="nc" id="L4132">        task = taskService.createTaskQuery().or().taskName(&quot;invalid&quot;).taskId(task.getId()).includeTaskLocalVariables().singleResult();</span>
<span class="nc" id="L4133">        assertThat(task).isNotNull();</span>
<span class="nc" id="L4134">        assertThat(task.getTaskLocalVariables()).isNotNull();</span>
<span class="nc" id="L4135">        bytes = (byte[]) task.getTaskLocalVariables().get(&quot;binaryTaskVariable&quot;);</span>
<span class="nc" id="L4136">        assertThat(new String(bytes)).isEqualTo(&quot;It is I, le binary&quot;);</span>
<span class="nc" id="L4137">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testQueryByDeploymentId() throws Exception {
<span class="nc" id="L4142">        org.flowable.engine.repository.Deployment deployment = repositoryService.createDeploymentQuery().singleResult();</span>
<span class="nc" id="L4143">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L4144">        assertThat(taskService.createTaskQuery().deploymentId(deployment.getId()).singleResult()).isNotNull();</span>
<span class="nc" id="L4145">        assertThat(taskService.createTaskQuery().deploymentId(deployment.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L4146">        assertThat(taskService.createTaskQuery().deploymentId(&quot;invalid&quot;).singleResult()).isNull();</span>
<span class="nc" id="L4147">        assertThat(taskService.createTaskQuery().deploymentId(&quot;invalid&quot;).count()).isZero();</span>
<span class="nc" id="L4148">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testQueryByDeploymentIdOr() throws Exception {
<span class="nc" id="L4153">        org.flowable.engine.repository.Deployment deployment = repositoryService.createDeploymentQuery().singleResult();</span>
<span class="nc" id="L4154">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L4155">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).deploymentId(deployment.getId()).singleResult()).isNotNull();</span>
<span class="nc" id="L4156">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).deploymentId(deployment.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L4157">        assertThat(taskService.createTaskQuery().deploymentId(&quot;invalid&quot;).singleResult()).isNull();</span>
<span class="nc" id="L4158">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).deploymentId(&quot;invalid&quot;).count()).isZero();</span>
<span class="nc" id="L4159">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testQueryByDeploymentIdIn() throws Exception {
<span class="nc" id="L4164">        org.flowable.engine.repository.Deployment deployment = repositoryService.createDeploymentQuery().singleResult();</span>
<span class="nc" id="L4165">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L4166">        List&lt;String&gt; deploymentIds = Collections.singletonList(deployment.getId());</span>
<span class="nc" id="L4167">        assertThat(taskService.createTaskQuery().deploymentIdIn(deploymentIds).singleResult()).isNotNull();</span>
<span class="nc" id="L4168">        assertThat(taskService.createTaskQuery().deploymentIdIn(deploymentIds).count()).isEqualTo(1);</span>

<span class="nc" id="L4170">        deploymentIds = asList(deployment.getId(), &quot;invalid&quot;);</span>
<span class="nc" id="L4171">        assertThat(taskService.createTaskQuery().deploymentIdIn(deploymentIds).singleResult()).isNotNull();</span>
<span class="nc" id="L4172">        assertThat(taskService.createTaskQuery().deploymentIdIn(deploymentIds).count()).isEqualTo(1);</span>

<span class="nc" id="L4174">        deploymentIds = Collections.singletonList(&quot;invalid&quot;);</span>
<span class="nc" id="L4175">        assertThat(taskService.createTaskQuery().deploymentIdIn(deploymentIds).singleResult()).isNull();</span>
<span class="nc" id="L4176">        assertThat(taskService.createTaskQuery().deploymentIdIn(deploymentIds).count()).isZero();</span>
<span class="nc" id="L4177">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testQueryByDeploymentIdInOr() throws Exception {
<span class="nc" id="L4182">        org.flowable.engine.repository.Deployment deployment = repositoryService.createDeploymentQuery().singleResult();</span>
<span class="nc" id="L4183">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L4184">        List&lt;String&gt; deploymentIds = Collections.singletonList(deployment.getId());</span>
<span class="nc" id="L4185">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).deploymentIdIn(deploymentIds).singleResult()).isNotNull();</span>

<span class="nc" id="L4187">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).deploymentIdIn(deploymentIds).count()).isEqualTo(1);</span>

<span class="nc" id="L4189">        deploymentIds = asList(deployment.getId(), &quot;invalid&quot;);</span>
<span class="nc" id="L4190">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).deploymentIdIn(deploymentIds).singleResult()).isNotNull();</span>

<span class="nc" id="L4192">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).deploymentIdIn(deploymentIds).count()).isEqualTo(1);</span>

<span class="nc" id="L4194">        deploymentIds = Collections.singletonList(&quot;invalid&quot;);</span>
<span class="nc" id="L4195">        assertThat(taskService.createTaskQuery().deploymentIdIn(deploymentIds).singleResult()).isNull();</span>
<span class="nc" id="L4196">        assertThat(taskService.createTaskQuery().or().taskId(&quot;invalid&quot;).deploymentIdIn(deploymentIds).count()).isZero();</span>
<span class="nc" id="L4197">    }</span>
    
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testWithoutScopeId() throws Exception {
<span class="nc" id="L4202">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L4204">        assertThat(taskService.createTaskQuery().withoutScopeId().count()).isEqualTo(13);</span>
<span class="nc" id="L4205">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).withoutScopeId().count()).isEqualTo(1);</span>
<span class="nc" id="L4206">    }</span>

    @Test
    public void testQueryByTaskNameLikeIgnoreCase() {

        // Runtime
<span class="nc" id="L4212">        assertThat(taskService.createTaskQuery().taskNameLikeIgnoreCase(&quot;%task%&quot;).count()).isEqualTo(12);</span>
<span class="nc" id="L4213">        assertThat(taskService.createTaskQuery().taskNameLikeIgnoreCase(&quot;%Task%&quot;).count()).isEqualTo(12);</span>
<span class="nc" id="L4214">        assertThat(taskService.createTaskQuery().taskNameLikeIgnoreCase(&quot;%TASK%&quot;).count()).isEqualTo(12);</span>
<span class="nc" id="L4215">        assertThat(taskService.createTaskQuery().taskNameLikeIgnoreCase(&quot;%TasK%&quot;).count()).isEqualTo(12);</span>
<span class="nc" id="L4216">        assertThat(taskService.createTaskQuery().taskNameLikeIgnoreCase(&quot;gonzo%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L4217">        assertThat(taskService.createTaskQuery().taskNameLikeIgnoreCase(&quot;%Gonzo%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L4218">        assertThat(taskService.createTaskQuery().taskNameLikeIgnoreCase(&quot;Task%&quot;).count()).isZero();</span>

<span class="nc bnc" id="L4220" title="All 2 branches missed.">        if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
            // History
<span class="nc" id="L4222">            assertThat(historyService.createHistoricTaskInstanceQuery().taskNameLikeIgnoreCase(&quot;%task%&quot;).count()).isEqualTo(12);</span>
<span class="nc" id="L4223">            assertThat(historyService.createHistoricTaskInstanceQuery().taskNameLikeIgnoreCase(&quot;%Task%&quot;).count()).isEqualTo(12);</span>
<span class="nc" id="L4224">            assertThat(historyService.createHistoricTaskInstanceQuery().taskNameLikeIgnoreCase(&quot;%TASK%&quot;).count()).isEqualTo(12);</span>
<span class="nc" id="L4225">            assertThat(historyService.createHistoricTaskInstanceQuery().taskNameLikeIgnoreCase(&quot;%TasK%&quot;).count()).isEqualTo(12);</span>
<span class="nc" id="L4226">            assertThat(historyService.createHistoricTaskInstanceQuery().taskNameLikeIgnoreCase(&quot;gonzo%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L4227">            assertThat(historyService.createHistoricTaskInstanceQuery().taskNameLikeIgnoreCase(&quot;%Gonzo%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L4228">            assertThat(historyService.createHistoricTaskInstanceQuery().taskNameLikeIgnoreCase(&quot;Task%&quot;).count()).isZero();</span>
        }
<span class="nc" id="L4230">    }</span>

    @Test
    public void testQueryByTaskNameOrDescriptionLikeIgnoreCase() {

        // Runtime
<span class="nc" id="L4236">        assertThat(taskService.createTaskQuery().or().taskNameLikeIgnoreCase(&quot;%task%&quot;).taskDescriptionLikeIgnoreCase(&quot;%task%&quot;).endOr().count()).isEqualTo(12);</span>

<span class="nc" id="L4238">        assertThat(taskService.createTaskQuery().or().taskNameLikeIgnoreCase(&quot;ACCOUN%&quot;).taskDescriptionLikeIgnoreCase(&quot;%ESCR%&quot;).endOr().count()).isEqualTo(9);</span>

<span class="nc bnc" id="L4240" title="All 2 branches missed.">        if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
            // History
<span class="nc" id="L4242">            assertThat(historyService.createHistoricTaskInstanceQuery().or().taskNameLikeIgnoreCase(&quot;%task%&quot;).taskDescriptionLikeIgnoreCase(&quot;%task%&quot;).endOr()</span>
<span class="nc" id="L4243">                    .count()).isEqualTo(12);</span>

<span class="nc" id="L4245">            assertThat(historyService.createHistoricTaskInstanceQuery().or().taskNameLikeIgnoreCase(&quot;ACCOUN%&quot;).taskDescriptionLikeIgnoreCase(&quot;%ESCR%&quot;).endOr()</span>
<span class="nc" id="L4246">                    .count()).isEqualTo(9);</span>
        }

<span class="nc" id="L4249">    }</span>

    @Test
    public void testQueryByTaskDescriptionLikeIgnoreCase() {

        // Runtime
<span class="nc" id="L4255">        assertThat(taskService.createTaskQuery().taskDescriptionLikeIgnoreCase(&quot;%task%&quot;).count()).isEqualTo(6);</span>
<span class="nc" id="L4256">        assertThat(taskService.createTaskQuery().taskDescriptionLikeIgnoreCase(&quot;%Task%&quot;).count()).isEqualTo(6);</span>
<span class="nc" id="L4257">        assertThat(taskService.createTaskQuery().taskDescriptionLikeIgnoreCase(&quot;%TASK%&quot;).count()).isEqualTo(6);</span>
<span class="nc" id="L4258">        assertThat(taskService.createTaskQuery().taskDescriptionLikeIgnoreCase(&quot;%TaSk%&quot;).count()).isEqualTo(6);</span>
<span class="nc" id="L4259">        assertThat(taskService.createTaskQuery().taskDescriptionLikeIgnoreCase(&quot;task%&quot;).count()).isZero();</span>
<span class="nc" id="L4260">        assertThat(taskService.createTaskQuery().taskDescriptionLikeIgnoreCase(&quot;gonzo%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L4261">        assertThat(taskService.createTaskQuery().taskDescriptionLikeIgnoreCase(&quot;Gonzo%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L4262">        assertThat(taskService.createTaskQuery().taskDescriptionLikeIgnoreCase(&quot;%manage%&quot;).count()).isZero();</span>

<span class="nc bnc" id="L4264" title="All 2 branches missed.">        if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
            // History
<span class="nc" id="L4266">            assertThat(historyService.createHistoricTaskInstanceQuery().taskDescriptionLikeIgnoreCase(&quot;%task%&quot;).count()).isEqualTo(6);</span>
<span class="nc" id="L4267">            assertThat(historyService.createHistoricTaskInstanceQuery().taskDescriptionLikeIgnoreCase(&quot;%Task%&quot;).count()).isEqualTo(6);</span>
<span class="nc" id="L4268">            assertThat(historyService.createHistoricTaskInstanceQuery().taskDescriptionLikeIgnoreCase(&quot;%TASK%&quot;).count()).isEqualTo(6);</span>
<span class="nc" id="L4269">            assertThat(historyService.createHistoricTaskInstanceQuery().taskDescriptionLikeIgnoreCase(&quot;%TaSk%&quot;).count()).isEqualTo(6);</span>
<span class="nc" id="L4270">            assertThat(historyService.createHistoricTaskInstanceQuery().taskDescriptionLikeIgnoreCase(&quot;task%&quot;).count()).isZero();</span>
<span class="nc" id="L4271">            assertThat(historyService.createHistoricTaskInstanceQuery().taskDescriptionLikeIgnoreCase(&quot;gonzo%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L4272">            assertThat(historyService.createHistoricTaskInstanceQuery().taskDescriptionLikeIgnoreCase(&quot;Gonzo%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L4273">            assertThat(historyService.createHistoricTaskInstanceQuery().taskDescriptionLikeIgnoreCase(&quot;%manage%&quot;).count()).isZero();</span>
        }
<span class="nc" id="L4275">    }</span>

    @Test
    public void testQueryByAssigneeLikeIgnoreCase() {

        // Runtime
<span class="nc" id="L4281">        assertThat(taskService.createTaskQuery().taskAssigneeLikeIgnoreCase(&quot;%gonzo%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L4282">        assertThat(taskService.createTaskQuery().taskAssigneeLikeIgnoreCase(&quot;%GONZO%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L4283">        assertThat(taskService.createTaskQuery().taskAssigneeLikeIgnoreCase(&quot;%Gon%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L4284">        assertThat(taskService.createTaskQuery().taskAssigneeLikeIgnoreCase(&quot;gon%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L4285">        assertThat(taskService.createTaskQuery().taskAssigneeLikeIgnoreCase(&quot;%nzo%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L4286">        assertThat(taskService.createTaskQuery().taskAssigneeLikeIgnoreCase(&quot;%doesnotexist%&quot;).count()).isZero();</span>

<span class="nc bnc" id="L4288" title="All 2 branches missed.">        if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
            // History
<span class="nc" id="L4290">            assertThat(historyService.createHistoricTaskInstanceQuery().taskAssigneeLikeIgnoreCase(&quot;%gonzo%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L4291">            assertThat(historyService.createHistoricTaskInstanceQuery().taskAssigneeLikeIgnoreCase(&quot;%GONZO%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L4292">            assertThat(historyService.createHistoricTaskInstanceQuery().taskAssigneeLikeIgnoreCase(&quot;%Gon%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L4293">            assertThat(historyService.createHistoricTaskInstanceQuery().taskAssigneeLikeIgnoreCase(&quot;gon%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L4294">            assertThat(historyService.createHistoricTaskInstanceQuery().taskAssigneeLikeIgnoreCase(&quot;%nzo%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L4295">            assertThat(historyService.createHistoricTaskInstanceQuery().taskAssigneeLikeIgnoreCase(&quot;%doesnotexist%&quot;).count()).isZero();</span>
        }
<span class="nc" id="L4297">    }</span>

    @Test
    public void testQueryByOwnerLikeIgnoreCase() {

        // Runtime
<span class="nc" id="L4303">        assertThat(taskService.createTaskQuery().taskOwnerLikeIgnoreCase(&quot;%gonzo%&quot;).count()).isEqualTo(6);</span>
<span class="nc" id="L4304">        assertThat(taskService.createTaskQuery().taskOwnerLikeIgnoreCase(&quot;%GONZO%&quot;).count()).isEqualTo(6);</span>
<span class="nc" id="L4305">        assertThat(taskService.createTaskQuery().taskOwnerLikeIgnoreCase(&quot;%Gon%&quot;).count()).isEqualTo(6);</span>
<span class="nc" id="L4306">        assertThat(taskService.createTaskQuery().taskOwnerLikeIgnoreCase(&quot;gon%&quot;).count()).isEqualTo(6);</span>
<span class="nc" id="L4307">        assertThat(taskService.createTaskQuery().taskOwnerLikeIgnoreCase(&quot;%nzo%&quot;).count()).isEqualTo(6);</span>
<span class="nc" id="L4308">        assertThat(taskService.createTaskQuery().taskOwnerLikeIgnoreCase(&quot;%doesnotexist%&quot;).count()).isZero();</span>

<span class="nc bnc" id="L4310" title="All 2 branches missed.">        if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
            // History
<span class="nc" id="L4312">            assertThat(historyService.createHistoricTaskInstanceQuery().taskOwnerLikeIgnoreCase(&quot;%gonzo%&quot;).count()).isEqualTo(6);</span>
<span class="nc" id="L4313">            assertThat(historyService.createHistoricTaskInstanceQuery().taskOwnerLikeIgnoreCase(&quot;%GONZO%&quot;).count()).isEqualTo(6);</span>
<span class="nc" id="L4314">            assertThat(historyService.createHistoricTaskInstanceQuery().taskOwnerLikeIgnoreCase(&quot;%Gon%&quot;).count()).isEqualTo(6);</span>
<span class="nc" id="L4315">            assertThat(historyService.createHistoricTaskInstanceQuery().taskOwnerLikeIgnoreCase(&quot;gon%&quot;).count()).isEqualTo(6);</span>
<span class="nc" id="L4316">            assertThat(historyService.createHistoricTaskInstanceQuery().taskOwnerLikeIgnoreCase(&quot;%nzo%&quot;).count()).isEqualTo(6);</span>
<span class="nc" id="L4317">            assertThat(historyService.createHistoricTaskInstanceQuery().taskOwnerLikeIgnoreCase(&quot;%doesnotexist%&quot;).count()).isZero();</span>
        }
<span class="nc" id="L4319">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testQueryByBusinessKeyLikeIgnoreCase() {
<span class="nc" id="L4324">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, &quot;BUSINESS-KEY-1&quot;);</span>
<span class="nc" id="L4325">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, &quot;Business-Key-2&quot;);</span>
<span class="nc" id="L4326">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, &quot;KeY-3&quot;);</span>

        // Runtime
<span class="nc" id="L4329">        assertThat(taskService.createTaskQuery().processInstanceBusinessKeyLikeIgnoreCase(&quot;%key%&quot;).count()).isEqualTo(3);</span>
<span class="nc" id="L4330">        assertThat(taskService.createTaskQuery().processInstanceBusinessKeyLikeIgnoreCase(&quot;%KEY%&quot;).count()).isEqualTo(3);</span>
<span class="nc" id="L4331">        assertThat(taskService.createTaskQuery().processInstanceBusinessKeyLikeIgnoreCase(&quot;%EY%&quot;).count()).isEqualTo(3);</span>
<span class="nc" id="L4332">        assertThat(taskService.createTaskQuery().processInstanceBusinessKeyLikeIgnoreCase(&quot;%business%&quot;).count()).isEqualTo(2);</span>
<span class="nc" id="L4333">        assertThat(taskService.createTaskQuery().processInstanceBusinessKeyLikeIgnoreCase(&quot;business%&quot;).count()).isEqualTo(2);</span>
<span class="nc" id="L4334">        assertThat(taskService.createTaskQuery().processInstanceBusinessKeyLikeIgnoreCase(&quot;%doesnotexist%&quot;).count()).isZero();</span>

<span class="nc bnc" id="L4336" title="All 2 branches missed.">        if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
            // History
<span class="nc" id="L4338">            assertThat(historyService.createHistoricTaskInstanceQuery().processInstanceBusinessKeyLikeIgnoreCase(&quot;%key%&quot;).count()).isEqualTo(3);</span>
<span class="nc" id="L4339">            assertThat(historyService.createHistoricTaskInstanceQuery().processInstanceBusinessKeyLikeIgnoreCase(&quot;%KEY%&quot;).count()).isEqualTo(3);</span>
<span class="nc" id="L4340">            assertThat(historyService.createHistoricTaskInstanceQuery().processInstanceBusinessKeyLikeIgnoreCase(&quot;%EY%&quot;).count()).isEqualTo(3);</span>
<span class="nc" id="L4341">            assertThat(historyService.createHistoricTaskInstanceQuery().processInstanceBusinessKeyLikeIgnoreCase(&quot;%business%&quot;).count()).isEqualTo(2);</span>
<span class="nc" id="L4342">            assertThat(historyService.createHistoricTaskInstanceQuery().processInstanceBusinessKeyLikeIgnoreCase(&quot;business%&quot;).count()).isEqualTo(2);</span>
<span class="nc" id="L4343">            assertThat(historyService.createHistoricTaskInstanceQuery().processInstanceBusinessKeyLikeIgnoreCase(&quot;%doesnotexist%&quot;).count()).isZero();</span>
        }
<span class="nc" id="L4345">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testQueryByProcessDefinitionKeyLikeIgnoreCase() {

        // Runtime
<span class="nc" id="L4352">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L4353">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L4354">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L4355">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L4357">        assertThat(taskService.createTaskQuery().processDefinitionKeyLikeIgnoreCase(&quot;%one%&quot;).count()).isEqualTo(4);</span>
<span class="nc" id="L4358">        assertThat(taskService.createTaskQuery().processDefinitionKeyLikeIgnoreCase(&quot;%ONE%&quot;).count()).isEqualTo(4);</span>
<span class="nc" id="L4359">        assertThat(taskService.createTaskQuery().processDefinitionKeyLikeIgnoreCase(&quot;ON%&quot;).count()).isEqualTo(4);</span>
<span class="nc" id="L4360">        assertThat(taskService.createTaskQuery().processDefinitionKeyLikeIgnoreCase(&quot;%fake%&quot;).count()).isZero();</span>

<span class="nc bnc" id="L4362" title="All 2 branches missed.">        if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
            // History
<span class="nc" id="L4364">            assertThat(historyService.createHistoricTaskInstanceQuery().processDefinitionKeyLikeIgnoreCase(&quot;%one%&quot;).count()).isEqualTo(4);</span>
<span class="nc" id="L4365">            assertThat(historyService.createHistoricTaskInstanceQuery().processDefinitionKeyLikeIgnoreCase(&quot;%ONE%&quot;).count()).isEqualTo(4);</span>
<span class="nc" id="L4366">            assertThat(historyService.createHistoricTaskInstanceQuery().processDefinitionKeyLikeIgnoreCase(&quot;ON%&quot;).count()).isEqualTo(4);</span>
<span class="nc" id="L4367">            assertThat(historyService.createHistoricTaskInstanceQuery().processDefinitionKeyLikeIgnoreCase(&quot;%fake%&quot;).count()).isZero();</span>
        }
<span class="nc" id="L4369">    }</span>

    @Test
    public void testCombinationOfOrAndLikeIgnoreCase() {

        // Runtime
<span class="nc" id="L4375">        assertThat(</span>
<span class="nc" id="L4376">                taskService.createTaskQuery().or().taskNameLikeIgnoreCase(&quot;%task%&quot;).taskDescriptionLikeIgnoreCase(&quot;%desc%&quot;).taskAssigneeLikeIgnoreCase(&quot;Gonz%&quot;)</span>
<span class="nc" id="L4377">                        .taskOwnerLike(&quot;G%&quot;).endOr()</span>
<span class="nc" id="L4378">                        .count()).isEqualTo(12);</span>

<span class="nc bnc" id="L4380" title="All 2 branches missed.">        if (isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {</span>
            // History
<span class="nc" id="L4382">            assertThat(historyService.createHistoricTaskInstanceQuery().or().taskNameLikeIgnoreCase(&quot;%task%&quot;).taskDescriptionLikeIgnoreCase(&quot;%desc%&quot;)</span>
<span class="nc" id="L4383">                    .taskAssigneeLikeIgnoreCase(&quot;Gonz%&quot;)</span>
<span class="nc" id="L4384">                    .taskOwnerLike(&quot;G%&quot;).endOr().count()).isEqualTo(12);</span>
        }
<span class="nc" id="L4386">    }</span>

    // Test for https://jira.codehaus.org/browse/ACT-2103
    @Test
    public void testTaskLocalAndProcessInstanceVariableEqualsInOr() {

<span class="nc" id="L4392">        deployOneTaskTestProcess();</span>
<span class="nc bnc" id="L4393" title="All 2 branches missed.">        for (int i = 0; i &lt; 10; i++) {</span>
<span class="nc" id="L4394">            runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
        }

<span class="nc" id="L4397">        List&lt;org.flowable.task.api.Task&gt; allTasks = taskService.createTaskQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).list();</span>
<span class="nc" id="L4398">        assertThat(allTasks).hasSize(10);</span>

        // Give two tasks a task local variable
<span class="nc" id="L4401">        taskService.setVariableLocal(allTasks.get(0).getId(), &quot;localVar&quot;, &quot;someValue&quot;);</span>
<span class="nc" id="L4402">        taskService.setVariableLocal(allTasks.get(1).getId(), &quot;localVar&quot;, &quot;someValue&quot;);</span>

        // Give three tasks a proc inst var
<span class="nc" id="L4405">        runtimeService.setVariable(allTasks.get(2).getProcessInstanceId(), &quot;var&quot;, &quot;theValue&quot;);</span>
<span class="nc" id="L4406">        runtimeService.setVariable(allTasks.get(3).getProcessInstanceId(), &quot;var&quot;, &quot;theValue&quot;);</span>
<span class="nc" id="L4407">        runtimeService.setVariable(allTasks.get(4).getProcessInstanceId(), &quot;var&quot;, &quot;theValue&quot;);</span>

<span class="nc" id="L4409">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;localVar&quot;, &quot;someValue&quot;).list()).hasSize(2);</span>
<span class="nc" id="L4410">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;var&quot;, &quot;theValue&quot;).list()).hasSize(3);</span>

<span class="nc" id="L4412">        assertThat(taskService.createTaskQuery().or()</span>
<span class="nc" id="L4413">                .taskVariableValueEquals(&quot;localVar&quot;, &quot;someValue&quot;)</span>
<span class="nc" id="L4414">                .processVariableValueEquals(&quot;var&quot;, &quot;theValue&quot;)</span>
<span class="nc" id="L4415">                .endOr().list()).hasSize(5);</span>

<span class="nc" id="L4417">        assertThat(taskService.createTaskQuery()</span>
<span class="nc" id="L4418">                .or()</span>
<span class="nc" id="L4419">                .taskVariableValueEquals(&quot;localVar&quot;, &quot;someValue&quot;)</span>
<span class="nc" id="L4420">                .processVariableValueEquals(&quot;var&quot;, &quot;theValue&quot;)</span>
<span class="nc" id="L4421">                .endOr()</span>
<span class="nc" id="L4422">                .or()</span>
<span class="nc" id="L4423">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L4424">                .processDefinitionId(&quot;notexisting&quot;)</span>
<span class="nc" id="L4425">                .endOr()</span>
<span class="nc" id="L4426">                .list()).hasSize(5);</span>
<span class="nc" id="L4427">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; },
        tenantId = &quot;testTenant&quot;
    )
    public void testIncludeTaskLocalAndProcessInstanceVariableHasTenant() {
<span class="nc bnc" id="L4434" title="All 2 branches missed.">        for (int i = 0; i &lt; 10; i++) {</span>
<span class="nc" id="L4435">            runtimeService.startProcessInstanceByKeyAndTenantId(&quot;oneTaskProcess&quot;, Collections.singletonMap(&quot;simpleVar&quot;, &quot;simpleVarValue&quot;), &quot;testTenant&quot;);</span>
        }

<span class="nc" id="L4438">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).</span>
<span class="nc" id="L4439">            includeProcessVariables().includeTaskLocalVariables()</span>
<span class="nc" id="L4440">            .list();</span>

<span class="nc" id="L4442">        assertThat(tasks).hasSize(10);</span>
<span class="nc bnc" id="L4443" title="All 2 branches missed.">        for (Task task : tasks) {</span>
<span class="nc" id="L4444">            assertThat(task.getTenantId()).isEqualTo(&quot;testTenant&quot;);</span>
<span class="nc" id="L4445">        }</span>
<span class="nc" id="L4446">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testLocalizeTasks() throws Exception {
<span class="nc" id="L4451">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L4453">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processDefinitionId(processInstance.getProcessDefinitionId()).list();</span>
<span class="nc" id="L4454">        assertThat(tasks)</span>
<span class="nc" id="L4455">                .extracting(Task::getName, Task::getDescription)</span>
<span class="nc" id="L4456">                .containsExactly(tuple(&quot;my task&quot;, &quot;My Task Description&quot;));</span>

<span class="nc" id="L4458">        tasks = taskService.createTaskQuery().processDefinitionId(processInstance.getProcessDefinitionId()).locale(&quot;es&quot;).list();</span>
<span class="nc" id="L4459">        assertThat(tasks)</span>
<span class="nc" id="L4460">                .extracting(Task::getName, Task::getDescription)</span>
<span class="nc" id="L4461">                .containsExactly(tuple(&quot;Mi Tarea&quot;, &quot;Mi Tarea Descripcin&quot;));</span>

<span class="nc" id="L4463">        tasks = taskService.createTaskQuery().processDefinitionId(processInstance.getProcessDefinitionId()).locale(&quot;it&quot;).list();</span>
<span class="nc" id="L4464">        assertThat(tasks)</span>
<span class="nc" id="L4465">                .extracting(Task::getName, Task::getDescription)</span>
<span class="nc" id="L4466">                .containsExactly(tuple(&quot;Il mio compito&quot;, &quot;Il mio compito Descrizione&quot;));</span>

<span class="nc" id="L4468">        ObjectNode infoNode = dynamicBpmnService.getProcessDefinitionInfo(processInstance.getProcessDefinitionId());</span>

<span class="nc" id="L4470">        dynamicBpmnService.changeLocalizationName(&quot;en-GB&quot;, &quot;theTask&quot;, &quot;My 'en-GB' localized name&quot;, infoNode);</span>
<span class="nc" id="L4471">        dynamicBpmnService.changeLocalizationDescription(&quot;en-GB&quot;, &quot;theTask&quot;, &quot;My 'en-GB' localized description&quot;, infoNode);</span>
<span class="nc" id="L4472">        dynamicBpmnService.saveProcessDefinitionInfo(processInstance.getProcessDefinitionId(), infoNode);</span>

<span class="nc" id="L4474">        dynamicBpmnService.changeLocalizationName(&quot;en&quot;, &quot;theTask&quot;, &quot;My 'en' localized name&quot;, infoNode);</span>
<span class="nc" id="L4475">        dynamicBpmnService.changeLocalizationDescription(&quot;en&quot;, &quot;theTask&quot;, &quot;My 'en' localized description&quot;, infoNode);</span>
<span class="nc" id="L4476">        dynamicBpmnService.saveProcessDefinitionInfo(processInstance.getProcessDefinitionId(), infoNode);</span>

<span class="nc" id="L4478">        tasks = taskService.createTaskQuery().processDefinitionId(processInstance.getProcessDefinitionId()).list();</span>
<span class="nc" id="L4479">        assertThat(tasks)</span>
<span class="nc" id="L4480">                .extracting(Task::getName, Task::getDescription)</span>
<span class="nc" id="L4481">                .containsExactly(tuple(&quot;my task&quot;, &quot;My Task Description&quot;));</span>

<span class="nc" id="L4483">        tasks = taskService.createTaskQuery().processDefinitionId(processInstance.getProcessDefinitionId()).locale(&quot;es&quot;).list();</span>
<span class="nc" id="L4484">        assertThat(tasks)</span>
<span class="nc" id="L4485">                .extracting(Task::getName, Task::getDescription)</span>
<span class="nc" id="L4486">                .containsExactly(tuple(&quot;Mi Tarea&quot;, &quot;Mi Tarea Descripcin&quot;));</span>

<span class="nc" id="L4488">        tasks = taskService.createTaskQuery().processDefinitionId(processInstance.getProcessDefinitionId()).locale(&quot;it&quot;).list();</span>
<span class="nc" id="L4489">        assertThat(tasks)</span>
<span class="nc" id="L4490">                .extracting(Task::getName, Task::getDescription)</span>
<span class="nc" id="L4491">                .containsExactly(tuple(&quot;Il mio compito&quot;, &quot;Il mio compito Descrizione&quot;));</span>

<span class="nc" id="L4493">        tasks = taskService.createTaskQuery().processDefinitionId(processInstance.getProcessDefinitionId()).locale(&quot;en-GB&quot;).list();</span>
<span class="nc" id="L4494">        assertThat(tasks)</span>
<span class="nc" id="L4495">                .extracting(Task::getName, Task::getDescription)</span>
<span class="nc" id="L4496">                .containsExactly(tuple(&quot;My 'en-GB' localized name&quot;, &quot;My 'en-GB' localized description&quot;));</span>

<span class="nc" id="L4498">        tasks = taskService.createTaskQuery().processDefinitionId(processInstance.getProcessDefinitionId()).listPage(0, 10);</span>
<span class="nc" id="L4499">        assertThat(tasks)</span>
<span class="nc" id="L4500">                .extracting(Task::getName, Task::getDescription)</span>
<span class="nc" id="L4501">                .containsExactly(tuple(&quot;my task&quot;, &quot;My Task Description&quot;));</span>

<span class="nc" id="L4503">        tasks = taskService.createTaskQuery().processDefinitionId(processInstance.getProcessDefinitionId()).locale(&quot;es&quot;).listPage(0, 10);</span>
<span class="nc" id="L4504">        assertThat(tasks)</span>
<span class="nc" id="L4505">                .extracting(Task::getName, Task::getDescription)</span>
<span class="nc" id="L4506">                .containsExactly(tuple(&quot;Mi Tarea&quot;, &quot;Mi Tarea Descripcin&quot;));</span>

<span class="nc" id="L4508">        tasks = taskService.createTaskQuery().processDefinitionId(processInstance.getProcessDefinitionId()).locale(&quot;it&quot;).listPage(0, 10);</span>
<span class="nc" id="L4509">        assertThat(tasks)</span>
<span class="nc" id="L4510">                .extracting(Task::getName, Task::getDescription)</span>
<span class="nc" id="L4511">                .containsExactly(tuple(&quot;Il mio compito&quot;, &quot;Il mio compito Descrizione&quot;));</span>

<span class="nc" id="L4513">        tasks = taskService.createTaskQuery().processDefinitionId(processInstance.getProcessDefinitionId()).locale(&quot;en-GB&quot;).listPage(0, 10);</span>
<span class="nc" id="L4514">        assertThat(tasks)</span>
<span class="nc" id="L4515">                .extracting(Task::getName, Task::getDescription)</span>
<span class="nc" id="L4516">                .containsExactly(tuple(&quot;My 'en-GB' localized name&quot;, &quot;My 'en-GB' localized description&quot;));</span>

<span class="nc" id="L4518">        org.flowable.task.api.Task task = taskService.createTaskQuery().processDefinitionId(processInstance.getProcessDefinitionId()).singleResult();</span>
<span class="nc" id="L4519">        assertThat(task.getName()).isEqualTo(&quot;my task&quot;);</span>
<span class="nc" id="L4520">        assertThat(task.getDescription()).isEqualTo(&quot;My Task Description&quot;);</span>

<span class="nc" id="L4522">        task = taskService.createTaskQuery().processDefinitionId(processInstance.getProcessDefinitionId()).locale(&quot;es&quot;).singleResult();</span>
<span class="nc" id="L4523">        assertThat(task.getName()).isEqualTo(&quot;Mi Tarea&quot;);</span>
<span class="nc" id="L4524">        assertThat(task.getDescription()).isEqualTo(&quot;Mi Tarea Descripcin&quot;);</span>

<span class="nc" id="L4526">        task = taskService.createTaskQuery().processDefinitionId(processInstance.getProcessDefinitionId()).locale(&quot;it&quot;).singleResult();</span>
<span class="nc" id="L4527">        assertThat(task.getName()).isEqualTo(&quot;Il mio compito&quot;);</span>
<span class="nc" id="L4528">        assertThat(task.getDescription()).isEqualTo(&quot;Il mio compito Descrizione&quot;);</span>

<span class="nc" id="L4530">        task = taskService.createTaskQuery().processDefinitionId(processInstance.getProcessDefinitionId()).locale(&quot;en-GB&quot;).singleResult();</span>
<span class="nc" id="L4531">        assertThat(task.getName()).isEqualTo(&quot;My 'en-GB' localized name&quot;);</span>
<span class="nc" id="L4532">        assertThat(task.getDescription()).isEqualTo(&quot;My 'en-GB' localized description&quot;);</span>

<span class="nc" id="L4534">        task = taskService.createTaskQuery().processDefinitionId(processInstance.getProcessDefinitionId()).singleResult();</span>
<span class="nc" id="L4535">        assertThat(task.getName()).isEqualTo(&quot;my task&quot;);</span>
<span class="nc" id="L4536">        assertThat(task.getDescription()).isEqualTo(&quot;My Task Description&quot;);</span>

<span class="nc" id="L4538">        task = taskService.createTaskQuery().processDefinitionId(processInstance.getProcessDefinitionId()).locale(&quot;en&quot;).singleResult();</span>
<span class="nc" id="L4539">        assertThat(task.getName()).isEqualTo(&quot;My 'en' localized name&quot;);</span>
<span class="nc" id="L4540">        assertThat(task.getDescription()).isEqualTo(&quot;My 'en' localized description&quot;);</span>

<span class="nc" id="L4542">        task = taskService.createTaskQuery().processDefinitionId(processInstance.getProcessDefinitionId()).locale(&quot;en-AU&quot;).withLocalizationFallback()</span>
<span class="nc" id="L4543">                .singleResult();</span>
<span class="nc" id="L4544">        assertThat(task.getName()).isEqualTo(&quot;My 'en' localized name&quot;);</span>
<span class="nc" id="L4545">        assertThat(task.getDescription()).isEqualTo(&quot;My 'en' localized description&quot;);</span>
<span class="nc" id="L4546">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/task/TaskQueryTest.testProcessDefinition.bpmn20.xml&quot; })
    public void testNullHandlingOrder() {
<span class="nc" id="L4551">        ProcessInstance firstProcessInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L4552">        ProcessInstance secondProcessInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L4554">        Task firstTask = taskService.createTaskQuery().processInstanceId(firstProcessInstance.getId()).singleResult();</span>
<span class="nc" id="L4555">        Task secondTask = taskService.createTaskQuery().processInstanceId(secondProcessInstance.getId()).singleResult();</span>

<span class="nc" id="L4557">        taskService.setDueDate(secondTask.getId(), new Date());</span>

<span class="nc" id="L4559">        List&lt;Task&gt; tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L4560">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L4561">                .orderByDueDateNullsLast()</span>
<span class="nc" id="L4562">                .asc()</span>
<span class="nc" id="L4563">                .listPage(0, 10);</span>

        // The order has to be exactly like defined, since we are testing the nulls last functionality
<span class="nc" id="L4566">        assertThat(tasks)</span>
<span class="nc" id="L4567">                .extracting(Task::getId)</span>
<span class="nc" id="L4568">                .containsExactly(secondTask.getId(), firstTask.getId());</span>

<span class="nc" id="L4570">        tasks = taskService.createTaskQuery()</span>
<span class="nc" id="L4571">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L4572">                .orderByDueDateNullsFirst()</span>
<span class="nc" id="L4573">                .asc()</span>
<span class="nc" id="L4574">                .listPage(0, 10);</span>

        // The order has to be exactly like defined, since we are testing the nulls last functionality
<span class="nc" id="L4577">        assertThat(tasks)</span>
<span class="nc" id="L4578">                .extracting(Task::getId)</span>
<span class="nc" id="L4579">                .containsExactly(firstTask.getId(), secondTask.getId());</span>

<span class="nc bnc" id="L4581" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L4582">            List&lt;HistoricTaskInstance&gt; historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L4583">                    .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L4584">                    .orderByDueDateNullsLast()</span>
<span class="nc" id="L4585">                    .asc()</span>
<span class="nc" id="L4586">                    .listPage(0, 10);</span>

            // The order has to be exactly like defined, since we are testing the nulls last functionality
<span class="nc" id="L4589">            assertThat(historicTasks)</span>
<span class="nc" id="L4590">                    .extracting(HistoricTaskInstance::getId)</span>
<span class="nc" id="L4591">                    .containsExactly(secondTask.getId(), firstTask.getId());</span>

<span class="nc" id="L4593">            historicTasks = historyService.createHistoricTaskInstanceQuery()</span>
<span class="nc" id="L4594">                    .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L4595">                    .orderByDueDateNullsFirst()</span>
<span class="nc" id="L4596">                    .asc()</span>
<span class="nc" id="L4597">                    .listPage(0, 10);</span>

            // The order has to be exactly like defined, since we are testing the nulls last functionality
<span class="nc" id="L4600">            assertThat(historicTasks)</span>
<span class="nc" id="L4601">                    .extracting(HistoricTaskInstance::getId)</span>
<span class="nc" id="L4602">                    .containsExactly(firstTask.getId(), secondTask.getId());</span>
        }
<span class="nc" id="L4604">    }</span>

    @Test
    public void testQueryVariableValueEqualsAndNotEquals() {
<span class="nc" id="L4608">        Task taskWithStringValue = taskService.createTaskBuilder()</span>
<span class="nc" id="L4609">                .name(&quot;With string value&quot;)</span>
<span class="nc" id="L4610">                .create();</span>
<span class="nc" id="L4611">        taskIds.add(taskWithStringValue.getId());</span>
<span class="nc" id="L4612">        taskService.setVariable(taskWithStringValue.getId(), &quot;var&quot;, &quot;TEST&quot;);</span>

<span class="nc" id="L4614">        Task taskWithNullValue = taskService.createTaskBuilder()</span>
<span class="nc" id="L4615">                .name(&quot;With null value&quot;)</span>
<span class="nc" id="L4616">                .create();</span>
<span class="nc" id="L4617">        taskIds.add(taskWithNullValue.getId());</span>
<span class="nc" id="L4618">        taskService.setVariable(taskWithNullValue.getId(), &quot;var&quot;, null);</span>

<span class="nc" id="L4620">        Task taskWithLongValue = taskService.createTaskBuilder()</span>
<span class="nc" id="L4621">                .name(&quot;With long value&quot;)</span>
<span class="nc" id="L4622">                .create();</span>
<span class="nc" id="L4623">        taskIds.add(taskWithLongValue.getId());</span>
<span class="nc" id="L4624">        taskService.setVariable(taskWithLongValue.getId(), &quot;var&quot;, 100L);</span>

<span class="nc" id="L4626">        Task taskWithDoubleValue = taskService.createTaskBuilder()</span>
<span class="nc" id="L4627">                .name(&quot;With double value&quot;)</span>
<span class="nc" id="L4628">                .create();</span>
<span class="nc" id="L4629">        taskIds.add(taskWithDoubleValue.getId());</span>
<span class="nc" id="L4630">        taskService.setVariable(taskWithDoubleValue.getId(), &quot;var&quot;, 45.55);</span>

<span class="nc" id="L4632">        assertThat(taskService.createTaskQuery().taskVariableValueNotEquals(&quot;var&quot;, &quot;TEST&quot;).list())</span>
<span class="nc" id="L4633">                .extracting(Task::getName, Task::getId)</span>
<span class="nc" id="L4634">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4635">                        tuple(&quot;With null value&quot;, taskWithNullValue.getId()),</span>
<span class="nc" id="L4636">                        tuple(&quot;With long value&quot;, taskWithLongValue.getId()),</span>
<span class="nc" id="L4637">                        tuple(&quot;With double value&quot;, taskWithDoubleValue.getId())</span>
                );

<span class="nc" id="L4640">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;var&quot;, &quot;TEST&quot;).list())</span>
<span class="nc" id="L4641">                .extracting(Task::getName, Task::getId)</span>
<span class="nc" id="L4642">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4643">                        tuple(&quot;With string value&quot;, taskWithStringValue.getId())</span>
                );

<span class="nc" id="L4646">        assertThat(taskService.createTaskQuery().taskVariableValueNotEquals(&quot;var&quot;, 100L).list())</span>
<span class="nc" id="L4647">                .extracting(Task::getName, Task::getId)</span>
<span class="nc" id="L4648">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4649">                        tuple(&quot;With string value&quot;, taskWithStringValue.getId()),</span>
<span class="nc" id="L4650">                        tuple(&quot;With null value&quot;, taskWithNullValue.getId()),</span>
<span class="nc" id="L4651">                        tuple(&quot;With double value&quot;, taskWithDoubleValue.getId())</span>
                );

<span class="nc" id="L4654">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;var&quot;, 100L).list())</span>
<span class="nc" id="L4655">                .extracting(Task::getName, Task::getId)</span>
<span class="nc" id="L4656">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4657">                        tuple(&quot;With long value&quot;, taskWithLongValue.getId())</span>
                );

<span class="nc" id="L4660">        assertThat(taskService.createTaskQuery().taskVariableValueNotEquals(&quot;var&quot;, 45.55).list())</span>
<span class="nc" id="L4661">                .extracting(Task::getName, Task::getId)</span>
<span class="nc" id="L4662">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4663">                        tuple(&quot;With string value&quot;, taskWithStringValue.getId()),</span>
<span class="nc" id="L4664">                        tuple(&quot;With null value&quot;, taskWithNullValue.getId()),</span>
<span class="nc" id="L4665">                        tuple(&quot;With long value&quot;, taskWithLongValue.getId())</span>
                );

<span class="nc" id="L4668">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;var&quot;, 45.55).list())</span>
<span class="nc" id="L4669">                .extracting(Task::getName, Task::getId)</span>
<span class="nc" id="L4670">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4671">                        tuple(&quot;With double value&quot;, taskWithDoubleValue.getId())</span>
                );

<span class="nc" id="L4674">        assertThat(taskService.createTaskQuery().taskVariableValueNotEquals(&quot;var&quot;, &quot;test&quot;).list())</span>
<span class="nc" id="L4675">                .extracting(Task::getName, Task::getId)</span>
<span class="nc" id="L4676">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4677">                        tuple(&quot;With string value&quot;, taskWithStringValue.getId()),</span>
<span class="nc" id="L4678">                        tuple(&quot;With null value&quot;, taskWithNullValue.getId()),</span>
<span class="nc" id="L4679">                        tuple(&quot;With long value&quot;, taskWithLongValue.getId()),</span>
<span class="nc" id="L4680">                        tuple(&quot;With double value&quot;, taskWithDoubleValue.getId())</span>
                );

<span class="nc" id="L4683">        assertThat(taskService.createTaskQuery().taskVariableValueNotEqualsIgnoreCase(&quot;var&quot;, &quot;test&quot;).list())</span>
<span class="nc" id="L4684">                .extracting(Task::getName, Task::getId)</span>
<span class="nc" id="L4685">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4686">                        tuple(&quot;With null value&quot;, taskWithNullValue.getId()),</span>
<span class="nc" id="L4687">                        tuple(&quot;With long value&quot;, taskWithLongValue.getId()),</span>
<span class="nc" id="L4688">                        tuple(&quot;With double value&quot;, taskWithDoubleValue.getId())</span>
                );

<span class="nc" id="L4691">        assertThat(taskService.createTaskQuery().taskVariableValueEquals(&quot;var&quot;, &quot;test&quot;).list())</span>
<span class="nc" id="L4692">                .extracting(Task::getName, Task::getId)</span>
<span class="nc" id="L4693">                .isEmpty();</span>

<span class="nc" id="L4695">        assertThat(taskService.createTaskQuery().taskVariableValueEqualsIgnoreCase(&quot;var&quot;, &quot;test&quot;).list())</span>
<span class="nc" id="L4696">                .extracting(Task::getName, Task::getId)</span>
<span class="nc" id="L4697">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4698">                        tuple(&quot;With string value&quot;, taskWithStringValue.getId())</span>
                );
<span class="nc" id="L4700">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryProcessVariableValueEqualsAndNotEquals() {
<span class="nc" id="L4705">        ProcessInstance processWithStringValue = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L4706">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L4707">                .name(&quot;With string value&quot;)</span>
<span class="nc" id="L4708">                .variable(&quot;var&quot;, &quot;TEST&quot;)</span>
<span class="nc" id="L4709">                .start();</span>

<span class="nc" id="L4711">        ProcessInstance processWithNullValue = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L4712">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L4713">                .name(&quot;With null value&quot;)</span>
<span class="nc" id="L4714">                .variable(&quot;var&quot;, null)</span>
<span class="nc" id="L4715">                .start();</span>

<span class="nc" id="L4717">        ProcessInstance processWithLongValue = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L4718">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L4719">                .name(&quot;With long value&quot;)</span>
<span class="nc" id="L4720">                .variable(&quot;var&quot;, 100L)</span>
<span class="nc" id="L4721">                .start();</span>

<span class="nc" id="L4723">        ProcessInstance processWithDoubleValue = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L4724">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L4725">                .name(&quot;With double value&quot;)</span>
<span class="nc" id="L4726">                .variable(&quot;var&quot;, 45.55)</span>
<span class="nc" id="L4727">                .start();</span>

<span class="nc" id="L4729">        assertThat(taskService.createTaskQuery().processVariableValueNotEquals(&quot;var&quot;, &quot;TEST&quot;).list())</span>
<span class="nc" id="L4730">                .extracting(Task::getName, Task::getProcessInstanceId)</span>
<span class="nc" id="L4731">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4732">                        tuple(&quot;my task&quot;, processWithNullValue.getId()),</span>
<span class="nc" id="L4733">                        tuple(&quot;my task&quot;, processWithLongValue.getId()),</span>
<span class="nc" id="L4734">                        tuple(&quot;my task&quot;, processWithDoubleValue.getId())</span>
                );

<span class="nc" id="L4737">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;var&quot;, &quot;TEST&quot;).list())</span>
<span class="nc" id="L4738">                .extracting(Task::getName, Task::getProcessInstanceId)</span>
<span class="nc" id="L4739">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4740">                        tuple(&quot;my task&quot;, processWithStringValue.getId())</span>
                );

<span class="nc" id="L4743">        assertThat(taskService.createTaskQuery().processVariableValueNotEquals(&quot;var&quot;, 100L).list())</span>
<span class="nc" id="L4744">                .extracting(Task::getName, Task::getProcessInstanceId)</span>
<span class="nc" id="L4745">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4746">                        tuple(&quot;my task&quot;, processWithStringValue.getId()),</span>
<span class="nc" id="L4747">                        tuple(&quot;my task&quot;, processWithNullValue.getId()),</span>
<span class="nc" id="L4748">                        tuple(&quot;my task&quot;, processWithDoubleValue.getId())</span>
                );

<span class="nc" id="L4751">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;var&quot;, 100L).list())</span>
<span class="nc" id="L4752">                .extracting(Task::getName, Task::getProcessInstanceId)</span>
<span class="nc" id="L4753">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4754">                        tuple(&quot;my task&quot;, processWithLongValue.getId())</span>
                );

<span class="nc" id="L4757">        assertThat(taskService.createTaskQuery().processVariableValueNotEquals(&quot;var&quot;, 45.55).list())</span>
<span class="nc" id="L4758">                .extracting(Task::getName, Task::getProcessInstanceId)</span>
<span class="nc" id="L4759">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4760">                        tuple(&quot;my task&quot;, processWithStringValue.getId()),</span>
<span class="nc" id="L4761">                        tuple(&quot;my task&quot;, processWithNullValue.getId()),</span>
<span class="nc" id="L4762">                        tuple(&quot;my task&quot;, processWithLongValue.getId())</span>
                );

<span class="nc" id="L4765">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;var&quot;, 45.55).list())</span>
<span class="nc" id="L4766">                .extracting(Task::getName, Task::getProcessInstanceId)</span>
<span class="nc" id="L4767">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4768">                        tuple(&quot;my task&quot;, processWithDoubleValue.getId())</span>
                );

<span class="nc" id="L4771">        assertThat(taskService.createTaskQuery().processVariableValueNotEquals(&quot;var&quot;, &quot;test&quot;).list())</span>
<span class="nc" id="L4772">                .extracting(Task::getName, Task::getProcessInstanceId)</span>
<span class="nc" id="L4773">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4774">                        tuple(&quot;my task&quot;, processWithStringValue.getId()),</span>
<span class="nc" id="L4775">                        tuple(&quot;my task&quot;, processWithNullValue.getId()),</span>
<span class="nc" id="L4776">                        tuple(&quot;my task&quot;, processWithLongValue.getId()),</span>
<span class="nc" id="L4777">                        tuple(&quot;my task&quot;, processWithDoubleValue.getId())</span>
                );

<span class="nc" id="L4780">        assertThat(taskService.createTaskQuery().processVariableValueNotEqualsIgnoreCase(&quot;var&quot;, &quot;test&quot;).list())</span>
<span class="nc" id="L4781">                .extracting(Task::getName, Task::getProcessInstanceId)</span>
<span class="nc" id="L4782">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4783">                        tuple(&quot;my task&quot;, processWithNullValue.getId()),</span>
<span class="nc" id="L4784">                        tuple(&quot;my task&quot;, processWithLongValue.getId()),</span>
<span class="nc" id="L4785">                        tuple(&quot;my task&quot;, processWithDoubleValue.getId())</span>
                );

<span class="nc" id="L4788">        assertThat(taskService.createTaskQuery().processVariableValueEquals(&quot;var&quot;, &quot;test&quot;).list())</span>
<span class="nc" id="L4789">                .extracting(Task::getName, Task::getProcessInstanceId)</span>
<span class="nc" id="L4790">                .isEmpty();</span>

<span class="nc" id="L4792">        assertThat(taskService.createTaskQuery().processVariableValueEqualsIgnoreCase(&quot;var&quot;, &quot;test&quot;).list())</span>
<span class="nc" id="L4793">                .extracting(Task::getName, Task::getProcessInstanceId)</span>
<span class="nc" id="L4794">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4795">                        tuple(&quot;my task&quot;, processWithStringValue.getId())</span>
                );
<span class="nc" id="L4797">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/simpleParallelCallActivity.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/simpleInnerCallActivity.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/simpleProcessWithUserTasks.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot;
    })
    public void testQueryByRootScopeId() {
<span class="nc" id="L4807">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L4808">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;simpleParallelCallActivity&quot;);</span>

<span class="nc" id="L4810">        List&lt;String&gt; taskExecutionIds = runtimeService.createExecutionQuery().rootProcessInstanceId(processInstance.getId())</span>
<span class="nc" id="L4811">                .processDefinitionKey(&quot;oneTaskProcess&quot;).activityId(&quot;theTask&quot;).list().stream().map(Execution::getId).toList();</span>

<span class="nc" id="L4813">        Task task1 = taskService.createTaskQuery().executionId(taskExecutionIds.get(0)).singleResult();</span>
<span class="nc" id="L4814">        Task task2 = taskService.createTaskQuery().executionId(taskExecutionIds.get(1)).singleResult();</span>
<span class="nc" id="L4815">        Task task3 = taskService.createTaskQuery().executionId(taskExecutionIds.get(2)).singleResult();</span>

<span class="nc" id="L4817">        Execution formTask1Execution = runtimeService.createExecutionQuery().rootProcessInstanceId(processInstance.getId()).activityId(&quot;formTask1&quot;)</span>
<span class="nc" id="L4818">                .singleResult();</span>
<span class="nc" id="L4819">        Task formTask1 = taskService.createTaskQuery().executionId(formTask1Execution.getId()).singleResult();</span>

<span class="nc" id="L4821">        Execution taskForm2Execution = runtimeService.createExecutionQuery().rootProcessInstanceId(processInstance.getId()).activityId(&quot;formTask2&quot;)</span>
<span class="nc" id="L4822">                .singleResult();</span>
<span class="nc" id="L4823">        Task formTask2 = taskService.createTaskQuery().executionId(taskForm2Execution.getId()).singleResult();</span>

<span class="nc" id="L4825">        List&lt;Task&gt; taskList = taskService.createTaskQuery().taskRootScopeId(processInstance.getId()).list();</span>

<span class="nc" id="L4827">        assertThat(taskList)</span>
<span class="nc" id="L4828">                .extracting(Task::getId)</span>
<span class="nc" id="L4829">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4830">                        task1.getId(),</span>
<span class="nc" id="L4831">                        task2.getId(),</span>
<span class="nc" id="L4832">                        task3.getId(),</span>
<span class="nc" id="L4833">                        formTask1.getId(),</span>
<span class="nc" id="L4834">                        formTask2.getId()</span>
                );

<span class="nc" id="L4837">        taskList = taskService.createTaskQuery().or().taskRootScopeId(processInstance.getId()).endOr().list();</span>

<span class="nc" id="L4839">        assertThat(taskList)</span>
<span class="nc" id="L4840">                .extracting(Task::getId)</span>
<span class="nc" id="L4841">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4842">                        task1.getId(),</span>
<span class="nc" id="L4843">                        task2.getId(),</span>
<span class="nc" id="L4844">                        task3.getId(),</span>
<span class="nc" id="L4845">                        formTask1.getId(),</span>
<span class="nc" id="L4846">                        formTask2.getId()</span>
                );
<span class="nc" id="L4848">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/simpleParallelCallActivity.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/simpleInnerCallActivity.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/simpleProcessWithUserTasks.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot;
    })
    public void testQueryByParentScopeId() {
<span class="nc" id="L4858">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L4859">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;simpleParallelCallActivity&quot;);</span>

<span class="nc" id="L4861">        Execution formTask1Execution = runtimeService.createExecutionQuery().rootProcessInstanceId(processInstance.getId()).activityId(&quot;formTask1&quot;)</span>
<span class="nc" id="L4862">                .singleResult();</span>
<span class="nc" id="L4863">        Task formTask1 = taskService.createTaskQuery().executionId(formTask1Execution.getId()).singleResult();</span>

<span class="nc" id="L4865">        Execution taskForm2Execution = runtimeService.createExecutionQuery().rootProcessInstanceId(processInstance.getId()).activityId(&quot;formTask2&quot;)</span>
<span class="nc" id="L4866">                .singleResult();</span>
<span class="nc" id="L4867">        Task formTask2 = taskService.createTaskQuery().executionId(taskForm2Execution.getId()).singleResult();</span>

<span class="nc" id="L4869">        List&lt;Task&gt; taskList = taskService.createTaskQuery().taskParentScopeId(taskForm2Execution.getProcessInstanceId()).list();</span>

<span class="nc" id="L4871">        assertThat(taskList)</span>
<span class="nc" id="L4872">                .extracting(Task::getId)</span>
<span class="nc" id="L4873">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4874">                        formTask1.getId(),</span>
<span class="nc" id="L4875">                        formTask2.getId()</span>
                );

<span class="nc" id="L4878">        taskList = taskService.createTaskQuery().or().taskParentScopeId(taskForm2Execution.getProcessInstanceId()).endOr().list();</span>

<span class="nc" id="L4880">        assertThat(taskList)</span>
<span class="nc" id="L4881">                .extracting(Task::getId)</span>
<span class="nc" id="L4882">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L4883">                        formTask1.getId(),</span>
<span class="nc" id="L4884">                        formTask2.getId()</span>
                );
<span class="nc" id="L4886">    }</span>

    private boolean isHistoryLevelAtLeast(HistoryLevel level) {
<span class="nc" id="L4889">        return HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration);</span>
    }

    /**
     * Generates some test tasks. - 6 tasks where kermit is a candidate - 1 tasks where gonzo is assignee - 2 tasks assigned to management group - 2 tasks assigned to accountancy group - 1 task
     * assigned to both the management and accountancy group
     */
    private List&lt;String&gt; generateTestTasks() throws Exception {
<span class="nc" id="L4897">        List&lt;String&gt; ids = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L4899">        SimpleDateFormat sdf = new SimpleDateFormat(&quot;dd/MM/yyyy hh:mm:ss.SSS&quot;);</span>
        // 6 tasks for kermit
<span class="nc" id="L4901">        processEngineConfiguration.getClock().setCurrentTime(sdf.parse(&quot;01/01/2001 01:01:01.000&quot;));</span>
<span class="nc bnc" id="L4902" title="All 2 branches missed.">        for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L4903">            org.flowable.task.api.Task task = taskService.newTask();</span>
<span class="nc" id="L4904">            task.setName(&quot;testTask&quot;);</span>
<span class="nc" id="L4905">            task.setDescription(&quot;testTask description&quot;);</span>
<span class="nc" id="L4906">            task.setOwner(&quot;gonzo&quot;);</span>
<span class="nc" id="L4907">            task.setPriority(3);</span>
<span class="nc" id="L4908">            taskService.saveTask(task);</span>
<span class="nc" id="L4909">            ids.add(task.getId());</span>
<span class="nc" id="L4910">            taskService.addCandidateUser(task.getId(), &quot;kermit&quot;);</span>
        }

<span class="nc" id="L4913">        processEngineConfiguration.getClock().setCurrentTime(sdf.parse(&quot;02/02/2002 02:02:02.000&quot;));</span>
        // 1 task for gonzo
<span class="nc" id="L4915">        org.flowable.task.api.Task task = taskService.newTask();</span>
<span class="nc" id="L4916">        task.setName(&quot;gonzoTask&quot;);</span>
<span class="nc" id="L4917">        task.setDescription(&quot;gonzo description&quot;);</span>
<span class="nc" id="L4918">        task.setPriority(4);</span>
<span class="nc" id="L4919">        taskService.saveTask(task);</span>
<span class="nc" id="L4920">        taskService.setAssignee(task.getId(), &quot;gonzo&quot;);</span>
<span class="nc" id="L4921">        taskService.setVariable(task.getId(), &quot;testVar&quot;, &quot;someVariable&quot;);</span>
<span class="nc" id="L4922">        ids.add(task.getId());</span>

<span class="nc" id="L4924">        processEngineConfiguration.getClock().setCurrentTime(sdf.parse(&quot;03/03/2003 03:03:03.000&quot;));</span>
        // 2 tasks for management group
<span class="nc bnc" id="L4926" title="All 2 branches missed.">        for (int i = 0; i &lt; 2; i++) {</span>
<span class="nc" id="L4927">            task = taskService.newTask();</span>
<span class="nc" id="L4928">            task.setName(&quot;managementTask&quot;);</span>
<span class="nc" id="L4929">            task.setPriority(10);</span>
<span class="nc" id="L4930">            taskService.saveTask(task);</span>
<span class="nc" id="L4931">            taskService.addCandidateGroup(task.getId(), &quot;management&quot;);</span>
<span class="nc" id="L4932">            ids.add(task.getId());</span>
        }

<span class="nc" id="L4935">        processEngineConfiguration.getClock().setCurrentTime(sdf.parse(&quot;04/04/2004 04:04:04.000&quot;));</span>
        // 2 tasks for accountancy group
<span class="nc bnc" id="L4937" title="All 2 branches missed.">        for (int i = 0; i &lt; 2; i++) {</span>
<span class="nc" id="L4938">            task = taskService.newTask();</span>
<span class="nc" id="L4939">            task.setName(&quot;accountancyTask&quot;);</span>
<span class="nc" id="L4940">            task.setDescription(&quot;accountancy description&quot;);</span>
<span class="nc" id="L4941">            taskService.saveTask(task);</span>
<span class="nc" id="L4942">            taskService.addCandidateGroup(task.getId(), &quot;accountancy&quot;);</span>
<span class="nc" id="L4943">            ids.add(task.getId());</span>
        }

<span class="nc" id="L4946">        processEngineConfiguration.getClock().setCurrentTime(sdf.parse(&quot;05/05/2005 05:05:05.000&quot;));</span>
        // 1 task assigned to management and accountancy group
<span class="nc" id="L4948">        task = taskService.newTask();</span>
<span class="nc" id="L4949">        task.setName(&quot;managementAndAccountancyTask&quot;);</span>
<span class="nc" id="L4950">        taskService.saveTask(task);</span>
<span class="nc" id="L4951">        taskService.addCandidateGroup(task.getId(), &quot;management&quot;);</span>
<span class="nc" id="L4952">        taskService.addCandidateGroup(task.getId(), &quot;accountancy&quot;);</span>
<span class="nc" id="L4953">        ids.add(task.getId());</span>

<span class="nc" id="L4955">        waitForHistoryJobExecutorToProcessAllJobs(10000, 200);</span>

<span class="nc" id="L4957">        return ids;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>