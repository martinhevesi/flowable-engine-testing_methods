<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MultiInstanceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.bpmn.multiinstance</a> &gt; <span class="el_source">MultiInstanceTest.java</span></div><h1>MultiInstanceTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.engine.test.bpmn.multiinstance;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.assertj.core.api.Assertions.entry;
import static org.assertj.core.api.Assertions.tuple;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.stream.Collectors;

import org.flowable.common.engine.api.FlowableIllegalArgumentException;
import org.flowable.common.engine.api.delegate.event.FlowableEngineEntityEvent;
import org.flowable.common.engine.api.delegate.event.FlowableEngineEventType;
import org.flowable.common.engine.api.delegate.event.FlowableEvent;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.common.engine.impl.util.CollectionUtil;
import org.flowable.engine.delegate.DelegateExecution;
import org.flowable.engine.delegate.ExecutionListener;
import org.flowable.engine.delegate.TaskListener;
import org.flowable.engine.delegate.event.AbstractFlowableEngineEventListener;
import org.flowable.engine.delegate.event.FlowableActivityCancelledEvent;
import org.flowable.engine.delegate.event.FlowableActivityEvent;
import org.flowable.engine.delegate.event.FlowableCancelledEvent;
import org.flowable.engine.delegate.event.FlowableMultiInstanceActivityCancelledEvent;
import org.flowable.engine.delegate.event.FlowableMultiInstanceActivityCompletedEvent;
import org.flowable.engine.delegate.event.FlowableMultiInstanceActivityEvent;
import org.flowable.engine.delegate.event.FlowableProcessStartedEvent;
import org.flowable.engine.history.HistoricActivityInstance;
import org.flowable.engine.history.HistoricProcessInstance;
import org.flowable.engine.impl.persistence.entity.ExecutionEntity;
import org.flowable.engine.impl.test.HistoryTestHelper;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.runtime.Execution;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.examples.bpmn.servicetask.ValueBean;
import org.flowable.job.api.Job;
import org.flowable.job.api.JobInfo;
import org.flowable.task.api.Task;
import org.flowable.task.api.TaskQuery;
import org.flowable.task.api.history.HistoricTaskInstance;
import org.flowable.task.service.delegate.DelegateTask;
import org.flowable.variable.api.history.HistoricVariableInstance;
import org.flowable.variable.api.persistence.entity.VariableInstance;
import org.junit.jupiter.api.Test;

/**
 * @author Joram Barrez
 * @author Tijs Rademakers
 */
<span class="nc" id="L73">public class MultiInstanceTest extends PluggableFlowableTestCase {</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.sequentialUserTasks.bpmn20.xml&quot; })
    public void testSequentialUserTasks() {
<span class="nc" id="L78">        checkSequentialUserTasks(&quot;miSequentialUserTasks&quot;);</span>
<span class="nc" id="L79">    }</span>

    @Test
    @Deployment
    public void testSequentialUserTasksCustomExtensions() {
<span class="nc" id="L84">        checkSequentialUserTasks(&quot;miSequentialUserTasksCustomExtensions&quot;);</span>
<span class="nc" id="L85">    }</span>

    private void checkSequentialUserTasks(String processDefinitionKey) {
<span class="nc" id="L88">        String procId = runtimeService.startProcessInstanceByKey(processDefinitionKey, CollectionUtil.singletonMap(&quot;nrOfLoops&quot;, 3)).getId();</span>

<span class="nc" id="L90">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L91">        assertThat(task.getName()).isEqualTo(&quot;My Task&quot;);</span>
<span class="nc" id="L92">        assertThat(task.getAssignee()).isEqualTo(&quot;kermit_0&quot;);</span>
<span class="nc" id="L93">        taskService.complete(task.getId());</span>

<span class="nc" id="L95">        task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L96">        assertThat(task.getName()).isEqualTo(&quot;My Task&quot;);</span>
<span class="nc" id="L97">        assertThat(task.getAssignee()).isEqualTo(&quot;kermit_1&quot;);</span>
<span class="nc" id="L98">        taskService.complete(task.getId());</span>

<span class="nc" id="L100">        task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L101">        assertThat(task.getName()).isEqualTo(&quot;My Task&quot;);</span>
<span class="nc" id="L102">        assertThat(task.getAssignee()).isEqualTo(&quot;kermit_2&quot;);</span>
<span class="nc" id="L103">        taskService.complete(task.getId());</span>

<span class="nc" id="L105">        assertThat(taskService.createTaskQuery().singleResult()).isNull();</span>
<span class="nc" id="L106">        assertProcessEnded(procId);</span>
<span class="nc" id="L107">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.sequentialUserTasks.bpmn20.xml&quot; })
    public void testSequentialUserTasksHistory() {
<span class="nc" id="L112">        String procId = runtimeService.startProcessInstanceByKey(&quot;miSequentialUserTasks&quot;, CollectionUtil.singletonMap(&quot;nrOfLoops&quot;, 4)).getId();</span>
        
<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L115">            assertThat(historyService.createHistoricTaskInstanceQuery().processInstanceId(procId).list()).hasSize(1);</span>
        }
        
<span class="nc bnc" id="L118" title="All 2 branches missed.">        for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc" id="L119">            String taskId = taskService.createTaskQuery().singleResult().getId();</span>
<span class="nc" id="L120">            taskService.complete(taskId);</span>
            
<span class="nc bnc" id="L122" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L123">                assertThat(historyService.createHistoricTaskInstanceQuery().taskId(taskId).singleResult()).isNotNull();</span>
            }
        }
<span class="nc" id="L126">        assertProcessEnded(procId);</span>

<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L129">            List&lt;HistoricTaskInstance&gt; historicTaskInstances = historyService.createHistoricTaskInstanceQuery().list();</span>
<span class="nc" id="L130">            assertThat(historicTaskInstances).hasSize(4);</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">            for (HistoricTaskInstance ht : historicTaskInstances) {</span>
<span class="nc" id="L132">                assertThat(ht.getAssignee()).isNotNull();</span>
<span class="nc" id="L133">                assertThat(ht.getStartTime()).isNotNull();</span>
<span class="nc" id="L134">                assertThat(ht.getEndTime()).isNotNull();</span>
<span class="nc" id="L135">            }</span>

<span class="nc" id="L137">            List&lt;HistoricActivityInstance&gt; historicActivityInstances = historyService.createHistoricActivityInstanceQuery().activityType(&quot;userTask&quot;).list();</span>
<span class="nc" id="L138">            assertThat(historicActivityInstances).hasSize(4);</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">            for (HistoricActivityInstance hai : historicActivityInstances) {</span>
<span class="nc" id="L140">                assertThat(hai.getActivityId()).isNotNull();</span>
<span class="nc" id="L141">                assertThat(hai.getActivityName()).isNotNull();</span>
<span class="nc" id="L142">                assertThat(hai.getStartTime()).isNotNull();</span>
<span class="nc" id="L143">                assertThat(hai.getEndTime()).isNotNull();</span>
<span class="nc" id="L144">                assertThat(hai.getAssignee()).isNotNull();</span>
<span class="nc" id="L145">            }</span>
        }
<span class="nc" id="L147">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.sequentialUserTasks.bpmn20.xml&quot; })
    public void testSequentialUserTasksWithTimer() {
<span class="nc" id="L152">        String procId = runtimeService.startProcessInstanceByKey(&quot;miSequentialUserTasks&quot;, CollectionUtil.singletonMap(&quot;nrOfLoops&quot;, 3)).getId();</span>

        // Complete 1 tasks
<span class="nc" id="L155">        taskService.complete(taskService.createTaskQuery().singleResult().getId());</span>

        // Fire timer
<span class="nc" id="L158">        Job timer = managementService.createTimerJobQuery().singleResult();</span>
<span class="nc" id="L159">        managementService.moveTimerToExecutableJob(timer.getId());</span>
<span class="nc" id="L160">        managementService.executeJob(timer.getId());</span>

<span class="nc" id="L162">        org.flowable.task.api.Task taskAfterTimer = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L163">        assertThat(taskAfterTimer.getTaskDefinitionKey()).isEqualTo(&quot;taskAfterTimer&quot;);</span>
<span class="nc" id="L164">        taskService.complete(taskAfterTimer.getId());</span>
<span class="nc" id="L165">        assertProcessEnded(procId);</span>
<span class="nc" id="L166">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.sequentialUserTasks.bpmn20.xml&quot; })
    public void testSequentialUserTasksCompletionCondition() {
<span class="nc" id="L171">        String procId = runtimeService.startProcessInstanceByKey(&quot;miSequentialUserTasks&quot;, CollectionUtil.singletonMap(&quot;nrOfLoops&quot;, 10)).getId();</span>

        // 10 tasks are to be created, but completionCondition stops them at 5
<span class="nc bnc" id="L174" title="All 2 branches missed.">        for (int i = 0; i &lt; 5; i++) {</span>
<span class="nc" id="L175">            org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L176">            taskService.complete(task.getId());</span>
        }
<span class="nc" id="L178">        assertThat(taskService.createTaskQuery().singleResult()).isNull();</span>
<span class="nc" id="L179">        assertProcessEnded(procId);</span>
<span class="nc" id="L180">    }</span>

    @Test
    @Deployment
    public void testNestedSequentialUserTasks() {
<span class="nc" id="L185">        String procId = runtimeService.startProcessInstanceByKey(&quot;miNestedSequentialUserTasks&quot;).getId();</span>

<span class="nc bnc" id="L187" title="All 2 branches missed.">        for (int i = 0; i &lt; 3; i++) {</span>
<span class="nc" id="L188">            org.flowable.task.api.Task task = taskService.createTaskQuery().taskAssignee(&quot;kermit&quot;).singleResult();</span>
<span class="nc" id="L189">            assertThat(task.getName()).isEqualTo(&quot;My Task&quot;);</span>
<span class="nc" id="L190">            taskService.complete(task.getId());</span>
        }

<span class="nc" id="L193">        assertProcessEnded(procId);</span>
<span class="nc" id="L194">    }</span>

    @Test
    @Deployment
    public void testParallelUserTasks() {
<span class="nc" id="L199">        String procId = runtimeService.startProcessInstanceByKey(&quot;miParallelUserTasks&quot;).getId();</span>

<span class="nc" id="L201">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().orderByTaskName().asc().list();</span>
<span class="nc" id="L202">        assertThat(tasks)</span>
<span class="nc" id="L203">                .extracting(Task::getName)</span>
<span class="nc" id="L204">                .containsExactly(&quot;My Task 0&quot;, &quot;My Task 1&quot;, &quot;My Task 2&quot;);</span>

<span class="nc" id="L206">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L207">        taskService.complete(tasks.get(1).getId());</span>
<span class="nc" id="L208">        taskService.complete(tasks.get(2).getId());</span>
<span class="nc" id="L209">        assertProcessEnded(procId);</span>
<span class="nc" id="L210">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testParallelUserTasks.bpmn20.xml&quot; })
    public void testParallelUserTasksHistory() {
<span class="nc" id="L215">        runtimeService.startProcessInstanceByKey(&quot;miParallelUserTasks&quot;);</span>
<span class="nc" id="L216">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().orderByTaskName().asc().list();</span>
<span class="nc" id="L217">        assertThat(tasks).hasSize(3);</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">        for (int i = 0; i &lt; tasks.size(); i++) {</span>
<span class="nc" id="L219">            assertThat(tasks.get(i).getName()).isEqualTo(&quot;My Task &quot; + i);</span>
<span class="nc" id="L220">            taskService.complete(tasks.get(i).getId());</span>
        }

        // Validate history
<span class="nc bnc" id="L224" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L225">            List&lt;HistoricTaskInstance&gt; historicTaskInstances = historyService.createHistoricTaskInstanceQuery().orderByTaskAssignee().asc().list();</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">            for (int i = 0; i &lt; historicTaskInstances.size(); i++) {</span>
<span class="nc" id="L227">                HistoricTaskInstance hi = historicTaskInstances.get(i);</span>
<span class="nc" id="L228">                assertThat(hi.getStartTime()).isNotNull();</span>
<span class="nc" id="L229">                assertThat(hi.getEndTime()).isNotNull();</span>
<span class="nc" id="L230">                assertThat(hi.getName()).isEqualTo(&quot;My Task &quot; + i);</span>
<span class="nc" id="L231">                assertThat(hi.getAssignee()).isEqualTo(&quot;kermit_&quot; + i);</span>
            }

<span class="nc" id="L234">            List&lt;HistoricActivityInstance&gt; historicActivityInstances = historyService.createHistoricActivityInstanceQuery().activityType(&quot;userTask&quot;).list();</span>
<span class="nc" id="L235">            assertThat(historicActivityInstances).hasSize(3);</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">            for (HistoricActivityInstance hai : historicActivityInstances) {</span>
<span class="nc" id="L237">                assertThat(hai.getStartTime()).isNotNull();</span>
<span class="nc" id="L238">                assertThat(hai.getEndTime()).isNotNull();</span>
<span class="nc" id="L239">                assertThat(hai.getAssignee()).isNotNull();</span>
<span class="nc" id="L240">                assertThat(hai.getActivityType()).isEqualTo(&quot;userTask&quot;);</span>
<span class="nc" id="L241">            }</span>
        }
<span class="nc" id="L243">    }</span>

    @Test
    @Deployment
    public void testParallelUserTasksWithTimer() {
<span class="nc" id="L248">        String procId = runtimeService.startProcessInstanceByKey(&quot;miParallelUserTasksWithTimer&quot;).getId();</span>

<span class="nc" id="L250">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L251">        taskService.complete(tasks.get(0).getId());</span>

        // Fire timer
<span class="nc" id="L254">        Job timer = managementService.createTimerJobQuery().singleResult();</span>
<span class="nc" id="L255">        managementService.moveTimerToExecutableJob(timer.getId());</span>
<span class="nc" id="L256">        managementService.executeJob(timer.getId());</span>

<span class="nc" id="L258">        org.flowable.task.api.Task taskAfterTimer = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L259">        assertThat(taskAfterTimer.getTaskDefinitionKey()).isEqualTo(&quot;taskAfterTimer&quot;);</span>
<span class="nc" id="L260">        taskService.complete(taskAfterTimer.getId());</span>
<span class="nc" id="L261">        assertProcessEnded(procId);</span>
<span class="nc" id="L262">    }</span>

    @Test
    @Deployment
    public void testParallelUserTasksCompletionCondition() {
<span class="nc" id="L267">        String procId = runtimeService.startProcessInstanceByKey(&quot;miParallelUserTasksCompletionCondition&quot;).getId();</span>
<span class="nc" id="L268">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L269">        assertThat(tasks).hasSize(5);</span>

        // Completing 3 tasks gives 50% of tasks completed, which triggers
        // completionCondition
<span class="nc bnc" id="L273" title="All 2 branches missed.">        for (int i = 0; i &lt; 3; i++) {</span>
<span class="nc" id="L274">            assertThat(taskService.createTaskQuery().count()).isEqualTo(5 - i);</span>
<span class="nc" id="L275">            taskService.complete(tasks.get(i).getId());</span>
        }
<span class="nc" id="L277">        assertProcessEnded(procId);</span>
<span class="nc" id="L278">    }</span>

    @Test
    @Deployment
    public void testParallelUserTasksBasedOnCollection() {
<span class="nc" id="L283">        List&lt;String&gt; assigneeList = Arrays.asList(&quot;kermit&quot;, &quot;gonzo&quot;, &quot;mispiggy&quot;, &quot;fozzie&quot;, &quot;bubba&quot;);</span>
<span class="nc" id="L284">        String procId = runtimeService.startProcessInstanceByKey(&quot;miParallelUserTasksBasedOnCollection&quot;, CollectionUtil.singletonMap(&quot;assigneeList&quot;, assigneeList)).getId();</span>

<span class="nc" id="L286">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().orderByTaskAssignee().asc().list();</span>
<span class="nc" id="L287">        assertThat(tasks)</span>
<span class="nc" id="L288">                .extracting(Task::getAssignee)</span>
<span class="nc" id="L289">                .containsExactly(&quot;bubba&quot;, &quot;fozzie&quot;, &quot;gonzo&quot;, &quot;kermit&quot;, &quot;mispiggy&quot;);</span>

        // Completing 3 tasks will trigger completioncondition
<span class="nc" id="L292">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L293">        taskService.complete(tasks.get(1).getId());</span>
<span class="nc" id="L294">        taskService.complete(tasks.get(2).getId());</span>
<span class="nc" id="L295">        assertThat(taskService.createTaskQuery().count()).isZero();</span>
<span class="nc" id="L296">        assertProcessEnded(procId);</span>
<span class="nc" id="L297">    }</span>

    @Test
    @Deployment
    public void testParallelUserTasksCustomCollectionStringExtension() {
<span class="nc" id="L302">    	checkParallelUserTasksCustomCollection(&quot;miParallelUserTasksCollection&quot;);</span>
<span class="nc" id="L303">    }</span>

    private void checkParallelUserTasksCustomCollection(String processDefinitionKey) {
<span class="nc" id="L306">    	ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(processDefinitionKey);</span>

<span class="nc" id="L308">        List&lt;Task&gt; tasks = taskService.createTaskQuery().taskCandidateUser(&quot;wfuser1&quot;).list();</span>
<span class="nc" id="L309">        assertThat(tasks)</span>
<span class="nc" id="L310">                .extracting(Task::getName)</span>
<span class="nc" id="L311">                .containsExactly(&quot;My Task 0&quot;);</span>

<span class="nc" id="L313">        tasks = taskService.createTaskQuery().taskCandidateUser(&quot;wfuser2&quot;).list();</span>
<span class="nc" id="L314">        assertThat(tasks)</span>
<span class="nc" id="L315">                .extracting(Task::getName)</span>
<span class="nc" id="L316">                .containsExactly(&quot;My Task 1&quot;);</span>

        // should be 2 tasks total
<span class="nc" id="L319">        tasks = taskService.createTaskQuery().orderByTaskName().asc().list();</span>
<span class="nc" id="L320">        assertThat(tasks)</span>
<span class="nc" id="L321">                .extracting(Task::getName)</span>
<span class="nc" id="L322">                .containsExactly(&quot;My Task 0&quot;, &quot;My Task 1&quot;);</span>

        // Completing 3 tasks will trigger completion condition
<span class="nc" id="L325">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L326">        taskService.complete(tasks.get(1).getId());</span>
<span class="nc" id="L327">        assertThat(taskService.createTaskQuery().count()).isZero();</span>
<span class="nc" id="L328">        assertProcessEnded(processInstance.getProcessInstanceId());</span>
<span class="nc" id="L329">    }</span>

    @Test
    @Deployment
    public void testParallelUserTasksCustomCollectionStringExtensionDelegateExpression() {
<span class="nc" id="L334">    	checkParallelUserTasksCustomCollectionDelegateExpression(&quot;miParallelUserTasksCollection&quot;);</span>
<span class="nc" id="L335">    }</span>

    private void checkParallelUserTasksCustomCollectionDelegateExpression(String processDefinitionKey) {
    	// Add bean temporary to process engine

<span class="nc" id="L340">    	Map&lt;Object, Object&gt; originalBeans = processEngineConfiguration.getExpressionManager().getBeans();</span>

    	try {

<span class="nc" id="L344">    		Map&lt;Object, Object&gt; newBeans = new HashMap&lt;&gt;();</span>
<span class="nc" id="L345">    		newBeans.put(&quot;collectionHandler&quot;, new JSONCollectionHandler());</span>
<span class="nc" id="L346">    		processEngineConfiguration.getExpressionManager().setBeans(newBeans);</span>

<span class="nc" id="L348">    		checkParallelUserTasksCustomCollection(processDefinitionKey);</span>
    	} finally {

    		// Put beans back
<span class="nc" id="L352">    		processEngineConfiguration.getExpressionManager().setBeans(originalBeans);</span>

    	}

<span class="nc" id="L356">    }</span>

    @Test
    @Deployment
    public void testParallelUserTasksCustomCollectionExpressionExtension() {
<span class="nc" id="L361">    	checkParallelUserTasksCustomCollection(&quot;miParallelUserTasksCollection&quot;);</span>
<span class="nc" id="L362">    }</span>

    @Test
    @Deployment
    public void testParallelUserTasksCustomCollectionExpressionExtensionDelegateExpression() {
<span class="nc" id="L367">    	checkParallelUserTasksCustomCollectionDelegateExpression(&quot;miParallelUserTasksCollection&quot;);</span>
<span class="nc" id="L368">    }</span>

    @Test
    @Deployment
    public void testParallelUserTasksCustomExtensionsCollection() {
<span class="nc" id="L373">    	checkParallelUserTasksCustomCollection(&quot;miParallelUserTasksCollection&quot;);</span>
<span class="nc" id="L374">    }</span>

    @Test
    @Deployment
    public void testParallelUserTasksCustomExtensionsCollectionDelegateExpression() {
<span class="nc" id="L379">    	checkParallelUserTasksCustomCollectionDelegateExpression(&quot;miParallelUserTasksCollection&quot;);</span>
<span class="nc" id="L380">    }</span>

    @Test
    @Deployment
    public void testParallelUserTasksCustomExtensions() {
<span class="nc" id="L385">        checkParallelUserTasksCustomExtensions(&quot;miParallelUserTasks&quot;);</span>
<span class="nc" id="L386">    }</span>

    @Test
    @Deployment
    public void testParallelUserTasksCustomExtensionsLoopIndexVariable() {
<span class="nc" id="L391">        checkParallelUserTasksCustomExtensions(&quot;miParallelUserTasksLoopVariable&quot;);</span>
<span class="nc" id="L392">    }</span>

    private void checkParallelUserTasksCustomExtensions(String processDefinitionKey) {
<span class="nc" id="L395">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L396">        List&lt;String&gt; assigneeList = Arrays.asList(&quot;kermit&quot;, &quot;gonzo&quot;, &quot;fozzie&quot;);</span>
<span class="nc" id="L397">        vars.put(&quot;assigneeList&quot;, assigneeList);</span>
<span class="nc" id="L398">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(processDefinitionKey, vars);</span>

<span class="nc" id="L400">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().orderByTaskName().asc().list();</span>
<span class="nc" id="L401">        assertThat(tasks)</span>
<span class="nc" id="L402">                .extracting(Task::getName)</span>
<span class="nc" id="L403">                .containsExactly(&quot;My Task 0&quot;, &quot;My Task 1&quot;, &quot;My Task 2&quot;);</span>

<span class="nc" id="L405">        tasks = taskService.createTaskQuery().orderByTaskAssignee().asc().list();</span>
<span class="nc" id="L406">        assertThat(tasks)</span>
<span class="nc" id="L407">                .extracting(Task::getAssignee)</span>
<span class="nc" id="L408">                .containsExactly(&quot;fozzie&quot;, &quot;gonzo&quot;, &quot;kermit&quot;);</span>

        // Completing 3 tasks will trigger completion condition
<span class="nc" id="L411">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L412">        taskService.complete(tasks.get(1).getId());</span>
<span class="nc" id="L413">        taskService.complete(tasks.get(2).getId());</span>
<span class="nc" id="L414">        assertThat(taskService.createTaskQuery().count()).isZero();</span>
<span class="nc" id="L415">        assertProcessEnded(processInstance.getProcessInstanceId());</span>
<span class="nc" id="L416">    }</span>

    @Test
    @Deployment
    public void testParallelUserTasksExecutionAndTaskListeners() {
<span class="nc" id="L421">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;miParallelUserTasks&quot;);</span>
<span class="nc" id="L422">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">        for (Task task : tasks) {</span>
<span class="nc" id="L424">            taskService.complete(task.getId());</span>
<span class="nc" id="L425">        }</span>

<span class="nc" id="L427">        Execution waitState = runtimeService.createExecutionQuery().activityId(&quot;waitState&quot;).singleResult();</span>
<span class="nc" id="L428">        assertThat(waitState).isNotNull();</span>

<span class="nc" id="L430">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;taskListenerCounter&quot;)).isEqualTo(3);</span>
<span class="nc" id="L431">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;executionListenerCounter&quot;)).isEqualTo(3);</span>

<span class="nc" id="L433">        runtimeService.trigger(waitState.getId());</span>
<span class="nc" id="L434">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L435">    }</span>
    
    @Test
    @Deployment
    public void testExecutionListener() {
<span class="nc" id="L440">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L441">        List&lt;String&gt; countersigns = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L442">        countersigns.add(&quot;zjl0&quot;);</span>
<span class="nc" id="L443">        countersigns.add(&quot;zjl1&quot;);</span>
<span class="nc" id="L444">        countersigns.add(&quot;zjl3&quot;);</span>
<span class="nc" id="L445">        vars.put(&quot;countersignAssigneeList&quot;, countersigns);</span>
<span class="nc" id="L446">        vars.put(&quot;approveResult&quot;, &quot;notpass&quot;);</span>
<span class="nc" id="L447">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;approve-process&quot;, vars);</span>
<span class="nc" id="L448">        assertThat(processInstance).isNotNull();</span>
        
<span class="nc" id="L450">        HistoryTestHelper.waitForJobExecutorToProcessAllHistoryJobs(processEngineConfiguration, </span>
<span class="nc" id="L451">                        processEngineConfiguration.getManagementService(), 7000, 200);</span>

<span class="nc" id="L453">        List&lt;Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">        for (Task task : tasks){</span>
<span class="nc" id="L455">            assertThat(taskService.getVariable(task.getId(), &quot;csAssignee&quot;)).isEqualTo(task.getAssignee());</span>
<span class="nc" id="L456">            taskService.setVariableLocal(task.getId(), &quot;csApproveResult&quot;, &quot;pass&quot;);</span>
<span class="nc" id="L457">            taskService.complete(task.getId());</span>
            
<span class="nc" id="L459">            HistoryTestHelper.waitForJobExecutorToProcessAllHistoryJobs(processEngineConfiguration, </span>
<span class="nc" id="L460">                            processEngineConfiguration.getManagementService(), 7000, 200);</span>
<span class="nc" id="L461">        }</span>
        
<span class="nc" id="L463">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L464">    }</span>
    
    @Test
    @Deployment
    public void testSequentialExecutionListener() {
<span class="nc" id="L469">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L470">        List&lt;String&gt; countersigns = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L471">        countersigns.add(&quot;zjl0&quot;);</span>
<span class="nc" id="L472">        countersigns.add(&quot;zjl1&quot;);</span>
<span class="nc" id="L473">        countersigns.add(&quot;zjl3&quot;);</span>
<span class="nc" id="L474">        vars.put(&quot;countersignAssigneeList&quot;, countersigns);</span>
<span class="nc" id="L475">        vars.put(&quot;approveResult&quot;, &quot;notpass&quot;);</span>
<span class="nc" id="L476">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;approve-process&quot;, vars);</span>
<span class="nc" id="L477">        assertThat(processInstance).isNotNull();</span>
        
<span class="nc" id="L479">        HistoryTestHelper.waitForJobExecutorToProcessAllHistoryJobs(processEngineConfiguration, </span>
<span class="nc" id="L480">                        processEngineConfiguration.getManagementService(), 7000, 200);</span>

<span class="nc" id="L482">        Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L483">        assertThat(taskService.getVariable(task.getId(), &quot;csAssignee&quot;)).isEqualTo(task.getAssignee());</span>
<span class="nc" id="L484">        taskService.setVariableLocal(task.getId(), &quot;csApproveResult&quot;, &quot;pass&quot;);</span>
<span class="nc" id="L485">        taskService.complete(task.getId());</span>
        
<span class="nc" id="L487">        HistoryTestHelper.waitForJobExecutorToProcessAllHistoryJobs(processEngineConfiguration, </span>
<span class="nc" id="L488">                        processEngineConfiguration.getManagementService(), 7000, 200);</span>
        
<span class="nc" id="L490">        task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L491">        assertThat(taskService.getVariable(task.getId(), &quot;csAssignee&quot;)).isEqualTo(task.getAssignee());</span>
<span class="nc" id="L492">        taskService.setVariableLocal(task.getId(), &quot;csApproveResult&quot;, &quot;pass&quot;);</span>
<span class="nc" id="L493">        taskService.complete(task.getId());</span>
        
<span class="nc" id="L495">        HistoryTestHelper.waitForJobExecutorToProcessAllHistoryJobs(processEngineConfiguration, </span>
<span class="nc" id="L496">                        processEngineConfiguration.getManagementService(), 7000, 200);</span>
        
<span class="nc" id="L498">        task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L499">        assertThat(taskService.getVariable(task.getId(), &quot;csAssignee&quot;)).isEqualTo(task.getAssignee());</span>
<span class="nc" id="L500">        taskService.setVariableLocal(task.getId(), &quot;csApproveResult&quot;, &quot;pass&quot;);</span>
<span class="nc" id="L501">        taskService.complete(task.getId());</span>
        
<span class="nc" id="L503">        HistoryTestHelper.waitForJobExecutorToProcessAllHistoryJobs(processEngineConfiguration, </span>
<span class="nc" id="L504">                        processEngineConfiguration.getManagementService(), 7000, 200);</span>
        
<span class="nc" id="L506">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L507">    }</span>

    @Test
    @Deployment
    public void testNestedParallelUserTasks() {
<span class="nc" id="L512">        String procId = runtimeService.startProcessInstanceByKey(&quot;miNestedParallelUserTasks&quot;).getId();</span>

<span class="nc" id="L514">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().taskAssignee(&quot;kermit&quot;).list();</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">        for (org.flowable.task.api.Task task : tasks) {</span>
<span class="nc" id="L516">            assertThat(task.getName()).isEqualTo(&quot;My Task&quot;);</span>
<span class="nc" id="L517">            taskService.complete(task.getId());</span>
<span class="nc" id="L518">        }</span>

<span class="nc" id="L520">        assertProcessEnded(procId);</span>
<span class="nc" id="L521">    }</span>

    @Test
    @Deployment
    public void testSequentialScriptTasks() {
<span class="nc" id="L526">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L527">        vars.put(&quot;sum&quot;, 0);</span>
<span class="nc" id="L528">        vars.put(&quot;nrOfLoops&quot;, 5);</span>
<span class="nc" id="L529">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;miSequentialScriptTask&quot;, vars);</span>
<span class="nc" id="L530">        int sum = (Integer) runtimeService.getVariable(processInstance.getId(), &quot;sum&quot;);</span>
<span class="nc" id="L531">        assertThat(sum).isEqualTo(10);</span>
<span class="nc" id="L532">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testSequentialScriptTasks.bpmn20.xml&quot; })
    public void testSequentialScriptTasksHistory() {
<span class="nc" id="L537">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L538">        vars.put(&quot;sum&quot;, 0);</span>
<span class="nc" id="L539">        vars.put(&quot;nrOfLoops&quot;, 7);</span>
<span class="nc" id="L540">        runtimeService.startProcessInstanceByKey(&quot;miSequentialScriptTask&quot;, vars);</span>

        // Validate history
<span class="nc bnc" id="L543" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L544">            List&lt;HistoricActivityInstance&gt; historicInstances = historyService.createHistoricActivityInstanceQuery().activityType(&quot;scriptTask&quot;).orderByActivityId().asc().list();</span>
<span class="nc" id="L545">            assertThat(historicInstances).hasSize(7);</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">            for (int i = 0; i &lt; 7; i++) {</span>
<span class="nc" id="L547">                HistoricActivityInstance hai = historicInstances.get(i);</span>
<span class="nc" id="L548">                assertActivityInstancesAreSame(hai, runtimeService.createActivityInstanceQuery().activityInstanceId(hai.getId()).singleResult());</span>
<span class="nc" id="L549">                assertThat(hai.getActivityType()).isEqualTo(&quot;scriptTask&quot;);</span>
<span class="nc" id="L550">                assertThat(hai.getStartTime()).isNotNull();</span>
<span class="nc" id="L551">                assertThat(hai.getEndTime()).isNotNull();</span>
            }
        }
<span class="nc" id="L554">    }</span>

    @Test
    @Deployment
    public void testSequentialScriptTasksCompletionCondition() {
<span class="nc" id="L559">        runtimeService.startProcessInstanceByKey(&quot;miSequentialScriptTaskCompletionCondition&quot;).getId();</span>
<span class="nc" id="L560">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().list();</span>
<span class="nc" id="L561">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L562">        Execution processInstanceExecution = null;</span>
<span class="nc" id="L563">        Execution waitStateExecution = null;</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">        for (Execution execution : executions) {</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">            if (execution.getId().equals(execution.getProcessInstanceId())) {</span>
<span class="nc" id="L566">                processInstanceExecution = execution;</span>
            } else {
<span class="nc" id="L568">                waitStateExecution = execution;</span>
            }
<span class="nc" id="L570">        }</span>
<span class="nc" id="L571">        assertThat(processInstanceExecution).isNotNull();</span>
<span class="nc" id="L572">        assertThat(waitStateExecution).isNotNull();</span>
<span class="nc" id="L573">        int sum = (Integer) runtimeService.getVariable(waitStateExecution.getId(), &quot;sum&quot;);</span>
<span class="nc" id="L574">        assertThat(sum).isEqualTo(5);</span>
<span class="nc" id="L575">    }</span>

    @Test
    @Deployment
    public void testParallelScriptTasks() {
<span class="nc" id="L580">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L581">        vars.put(&quot;sum&quot;, 0);</span>
<span class="nc" id="L582">        vars.put(&quot;nrOfLoops&quot;, 10);</span>
<span class="nc" id="L583">        runtimeService.startProcessInstanceByKey(&quot;miParallelScriptTask&quot;, vars);</span>
<span class="nc" id="L584">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().list();</span>
<span class="nc" id="L585">        assertThat(executions).hasSize(2);</span>
<span class="nc" id="L586">        Execution processInstanceExecution = null;</span>
<span class="nc" id="L587">        Execution waitStateExecution = null;</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">        for (Execution execution : executions) {</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">            if (execution.getId().equals(execution.getProcessInstanceId())) {</span>
<span class="nc" id="L590">                processInstanceExecution = execution;</span>
            } else {
<span class="nc" id="L592">                waitStateExecution = execution;</span>
            }
<span class="nc" id="L594">        }</span>
<span class="nc" id="L595">        assertThat(processInstanceExecution).isNotNull();</span>
<span class="nc" id="L596">        assertThat(waitStateExecution).isNotNull();</span>
<span class="nc" id="L597">        int sum = (Integer) runtimeService.getVariable(waitStateExecution.getId(), &quot;sum&quot;);</span>
<span class="nc" id="L598">        assertThat(sum).isEqualTo(45);</span>
<span class="nc" id="L599">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testParallelScriptTasks.bpmn20.xml&quot; })
    public void testParallelScriptTasksHistory() {
<span class="nc" id="L604">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L605">        vars.put(&quot;sum&quot;, 0);</span>
<span class="nc" id="L606">        vars.put(&quot;nrOfLoops&quot;, 4);</span>
<span class="nc" id="L607">        runtimeService.startProcessInstanceByKey(&quot;miParallelScriptTask&quot;, vars);</span>

<span class="nc bnc" id="L609" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L610">            List&lt;HistoricActivityInstance&gt; historicActivityInstances = historyService.createHistoricActivityInstanceQuery().activityType(&quot;scriptTask&quot;).list();</span>
<span class="nc" id="L611">            assertThat(historicActivityInstances).hasSize(4);</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">            for (HistoricActivityInstance hai : historicActivityInstances) {</span>
<span class="nc" id="L613">                assertActivityInstancesAreSame(hai, runtimeService.createActivityInstanceQuery().activityInstanceId(hai.getId()).singleResult());</span>
<span class="nc" id="L614">                assertThat(hai.getStartTime()).isNotNull();</span>
<span class="nc" id="L615">                assertThat(hai.getEndTime()).isNotNull();</span>
<span class="nc" id="L616">            }</span>
        }
<span class="nc" id="L618">    }</span>

    @Test
    @Deployment
    public void testParallelAsyncScriptTasks() {
<span class="nc bnc" id="L623" title="All 2 branches missed.">        if (!processEngineConfiguration.isAsyncHistoryEnabled()) {</span>
<span class="nc" id="L624">            ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L625">                    .processDefinitionKey(&quot;miParallelAsyncScriptTask&quot;)</span>
<span class="nc" id="L626">                    .variable(&quot;nrOfLoops&quot;, 10)</span>
<span class="nc" id="L627">                    .start();</span>
<span class="nc" id="L628">            List&lt;Job&gt; jobs = managementService.createJobQuery().list();</span>
            // There are 10 jobs for each async execution
<span class="nc" id="L630">            assertThat(jobs).hasSize(10);</span>
    
<span class="nc bnc" id="L632" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L633">                HistoricVariableInstance varInstance = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L634">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L635">                        .variableName(&quot;nrOfCompletedInstances&quot;)</span>
<span class="nc" id="L636">                        .singleResult();</span>
<span class="nc" id="L637">                assertThat(varInstance).isNotNull();</span>
<span class="nc" id="L638">                assertThat(varInstance.getValue()).isEqualTo(0);</span>
    
<span class="nc" id="L640">                varInstance = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L641">                        .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L642">                        .variableName(&quot;nrOfActiveInstances&quot;)</span>
<span class="nc" id="L643">                        .singleResult();</span>
<span class="nc" id="L644">                assertThat(varInstance).isNotNull();</span>
<span class="nc" id="L645">                assertThat(varInstance.getValue()).isEqualTo(10);</span>
            }
    
            // When a job fails it is moved to the timer jobs, so it can be executed later
<span class="nc" id="L649">            waitForJobExecutorToProcessAllJobsAndExecutableTimerJobs(10000L, 200);</span>
<span class="nc" id="L650">            jobs = managementService.createJobQuery().list();</span>
<span class="nc" id="L651">            assertThat(jobs).isEmpty();</span>
<span class="nc" id="L652">            List&lt;Job&gt; timerJobs = managementService.createTimerJobQuery().list();</span>
<span class="nc" id="L653">            assertThat(timerJobs).isEmpty();</span>
    
<span class="nc" id="L655">            List&lt;Job&gt; deadLetterJobs = managementService.createDeadLetterJobQuery().list();</span>
<span class="nc" id="L656">            assertThat(deadLetterJobs).isEmpty();</span>
    
    
<span class="nc" id="L659">            List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().list();</span>
<span class="nc" id="L660">            assertThat(executions).hasSize(2);</span>
<span class="nc" id="L661">            Execution processInstanceExecution = null;</span>
<span class="nc" id="L662">            Execution waitStateExecution = null;</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">            for (Execution execution : executions) {</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">                if (execution.getId().equals(execution.getProcessInstanceId())) {</span>
<span class="nc" id="L665">                    processInstanceExecution = execution;</span>
                } else {
<span class="nc" id="L667">                    waitStateExecution = execution;</span>
                }
<span class="nc" id="L669">            }</span>
<span class="nc" id="L670">            assertThat(processInstanceExecution).isNotNull();</span>
<span class="nc" id="L671">            assertThat(waitStateExecution).isNotNull();</span>
    
<span class="nc" id="L673">            Map&lt;String, VariableInstance&gt; variableInstances = runtimeService.getVariableInstances(processInstanceExecution.getProcessInstanceId());</span>
<span class="nc" id="L674">            assertThat(variableInstances).containsOnlyKeys(&quot;nrOfLoops&quot;);</span>
<span class="nc" id="L675">            VariableInstance nrOfLoops = variableInstances.get(&quot;nrOfLoops&quot;);</span>
<span class="nc" id="L676">            assertThat(nrOfLoops.getValue()).isEqualTo(10);</span>
    
<span class="nc bnc" id="L678" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L679">                HistoricVariableInstance varInstance = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L680">                        .processInstanceId(processInstanceExecution.getProcessInstanceId())</span>
<span class="nc" id="L681">                        .variableName(&quot;nrOfCompletedInstances&quot;)</span>
<span class="nc" id="L682">                        .singleResult();</span>
<span class="nc" id="L683">                assertThat(varInstance).isNotNull();</span>
<span class="nc" id="L684">                assertThat(varInstance.getValue()).isEqualTo(10);</span>
    
<span class="nc" id="L686">                varInstance = historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L687">                        .processInstanceId(processInstanceExecution.getProcessInstanceId())</span>
<span class="nc" id="L688">                        .variableName(&quot;nrOfActiveInstances&quot;)</span>
<span class="nc" id="L689">                        .singleResult();</span>
<span class="nc" id="L690">                assertThat(varInstance).isNotNull();</span>
<span class="nc" id="L691">                assertThat(varInstance.getValue()).isEqualTo(0);</span>
            }
        }
<span class="nc" id="L694">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testParallelAsyncScriptTasks.bpmn20.xml&quot;)
    public void testParallelAsyncScriptTasksWithoutAsyncLeave() {
<span class="nc" id="L699">        boolean originalAsyncLeave = processEngineConfiguration.isParallelMultiInstanceAsyncLeave();</span>
<span class="nc" id="L700">        processEngineConfiguration.setParallelMultiInstanceAsyncLeave(false);</span>
        try {

<span class="nc" id="L703">            runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L704">                    .processDefinitionKey(&quot;miParallelAsyncScriptTask&quot;)</span>
<span class="nc" id="L705">                    .variable(&quot;nrOfLoops&quot;, 10)</span>
<span class="nc" id="L706">                    .start();</span>
<span class="nc" id="L707">            List&lt;Job&gt; jobs = managementService.createJobQuery().list();</span>
            // There are 10 jobs for each async execution
<span class="nc" id="L709">            assertThat(jobs).hasSize(10);</span>

            // When a job fails it is moved to the timer jobs, so it can be executed later
<span class="nc" id="L712">            waitForJobExecutorToProcessAllJobsAndExecutableTimerJobs(20000, 200);</span>
<span class="nc" id="L713">            jobs = managementService.createJobQuery().list();</span>
<span class="nc" id="L714">            assertThat(jobs).isEmpty();</span>
<span class="nc" id="L715">            List&lt;Job&gt; timerJobs = managementService.createTimerJobQuery().list();</span>
<span class="nc" id="L716">            assertThat(timerJobs)</span>
<span class="nc" id="L717">                    .isNotEmpty()</span>
<span class="nc" id="L718">                    .extracting(JobInfo::getExceptionMessage)</span>
<span class="nc" id="L719">                    .allSatisfy(message -&gt; {</span>
<span class="nc" id="L720">                        assertThat(message)</span>
<span class="nc" id="L721">                                .contains(&quot;was updated by another transaction concurrently&quot;);</span>
<span class="nc" id="L722">                    });</span>

<span class="nc" id="L724">            List&lt;String&gt; timerJobsExceptionStacktraces = timerJobs.stream()</span>
<span class="nc" id="L725">                    .map(JobInfo::getId)</span>
<span class="nc" id="L726">                    .map(managementService::getTimerJobExceptionStacktrace)</span>
<span class="nc" id="L727">                    .collect(Collectors.toList());</span>
<span class="nc" id="L728">            assertThat(timerJobsExceptionStacktraces)</span>
<span class="nc" id="L729">                    .allSatisfy(stacktrace -&gt; {</span>
<span class="nc" id="L730">                        assertThat(stacktrace).contains(&quot;FlowableOptimisticLockingException&quot;);</span>
<span class="nc" id="L731">                    });</span>

<span class="nc" id="L733">            List&lt;Job&gt; deadLetterJobs = managementService.createDeadLetterJobQuery().list();</span>
<span class="nc" id="L734">            assertThat(deadLetterJobs).isEmpty();</span>

<span class="nc" id="L736">            List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().list();</span>
<span class="nc" id="L737">            assertThat(executions).hasSizeGreaterThan(timerJobs.size());</span>
<span class="nc" id="L738">            Execution waitStateExecution = runtimeService.createExecutionQuery().activityId(&quot;waitState&quot;).singleResult();</span>
<span class="nc" id="L739">            assertThat(waitStateExecution).isNull();</span>
        } finally {
<span class="nc" id="L741">            processEngineConfiguration.setParallelMultiInstanceAsyncLeave(originalAsyncLeave);</span>
        }
<span class="nc" id="L743">    }</span>

    @Test
    @Deployment
    public void testParallelScriptTasksCompletionCondition() {
<span class="nc" id="L748">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;miParallelScriptTaskCompletionCondition&quot;);</span>
<span class="nc" id="L749">        Execution waitStateExecution = runtimeService.createExecutionQuery().activityId(&quot;waitState&quot;).singleResult();</span>
<span class="nc" id="L750">        assertThat(waitStateExecution).isNotNull();</span>
<span class="nc" id="L751">        int sum = (Integer) runtimeService.getVariable(processInstance.getId(), &quot;sum&quot;);</span>
<span class="nc" id="L752">        assertThat(sum).isEqualTo(2);</span>
<span class="nc" id="L753">        runtimeService.trigger(waitStateExecution.getId());</span>
<span class="nc" id="L754">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L755">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testParallelScriptTasksCompletionCondition.bpmn20.xml&quot; })
    public void testParallelScriptTasksCompletionConditionHistory() {
<span class="nc" id="L760">        runtimeService.startProcessInstanceByKey(&quot;miParallelScriptTaskCompletionCondition&quot;);</span>
<span class="nc bnc" id="L761" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L762">            List&lt;HistoricActivityInstance&gt; historicActivityInstances = historyService.createHistoricActivityInstanceQuery().activityType(&quot;scriptTask&quot;).list();</span>
<span class="nc" id="L763">            assertThat(historicActivityInstances).hasSize(2);</span>
        }
<span class="nc" id="L765">    }</span>

    @Test
    @Deployment
    public void testSequentialSubProcess() {
<span class="nc" id="L770">        String procId = runtimeService.startProcessInstanceByKey(&quot;miSequentialSubprocess&quot;).getId();</span>

<span class="nc" id="L772">        TaskQuery query = taskService.createTaskQuery().orderByTaskName().asc();</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">        for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc" id="L774">            List&lt;org.flowable.task.api.Task&gt; tasks = query.list();</span>
<span class="nc" id="L775">            assertThat(tasks)</span>
<span class="nc" id="L776">                    .extracting(Task::getName)</span>
<span class="nc" id="L777">                    .containsExactly(&quot;task one&quot;, &quot;task two&quot;);</span>

<span class="nc" id="L779">            taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L780">            taskService.complete(tasks.get(1).getId());</span>

<span class="nc bnc" id="L782" title="All 2 branches missed.">            if (i != 3) {</span>
<span class="nc" id="L783">                List&lt;String&gt; activities = runtimeService.getActiveActivityIds(procId);</span>
<span class="nc" id="L784">                assertThat(activities).hasSize(3);</span>
            }
        }

<span class="nc" id="L788">        assertProcessEnded(procId);</span>
<span class="nc" id="L789">    }</span>

    @Test
    @Deployment
    public void testSequentialSubProcessEndEvent() {
        // ACT-1185: end-event in subprocess causes inactivated execution
<span class="nc" id="L795">        String procId = runtimeService.startProcessInstanceByKey(&quot;miSequentialSubprocess&quot;).getId();</span>

<span class="nc" id="L797">        TaskQuery query = taskService.createTaskQuery().orderByTaskName().asc();</span>
<span class="nc bnc" id="L798" title="All 2 branches missed.">        for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc" id="L799">            List&lt;org.flowable.task.api.Task&gt; tasks = query.list();</span>
<span class="nc" id="L800">            assertThat(tasks)</span>
<span class="nc" id="L801">                    .extracting(Task::getName)</span>
<span class="nc" id="L802">                    .containsExactly(&quot;task one&quot;);</span>

<span class="nc" id="L804">            taskService.complete(tasks.get(0).getId());</span>

            // Last run, the execution no longer exists
<span class="nc bnc" id="L807" title="All 2 branches missed.">            if (i != 3) {</span>
<span class="nc" id="L808">                List&lt;String&gt; activities = runtimeService.getActiveActivityIds(procId);</span>
<span class="nc" id="L809">                assertThat(activities).hasSize(2);</span>
            }
        }

<span class="nc" id="L813">        assertProcessEnded(procId);</span>
<span class="nc" id="L814">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testSequentialSubProcess.bpmn20.xml&quot; })
    public void testSequentialSubProcessHistory() {
<span class="nc" id="L819">        runtimeService.startProcessInstanceByKey(&quot;miSequentialSubprocess&quot;);</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">        for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc" id="L821">            List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L822">            taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L823">            taskService.complete(tasks.get(1).getId());</span>
        }

        // Validate history
<span class="nc bnc" id="L827" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L828">            List&lt;HistoricActivityInstance&gt; onlySubProcessInstances = historyService.createHistoricActivityInstanceQuery().activityType(&quot;subProcess&quot;).list();</span>
<span class="nc" id="L829">            assertThat(onlySubProcessInstances).hasSize(4);</span>

<span class="nc" id="L831">            List&lt;HistoricActivityInstance&gt; historicInstances = historyService.createHistoricActivityInstanceQuery().activityType(&quot;subProcess&quot;).list();</span>
<span class="nc" id="L832">            assertThat(historicInstances).hasSize(4);</span>
<span class="nc bnc" id="L833" title="All 2 branches missed.">            for (HistoricActivityInstance hai : historicInstances) {</span>
<span class="nc" id="L834">                assertThat(hai.getStartTime()).isNotNull();</span>
<span class="nc" id="L835">                assertThat(hai.getEndTime()).isNotNull();</span>
<span class="nc" id="L836">            }</span>

<span class="nc" id="L838">            historicInstances = historyService.createHistoricActivityInstanceQuery().activityType(&quot;userTask&quot;).list();</span>
<span class="nc" id="L839">            assertThat(historicInstances).hasSize(8);</span>
<span class="nc bnc" id="L840" title="All 2 branches missed.">            for (HistoricActivityInstance hai : historicInstances) {</span>
<span class="nc" id="L841">                assertThat(hai.getStartTime()).isNotNull();</span>
<span class="nc" id="L842">                assertThat(hai.getEndTime()).isNotNull();</span>
<span class="nc" id="L843">            }</span>
        }
<span class="nc" id="L845">    }</span>

    @Test
    @Deployment
    public void testSequentialSubProcessWithTimer() {
<span class="nc" id="L850">        String procId = runtimeService.startProcessInstanceByKey(&quot;miSequentialSubprocessWithTimer&quot;).getId();</span>

        // Complete one subprocess
<span class="nc" id="L853">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L854">        assertThat(tasks).hasSize(2);</span>
<span class="nc" id="L855">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L856">        taskService.complete(tasks.get(1).getId());</span>
<span class="nc" id="L857">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L858">        assertThat(tasks).hasSize(2);</span>

        // Fire timer
<span class="nc" id="L861">        Job timer = managementService.createTimerJobQuery().singleResult();</span>
<span class="nc" id="L862">        managementService.moveTimerToExecutableJob(timer.getId());</span>
<span class="nc" id="L863">        managementService.executeJob(timer.getId());</span>

<span class="nc" id="L865">        org.flowable.task.api.Task taskAfterTimer = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L866">        assertThat(taskAfterTimer.getTaskDefinitionKey()).isEqualTo(&quot;taskAfterTimer&quot;);</span>
<span class="nc" id="L867">        taskService.complete(taskAfterTimer.getId());</span>

<span class="nc" id="L869">        assertProcessEnded(procId);</span>
<span class="nc" id="L870">    }</span>

    @Test
    @Deployment
    public void testSequentialSubProcessCompletionCondition() {
<span class="nc" id="L875">        String procId = runtimeService.startProcessInstanceByKey(&quot;miSequentialSubprocessCompletionCondition&quot;).getId();</span>

<span class="nc" id="L877">        TaskQuery query = taskService.createTaskQuery().orderByTaskName().asc();</span>
<span class="nc bnc" id="L878" title="All 2 branches missed.">        for (int i = 0; i &lt; 3; i++) {</span>
<span class="nc" id="L879">            List&lt;org.flowable.task.api.Task&gt; tasks = query.list();</span>
<span class="nc" id="L880">            assertThat(tasks)</span>
<span class="nc" id="L881">                    .extracting(Task::getName)</span>
<span class="nc" id="L882">                    .containsExactly(&quot;task one&quot;, &quot;task two&quot;);</span>

<span class="nc" id="L884">            taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L885">            taskService.complete(tasks.get(1).getId());</span>
        }

<span class="nc" id="L888">        assertProcessEnded(procId);</span>
<span class="nc" id="L889">    }</span>

    @Test
    @Deployment
    public void testNestedSequentialSubProcess() {
<span class="nc" id="L894">        String procId = runtimeService.startProcessInstanceByKey(&quot;miNestedSequentialSubProcess&quot;).getId();</span>

<span class="nc bnc" id="L896" title="All 2 branches missed.">        for (int i = 0; i &lt; 3; i++) {</span>
<span class="nc" id="L897">            List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().taskAssignee(&quot;kermit&quot;).list();</span>
<span class="nc" id="L898">            taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L899">            taskService.complete(tasks.get(1).getId());</span>
        }

<span class="nc" id="L902">        assertProcessEnded(procId);</span>
<span class="nc" id="L903">    }</span>

    @Test
    @Deployment
    public void testNestedSequentialSubProcessWithTimer() {
<span class="nc" id="L908">        String procId = runtimeService.startProcessInstanceByKey(&quot;miNestedSequentialSubProcessWithTimer&quot;).getId();</span>

<span class="nc bnc" id="L910" title="All 2 branches missed.">        for (int i = 0; i &lt; 2; i++) {</span>
<span class="nc" id="L911">            List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().taskAssignee(&quot;kermit&quot;).list();</span>
<span class="nc" id="L912">            taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L913">            taskService.complete(tasks.get(1).getId());</span>
        }

        // Complete one task, to make it a bit more trickier
<span class="nc" id="L917">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().taskAssignee(&quot;kermit&quot;).list();</span>
<span class="nc" id="L918">        taskService.complete(tasks.get(0).getId());</span>

        // Fire timer
<span class="nc" id="L921">        Job timer = managementService.createTimerJobQuery().singleResult();</span>
<span class="nc" id="L922">        managementService.moveTimerToExecutableJob(timer.getId());</span>
<span class="nc" id="L923">        managementService.executeJob(timer.getId());</span>

<span class="nc" id="L925">        org.flowable.task.api.Task taskAfterTimer = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L926">        assertThat(taskAfterTimer.getTaskDefinitionKey()).isEqualTo(&quot;taskAfterTimer&quot;);</span>
<span class="nc" id="L927">        taskService.complete(taskAfterTimer.getId());</span>

<span class="nc" id="L929">        assertProcessEnded(procId);</span>
<span class="nc" id="L930">    }</span>

    @Test
    @Deployment
    public void testParallelSubProcess() {
<span class="nc" id="L935">        String procId = runtimeService.startProcessInstanceByKey(&quot;miParallelSubprocess&quot;).getId();</span>
<span class="nc" id="L936">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().orderByTaskName().asc().list();</span>
<span class="nc" id="L937">        assertThat(tasks).hasSize(4);</span>

<span class="nc bnc" id="L939" title="All 2 branches missed.">        for (org.flowable.task.api.Task task : tasks) {</span>
<span class="nc" id="L940">            taskService.complete(task.getId());</span>
<span class="nc" id="L941">        }</span>

<span class="nc" id="L943">        assertProcessEnded(procId);</span>
<span class="nc" id="L944">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testParallelSubProcess.bpmn20.xml&quot; })
    public void testParallelSubProcessHistory() {
<span class="nc" id="L949">        runtimeService.startProcessInstanceByKey(&quot;miParallelSubprocess&quot;);</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">        for (org.flowable.task.api.Task task : taskService.createTaskQuery().list()) {</span>
<span class="nc" id="L951">            taskService.complete(task.getId());</span>
<span class="nc" id="L952">        }</span>

        // Validate history
<span class="nc bnc" id="L955" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L956">            List&lt;HistoricActivityInstance&gt; historicActivityInstances = historyService.createHistoricActivityInstanceQuery().activityId(&quot;miSubProcess&quot;).list();</span>
<span class="nc" id="L957">            assertThat(historicActivityInstances).hasSize(2);</span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">            for (HistoricActivityInstance hai : historicActivityInstances) {</span>
<span class="nc" id="L959">                assertThat(hai.getStartTime()).isNotNull();</span>
<span class="nc" id="L960">                assertThat(hai.getEndTime()).isNotNull();</span>
<span class="nc" id="L961">            }</span>
        }
<span class="nc" id="L963">    }</span>

    @Test
    @Deployment
    public void testParallelSubProcessWithTimer() {
<span class="nc" id="L968">        String procId = runtimeService.startProcessInstanceByKey(&quot;miParallelSubprocessWithTimer&quot;).getId();</span>
<span class="nc" id="L969">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L970">        assertThat(tasks).hasSize(6);</span>

        // Complete two tasks
<span class="nc" id="L973">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L974">        taskService.complete(tasks.get(1).getId());</span>

        // Fire timer
<span class="nc" id="L977">        Job timer = managementService.createTimerJobQuery().singleResult();</span>
<span class="nc" id="L978">        managementService.moveTimerToExecutableJob(timer.getId());</span>
<span class="nc" id="L979">        managementService.executeJob(timer.getId());</span>

<span class="nc" id="L981">        org.flowable.task.api.Task taskAfterTimer = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L982">        assertThat(taskAfterTimer.getTaskDefinitionKey()).isEqualTo(&quot;taskAfterTimer&quot;);</span>
<span class="nc" id="L983">        taskService.complete(taskAfterTimer.getId());</span>

<span class="nc" id="L985">        assertProcessEnded(procId);</span>
<span class="nc" id="L986">    }</span>

    @Test
    @Deployment
    public void testParallelSubProcessCompletionCondition() {
<span class="nc" id="L991">        String procId = runtimeService.startProcessInstanceByKey(&quot;miParallelSubprocessCompletionCondition&quot;).getId();</span>
<span class="nc" id="L992">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L993">        assertThat(tasks).hasSize(4);</span>

<span class="nc" id="L995">        List&lt;org.flowable.task.api.Task&gt; subProcessTasks1 = taskService.createTaskQuery().taskDefinitionKey(&quot;subProcessTask1&quot;).list();</span>
<span class="nc" id="L996">        assertThat(subProcessTasks1).hasSize(2);</span>

<span class="nc" id="L998">        List&lt;org.flowable.task.api.Task&gt; subProcessTasks2 = taskService.createTaskQuery().taskDefinitionKey(&quot;subProcessTask2&quot;).list();</span>
<span class="nc" id="L999">        assertThat(subProcessTasks2).hasSize(2);</span>

<span class="nc" id="L1001">        Execution taskExecution = runtimeService.createExecutionQuery().executionId(subProcessTasks1.get(0).getExecutionId()).singleResult();</span>
<span class="nc" id="L1002">        String parentExecutionId = taskExecution.getParentId();</span>

<span class="nc" id="L1004">        org.flowable.task.api.Task subProcessTask2 = null;</span>
<span class="nc bnc" id="L1005" title="All 2 branches missed.">        for (org.flowable.task.api.Task task : subProcessTasks2) {</span>
<span class="nc" id="L1006">            Execution toFindExecution = runtimeService.createExecutionQuery().executionId(task.getExecutionId()).singleResult();</span>
<span class="nc bnc" id="L1007" title="All 2 branches missed.">            if (toFindExecution.getParentId().equals(parentExecutionId)) {</span>
<span class="nc" id="L1008">                subProcessTask2 = task;</span>
<span class="nc" id="L1009">                break;</span>
            }
<span class="nc" id="L1011">        }</span>

<span class="nc" id="L1013">        assertThat(subProcessTask2).isNotNull();</span>
<span class="nc" id="L1014">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L1015">        taskService.complete(subProcessTask2.getId());</span>

<span class="nc" id="L1017">        assertProcessEnded(procId);</span>
<span class="nc" id="L1018">    }</span>

    @Test
    @Deployment
    public void testParallelSubProcessAllAutomatic() {
<span class="nc" id="L1023">        String procId = runtimeService.startProcessInstanceByKey(&quot;miParallelSubprocessAllAutomatics&quot;, CollectionUtil.singletonMap(&quot;nrOfLoops&quot;, 5)).getId();</span>

<span class="nc bnc" id="L1025" title="All 2 branches missed.">        for (int i = 0; i &lt; 5; i++) {</span>
<span class="nc" id="L1026">            List&lt;Execution&gt; waitSubExecutions = runtimeService.createExecutionQuery().activityId(&quot;subProcessWait&quot;).list();</span>
<span class="nc" id="L1027">            assertThat(waitSubExecutions).isNotEmpty();</span>
<span class="nc" id="L1028">            runtimeService.trigger(waitSubExecutions.get(0).getId());</span>
        }

<span class="nc" id="L1031">        List&lt;Execution&gt; waitSubExecutions = runtimeService.createExecutionQuery().activityId(&quot;subProcessWait&quot;).list();</span>
<span class="nc" id="L1032">        assertThat(waitSubExecutions).isEmpty();</span>

<span class="nc" id="L1034">        Execution waitState = runtimeService.createExecutionQuery().activityId(&quot;waitState&quot;).singleResult();</span>
<span class="nc" id="L1035">        assertThat(runtimeService.getVariable(waitState.getId(), &quot;sum&quot;)).isEqualTo(10);</span>

<span class="nc" id="L1037">        runtimeService.trigger(waitState.getId());</span>
<span class="nc" id="L1038">        assertProcessEnded(procId);</span>
<span class="nc" id="L1039">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testParallelSubProcessAllAutomatic.bpmn20.xml&quot; })
    public void testParallelSubProcessAllAutomaticCompletionCondition() {
<span class="nc" id="L1044">        String procId = runtimeService.startProcessInstanceByKey(&quot;miParallelSubprocessAllAutomatics&quot;, CollectionUtil.singletonMap(&quot;nrOfLoops&quot;, 10)).getId();</span>

<span class="nc bnc" id="L1046" title="All 2 branches missed.">        for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L1047">            List&lt;Execution&gt; waitSubExecutions = runtimeService.createExecutionQuery().activityId(&quot;subProcessWait&quot;).list();</span>
<span class="nc" id="L1048">            assertThat(waitSubExecutions).isNotEmpty();</span>
<span class="nc" id="L1049">            runtimeService.trigger(waitSubExecutions.get(0).getId());</span>
        }

<span class="nc" id="L1052">        List&lt;Execution&gt; waitSubExecutions = runtimeService.createExecutionQuery().activityId(&quot;subProcessWait&quot;).list();</span>
<span class="nc" id="L1053">        assertThat(waitSubExecutions).isEmpty();</span>

<span class="nc" id="L1055">        Execution waitState = runtimeService.createExecutionQuery().activityId(&quot;waitState&quot;).singleResult();</span>
<span class="nc" id="L1056">        assertThat(runtimeService.getVariable(procId, &quot;sum&quot;)).isEqualTo(12);</span>

<span class="nc" id="L1058">        runtimeService.trigger(waitState.getId());</span>
<span class="nc" id="L1059">        assertProcessEnded(procId);</span>
<span class="nc" id="L1060">    }</span>

    @Test
    @Deployment
    public void testNestedParallelSubProcess() {
<span class="nc" id="L1065">        String procId = runtimeService.startProcessInstanceByKey(&quot;miNestedParallelSubProcess&quot;).getId();</span>
<span class="nc" id="L1066">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1067">        assertThat(tasks).hasSize(8);</span>

<span class="nc bnc" id="L1069" title="All 2 branches missed.">        for (org.flowable.task.api.Task task : tasks) {</span>
<span class="nc" id="L1070">            taskService.complete(task.getId());</span>
<span class="nc" id="L1071">        }</span>
<span class="nc" id="L1072">        assertProcessEnded(procId);</span>
<span class="nc" id="L1073">    }</span>

    @Test
    @Deployment
    public void testNestedParallelSubProcessWithTimer() {
<span class="nc" id="L1078">        String procId = runtimeService.startProcessInstanceByKey(&quot;miNestedParallelSubProcess&quot;).getId();</span>
<span class="nc" id="L1079">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1080">        assertThat(tasks).hasSize(12);</span>

<span class="nc bnc" id="L1082" title="All 2 branches missed.">        for (int i = 0; i &lt; 3; i++) {</span>
<span class="nc" id="L1083">            taskService.complete(tasks.get(i).getId());</span>
        }

        // Fire timer
<span class="nc" id="L1087">        Job timer = managementService.createTimerJobQuery().singleResult();</span>
<span class="nc" id="L1088">        managementService.moveTimerToExecutableJob(timer.getId());</span>
<span class="nc" id="L1089">        managementService.executeJob(timer.getId());</span>

<span class="nc" id="L1091">        org.flowable.task.api.Task taskAfterTimer = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L1092">        assertThat(taskAfterTimer.getTaskDefinitionKey()).isEqualTo(&quot;taskAfterTimer&quot;);</span>
<span class="nc" id="L1093">        taskService.complete(taskAfterTimer.getId());</span>

<span class="nc" id="L1095">        assertProcessEnded(procId);</span>
<span class="nc" id="L1096">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testCallActivityLocalVariables.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.externalSubProcess.bpmn20.xml&quot; })
    public void testCallActivityLocalVariables() {
<span class="nc" id="L1102">        Map&lt;String, Object&gt; variables = Collections.singletonMap(&quot;name&quot;, (Object) &quot;test&quot;);</span>
<span class="nc" id="L1103">        String procId = runtimeService.startProcessInstanceByKey(&quot;miSubProcessLocalVariables&quot;, variables).getId();</span>

<span class="nc bnc" id="L1105" title="All 2 branches missed.">        for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc" id="L1106">            List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().orderByTaskName().asc().list();</span>
<span class="nc" id="L1107">            assertThat(tasks)</span>
<span class="nc" id="L1108">                    .extracting(Task::getName)</span>
<span class="nc" id="L1109">                    .containsExactly(&quot;task one&quot;, &quot;task two&quot;);</span>

<span class="nc" id="L1111">            Map&lt;String, Object&gt; taskVariables = Collections.singletonMap(&quot;output&quot;, (Object) (&quot;run&quot; + i + 1));</span>
<span class="nc" id="L1112">            taskService.complete(tasks.get(0).getId(), taskVariables);</span>
<span class="nc" id="L1113">            taskService.complete(tasks.get(1).getId());</span>
            
<span class="nc" id="L1115">            org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(procId).singleResult();</span>
<span class="nc" id="L1116">            assertThat(task).isNotNull();</span>
<span class="nc" id="L1117">            assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;task&quot;);</span>
            
<span class="nc" id="L1119">            ExecutionEntity execution = (ExecutionEntity) runtimeService.createExecutionQuery().processInstanceId(procId).activityId(&quot;task&quot;).singleResult();</span>
<span class="nc" id="L1120">            assertThat(runtimeService.getVariableLocal(execution.getId(), &quot;output&quot;)).isEqualTo(&quot;run&quot; + i + 1);</span>
<span class="nc" id="L1121">            assertThat(runtimeService.getVariable(procId, &quot;output&quot;)).isNull();</span>
            
<span class="nc" id="L1123">            taskService.complete(task.getId());</span>
        }

<span class="nc" id="L1126">        assertProcessEnded(procId);</span>
<span class="nc" id="L1127">    }</span>
    
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testCallActivityNormalVariables.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.externalSubProcess.bpmn20.xml&quot; })
        public void testCallActivityNormalVariables() {
<span class="nc" id="L1133">        Map&lt;String, Object&gt; variables = Collections.singletonMap(&quot;name&quot;, (Object) &quot;test&quot;);</span>
<span class="nc" id="L1134">        String procId = runtimeService.startProcessInstanceByKey(&quot;miSubProcessNormalVariables&quot;, variables).getId();</span>
        
<span class="nc bnc" id="L1136" title="All 2 branches missed.">        for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc" id="L1137">            List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().orderByTaskName().asc().list();</span>
<span class="nc" id="L1138">            assertThat(tasks)</span>
<span class="nc" id="L1139">                    .extracting(Task::getName)</span>
<span class="nc" id="L1140">                    .containsExactly(&quot;task one&quot;, &quot;task two&quot;);</span>

<span class="nc" id="L1142">            Map&lt;String, Object&gt; taskVariables = Collections.singletonMap(&quot;output&quot;, (Object) (&quot;run&quot; + i + 1));</span>
<span class="nc" id="L1143">            taskService.complete(tasks.get(0).getId(), taskVariables);</span>
<span class="nc" id="L1144">            taskService.complete(tasks.get(1).getId());</span>
            
<span class="nc" id="L1146">            org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(procId).singleResult();</span>
<span class="nc" id="L1147">            assertThat(task).isNotNull();</span>
<span class="nc" id="L1148">            assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;task&quot;);</span>
            
<span class="nc" id="L1150">            ExecutionEntity execution = (ExecutionEntity) runtimeService.createExecutionQuery().processInstanceId(procId).activityId(&quot;task&quot;).singleResult();</span>
<span class="nc" id="L1151">            assertThat(runtimeService.getVariableLocal(execution.getId(), &quot;output&quot;)).isNull();</span>
<span class="nc" id="L1152">            assertThat(runtimeService.getVariable(procId, &quot;output&quot;)).isEqualTo(&quot;run&quot; + i + 1);</span>
            
<span class="nc" id="L1154">            taskService.complete(task.getId());</span>
        }
        
<span class="nc" id="L1157">        assertProcessEnded(procId);</span>
<span class="nc" id="L1158">    }</span>
    
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testSequentialCallActivity.bpmn20.xml&quot;,
    &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.externalSubProcess.bpmn20.xml&quot; })
    public void testSequentialCallActivity() {
<span class="nc" id="L1164">        String procId = runtimeService.startProcessInstanceByKey(&quot;miSequentialCallActivity&quot;).getId();</span>

<span class="nc bnc" id="L1166" title="All 2 branches missed.">        for (int i = 0; i &lt; 3; i++) {</span>
<span class="nc" id="L1167">            List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().orderByTaskName().asc().list();</span>
<span class="nc" id="L1168">            assertThat(tasks)</span>
<span class="nc" id="L1169">                    .extracting(Task::getName)</span>
<span class="nc" id="L1170">                    .containsExactly(&quot;task one&quot;, &quot;task two&quot;);</span>
<span class="nc" id="L1171">            taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L1172">            taskService.complete(tasks.get(1).getId());</span>
        }

<span class="nc" id="L1175">        assertProcessEnded(procId);</span>
<span class="nc" id="L1176">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testSequentialCallActivityWithList.bpmn20.xml&quot;)
    public void testSequentialCallActivityWithList() {
<span class="nc" id="L1181">        ArrayList&lt;String&gt; list = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1182">        list.add(&quot;one&quot;);</span>
<span class="nc" id="L1183">        list.add(&quot;two&quot;);</span>

<span class="nc" id="L1185">        HashMap&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1186">        variables.put(&quot;list&quot;, list);</span>

<span class="nc" id="L1188">        String procId = runtimeService.startProcessInstanceByKey(&quot;parentProcess&quot;, variables).getId();</span>

<span class="nc" id="L1190">        org.flowable.task.api.Task task1 = taskService.createTaskQuery().processVariableValueEquals(&quot;element&quot;, &quot;one&quot;).singleResult();</span>
<span class="nc" id="L1191">        org.flowable.task.api.Task task2 = taskService.createTaskQuery().processVariableValueEquals(&quot;element&quot;, &quot;two&quot;).singleResult();</span>

<span class="nc" id="L1193">        assertThat(task1).isNotNull();</span>
<span class="nc" id="L1194">        assertThat(task2).isNotNull();</span>

<span class="nc" id="L1196">        HashMap&lt;String, Object&gt; subVariables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1197">        subVariables.put(&quot;x&quot;, &quot;y&quot;);</span>

<span class="nc" id="L1199">        taskService.complete(task1.getId(), subVariables);</span>
<span class="nc" id="L1200">        taskService.complete(task2.getId(), subVariables);</span>

<span class="nc" id="L1202">        org.flowable.task.api.Task task3 = taskService.createTaskQuery().processDefinitionKey(&quot;midProcess&quot;).singleResult();</span>
<span class="nc" id="L1203">        assertThat(task3).isNotNull();</span>
<span class="nc" id="L1204">        taskService.complete(task3.getId());</span>

<span class="nc" id="L1206">        org.flowable.task.api.Task task4 = taskService.createTaskQuery().processDefinitionKey(&quot;parentProcess&quot;).singleResult();</span>
<span class="nc" id="L1207">        assertThat(task4).isNotNull();</span>
<span class="nc" id="L1208">        taskService.complete(task4.getId());</span>

<span class="nc" id="L1210">        assertProcessEnded(procId);</span>
<span class="nc" id="L1211">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testSequentialCallActivityWithTimer.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.externalSubProcess.bpmn20.xml&quot; })
    public void testSequentialCallActivityWithTimer() {
<span class="nc" id="L1217">        String procId = runtimeService.startProcessInstanceByKey(&quot;miSequentialCallActivityWithTimer&quot;).getId();</span>

        // Complete first subprocess
<span class="nc" id="L1220">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().orderByTaskName().asc().list();</span>
<span class="nc" id="L1221">        assertThat(tasks)</span>
<span class="nc" id="L1222">                .extracting(Task::getName)</span>
<span class="nc" id="L1223">                .containsExactly(&quot;task one&quot;, &quot;task two&quot;);</span>
<span class="nc" id="L1224">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L1225">        taskService.complete(tasks.get(1).getId());</span>

        // Fire timer
<span class="nc" id="L1228">        Job timer = managementService.createTimerJobQuery().singleResult();</span>
<span class="nc" id="L1229">        managementService.moveTimerToExecutableJob(timer.getId());</span>
<span class="nc" id="L1230">        managementService.executeJob(timer.getId());</span>

<span class="nc" id="L1232">        org.flowable.task.api.Task taskAfterTimer = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L1233">        assertThat(taskAfterTimer.getTaskDefinitionKey()).isEqualTo(&quot;taskAfterTimer&quot;);</span>
<span class="nc" id="L1234">        taskService.complete(taskAfterTimer.getId());</span>

<span class="nc" id="L1236">        assertProcessEnded(procId);</span>
<span class="nc" id="L1237">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testParallelCallActivity.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.externalSubProcess.bpmn20.xml&quot; })
    public void testParallelCallActivity() {
<span class="nc" id="L1243">        String procId = runtimeService.startProcessInstanceByKey(&quot;miParallelCallActivity&quot;).getId();</span>
<span class="nc" id="L1244">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1245">        assertThat(tasks).hasSize(12);</span>
<span class="nc bnc" id="L1246" title="All 2 branches missed.">        for (int i = 0; i &lt; tasks.size(); i++) {</span>
<span class="nc" id="L1247">            taskService.complete(tasks.get(i).getId());</span>
        }

<span class="nc" id="L1250">        assertProcessEnded(procId);</span>
<span class="nc" id="L1251">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testParallelCallActivity.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.externalSubProcess.bpmn20.xml&quot; })
    public void testParallelCallActivityHistory() {
<span class="nc" id="L1257">        runtimeService.startProcessInstanceByKey(&quot;miParallelCallActivity&quot;);</span>
<span class="nc" id="L1258">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1259">        assertThat(tasks).hasSize(12);</span>
<span class="nc bnc" id="L1260" title="All 2 branches missed.">        for (int i = 0; i &lt; tasks.size(); i++) {</span>
<span class="nc" id="L1261">            taskService.complete(tasks.get(i).getId());</span>
        }

<span class="nc bnc" id="L1264" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            // Validate historic processes
<span class="nc" id="L1266">            List&lt;HistoricProcessInstance&gt; historicProcessInstances = historyService.createHistoricProcessInstanceQuery().list();</span>
<span class="nc" id="L1267">            assertThat(historicProcessInstances).hasSize(7); // 6 subprocesses</span>
                                                              // + main process
<span class="nc bnc" id="L1269" title="All 2 branches missed.">            for (HistoricProcessInstance hpi : historicProcessInstances) {</span>
<span class="nc" id="L1270">                assertThat(hpi.getStartTime()).isNotNull();</span>
<span class="nc" id="L1271">                assertThat(hpi.getEndTime()).isNotNull();</span>
<span class="nc" id="L1272">            }</span>

            // Validate historic tasks
<span class="nc" id="L1275">            List&lt;HistoricTaskInstance&gt; historicTaskInstances = historyService.createHistoricTaskInstanceQuery().list();</span>
<span class="nc" id="L1276">            assertThat(historicTaskInstances).hasSize(12);</span>
<span class="nc bnc" id="L1277" title="All 2 branches missed.">            for (HistoricTaskInstance hti : historicTaskInstances) {</span>
<span class="nc" id="L1278">                assertThat(hti.getStartTime()).isNotNull();</span>
<span class="nc" id="L1279">                assertThat(hti.getEndTime()).isNotNull();</span>
<span class="nc" id="L1280">                assertThat(hti.getAssignee()).isNotNull();</span>
<span class="nc" id="L1281">                assertThat(hti.getDeleteReason()).isNull();</span>
<span class="nc" id="L1282">            }</span>

            // Validate historic activities
<span class="nc" id="L1285">            List&lt;HistoricActivityInstance&gt; historicActivityInstances = historyService.createHistoricActivityInstanceQuery().activityType(&quot;callActivity&quot;).list();</span>
<span class="nc" id="L1286">            assertThat(historicActivityInstances).hasSize(6);</span>
<span class="nc bnc" id="L1287" title="All 2 branches missed.">            for (HistoricActivityInstance hai : historicActivityInstances) {</span>
<span class="nc" id="L1288">                assertThat(hai.getStartTime()).isNotNull();</span>
<span class="nc" id="L1289">                assertThat(hai.getEndTime()).isNotNull();</span>
<span class="nc" id="L1290">            }</span>
        }
<span class="nc" id="L1292">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testParallelCallActivityWithTimer.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.externalSubProcess.bpmn20.xml&quot; })
    public void testParallelCallActivityWithTimer() {
<span class="nc" id="L1298">        String procId = runtimeService.startProcessInstanceByKey(&quot;miParallelCallActivity&quot;).getId();</span>
<span class="nc" id="L1299">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1300">        assertThat(tasks).hasSize(6);</span>
<span class="nc bnc" id="L1301" title="All 2 branches missed.">        for (int i = 0; i &lt; 2; i++) {</span>
<span class="nc" id="L1302">            taskService.complete(tasks.get(i).getId());</span>
        }

        // Fire timer
<span class="nc" id="L1306">        Job timer = managementService.createTimerJobQuery().singleResult();</span>
<span class="nc" id="L1307">        managementService.moveTimerToExecutableJob(timer.getId());</span>
<span class="nc" id="L1308">        managementService.executeJob(timer.getId());</span>

<span class="nc" id="L1310">        org.flowable.task.api.Task taskAfterTimer = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L1311">        assertThat(taskAfterTimer.getTaskDefinitionKey()).isEqualTo(&quot;taskAfterTimer&quot;);</span>
<span class="nc" id="L1312">        taskService.complete(taskAfterTimer.getId());</span>

<span class="nc" id="L1314">        assertProcessEnded(procId);</span>
<span class="nc" id="L1315">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testNestedSequentialCallActivity.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.externalSubProcess.bpmn20.xml&quot; })
    public void testNestedSequentialCallActivity() {
<span class="nc" id="L1321">        String procId = runtimeService.startProcessInstanceByKey(&quot;miNestedSequentialCallActivity&quot;).getId();</span>

<span class="nc bnc" id="L1323" title="All 2 branches missed.">        for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc" id="L1324">            List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().orderByTaskName().asc().list();</span>
<span class="nc" id="L1325">            assertThat(tasks)</span>
<span class="nc" id="L1326">                    .extracting(Task::getName)</span>
<span class="nc" id="L1327">                    .containsExactly(&quot;task one&quot;, &quot;task two&quot;);</span>
<span class="nc" id="L1328">            taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L1329">            taskService.complete(tasks.get(1).getId());</span>
        }

<span class="nc" id="L1332">        assertProcessEnded(procId);</span>
<span class="nc" id="L1333">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testNestedSequentialCallActivityWithTimer.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.externalSubProcess.bpmn20.xml&quot; })
    public void testNestedSequentialCallActivityWithTimer() {
<span class="nc" id="L1339">        String procId = runtimeService.startProcessInstanceByKey(&quot;miNestedSequentialCallActivityWithTimer&quot;).getId();</span>

        // first instance
<span class="nc" id="L1342">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().orderByTaskName().asc().list();</span>
<span class="nc" id="L1343">        assertThat(tasks)</span>
<span class="nc" id="L1344">                .extracting(Task::getName)</span>
<span class="nc" id="L1345">                .containsExactly(&quot;task one&quot;, &quot;task two&quot;);</span>
<span class="nc" id="L1346">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L1347">        taskService.complete(tasks.get(1).getId());</span>

        // one task of second instance
<span class="nc" id="L1350">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1351">        assertThat(tasks).hasSize(2);</span>
<span class="nc" id="L1352">        taskService.complete(tasks.get(0).getId());</span>

        // Fire timer
<span class="nc" id="L1355">        Job timer = managementService.createTimerJobQuery().singleResult();</span>
<span class="nc" id="L1356">        managementService.moveTimerToExecutableJob(timer.getId());</span>
<span class="nc" id="L1357">        managementService.executeJob(timer.getId());</span>

<span class="nc" id="L1359">        org.flowable.task.api.Task taskAfterTimer = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L1360">        assertThat(taskAfterTimer.getTaskDefinitionKey()).isEqualTo(&quot;taskAfterTimer&quot;);</span>
<span class="nc" id="L1361">        taskService.complete(taskAfterTimer.getId());</span>

<span class="nc" id="L1363">        assertProcessEnded(procId);</span>
<span class="nc" id="L1364">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testNestedParallelCallActivity.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.externalSubProcess.bpmn20.xml&quot; })
    public void testNestedParallelCallActivity() {
<span class="nc" id="L1370">        String procId = runtimeService.startProcessInstanceByKey(&quot;miNestedParallelCallActivity&quot;).getId();</span>

<span class="nc" id="L1372">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1373">        assertThat(tasks).hasSize(14);</span>
<span class="nc bnc" id="L1374" title="All 2 branches missed.">        for (int i = 0; i &lt; 14; i++) {</span>
<span class="nc" id="L1375">            taskService.complete(tasks.get(i).getId());</span>
        }

<span class="nc" id="L1378">        assertProcessEnded(procId);</span>
<span class="nc" id="L1379">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testNestedParallelCallActivityWithTimer.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.externalSubProcess.bpmn20.xml&quot; })
    public void testNestedParallelCallActivityWithTimer() {
<span class="nc" id="L1385">        String procId = runtimeService.startProcessInstanceByKey(&quot;miNestedParallelCallActivityWithTimer&quot;).getId();</span>

<span class="nc" id="L1387">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1388">        assertThat(tasks).hasSize(4);</span>
<span class="nc bnc" id="L1389" title="All 2 branches missed.">        for (int i = 0; i &lt; 3; i++) {</span>
<span class="nc" id="L1390">            taskService.complete(tasks.get(i).getId());</span>
        }

        // Fire timer
<span class="nc" id="L1394">        Job timer = managementService.createTimerJobQuery().singleResult();</span>
<span class="nc" id="L1395">        managementService.moveTimerToExecutableJob(timer.getId());</span>
<span class="nc" id="L1396">        managementService.executeJob(timer.getId());</span>

<span class="nc" id="L1398">        org.flowable.task.api.Task taskAfterTimer = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L1399">        assertThat(taskAfterTimer.getTaskDefinitionKey()).isEqualTo(&quot;taskAfterTimer&quot;);</span>
<span class="nc" id="L1400">        taskService.complete(taskAfterTimer.getId());</span>

<span class="nc" id="L1402">        assertProcessEnded(procId);</span>
<span class="nc" id="L1403">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testNestedParallelCallActivityCompletionCondition.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.externalSubProcess.bpmn20.xml&quot; })
    public void testNestedParallelCallActivityCompletionCondition() {
<span class="nc" id="L1409">        String procId = runtimeService.startProcessInstanceByKey(&quot;miNestedParallelCallActivityCompletionCondition&quot;).getId();</span>

<span class="nc" id="L1411">        assertThat(taskService.createTaskQuery().count()).isEqualTo(8);</span>

<span class="nc bnc" id="L1413" title="All 2 branches missed.">        for (int i = 0; i &lt; 2; i++) {</span>
<span class="nc" id="L1414">            ProcessInstance nextSubProcessInstance = runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;externalSubProcess&quot;).listPage(0, 1).get(0);</span>
<span class="nc" id="L1415">            List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(nextSubProcessInstance.getId()).list();</span>
<span class="nc" id="L1416">            assertThat(tasks).hasSize(2);</span>
<span class="nc bnc" id="L1417" title="All 2 branches missed.">            for (org.flowable.task.api.Task task : tasks) {</span>
<span class="nc" id="L1418">                taskService.complete(task.getId());</span>
<span class="nc" id="L1419">            }</span>
        }

<span class="nc" id="L1422">        assertProcessEnded(procId);</span>
<span class="nc" id="L1423">    }</span>

    // ACT-764
    @Test
    @Deployment
    public void testSequentialServiceTaskWithClass() {
<span class="nc" id="L1429">        ProcessInstance procInst = runtimeService.startProcessInstanceByKey(&quot;multiInstanceServiceTask&quot;, CollectionUtil.singletonMap(&quot;result&quot;, 5));</span>
<span class="nc" id="L1430">        Integer result = (Integer) runtimeService.getVariable(procInst.getId(), &quot;result&quot;);</span>
<span class="nc" id="L1431">        assertThat(result.intValue()).isEqualTo(160);</span>

<span class="nc" id="L1433">        Execution waitExecution = runtimeService.createExecutionQuery().processInstanceId(procInst.getId()).activityId(&quot;wait&quot;).singleResult();</span>
<span class="nc" id="L1434">        runtimeService.trigger(waitExecution.getId());</span>
<span class="nc" id="L1435">        assertProcessEnded(procInst.getId());</span>
<span class="nc" id="L1436">    }</span>

    @Test
    @Deployment
    public void testSequentialServiceTaskWithClassAndCollection() {
<span class="nc" id="L1441">        Collection&lt;Integer&gt; items = Arrays.asList(1, 2, 3, 4, 5, 6);</span>
<span class="nc" id="L1442">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1443">        vars.put(&quot;result&quot;, 1);</span>
<span class="nc" id="L1444">        vars.put(&quot;items&quot;, items);</span>

<span class="nc" id="L1446">        ProcessInstance procInst = runtimeService.startProcessInstanceByKey(&quot;multiInstanceServiceTask&quot;, vars);</span>
<span class="nc" id="L1447">        Integer result = (Integer) runtimeService.getVariable(procInst.getId(), &quot;result&quot;);</span>
<span class="nc" id="L1448">        assertThat(result.intValue()).isEqualTo(720);</span>

<span class="nc" id="L1450">        Execution waitExecution = runtimeService.createExecutionQuery().processInstanceId(procInst.getId()).activityId(&quot;wait&quot;).singleResult();</span>
<span class="nc" id="L1451">        runtimeService.trigger(waitExecution.getId());</span>
<span class="nc" id="L1452">        assertProcessEnded(procInst.getId());</span>
<span class="nc" id="L1453">    }</span>

    // ACT-901
    @Test
    @Deployment
    public void testAct901() {

<span class="nc" id="L1460">        Date startTime = processEngineConfiguration.getClock().getCurrentTime();</span>

<span class="nc" id="L1462">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;multiInstanceSubProcess&quot;);</span>
<span class="nc" id="L1463">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(pi.getId()).orderByTaskName().asc().list();</span>

<span class="nc" id="L1465">        processEngineConfiguration.getClock().setCurrentTime(new Date(startTime.getTime() + 61000L)); // timer is set to one minute</span>
<span class="nc" id="L1466">        List&lt;Job&gt; timers = managementService.createTimerJobQuery().list();</span>
<span class="nc" id="L1467">        assertThat(timers).hasSize(5);</span>

        // Execute all timers one by one (single thread vs thread pool of job
        // executor, which leads to optimisticlockingexceptions!)
<span class="nc bnc" id="L1471" title="All 2 branches missed.">        for (Job timer : timers) {</span>
<span class="nc" id="L1472">            managementService.moveTimerToExecutableJob(timer.getId());</span>
<span class="nc" id="L1473">            managementService.executeJob(timer.getId());</span>
<span class="nc" id="L1474">        }</span>

        // All tasks should be canceled
<span class="nc" id="L1477">        tasks = taskService.createTaskQuery().processInstanceId(pi.getId()).orderByTaskName().asc().list();</span>
<span class="nc" id="L1478">        assertThat(tasks).isEmpty();</span>
<span class="nc" id="L1479">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.callActivityWithBoundaryErrorEvent.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.throwingErrorEventSubProcess.bpmn20.xml&quot; })
    public void testMultiInstanceCallActivityWithErrorBoundaryEvent() {
<span class="nc" id="L1485">        Map&lt;String, Object&gt; variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1486">        variableMap.put(&quot;assignees&quot;, Arrays.asList(&quot;kermit&quot;, &quot;gonzo&quot;));</span>

<span class="nc" id="L1488">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;process&quot;, variableMap);</span>

<span class="nc" id="L1490">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1491">        assertThat(tasks).hasSize(2);</span>

        // finish first call activity with error
<span class="nc" id="L1494">        variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1495">        variableMap.put(&quot;done&quot;, false);</span>
<span class="nc" id="L1496">        taskService.complete(tasks.get(0).getId(), variableMap);</span>

<span class="nc" id="L1498">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1499">        assertThat(tasks).hasSize(1);</span>

<span class="nc" id="L1501">        taskService.complete(tasks.get(0).getId());</span>

<span class="nc" id="L1503">        List&lt;ProcessInstance&gt; processInstances = runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;process&quot;).list();</span>
<span class="nc" id="L1504">        assertThat(processInstances).isEmpty();</span>
<span class="nc" id="L1505">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1506">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.callActivityWithBoundaryErrorEventSequential.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.throwingErrorEventSubProcess.bpmn20.xml&quot; })
    public void testSequentialMultiInstanceCallActivityWithErrorBoundaryEvent() {
<span class="nc" id="L1512">        Map&lt;String, Object&gt; variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1513">        variableMap.put(&quot;assignees&quot;, Arrays.asList(&quot;kermit&quot;, &quot;gonzo&quot;));</span>

<span class="nc" id="L1515">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;process&quot;, variableMap);</span>

<span class="nc" id="L1517">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1518">        assertThat(tasks).hasSize(1);</span>

        // finish first call activity with error
<span class="nc" id="L1521">        variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1522">        variableMap.put(&quot;done&quot;, false);</span>
<span class="nc" id="L1523">        taskService.complete(tasks.get(0).getId(), variableMap);</span>

<span class="nc" id="L1525">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1526">        assertThat(tasks).hasSize(1);</span>

<span class="nc" id="L1528">        taskService.complete(tasks.get(0).getId());</span>

<span class="nc" id="L1530">        List&lt;ProcessInstance&gt; processInstances = runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;process&quot;).list();</span>
<span class="nc" id="L1531">        assertThat(processInstances).isEmpty();</span>
<span class="nc" id="L1532">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1533">    }</span>

    @Test
    @Deployment
    public void testMultiInstanceParallelReceiveTask() {
<span class="nc" id="L1538">        runtimeService.startProcessInstanceByKey(&quot;multi-instance-receive&quot;);</span>
<span class="nc" id="L1539">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().activityId(&quot;theReceiveTask&quot;).list();</span>
<span class="nc" id="L1540">        assertThat(executions).hasSize(4);</span>

        // Complete all four of the executions
<span class="nc bnc" id="L1543" title="All 2 branches missed.">        for (Execution execution : executions) {</span>
<span class="nc" id="L1544">            runtimeService.trigger(execution.getId());</span>
<span class="nc" id="L1545">        }</span>

        // There is one task after the task
<span class="nc" id="L1548">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L1549">        assertThat(task).isNotNull();</span>
<span class="nc" id="L1550">        taskService.complete(task.getId());</span>

<span class="nc" id="L1552">        assertThat(runtimeService.createExecutionQuery().count()).isZero();</span>
<span class="nc" id="L1553">    }</span>

    @Test
    @Deployment
    public void testMultiInstanceParalelReceiveTaskWithTimer() {
<span class="nc" id="L1558">        Date startTime = new Date();</span>
<span class="nc" id="L1559">        processEngineConfiguration.getClock().setCurrentTime(startTime);</span>

<span class="nc" id="L1561">        runtimeService.startProcessInstanceByKey(&quot;multiInstanceReceiveWithTimer&quot;);</span>
<span class="nc" id="L1562">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().activityId(&quot;theReceiveTask&quot;).list();</span>
<span class="nc" id="L1563">        assertThat(executions).hasSize(3);</span>

        // Signal only one execution. Then the timer will fire
<span class="nc" id="L1566">        runtimeService.trigger(executions.get(1).getId());</span>
<span class="nc" id="L1567">        processEngineConfiguration.getClock().setCurrentTime(new Date(startTime.getTime() + 60000L));</span>
<span class="nc" id="L1568">        waitForJobExecutorToProcessAllJobs(10000L, 1000L);</span>

        // The process should now be in the task after the timer
<span class="nc" id="L1571">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L1572">        assertThat(task.getName()).isEqualTo(&quot;Task after timer&quot;);</span>

        // Completing it should end the process
<span class="nc" id="L1575">        taskService.complete(task.getId());</span>
<span class="nc" id="L1576">        assertThat(runtimeService.createExecutionQuery().count()).isZero();</span>
<span class="nc" id="L1577">    }</span>

    @Test
    @Deployment
    public void testMultiInstanceSequentialReceiveTask() {
<span class="nc" id="L1582">        runtimeService.startProcessInstanceByKey(&quot;multi-instance-receive&quot;);</span>
<span class="nc" id="L1583">        Execution execution = runtimeService.createExecutionQuery().activityId(&quot;theReceiveTask&quot;).singleResult();</span>
<span class="nc" id="L1584">        assertThat(execution).isNotNull();</span>

        // Complete all four of the executions
<span class="nc bnc" id="L1587" title="All 2 branches missed.">        while (execution != null) {</span>
<span class="nc" id="L1588">            runtimeService.trigger(execution.getId());</span>
<span class="nc" id="L1589">            execution = runtimeService.createExecutionQuery().activityId(&quot;theReceiveTask&quot;).singleResult();</span>
        }

        // There is one task after the task
<span class="nc" id="L1593">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L1594">        assertThat(task).isNotNull();</span>
<span class="nc" id="L1595">        taskService.complete(task.getId());</span>

<span class="nc" id="L1597">        assertThat(runtimeService.createExecutionQuery().count()).isZero();</span>
<span class="nc" id="L1598">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testNestedMultiInstanceTasks.bpmn20.xml&quot; })
    public void testNestedMultiInstanceTasks() {
<span class="nc" id="L1603">        List&lt;String&gt; processes = Arrays.asList(&quot;process A&quot;, &quot;process B&quot;);</span>
<span class="nc" id="L1604">        List&lt;String&gt; assignees = Arrays.asList(&quot;kermit&quot;, &quot;gonzo&quot;);</span>
<span class="nc" id="L1605">        Map&lt;String, Object&gt; variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1606">        variableMap.put(&quot;subProcesses&quot;, processes);</span>
<span class="nc" id="L1607">        variableMap.put(&quot;assignees&quot;, assignees);</span>

<span class="nc" id="L1609">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;miNestedMultiInstanceTasks&quot;, variableMap);</span>

<span class="nc" id="L1611">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L1612">        assertThat(tasks).hasSize(processes.size() * assignees.size());</span>

<span class="nc bnc" id="L1614" title="All 2 branches missed.">        for (org.flowable.task.api.Task t : tasks) {</span>
<span class="nc" id="L1615">            taskService.complete(t.getId(), Collections.singletonMap(&quot;assignee&quot;, &quot;1&quot;));</span>
<span class="nc" id="L1616">        }</span>

<span class="nc" id="L1618">        List&lt;ProcessInstance&gt; processInstances = runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;miNestedMultiInstanceTasks&quot;).list();</span>
<span class="nc" id="L1619">        assertThat(processInstances).isEmpty();</span>
<span class="nc" id="L1620">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1621">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testSequentialSubprocessEmptyCollection.bpmn20.xml&quot; })
    public void testSequentialSubprocessEmptyCollection() {
<span class="nc" id="L1626">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L1627">                .processDefinitionKey(&quot;testSequentialSubProcessEmptyCollection&quot;)</span>
<span class="nc" id="L1628">                .transientVariable(&quot;collection&quot;, Collections.emptyList())</span>
<span class="nc" id="L1629">                .start();</span>
<span class="nc" id="L1630">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L1631">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L1632">        assertThat(task).isNull();</span>
<span class="nc" id="L1633">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L1634">        assertThat(historyService.createHistoricVariableInstanceQuery().list())</span>
<span class="nc" id="L1635">                .extracting(HistoricVariableInstance::getVariableName, HistoricVariableInstance::getValue)</span>
<span class="nc" id="L1636">                .isEmpty();</span>
<span class="nc" id="L1637">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testSequentialEmptyCollection.bpmn20.xml&quot; })
    public void testSequentialEmptyCollection() {
<span class="nc" id="L1642">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L1643">                .processDefinitionKey(&quot;testSequentialEmptyCollection&quot;)</span>
<span class="nc" id="L1644">                .transientVariable(&quot;collection&quot;, Collections.emptyList())</span>
<span class="nc" id="L1645">                .start();</span>
<span class="nc" id="L1646">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L1647">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L1648">        assertThat(task).isNull();</span>
<span class="nc" id="L1649">        assertProcessEnded(processInstance.getId());</span>

<span class="nc bnc" id="L1651" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1652">            assertThat(historyService.createHistoricVariableInstanceQuery().list())</span>
<span class="nc" id="L1653">                    .extracting(HistoricVariableInstance::getVariableName, HistoricVariableInstance::getValue)</span>
<span class="nc" id="L1654">                    .isEmpty();</span>
        }
<span class="nc" id="L1656">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testSequentialEmptyCollection.bpmn20.xml&quot; })
    public void testSequentialEmptyCollectionWithNonEmptyCollection() {
<span class="nc" id="L1661">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L1662">                .processDefinitionKey(&quot;testSequentialEmptyCollection&quot;)</span>
<span class="nc" id="L1663">                .transientVariable(&quot;collection&quot;, Collections.singleton(&quot;Test&quot;))</span>
<span class="nc" id="L1664">                .start();</span>
<span class="nc" id="L1665">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L1666">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L1667">        assertThat(task).isNotNull();</span>
<span class="nc" id="L1668">        assertThat(runtimeService.getVariables(processInstance.getId())).isEmpty();</span>
<span class="nc bnc" id="L1669" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1670">            assertThat(historyService.createHistoricVariableInstanceQuery().list())</span>
<span class="nc" id="L1671">                    .extracting(HistoricVariableInstance::getVariableName, HistoricVariableInstance::getValue)</span>
<span class="nc" id="L1672">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1673">                            tuple(&quot;loopCounter&quot;, 0), // On the child execution</span>
<span class="nc" id="L1674">                            tuple(&quot;nrOfInstances&quot;, 1), // On the MI Root Execution</span>
<span class="nc" id="L1675">                            tuple(&quot;nrOfActiveInstances&quot;, 1), // On the MI Root Execution</span>
<span class="nc" id="L1676">                            tuple(&quot;nrOfCompletedInstances&quot;, 0) // On the MI Root Execution</span>
                    );
        }
<span class="nc" id="L1679">        taskService.complete(task.getId());</span>
<span class="nc" id="L1680">        assertProcessEnded(processInstance.getId());</span>
<span class="nc bnc" id="L1681" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1682">            assertThat(historyService.createHistoricVariableInstanceQuery().list())</span>
<span class="nc" id="L1683">                    .extracting(HistoricVariableInstance::getVariableName, HistoricVariableInstance::getValue)</span>
<span class="nc" id="L1684">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1685">                            tuple(&quot;loopCounter&quot;, 0), // On the child execution</span>
<span class="nc" id="L1686">                            tuple(&quot;nrOfInstances&quot;, 1), // On the MI Root Execution</span>
<span class="nc" id="L1687">                            tuple(&quot;nrOfActiveInstances&quot;, 1), // On the MI Root Execution</span>
<span class="nc" id="L1688">                            tuple(&quot;nrOfCompletedInstances&quot;, 1) // On the MI Root Execution</span>
                    );
        }
<span class="nc" id="L1691">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testParallelEmptyCollection.bpmn20.xml&quot; })
    public void testParalellEmptyCollection() throws Exception {
<span class="nc" id="L1696">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L1697">                .processDefinitionKey(&quot;testParalellEmptyCollection&quot;)</span>
<span class="nc" id="L1698">                .transientVariable(&quot;collection&quot;, Collections.emptyList())</span>
<span class="nc" id="L1699">                .start();</span>
<span class="nc" id="L1700">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L1701">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L1702">        assertThat(task).isNull();</span>
<span class="nc" id="L1703">        assertProcessEnded(processInstance.getId());</span>
<span class="nc bnc" id="L1704" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1705">            assertThat(historyService.createHistoricVariableInstanceQuery().list())</span>
<span class="nc" id="L1706">                    .extracting(HistoricVariableInstance::getVariableName, HistoricVariableInstance::getValue)</span>
<span class="nc" id="L1707">                    .isEmpty();</span>
        }
<span class="nc" id="L1709">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testParallelEmptyCollection.bpmn20.xml&quot; })
    public void testParalellEmptyCollectionWithNonEmptyCollection() {
<span class="nc" id="L1714">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L1715">                .processDefinitionKey(&quot;testParalellEmptyCollection&quot;)</span>
<span class="nc" id="L1716">                .variable(&quot;collection&quot;, Collections.singleton(&quot;Test&quot;))</span>
<span class="nc" id="L1717">                .start();</span>
<span class="nc" id="L1718">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L1719">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L1720">        assertThat(task).isNotNull();</span>
<span class="nc" id="L1721">        assertThat(runtimeService.getVariables(processInstance.getId()))</span>
<span class="nc" id="L1722">                .containsOnly(</span>
<span class="nc" id="L1723">                        entry(&quot;collection&quot;, Collections.singleton(&quot;Test&quot;))</span>
                );
<span class="nc bnc" id="L1725" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1726">            assertThat(historyService.createHistoricVariableInstanceQuery().list())</span>
<span class="nc" id="L1727">                    .extracting(HistoricVariableInstance::getVariableName, HistoricVariableInstance::getValue)</span>
<span class="nc" id="L1728">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1729">                            tuple(&quot;collection&quot;, Collections.singleton(&quot;Test&quot;)),</span>
<span class="nc" id="L1730">                            tuple(&quot;loopCounter&quot;, 0), // On the child execution</span>
<span class="nc" id="L1731">                            tuple(&quot;nrOfInstances&quot;, 1), // On the MI Root Execution</span>
<span class="nc" id="L1732">                            tuple(&quot;nrOfActiveInstances&quot;, 1), // On the MI Root Execution</span>
<span class="nc" id="L1733">                            tuple(&quot;nrOfCompletedInstances&quot;, 0) // On the MI Root Execution</span>
                    );
        }
<span class="nc" id="L1736">        taskService.complete(task.getId());</span>
<span class="nc" id="L1737">        assertProcessEnded(processInstance.getId());</span>
<span class="nc bnc" id="L1738" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1739">            assertThat(historyService.createHistoricVariableInstanceQuery().list())</span>
<span class="nc" id="L1740">                    .extracting(HistoricVariableInstance::getVariableName, HistoricVariableInstance::getValue)</span>
<span class="nc" id="L1741">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1742">                            tuple(&quot;collection&quot;, Collections.singleton(&quot;Test&quot;)), // Process Instance</span>
<span class="nc" id="L1743">                            tuple(&quot;loopCounter&quot;, 0), // On the child execution</span>
<span class="nc" id="L1744">                            tuple(&quot;nrOfInstances&quot;, 1), // On the MI Root Execution</span>
<span class="nc" id="L1745">                            tuple(&quot;nrOfActiveInstances&quot;, 0), // On the MI Root Execution</span>
<span class="nc" id="L1746">                            tuple(&quot;nrOfCompletedInstances&quot;, 1) // On the MI Root Execution</span>
                    );
        }
<span class="nc" id="L1749">    }</span>

    @Test
    @Deployment
    public void testInfiniteLoopWithDelegateExpressionFix() {

        // Add bean temporary to process engine

<span class="nc" id="L1757">        Map&lt;Object, Object&gt; originalBeans = processEngineConfiguration.getExpressionManager().getBeans();</span>

        try {

<span class="nc" id="L1761">            Map&lt;Object, Object&gt; newBeans = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1762">            newBeans.put(&quot;SampleTask&quot;, new TestSampleServiceTask());</span>
<span class="nc" id="L1763">            processEngineConfiguration.getExpressionManager().setBeans(newBeans);</span>

<span class="nc" id="L1765">            Map&lt;String, Object&gt; params = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1766">            params.put(&quot;sampleValues&quot;, Arrays.asList(&quot;eins&quot;, &quot;zwei&quot;, &quot;drei&quot;));</span>
<span class="nc" id="L1767">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;infiniteLoopTest&quot;, params);</span>
<span class="nc" id="L1768">            assertThat(processInstance).isNotNull();</span>

        } finally {

            // Put beans back
<span class="nc" id="L1773">            processEngineConfiguration.getExpressionManager().setBeans(originalBeans);</span>

        }
<span class="nc" id="L1776">    }</span>

    @Test
    @Deployment
    public void testEmptyCollectionOnParallelUserTask() {
<span class="nc bnc" id="L1781" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1782">            ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L1783">                    .processDefinitionKey(&quot;parallelUserTaskMi&quot;)</span>
<span class="nc" id="L1784">                    .transientVariable(&quot;messages&quot;, Collections.emptyList())</span>
<span class="nc" id="L1785">                    .start();</span>

<span class="nc" id="L1787">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>
<span class="nc" id="L1788">            assertThat(historyService.createHistoricProcessInstanceQuery().processInstanceId(processInstance.getId()).finished().count()).isEqualTo(1L);</span>
<span class="nc" id="L1789">            assertThat(historyService.createHistoricVariableInstanceQuery().list())</span>
<span class="nc" id="L1790">                    .extracting(HistoricVariableInstance::getVariableName, HistoricVariableInstance::getValue)</span>
<span class="nc" id="L1791">                    .isEmpty();</span>
        }
<span class="nc" id="L1793">    }</span>

    @Test
    @Deployment
    public void testZeroLoopCardinalityOnParallelUserTask() {
<span class="nc bnc" id="L1798" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1799">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;parallelUserTaskMi&quot;);</span>
            
<span class="nc" id="L1801">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>
<span class="nc" id="L1802">            assertThat(historyService.createHistoricProcessInstanceQuery().processInstanceId(processInstance.getId()).finished().count()).isEqualTo(1L);</span>
        }
<span class="nc" id="L1804">    }</span>

    @Test
    @Deployment
    public void testEmptyCollectionOnSequentialEmbeddedSubprocess() {
<span class="nc bnc" id="L1809" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1810">            runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L1811">                    .processDefinitionKey(&quot;sequentialMiSubprocess&quot;)</span>
<span class="nc" id="L1812">                    .transientVariable(&quot;messages&quot;, Collections.emptyList())</span>
<span class="nc" id="L1813">                    .start();</span>

<span class="nc" id="L1815">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>
<span class="nc" id="L1816">            assertThat(historyService.createHistoricProcessInstanceQuery().finished().count()).isEqualTo(1L);</span>
<span class="nc" id="L1817">            assertThat(historyService.createHistoricVariableInstanceQuery().list())</span>
<span class="nc" id="L1818">                    .extracting(HistoricVariableInstance::getVariableName, HistoricVariableInstance::getValue)</span>
<span class="nc" id="L1819">                    .isEmpty();</span>
        }
<span class="nc" id="L1821">    }</span>

    @Test
    @Deployment
    public void testEmptyCollectionOnParallelEmbeddedSubprocess() {
<span class="nc bnc" id="L1826" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1827">            runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L1828">                    .processDefinitionKey(&quot;parallelMiSubprocess&quot;)</span>
<span class="nc" id="L1829">                    .transientVariable(&quot;messages&quot;, Collections.emptyList())</span>
<span class="nc" id="L1830">                    .start();</span>
            
<span class="nc" id="L1832">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L1834">            assertThat(historyService.createHistoricProcessInstanceQuery().finished().count()).isEqualTo(1L);</span>
<span class="nc" id="L1835">            assertThat(historyService.createHistoricVariableInstanceQuery().list())</span>
<span class="nc" id="L1836">                    .extracting(HistoricVariableInstance::getVariableName, HistoricVariableInstance::getValue)</span>
<span class="nc" id="L1837">                    .isEmpty();</span>
        }
<span class="nc" id="L1839">    }</span>

    @Test
    @Deployment
    public void testExecutionListenersOnMultiInstanceSubprocess() {
<span class="nc" id="L1844">        resetTestCounts();</span>
<span class="nc" id="L1845">        Map&lt;String, Object&gt; variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1846">        List&lt;String&gt; assignees = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1847">        assignees.add(&quot;john&quot;);</span>
<span class="nc" id="L1848">        assignees.add(&quot;jane&quot;);</span>
<span class="nc" id="L1849">        assignees.add(&quot;matt&quot;);</span>
<span class="nc" id="L1850">        variableMap.put(&quot;assignees&quot;, assignees);</span>
<span class="nc" id="L1851">        runtimeService.startProcessInstanceByKey(&quot;MultiInstanceTest&quot;, variableMap);</span>

<span class="nc" id="L1853">        assertThat(TestStartExecutionListener.countWithLoopCounter.get()).isEqualTo(3);</span>
<span class="nc" id="L1854">        assertThat(TestEndExecutionListener.countWithLoopCounter.get()).isEqualTo(3);</span>

<span class="nc" id="L1856">        assertThat(TestStartExecutionListener.countWithoutLoopCounter.get()).isEqualTo(1);</span>
<span class="nc" id="L1857">        assertThat(TestEndExecutionListener.countWithoutLoopCounter.get()).isEqualTo(1);</span>

<span class="nc" id="L1859">        assertThat(TestStartExecutionListener.countWithMultiInstanceRoot.get()).isEqualTo(1);</span>
<span class="nc" id="L1860">        assertThat(TestEndExecutionListener.countWithMultiInstanceRoot.get()).isEqualTo(1);</span>
<span class="nc" id="L1861">    }</span>
    
    @Deployment(resources = {
        &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testExecutionListenersOnMultiInstanceSubprocess.bpmn20.xml&quot; })
    @Test
    public void testDispatchFlowableMultiInstanceActivityCompletedEventLoopVariables() {
<span class="nc" id="L1867">        MultiInstanceUserActivityEventListener testListener = new MultiInstanceUserActivityEventListener();</span>
<span class="nc" id="L1868">        processEngineConfiguration.getEventDispatcher().addEventListener(testListener);</span>
        
        try {
<span class="nc" id="L1871">            Map&lt;String, Object&gt; variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1872">            List&lt;String&gt; assignees = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1873">            assignees.add(&quot;john&quot;);</span>
<span class="nc" id="L1874">            assignees.add(&quot;jane&quot;);</span>
<span class="nc" id="L1875">            assignees.add(&quot;matt&quot;);</span>
<span class="nc" id="L1876">            variableMap.put(&quot;assignees&quot;, assignees);</span>
<span class="nc" id="L1877">            runtimeService.startProcessInstanceByKey(&quot;MultiInstanceTest&quot;, variableMap);</span>
            
<span class="nc" id="L1879">            List&lt;FlowableMultiInstanceActivityCompletedEvent&gt; multiInstanceEvents = testListener.getEventsReceived().stream()</span>
<span class="nc" id="L1880">                    .filter(event -&gt; event instanceof FlowableMultiInstanceActivityCompletedEvent)</span>
<span class="nc" id="L1881">                    .map(event -&gt; (FlowableMultiInstanceActivityCompletedEvent) event).collect(Collectors.toList());</span>
<span class="nc" id="L1882">            assertThat(multiInstanceEvents.size()).isEqualTo(1);</span>
            
<span class="nc" id="L1884">            Integer numberOfActiveInstances = multiInstanceEvents.stream()</span>
<span class="nc" id="L1885">                    .map(FlowableMultiInstanceActivityCompletedEvent::getNumberOfActiveInstances).findFirst().get();</span>
<span class="nc" id="L1886">            Integer numberOfCompletedInstances = multiInstanceEvents.stream()</span>
<span class="nc" id="L1887">                    .map(FlowableMultiInstanceActivityCompletedEvent::getNumberOfCompletedInstances).findFirst().get();</span>
<span class="nc" id="L1888">            Integer numberOfInstances = multiInstanceEvents.stream().map(FlowableMultiInstanceActivityCompletedEvent::getNumberOfInstances)</span>
<span class="nc" id="L1889">                    .findFirst().get();</span>
            
<span class="nc" id="L1891">            assertThat(numberOfActiveInstances).isEqualTo(0);</span>
<span class="nc" id="L1892">            assertThat(numberOfCompletedInstances).isEqualTo(3);</span>
<span class="nc" id="L1893">            assertThat(numberOfInstances).isEqualTo(3);</span>
            
        } finally {
<span class="nc" id="L1896">            testListener.clearEventsReceived();</span>
<span class="nc" id="L1897">            processEngineConfiguration.getEventDispatcher().removeEventListener(testListener);</span>
        }
<span class="nc" id="L1899">    }</span>

    @Test
    @Deployment
    public void testExecutionListenersOnMultiInstanceUserTask() {
<span class="nc" id="L1904">        resetTestCounts();</span>
<span class="nc" id="L1905">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;testExecutionListenersOnMultiInstanceUserTask&quot;);</span>

<span class="nc" id="L1907">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc bnc" id="L1908" title="All 2 branches missed.">        for (org.flowable.task.api.Task task : tasks) {</span>
<span class="nc" id="L1909">            taskService.complete(task.getId());</span>
<span class="nc" id="L1910">        }</span>

<span class="nc" id="L1912">        assertThat(TestTaskCompletionListener.count.get()).isEqualTo(4);</span>

<span class="nc" id="L1914">        assertThat(TestStartExecutionListener.countWithLoopCounter.get()).isEqualTo(4);</span>
<span class="nc" id="L1915">        assertThat(TestEndExecutionListener.countWithLoopCounter.get()).isEqualTo(4);</span>

<span class="nc" id="L1917">        assertThat(TestStartExecutionListener.countWithoutLoopCounter.get()).isEqualTo(1);</span>
<span class="nc" id="L1918">        assertThat(TestEndExecutionListener.countWithoutLoopCounter.get()).isEqualTo(1);</span>

<span class="nc" id="L1920">        assertThat(TestStartExecutionListener.countWithMultiInstanceRoot.get()).isEqualTo(1);</span>
<span class="nc" id="L1921">        assertThat(TestEndExecutionListener.countWithMultiInstanceRoot.get()).isEqualTo(1);</span>
<span class="nc" id="L1922">    }</span>

    @Test
    @Deployment
    public void testParallelAfterSequentialMultiInstance() {

        // Used to throw a nullpointer exception

<span class="nc" id="L1930">        runtimeService.startProcessInstanceByKey(&quot;multiInstance&quot;);</span>
<span class="nc" id="L1931">        assertThat(runtimeService.createExecutionQuery().count()).isZero();</span>
<span class="nc" id="L1932">    }</span>

    @Test
    @Deployment
    public void testEndTimeOnMiSubprocess() {

<span class="nc bnc" id="L1938" title="All 2 branches missed.">        if (!processEngineConfiguration.getHistoryLevel().isAtLeast(HistoryLevel.AUDIT)) {</span>
<span class="nc" id="L1939">            return;</span>
        }

<span class="nc" id="L1942">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;multiInstanceSubProcessParallelTasks&quot;);</span>

<span class="nc" id="L1944">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L1945">        assertThat(tasks)</span>
<span class="nc" id="L1946">                .extracting(Task::getName)</span>
<span class="nc" id="L1947">                .containsExactly(&quot;User Task 1&quot;, &quot;User Task 1&quot;);</span>

<span class="nc" id="L1949">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

        // End time should not be set for the subprocess
<span class="nc" id="L1952">        List&lt;HistoricActivityInstance&gt; historicActivityInstances = historyService.createHistoricActivityInstanceQuery().activityId(&quot;subprocess1&quot;).list();</span>
<span class="nc" id="L1953">        assertThat(historicActivityInstances).hasSize(2);</span>
<span class="nc bnc" id="L1954" title="All 2 branches missed.">        for (HistoricActivityInstance historicActivityInstance : historicActivityInstances) {</span>
<span class="nc" id="L1955">            assertActivityInstancesAreSame(historicActivityInstance, runtimeService.createActivityInstanceQuery().activityInstanceId(historicActivityInstance.getId()).singleResult());</span>
<span class="nc" id="L1956">            assertThat(historicActivityInstance.getStartTime()).isNotNull();</span>
<span class="nc" id="L1957">            assertThat(historicActivityInstance.getEndTime()).isNull();</span>
<span class="nc" id="L1958">        }</span>

        // Complete one of the user tasks. This should not trigger setting of end time of the subprocess, but due to a bug it did exactly that
<span class="nc" id="L1961">        taskService.complete(tasks.get(0).getId());</span>
        
<span class="nc" id="L1963">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>
        
<span class="nc" id="L1965">        historicActivityInstances = historyService.createHistoricActivityInstanceQuery().activityId(&quot;subprocess1&quot;).list();</span>
<span class="nc" id="L1966">        assertThat(historicActivityInstances).hasSize(2);</span>
<span class="nc bnc" id="L1967" title="All 2 branches missed.">        for (HistoricActivityInstance historicActivityInstance : historicActivityInstances) {</span>
<span class="nc" id="L1968">            assertActivityInstancesAreSame(historicActivityInstance, runtimeService.createActivityInstanceQuery().activityInstanceId(historicActivityInstance.getId()).singleResult());</span>
<span class="nc" id="L1969">            assertThat(historicActivityInstance.getEndTime()).isNull();</span>
<span class="nc" id="L1970">        }</span>

<span class="nc" id="L1972">        taskService.complete(tasks.get(1).getId());</span>
        
<span class="nc" id="L1974">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>
        
<span class="nc" id="L1976">        historicActivityInstances = historyService.createHistoricActivityInstanceQuery().activityId(&quot;subprocess1&quot;).list();</span>
<span class="nc" id="L1977">        assertThat(historicActivityInstances).hasSize(2);</span>
<span class="nc bnc" id="L1978" title="All 2 branches missed.">        for (HistoricActivityInstance historicActivityInstance : historicActivityInstances) {</span>
<span class="nc" id="L1979">            assertActivityInstancesAreSame(historicActivityInstance, runtimeService.createActivityInstanceQuery().activityInstanceId(historicActivityInstance.getId()).singleResult());</span>
<span class="nc" id="L1980">            assertThat(historicActivityInstance.getEndTime()).isNull();</span>
<span class="nc" id="L1981">        }</span>

<span class="nc" id="L1983">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskName(&quot;User Task 3&quot;).list();</span>
<span class="nc" id="L1984">        assertThat(tasks).hasSize(2);</span>
<span class="nc bnc" id="L1985" title="All 2 branches missed.">        for (org.flowable.task.api.Task task : tasks) {</span>
<span class="nc" id="L1986">            taskService.complete(task.getId());</span>
            
<span class="nc" id="L1988">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>
            
<span class="nc" id="L1990">            historicActivityInstances = historyService.createHistoricActivityInstanceQuery().activityId(&quot;subprocess1&quot;).list();</span>
<span class="nc" id="L1991">            assertThat(historicActivityInstances).hasSize(2);</span>
<span class="nc bnc" id="L1992" title="All 2 branches missed.">            for (HistoricActivityInstance historicActivityInstance : historicActivityInstances) {</span>
<span class="nc" id="L1993">                assertActivityInstancesAreSame(historicActivityInstance, runtimeService.createActivityInstanceQuery().activityInstanceId(historicActivityInstance.getId()).singleResult());</span>
<span class="nc" id="L1994">                assertThat(historicActivityInstance.getEndTime()).isNull();</span>
<span class="nc" id="L1995">            }</span>
<span class="nc" id="L1996">        }</span>

        // Finishing the tasks should also set the end time
<span class="nc" id="L1999">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2000">        assertThat(tasks).hasSize(2);</span>
<span class="nc bnc" id="L2001" title="All 2 branches missed.">        for (org.flowable.task.api.Task task : tasks) {</span>
<span class="nc" id="L2002">            taskService.complete(task.getId());</span>
<span class="nc" id="L2003">        }</span>
        
<span class="nc" id="L2005">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L2007">        historicActivityInstances = historyService.createHistoricActivityInstanceQuery().activityId(&quot;subprocess1&quot;).list();</span>
<span class="nc" id="L2008">        assertThat(historicActivityInstances).hasSize(2);</span>
<span class="nc bnc" id="L2009" title="All 2 branches missed.">        for (HistoricActivityInstance historicActivityInstance : historicActivityInstances) {</span>
<span class="nc" id="L2010">            assertThat(historicActivityInstance.getEndTime()).isNotNull();</span>
<span class="nc" id="L2011">        }</span>
<span class="nc" id="L2012">    }</span>

    @Test
    @Deployment
    public void testChangingCollection() {
<span class="nc" id="L2017">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2018">        vars.put(&quot;multi_users&quot;, Collections.singletonList(&quot;testuser&quot;));</span>
<span class="nc" id="L2019">        ProcessInstance instance = runtimeService.startProcessInstanceByKey(&quot;test_multi&quot;, vars);</span>
<span class="nc" id="L2020">        assertThat(instance).isNotNull();</span>
<span class="nc" id="L2021">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L2022">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;multi&quot;);</span>
<span class="nc" id="L2023">        vars.put(&quot;multi_users&quot;, new ArrayList&lt;String&gt;()); // &lt;-- Problem here.</span>
<span class="nc" id="L2024">        taskService.complete(task.getId(), vars);</span>
<span class="nc" id="L2025">        List&lt;ProcessInstance&gt; instances = runtimeService.createProcessInstanceQuery().list();</span>
<span class="nc" id="L2026">        assertThat(instances).isEmpty();</span>
<span class="nc" id="L2027">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.simpleMultiInstanceWithCollectionVariable.bpmn20.xml&quot;)
    public void testCollectionVariableMissing() {
<span class="nc" id="L2032">        assertThatThrownBy(() -&gt; runtimeService.startProcessInstanceByKey(&quot;simple_multi&quot;))</span>
<span class="nc" id="L2033">                .as(&quot;Should have failed with missing collection variable&quot;)</span>
<span class="nc" id="L2034">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L2035">                .hasMessage(&quot;Variable 'elements' was not found&quot;);</span>
<span class="nc" id="L2036">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.simpleMultiInstanceWithCollectionVariable.bpmn20.xml&quot;)
    public void testCollectionVariableIsNotACollection() {
<span class="nc" id="L2041">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2042">        ValueBean valueBean = new ValueBean(&quot;test&quot;);</span>
<span class="nc" id="L2043">        vars.put(&quot;elements&quot;, valueBean);</span>
<span class="nc" id="L2044">        assertThatThrownBy(() -&gt; runtimeService.startProcessInstanceByKey(&quot;simple_multi&quot;, vars))</span>
<span class="nc" id="L2045">                .as(&quot;Should have failed with collection variable not a collection&quot;)</span>
<span class="nc" id="L2046">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L2047">                .hasMessage(&quot;Variable 'elements':&quot; + valueBean + &quot; is not a Collection&quot;);</span>
<span class="nc" id="L2048">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testZeroLoopCardinalityOnParallelUserTaskWithEventSubscription.bpmn20.xml&quot; })
    public void testZeroLoopCardinalityOnParallelUserTaskWithEventSubscription() {
<span class="nc" id="L2053">        String procId = runtimeService.startProcessInstanceByKey(&quot;parallelUserTaskMi_withEventSubscription&quot;).getId();</span>
<span class="nc" id="L2054">        assertProcessEnded(procId);</span>
<span class="nc" id="L2055">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testZeroLoopCardinalityOnParallelSubprocessWithEventSubscription.bpmn20.xml&quot; })
    public void testZeroLoopCardinalityOnParallelSubprocessWithEventSubscription() {
<span class="nc" id="L2060">        String procId = runtimeService.startProcessInstanceByKey(&quot;parallelSubprocessMi_withEventSubscription&quot;).getId();</span>
<span class="nc" id="L2061">        assertProcessEnded(procId);</span>
<span class="nc" id="L2062">    }</span>

    @Test
    @Deployment
    public void testLoopCounterVariableForSequentialMultiInstance() {
<span class="nc" id="L2067">        List&lt;String&gt; myCollection = Arrays.asList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;);</span>
<span class="nc" id="L2068">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L2069">            .variable(&quot;myCollection&quot;, myCollection)</span>
<span class="nc" id="L2070">            .processDefinitionKey(&quot;loopCounterTest&quot;)</span>
<span class="nc" id="L2071">            .start();</span>

<span class="nc bnc" id="L2073" title="All 2 branches missed.">        for (int i = 0; i &lt; myCollection.size(); i++) {</span>
<span class="nc" id="L2074">            Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

<span class="nc" id="L2076">            Integer loopCounter = (Integer) runtimeService.getVariableLocal(task.getExecutionId(), &quot;loopCounter&quot;);</span>
<span class="nc" id="L2077">            assertThat(loopCounter).isEqualTo(i);</span>

<span class="nc" id="L2079">            String myElement = (String) runtimeService.getVariableLocal(task.getExecutionId(), &quot;myElement&quot;);</span>
<span class="nc" id="L2080">            assertThat(myElement).isEqualTo(myCollection.get(i));</span>

<span class="nc" id="L2082">            taskService.complete(task.getId());</span>
        }
<span class="nc" id="L2084">    }</span>

    @Test
    @Deployment
    public void testLoopCounterVariableForParallelMultiInstance() {
<span class="nc" id="L2089">        List&lt;String&gt; myCollection = Arrays.asList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;);</span>
<span class="nc" id="L2090">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L2091">            .variable(&quot;myCollection&quot;, myCollection)</span>
<span class="nc" id="L2092">            .processDefinitionKey(&quot;loopCounterTest&quot;)</span>
<span class="nc" id="L2093">            .start();</span>

<span class="nc" id="L2095">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2096">        assertThat(tasks).hasSize(4);</span>

<span class="nc" id="L2098">        List&lt;Integer&gt; loopCounters = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2099" title="All 2 branches missed.">        for (Task task : tasks) {</span>
<span class="nc" id="L2100">            loopCounters.add((Integer) runtimeService.getVariableLocal(task.getExecutionId(), &quot;loopCounter&quot;));</span>

<span class="nc" id="L2102">            String myElement = (String) runtimeService.getVariableLocal(task.getExecutionId(), &quot;myElement&quot;);</span>
<span class="nc" id="L2103">            assertThat(myElement).isNotNull();</span>
<span class="nc" id="L2104">        }</span>

<span class="nc" id="L2106">        assertThat(loopCounters).containsOnly(0, 1 , 2, 3);</span>
<span class="nc" id="L2107">    }</span>

    @Test
    @Deployment(resources = {
        &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot;,
        &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testMapLoopCounterIntoAsyncParallelMultiInstanceCallActivity.bpmn20.xml&quot;
    })
    public void testMapLoopCounterIntoAsyncParallelMultiInstanceCallActivity() {
<span class="nc" id="L2115">        List&lt;String&gt; myCollection = Arrays.asList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;);</span>
<span class="nc" id="L2116">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L2117">            .variable(&quot;myCollection&quot;, myCollection)</span>
<span class="nc" id="L2118">            .processDefinitionKey(&quot;loopCounterTest&quot;)</span>
<span class="nc" id="L2119">            .start();</span>

<span class="nc" id="L2121">        List&lt;Job&gt; jobs = managementService.createJobQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2122">        assertThat(jobs).hasSameSizeAs(myCollection);</span>
<span class="nc bnc" id="L2123" title="All 2 branches missed.">        for (Job job : jobs) {</span>
<span class="nc" id="L2124">            managementService.executeJob(job.getId());</span>
<span class="nc" id="L2125">        }</span>

<span class="nc" id="L2127">        List&lt;ProcessInstance&gt; processInstances = runtimeService.createProcessInstanceQuery().superProcessInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2128">        assertThat(processInstances).hasSameSizeAs(myCollection);</span>

<span class="nc" id="L2130">        List&lt;Integer&gt; loopCounters = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2131" title="All 2 branches missed.">        for (ProcessInstance instance : processInstances) {</span>
<span class="nc" id="L2132">            loopCounters.add(((Integer) runtimeService.getVariable(instance.getId(), &quot;copiedLoopCounter&quot;)));</span>
<span class="nc" id="L2133">        }</span>
<span class="nc" id="L2134">        assertThat(loopCounters).containsOnly(0, 1 , 2, 3);</span>
<span class="nc" id="L2135">    }</span>

    @Test
    @Deployment(resources = {
        &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot;,
        &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testMapLoopCounterIntoAsyncSequentialMultiInstanceCallActivity.bpmn20.xml&quot;
    })
    public void testMapLoopCounterIntoAsyncSequentialMultiInstanceCallActivity() {
<span class="nc" id="L2143">        List&lt;String&gt; myCollection = Arrays.asList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;);</span>
<span class="nc" id="L2144">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L2145">            .variable(&quot;myCollection&quot;, myCollection)</span>
<span class="nc" id="L2146">            .processDefinitionKey(&quot;loopCounterTest&quot;)</span>
<span class="nc" id="L2147">            .start();</span>

<span class="nc bnc" id="L2149" title="All 2 branches missed.">        for (int i = 0; i &lt; myCollection.size(); i++) {</span>
<span class="nc" id="L2150">            Job job = managementService.createJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2151">            managementService.executeJob(job.getId());</span>

<span class="nc" id="L2153">            ProcessInstance calledProcessInstance = runtimeService.createProcessInstanceQuery().superProcessInstanceId(processInstance.getId()).singleResult();</span>

<span class="nc" id="L2155">            Integer copiedLoopCounter = (Integer) runtimeService.getVariable(calledProcessInstance.getId(), &quot;copiedLoopCounter&quot;);</span>
<span class="nc" id="L2156">            assertThat(i).isEqualTo(copiedLoopCounter);</span>

<span class="nc" id="L2158">            Task task = taskService.createTaskQuery().processInstanceId(calledProcessInstance.getId()).singleResult();</span>
<span class="nc" id="L2159">            taskService.complete(task.getId());</span>
        }
<span class="nc" id="L2161">    }</span>

    @Test
    @Deployment
    public void testMultiInstanceSubprocessWithoutInnerEndEvent() {
<span class="nc" id="L2166">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L2167">                .processDefinitionKey(&quot;testMi&quot;)</span>
<span class="nc" id="L2168">                .variable(&quot;iterations&quot;, 15)</span>
<span class="nc" id="L2169">                .variable(&quot;counter&quot;, 0)</span>
<span class="nc" id="L2170">                .start();</span>

        // The service task should have been executed 15 times
<span class="nc" id="L2173">        assertThat(((Number) runtimeService.getVariable(processInstance.getId(), &quot;counter&quot;)).intValue()).isEqualTo(15);</span>
<span class="nc" id="L2174">    }</span>

    @Test
    @Deployment
    public void testMultipleMultiInstanceSubprocessWithoutInnerEndEvent() {
<span class="nc" id="L2179">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L2180">                .processDefinitionKey(&quot;testMi&quot;)</span>
<span class="nc" id="L2181">                .variable(&quot;iterations&quot;, 5)</span>
<span class="nc" id="L2182">                .variable(&quot;counter&quot;, 0)</span>
<span class="nc" id="L2183">                .start();</span>

        // The service task should have been executed 5 x 4 times
<span class="nc" id="L2186">        assertThat(((Number) runtimeService.getVariable(processInstance.getId(), &quot;counter&quot;)).intValue()).isEqualTo(20);</span>
<span class="nc" id="L2187">    }</span>

    @Test
    @Deployment
    public void testLoopVariablesWithSubprocessWhenProcessIsDeleted() {
<span class="nc" id="L2192">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L2193">                .processDefinitionKey(&quot;ModelWithSubProcess&quot;)</span>
<span class="nc" id="L2194">                .start();</span>

<span class="nc bnc" id="L2196" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2197">            assertThat(historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L2198">                    .list())</span>
<span class="nc" id="L2199">                    .extracting(HistoricVariableInstance::getVariableName, HistoricVariableInstance::getVariableTypeName, HistoricVariableInstance::getValue)</span>
<span class="nc" id="L2200">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2201">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 0),</span>
<span class="nc" id="L2202">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 1),</span>
<span class="nc" id="L2203">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 2),</span>
<span class="nc" id="L2204">                            tuple(&quot;nrOfInstances&quot;, &quot;integer&quot;, 3),</span>
<span class="nc" id="L2205">                            tuple(&quot;nrOfActiveInstances&quot;, &quot;bpmnParallelMultiInstanceCompleted&quot;, 3),</span>
<span class="nc" id="L2206">                            tuple(&quot;nrOfCompletedInstances&quot;, &quot;bpmnParallelMultiInstanceCompleted&quot;, 0)</span>
                    );
        }

<span class="nc" id="L2210">        runtimeService.deleteProcessInstance(processInstance.getProcessInstanceId(), &quot;For test&quot;);</span>

<span class="nc bnc" id="L2212" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2213">            assertThat(historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L2214">                    .list())</span>
<span class="nc" id="L2215">                    .extracting(HistoricVariableInstance::getVariableName, HistoricVariableInstance::getVariableTypeName, HistoricVariableInstance::getValue)</span>
<span class="nc" id="L2216">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2217">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 0),</span>
<span class="nc" id="L2218">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 1),</span>
<span class="nc" id="L2219">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 2),</span>
<span class="nc" id="L2220">                            tuple(&quot;nrOfInstances&quot;, &quot;integer&quot;, 3),</span>
<span class="nc" id="L2221">                            tuple(&quot;nrOfActiveInstances&quot;, &quot;integer&quot;, 3),</span>
<span class="nc" id="L2222">                            tuple(&quot;nrOfCompletedInstances&quot;, &quot;integer&quot;, 0)</span>
                    );
        }
<span class="nc" id="L2225">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.testLoopVariablesWithSubprocessWhenProcessIsDeleted.bpmn20.xml&quot;)
    public void testLoopVariablesWithSubprocessWhenProcessIsDeletedAndHasSomeCompletedInstances() {
<span class="nc" id="L2230">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L2231">                .processDefinitionKey(&quot;ModelWithSubProcess&quot;)</span>
<span class="nc" id="L2232">                .start();</span>

<span class="nc bnc" id="L2234" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2235">            assertThat(historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L2236">                    .list())</span>
<span class="nc" id="L2237">                    .extracting(HistoricVariableInstance::getVariableName, HistoricVariableInstance::getVariableTypeName, HistoricVariableInstance::getValue)</span>
<span class="nc" id="L2238">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2239">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 0),</span>
<span class="nc" id="L2240">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 1),</span>
<span class="nc" id="L2241">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 2),</span>
<span class="nc" id="L2242">                            tuple(&quot;nrOfInstances&quot;, &quot;integer&quot;, 3),</span>
<span class="nc" id="L2243">                            tuple(&quot;nrOfActiveInstances&quot;, &quot;bpmnParallelMultiInstanceCompleted&quot;, 3),</span>
<span class="nc" id="L2244">                            tuple(&quot;nrOfCompletedInstances&quot;, &quot;bpmnParallelMultiInstanceCompleted&quot;, 0)</span>
                    );
        }

<span class="nc" id="L2248">        Task task = taskService.createTaskQuery().taskName(&quot;Task #1&quot;).singleResult();</span>
<span class="nc" id="L2249">        assertThat(task).isNotNull();</span>
<span class="nc" id="L2250">        taskService.complete(task.getId());</span>

<span class="nc bnc" id="L2252" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2253">            assertThat(historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L2254">                    .list())</span>
<span class="nc" id="L2255">                    .extracting(HistoricVariableInstance::getVariableName, HistoricVariableInstance::getVariableTypeName, HistoricVariableInstance::getValue)</span>
<span class="nc" id="L2256">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2257">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 0),</span>
<span class="nc" id="L2258">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 1),</span>
<span class="nc" id="L2259">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 2),</span>
<span class="nc" id="L2260">                            tuple(&quot;nrOfInstances&quot;, &quot;integer&quot;, 3),</span>
<span class="nc" id="L2261">                            tuple(&quot;nrOfActiveInstances&quot;, &quot;bpmnParallelMultiInstanceCompleted&quot;, 2),</span>
<span class="nc" id="L2262">                            tuple(&quot;nrOfCompletedInstances&quot;, &quot;bpmnParallelMultiInstanceCompleted&quot;, 1)</span>
                    );
        }

<span class="nc" id="L2266">        runtimeService.deleteProcessInstance(processInstance.getProcessInstanceId(), &quot;For test&quot;);</span>

<span class="nc bnc" id="L2268" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2269">            assertThat(historyService.createHistoricVariableInstanceQuery().list())</span>
<span class="nc" id="L2270">                    .extracting(HistoricVariableInstance::getVariableName, HistoricVariableInstance::getVariableTypeName, HistoricVariableInstance::getValue)</span>
<span class="nc" id="L2271">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2272">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 0),</span>
<span class="nc" id="L2273">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 1),</span>
<span class="nc" id="L2274">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 2),</span>
<span class="nc" id="L2275">                            tuple(&quot;nrOfInstances&quot;, &quot;integer&quot;, 3),</span>
<span class="nc" id="L2276">                            tuple(&quot;nrOfActiveInstances&quot;, &quot;integer&quot;, 2),</span>
<span class="nc" id="L2277">                            tuple(&quot;nrOfCompletedInstances&quot;, &quot;integer&quot;, 1)</span>
                    );
        }
<span class="nc" id="L2280">    }</span>

    @Test
    @Deployment
    public void testLoopVariablesWithBoundaryOnSubprocess() {
<span class="nc" id="L2285">        runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L2286">                .processDefinitionKey(&quot;ModelWithSubProcess&quot;)</span>
<span class="nc" id="L2287">                .start();</span>

<span class="nc bnc" id="L2289" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2290">            assertThat(historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L2291">                    .list())</span>
<span class="nc" id="L2292">                    .extracting(HistoricVariableInstance::getVariableName, HistoricVariableInstance::getVariableTypeName, HistoricVariableInstance::getValue)</span>
<span class="nc" id="L2293">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2294">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 0),</span>
<span class="nc" id="L2295">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 1),</span>
<span class="nc" id="L2296">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 2),</span>
<span class="nc" id="L2297">                            tuple(&quot;nrOfInstances&quot;, &quot;integer&quot;, 3),</span>
<span class="nc" id="L2298">                            tuple(&quot;nrOfActiveInstances&quot;, &quot;bpmnParallelMultiInstanceCompleted&quot;, 3),</span>
<span class="nc" id="L2299">                            tuple(&quot;nrOfCompletedInstances&quot;, &quot;bpmnParallelMultiInstanceCompleted&quot;, 0)</span>
                    );
        }

<span class="nc" id="L2303">        Task task = taskService.createTaskQuery().taskName(&quot;Task #1&quot;).singleResult();</span>
<span class="nc" id="L2304">        assertThat(task).isNotNull();</span>
<span class="nc" id="L2305">        taskService.complete(task.getId());</span>

<span class="nc bnc" id="L2307" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L2308">            assertThat(historyService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L2309">                    .list())</span>
<span class="nc" id="L2310">                    .extracting(HistoricVariableInstance::getVariableName, HistoricVariableInstance::getVariableTypeName, HistoricVariableInstance::getValue)</span>
<span class="nc" id="L2311">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2312">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 0),</span>
<span class="nc" id="L2313">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 1),</span>
<span class="nc" id="L2314">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 2),</span>
<span class="nc" id="L2315">                            tuple(&quot;nrOfInstances&quot;, &quot;integer&quot;, 3),</span>
<span class="nc" id="L2316">                            tuple(&quot;nrOfActiveInstances&quot;, &quot;bpmnParallelMultiInstanceCompleted&quot;, 2),</span>
<span class="nc" id="L2317">                            tuple(&quot;nrOfCompletedInstances&quot;, &quot;bpmnParallelMultiInstanceCompleted&quot;, 1)</span>
                    );
        }

<span class="nc" id="L2321">        runtimeService.signalEventReceived(&quot;cancelSubProcess&quot;);</span>

<span class="nc" id="L2323">        task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L2324">        assertThat(task).isNotNull();</span>
<span class="nc" id="L2325">        assertThat(task.getName()).isEqualTo(&quot;Cancelled Sub Process&quot;);</span>

<span class="nc bnc" id="L2327" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L2328">            assertThat(historyService.createHistoricVariableInstanceQuery().list())</span>
<span class="nc" id="L2329">                    .extracting(HistoricVariableInstance::getVariableName, HistoricVariableInstance::getVariableTypeName, HistoricVariableInstance::getValue)</span>
<span class="nc" id="L2330">                    .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2331">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 0),</span>
<span class="nc" id="L2332">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 1),</span>
<span class="nc" id="L2333">                            tuple(&quot;loopCounter&quot;, &quot;integer&quot;, 2),</span>
<span class="nc" id="L2334">                            tuple(&quot;nrOfInstances&quot;, &quot;integer&quot;, 3),</span>
<span class="nc" id="L2335">                            tuple(&quot;nrOfActiveInstances&quot;, &quot;integer&quot;, 2),</span>
<span class="nc" id="L2336">                            tuple(&quot;nrOfCompletedInstances&quot;, &quot;integer&quot;, 1)</span>
                    );
        }
<span class="nc" id="L2339">    }</span>

    protected void resetTestCounts() {
<span class="nc" id="L2342">        TestStartExecutionListener.countWithMultiInstanceRoot.set(0);</span>
<span class="nc" id="L2343">        TestStartExecutionListener.countWithLoopCounter.set(0);</span>
<span class="nc" id="L2344">        TestStartExecutionListener.countWithoutLoopCounter.set(0);</span>
<span class="nc" id="L2345">        TestEndExecutionListener.countWithMultiInstanceRoot.set(0);</span>
<span class="nc" id="L2346">        TestEndExecutionListener.countWithLoopCounter.set(0);</span>
<span class="nc" id="L2347">        TestEndExecutionListener.countWithoutLoopCounter.set(0);</span>
<span class="nc" id="L2348">        TestTaskCompletionListener.count.set(0);</span>
<span class="nc" id="L2349">    }</span>

<span class="nc" id="L2351">    public static class TestStartExecutionListener implements ExecutionListener {</span>

<span class="nc" id="L2353">        public static AtomicInteger countWithMultiInstanceRoot = new AtomicInteger(0);</span>
<span class="nc" id="L2354">        public static AtomicInteger countWithLoopCounter = new AtomicInteger(0);</span>
<span class="nc" id="L2355">        public static AtomicInteger countWithoutLoopCounter = new AtomicInteger(0);</span>

        @Override
        public void notify(DelegateExecution execution) {
<span class="nc" id="L2359">            Integer loopCounter = (Integer) execution.getVariable(&quot;loopCounter&quot;);</span>
<span class="nc bnc" id="L2360" title="All 2 branches missed.">            if (execution.isMultiInstanceRoot()) {</span>
<span class="nc" id="L2361">                countWithMultiInstanceRoot.incrementAndGet();</span>
            }
<span class="nc bnc" id="L2363" title="All 2 branches missed.">            if (loopCounter != null) {</span>
<span class="nc" id="L2364">                countWithLoopCounter.incrementAndGet();</span>
            } else {
<span class="nc" id="L2366">                countWithoutLoopCounter.incrementAndGet();</span>
            }
<span class="nc" id="L2368">        }</span>

    }

<span class="nc" id="L2372">    public static class TestEndExecutionListener implements ExecutionListener {</span>

<span class="nc" id="L2374">        public static AtomicInteger countWithMultiInstanceRoot = new AtomicInteger(0);</span>
<span class="nc" id="L2375">        public static AtomicInteger countWithLoopCounter = new AtomicInteger(0);</span>
<span class="nc" id="L2376">        public static AtomicInteger countWithoutLoopCounter = new AtomicInteger(0);</span>

        @Override
        public void notify(DelegateExecution execution) {
<span class="nc" id="L2380">            Integer loopCounter = (Integer) execution.getVariable(&quot;loopCounter&quot;);</span>
<span class="nc bnc" id="L2381" title="All 2 branches missed.">            if (execution.isMultiInstanceRoot()) {</span>
<span class="nc" id="L2382">                countWithMultiInstanceRoot.incrementAndGet();</span>
            }
<span class="nc bnc" id="L2384" title="All 2 branches missed.">            if (loopCounter != null) {</span>
<span class="nc" id="L2385">                countWithLoopCounter.incrementAndGet();</span>
            } else {
<span class="nc" id="L2387">                countWithoutLoopCounter.incrementAndGet();</span>
            }
<span class="nc" id="L2389">        }</span>

    }

<span class="nc" id="L2393">    public static class TestTaskCompletionListener implements TaskListener {</span>

<span class="nc" id="L2395">        public static AtomicInteger count = new AtomicInteger(0);</span>

        @Override
        public void notify(DelegateTask delegateTask) {
<span class="nc" id="L2399">            count.incrementAndGet();</span>
<span class="nc" id="L2400">        }</span>

    }
    
    class MultiInstanceUserActivityEventListener extends AbstractFlowableEngineEventListener {

        private List&lt;FlowableEvent&gt; eventsReceived;

<span class="nc" id="L2408">        public MultiInstanceUserActivityEventListener() {</span>
<span class="nc" id="L2409">            super(new HashSet&lt;&gt;(Arrays.asList(</span>
                    FlowableEngineEventType.ACTIVITY_STARTED,
                    FlowableEngineEventType.ACTIVITY_COMPLETED,
                    FlowableEngineEventType.ACTIVITY_CANCELLED,
                    FlowableEngineEventType.MULTI_INSTANCE_ACTIVITY_STARTED,
                    FlowableEngineEventType.MULTI_INSTANCE_ACTIVITY_COMPLETED,
                    FlowableEngineEventType.MULTI_INSTANCE_ACTIVITY_COMPLETED_WITH_CONDITION,
                    FlowableEngineEventType.MULTI_INSTANCE_ACTIVITY_CANCELLED,
                    FlowableEngineEventType.TASK_CREATED,
                    FlowableEngineEventType.TASK_COMPLETED,
                    FlowableEngineEventType.PROCESS_STARTED,
                    FlowableEngineEventType.PROCESS_COMPLETED,
                    FlowableEngineEventType.PROCESS_CANCELLED,
                    FlowableEngineEventType.PROCESS_COMPLETED_WITH_TERMINATE_END_EVENT
            )));
<span class="nc" id="L2424">            eventsReceived = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2425">        }</span>

        public List&lt;FlowableEvent&gt; getEventsReceived() {
<span class="nc" id="L2428">            return eventsReceived;</span>
        }

        public void clearEventsReceived() {
<span class="nc" id="L2432">            eventsReceived.clear();</span>
<span class="nc" id="L2433">        }</span>

        @Override
        protected void activityStarted(FlowableActivityEvent event) {
<span class="nc" id="L2437">            eventsReceived.add(event);</span>
<span class="nc" id="L2438">        }</span>

        @Override
        protected void activityCompleted(FlowableActivityEvent event) {
<span class="nc" id="L2442">            eventsReceived.add(event);</span>
<span class="nc" id="L2443">        }</span>

        @Override
        protected void activityCancelled(FlowableActivityCancelledEvent event) {
<span class="nc" id="L2447">            eventsReceived.add(event);</span>
<span class="nc" id="L2448">        }</span>

        @Override
        protected void taskCreated(FlowableEngineEntityEvent event) {
<span class="nc" id="L2452">            eventsReceived.add(event);</span>
<span class="nc" id="L2453">        }</span>

        @Override
        protected void taskCompleted(FlowableEngineEntityEvent event) {
<span class="nc" id="L2457">            eventsReceived.add(event);</span>
<span class="nc" id="L2458">        }</span>

        @Override
        protected void processStarted(FlowableProcessStartedEvent event) {
<span class="nc" id="L2462">            eventsReceived.add(event);</span>
<span class="nc" id="L2463">        }</span>

        @Override
        protected void processCompleted(FlowableEngineEntityEvent event) {
<span class="nc" id="L2467">            eventsReceived.add(event);</span>
<span class="nc" id="L2468">        }</span>

        @Override
        protected void processCompletedWithTerminateEnd(FlowableEngineEntityEvent event) {
<span class="nc" id="L2472">            eventsReceived.add(event);</span>
<span class="nc" id="L2473">        }</span>

        @Override
        protected void processCancelled(FlowableCancelledEvent event) {
<span class="nc" id="L2477">            eventsReceived.add(event);</span>
<span class="nc" id="L2478">        }</span>

        @Override
        protected void multiInstanceActivityStarted(FlowableMultiInstanceActivityEvent event) {
<span class="nc" id="L2482">            eventsReceived.add(event);</span>
<span class="nc" id="L2483">        }</span>

        @Override
        protected void multiInstanceActivityCompleted(FlowableMultiInstanceActivityCompletedEvent event) {
<span class="nc" id="L2487">            eventsReceived.add(event);</span>
<span class="nc" id="L2488">        }</span>

        @Override
        protected void multiInstanceActivityCompletedWithCondition(FlowableMultiInstanceActivityCompletedEvent event) {
<span class="nc" id="L2492">            eventsReceived.add(event);</span>
<span class="nc" id="L2493">        }</span>

        @Override
        protected void multiInstanceActivityCancelled(FlowableMultiInstanceActivityCancelledEvent event) {
<span class="nc" id="L2497">            eventsReceived.add(event);</span>
<span class="nc" id="L2498">        }</span>

        @Override
        public boolean isFailOnException() {
<span class="nc" id="L2502">            return false;</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>