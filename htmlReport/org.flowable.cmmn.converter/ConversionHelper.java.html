<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConversionHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.cmmn.converter</a> &gt; <span class="el_source">ConversionHelper.java</span></div><h1>ConversionHelper.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.cmmn.converter;

import static org.flowable.cmmn.converter.util.CriterionUtil.generateEntryCriterionId;
import static org.flowable.cmmn.converter.util.CriterionUtil.generateExitCriterionId;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.ListIterator;
import java.util.Map;
import java.util.Optional;

import org.apache.commons.lang3.StringUtils;
import org.flowable.cmmn.model.Case;
import org.flowable.cmmn.model.CaseElement;
import org.flowable.cmmn.model.CmmnDiEdge;
import org.flowable.cmmn.model.CmmnDiShape;
import org.flowable.cmmn.model.CmmnElement;
import org.flowable.cmmn.model.CmmnModel;
import org.flowable.cmmn.model.Criterion;
import org.flowable.cmmn.model.GraphicInfo;
import org.flowable.cmmn.model.HasEntryCriteria;
import org.flowable.cmmn.model.HasExitCriteria;
import org.flowable.cmmn.model.PlanFragment;
import org.flowable.cmmn.model.PlanItem;
import org.flowable.cmmn.model.PlanItemDefinition;
import org.flowable.cmmn.model.Sentry;
import org.flowable.cmmn.model.SentryIfPart;
import org.flowable.cmmn.model.SentryOnPart;
import org.flowable.cmmn.model.Stage;
import org.flowable.common.engine.api.FlowableException;

/**
 * @author Joram Barrez
 */
<span class="nc" id="L49">public class ConversionHelper {</span>

    protected CmmnModel cmmnModel;
    protected Case currentCase;
<span class="nc" id="L53">    protected LinkedList&lt;CmmnElement&gt; currentCmmnElements = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L54">    protected LinkedList&lt;PlanFragment&gt; planFragmentsStack = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L55">    protected LinkedList&lt;Stage&gt; stagesStack = new LinkedList&lt;&gt;();</span>
    protected Sentry currentSentry;
    protected SentryOnPart currentSentryOnPart;
    protected PlanItem currentPlanItem;
    protected CmmnDiShape currentDiShape;
    protected CmmnDiEdge currentDiEdge;
    protected GraphicInfo currentLabelGraphicInfo;

<span class="nc" id="L63">    protected Map&lt;Case, List&lt;CaseElement&gt;&gt; caseElements = new HashMap&lt;&gt;();</span>
<span class="nc" id="L64">    protected List&lt;Stage&gt; stages = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L65">    protected List&lt;PlanFragment&gt; planFragments = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L66">    protected List&lt;Criterion&gt; entryCriteria = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L67">    protected List&lt;Criterion&gt; exitCriteria = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L68">    protected List&lt;Sentry&gt; sentries = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L69">    protected List&lt;SentryOnPart&gt; sentryOnParts = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L70">    protected List&lt;SentryIfPart&gt; sentryIfParts = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L71">    protected List&lt;PlanItem&gt; planItems = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L72">    protected List&lt;PlanItemDefinition&gt; planItemDefinitions = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L74">    protected List&lt;CmmnDiShape&gt; diShapes = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L75">    protected List&lt;CmmnDiEdge&gt; diEdges = new ArrayList&lt;&gt;();</span>

    public void addCaseElement(CaseElement caseElement) {
<span class="nc bnc" id="L78" title="All 2 branches missed.">        if (!caseElements.containsKey(currentCase)) {</span>
<span class="nc" id="L79">            caseElements.put(currentCase, new ArrayList&lt;&gt;());</span>
        }
<span class="nc" id="L81">        caseElements.get(currentCase).add(caseElement);</span>
<span class="nc" id="L82">    }</span>

    public Map&lt;Case, List&lt;CaseElement&gt;&gt; getCaseElements() {
<span class="nc" id="L85">        return caseElements;</span>
    }

    public void setCaseElements(Map&lt;Case, List&lt;CaseElement&gt;&gt; caseElements) {
<span class="nc" id="L89">        this.caseElements = caseElements;</span>
<span class="nc" id="L90">    }</span>

    public void addStage(Stage stage) {
<span class="nc" id="L93">        stages.add(stage);</span>
<span class="nc" id="L94">    }</span>

    public void addPlanFragment(PlanFragment planFragment) {
<span class="nc" id="L97">        planFragments.add(planFragment);</span>
<span class="nc" id="L98">    }</span>

    public void addEntryCriterion(Criterion entryCriterion) {
<span class="nc" id="L101">        entryCriteria.add(entryCriterion);</span>
<span class="nc" id="L102">    }</span>

    public void addEntryCriterionToCurrentElement(Criterion entryCriterion) {
<span class="nc" id="L105">        addEntryCriterion(entryCriterion);</span>

<span class="nc" id="L107">        ListIterator&lt;CmmnElement&gt; iterator = currentCmmnElements.listIterator(currentCmmnElements.size());</span>
<span class="nc" id="L108">        HasEntryCriteria hasEntryCriteria = null;</span>
<span class="nc bnc" id="L109" title="All 4 branches missed.">        while (hasEntryCriteria == null &amp;&amp; iterator.hasPrevious()) {</span>
<span class="nc" id="L110">            CmmnElement cmmnElement = iterator.previous();</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">            if (cmmnElement instanceof HasEntryCriteria) {</span>
<span class="nc" id="L112">                hasEntryCriteria = (HasEntryCriteria) cmmnElement;</span>
            }
<span class="nc" id="L114">        }</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (hasEntryCriteria != null) {</span>

<span class="nc bnc" id="L117" title="All 2 branches missed.">            if (StringUtils.isEmpty(entryCriterion.getId())) {</span>
                // An id is expected by the evaluation algorithm, so setting an internal one if there isn't one
<span class="nc" id="L119">                entryCriterion.setId(generateEntryCriterionId(hasEntryCriteria));</span>
            }

<span class="nc" id="L122">            entryCriterion.setAttachedToRefId(hasEntryCriteria.getId());</span>
<span class="nc" id="L123">            hasEntryCriteria.getEntryCriteria().add(entryCriterion);</span>

        } else {
<span class="nc" id="L126">            throw new FlowableException(&quot;Cannot add an entry criteria &quot; + entryCriterion.getId() + &quot; no matching plan item found to attach it to&quot;);</span>
        }
<span class="nc" id="L128">    }</span>

    public void addExitCriterion(Criterion exitCriterion) {
<span class="nc" id="L131">        exitCriteria.add(exitCriterion);</span>
<span class="nc" id="L132">    }</span>

    public void addExitCriteriaToCurrentElement(Criterion exitCriterion) {
<span class="nc" id="L135">        addExitCriterion(exitCriterion);</span>

<span class="nc" id="L137">        ListIterator&lt;CmmnElement&gt; iterator = currentCmmnElements.listIterator(currentCmmnElements.size());</span>
<span class="nc" id="L138">        HasExitCriteria hasExitCriteria = null;</span>
<span class="nc bnc" id="L139" title="All 4 branches missed.">        while (hasExitCriteria == null &amp;&amp; iterator.hasPrevious()) {</span>
<span class="nc" id="L140">            CmmnElement cmmnElement = iterator.previous();</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">            if (cmmnElement instanceof HasExitCriteria) {</span>
<span class="nc" id="L142">                hasExitCriteria = (HasExitCriteria) cmmnElement;</span>
            }
<span class="nc" id="L144">        }</span>

<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (hasExitCriteria == null) {</span>
<span class="nc" id="L147">            hasExitCriteria = getCurrentCase().getPlanModel();</span>
        }

<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (StringUtils.isEmpty(exitCriterion.getId())) {</span>
            // An id is expected by the evaluation algorithm, so setting an internal one if there isn't one
<span class="nc" id="L152">            exitCriterion.setId(generateExitCriterionId(hasExitCriteria));</span>
        }

<span class="nc" id="L155">        exitCriterion.setAttachedToRefId(hasExitCriteria.getId());</span>
<span class="nc" id="L156">        hasExitCriteria.getExitCriteria().add(exitCriterion);</span>
<span class="nc" id="L157">    }</span>

    public void addSentry(Sentry sentry) {
<span class="nc" id="L160">        sentries.add(sentry);</span>
<span class="nc" id="L161">    }</span>

    public void addSentryToCurrentPlanFragment(Sentry sentry) {
<span class="nc" id="L164">        addSentry(sentry);</span>
<span class="nc" id="L165">        setCurrentSentry(sentry);</span>
<span class="nc" id="L166">        getCurrentPlanFragment().addSentry(sentry);</span>
<span class="nc" id="L167">    }</span>

    public void addSentryOnPart(SentryOnPart sentryOnPart) {
<span class="nc" id="L170">        sentryOnParts.add(sentryOnPart);</span>
<span class="nc" id="L171">    }</span>

    public void addSentryOnPartToCurrentSentry(SentryOnPart sentryOnPart) {
<span class="nc" id="L174">        addSentryOnPart(sentryOnPart);</span>
<span class="nc" id="L175">        getCurrentSentry().addSentryOnPart(sentryOnPart);</span>
<span class="nc" id="L176">        setCurrentSentryOnPart(sentryOnPart);</span>
<span class="nc" id="L177">    }</span>

    public void addSentryIfPart(SentryIfPart sentryIfPart) {
<span class="nc" id="L180">        sentryIfParts.add(sentryIfPart);</span>
<span class="nc" id="L181">    }</span>

    public void addSentryIfPartToCurrentSentry(SentryIfPart sentryIfPart) {
<span class="nc" id="L184">        addSentryIfPart(sentryIfPart);</span>
<span class="nc" id="L185">        getCurrentSentry().setSentryIfPart(sentryIfPart);</span>
<span class="nc" id="L186">    }</span>

    public void addPlanItem(PlanItem planItem) {
<span class="nc" id="L189">        planItems.add(planItem);</span>
<span class="nc" id="L190">    }</span>

    public void addPlanItemToCurrentPlanFragment(PlanItem planItem) {
<span class="nc" id="L193">        addPlanItem(planItem);</span>
<span class="nc" id="L194">        getCurrentPlanFragment().addPlanItem(planItem);</span>
<span class="nc" id="L195">        setCurrentPlanItem(planItem);</span>
<span class="nc" id="L196">    }</span>

    public void addPlanItemDefinition(PlanItemDefinition planItemDefinition) {
<span class="nc" id="L199">        planItemDefinitions.add(planItemDefinition);</span>
<span class="nc" id="L200">    }</span>

    public void addDiShape(CmmnDiShape diShape) {
<span class="nc" id="L203">        diShapes.add(diShape);</span>
<span class="nc" id="L204">        setCurrentDiShape(diShape);</span>
<span class="nc" id="L205">    }</span>

    public void addDiEdge(CmmnDiEdge diEdge) {
<span class="nc" id="L208">        diEdges.add(diEdge);</span>
<span class="nc" id="L209">        setCurrentDiEdge(diEdge);</span>
<span class="nc" id="L210">    }</span>

    public Optional&lt;PlanItem&gt; findPlanItem(String planItemId) {
<span class="nc" id="L213">        return planItems.stream()</span>
<span class="nc" id="L214">                        .filter(planItem -&gt; planItem.getId().equals(planItemId))</span>
<span class="nc" id="L215">                        .findFirst();</span>
    }

    public CmmnModel getCmmnModel() {
<span class="nc" id="L219">        return cmmnModel;</span>
    }

    public void setCmmnModel(CmmnModel cmmnModel) {
<span class="nc" id="L223">        this.cmmnModel = cmmnModel;</span>
<span class="nc" id="L224">    }</span>

    public Case getCurrentCase() {
<span class="nc" id="L227">        return currentCase;</span>
    }

    public void setCurrentCase(Case currentCase) {
<span class="nc" id="L231">        this.currentCase = currentCase;</span>
<span class="nc" id="L232">    }</span>

    public CmmnElement getCurrentCmmnElement() {
<span class="nc" id="L235">        return currentCmmnElements.peekLast();</span>
    }

    public PlanFragment getCurrentPlanFragment() {
<span class="nc" id="L239">        return planFragmentsStack.peekLast();</span>
    }

    public void setCurrentPlanFragment(PlanFragment currentPlanFragment) {
<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (currentPlanFragment != null) {</span>
<span class="nc" id="L244">            this.planFragmentsStack.add(currentPlanFragment);</span>
        }
<span class="nc" id="L246">    }</span>

    public void removeCurrentPlanFragment() {
<span class="nc" id="L249">        this.planFragmentsStack.removeLast();</span>
<span class="nc" id="L250">    }</span>

    public Stage getCurrentStage() {
<span class="nc" id="L253">        return stagesStack.peekLast();</span>
    }

    public void setCurrentStage(Stage currentStage) {
<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (currentStage != null) {</span>
<span class="nc" id="L258">            this.stagesStack.add(currentStage);</span>
<span class="nc" id="L259">            setCurrentPlanFragment(currentStage);</span>
        }
<span class="nc" id="L261">    }</span>

    public void removeCurrentStage() {
<span class="nc" id="L264">        this.stagesStack.removeLast();</span>
<span class="nc" id="L265">        removeCurrentPlanFragment();</span>
<span class="nc" id="L266">    }</span>

    public void setCurrentCmmnElement(CmmnElement currentCmmnElement) {
<span class="nc" id="L269">        currentCmmnElements.add(currentCmmnElement);</span>
<span class="nc" id="L270">    }</span>

    public void removeCurrentCmmnElement() {
<span class="nc" id="L273">        currentCmmnElements.removeLast();</span>
<span class="nc" id="L274">    }</span>

    public Sentry getCurrentSentry() {
<span class="nc" id="L277">        return currentSentry;</span>
    }

    public void setCurrentSentry(Sentry currentSentry) {
<span class="nc" id="L281">        this.currentSentry = currentSentry;</span>
<span class="nc" id="L282">    }</span>

    public SentryOnPart getCurrentSentryOnPart() {
<span class="nc" id="L285">        return currentSentryOnPart;</span>
    }

    public void setCurrentSentryOnPart(SentryOnPart currentSentryOnPart) {
<span class="nc" id="L289">        this.currentSentryOnPart = currentSentryOnPart;</span>
<span class="nc" id="L290">    }</span>

    public PlanItem getCurrentPlanItem() {
<span class="nc" id="L293">        return currentPlanItem;</span>
    }

    public void setCurrentPlanItem(PlanItem currentPlanItem) {
<span class="nc" id="L297">        this.currentPlanItem = currentPlanItem;</span>
<span class="nc" id="L298">    }</span>

    public CmmnDiShape getCurrentDiShape() {
<span class="nc" id="L301">        return currentDiShape;</span>
    }

    public void setCurrentDiShape(CmmnDiShape currentDiShape) {
<span class="nc" id="L305">        this.currentDiShape = currentDiShape;</span>
<span class="nc" id="L306">    }</span>

    public CmmnDiEdge getCurrentDiEdge() {
<span class="nc" id="L309">        return currentDiEdge;</span>
    }

    public void setCurrentDiEdge(CmmnDiEdge currentDiEdge) {
<span class="nc" id="L313">        this.currentDiEdge = currentDiEdge;</span>
<span class="nc" id="L314">    }</span>

    public List&lt;Stage&gt; getStages() {
<span class="nc" id="L317">        return stages;</span>
    }

    public List&lt;PlanFragment&gt; getPlanFragments() {
<span class="nc" id="L321">        return planFragments;</span>
    }

    public List&lt;Criterion&gt; getEntryCriteria() {
<span class="nc" id="L325">        return entryCriteria;</span>
    }

    public List&lt;Criterion&gt; getExitCriteria() {
<span class="nc" id="L329">        return exitCriteria;</span>
    }

    public List&lt;Sentry&gt; getSentries() {
<span class="nc" id="L333">        return sentries;</span>
    }

    public List&lt;SentryOnPart&gt; getSentryOnParts() {
<span class="nc" id="L337">        return sentryOnParts;</span>
    }

    public List&lt;SentryIfPart&gt; getSentryIfParts() {
<span class="nc" id="L341">        return sentryIfParts;</span>
    }

    public List&lt;PlanItem&gt; getPlanItems() {
<span class="nc" id="L345">        return planItems;</span>
    }

    public List&lt;PlanItemDefinition&gt; getPlanItemDefinitions() {
<span class="nc" id="L349">        return planItemDefinitions;</span>
    }

    public List&lt;CmmnDiShape&gt; getDiShapes() {
<span class="nc" id="L353">        return diShapes;</span>
    }

    public List&lt;CmmnDiEdge&gt; getDiEdges() {
<span class="nc" id="L357">        return diEdges;</span>
    }

    public GraphicInfo getCurrentLabelGraphicInfo() {
<span class="nc" id="L361">        return currentLabelGraphicInfo;</span>
    }

    public void setCurrentLabelGraphicInfo(GraphicInfo labelGraphicInfo) {
<span class="nc" id="L365">        this.currentLabelGraphicInfo = labelGraphicInfo;</span>
<span class="nc" id="L366">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>