<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TaskAssignmentExtensionsTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.bpmn.usertask</a> &gt; <span class="el_source">TaskAssignmentExtensionsTest.java</span></div><h1>TaskAssignmentExtensionsTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.engine.test.bpmn.usertask;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.assertj.core.api.Assertions.tuple;

import java.util.Arrays;
import java.util.List;

import org.flowable.bpmn.exceptions.XMLException;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.impl.test.TestHelper;
import org.flowable.engine.test.Deployment;
import org.flowable.identitylink.api.IdentityLink;
import org.flowable.identitylink.api.IdentityLinkType;
import org.flowable.task.api.Task;
import org.flowable.task.api.TaskQuery;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import com.fasterxml.jackson.databind.node.ArrayNode;

/**
 * Testcase for the non-spec extensions to the task candidate use case.
 * 
 * @author Joram Barrez
 */
<span class="nc" id="L41">public class TaskAssignmentExtensionsTest extends PluggableFlowableTestCase {</span>

    @BeforeEach
    public void setUp() throws Exception {
<span class="nc" id="L45">        identityService.saveUser(identityService.newUser(&quot;kermit&quot;));</span>
<span class="nc" id="L46">        identityService.saveUser(identityService.newUser(&quot;gonzo&quot;));</span>
<span class="nc" id="L47">        identityService.saveUser(identityService.newUser(&quot;fozzie&quot;));</span>

<span class="nc" id="L49">        identityService.saveGroup(identityService.newGroup(&quot;management&quot;));</span>
<span class="nc" id="L50">        identityService.saveGroup(identityService.newGroup(&quot;accountancy&quot;));</span>

<span class="nc" id="L52">        identityService.createMembership(&quot;kermit&quot;, &quot;management&quot;);</span>
<span class="nc" id="L53">        identityService.createMembership(&quot;kermit&quot;, &quot;accountancy&quot;);</span>
<span class="nc" id="L54">        identityService.createMembership(&quot;fozzie&quot;, &quot;management&quot;);</span>
<span class="nc" id="L55">    }</span>

    @AfterEach
    public void tearDown() throws Exception {
<span class="nc" id="L59">        identityService.deleteGroup(&quot;accountancy&quot;);</span>
<span class="nc" id="L60">        identityService.deleteGroup(&quot;management&quot;);</span>
<span class="nc" id="L61">        identityService.deleteUser(&quot;fozzie&quot;);</span>
<span class="nc" id="L62">        identityService.deleteUser(&quot;gonzo&quot;);</span>
<span class="nc" id="L63">        identityService.deleteUser(&quot;kermit&quot;);</span>
<span class="nc" id="L64">    }</span>

    @Test
    @Deployment
    public void testAssigneeExtension() {
<span class="nc" id="L69">        runtimeService.startProcessInstanceByKey(&quot;assigneeExtension&quot;);</span>
<span class="nc" id="L70">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().taskAssignee(&quot;kermit&quot;).list();</span>
<span class="nc" id="L71">        assertThat(tasks)</span>
<span class="nc" id="L72">                .extracting(Task::getName)</span>
<span class="nc" id="L73">                .containsExactly(&quot;my task&quot;);</span>
<span class="nc" id="L74">    }</span>

    @Test
    public void testDuplicateAssigneeDeclaration() {
<span class="nc" id="L78">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L79">            String resource = TestHelper.getBpmnProcessDefinitionResource(getClass(), &quot;testDuplicateAssigneeDeclaration&quot;);</span>
<span class="nc" id="L80">            repositoryService.createDeployment().addClasspathResource(resource).deploy();</span>
<span class="nc" id="L81">        })</span>
<span class="nc" id="L82">                .as(&quot;Invalid BPMN 2.0 process should not parse, but it gets parsed successfully&quot;)</span>
<span class="nc" id="L83">                .isInstanceOf(XMLException.class);</span>
<span class="nc" id="L84">    }</span>

    @Test
    @Deployment
    public void testOwnerExtension() {
<span class="nc" id="L89">        runtimeService.startProcessInstanceByKey(&quot;ownerExtension&quot;);</span>
<span class="nc" id="L90">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().taskOwner(&quot;gonzo&quot;).list();</span>
<span class="nc" id="L91">        assertThat(tasks)</span>
<span class="nc" id="L92">                .extracting(Task::getName)</span>
<span class="nc" id="L93">                .containsExactly(&quot;my task&quot;);</span>
<span class="nc" id="L94">    }</span>

    @Test
    @Deployment
    public void testCandidateUsersExtension() {
<span class="nc" id="L99">        runtimeService.startProcessInstanceByKey(&quot;candidateUsersExtension&quot;);</span>
<span class="nc" id="L100">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().taskCandidateUser(&quot;kermit&quot;).list();</span>
<span class="nc" id="L101">        assertThat(tasks).hasSize(1);</span>
<span class="nc" id="L102">        tasks = taskService.createTaskQuery().taskCandidateUser(&quot;gonzo&quot;).list();</span>
<span class="nc" id="L103">        assertThat(tasks).hasSize(1);</span>
<span class="nc" id="L104">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/bpmn/usertask/TaskAssignmentExtensionsTest.testCandidateUsersExpressionExtension.bpmn20.xml&quot;)
    public void testCandidateUsersCollectionVariable() {
<span class="nc" id="L109">        runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L110">                .processDefinitionKey(&quot;candidateUsersExtension&quot;)</span>
<span class="nc" id="L111">                .transientVariable(&quot;candidateUsersVar&quot;, Arrays.asList(&quot;kermit&quot;, &quot;gonzo&quot;))</span>
<span class="nc" id="L112">                .start();</span>
<span class="nc" id="L113">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().taskCandidateUser(&quot;kermit&quot;).list();</span>
<span class="nc" id="L114">        assertThat(tasks).hasSize(1);</span>
<span class="nc" id="L115">        tasks = taskService.createTaskQuery().taskCandidateUser(&quot;gonzo&quot;).list();</span>
<span class="nc" id="L116">        assertThat(tasks).hasSize(1);</span>
<span class="nc" id="L117">        tasks = taskService.createTaskQuery().taskCandidateUser(&quot;rizzo&quot;).list();</span>
<span class="nc" id="L118">        assertThat(tasks).isEmpty();</span>
<span class="nc" id="L119">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/bpmn/usertask/TaskAssignmentExtensionsTest.testCandidateUsersExpressionExtension.bpmn20.xml&quot;)
    public void testCandidateUsersArrayNodeVariable() {
<span class="nc" id="L124">        ArrayNode users = processEngineConfiguration.getObjectMapper().createArrayNode();</span>
<span class="nc" id="L125">        users.add(&quot;kermit&quot;);</span>
<span class="nc" id="L126">        users.add(&quot;gonzo&quot;);</span>
<span class="nc" id="L127">        runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L128">                .processDefinitionKey(&quot;candidateUsersExtension&quot;)</span>
<span class="nc" id="L129">                .transientVariable(&quot;candidateUsersVar&quot;, users)</span>
<span class="nc" id="L130">                .start();</span>
<span class="nc" id="L131">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().taskCandidateUser(&quot;kermit&quot;).list();</span>
<span class="nc" id="L132">        assertThat(tasks).hasSize(1);</span>
<span class="nc" id="L133">        tasks = taskService.createTaskQuery().taskCandidateUser(&quot;gonzo&quot;).list();</span>
<span class="nc" id="L134">        assertThat(tasks).hasSize(1);</span>
<span class="nc" id="L135">        tasks = taskService.createTaskQuery().taskCandidateUser(&quot;rizzo&quot;).list();</span>
<span class="nc" id="L136">        assertThat(tasks).isEmpty();</span>
<span class="nc" id="L137">    }</span>

    @Test
    @Deployment
    public void testCandidateGroupsExtension() {
<span class="nc" id="L142">        runtimeService.startProcessInstanceByKey(&quot;candidateGroupsExtension&quot;);</span>

        // Bugfix check: potentially the query could return 2 tasks since
        // kermit is a member of the two candidate groups
<span class="nc" id="L146">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().taskCandidateUser(&quot;kermit&quot;).list();</span>
<span class="nc" id="L147">        assertThat(tasks).hasSize(1);</span>
<span class="nc" id="L148">        assertThat(tasks.get(0).getName()).isEqualTo(&quot;make profit&quot;);</span>
<span class="nc" id="L149">        assertThat(tasks)</span>
<span class="nc" id="L150">                .extracting(Task::getName)</span>
<span class="nc" id="L151">                .containsExactly(&quot;make profit&quot;);</span>

<span class="nc" id="L153">        tasks = taskService.createTaskQuery().taskCandidateUser(&quot;fozzie&quot;).list();</span>
<span class="nc" id="L154">        assertThat(tasks).hasSize(1);</span>
<span class="nc" id="L155">        assertThat(tasks.get(0).getName()).isEqualTo(&quot;make profit&quot;);</span>
<span class="nc" id="L156">        assertThat(tasks)</span>
<span class="nc" id="L157">                .extracting(Task::getName)</span>
<span class="nc" id="L158">                .containsExactly(&quot;make profit&quot;);</span>

        // Test the task query find-by-candidate-group operation
<span class="nc" id="L161">        TaskQuery query = taskService.createTaskQuery();</span>
<span class="nc" id="L162">        assertThat(query.taskCandidateGroup(&quot;management&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L163">        assertThat(query.taskCandidateGroup(&quot;accountancy&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L164">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/bpmn/usertask/TaskAssignmentExtensionsTest.testCandidateGroupsExpressionExtension.bpmn20.xml&quot;)
    public void testCandidateGroupsCollectionVariable() {
<span class="nc" id="L169">        runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L170">                .processDefinitionKey(&quot;candidateGroupsExtension&quot;)</span>
<span class="nc" id="L171">                .transientVariable(&quot;candidateGroupsVar&quot;, Arrays.asList(&quot;management&quot;, &quot;accountancy&quot;))</span>
<span class="nc" id="L172">                .start();</span>
<span class="nc" id="L173">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().taskCandidateUser(&quot;kermit&quot;).list();</span>
<span class="nc" id="L174">        assertThat(tasks)</span>
<span class="nc" id="L175">                .extracting(Task::getName)</span>
<span class="nc" id="L176">                .containsExactly(&quot;make profit&quot;);</span>

<span class="nc" id="L178">        tasks = taskService.createTaskQuery().taskCandidateUser(&quot;fozzie&quot;).list();</span>
<span class="nc" id="L179">        assertThat(tasks)</span>
<span class="nc" id="L180">                .extracting(Task::getName)</span>
<span class="nc" id="L181">                .containsExactly(&quot;make profit&quot;);</span>

        // Test the task query find-by-candidate-group operation
<span class="nc" id="L184">        TaskQuery query = taskService.createTaskQuery();</span>
<span class="nc" id="L185">        assertThat(query.taskCandidateGroup(&quot;management&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L186">        assertThat(query.taskCandidateGroup(&quot;accountancy&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L187">        assertThat(query.taskCandidateGroup(&quot;sales&quot;).count()).isZero();</span>
<span class="nc" id="L188">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/bpmn/usertask/TaskAssignmentExtensionsTest.testCandidateGroupsExpressionExtension.bpmn20.xml&quot;)
    public void testCandidateGroupsArrayNodeVariable() {
<span class="nc" id="L193">        ArrayNode users = processEngineConfiguration.getObjectMapper().createArrayNode();</span>
<span class="nc" id="L194">        users.add(&quot;management&quot;);</span>
<span class="nc" id="L195">        users.add(&quot;accountancy&quot;);</span>
<span class="nc" id="L196">        runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L197">                .processDefinitionKey(&quot;candidateGroupsExtension&quot;)</span>
<span class="nc" id="L198">                .transientVariable(&quot;candidateGroupsVar&quot;, users)</span>
<span class="nc" id="L199">                .start();</span>
<span class="nc" id="L200">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().taskCandidateUser(&quot;kermit&quot;).list();</span>
<span class="nc" id="L201">        assertThat(tasks)</span>
<span class="nc" id="L202">                .extracting(Task::getName)</span>
<span class="nc" id="L203">                .containsExactly(&quot;make profit&quot;);</span>

<span class="nc" id="L205">        tasks = taskService.createTaskQuery().taskCandidateUser(&quot;fozzie&quot;).list();</span>
<span class="nc" id="L206">        assertThat(tasks)</span>
<span class="nc" id="L207">                .extracting(Task::getName)</span>
<span class="nc" id="L208">                .containsExactly(&quot;make profit&quot;);</span>

        // Test the task query find-by-candidate-group operation
<span class="nc" id="L211">        TaskQuery query = taskService.createTaskQuery();</span>
<span class="nc" id="L212">        assertThat(query.taskCandidateGroup(&quot;management&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L213">        assertThat(query.taskCandidateGroup(&quot;accountancy&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L214">        assertThat(query.taskCandidateGroup(&quot;sales&quot;).count()).isZero();</span>
<span class="nc" id="L215">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/bpmn/usertask/TaskAssignmentExtensionsTest.testCandidatesWithCommaSeparatedStringExpression.bpmn20.xml&quot;)
    public void testCandidatesWithCommaSeparatedStringExpression() {
<span class="nc" id="L220">        runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L221">                .processDefinitionKey(&quot;candidatesExpression&quot;)</span>
<span class="nc" id="L222">                .start();</span>

<span class="nc" id="L224">        Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L225">        assertThat(task).isNotNull();</span>

<span class="nc" id="L227">        assertThat(taskService.getIdentityLinksForTask(task.getId()))</span>
<span class="nc" id="L228">                .extracting(IdentityLink::getType, IdentityLink::getUserId, IdentityLink::getGroupId)</span>
<span class="nc" id="L229">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L230">                        tuple(IdentityLinkType.CANDIDATE, &quot;user1&quot;, null),</span>
<span class="nc" id="L231">                        tuple(IdentityLinkType.CANDIDATE, &quot;user2&quot;, null),</span>
<span class="nc" id="L232">                        tuple(IdentityLinkType.CANDIDATE, null, &quot;groupA&quot;),</span>
<span class="nc" id="L233">                        tuple(IdentityLinkType.CANDIDATE, null, &quot;groupB&quot;)</span>
                );
<span class="nc" id="L235">    }</span>

    // Test where the candidate user extension is used together
    // with the spec way of defining candidate users
    @Test
    @Deployment
    public void testMixedCandidateUserDefinition() {
<span class="nc" id="L242">        runtimeService.startProcessInstanceByKey(&quot;mixedCandidateUser&quot;);</span>

<span class="nc" id="L244">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().taskCandidateUser(&quot;kermit&quot;).list();</span>
<span class="nc" id="L245">        assertThat(tasks).hasSize(1);</span>

<span class="nc" id="L247">        tasks = taskService.createTaskQuery().taskCandidateUser(&quot;fozzie&quot;).list();</span>
<span class="nc" id="L248">        assertThat(tasks).hasSize(1);</span>

<span class="nc" id="L250">        tasks = taskService.createTaskQuery().taskCandidateUser(&quot;gonzo&quot;).list();</span>
<span class="nc" id="L251">        assertThat(tasks).hasSize(1);</span>

<span class="nc" id="L253">        tasks = taskService.createTaskQuery().taskCandidateUser(&quot;mispiggy&quot;).list();</span>
<span class="nc" id="L254">        assertThat(tasks).isEmpty();</span>
<span class="nc" id="L255">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>