<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserTaskTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.bpmn.usertask</a> &gt; <span class="el_source">UserTaskTest.java</span></div><h1>UserTaskTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.engine.test.bpmn.usertask;

import static org.assertj.core.api.Assertions.assertThat;

import java.util.Calendar;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.flowable.common.engine.api.scope.ScopeTypes;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.common.engine.impl.identity.Authentication;
import org.flowable.common.engine.impl.interceptor.Command;
import org.flowable.common.engine.impl.interceptor.CommandContext;
import org.flowable.common.engine.impl.interceptor.CommandExecutor;
import org.flowable.engine.impl.test.HistoryTestHelper;
import org.flowable.engine.impl.test.JobTestHelper;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.interceptor.CreateUserTaskAfterContext;
import org.flowable.engine.interceptor.CreateUserTaskBeforeContext;
import org.flowable.engine.interceptor.CreateUserTaskInterceptor;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.entitylink.api.EntityLink;
import org.flowable.entitylink.api.EntityLinkService;
import org.flowable.entitylink.api.EntityLinkType;
import org.flowable.entitylink.api.HierarchyType;
import org.flowable.identitylink.api.IdentityLink;
import org.flowable.identitylink.api.IdentityLinkType;
import org.flowable.job.service.JobHandler;
import org.flowable.job.service.TimerJobService;
import org.flowable.job.service.impl.persistence.entity.JobEntity;
import org.flowable.job.service.impl.persistence.entity.TimerJobEntity;
import org.flowable.task.api.Task;
import org.flowable.task.api.history.HistoricTaskInstance;
import org.junit.jupiter.api.Test;

/**
 * @author Joram Barrez
 */
<span class="nc" id="L54">public class UserTaskTest extends PluggableFlowableTestCase {</span>

    @Test
    @Deployment
    public void testTaskPropertiesNotNull() {
<span class="nc" id="L59">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L61">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L62">        assertThat(task.getId()).isNotNull();</span>
<span class="nc" id="L63">        assertThat(task.getName()).isEqualTo(&quot;my task&quot;);</span>
<span class="nc" id="L64">        assertThat(task.getDescription()).isEqualTo(&quot;Very important&quot;);</span>
<span class="nc" id="L65">        assertThat(task.getPriority()).isGreaterThan(0);</span>
<span class="nc" id="L66">        assertThat(task.getAssignee()).isEqualTo(&quot;kermit&quot;);</span>
<span class="nc" id="L67">        assertThat(task.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L68">        assertThat(task.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L69">        assertThat(task.getTaskDefinitionKey()).isNotNull();</span>
<span class="nc" id="L70">        assertThat(task.getCreateTime()).isNotNull();</span>
        
        // the next test verifies that if an execution creates a task, that no events are created during creation of the task.
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L74">            assertThat(taskService.getTaskEvents(task.getId())).isEmpty();</span>
        }
<span class="nc" id="L76">    }</span>

    @Test
    @Deployment
    public void testEntityLinkCreated() {
<span class="nc" id="L81">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L83">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L84">        assertThat(task.getId()).isNotNull();</span>
<span class="nc" id="L85">        assertThat(task.getName()).isEqualTo(&quot;my task&quot;);</span>
<span class="nc" id="L86">        assertThat(task.getDescription()).isEqualTo(&quot;Very important&quot;);</span>
<span class="nc" id="L87">        assertThat(task.getPriority()).isGreaterThan(0);</span>
<span class="nc" id="L88">        assertThat(task.getAssignee()).isEqualTo(&quot;kermit&quot;);</span>
<span class="nc" id="L89">        assertThat(task.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L90">        assertThat(task.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L91">        assertThat(task.getTaskDefinitionKey()).isNotNull();</span>
<span class="nc" id="L92">        assertThat(task.getCreateTime()).isNotNull();</span>

<span class="nc" id="L94">        CommandExecutor commandExecutor = processEngine.getProcessEngineConfiguration().getCommandExecutor();</span>

<span class="nc" id="L96">        List&lt;EntityLink&gt; entityLinksByScopeIdAndType = commandExecutor.execute(commandContext -&gt; {</span>
<span class="nc" id="L97">            EntityLinkService entityLinkService = processEngineConfiguration.getEntityLinkServiceConfiguration().getEntityLinkService();</span>

<span class="nc" id="L99">            return entityLinkService.findEntityLinksByScopeIdAndType(processInstance.getId(), ScopeTypes.BPMN, EntityLinkType.CHILD);</span>
        });

<span class="nc" id="L102">        assertThat(entityLinksByScopeIdAndType).hasSize(1);</span>
<span class="nc" id="L103">        assertThat(entityLinksByScopeIdAndType.get(0).getHierarchyType()).isEqualTo(HierarchyType.ROOT);</span>
<span class="nc" id="L104">    }</span>

    @Test
    @Deployment
    public void testQuerySortingWithParameter() {
<span class="nc" id="L109">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L110">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).list()).hasSize(1);</span>
<span class="nc" id="L111">    }</span>

    @Test
    @Deployment
    public void testCompleteAfterParallelGateway() throws InterruptedException {
        // related to https://activiti.atlassian.net/browse/ACT-1054

        // start the process
<span class="nc" id="L119">        runtimeService.startProcessInstanceByKey(&quot;ForkProcess&quot;);</span>
<span class="nc" id="L120">        List&lt;org.flowable.task.api.Task&gt; taskList = taskService.createTaskQuery().list();</span>
<span class="nc" id="L121">        assertThat(taskList).hasSize(2);</span>

        // make sure user task exists
<span class="nc" id="L124">        org.flowable.task.api.Task task = taskService.createTaskQuery().taskDefinitionKey(&quot;SimpleUser&quot;).singleResult();</span>
<span class="nc" id="L125">        assertThat(task).isNotNull();</span>

        // attempt to complete the task and get PersistenceException pointing to
        // &quot;referential integrity constraint violation&quot;
<span class="nc" id="L129">        taskService.complete(task.getId());</span>
<span class="nc" id="L130">    }</span>

    @Test
    @Deployment
    public void testTaskCategory() {
<span class="nc" id="L135">        runtimeService.startProcessInstanceByKey(&quot;testTaskCategory&quot;);</span>
<span class="nc" id="L136">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>

        // Test if the property set in the model is shown in the task
<span class="nc" id="L139">        String testCategory = &quot;My Category&quot;;</span>
<span class="nc" id="L140">        assertThat(task.getCategory()).isEqualTo(testCategory);</span>

        // Test if can be queried by query API
<span class="nc" id="L143">        assertThat(taskService.createTaskQuery().taskCategory(testCategory).singleResult().getName()).isEqualTo(&quot;Task with category&quot;);</span>
<span class="nc" id="L144">        assertThat(taskService.createTaskQuery().taskCategory(&quot;Does not exist&quot;).count()).isZero();</span>

<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
            // Check historic task
<span class="nc" id="L148">            HistoricTaskInstance historicTaskInstance = historyService.createHistoricTaskInstanceQuery().taskId(task.getId()).singleResult();</span>
<span class="nc" id="L149">            assertThat(historicTaskInstance.getCategory()).isEqualTo(testCategory);</span>
<span class="nc" id="L150">            assertThat(historyService.createHistoricTaskInstanceQuery().taskCategory(testCategory).singleResult().getName()).isEqualTo(&quot;Task with category&quot;);</span>
<span class="nc" id="L151">            assertThat(historyService.createHistoricTaskInstanceQuery().taskCategory(&quot;Does not exist&quot;).count()).isZero();</span>
        }

        // Update category
<span class="nc" id="L155">        String newCategory = &quot;New Test Category&quot;;</span>
<span class="nc" id="L156">        task.setCategory(newCategory);</span>
<span class="nc" id="L157">        taskService.saveTask(task);</span>

<span class="nc" id="L159">        task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L160">        assertThat(task.getCategory()).isEqualTo(newCategory);</span>
<span class="nc" id="L161">        assertThat(taskService.createTaskQuery().taskCategory(newCategory).singleResult().getName()).isEqualTo(&quot;Task with category&quot;);</span>
<span class="nc" id="L162">        assertThat(taskService.createTaskQuery().taskCategory(testCategory).count()).isZero();</span>

        // Complete task and verify history
<span class="nc" id="L165">        taskService.complete(task.getId());</span>
            
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L168">            HistoricTaskInstance historicTaskInstance = historyService.createHistoricTaskInstanceQuery().taskId(task.getId()).singleResult();</span>
<span class="nc" id="L169">            assertThat(historicTaskInstance.getCategory()).isEqualTo(newCategory);</span>
<span class="nc" id="L170">            assertThat(historyService.createHistoricTaskInstanceQuery().taskCategory(newCategory).singleResult().getName()).isEqualTo(&quot;Task with category&quot;);</span>
<span class="nc" id="L171">            assertThat(historyService.createHistoricTaskInstanceQuery().taskCategory(testCategory).count()).isZero();</span>
        }
<span class="nc" id="L173">    }</span>

    // See https://activiti.atlassian.net/browse/ACT-4041
    @Test
    public void testTaskFormKeyWhenUsingIncludeVariables() {
<span class="nc" id="L178">        deployOneTaskTestProcess();</span>
<span class="nc" id="L179">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

        // Set variables
<span class="nc" id="L182">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L183">        assertThat(task).isNotNull();</span>
<span class="nc" id="L184">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">        for (int i = 0; i &lt; 20; i++) {</span>
<span class="nc" id="L186">            vars.put(&quot;var&quot; + i, i * 2);</span>
        }
<span class="nc" id="L188">        taskService.setVariables(task.getId(), vars);</span>

        // Set form key
<span class="nc" id="L191">        task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L192">        task.setFormKey(&quot;test123&quot;);</span>
<span class="nc" id="L193">        taskService.saveTask(task);</span>

        // Verify query and check form key
<span class="nc" id="L196">        task = taskService.createTaskQuery().includeProcessVariables().singleResult();</span>
<span class="nc" id="L197">        assertThat(task.getProcessVariables()).hasSameSizeAs(vars);</span>

<span class="nc" id="L199">        assertThat(task.getFormKey()).isEqualTo(&quot;test123&quot;);</span>
<span class="nc" id="L200">    }</span>
    
    @Test
    @Deployment
    public void testEmptyAssignmentExpression() {
<span class="nc" id="L205">        Map&lt;String, Object&gt; variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L206">        variableMap.put(&quot;assignee&quot;, null);</span>
<span class="nc" id="L207">        variableMap.put(&quot;candidateUsers&quot;, null);</span>
<span class="nc" id="L208">        variableMap.put(&quot;candidateGroups&quot;, null);</span>
<span class="nc" id="L209">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, variableMap);</span>
<span class="nc" id="L210">        assertThat(processInstance).isNotNull();</span>
        
<span class="nc" id="L212">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L213">        assertThat(task).isNotNull();</span>
<span class="nc" id="L214">        assertThat(task.getAssignee()).isNull();</span>
<span class="nc" id="L215">        List&lt;IdentityLink&gt; identityLinks = taskService.getIdentityLinksForTask(task.getId());</span>
<span class="nc" id="L216">        assertThat(identityLinks).isEmpty();</span>
        
<span class="nc" id="L218">        variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L219">        variableMap.put(&quot;assignee&quot;, &quot;&quot;);</span>
<span class="nc" id="L220">        variableMap.put(&quot;candidateUsers&quot;, &quot;&quot;);</span>
<span class="nc" id="L221">        variableMap.put(&quot;candidateGroups&quot;, &quot;&quot;);</span>
<span class="nc" id="L222">        processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, variableMap);</span>
<span class="nc" id="L223">        assertThat(processInstance).isNotNull();</span>
        
<span class="nc" id="L225">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L226">        assertThat(task).isNotNull();</span>
<span class="nc" id="L227">        assertThat(task.getAssignee()).isNull();</span>
<span class="nc" id="L228">        identityLinks = taskService.getIdentityLinksForTask(task.getId());</span>
<span class="nc" id="L229">        assertThat(identityLinks).isEmpty();</span>
<span class="nc" id="L230">    }</span>
    
    @Test
    @Deployment
    public void testNonStringProperties() {
<span class="nc" id="L235">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L236">        vars.put(&quot;taskName&quot;, 1);</span>
<span class="nc" id="L237">        vars.put(&quot;taskDescription&quot;, 2);</span>
<span class="nc" id="L238">        vars.put(&quot;taskCategory&quot;, 3);</span>
<span class="nc" id="L239">        vars.put(&quot;taskFormKey&quot;, 4);</span>
<span class="nc" id="L240">        vars.put(&quot;taskAssignee&quot;, 5);</span>
<span class="nc" id="L241">        vars.put(&quot;taskOwner&quot;, 6);</span>
<span class="nc" id="L242">        vars.put(&quot;taskCandidateGroups&quot;, 7);</span>
<span class="nc" id="L243">        vars.put(&quot;taskCandidateUsers&quot;, 8);</span>
<span class="nc" id="L244">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;nonStringProperties&quot;, vars);</span>
        
<span class="nc" id="L246">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L247">        assertThat(task.getName()).isEqualTo(&quot;1&quot;);</span>
<span class="nc" id="L248">        assertThat(task.getDescription()).isEqualTo(&quot;2&quot;);</span>
<span class="nc" id="L249">        assertThat(task.getCategory()).isEqualTo(&quot;3&quot;);</span>
<span class="nc" id="L250">        assertThat(task.getFormKey()).isEqualTo(&quot;4&quot;);</span>
<span class="nc" id="L251">        assertThat(task.getAssignee()).isEqualTo(&quot;5&quot;);</span>
<span class="nc" id="L252">        assertThat(task.getOwner()).isEqualTo(&quot;6&quot;);</span>
        
<span class="nc" id="L254">        List&lt;IdentityLink&gt; identityLinks = taskService.getIdentityLinksForTask(task.getId());</span>
<span class="nc" id="L255">        assertThat(identityLinks).hasSize(4);</span>
<span class="nc" id="L256">        int candidateIdentityLinkCount = 0;</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">        for (IdentityLink identityLink : identityLinks) {</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">            if (identityLink.getType().equals(IdentityLinkType.CANDIDATE)) {</span>
<span class="nc" id="L259">                candidateIdentityLinkCount++;</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">                if (identityLink.getGroupId() != null) {</span>
<span class="nc" id="L261">                    assertThat(identityLink.getGroupId()).isEqualTo(&quot;7&quot;);</span>
                } else {
<span class="nc" id="L263">                    assertThat(identityLink.getUserId()).isEqualTo(&quot;8&quot;);</span>
                }
            }
<span class="nc" id="L266">        }</span>
<span class="nc" id="L267">        assertThat(candidateIdentityLinkCount).isEqualTo(2);</span>
<span class="nc" id="L268">    }</span>
    
    @Test
    @Deployment(resources=&quot;org/flowable/engine/test/bpmn/usertask/UserTaskTest.testTaskPropertiesNotNull.bpmn20.xml&quot;)
    public void testCreateUserTaskInterceptor() throws Exception {
<span class="nc" id="L273">        TestCreateUserTaskInterceptor testCreateUserTaskInterceptor = new TestCreateUserTaskInterceptor();</span>
<span class="nc" id="L274">        processEngineConfiguration.setCreateUserTaskInterceptor(testCreateUserTaskInterceptor);</span>
        
        try {
<span class="nc" id="L277">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L279">            org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L280">            assertThat(task.getId()).isNotNull();</span>
<span class="nc" id="L281">            assertThat(task.getName()).isEqualTo(&quot;my task&quot;);</span>
<span class="nc" id="L282">            assertThat(task.getDescription()).isEqualTo(&quot;Very important&quot;);</span>
<span class="nc" id="L283">            assertThat(task.getCategory()).isEqualTo(&quot;testCategory&quot;);</span>
            
<span class="nc" id="L285">            assertThat(testCreateUserTaskInterceptor.getBeforeCreateUserTaskCounter()).isEqualTo(1);</span>
<span class="nc" id="L286">            assertThat(testCreateUserTaskInterceptor.getAfterCreateUserTaskCounter()).isEqualTo(1);</span>
            
        } finally {
<span class="nc" id="L289">            processEngineConfiguration.setCreateUserTaskInterceptor(null);</span>
        }
<span class="nc" id="L291">    }</span>

    @Test
    @Deployment(resources=&quot;org/flowable/engine/test/bpmn/usertask/UserTaskTest.userTaskIdVariableName.bpmn20.xml&quot;)
    public void testUserTaskIdVariableName() throws Exception {
<span class="nc" id="L296">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;userTaskIdVariableName&quot;);</span>

        // Normal string
<span class="nc" id="L299">        Task firstTask = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;task1&quot;).singleResult();</span>
<span class="nc" id="L300">        assertThat(firstTask).isNotNull();</span>

<span class="nc" id="L302">        String actualTaskId = firstTask.getId();</span>
<span class="nc" id="L303">        String myTaskId = (String)runtimeService.getVariable(processInstance.getId(), &quot;myTaskId&quot;);</span>
<span class="nc" id="L304">        assertThat(myTaskId).isEqualTo(actualTaskId);</span>

        // Expression
<span class="nc" id="L307">        Task secondTask = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;task2&quot;).singleResult();</span>
<span class="nc" id="L308">        assertThat(secondTask).isNotNull();</span>

<span class="nc" id="L310">        actualTaskId = secondTask.getId();</span>
<span class="nc" id="L311">        String myExpressionTaskId = (String)runtimeService.getVariable(processInstance.getId(), &quot;myExpressionTaskId&quot;);</span>
<span class="nc" id="L312">        assertThat(myExpressionTaskId).isEqualTo(actualTaskId);</span>
<span class="nc" id="L313">    }</span>

    @Test
    @Deployment(resources=&quot;org/flowable/engine/test/bpmn/usertask/UserTaskTest.userTaskCompleterVariableName.bpmn20.xml&quot;)
    public void testUserTaskCompleterVariableName() throws Exception {
<span class="nc" id="L318">        Authentication.setAuthenticatedUserId(&quot;JohnDoe&quot;);</span>
<span class="nc" id="L319">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;userTaskCompleterVariableName&quot;);</span>

        // Normal string
<span class="nc" id="L322">        Task firstTask = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;task1&quot;).singleResult();</span>
<span class="nc" id="L323">        assertThat(firstTask).isNotNull();</span>
<span class="nc" id="L324">        taskService.complete(firstTask.getId());</span>
<span class="nc" id="L325">        String completerTask1 = runtimeService.getVariable(processInstance.getProcessInstanceId(), &quot;completerTask1&quot;, String.class);</span>
<span class="nc" id="L326">        assertThat(completerTask1).isEqualTo(&quot;JohnDoe&quot;);</span>

        // Expression
<span class="nc" id="L329">        Task secondTask = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;task2&quot;).singleResult();</span>
<span class="nc" id="L330">        assertThat(secondTask).isNotNull();</span>
<span class="nc" id="L331">        taskService.complete(secondTask.getId());</span>
<span class="nc" id="L332">        String completerTask2 = runtimeService.getVariable(processInstance.getProcessInstanceId(), &quot;completerTask2&quot;, String.class);</span>
<span class="nc" id="L333">        assertThat(completerTask2).isEqualTo(&quot;JohnDoe&quot;);</span>

        // No user
<span class="nc" id="L336">        Authentication.setAuthenticatedUserId(null);</span>
<span class="nc" id="L337">        Task thirdTask = taskService.createTaskQuery().processInstanceId(processInstance.getId()).taskDefinitionKey(&quot;task3&quot;).singleResult();</span>
<span class="nc" id="L338">        assertThat(thirdTask).isNotNull();</span>
<span class="nc" id="L339">        taskService.complete(thirdTask.getId());</span>
<span class="nc" id="L340">        String completerTask3 = runtimeService.getVariable(processInstance.getProcessInstanceId(), &quot;completerTask3&quot;, String.class);</span>
<span class="nc" id="L341">        assertThat(completerTask3).isEqualTo(null);</span>
<span class="nc" id="L342">    }</span>

    /**
     * Test for Issue &lt;a href=&quot;https://github.com/flowable/flowable-engine/issues/3467&quot;&gt;#3467&lt;/a&gt;
     */
    @Deployment
    @Test
    void testIdentityLinkNotDuplicate() {
<span class="nc" id="L350">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L351">        variables.put(&quot;employee&quot;, &quot;John Doe&quot;);</span>
<span class="nc" id="L352">        variables.put(&quot;nrOfHolidays&quot;, 10);</span>
<span class="nc" id="L353">        variables.put(&quot;description&quot;, &quot;I want to go to Hawaii&quot;);</span>
<span class="nc" id="L354">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;holidayRequest&quot;, variables);</span>
<span class="nc" id="L355">        Task task = taskService.createTaskQuery().taskCandidateGroup(&quot;managers&quot;).singleResult();</span>
<span class="nc" id="L356">        List&lt;IdentityLink&gt; identityLinksForTask = taskService.getIdentityLinksForTask(task.getId());</span>

<span class="nc" id="L358">        assertThat(identityLinksForTask).singleElement().satisfies(e -&gt; assertThat(e.getType()).isEqualTo(&quot;candidate&quot;));</span>
        // Identity link variables are added in TestListener.java. Only one expected
<span class="nc" id="L360">        assertThat(processInstance.getProcessVariables()).describedAs(&quot;Expected only one identity link&quot;)</span>
<span class="nc" id="L361">                .containsOnlyKeys(&quot;identityLinks_0&quot;, &quot;employee&quot;, &quot;nrOfHolidays&quot;, &quot;description&quot;);</span>
<span class="nc" id="L362">    }</span>
    
    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot;)
    public void testFillTaskLifecycleValues() {
<span class="nc" id="L367">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L369">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L370">        assertThat(task.getId()).isNotNull();</span>
<span class="nc" id="L371">        assertThat(task.getName()).isEqualTo(&quot;my task&quot;);</span>
<span class="nc" id="L372">        assertThat(task.getState()).isEqualTo(Task.CREATED);</span>
<span class="nc" id="L373">        assertThat(task.getInProgressStartTime()).isNull();</span>
<span class="nc" id="L374">        assertThat(task.getInProgressStartedBy()).isNull();</span>
<span class="nc" id="L375">        assertThat(task.getClaimTime()).isNull();</span>
<span class="nc" id="L376">        assertThat(task.getClaimedBy()).isNull();</span>
<span class="nc" id="L377">        assertThat(task.getSuspendedTime()).isNull();</span>
<span class="nc" id="L378">        assertThat(task.getSuspendedBy()).isNull();</span>
        
<span class="nc bnc" id="L380" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L381">            HistoricTaskInstance historicTaskInstance = historyService.createHistoricTaskInstanceQuery().taskId(task.getId()).singleResult();</span>
<span class="nc" id="L382">            assertThat(historicTaskInstance.getState()).isEqualTo(Task.CREATED);</span>
<span class="nc" id="L383">            assertThat(historicTaskInstance.getCreateTime()).isNotNull();</span>
        }
        
<span class="nc" id="L386">        taskService.claim(task.getId(), &quot;kermit&quot;);</span>
<span class="nc" id="L387">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L388">        assertThat(task.getState()).isEqualTo(Task.CLAIMED);</span>
<span class="nc" id="L389">        assertThat(task.getClaimTime()).isNotNull();</span>
<span class="nc" id="L390">        assertThat(task.getClaimedBy()).isEqualTo(&quot;kermit&quot;);</span>
        
<span class="nc bnc" id="L392" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L393">            HistoricTaskInstance historicTaskInstance = historyService.createHistoricTaskInstanceQuery().taskId(task.getId()).singleResult();</span>
<span class="nc" id="L394">            assertThat(historicTaskInstance.getState()).isEqualTo(Task.CLAIMED);</span>
<span class="nc" id="L395">            assertThat(historicTaskInstance.getClaimTime()).isNotNull();</span>
<span class="nc" id="L396">            assertThat(historicTaskInstance.getClaimedBy()).isEqualTo(&quot;kermit&quot;);</span>
        }
        
<span class="nc" id="L399">        taskService.startProgress(task.getId(), &quot;fozzie&quot;);</span>
<span class="nc" id="L400">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L401">        assertThat(task.getState()).isEqualTo(Task.IN_PROGRESS);</span>
<span class="nc" id="L402">        assertThat(task.getInProgressStartTime()).isNotNull();</span>
<span class="nc" id="L403">        assertThat(task.getInProgressStartedBy()).isEqualTo(&quot;fozzie&quot;);</span>
        
<span class="nc bnc" id="L405" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L406">            HistoricTaskInstance historicTaskInstance = historyService.createHistoricTaskInstanceQuery().taskId(task.getId()).singleResult();</span>
<span class="nc" id="L407">            assertThat(historicTaskInstance.getState()).isEqualTo(Task.IN_PROGRESS);</span>
<span class="nc" id="L408">            assertThat(historicTaskInstance.getInProgressStartTime()).isNotNull();</span>
<span class="nc" id="L409">            assertThat(historicTaskInstance.getInProgressStartedBy()).isEqualTo(&quot;fozzie&quot;);</span>
        }
        
<span class="nc" id="L412">        taskService.suspendTask(task.getId(), &quot;gonzo&quot;);</span>
<span class="nc" id="L413">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L414">        assertThat(task.getState()).isEqualTo(Task.SUSPENDED);</span>
<span class="nc" id="L415">        assertThat(task.getSuspendedTime()).isNotNull();</span>
<span class="nc" id="L416">        assertThat(task.getSuspendedBy()).isEqualTo(&quot;gonzo&quot;);</span>
        
<span class="nc bnc" id="L418" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L419">            HistoricTaskInstance historicTaskInstance = historyService.createHistoricTaskInstanceQuery().taskId(task.getId()).singleResult();</span>
<span class="nc" id="L420">            assertThat(historicTaskInstance.getState()).isEqualTo(Task.SUSPENDED);</span>
<span class="nc" id="L421">            assertThat(historicTaskInstance.getSuspendedTime()).isNotNull();</span>
<span class="nc" id="L422">            assertThat(historicTaskInstance.getSuspendedBy()).isEqualTo(&quot;gonzo&quot;);</span>
        }
        
<span class="nc" id="L425">        taskService.activateTask(task.getId(), &quot;kermit&quot;);</span>
<span class="nc" id="L426">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L427">        assertThat(task.getState()).isEqualTo(Task.IN_PROGRESS);</span>
<span class="nc" id="L428">        assertThat(task.getSuspendedTime()).isNull();</span>
<span class="nc" id="L429">        assertThat(task.getSuspendedBy()).isNull();</span>
        
<span class="nc bnc" id="L431" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L432">            HistoricTaskInstance historicTaskInstance = historyService.createHistoricTaskInstanceQuery().taskId(task.getId()).singleResult();</span>
<span class="nc" id="L433">            assertThat(historicTaskInstance.getState()).isEqualTo(Task.IN_PROGRESS);</span>
<span class="nc" id="L434">            assertThat(historicTaskInstance.getClaimTime()).isNotNull();</span>
<span class="nc" id="L435">            assertThat(historicTaskInstance.getClaimedBy()).isEqualTo(&quot;kermit&quot;);</span>
<span class="nc" id="L436">            assertThat(historicTaskInstance.getInProgressStartTime()).isNotNull();</span>
<span class="nc" id="L437">            assertThat(historicTaskInstance.getInProgressStartedBy()).isEqualTo(&quot;fozzie&quot;);</span>
        }
        
<span class="nc" id="L440">        taskService.complete(task.getId(), &quot;kermit&quot;);</span>
<span class="nc" id="L441">        assertProcessEnded(processInstance.getId());</span>
        
<span class="nc bnc" id="L443" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L444">            HistoricTaskInstance historicTaskInstance = historyService.createHistoricTaskInstanceQuery().taskId(task.getId()).singleResult();</span>
<span class="nc" id="L445">            assertThat(historicTaskInstance.getState()).isEqualTo(Task.COMPLETED);</span>
<span class="nc" id="L446">            assertThat(historicTaskInstance.getEndTime()).isNotNull();</span>
<span class="nc" id="L447">            assertThat(historicTaskInstance.getCompletedBy()).isEqualTo(&quot;kermit&quot;);</span>
        }
<span class="nc" id="L449">    }</span>
    
    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot;)
    public void testTaskWithTimerJob() {
<span class="nc" id="L454">        Map&lt;String, JobHandler&gt; existingJobHandlers = processEngineConfiguration.getJobHandlers();</span>
<span class="nc" id="L455">        Map&lt;String, JobHandler&gt; updatedJobHandlers = new HashMap&lt;&gt;(existingJobHandlers);</span>
<span class="nc" id="L456">        TestBpmnTaskTimerJobHandler testTimerJobHandler = new TestBpmnTaskTimerJobHandler();</span>
<span class="nc" id="L457">        updatedJobHandlers.put(testTimerJobHandler.getType(), testTimerJobHandler);</span>
<span class="nc" id="L458">        processEngineConfiguration.setJobHandlers(updatedJobHandlers);</span>
<span class="nc" id="L459">        processEngineConfiguration.getJobServiceConfiguration().setJobHandlers(updatedJobHandlers);</span>
        
        try {
<span class="nc" id="L462">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
    
<span class="nc" id="L464">            final org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L465">            assertThat(task.getId()).isNotNull();</span>
<span class="nc" id="L466">            assertThat(task.getName()).isEqualTo(&quot;my task&quot;);</span>
<span class="nc" id="L467">            assertThat(task.getPriority()).isEqualTo(50);</span>
            
<span class="nc" id="L469">            managementService.executeCommand(new Command&lt;Void&gt;() {</span>
                
                @Override
                public Void execute(CommandContext commandContext) {
<span class="nc" id="L473">                    TimerJobService timerJobService = processEngineConfiguration.getJobServiceConfiguration().getTimerJobService();</span>
<span class="nc" id="L474">                    TimerJobEntity timerJob = timerJobService.createTimerJob();</span>
<span class="nc" id="L475">                    timerJob.setJobType(JobEntity.JOB_TYPE_TIMER);</span>
<span class="nc" id="L476">                    timerJob.setJobHandlerType(testTimerJobHandler.getType());</span>
<span class="nc" id="L477">                    timerJob.setProcessInstanceId(processInstance.getId());</span>
<span class="nc" id="L478">                    timerJob.setSubScopeId(task.getId());</span>
                    
<span class="nc" id="L480">                    Calendar calendar = processEngineConfiguration.getClock().getCurrentCalendar();</span>
<span class="nc" id="L481">                    calendar.add(Calendar.MINUTE, -60);</span>
<span class="nc" id="L482">                    timerJob.setDuedate(calendar.getTime());</span>
                    
<span class="nc" id="L484">                    timerJobService.scheduleTimerJob(timerJob);</span>
                    
<span class="nc" id="L486">                    return null;</span>
                }
            });
            
<span class="nc" id="L490">            JobTestHelper.waitForJobExecutorToProcessAllJobsAndTimerJobs(processEngineConfiguration, managementService, 5000, 200);</span>
            
<span class="nc" id="L492">            Task updatedTask = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L493">            assertThat(updatedTask.getPriority()).isEqualTo(100);</span>
            
        } finally {
<span class="nc" id="L496">            processEngineConfiguration.setJobHandlers(existingJobHandlers);</span>
<span class="nc" id="L497">            processEngineConfiguration.getJobServiceConfiguration().setJobHandlers(existingJobHandlers);</span>
        }
<span class="nc" id="L499">    }</span>

    @Test
    @Deployment
    public void testTaskNameWithExpression() {
<span class="nc" id="L504">        ProcessInstance processWithoutVariable = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L505">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L506">                .start();</span>

<span class="nc" id="L508">        ProcessInstance processWithVariable = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L509">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L510">                .variable(&quot;testVar&quot;, &quot;Task name&quot;)</span>
<span class="nc" id="L511">                .start();</span>

<span class="nc" id="L513">        Task task = taskService.createTaskQuery().processInstanceId(processWithoutVariable.getId()).singleResult();</span>
<span class="nc" id="L514">        assertThat(task).isNotNull();</span>
<span class="nc" id="L515">        assertThat(task.getName()).isEqualTo(&quot;${testVar}&quot;);</span>

<span class="nc" id="L517">        task = taskService.createTaskQuery().processInstanceId(processWithVariable.getId()).singleResult();</span>
<span class="nc" id="L518">        assertThat(task).isNotNull();</span>
<span class="nc" id="L519">        assertThat(task.getName()).isEqualTo(&quot;Task name&quot;);</span>
<span class="nc" id="L520">    }</span>

<span class="nc" id="L522">    protected class TestCreateUserTaskInterceptor implements CreateUserTaskInterceptor {</span>
        
<span class="nc" id="L524">        protected int beforeCreateUserTaskCounter = 0;</span>
<span class="nc" id="L525">        protected int afterCreateUserTaskCounter = 0;</span>
        
        @Override
        public void beforeCreateUserTask(CreateUserTaskBeforeContext context) {
<span class="nc" id="L529">            beforeCreateUserTaskCounter++;</span>
<span class="nc" id="L530">            context.setCategory(&quot;testCategory&quot;);</span>
<span class="nc" id="L531">        }</span>

        @Override
        public void afterCreateUserTask(CreateUserTaskAfterContext context) {
<span class="nc" id="L535">            afterCreateUserTaskCounter++;</span>
<span class="nc" id="L536">        }</span>

        public int getBeforeCreateUserTaskCounter() {
<span class="nc" id="L539">            return beforeCreateUserTaskCounter;</span>
        }

        public int getAfterCreateUserTaskCounter() {
<span class="nc" id="L543">            return afterCreateUserTaskCounter;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>