<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RuntimeActivityInstanceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.runtime</a> &gt; <span class="el_source">RuntimeActivityInstanceTest.java</span></div><h1>RuntimeActivityInstanceTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.engine.test.api.runtime;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

import java.util.List;

import org.flowable.common.engine.api.FlowableIllegalArgumentException;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.common.engine.impl.util.CollectionUtil;
import org.flowable.engine.history.HistoricActivityInstance;
import org.flowable.engine.history.HistoricProcessInstance;
import org.flowable.engine.impl.persistence.entity.ActivityInstanceEntity;
import org.flowable.engine.impl.test.HistoryTestHelper;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.impl.util.CommandContextUtil;
import org.flowable.engine.runtime.ActivityInstance;
import org.flowable.engine.runtime.ActivityInstanceQuery;
import org.flowable.engine.runtime.Execution;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.task.api.Task;
import org.junit.jupiter.api.Test;

/**
 * @author martin.grofcik
 */
<span class="nc" id="L41">public class RuntimeActivityInstanceTest extends PluggableFlowableTestCase {</span>

    @Test
    @Deployment
    public void testActivityInstanceNoop() {
<span class="nc" id="L46">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;noopProcess&quot;);</span>

<span class="nc" id="L48">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L50">        ActivityInstance activityInstance = runtimeService.createActivityInstanceQuery().activityId(&quot;noop&quot;).singleResult();</span>

<span class="nc" id="L52">        assertThat(activityInstance.getActivityId()).isEqualTo(&quot;noop&quot;);</span>
<span class="nc" id="L53">        assertThat(activityInstance.getActivityType()).isEqualTo(&quot;serviceTask&quot;);</span>
<span class="nc" id="L54">        assertThat(activityInstance.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L55">        assertThat(activityInstance.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L56">        assertThat(activityInstance.getStartTime()).isNotNull();</span>
<span class="nc" id="L57">        assertThat(activityInstance.getEndTime()).isNotNull();</span>
<span class="nc" id="L58">        assertThat(activityInstance.getDurationInMillis()).isGreaterThanOrEqualTo(0);</span>
<span class="nc" id="L59">        assertThat(activityInstance.getTransactionOrder()).isEqualTo(3);</span>

<span class="nc bnc" id="L61" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L62">            assertActivityInstancesAreSame(historyService.createHistoricActivityInstanceQuery().activityId(&quot;noop&quot;).singleResult(), activityInstance);</span>
        }

<span class="nc" id="L65">        String executionId = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).onlyChildExecutions().singleResult().getId();</span>
<span class="nc" id="L66">        this.runtimeService.trigger(executionId);</span>
        
<span class="nc" id="L68">        assertThat(runtimeService.createActivityInstanceQuery().activityId(&quot;noop&quot;).count()).isZero();</span>
<span class="nc" id="L69">    }</span>

    @Test
    @Deployment
    public void testActivityInstanceReceive() {
<span class="nc" id="L74">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;receiveProcess&quot;);</span>

<span class="nc" id="L76">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L78">        ActivityInstance activityInstance = runtimeService.createActivityInstanceQuery().activityId(&quot;receive&quot;).singleResult();</span>

<span class="nc" id="L80">        assertThat(activityInstance.getActivityId()).isEqualTo(&quot;receive&quot;);</span>
<span class="nc" id="L81">        assertThat(activityInstance.getActivityType()).isEqualTo(&quot;receiveTask&quot;);</span>
<span class="nc" id="L82">        assertThat(activityInstance.getEndTime()).isNull();</span>
<span class="nc" id="L83">        assertThat(activityInstance.getDurationInMillis()).isNull();</span>
<span class="nc" id="L84">        assertThat(activityInstance.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L85">        assertThat(activityInstance.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L86">        assertThat(activityInstance.getStartTime()).isNotNull();</span>
<span class="nc" id="L87">        assertThat(activityInstance.getTransactionOrder()).isEqualTo(3);</span>

<span class="nc bnc" id="L89" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L90">            HistoricActivityInstance historicActivityInstance = historyService.createHistoricActivityInstanceQuery().activityId(&quot;receive&quot;).singleResult();</span>
<span class="nc" id="L91">            assertActivityInstancesAreSame(historicActivityInstance, activityInstance);</span>
        }

<span class="nc" id="L94">        Execution execution = runtimeService.createExecutionQuery().onlyChildExecutions().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L95">        runtimeService.trigger(execution.getId());</span>

<span class="nc" id="L97">        activityInstance = runtimeService.createActivityInstanceQuery().activityId(&quot;receive&quot;).singleResult();</span>

<span class="nc" id="L99">        assertThat(activityInstance.getActivityId()).isEqualTo(&quot;receive&quot;);</span>
<span class="nc" id="L100">        assertThat(activityInstance.getActivityType()).isEqualTo(&quot;receiveTask&quot;);</span>
<span class="nc" id="L101">        assertThat(activityInstance.getEndTime()).isNotNull();</span>
<span class="nc" id="L102">        assertThat(activityInstance.getDurationInMillis()).isGreaterThanOrEqualTo(0);</span>
<span class="nc" id="L103">        assertThat(activityInstance.getProcessDefinitionId()).isNotNull();</span>
<span class="nc" id="L104">        assertThat(activityInstance.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L105">        assertThat(activityInstance.getStartTime()).isNotNull();</span>

<span class="nc" id="L107">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L109">            assertActivityInstancesAreSame(historyService.createHistoricActivityInstanceQuery().activityId(&quot;receive&quot;).singleResult(), activityInstance);</span>
        }

<span class="nc" id="L112">        runtimeService.trigger(execution.getId());</span>

<span class="nc" id="L114">        assertThat(runtimeService.createActivityInstanceQuery().count()).isZero();</span>
<span class="nc" id="L115">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/history/oneTaskProcess.bpmn20.xml&quot;)
    public void testActivityInstanceUnfinished() {
<span class="nc" id="L120">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L121">        assertThat(processInstance).isNotNull();</span>
        
<span class="nc" id="L123">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L125">        ActivityInstanceQuery activityInstanceQuery = runtimeService.createActivityInstanceQuery();</span>

<span class="nc" id="L127">        long finishedActivityInstanceCount = activityInstanceQuery.finished().count();</span>
<span class="nc" id="L128">        assertThat(finishedActivityInstanceCount).as(&quot;The Start event and sequenceFlow are completed&quot;).isEqualTo(2);</span>

<span class="nc" id="L130">        long unfinishedActivityInstanceCount = activityInstanceQuery.unfinished().count();</span>
<span class="nc" id="L131">        assertThat(unfinishedActivityInstanceCount).as(&quot;One active (unfinished) User org.flowable.task.service.Task&quot;).isEqualTo(1);</span>
<span class="nc" id="L132">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/history/oneTaskProcess.bpmn20.xml&quot;)
    public void testSequenceFlowActivityInstance() {
<span class="nc" id="L137">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L138">        assertThat(processInstance).isNotNull();</span>

<span class="nc" id="L140">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L142">        ActivityInstance sequenceFlow = runtimeService.createActivityInstanceQuery().activityType(&quot;sequenceFlow&quot;).singleResult();</span>
<span class="nc" id="L143">        assertThat(sequenceFlow.getActivityId()).isEqualTo(&quot;flow1&quot;);</span>
<span class="nc" id="L144">        assertThat(sequenceFlow.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L145">        assertThat(sequenceFlow.getProcessDefinitionId()).isEqualTo(processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L146">        assertThat(sequenceFlow.getExecutionId()).isNotNull();</span>
<span class="nc" id="L147">        assertThat(sequenceFlow.getStartTime()).isNotNull();</span>
<span class="nc" id="L148">        assertThat(sequenceFlow.getEndTime()).isEqualTo(sequenceFlow.getStartTime());</span>
<span class="nc" id="L149">        assertThat(sequenceFlow.getDurationInMillis()).isZero();</span>
<span class="nc" id="L150">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/history/oneTaskProcessWithoutSequenceFlowIds.bpmn20.xml&quot;)
    public void testSequenceFlowActivityInstanceWithoutSequenceFlowId() {
<span class="nc" id="L155">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcessWithoutSequenceFlowIds&quot;);</span>
<span class="nc" id="L156">        assertThat(processInstance).isNotNull();</span>

<span class="nc" id="L158">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L160">        ActivityInstance sequenceFlow = runtimeService.createActivityInstanceQuery().activityType(&quot;sequenceFlow&quot;).singleResult();</span>
<span class="nc" id="L161">        assertThat(sequenceFlow.getActivityId()).isEqualTo(&quot;_flow_theStart__theTask&quot;);</span>
<span class="nc" id="L162">    }</span>

    @Test
    @Deployment(resources= &quot;org/flowable/engine/test/api/runtime/RuntimeActivityInstanceTest.testActivityInstanceNoop.bpmn20.xml&quot;)
    public void testActivityInstanceQuery() {
<span class="nc" id="L167">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;noopProcess&quot;);</span>

<span class="nc" id="L169">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L171">        assertThat(runtimeService.createActivityInstanceQuery().activityId(&quot;nonExistingActivityId&quot;).list()).isEmpty();</span>
<span class="nc" id="L172">        assertThat(runtimeService.createActivityInstanceQuery().activityId(&quot;noop&quot;).list()).hasSize(1);</span>

<span class="nc" id="L174">        assertThat(runtimeService.createActivityInstanceQuery().activityType(&quot;nonExistingActivityType&quot;).list()).isEmpty();</span>
<span class="nc" id="L175">        assertThat(runtimeService.createActivityInstanceQuery().activityType(&quot;serviceTask&quot;).list()).hasSize(1);</span>

<span class="nc" id="L177">        assertThat(runtimeService.createActivityInstanceQuery().activityName(&quot;nonExistingActivityName&quot;).list()).isEmpty();</span>
<span class="nc" id="L178">        assertThat(runtimeService.createActivityInstanceQuery().activityName(&quot;No operation&quot;).list()).hasSize(1);</span>

<span class="nc" id="L180">        assertThat(runtimeService.createActivityInstanceQuery().taskAssignee(&quot;nonExistingAssignee&quot;).list()).isEmpty();</span>

<span class="nc" id="L182">        assertThat(runtimeService.createActivityInstanceQuery().executionId(&quot;nonExistingExecutionId&quot;).list()).isEmpty();</span>

<span class="nc" id="L184">        assertThat(runtimeService.createActivityInstanceQuery().processInstanceId(processInstance.getId()).list()).hasSize(5);</span>

<span class="nc" id="L186">        assertThat(runtimeService.createActivityInstanceQuery().processInstanceId(&quot;nonExistingProcessInstanceId&quot;).list()).isEmpty();</span>

<span class="nc" id="L188">        assertThat(runtimeService.createActivityInstanceQuery().processInstanceId(processInstance.getId()).list()).hasSize(5);</span>

<span class="nc" id="L190">        assertThat(runtimeService.createActivityInstanceQuery().processDefinitionId(&quot;nonExistingProcessDefinitionId&quot;).list()).isEmpty();</span>

<span class="nc" id="L192">        assertThat(runtimeService.createActivityInstanceQuery().processDefinitionId(processInstance.getProcessDefinitionId()).list()).hasSize(5);</span>

<span class="nc" id="L194">        assertThat(runtimeService.createActivityInstanceQuery().unfinished().list()).hasSize(1);</span>

<span class="nc" id="L196">        assertThat(runtimeService.createActivityInstanceQuery().finished().list()).hasSize(4);</span>

<span class="nc" id="L198">        ActivityInstance activityInstance = runtimeService.createActivityInstanceQuery().list().get(0);</span>
<span class="nc" id="L199">        assertThat(runtimeService.createActivityInstanceQuery().activityInstanceId(activityInstance.getId()).list()).hasSize(1);</span>
<span class="nc" id="L200">    }</span>

    @Test
    @Deployment
    public void testActivityInstanceForEventsQuery() {
<span class="nc" id="L205">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;eventProcess&quot;);</span>
<span class="nc" id="L206">        assertThat(taskService.createTaskQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L207">        runtimeService.signalEventReceived(&quot;signal&quot;);</span>

<span class="nc" id="L209">        assertThatActivityInstancesAreSame(&quot;noop&quot;);</span>
<span class="nc" id="L210">        assertThatActivityInstancesAreSame(&quot;userTask&quot;);</span>
<span class="nc" id="L211">        assertThatActivityInstancesAreSame(&quot;intermediate-event&quot;);</span>
<span class="nc" id="L212">        assertThatActivityInstancesAreSame(&quot;start&quot;);</span>

<span class="nc" id="L214">        assertThatActivityInstancesAreSame(&quot;intermediate-event&quot;);</span>

<span class="nc" id="L216">        assertThatActivityInstancesAreSame(&quot;start&quot;);</span>

<span class="nc" id="L218">        runtimeService.trigger(runtimeService.createExecutionQuery().processInstanceId(pi.getId()).onlyChildExecutions().singleResult().getId());</span>

<span class="nc" id="L220">        assertThat(runtimeService.createActivityInstanceQuery().processInstanceId(pi.getId()).count()).isZero();</span>
<span class="nc" id="L221">    }</span>

    protected void assertThatActivityInstancesAreSame(String userTask) {
<span class="nc bnc" id="L224" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L225">            assertActivityInstancesAreSame(historyService.createHistoricActivityInstanceQuery().activityId(userTask).singleResult(),</span>
<span class="nc" id="L226">                runtimeService.createActivityInstanceQuery().activityId(userTask).singleResult());</span>
        }
<span class="nc" id="L228">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/history/HistoricActivityInstanceTest.testHistoricActivityInstanceProperties.bpmn20.xml&quot;)
    public void testActivityInstanceProperties() {
        // Start process instance
<span class="nc" id="L234">        runtimeService.startProcessInstanceByKey(&quot;taskAssigneeProcess&quot;);</span>

        // Get task list
<span class="nc" id="L237">        ActivityInstance activityInstance = runtimeService.createActivityInstanceQuery().activityId(&quot;theTask&quot;).singleResult();</span>

<span class="nc" id="L239">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L240">        assertThat(activityInstance.getTaskId()).isEqualTo(task.getId());</span>
<span class="nc" id="L241">        assertThat(activityInstance.getAssignee()).isEqualTo(&quot;kermit&quot;);</span>
<span class="nc" id="L242">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/history/calledProcess.bpmn20.xml&quot;, &quot;org/flowable/engine/test/history/HistoricActivityInstanceTest.testCallSimpleSubProcess.bpmn20.xml&quot; })
    public void processInstanceEndRemovesAllActivityInstances() {
<span class="nc" id="L247">        runtimeService.startProcessInstanceByKey(&quot;callSimpleSubProcess&quot;);</span>

<span class="nc" id="L249">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L251">        assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>
<span class="nc" id="L252">        assertThat(runtimeService.createActivityInstanceQuery().count()).isZero();</span>
<span class="nc" id="L253">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/history/calledProcess.bpmn20.xml&quot;, &quot;org/flowable/engine/test/api/runtime/RuntimeActivityInstanceTest.testCallSimpleSubProcess.bpmn20.xml&quot; })
    public void testActivityInstanceCalledProcessId() {
<span class="nc" id="L258">        runtimeService.startProcessInstanceByKey(&quot;callSimpleSubProcess&quot;);</span>

<span class="nc" id="L260">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L262">        ActivityInstance activityInstance = runtimeService.createActivityInstanceQuery().activityId(&quot;callSubProcess&quot;).singleResult();</span>

<span class="nc bnc" id="L264" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L265">            HistoricActivityInstance historicActivityInstance = historyService.createHistoricActivityInstanceQuery().activityId(&quot;callSubProcess&quot;).singleResult();</span>
<span class="nc" id="L266">            assertActivityInstancesAreSame(historicActivityInstance, activityInstance);</span>

<span class="nc" id="L268">            HistoricProcessInstance oldInstance = historyService.createHistoricProcessInstanceQuery().processDefinitionKey(&quot;calledProcess&quot;).singleResult();</span>

<span class="nc" id="L270">            assertThat(activityInstance.getCalledProcessInstanceId()).isEqualTo(oldInstance.getId());</span>
        }
<span class="nc" id="L272">    }</span>

    @Test
    @Deployment
    public void testSorting() {
<span class="nc" id="L277">        runtimeService.startProcessInstanceByKey(&quot;process&quot;);</span>

<span class="nc" id="L279">        int expectedActivityInstances = 3;</span>

<span class="nc" id="L281">        assertThat(runtimeService.createActivityInstanceQuery().orderByActivityInstanceId().asc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L282">        assertThat(runtimeService.createActivityInstanceQuery().orderByActivityInstanceStartTime().asc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L283">        assertThat(runtimeService.createActivityInstanceQuery().orderByActivityInstanceEndTime().asc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L284">        assertThat(runtimeService.createActivityInstanceQuery().orderByActivityInstanceDuration().asc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L285">        assertThat(runtimeService.createActivityInstanceQuery().orderByExecutionId().asc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L286">        assertThat(runtimeService.createActivityInstanceQuery().orderByProcessDefinitionId().asc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L287">        assertThat(runtimeService.createActivityInstanceQuery().orderByProcessInstanceId().asc().list()).hasSize(expectedActivityInstances);</span>

<span class="nc" id="L289">        assertThat(runtimeService.createActivityInstanceQuery().orderByActivityInstanceId().desc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L290">        assertThat(runtimeService.createActivityInstanceQuery().orderByActivityInstanceStartTime().desc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L291">        assertThat(runtimeService.createActivityInstanceQuery().orderByActivityInstanceEndTime().desc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L292">        assertThat(runtimeService.createActivityInstanceQuery().orderByActivityInstanceDuration().desc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L293">        assertThat(runtimeService.createActivityInstanceQuery().orderByExecutionId().desc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L294">        assertThat(runtimeService.createActivityInstanceQuery().orderByProcessDefinitionId().desc().list()).hasSize(expectedActivityInstances);</span>
<span class="nc" id="L295">        assertThat(runtimeService.createActivityInstanceQuery().orderByProcessInstanceId().desc().list()).hasSize(expectedActivityInstances);</span>

<span class="nc" id="L297">        assertThat(runtimeService.createActivityInstanceQuery().orderByActivityInstanceId().asc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L298">        assertThat(runtimeService.createActivityInstanceQuery().orderByActivityInstanceStartTime().asc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L299">        assertThat(runtimeService.createActivityInstanceQuery().orderByActivityInstanceEndTime().asc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L300">        assertThat(runtimeService.createActivityInstanceQuery().orderByActivityInstanceDuration().asc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L301">        assertThat(runtimeService.createActivityInstanceQuery().orderByExecutionId().asc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L302">        assertThat(runtimeService.createActivityInstanceQuery().orderByProcessDefinitionId().asc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L303">        assertThat(runtimeService.createActivityInstanceQuery().orderByProcessInstanceId().asc().count()).isEqualTo(expectedActivityInstances);</span>

<span class="nc" id="L305">        assertThat(runtimeService.createActivityInstanceQuery().orderByActivityInstanceId().desc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L306">        assertThat(runtimeService.createActivityInstanceQuery().orderByActivityInstanceStartTime().desc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L307">        assertThat(runtimeService.createActivityInstanceQuery().orderByActivityInstanceEndTime().desc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L308">        assertThat(runtimeService.createActivityInstanceQuery().orderByActivityInstanceDuration().desc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L309">        assertThat(runtimeService.createActivityInstanceQuery().orderByExecutionId().desc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L310">        assertThat(runtimeService.createActivityInstanceQuery().orderByProcessDefinitionId().desc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L311">        assertThat(runtimeService.createActivityInstanceQuery().orderByProcessInstanceId().desc().count()).isEqualTo(expectedActivityInstances);</span>
<span class="nc" id="L312">    }</span>

    @Test
    public void testInvalidSorting() {
<span class="nc" id="L316">        assertThatThrownBy(() -&gt; runtimeService.createActivityInstanceQuery().asc().list())</span>
<span class="nc" id="L317">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>

<span class="nc" id="L319">        assertThatThrownBy(() -&gt; runtimeService.createActivityInstanceQuery().desc().list())</span>
<span class="nc" id="L320">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>

<span class="nc" id="L322">        assertThatThrownBy(() -&gt; runtimeService.createActivityInstanceQuery().orderByActivityInstanceDuration().list())</span>
<span class="nc" id="L323">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L324">    }</span>

    @Test
    @Deployment
    public void testBoundaryEvent() {
<span class="nc" id="L329">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;boundaryEventProcess&quot;);</span>
        // Complete the task with the boundary-event on it
<span class="nc" id="L331">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L332">        assertThat(task).isNotNull();</span>
<span class="nc" id="L333">        taskService.complete(task.getId());</span>

<span class="nc" id="L335">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).count()).isZero();</span>

<span class="nc" id="L337">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L339">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).count()).isZero();</span>

        // Now check the history when the boundary-event is fired
<span class="nc" id="L342">        processInstance = runtimeService.startProcessInstanceByKey(&quot;boundaryEventProcess&quot;);</span>

<span class="nc" id="L344">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

<span class="nc" id="L346">        Execution signalExecution = runtimeService.createExecutionQuery().signalEventSubscriptionName(&quot;alert&quot;).singleResult();</span>
<span class="nc" id="L347">        runtimeService.signalEventReceived(&quot;alert&quot;, signalExecution.getId());</span>
<span class="nc" id="L348">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(1);</span>

<span class="nc" id="L350">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L352">        ActivityInstance activityInstance = runtimeService.createActivityInstanceQuery().activityId(&quot;boundary&quot;).processInstanceId(processInstance.getId())</span>
<span class="nc" id="L353">                .singleResult();</span>

<span class="nc" id="L355">        assertThat(activityInstance).isNotNull();</span>
<span class="nc" id="L356">        assertThat(activityInstance.getStartTime()).isNotNull();</span>
<span class="nc" id="L357">        assertThat(activityInstance.getEndTime()).isNotNull();</span>

<span class="nc bnc" id="L359" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L360">            assertActivityInstancesAreSame(historyService.createHistoricActivityInstanceQuery().activityId(&quot;boundary&quot;)</span>
<span class="nc" id="L361">                    .processInstanceId(processInstance.getId()).singleResult(), activityInstance);</span>
        }
<span class="nc" id="L363">    }</span>

    @Test
    @Deployment
    public void testEventBasedGateway() {
<span class="nc" id="L368">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;catchSignal&quot;);</span>
<span class="nc" id="L369">        Execution waitingExecution = runtimeService.createExecutionQuery().signalEventSubscriptionName(&quot;alert&quot;).singleResult();</span>
<span class="nc" id="L370">        assertThat(waitingExecution).isNotNull();</span>
<span class="nc" id="L371">        runtimeService.signalEventReceived(&quot;alert&quot;, waitingExecution.getId());</span>

<span class="nc" id="L373">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(1);</span>
        
<span class="nc" id="L375">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L377">        assertThatActivityInstancesAreSame(&quot;eventBasedgateway&quot;);</span>
<span class="nc" id="L378">    }</span>

    /**
     * Test to validate fix for ACT-1549: endTime of joining parallel gateway is not set
     */
    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/history/HistoricActivityInstanceTest.testParallelJoinEndTime.bpmn20.xml&quot;)
    public void testParallelJoinEndTime() {
<span class="nc" id="L386">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;forkJoin&quot;);</span>

<span class="nc" id="L388">        List&lt;org.flowable.task.api.Task&gt; tasksToComplete = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L389">        assertThat(tasksToComplete).hasSize(2);</span>

        // Complete both tasks, second task-complete should end the fork-gateway and set time
<span class="nc" id="L392">        taskService.complete(tasksToComplete.get(0).getId());</span>
<span class="nc" id="L393">        taskService.complete(tasksToComplete.get(1).getId());</span>

<span class="nc" id="L395">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L397">        List&lt;ActivityInstance&gt; activityInstance = runtimeService.createActivityInstanceQuery().activityId(&quot;join&quot;).processInstanceId(processInstance.getId())</span>
<span class="nc" id="L398">                .list();</span>

        // History contains 2 entries for parallel join (one for each path
        // arriving in the join), should contain end-time
<span class="nc" id="L402">        assertThat(activityInstance).hasSize(2);</span>
<span class="nc" id="L403">        assertThat(activityInstance)</span>
<span class="nc" id="L404">                .flatExtracting(ActivityInstance::getEndTime)</span>
<span class="nc" id="L405">                .doesNotContainNull();</span>
<span class="nc" id="L406">    }</span>

    @Test
    @Deployment
    public void testLoop() {
<span class="nc" id="L411">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;historic-activity-loops&quot;, CollectionUtil.singletonMap(&quot;input&quot;, 0));</span>

        // completing 10 user tasks
        // 15 service tasks should have passed

<span class="nc bnc" id="L416" title="All 2 branches missed.">        for (int i = 0; i &lt; 10; i++) {</span>
<span class="nc" id="L417">            org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L418">            Number inputNumber = (Number) taskService.getVariable(task.getId(), &quot;input&quot;);</span>
<span class="nc" id="L419">            int input = inputNumber.intValue();</span>
<span class="nc" id="L420">            assertThat(input).isEqualTo(i);</span>
<span class="nc" id="L421">            taskService.complete(task.getId(), CollectionUtil.singletonMap(&quot;input&quot;, input + 1));</span>
<span class="nc" id="L422">            task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
        }

<span class="nc" id="L425">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

        // Verify history
<span class="nc" id="L428">        List&lt;ActivityInstance&gt; taskActivityInstances = runtimeService.createActivityInstanceQuery().activityType(&quot;userTask&quot;).list();</span>
<span class="nc" id="L429">        assertThat(taskActivityInstances).hasSize(10);</span>
<span class="nc" id="L430">        assertThat(taskActivityInstances)</span>
<span class="nc" id="L431">                .flatExtracting(ActivityInstance::getEndTime, ActivityInstance::getEndTime)</span>
<span class="nc" id="L432">                .doesNotContainNull();</span>

<span class="nc" id="L434">        List&lt;ActivityInstance&gt; serviceTaskInstances = runtimeService.createActivityInstanceQuery().activityType(&quot;serviceTask&quot;).list();</span>
<span class="nc" id="L435">        assertThat(serviceTaskInstances).hasSize(15);</span>
<span class="nc" id="L436">        assertThat(taskActivityInstances)</span>
<span class="nc" id="L437">                .flatExtracting(ActivityInstance::getEndTime, ActivityInstance::getEndTime)</span>
<span class="nc" id="L438">                .doesNotContainNull();</span>
<span class="nc" id="L439">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testNativeActivityInstanceTest() {
<span class="nc" id="L444">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L445">        HistoryTestHelper.waitForJobExecutorToProcessAllHistoryJobs(processEngineConfiguration, managementService, 7000, 200);</span>
<span class="nc" id="L446">        assertThat(</span>
<span class="nc" id="L447">                runtimeService.createNativeActivityInstanceQuery().sql(&quot;SELECT count(*) FROM &quot; + managementService.getTableName(ActivityInstanceEntity.class))</span>
<span class="nc" id="L448">                        .count()).isEqualTo(3);</span>
<span class="nc" id="L449">        assertThat(</span>
<span class="nc" id="L450">                runtimeService.createNativeActivityInstanceQuery().sql(&quot;SELECT * FROM &quot; + managementService.getTableName(ActivityInstanceEntity.class)).list())</span>
<span class="nc" id="L451">                .hasSize(3);</span>
<span class="nc" id="L452">        assertThat(runtimeService.createNativeActivityInstanceQuery().sql(&quot;SELECT * FROM &quot; + managementService.getTableName(ActivityInstanceEntity.class))</span>
<span class="nc" id="L453">                .listPage(0, 1)).hasSize(1);</span>
<span class="nc" id="L454">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/history/oneTaskProcess.bpmn20.xml&quot;)
    public void upgradeFromHistoryToRuntimeActivities_completeTask() {
<span class="nc" id="L459">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L460">        assertThat(processInstance).isNotNull();</span>

<span class="nc" id="L462">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L464">        managementService.executeCommand(commandContext -&gt; {</span>
<span class="nc" id="L465">            CommandContextUtil.getActivityInstanceEntityManager(commandContext).deleteActivityInstancesByProcessInstanceId(processInstance.getId());</span>
<span class="nc" id="L466">            return null;</span>
        });

<span class="nc" id="L469">        taskService.complete(taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult().getId());</span>

<span class="nc" id="L471">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L472">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/history/oneTaskProcess.bpmn20.xml&quot;)
    public void upgradeFromHistoryToRuntimeActivities_changeAssignee() {
<span class="nc" id="L477">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L478">        assertThat(processInstance).isNotNull();</span>

<span class="nc" id="L480">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
        
<span class="nc" id="L482">        HistoryTestHelper.waitForJobExecutorToProcessAllHistoryJobs(processEngineConfiguration, managementService, 10000, 200);</span>

<span class="nc" id="L484">        managementService.executeCommand(commandContext -&gt; {</span>
<span class="nc" id="L485">            CommandContextUtil.getActivityInstanceEntityManager(commandContext).deleteActivityInstancesByProcessInstanceId(processInstance.getId());</span>
<span class="nc" id="L486">            return null;</span>
        });

<span class="nc" id="L489">        taskService.claim(task.getId(), &quot;newAssignee&quot;);</span>

<span class="nc" id="L491">        assertThatActivityInstancesAreSame(&quot;theTask&quot;);</span>
<span class="nc" id="L492">        taskService.complete(task.getId());</span>

<span class="nc" id="L494">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L495">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/history/oneTaskProcess.bpmn20.xml&quot;)
    public void upgradeFromHistoryToRuntimeActivities_changeOwner() {
<span class="nc" id="L500">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L501">        assertThat(processInstance).isNotNull();</span>

<span class="nc" id="L503">        waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

<span class="nc" id="L505">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>

<span class="nc" id="L507">        managementService.executeCommand(commandContext -&gt; {</span>
<span class="nc" id="L508">            CommandContextUtil.getActivityInstanceEntityManager(commandContext).deleteActivityInstancesByProcessInstanceId(processInstance.getId());</span>
<span class="nc" id="L509">            return null;</span>
        });

<span class="nc" id="L512">        taskService.setOwner(task.getId(), &quot;newOwner&quot;);</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L514">            assertThat(historyService.createHistoricActivityInstanceQuery().processInstanceId(processInstance.getId()).activityId(&quot;theTask&quot;).count())</span>
<span class="nc" id="L515">                    .isEqualTo(1);</span>
        }

<span class="nc" id="L518">        taskService.complete(task.getId());</span>

<span class="nc" id="L520">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L521">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcessWithExpression.bpmn20.xml&quot; })
    public void testActivityNameIsResolved() {
<span class="nc" id="L526">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L527">                .variable(&quot;testVar&quot;, &quot;someTestValue&quot;).start();</span>
<span class="nc" id="L528">        ActivityInstance taskActivity = runtimeService.createActivityInstanceQuery().activityId(&quot;theTask&quot;).processInstanceId(processInstance.getId())</span>
<span class="nc" id="L529">                .singleResult();</span>
<span class="nc" id="L530">        assertThat(taskActivity.getActivityName()).isEqualTo(&quot;someTestValue&quot;);</span>

<span class="nc" id="L532">        ActivityInstance flowActivityInstance = runtimeService.createActivityInstanceQuery().processInstanceId(processInstance.getId()).activityId(&quot;flow1&quot;)</span>
<span class="nc" id="L533">                .singleResult();</span>

<span class="nc" id="L535">        assertThat(flowActivityInstance.getActivityName()).isEqualTo(&quot;someTestValue&quot;);</span>

<span class="nc" id="L537">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/ServiceTaskWithNameExpression.bpmn20.xml&quot; })
    public void testServiceTaskWithNameExpression() {
<span class="nc" id="L542">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;noopProcess&quot;)</span>
<span class="nc" id="L543">                .variable(&quot;testVar&quot;, &quot;someTestValue&quot;).start();</span>
<span class="nc" id="L544">        ActivityInstance taskActivity = runtimeService.createActivityInstanceQuery().activityId(&quot;noop&quot;).processInstanceId(processInstance.getId())</span>
<span class="nc" id="L545">                .singleResult();</span>
<span class="nc" id="L546">        assertThat(taskActivity.getActivityName()).isEqualTo(&quot;someTestValue&quot;);</span>


<span class="nc" id="L549">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/oneTaskProcessWithBeanExpression.bpmn20.xml&quot;)
    public void testTaskNameExpressionIsNotResolvedTwice() {
<span class="nc" id="L554">        NameProvider nameProvider = new NameProvider();</span>
<span class="nc" id="L555">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().transientVariable(&quot;nameProvider&quot;, nameProvider)</span>
<span class="nc" id="L556">                .processDefinitionKey(&quot;oneTaskProcess&quot;).start();</span>
<span class="nc" id="L557">        ActivityInstance taskActivity = runtimeService.createActivityInstanceQuery().activityId(&quot;theTask&quot;).processInstanceId(processInstance.getId())</span>
<span class="nc" id="L558">                .singleResult();</span>
<span class="nc" id="L559">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
        
<span class="nc" id="L561">        assertThat(taskActivity.getActivityName()).isEqualTo(&quot;someName&quot;);</span>
<span class="nc" id="L562">        assertThat(task.getName()).isEqualTo(&quot;someName&quot;);</span>
<span class="nc" id="L563">        assertThat(nameProvider.getCounter()).isEqualTo(1);</span>

<span class="nc" id="L565">    }</span>

<span class="nc" id="L567">    public static class NameProvider {</span>

<span class="nc" id="L569">        int counter = 0;</span>

        public String getName() {
<span class="nc" id="L572">            counter++;</span>
<span class="nc" id="L573">            return &quot;someName&quot;;</span>
        }

        public int getCounter() {
<span class="nc" id="L577">            return counter;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>