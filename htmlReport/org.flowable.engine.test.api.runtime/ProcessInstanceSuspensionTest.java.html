<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProcessInstanceSuspensionTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.runtime</a> &gt; <span class="el_source">ProcessInstanceSuspensionTest.java</span></div><h1>ProcessInstanceSuspensionTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.engine.test.api.runtime;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

import java.util.Arrays;
import java.util.Date;
import java.util.HashMap;
import java.util.List;

import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.api.FlowableIllegalArgumentException;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.repository.ProcessDefinition;
import org.flowable.engine.runtime.Execution;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.identitylink.api.IdentityLinkType;
import org.flowable.job.api.Job;
import org.junit.jupiter.api.Test;

/**
 * @author Daniel Meyer
 * @author Joram Barrez
 */
<span class="nc" id="L38">public class ProcessInstanceSuspensionTest extends PluggableFlowableTestCase {</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/oneTaskProcess.bpmn20.xml&quot; })
    public void testProcessInstanceActiveByDefault() {

<span class="nc" id="L44">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span>
<span class="nc" id="L45">        runtimeService.startProcessInstanceByKey(processDefinition.getKey());</span>

<span class="nc" id="L47">        ProcessInstance processInstance = runtimeService.createProcessInstanceQuery().singleResult();</span>
<span class="nc" id="L48">        assertThat(processInstance.isSuspended()).isFalse();</span>

<span class="nc" id="L50">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/oneTaskProcess.bpmn20.xml&quot; })
    public void testSuspendActivateProcessInstance() {
<span class="nc" id="L55">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span>
<span class="nc" id="L56">        runtimeService.startProcessInstanceByKey(processDefinition.getKey());</span>

<span class="nc" id="L58">        ProcessInstance processInstance = runtimeService.createProcessInstanceQuery().singleResult();</span>
<span class="nc" id="L59">        assertThat(processInstance.isSuspended()).isFalse();</span>

        // suspend
<span class="nc" id="L62">        runtimeService.suspendProcessInstanceById(processInstance.getId());</span>
<span class="nc" id="L63">        processInstance = runtimeService.createProcessInstanceQuery().singleResult();</span>
<span class="nc" id="L64">        assertThat(processInstance.isSuspended()).isTrue();</span>

        // activate
<span class="nc" id="L67">        runtimeService.activateProcessInstanceById(processInstance.getId());</span>
<span class="nc" id="L68">        processInstance = runtimeService.createProcessInstanceQuery().singleResult();</span>
<span class="nc" id="L69">        assertThat(processInstance.isSuspended()).isFalse();</span>
<span class="nc" id="L70">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/oneTaskProcess.bpmn20.xml&quot; })
    public void testCannotActivateActiveProcessInstance() {
<span class="nc" id="L75">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span>
<span class="nc" id="L76">        runtimeService.startProcessInstanceByKey(processDefinition.getKey());</span>

<span class="nc" id="L78">        ProcessInstance processInstance = runtimeService.createProcessInstanceQuery().singleResult();</span>
<span class="nc" id="L79">        assertThat(processInstance.isSuspended()).isFalse();</span>

<span class="nc" id="L81">        assertThatThrownBy(() -&gt; runtimeService.activateProcessInstanceById(processInstance.getId()))</span>
<span class="nc" id="L82">                .isExactlyInstanceOf(FlowableException.class);</span>
<span class="nc" id="L83">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/oneTaskProcess.bpmn20.xml&quot; })
    public void testCannotSuspendSuspendedProcessInstance() {
<span class="nc" id="L88">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span>
<span class="nc" id="L89">        runtimeService.startProcessInstanceByKey(processDefinition.getKey());</span>

<span class="nc" id="L91">        ProcessInstance processInstance = runtimeService.createProcessInstanceQuery().singleResult();</span>
<span class="nc" id="L92">        assertThat(processInstance.isSuspended()).isFalse();</span>

<span class="nc" id="L94">        runtimeService.suspendProcessInstanceById(processInstance.getId());</span>

<span class="nc" id="L96">        assertThatThrownBy(() -&gt; runtimeService.suspendProcessInstanceById(processInstance.getId()))</span>
<span class="nc" id="L97">                .isExactlyInstanceOf(FlowableException.class);</span>
<span class="nc" id="L98">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/superProcessWithMultipleNestedSubProcess.bpmn20.xml&quot;, &quot;org/flowable/engine/test/api/runtime/nestedSubProcess.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/runtime/subProcess.bpmn20.xml&quot; })
    public void testQueryForActiveAndSuspendedProcessInstances() {
<span class="nc" id="L104">        runtimeService.startProcessInstanceByKey(&quot;nestedSubProcessQueryTest&quot;);</span>

<span class="nc" id="L106">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(5);</span>
<span class="nc" id="L107">        assertThat(runtimeService.createProcessInstanceQuery().active().count()).isEqualTo(5);</span>
<span class="nc" id="L108">        assertThat(runtimeService.createProcessInstanceQuery().suspended().count()).isZero();</span>

<span class="nc" id="L110">        ProcessInstance piToSuspend = runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;nestedSubProcessQueryTest&quot;).singleResult();</span>
<span class="nc" id="L111">        runtimeService.suspendProcessInstanceById(piToSuspend.getId());</span>

<span class="nc" id="L113">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(5);</span>
<span class="nc" id="L114">        assertThat(runtimeService.createProcessInstanceQuery().active().count()).isEqualTo(4);</span>
<span class="nc" id="L115">        assertThat(runtimeService.createProcessInstanceQuery().suspended().count()).isEqualTo(1);</span>

<span class="nc" id="L117">        assertThat(runtimeService.createProcessInstanceQuery().suspended().singleResult().getId()).isEqualTo(piToSuspend.getId());</span>
<span class="nc" id="L118">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/oneTaskProcess.bpmn20.xml&quot; })
    public void testTaskSuspendedAfterProcessInstanceSuspension() {

        // Start Process Instance
<span class="nc" id="L125">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span>
<span class="nc" id="L126">        runtimeService.startProcessInstanceByKey(processDefinition.getKey());</span>
<span class="nc" id="L127">        ProcessInstance processInstance = runtimeService.createProcessInstanceQuery().singleResult();</span>

        // Suspense process instance
<span class="nc" id="L130">        runtimeService.suspendProcessInstanceById(processInstance.getId());</span>

        // Assert that the task is now also suspended
<span class="nc" id="L133">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">        for (org.flowable.task.api.Task task : tasks) {</span>
<span class="nc" id="L135">            assertThat(task.isSuspended()).isTrue();</span>
<span class="nc" id="L136">        }</span>

        // Activate process instance again
<span class="nc" id="L139">        runtimeService.activateProcessInstanceById(processInstance.getId());</span>
<span class="nc" id="L140">        tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        for (org.flowable.task.api.Task task : tasks) {</span>
<span class="nc" id="L142">            assertThat(task.isSuspended()).isFalse();</span>
<span class="nc" id="L143">        }</span>
<span class="nc" id="L144">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testTaskQueryAfterProcessInstanceSuspend() {
<span class="nc" id="L149">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span>
<span class="nc" id="L150">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(processDefinition.getId());</span>

<span class="nc" id="L152">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L153">        assertThat(task).isNotNull();</span>

<span class="nc" id="L155">        task = taskService.createTaskQuery().active().singleResult();</span>
<span class="nc" id="L156">        assertThat(task).isNotNull();</span>

        // Suspend
<span class="nc" id="L159">        runtimeService.suspendProcessInstanceById(processInstance.getId());</span>
<span class="nc" id="L160">        assertThat(taskService.createTaskQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L161">        assertThat(taskService.createTaskQuery().suspended().count()).isEqualTo(1);</span>
<span class="nc" id="L162">        assertThat(taskService.createTaskQuery().active().count()).isZero();</span>

        // Activate
<span class="nc" id="L165">        runtimeService.activateProcessInstanceById(processInstance.getId());</span>
<span class="nc" id="L166">        assertThat(taskService.createTaskQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L167">        assertThat(taskService.createTaskQuery().suspended().count()).isZero();</span>
<span class="nc" id="L168">        assertThat(taskService.createTaskQuery().active().count()).isEqualTo(1);</span>

        // Completing should end the process instance
<span class="nc" id="L171">        task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L172">        taskService.complete(task.getId());</span>
<span class="nc" id="L173">        assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>
<span class="nc" id="L174">    }</span>

    @Test
    @Deployment
    public void testChildExecutionsSuspendedAfterProcessInstanceSuspend() {
<span class="nc" id="L179">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;testChildExecutionsSuspended&quot;);</span>
<span class="nc" id="L180">        runtimeService.suspendProcessInstanceById(processInstance.getId());</span>

<span class="nc" id="L182">        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">        for (Execution execution : executions) {</span>
<span class="nc" id="L184">            assertThat(execution.isSuspended()).isTrue();</span>
<span class="nc" id="L185">        }</span>

        // Activate again
<span class="nc" id="L188">        runtimeService.activateProcessInstanceById(processInstance.getId());</span>
<span class="nc" id="L189">        executions = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">        for (Execution execution : executions) {</span>
<span class="nc" id="L191">            assertThat(execution.isSuspended()).isFalse();</span>
<span class="nc" id="L192">        }</span>

        // Finish process
<span class="nc bnc" id="L195" title="All 2 branches missed.">        while (taskService.createTaskQuery().count() &gt; 0) {</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">            for (org.flowable.task.api.Task task : taskService.createTaskQuery().list()) {</span>
<span class="nc" id="L197">                taskService.complete(task.getId());</span>
<span class="nc" id="L198">            }</span>
        }
<span class="nc" id="L200">        assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>
<span class="nc" id="L201">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testSubmitTaskFormAfterProcessInstanceSuspend() {
<span class="nc" id="L206">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span>
<span class="nc" id="L207">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(processDefinition.getId());</span>
<span class="nc" id="L208">        runtimeService.suspendProcessInstanceById(processInstance.getId());</span>

<span class="nc" id="L210">        assertThatThrownBy(() -&gt; formService</span>
<span class="nc" id="L211">                .submitTaskFormData(taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult().getId(), new HashMap&lt;&gt;()))</span>
<span class="nc" id="L212">                .isExactlyInstanceOf(FlowableException.class);</span>
<span class="nc" id="L213">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testProcessInstanceOperationsFailAfterSuspend() {

        // Suspend process instance
<span class="nc" id="L220">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span>
<span class="nc" id="L221">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(processDefinition.getId());</span>
<span class="nc" id="L222">        String processInstanceError = &quot;ProcessInstance[&quot; + processInstance.getId() + &quot;] - definition '&quot; + processInstance.getProcessDefinitionId() + &quot;'&quot;;</span>
<span class="nc" id="L223">        runtimeService.suspendProcessInstanceById(processInstance.getId());</span>

<span class="nc" id="L225">        assertThatThrownBy(() -&gt; runtimeService.messageEventReceived(&quot;someMessage&quot;, processInstance.getId()))</span>
<span class="nc" id="L226">                .isExactlyInstanceOf(FlowableException.class)</span>
<span class="nc" id="L227">                .hasMessage(&quot;Cannot receive message for a suspended &quot; + processInstanceError);</span>

<span class="nc" id="L229">        assertThatThrownBy(() -&gt; runtimeService.messageEventReceived(&quot;someMessage&quot;, processInstance.getId(), new HashMap&lt;&gt;()))</span>
<span class="nc" id="L230">                .isExactlyInstanceOf(FlowableException.class)</span>
<span class="nc" id="L231">                .hasMessage(&quot;Cannot receive message for a suspended &quot; + processInstanceError);</span>

<span class="nc" id="L233">        assertThatThrownBy(() -&gt; runtimeService.removeVariable(processInstance.getId(), &quot;someVariable&quot;))</span>
<span class="nc" id="L234">                .isExactlyInstanceOf(FlowableException.class)</span>
<span class="nc" id="L235">                .hasMessage(&quot;Cannot remove variables from a suspended &quot; + processInstanceError);</span>

<span class="nc" id="L237">        assertThatThrownBy(() -&gt; runtimeService.removeVariableLocal(processInstance.getId(), &quot;someVariable&quot;))</span>
<span class="nc" id="L238">                .isExactlyInstanceOf(FlowableException.class)</span>
<span class="nc" id="L239">                .hasMessage(&quot;Cannot remove variables from a suspended &quot; + processInstanceError);</span>

<span class="nc" id="L241">        assertThatThrownBy(() -&gt; runtimeService.removeVariables(processInstance.getId(), Arrays.asList(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;)))</span>
<span class="nc" id="L242">                .isExactlyInstanceOf(FlowableException.class)</span>
<span class="nc" id="L243">                .hasMessage(&quot;Cannot remove variables from a suspended &quot; + processInstanceError);</span>

<span class="nc" id="L245">        assertThatThrownBy(() -&gt; runtimeService.removeVariablesLocal(processInstance.getId(), Arrays.asList(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;)))</span>
<span class="nc" id="L246">                .isExactlyInstanceOf(FlowableException.class)</span>
<span class="nc" id="L247">                .hasMessage(&quot;Cannot remove variables from a suspended &quot; + processInstanceError);</span>

<span class="nc" id="L249">        assertThatThrownBy(() -&gt; runtimeService.setVariable(processInstance.getId(), &quot;someVariable&quot;, &quot;someValue&quot;))</span>
<span class="nc" id="L250">                .isExactlyInstanceOf(FlowableException.class)</span>
<span class="nc" id="L251">                .hasMessage(&quot;Cannot set variables to a suspended &quot; + processInstanceError);</span>

<span class="nc" id="L253">        assertThatThrownBy(() -&gt; runtimeService.setVariableLocal(processInstance.getId(), &quot;someVariable&quot;, &quot;someValue&quot;))</span>
<span class="nc" id="L254">                .isExactlyInstanceOf(FlowableException.class)</span>
<span class="nc" id="L255">                .hasMessage(&quot;Cannot set variables to a suspended &quot; + processInstanceError);</span>

<span class="nc" id="L257">        assertThatThrownBy(() -&gt; runtimeService.setVariables(processInstance.getId(), new HashMap&lt;&gt;()))</span>
<span class="nc" id="L258">                .isExactlyInstanceOf(FlowableException.class)</span>
<span class="nc" id="L259">                .hasMessage(&quot;Cannot set variables to a suspended &quot; + processInstanceError);</span>

<span class="nc" id="L261">        assertThatThrownBy(() -&gt; runtimeService.setVariablesLocal(processInstance.getId(), new HashMap&lt;&gt;()))</span>
<span class="nc" id="L262">                .isExactlyInstanceOf(FlowableException.class)</span>
<span class="nc" id="L263">                .hasMessage(&quot;Cannot set variables to a suspended &quot; + processInstanceError);</span>

<span class="nc" id="L265">        assertThatThrownBy(() -&gt; runtimeService.trigger(processInstance.getId()))</span>
<span class="nc" id="L266">                .isExactlyInstanceOf(FlowableException.class)</span>
<span class="nc" id="L267">                .hasMessage(&quot;Cannot trigger a suspended &quot; + processInstanceError);</span>

<span class="nc" id="L269">        assertThatThrownBy(() -&gt; runtimeService.trigger(processInstance.getId(), new HashMap&lt;&gt;()))</span>
<span class="nc" id="L270">                .isExactlyInstanceOf(FlowableException.class)</span>
<span class="nc" id="L271">                .hasMessage(&quot;Cannot trigger a suspended &quot; + processInstanceError);</span>

<span class="nc" id="L273">        assertThatThrownBy(() -&gt; runtimeService.signalEventReceived(&quot;someSignal&quot;, processInstance.getId()))</span>
<span class="nc" id="L274">                .isExactlyInstanceOf(FlowableException.class)</span>
<span class="nc" id="L275">                .hasMessage(&quot;Cannot throw signal event 'someSignal' because &quot; + processInstanceError + &quot; is suspended&quot;);</span>

<span class="nc" id="L277">        assertThatThrownBy(() -&gt; runtimeService.signalEventReceived(&quot;someSignal&quot;, processInstance.getId(), new HashMap&lt;&gt;()))</span>
<span class="nc" id="L278">                .isExactlyInstanceOf(FlowableException.class)</span>
<span class="nc" id="L279">                .hasMessage(&quot;Cannot throw signal event 'someSignal' because &quot; + processInstanceError + &quot; is suspended&quot;);</span>
<span class="nc" id="L280">    }</span>

    @Test
    @Deployment
    public void testSignalEventReceivedAfterProcessInstanceSuspended() {

<span class="nc" id="L286">        final String signal = &quot;Some Signal&quot;;</span>

        // Test if process instance can be completed using the signal
<span class="nc" id="L289">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;signalSuspendedProcessInstance&quot;);</span>
<span class="nc" id="L290">        runtimeService.signalEventReceived(signal);</span>
<span class="nc" id="L291">        assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>

        // Now test when suspending the process instance: the process instance
        // shouldn't be continued
<span class="nc" id="L295">        processInstance = runtimeService.startProcessInstanceByKey(&quot;signalSuspendedProcessInstance&quot;);</span>
<span class="nc" id="L296">        runtimeService.suspendProcessInstanceById(processInstance.getId());</span>
<span class="nc" id="L297">        runtimeService.signalEventReceived(signal);</span>
<span class="nc" id="L298">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L300">        runtimeService.signalEventReceived(signal, new HashMap&lt;&gt;());</span>
<span class="nc" id="L301">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>

        // Activate and try again
<span class="nc" id="L304">        runtimeService.activateProcessInstanceById(processInstance.getId());</span>
<span class="nc" id="L305">        runtimeService.signalEventReceived(signal);</span>
<span class="nc" id="L306">        assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>
<span class="nc" id="L307">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/runtime/ProcessInstanceSuspensionTest.testSignalEventReceivedAfterProcessInstanceSuspended.bpmn20.xml&quot;)
    public void testSignalEventReceivedAfterMultipleProcessInstancesSuspended() {

<span class="nc" id="L313">        final String signal = &quot;Some Signal&quot;;</span>

        // Test if process instance can be completed using the signal
<span class="nc" id="L316">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;signalSuspendedProcessInstance&quot;);</span>
<span class="nc" id="L317">        runtimeService.startProcessInstanceByKey(&quot;signalSuspendedProcessInstance&quot;);</span>
<span class="nc" id="L318">        runtimeService.signalEventReceived(signal);</span>
<span class="nc" id="L319">        assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>

        // Now test when suspending the process instance: the process instance
        // shouldn't be continued
<span class="nc" id="L323">        processInstance = runtimeService.startProcessInstanceByKey(&quot;signalSuspendedProcessInstance&quot;);</span>
<span class="nc" id="L324">        runtimeService.suspendProcessInstanceById(processInstance.getId());</span>
<span class="nc" id="L325">        processInstance = runtimeService.startProcessInstanceByKey(&quot;signalSuspendedProcessInstance&quot;);</span>
<span class="nc" id="L326">        runtimeService.suspendProcessInstanceById(processInstance.getId());</span>
<span class="nc" id="L327">        runtimeService.signalEventReceived(signal);</span>
<span class="nc" id="L328">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(2);</span>

<span class="nc" id="L330">        runtimeService.signalEventReceived(signal, new HashMap&lt;&gt;());</span>
<span class="nc" id="L331">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(2);</span>

        // Activate and try again
<span class="nc" id="L334">        runtimeService.activateProcessInstanceById(processInstance.getId());</span>
<span class="nc" id="L335">        runtimeService.signalEventReceived(signal);</span>
<span class="nc" id="L336">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L337">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testTaskOperationsFailAfterProcessInstanceSuspend() {

        // Start a new process instance with one task
<span class="nc" id="L344">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span>
<span class="nc" id="L345">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(processDefinition.getId());</span>
<span class="nc" id="L346">        final org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L347">        assertThat(task).isNotNull();</span>

        // Suspend the process instance
<span class="nc" id="L350">        runtimeService.suspendProcessInstanceById(processInstance.getId());</span>

        // Yeah, the following is pretty long and boring ... but I didn't have the patience
        // to create separate tests for each of them.

        // Completing the task should fail
<span class="nc" id="L356">        assertThatThrownBy(() -&gt; taskService.complete(task.getId()))</span>
<span class="nc" id="L357">                .as(&quot;It is not allowed to complete a task of a suspended process instance&quot;)</span>
<span class="nc" id="L358">                .isExactlyInstanceOf(FlowableException.class);</span>

        // Claiming the task should fail
<span class="nc" id="L361">        assertThatThrownBy(() -&gt; taskService.claim(task.getId(), &quot;jos&quot;))</span>
<span class="nc" id="L362">                .as(&quot;It is not allowed to claim a task of a suspended process instance&quot;)</span>
<span class="nc" id="L363">                .isExactlyInstanceOf(FlowableException.class);</span>

        // Setting variable on the task should fail
<span class="nc" id="L366">        assertThatThrownBy(() -&gt; taskService.setVariable(task.getId(), &quot;someVar&quot;, &quot;someValue&quot;))</span>
<span class="nc" id="L367">                .as(&quot;It is not allowed to set a variable on a task of a suspended process instance&quot;)</span>
<span class="nc" id="L368">                .isExactlyInstanceOf(FlowableException.class);</span>

        // Setting variable on the task should fail
<span class="nc" id="L371">        assertThatThrownBy(() -&gt; taskService.setVariableLocal(task.getId(), &quot;someVar&quot;, &quot;someValue&quot;))</span>
<span class="nc" id="L372">                .as(&quot;It is not allowed to set a variable on a task of a suspended process instance&quot;)</span>
<span class="nc" id="L373">                .isExactlyInstanceOf(FlowableException.class);</span>

        // Setting variables on the task should fail
<span class="nc" id="L376">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L377">            HashMap&lt;String, String&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L378">            variables.put(&quot;varOne&quot;, &quot;one&quot;);</span>
<span class="nc" id="L379">            variables.put(&quot;varTwo&quot;, &quot;two&quot;);</span>
<span class="nc" id="L380">            taskService.setVariables(task.getId(), variables);</span>
<span class="nc" id="L381">        })</span>
<span class="nc" id="L382">                .as(&quot;It is not allowed to set variables on a task of a suspended process instance&quot;)</span>
<span class="nc" id="L383">                .isExactlyInstanceOf(FlowableException.class);</span>

        // Setting variables on the task should fail
<span class="nc" id="L386">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L387">            HashMap&lt;String, String&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L388">            variables.put(&quot;varOne&quot;, &quot;one&quot;);</span>
<span class="nc" id="L389">            variables.put(&quot;varTwo&quot;, &quot;two&quot;);</span>
<span class="nc" id="L390">            taskService.setVariablesLocal(task.getId(), variables);</span>
<span class="nc" id="L391">        })</span>
<span class="nc" id="L392">                .isExactlyInstanceOf(FlowableException.class);</span>

        // Removing variable on the task should fail
<span class="nc" id="L395">        assertThatThrownBy(() -&gt; taskService.removeVariable(task.getId(), &quot;someVar&quot;))</span>
<span class="nc" id="L396">                .as(&quot;It is not allowed to remove a variable on a task of a suspended process instance&quot;)</span>
<span class="nc" id="L397">                .isExactlyInstanceOf(FlowableException.class);</span>

        // Removing variable on the task should fail
<span class="nc" id="L400">        assertThatThrownBy(() -&gt; taskService.removeVariableLocal(task.getId(), &quot;someVar&quot;))</span>
<span class="nc" id="L401">                .as(&quot;It is not allowed to remove a variable on a task of a suspended process instance&quot;)</span>
<span class="nc" id="L402">                .isExactlyInstanceOf(FlowableException.class);</span>

        // Removing variables on the task should fail
<span class="nc" id="L405">        assertThatThrownBy(() -&gt; taskService.removeVariables(task.getId(), Arrays.asList(&quot;one&quot;, &quot;two&quot;)))</span>
<span class="nc" id="L406">                .as(&quot;It is not allowed to remove a variable on a task of a suspended process instance&quot;)</span>
<span class="nc" id="L407">                .isExactlyInstanceOf(FlowableException.class);</span>

        // Removing variables on the task should fail
<span class="nc" id="L410">        assertThatThrownBy(() -&gt; taskService.removeVariablesLocal(task.getId(), Arrays.asList(&quot;one&quot;, &quot;two&quot;)))</span>
<span class="nc" id="L411">                .as(&quot;It is not allowed to remove a variable on a task of a suspended process instance&quot;)</span>
<span class="nc" id="L412">                .isExactlyInstanceOf(FlowableException.class);</span>

        // Adding candidate groups on the task should fail
<span class="nc" id="L415">        assertThatThrownBy(() -&gt; taskService.addCandidateGroup(task.getId(), &quot;blahGroup&quot;))</span>
<span class="nc" id="L416">                .as(&quot;It is not allowed to add a candidate group on a task of a suspended process instance&quot;)</span>
<span class="nc" id="L417">                .isExactlyInstanceOf(FlowableException.class);</span>

        // Adding candidate users on the task should fail
<span class="nc" id="L420">        assertThatThrownBy(() -&gt; taskService.addCandidateUser(task.getId(), &quot;blahUser&quot;))</span>
<span class="nc" id="L421">                .as(&quot;It is not allowed to add a candidate user on a task of a suspended process instance&quot;)</span>
<span class="nc" id="L422">                .isExactlyInstanceOf(FlowableException.class);</span>

        // Adding candidate users on the task should fail
<span class="nc" id="L425">        assertThatThrownBy(() -&gt; taskService.addGroupIdentityLink(task.getId(), &quot;blahGroup&quot;, IdentityLinkType.CANDIDATE))</span>
<span class="nc" id="L426">                .as(&quot;It is not allowed to add a candidate user on a task of a suspended process instance&quot;)</span>
<span class="nc" id="L427">                .isExactlyInstanceOf(FlowableException.class);</span>

        // Adding an identity link on the task should fail
<span class="nc" id="L430">        assertThatThrownBy(() -&gt; taskService.addUserIdentityLink(task.getId(), &quot;blahUser&quot;, IdentityLinkType.OWNER))</span>
<span class="nc" id="L431">                .as(&quot;It is not allowed to add an identityLink on a task of a suspended process instance&quot;)</span>
<span class="nc" id="L432">                .isExactlyInstanceOf(FlowableException.class);</span>

        // Adding a comment on the task should fail
<span class="nc" id="L435">        assertThatThrownBy(() -&gt; taskService.addComment(task.getId(), processInstance.getId(), &quot;test comment&quot;))</span>
<span class="nc" id="L436">                .as(&quot;It is not allowed to add a comment on a task of a suspended process instance&quot;)</span>
<span class="nc" id="L437">                .isExactlyInstanceOf(FlowableException.class);</span>

        // Adding an attachment on the task should fail
<span class="nc" id="L440">        assertThatThrownBy(() -&gt; taskService.createAttachment(&quot;text&quot;, task.getId(), processInstance.getId(), &quot;testName&quot;, &quot;testDescription&quot;, &quot;http://test.com&quot;))</span>
<span class="nc" id="L441">                .as(&quot;It is not allowed to add an attachment on a task of a suspended process instance&quot;)</span>
<span class="nc" id="L442">                .isExactlyInstanceOf(FlowableException.class);</span>

        // Set an assignee on the task should fail
<span class="nc" id="L445">        assertThatThrownBy(() -&gt; taskService.setAssignee(task.getId(), &quot;mispiggy&quot;))</span>
<span class="nc" id="L446">                .as(&quot;It is not allowed to set an assignee on a task of a suspended process instance&quot;)</span>
<span class="nc" id="L447">                .isExactlyInstanceOf(FlowableException.class);</span>

        // Set an owner on the task should fail
<span class="nc" id="L450">        assertThatThrownBy(() -&gt; taskService.setOwner(task.getId(), &quot;kermit&quot;))</span>
<span class="nc" id="L451">                .as(&quot;It is not allowed to set an owner on a task of a suspended process instance&quot;)</span>
<span class="nc" id="L452">                .isExactlyInstanceOf(FlowableException.class);</span>

        // Set priority on the task should fail
<span class="nc" id="L455">        assertThatThrownBy(() -&gt; taskService.setPriority(task.getId(), 99))</span>
<span class="nc" id="L456">                .as(&quot;It is not allowed to set a priority on a task of a suspended process instance&quot;)</span>
<span class="nc" id="L457">                .isExactlyInstanceOf(FlowableException.class);</span>
<span class="nc" id="L458">    }</span>

    @Test
    @Deployment
    public void testJobNotExecutedAfterProcessInstanceSuspend() {

<span class="nc" id="L464">        Date now = new Date();</span>
<span class="nc" id="L465">        processEngineConfiguration.getClock().setCurrentTime(now);</span>

        // Suspending the process instance should also stop the execution of jobs for that process instance
<span class="nc" id="L468">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span>
<span class="nc" id="L469">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(processDefinition.getId());</span>
<span class="nc" id="L470">        Job job = managementService.createTimerJobQuery().singleResult();</span>
<span class="nc" id="L471">        assertThat(job).isNotNull();</span>
<span class="nc" id="L472">        assertThat(job.getCorrelationId()).isNotNull();</span>
<span class="nc" id="L473">        assertThat(managementService.createTimerJobQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L475">        String correlationId = job.getCorrelationId();</span>
<span class="nc" id="L476">        runtimeService.suspendProcessInstanceById(processInstance.getId());</span>
<span class="nc" id="L477">        assertThat(managementService.createSuspendedJobQuery().count()).isEqualTo(1);</span>

        // The jobs should not be executed now
<span class="nc" id="L480">        processEngineConfiguration.getClock().setCurrentTime(new Date(now.getTime() + (60 * 60 * 1000))); // Timer is set to fire on 5 minutes</span>
<span class="nc" id="L481">        job = managementService.createTimerJobQuery().executable().singleResult();</span>
<span class="nc" id="L482">        assertThat(job).isNull();</span>

<span class="nc" id="L484">        assertThat(managementService.createSuspendedJobQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L485">        Job suspendedJob = managementService.createSuspendedJobQuery().correlationId(correlationId).singleResult();</span>
<span class="nc" id="L486">        assertThat(suspendedJob).isNotNull();</span>
<span class="nc" id="L487">        assertThat(suspendedJob.getCorrelationId()).isEqualTo(correlationId);</span>

        // Activation of the process instance should now allow for job execution
<span class="nc" id="L490">        runtimeService.activateProcessInstanceById(processInstance.getId());</span>
<span class="nc" id="L491">        waitForJobExecutorToProcessAllJobs(1000L, 100L);</span>
<span class="nc" id="L492">        assertThat(managementService.createJobQuery().count()).isZero();</span>
<span class="nc" id="L493">        assertThat(managementService.createTimerJobQuery().count()).isZero();</span>
<span class="nc" id="L494">        assertThat(managementService.createSuspendedJobQuery().count()).isZero();</span>
<span class="nc" id="L495">        assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>
<span class="nc" id="L496">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/runtime/ProcessInstanceSuspensionTest.testJobNotExecutedAfterProcessInstanceSuspend.bpmn20.xml&quot;)
    public void testJobActivationAfterProcessInstanceSuspend() {

<span class="nc" id="L502">        Date now = new Date();</span>
<span class="nc" id="L503">        processEngineConfiguration.getClock().setCurrentTime(now);</span>

        // Suspending the process instance should also stop the execution of jobs for that process instance
<span class="nc" id="L506">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span>
<span class="nc" id="L507">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(processDefinition.getId());</span>
<span class="nc" id="L508">        assertThat(managementService.createTimerJobQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L509">        runtimeService.suspendProcessInstanceById(processInstance.getId());</span>
<span class="nc" id="L510">        assertThat(managementService.createSuspendedJobQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L512">        Job job = managementService.createTimerJobQuery().executable().singleResult();</span>
<span class="nc" id="L513">        assertThat(job).isNull();</span>

<span class="nc" id="L515">        Job suspendedJob = managementService.createSuspendedJobQuery().singleResult();</span>
<span class="nc" id="L516">        assertThat(suspendedJob).isNotNull();</span>

        // Activation of the suspended job instance should throw exception because parent is suspended
<span class="nc" id="L519">        assertThatThrownBy(() -&gt; managementService.moveSuspendedJobToExecutableJob(suspendedJob.getId()))</span>
<span class="nc" id="L520">                .as(&quot;FlowableIllegalArgumentException expected. Cannot activate job with suspended parent&quot;)</span>
<span class="nc" id="L521">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L522">                .hasMessageContaining(&quot;Can not activate job &quot; + suspendedJob.getId() + &quot;. Parent is suspended.&quot;);</span>
<span class="nc" id="L523">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>