<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RuntimeServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.runtime</a> &gt; <span class="el_source">RuntimeServiceTest.java</span></div><h1>RuntimeServiceTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.engine.test.api.runtime;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.assertj.core.api.Assertions.entry;
import static org.assertj.core.api.Assertions.fail;
import static org.mockito.Mockito.when;

import java.util.Arrays;
import java.util.Calendar;
import java.util.Collections;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.flowable.cmmn.api.CallbackTypes;
import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.api.FlowableIllegalArgumentException;
import org.flowable.common.engine.api.FlowableObjectNotFoundException;
import org.flowable.common.engine.api.scope.ScopeTypes;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.common.engine.impl.interceptor.EngineConfigurationConstants;
import org.flowable.common.engine.impl.util.CollectionUtil;
import org.flowable.engine.history.DeleteReason;
import org.flowable.engine.history.HistoricDetail;
import org.flowable.engine.history.HistoricProcessInstance;
import org.flowable.engine.impl.persistence.entity.HistoricDetailVariableInstanceUpdateEntity;
import org.flowable.engine.impl.test.HistoryTestHelper;
import org.flowable.engine.impl.test.JobTestHelper;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.repository.ProcessDefinition;
import org.flowable.engine.runtime.Execution;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.runtime.ProcessInstanceBuilder;
import org.flowable.engine.test.Deployment;
import org.flowable.form.api.FormEngineConfigurationApi;
import org.flowable.form.api.FormInfo;
import org.flowable.form.api.FormService;
import org.flowable.job.api.Job;
import org.flowable.task.api.Task;
import org.flowable.task.api.history.HistoricTaskInstance;
import org.junit.jupiter.api.Test;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoSettings;

/**
 * @author Frederik Heremans
 * @author Joram Barrez
 */
<span class="nc" id="L67">public class RuntimeServiceTest extends PluggableFlowableTestCase {</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testStartProcessInstanceWithVariables() {
<span class="nc" id="L72">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L73">        vars.put(&quot;basicType&quot;, new DummySerializable());</span>
<span class="nc" id="L74">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>
<span class="nc" id="L75">        org.flowable.task.api.Task task = taskService.createTaskQuery().includeProcessVariables().singleResult();</span>
<span class="nc" id="L76">        assertThat(task.getProcessVariables()).isNotNull();</span>
<span class="nc" id="L77">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testStartProcessInstanceWithLongStringVariable() {
<span class="nc" id="L82">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L83">        StringBuilder longString = new StringBuilder();</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        for (int i = 0; i &lt; 4001; i++) {</span>
<span class="nc" id="L85">            longString.append(&quot;c&quot;);</span>
        }
<span class="nc" id="L87">        vars.put(&quot;longString&quot;, longString.toString());</span>
<span class="nc" id="L88">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>
<span class="nc" id="L89">        org.flowable.task.api.Task task = taskService.createTaskQuery().includeProcessVariables().singleResult();</span>
<span class="nc" id="L90">        assertThat(task.getProcessVariables())</span>
<span class="nc" id="L91">                .containsEntry(&quot;longString&quot;, longString.toString());</span>
<span class="nc" id="L92">    }</span>

    @Test
    public void testStartProcessInstanceByKeyNullKey() {
<span class="nc" id="L96">        assertThatThrownBy(() -&gt; runtimeService.startProcessInstanceByKey(null))</span>
<span class="nc" id="L97">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L98">    }</span>

    @Test
    public void testStartProcessInstanceByKeyUnexistingKey() {
<span class="nc" id="L102">        assertThatThrownBy(() -&gt; runtimeService.startProcessInstanceByKey(&quot;unexistingkey&quot;))</span>
<span class="nc" id="L103">                .isExactlyInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L104">                .hasMessageContaining(&quot;No process definition found for key 'unexistingkey'&quot;);</span>
<span class="nc" id="L105">    }</span>

    @Test
    public void testStartProcessInstanceByIdNullId() {
<span class="nc" id="L109">        assertThatThrownBy(() -&gt; runtimeService.startProcessInstanceById(null))</span>
<span class="nc" id="L110">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L111">    }</span>

    @Test
    public void testStartProcessInstanceByIdUnexistingId() {
<span class="nc" id="L115">        assertThatThrownBy(() -&gt; runtimeService.startProcessInstanceById(&quot;unexistingId&quot;))</span>
<span class="nc" id="L116">                .isExactlyInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L117">                .hasMessageContaining(&quot;no deployed process definition found with id 'unexistingId'&quot;);</span>
<span class="nc" id="L118">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testStartProcessInstanceByIdNullVariables() {
<span class="nc" id="L123">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, (Map&lt;String, Object&gt;) null);</span>
<span class="nc" id="L124">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L125">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testStartProcessInstanceWithBusinessKey() {
<span class="nc" id="L130">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span>

        // by key
<span class="nc" id="L133">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, &quot;123&quot;);</span>
<span class="nc" id="L134">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L135">        assertThat(processInstance.getBusinessKey()).isEqualTo(&quot;123&quot;);</span>
<span class="nc" id="L136">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(1);</span>

        // by key with variables
<span class="nc" id="L139">        processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, &quot;456&quot;, CollectionUtil.singletonMap(&quot;var&quot;, &quot;value&quot;));</span>
<span class="nc" id="L140">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L141">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(2);</span>
<span class="nc" id="L142">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;var&quot;)).isEqualTo(&quot;value&quot;);</span>

        // by id
<span class="nc" id="L145">        processInstance = runtimeService.startProcessInstanceById(processDefinition.getId(), &quot;789&quot;);</span>
<span class="nc" id="L146">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L147">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(3);</span>

        // by id with variables
<span class="nc" id="L150">        processInstance = runtimeService.startProcessInstanceById(processDefinition.getId(), &quot;101123&quot;, CollectionUtil.singletonMap(&quot;var&quot;, &quot;value2&quot;));</span>
<span class="nc" id="L151">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L152">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(4);</span>
<span class="nc" id="L153">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;var&quot;)).isEqualTo(&quot;value2&quot;);</span>
<span class="nc" id="L154">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testStartProcessInstanceByProcessInstanceBuilder() {
<span class="nc" id="L159">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span>

<span class="nc" id="L161">        ProcessInstanceBuilder processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>

        // by key
<span class="nc" id="L164">        ProcessInstance processInstance = processInstanceBuilder.processDefinitionKey(&quot;oneTaskProcess&quot;).businessKey(&quot;123&quot;).start();</span>
<span class="nc" id="L165">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L166">        assertThat(processInstance.getBusinessKey()).isEqualTo(&quot;123&quot;);</span>
<span class="nc" id="L167">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(1);</span>

<span class="nc" id="L169">        processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>

        // by key, with processInstance name with variables
<span class="nc" id="L172">        processInstance = processInstanceBuilder.processDefinitionKey(&quot;oneTaskProcess&quot;).businessKey(&quot;456&quot;).variable(&quot;var&quot;, &quot;value&quot;).name(&quot;processName1&quot;)</span>
<span class="nc" id="L173">                .start();</span>
<span class="nc" id="L174">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L175">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(2);</span>
<span class="nc" id="L176">        assertThat(processInstance.getName()).isEqualTo(&quot;processName1&quot;);</span>
<span class="nc" id="L177">        assertThat(processInstance.getBusinessKey()).isEqualTo(&quot;456&quot;);</span>
<span class="nc" id="L178">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;var&quot;)).isEqualTo(&quot;value&quot;);</span>

<span class="nc" id="L180">        processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>

        // by id
<span class="nc" id="L183">        processInstance = processInstanceBuilder.processDefinitionId(processDefinition.getId()).businessKey(&quot;789&quot;).start();</span>
<span class="nc" id="L184">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L185">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(3);</span>
<span class="nc" id="L186">        assertThat(processInstance.getBusinessKey()).isEqualTo(&quot;789&quot;);</span>

<span class="nc" id="L188">        processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>
        // by id with variables
<span class="nc" id="L190">        processInstance = processInstanceBuilder.processDefinitionId(processDefinition.getId()).businessKey(&quot;101123&quot;).variable(&quot;var&quot;, &quot;value2&quot;).start();</span>
<span class="nc" id="L191">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L192">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(4);</span>
<span class="nc" id="L193">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;var&quot;)).isEqualTo(&quot;value2&quot;);</span>
<span class="nc" id="L194">        assertThat(processInstance.getBusinessKey()).isEqualTo(&quot;101123&quot;);</span>

<span class="nc" id="L196">        processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>
        // by id and processInstance name
<span class="nc" id="L198">        processInstance = processInstanceBuilder.processDefinitionId(processDefinition.getId()).businessKey(&quot;101124&quot;).name(&quot;processName2&quot;).start();</span>
<span class="nc" id="L199">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L200">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(5);</span>
<span class="nc" id="L201">        assertThat(processInstance.getName()).isEqualTo(&quot;processName2&quot;);</span>
<span class="nc" id="L202">        assertThat(processInstance.getBusinessKey()).isEqualTo(&quot;101124&quot;);</span>
<span class="nc" id="L203">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testStartProcessInstanceByProcessInstanceBuilderAsync() {
<span class="nc" id="L208">        repositoryService.createProcessDefinitionQuery().singleResult();</span>

<span class="nc" id="L210">        ProcessInstanceBuilder processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>

        // by key
<span class="nc" id="L213">        ProcessInstance processInstance = processInstanceBuilder.processDefinitionKey(&quot;oneTaskProcess&quot;).businessKey(&quot;123&quot;).startAsync();</span>
<span class="nc" id="L214">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L215">        assertThat(processInstance.getBusinessKey()).isEqualTo(&quot;123&quot;);</span>
<span class="nc" id="L216">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L217">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).count())</span>
<span class="nc" id="L218">                .as(&quot;Process is started, but its execution waits on the job&quot;).isZero();</span>

<span class="nc" id="L220">        Job job = managementService.createJobQuery().singleResult();</span>
<span class="nc" id="L221">        assertThat(job).isNotNull();</span>
<span class="nc" id="L222">        assertThat(job.isExclusive()).isFalse();</span>

<span class="nc" id="L224">        JobTestHelper.waitForJobExecutorToProcessAllJobs(processEngineConfiguration, managementService, 2000, 200);</span>
<span class="nc" id="L225">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).count()).as(&quot;The task is created from the job execution&quot;)</span>
<span class="nc" id="L226">                .isEqualTo(1);</span>
<span class="nc" id="L227">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testStartProcessInstanceByProcessInstanceBuilderAsyncWithDefinitionId() {
<span class="nc" id="L232">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span>

<span class="nc" id="L234">        ProcessInstanceBuilder processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>

        // by definitionId
<span class="nc" id="L237">        ProcessInstance processInstance = processInstanceBuilder.processDefinitionId(processDefinition.getId()).businessKey(&quot;123&quot;).startAsync();</span>
<span class="nc" id="L238">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L239">        assertThat(processInstance.getBusinessKey()).isEqualTo(&quot;123&quot;);</span>
<span class="nc" id="L240">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L241">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).count())</span>
<span class="nc" id="L242">                .as(&quot;Process is started, but its execution waits on the job&quot;).isZero();</span>

<span class="nc" id="L244">        JobTestHelper.waitForJobExecutorToProcessAllJobs(processEngineConfiguration, managementService, 2000, 200);</span>
<span class="nc" id="L245">        assertThat(taskService.createTaskQuery().processInstanceId(processInstance.getId()).count()).as(&quot;The task is created from the job execution&quot;)</span>
<span class="nc" id="L246">                .isEqualTo(1);</span>
<span class="nc" id="L247">    }</span>

    @Test
    public void testStartProcessInstanceByProcessInstanceBuilderAsyncWithoutKeyAndDefinitionId() {
<span class="nc" id="L251">        ProcessInstanceBuilder processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>

<span class="nc" id="L253">        assertThatThrownBy(() -&gt; processInstanceBuilder.startAsync())</span>
<span class="nc" id="L254">            .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L255">            .hasMessage(&quot;No processDefinitionId, processDefinitionKey provided&quot;);</span>
<span class="nc" id="L256">    }</span>

    @Test
    public void testStartProcessInstanceByProcessInstanceBuilderAsyncWithNonExistingDefKey() {
<span class="nc" id="L260">        ProcessInstanceBuilder processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>

<span class="nc" id="L262">        assertThatThrownBy(() -&gt; processInstanceBuilder.processDefinitionKey(&quot;nonExistingKey&quot;).startAsync())</span>
<span class="nc" id="L263">            .isExactlyInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L264">            .hasMessage(&quot;No process definition found for key 'nonExistingKey'&quot;);</span>
<span class="nc" id="L265">    }</span>

    @Test
    public void testStartProcessInstanceByProcessInstanceBuilderAsyncWithNonExistingDefId() {
<span class="nc" id="L269">        ProcessInstanceBuilder processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>

<span class="nc" id="L271">        assertThatThrownBy(() -&gt; processInstanceBuilder.processDefinitionId(&quot;nonExistingDefinitionId&quot;).startAsync())</span>
<span class="nc" id="L272">            .isExactlyInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L273">            .hasMessage(&quot;no deployed process definition found with id 'nonExistingDefinitionId'&quot;);</span>
<span class="nc" id="L274">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testProcessInstanceDefinitionInformation() {
<span class="nc" id="L279">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span>
<span class="nc" id="L280">        ProcessInstanceBuilder processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>

<span class="nc" id="L282">        ProcessInstance processInstance = processInstanceBuilder.processDefinitionKey(&quot;oneTaskProcess&quot;).start();</span>

<span class="nc" id="L284">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L285">        assertThat(processInstance.getDeploymentId()).isEqualTo(processDefinition.getDeploymentId());</span>
<span class="nc" id="L286">        assertThat(processInstance.getProcessDefinitionId()).isEqualTo(processDefinition.getId());</span>
<span class="nc" id="L287">        assertThat(processInstance.getProcessDefinitionKey()).isEqualTo(processDefinition.getKey());</span>
<span class="nc" id="L288">        assertThat(processInstance.getProcessDefinitionVersion().intValue()).isEqualTo(processDefinition.getVersion());</span>
<span class="nc" id="L289">        assertThat(processInstance.getProcessDefinitionName()).isEqualTo(processDefinition.getName());</span>
<span class="nc" id="L290">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/twoTasksProcess.bpmn20.xml&quot; })
    public void testProcessInstanceDefinitionInformationWithoutProcessDefinitionName() {
<span class="nc" id="L295">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span>
<span class="nc" id="L296">        ProcessInstanceBuilder processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>

<span class="nc" id="L298">        ProcessInstance processInstance = processInstanceBuilder.processDefinitionKey(&quot;twoTasksProcess&quot;).start();</span>

<span class="nc" id="L300">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L301">        assertThat(processInstance.getDeploymentId()).isEqualTo(processDefinition.getDeploymentId());</span>
<span class="nc" id="L302">        assertThat(processInstance.getProcessDefinitionId()).isEqualTo(processDefinition.getId());</span>
<span class="nc" id="L303">        assertThat(processInstance.getProcessDefinitionKey()).isEqualTo(&quot;twoTasksProcess&quot;);</span>
<span class="nc" id="L304">        assertThat(processInstance.getProcessDefinitionVersion().intValue()).isEqualTo(processDefinition.getVersion());</span>
<span class="nc" id="L305">        assertThat(processInstance.getProcessDefinitionName()).isNull();</span>
<span class="nc" id="L306">    }</span>

    @Test
    public void testStartProcessInstanceByProcessInstanceBuilderWithTenantId() {
<span class="nc" id="L310">        org.flowable.engine.repository.Deployment deployment = repositoryService.createDeployment()</span>
<span class="nc" id="L311">            .addClasspathResource(&quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot;).</span>
<span class="nc" id="L312">                tenantId(&quot;flowable&quot;).</span>
<span class="nc" id="L313">                deploy();</span>
        try {
<span class="nc" id="L315">            ProcessInstanceBuilder processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>

<span class="nc" id="L317">            ProcessInstance processInstance = processInstanceBuilder.processDefinitionKey(&quot;oneTaskProcess&quot;).businessKey(&quot;123&quot;).</span>
<span class="nc" id="L318">                    tenantId(&quot;flowable&quot;).start();</span>
<span class="nc" id="L319">            assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L320">            assertThat(processInstance.getBusinessKey()).isEqualTo(&quot;123&quot;);</span>
<span class="nc" id="L321">            assertThat(processInstance.getTenantId()).isEqualTo(&quot;flowable&quot;);</span>

<span class="nc" id="L323">            Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L324">            assertThat(task.getTenantId()).isEqualTo(&quot;flowable&quot;);</span>
        } finally {
<span class="nc" id="L326">            repositoryService.deleteDeployment(deployment.getId(), true);</span>
        }
<span class="nc" id="L328">    }</span>

    @Test
    public void testStartProcessInstanceByProcessInstanceBuilderWithOverrideTenantId() {
<span class="nc" id="L332">        org.flowable.engine.repository.Deployment deployment = repositoryService.createDeployment()</span>
<span class="nc" id="L333">            .addClasspathResource(&quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot;)</span>
<span class="nc" id="L334">            .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L335">            .deploy();</span>

        try {
<span class="nc" id="L338">            ProcessInstanceBuilder processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>

<span class="nc" id="L340">            ProcessInstance processInstance = processInstanceBuilder.processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L341">                    .businessKey(&quot;123&quot;)</span>
<span class="nc" id="L342">                    .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L343">                    .overrideProcessDefinitionTenantId(&quot;customTenant&quot;)</span>
<span class="nc" id="L344">                    .start();</span>

<span class="nc" id="L346">            assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L347">            assertThat(processInstance.getBusinessKey()).isEqualTo(&quot;123&quot;);</span>
<span class="nc" id="L348">            assertThat(processInstance.getTenantId()).isEqualTo(&quot;customTenant&quot;);</span>

<span class="nc" id="L350">            Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L351">            assertThat(task.getTenantId()).isEqualTo(&quot;customTenant&quot;);</span>

        } finally {
<span class="nc" id="L354">            repositoryService.deleteDeployment(deployment.getId(), true);</span>
        }
<span class="nc" id="L356">    }</span>

    @Test
    public void testStartProcessInstanceByProcessInstanceBuilderWithDefaultDefinitionTenantId() {
<span class="nc" id="L360">        org.flowable.engine.repository.Deployment deployment = repositoryService.createDeployment()</span>
<span class="nc" id="L361">            .addClasspathResource(&quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot;)</span>
<span class="nc" id="L362">            .deploy();</span>

        try {
<span class="nc" id="L365">            ProcessInstanceBuilder processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>

<span class="nc" id="L367">            ProcessInstance processInstance = processInstanceBuilder.processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L368">                    .businessKey(&quot;123&quot;)</span>
<span class="nc" id="L369">                    .overrideProcessDefinitionTenantId(&quot;customTenant&quot;)</span>
<span class="nc" id="L370">                    .start();</span>

<span class="nc" id="L372">            assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L373">            assertThat(processInstance.getBusinessKey()).isEqualTo(&quot;123&quot;);</span>
<span class="nc" id="L374">            assertThat(processInstance.getTenantId()).isEqualTo(&quot;customTenant&quot;);</span>

<span class="nc" id="L376">            Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L377">            assertThat(task.getTenantId()).isEqualTo(&quot;customTenant&quot;);</span>

        } finally {
<span class="nc" id="L380">            repositoryService.deleteDeployment(deployment.getId(), true);</span>
        }
<span class="nc" id="L382">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testNonUniqueBusinessKey() {
<span class="nc" id="L387">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, &quot;123&quot;);</span>

        // Behaviour changed: https://activiti.atlassian.net/browse/ACT-1860
<span class="nc" id="L390">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, &quot;123&quot;);</span>
<span class="nc" id="L391">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessKey(&quot;123&quot;).count()).isEqualTo(2);</span>
<span class="nc" id="L392">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testStartProcessInstanceFormWithoutFormKey() {
<span class="nc" id="L397">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L398">        vars.put(&quot;basicType&quot;, new DummySerializable());</span>

<span class="nc" id="L400">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span>

<span class="nc" id="L402">        runtimeService.startProcessInstanceWithForm(processDefinition.getId(), null, vars, null);</span>
<span class="nc" id="L403">        org.flowable.task.api.Task task = taskService.createTaskQuery().includeProcessVariables().singleResult();</span>
<span class="nc" id="L404">        assertThat(task.getProcessVariables()).isNotNull();</span>
<span class="nc" id="L405">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testStartProcessInstanceFormWithoutVariables() {
<span class="nc" id="L410">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span>
<span class="nc" id="L411">        ProcessInstance processInstance = runtimeService.startProcessInstanceWithForm(processDefinition.getId(), &quot;outcome&quot;, null, null);</span>
<span class="nc" id="L412">        assertThat(runtimeService.getVariables(processInstance.getId())).isEmpty();</span>
<span class="nc" id="L413">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testStartProcessInstanceFormWithEmptyVariables() {
<span class="nc" id="L418">        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span>
<span class="nc" id="L419">        ProcessInstance processInstance = runtimeService.startProcessInstanceWithForm(processDefinition.getId(), &quot;outcome&quot;, new HashMap&lt;&gt;(), null);</span>
<span class="nc" id="L420">        assertThat(runtimeService.getVariables(processInstance.getId())).isEmpty();</span>
<span class="nc" id="L421">    }</span>

    // some databases might react strange on having multiple times null for the
    // business key
    // when the unique constraint is {processDefinitionId, businessKey}
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testMultipleNullBusinessKeys() {
<span class="nc" id="L429">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L430">        assertThat(processInstance.getBusinessKey()).isNull();</span>

<span class="nc" id="L432">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L433">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L435">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(3);</span>
<span class="nc" id="L436">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testDeleteProcessInstance() {
<span class="nc" id="L441">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L442">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(1);</span>

<span class="nc" id="L444">        String deleteReason = &quot;testing instance deletion&quot;;</span>
<span class="nc" id="L445">        runtimeService.deleteProcessInstance(processInstance.getId(), deleteReason);</span>
<span class="nc" id="L446">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isZero();</span>

        // test that the delete reason of the process instance shows up as
        // delete reason of the task in history ACT-848
<span class="nc bnc" id="L450" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>

<span class="nc" id="L452">            HistoricTaskInstance historicTaskInstance = historyService.createHistoricTaskInstanceQuery().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L453">                    .singleResult();</span>

<span class="nc" id="L455">            assertThat(historicTaskInstance.getDeleteReason()).isEqualTo(deleteReason);</span>

<span class="nc" id="L457">            HistoricProcessInstance historicInstance = historyService.createHistoricProcessInstanceQuery().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L458">                    .singleResult();</span>

<span class="nc" id="L460">            assertThat(historicInstance).isNotNull();</span>
<span class="nc" id="L461">            assertThat(historicInstance.getDeleteReason()).isEqualTo(deleteReason);</span>
<span class="nc" id="L462">            assertThat(historicInstance.getEndTime()).isNotNull();</span>
        }
<span class="nc" id="L464">    }</span>
    
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testBulkDeleteProcessInstance() {
<span class="nc" id="L469">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L470">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L471">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L472">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(2);</span>
<span class="nc" id="L473">        ProcessInstance processInstance3 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L474">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(3);</span>

<span class="nc" id="L476">        String deleteReason = &quot;testing instance deletion&quot;;</span>
<span class="nc" id="L477">        Set&lt;String&gt; instanceIds = new HashSet&lt;&gt;();</span>
<span class="nc" id="L478">        instanceIds.add(processInstance1.getId());</span>
<span class="nc" id="L479">        instanceIds.add(processInstance2.getId());</span>

<span class="nc" id="L481">        runtimeService.bulkDeleteProcessInstances(instanceIds, deleteReason);</span>

        // test that the delete reason of the process instance shows up as
        // delete reason of the task in history ACT-848
<span class="nc bnc" id="L485" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L486">            HistoricTaskInstance historicTaskInstance = historyService.createHistoricTaskInstanceQuery().processInstanceId(processInstance1.getId())</span>
<span class="nc" id="L487">                    .singleResult();</span>
<span class="nc" id="L488">            assertThat(historicTaskInstance.getDeleteReason()).isEqualTo(deleteReason);</span>
<span class="nc" id="L489">            HistoricProcessInstance historicInstance = historyService.createHistoricProcessInstanceQuery().processInstanceId(processInstance1.getId())</span>
<span class="nc" id="L490">                    .singleResult();</span>
<span class="nc" id="L491">            assertThat(historicInstance).isNotNull();</span>
<span class="nc" id="L492">            assertThat(historicInstance.getDeleteReason()).isEqualTo(deleteReason);</span>
<span class="nc" id="L493">            assertThat(historicInstance.getEndTime()).isNotNull();</span>
        }
<span class="nc" id="L495">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L496">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(processInstance3.getId()).singleResult()).isNotNull();</span>
<span class="nc" id="L497">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testInvalidBulkDeleteProcessInstance() {
<span class="nc" id="L502">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L503">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L504">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L505">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(2);</span>
<span class="nc" id="L506">        ProcessInstance processInstance3 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L507">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(3);</span>

<span class="nc" id="L509">        String deleteReason = &quot;testing instance deletion&quot;;</span>
<span class="nc" id="L510">        Set&lt;String&gt; instanceIds = new HashSet&lt;&gt;();</span>
<span class="nc" id="L511">        instanceIds.add(processInstance1.getId());</span>
<span class="nc" id="L512">        instanceIds.add(processInstance2.getId());</span>
<span class="nc" id="L513">        instanceIds.add(&quot;invalidID&quot;);</span>

<span class="nc" id="L515">        assertThatThrownBy(() -&gt; runtimeService.bulkDeleteProcessInstances(instanceIds, deleteReason))</span>
<span class="nc" id="L516">                .isInstanceOf(FlowableObjectNotFoundException.class);</span>

<span class="nc" id="L518">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(3);</span>

<span class="nc" id="L520">        assertThatThrownBy(() -&gt; runtimeService.bulkDeleteProcessInstances(null, deleteReason))</span>
<span class="nc" id="L521">                .isInstanceOf(FlowableIllegalArgumentException.class).hasMessage(&quot;processInstanceIds are null&quot;);</span>
<span class="nc" id="L522">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcessWithListener.bpmn20.xml&quot; })
    public void testDeleteProcessInstanceWithListener() {
<span class="nc" id="L527">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L528">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(1);</span>

<span class="nc" id="L530">        String deleteReason = &quot;testing instance deletion&quot;;</span>
<span class="nc" id="L531">        runtimeService.deleteProcessInstance(processInstance.getId(), deleteReason);</span>
<span class="nc" id="L532">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isZero();</span>

<span class="nc bnc" id="L534" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L535">            HistoricProcessInstance historicInstance = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L536">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L537">                    .singleResult();</span>

<span class="nc" id="L539">            assertThat(historicInstance).isNotNull();</span>
<span class="nc" id="L540">            assertThat(historicInstance.getDeleteReason()).isEqualTo(deleteReason);</span>
<span class="nc" id="L541">            assertThat(historicInstance.getEndTime()).isNotNull();</span>
        }
<span class="nc" id="L543">    }</span>
    
    @Test
    @Deployment(resources = { 
            &quot;org/flowable/engine/test/api/taskProcessWithCallActivityListener.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/oneTaskProcessWithListener.bpmn20.xml&quot; 
    })
    public void testDeleteProcessInstanceWithCallActivityListener() {
<span class="nc" id="L551">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;taskAndCallActivityProcess&quot;);</span>
<span class="nc" id="L552">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;taskAndCallActivityProcess&quot;).count()).isEqualTo(1);</span>

<span class="nc" id="L554">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L555">        taskService.complete(task.getId());</span>
        
<span class="nc" id="L557">        ProcessInstance subProcessInstance = runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).singleResult();</span>
<span class="nc" id="L558">        assertThat(subProcessInstance).isNotNull();</span>
        
<span class="nc" id="L560">        String deleteReason = &quot;testing instance deletion&quot;;</span>
<span class="nc" id="L561">        runtimeService.deleteProcessInstance(processInstance.getId(), deleteReason);</span>
<span class="nc" id="L562">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;taskAndCallActivityProcess&quot;).count()).isZero();</span>
<span class="nc" id="L563">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(subProcessInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L565" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L566">            HistoricProcessInstance historicInstance = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L567">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L568">                    .singleResult();</span>

<span class="nc" id="L570">            assertThat(historicInstance).isNotNull();</span>
<span class="nc" id="L571">            assertThat(historicInstance.getDeleteReason()).isEqualTo(deleteReason);</span>
<span class="nc" id="L572">            assertThat(historicInstance.getEndTime()).isNotNull();</span>
            
<span class="nc" id="L574">            HistoricProcessInstance historicSubInstance = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L575">                    .processInstanceId(subProcessInstance.getId())</span>
<span class="nc" id="L576">                    .singleResult();</span>

<span class="nc" id="L578">            assertThat(historicSubInstance).isNotNull();</span>
<span class="nc" id="L579">            assertThat(historicSubInstance.getDeleteReason()).isEqualTo(deleteReason);</span>
<span class="nc" id="L580">            assertThat(historicSubInstance.getEndTime()).isNotNull();</span>
        }
<span class="nc" id="L582">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testDeleteProcessInstanceNullReason() {
<span class="nc" id="L587">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L588">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isEqualTo(1);</span>

        // Deleting without a reason should be possible
<span class="nc" id="L591">        runtimeService.deleteProcessInstance(processInstance.getId(), null);</span>
<span class="nc" id="L592">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;).count()).isZero();</span>

<span class="nc bnc" id="L594" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
<span class="nc" id="L595">            HistoricProcessInstance historicInstance = historyService.createHistoricProcessInstanceQuery().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L596">                    .singleResult();</span>

<span class="nc" id="L598">            assertThat(historicInstance).isNotNull();</span>
<span class="nc" id="L599">            assertThat(historicInstance.getDeleteReason()).isEqualTo(DeleteReason.PROCESS_INSTANCE_DELETED);</span>
        }
<span class="nc" id="L601">    }</span>

    @Test
    public void testDeleteProcessInstanceUnexistingId() {
<span class="nc" id="L605">        assertThatThrownBy(() -&gt; runtimeService.deleteProcessInstance(&quot;enexistingInstanceId&quot;, null))</span>
<span class="nc" id="L606">                .isExactlyInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L607">                .hasMessageContaining(&quot;No process instance found for id&quot;);</span>
<span class="nc" id="L608">    }</span>

    @Test
    public void testDeleteProcessInstanceNullId() {
<span class="nc" id="L612">        assertThatThrownBy(() -&gt; runtimeService.deleteProcessInstance(null, &quot;test null id delete&quot;))</span>
<span class="nc" id="L613">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L614">                .hasMessage(&quot;processInstanceId is null&quot;);</span>
<span class="nc" id="L615">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testFindActiveActivityIds() {
<span class="nc" id="L620">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L622">        List&lt;String&gt; activities = runtimeService.getActiveActivityIds(processInstance.getId());</span>
<span class="nc" id="L623">        assertThat(activities).hasSize(1);</span>
<span class="nc" id="L624">    }</span>

    @Test
    public void testFindActiveActivityIdsUnexistingExecututionId() {
<span class="nc" id="L628">        assertThatThrownBy(() -&gt; runtimeService.getActiveActivityIds(&quot;unexistingExecutionId&quot;))</span>
<span class="nc" id="L629">                .isExactlyInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L630">                .hasMessage(&quot;execution unexistingExecutionId doesn't exist&quot;);</span>
<span class="nc" id="L631">    }</span>

    @Test
    public void testFindActiveActivityIdsNullExecututionId() {
<span class="nc" id="L635">        assertThatThrownBy(() -&gt; runtimeService.getActiveActivityIds(null))</span>
<span class="nc" id="L636">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L637">                .hasMessage(&quot;executionId is null&quot;);</span>
<span class="nc" id="L638">    }</span>

    /**
     * Testcase to reproduce ACT-950 (https://jira.codehaus.org/browse/ACT-950)
     */
    @Test
    @Deployment
    public void testFindActiveActivityIdProcessWithErrorEventAndSubProcess() {
<span class="nc" id="L646">        ProcessInstance processInstance = processEngine.getRuntimeService().startProcessInstanceByKey(&quot;errorEventSubprocess&quot;);</span>

<span class="nc" id="L648">        List&lt;String&gt; activeActivities = runtimeService.getActiveActivityIds(processInstance.getId());</span>
<span class="nc" id="L649">        assertThat(activeActivities).hasSize(5);</span>

<span class="nc" id="L651">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L652">        assertThat(tasks)</span>
<span class="nc" id="L653">                .extracting(Task::getName)</span>
<span class="nc" id="L654">                .containsExactlyInAnyOrder(&quot;ParallelUserTask&quot;, &quot;MainUserTask&quot;);</span>

<span class="nc" id="L656">        org.flowable.task.api.Task parallelUserTask = null;</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">        for (org.flowable.task.api.Task task : tasks) {</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">            if (&quot;ParallelUserTask&quot;.equals(task.getName())) {</span>
<span class="nc" id="L659">                parallelUserTask = task;</span>
            }
<span class="nc" id="L661">        }</span>
<span class="nc" id="L662">        taskService.complete(parallelUserTask.getId());</span>

<span class="nc" id="L664">        Execution execution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).activityId(&quot;subprocess1WaitBeforeError&quot;)</span>
<span class="nc" id="L665">                .singleResult();</span>
<span class="nc" id="L666">        runtimeService.trigger(execution.getId());</span>

<span class="nc" id="L668">        activeActivities = runtimeService.getActiveActivityIds(processInstance.getId());</span>
<span class="nc" id="L669">        assertThat(activeActivities).hasSize(4);</span>

<span class="nc" id="L671">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L672">        assertThat(tasks)</span>
<span class="nc" id="L673">                .extracting(Task::getName)</span>
<span class="nc" id="L674">                .containsExactlyInAnyOrder(&quot;BeforeError&quot;, &quot;MainUserTask&quot;);</span>

<span class="nc" id="L676">        org.flowable.task.api.Task beforeErrorUserTask = null;</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">        for (org.flowable.task.api.Task task : tasks) {</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">            if (&quot;BeforeError&quot;.equals(task.getName())) {</span>
<span class="nc" id="L679">                beforeErrorUserTask = task;</span>
            }
<span class="nc" id="L681">        }</span>
<span class="nc" id="L682">        taskService.complete(beforeErrorUserTask.getId());</span>

<span class="nc" id="L684">        activeActivities = runtimeService.getActiveActivityIds(processInstance.getId());</span>
<span class="nc" id="L685">        assertThat(activeActivities).hasSize(2);</span>

<span class="nc" id="L687">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L688">        assertThat(tasks)</span>
<span class="nc" id="L689">                .extracting(Task::getName)</span>
<span class="nc" id="L690">                .containsExactlyInAnyOrder(&quot;AfterError&quot;, &quot;MainUserTask&quot;);</span>

<span class="nc" id="L692">        org.flowable.task.api.Task afterErrorUserTask = null;</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">        for (org.flowable.task.api.Task task : tasks) {</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">            if (&quot;AfterError&quot;.equals(task.getName())) {</span>
<span class="nc" id="L695">                afterErrorUserTask = task;</span>
            }
<span class="nc" id="L697">        }</span>
<span class="nc" id="L698">        taskService.complete(afterErrorUserTask.getId());</span>

<span class="nc" id="L700">        tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L701">        assertThat(tasks)</span>
<span class="nc" id="L702">                .extracting(Task::getName)</span>
<span class="nc" id="L703">                .containsExactly(&quot;MainUserTask&quot;);</span>

<span class="nc" id="L705">        activeActivities = runtimeService.getActiveActivityIds(processInstance.getId());</span>
<span class="nc" id="L706">        assertThat(activeActivities)</span>
<span class="nc" id="L707">                .containsOnly(&quot;MainUserTask&quot;);</span>

<span class="nc" id="L709">        taskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L710">        assertProcessEnded(processInstance.getId());</span>
<span class="nc" id="L711">    }</span>

    @Test
    public void testSignalUnexistingExecututionId() {
<span class="nc" id="L715">        assertThatThrownBy(() -&gt; runtimeService.trigger(&quot;unexistingExecutionId&quot;))</span>
<span class="nc" id="L716">                .isExactlyInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L717">                .hasMessage(&quot;execution unexistingExecutionId doesn't exist&quot;);</span>
<span class="nc" id="L718">    }</span>

    @Test
    public void testSignalNullExecutionId() {
<span class="nc" id="L722">        assertThatThrownBy(() -&gt; runtimeService.trigger(null))</span>
<span class="nc" id="L723">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L724">                .hasMessage(&quot;executionId is null&quot;);</span>
<span class="nc" id="L725">    }</span>

    @Test
    @Deployment
    public void testSignalWithProcessVariables() {

<span class="nc" id="L731">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;testSignalWithProcessVariables&quot;);</span>
<span class="nc" id="L732">        Map&lt;String, Object&gt; processVariables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L733">        processVariables.put(&quot;variable&quot;, &quot;value&quot;);</span>

        // signal the execution while passing in the variables
<span class="nc" id="L736">        Execution execution = runtimeService.createExecutionQuery().activityId(&quot;receiveMessage&quot;).singleResult();</span>
<span class="nc" id="L737">        runtimeService.trigger(execution.getId(), processVariables);</span>

<span class="nc" id="L739">        Map&lt;String, Object&gt; variables = runtimeService.getVariables(processInstance.getId());</span>
<span class="nc" id="L740">        assertThat(variables).isEqualTo(processVariables);</span>
<span class="nc" id="L741">    }</span>

    @Test
    public void testGetVariablesUnexistingExecutionId() {
<span class="nc" id="L745">        assertThatThrownBy(() -&gt; runtimeService.getVariables(&quot;unexistingExecutionId&quot;))</span>
<span class="nc" id="L746">                .isExactlyInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L747">                .hasMessage(&quot;execution unexistingExecutionId doesn't exist&quot;);</span>
<span class="nc" id="L748">    }</span>

    @Test
    public void testGetVariablesNullExecutionId() {
<span class="nc" id="L752">        assertThatThrownBy(() -&gt; runtimeService.getVariables(null))</span>
<span class="nc" id="L753">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L754">                .hasMessage(&quot;executionId is null&quot;);</span>
<span class="nc" id="L755">    }</span>

    @Test
    public void testGetVariableUnexistingExecutionId() {
<span class="nc" id="L759">        assertThatThrownBy(() -&gt; runtimeService.getVariable(&quot;unexistingExecutionId&quot;, &quot;var&quot;))</span>
<span class="nc" id="L760">                .isExactlyInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L761">                .hasMessage(&quot;execution unexistingExecutionId doesn't exist&quot;);</span>
<span class="nc" id="L762">    }</span>

    @Test
    public void testGetVariableNullExecutionId() {
<span class="nc" id="L766">        assertThatThrownBy(() -&gt; runtimeService.getVariable(null, &quot;var&quot;))</span>
<span class="nc" id="L767">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L768">                .hasMessage(&quot;executionId is null&quot;);</span>
<span class="nc" id="L769">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testGetVariableUnexistingVariableName() {
<span class="nc" id="L774">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L775">        Object variableValue = runtimeService.getVariable(processInstance.getId(), &quot;unexistingVariable&quot;);</span>
<span class="nc" id="L776">        assertThat(variableValue).isNull();</span>
<span class="nc" id="L777">    }</span>

    @Test
    public void testSetVariableUnexistingExecutionId() {
<span class="nc" id="L781">        assertThatThrownBy(() -&gt; runtimeService.setVariable(&quot;unexistingExecutionId&quot;, &quot;variableName&quot;, &quot;value&quot;))</span>
<span class="nc" id="L782">                .isExactlyInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L783">                .hasMessage(&quot;execution unexistingExecutionId doesn't exist&quot;);</span>
<span class="nc" id="L784">    }</span>

    @Test
    public void testSetVariableNullExecutionId() {
<span class="nc" id="L788">        assertThatThrownBy(() -&gt; runtimeService.setVariable(null, &quot;variableName&quot;, &quot;value&quot;))</span>
<span class="nc" id="L789">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L790">                .hasMessage(&quot;executionId is null&quot;);</span>
<span class="nc" id="L791">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testSetVariableNullVariableName() {
<span class="nc" id="L796">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L797">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L798">            runtimeService.setVariable(processInstance.getId(), null, &quot;variableValue&quot;);</span>
<span class="nc" id="L799">        })</span>
<span class="nc" id="L800">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L801">                .hasMessage(&quot;variableName is null&quot;);</span>
<span class="nc" id="L802">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testSetVariables() {
<span class="nc" id="L807">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L808">        vars.put(&quot;variable1&quot;, &quot;value1&quot;);</span>
<span class="nc" id="L809">        vars.put(&quot;variable2&quot;, &quot;value2&quot;);</span>

<span class="nc" id="L811">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L812">        runtimeService.setVariables(processInstance.getId(), vars);</span>

<span class="nc" id="L814">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;variable1&quot;)).isEqualTo(&quot;value1&quot;);</span>
<span class="nc" id="L815">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;variable2&quot;)).isEqualTo(&quot;value2&quot;);</span>
<span class="nc" id="L816">    }</span>

    @Test
    public void testSetVariablesUnexistingExecutionId() {
<span class="nc" id="L820">        assertThatThrownBy(() -&gt; runtimeService.setVariables(&quot;unexistingexecution&quot;, new HashMap&lt;&gt;()))</span>
<span class="nc" id="L821">                .isInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L822">                .hasMessage(&quot;execution unexistingexecution doesn't exist&quot;);</span>
<span class="nc" id="L823">    }</span>

    @Test
    public void testSetVariablesNullExecutionId() {
<span class="nc" id="L827">        assertThatThrownBy(() -&gt; runtimeService.setVariables(null, new HashMap&lt;&gt;()))</span>
<span class="nc" id="L828">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L829">                .hasMessage(&quot;executionId is null&quot;);</span>
<span class="nc" id="L830">    }</span>

    private void checkHistoricVariableUpdateEntity(String variableName, String processInstanceId) {
<span class="nc bnc" id="L833" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.FULL, processEngineConfiguration)) {</span>
<span class="nc" id="L834">            boolean deletedVariableUpdateFound = false;</span>

<span class="nc" id="L836">            List&lt;HistoricDetail&gt; resultSet = historyService.createHistoricDetailQuery().processInstanceId(processInstanceId).list();</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">            for (HistoricDetail currentHistoricDetail : resultSet) {</span>
<span class="nc" id="L838">                assertThat(currentHistoricDetail).isInstanceOf(HistoricDetailVariableInstanceUpdateEntity.class);</span>
<span class="nc" id="L839">                HistoricDetailVariableInstanceUpdateEntity historicVariableUpdate = (HistoricDetailVariableInstanceUpdateEntity) currentHistoricDetail;</span>

<span class="nc bnc" id="L841" title="All 2 branches missed.">                if (historicVariableUpdate.getName().equals(variableName)) {</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">                    if (historicVariableUpdate.getValue() == null) {</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">                        if (deletedVariableUpdateFound) {</span>
<span class="nc" id="L844">                            fail(&quot;Mismatch: A HistoricVariableUpdateEntity with a null value already found&quot;);</span>
                        } else {
<span class="nc" id="L846">                            deletedVariableUpdateFound = true;</span>
                        }
                    }
                }
<span class="nc" id="L850">            }</span>

<span class="nc" id="L852">            assertThat(deletedVariableUpdateFound).isTrue();</span>
        }
<span class="nc" id="L854">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testRemoveVariable() {
<span class="nc" id="L859">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L860">        vars.put(&quot;variable1&quot;, &quot;value1&quot;);</span>
<span class="nc" id="L861">        vars.put(&quot;variable2&quot;, &quot;value2&quot;);</span>

<span class="nc" id="L863">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L864">        runtimeService.setVariables(processInstance.getId(), vars);</span>

<span class="nc" id="L866">        runtimeService.removeVariable(processInstance.getId(), &quot;variable1&quot;);</span>

<span class="nc" id="L868">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;variable1&quot;)).isNull();</span>
<span class="nc" id="L869">        assertThat(runtimeService.getVariableLocal(processInstance.getId(), &quot;variable1&quot;)).isNull();</span>
<span class="nc" id="L870">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;variable2&quot;)).isEqualTo(&quot;value2&quot;);</span>

<span class="nc" id="L872">        checkHistoricVariableUpdateEntity(&quot;variable1&quot;, processInstance.getId());</span>
<span class="nc" id="L873">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneSubProcess.bpmn20.xml&quot; })
    public void testRemoveVariableInParentScope() {
<span class="nc" id="L878">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L879">        vars.put(&quot;variable1&quot;, &quot;value1&quot;);</span>
<span class="nc" id="L880">        vars.put(&quot;variable2&quot;, &quot;value2&quot;);</span>

<span class="nc" id="L882">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;, vars);</span>
<span class="nc" id="L883">        org.flowable.task.api.Task currentTask = taskService.createTaskQuery().singleResult();</span>

<span class="nc" id="L885">        runtimeService.removeVariable(currentTask.getExecutionId(), &quot;variable1&quot;);</span>

<span class="nc" id="L887">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;variable1&quot;)).isNull();</span>
<span class="nc" id="L888">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;variable2&quot;)).isEqualTo(&quot;value2&quot;);</span>

<span class="nc" id="L890">        checkHistoricVariableUpdateEntity(&quot;variable1&quot;, processInstance.getId());</span>
<span class="nc" id="L891">    }</span>

    @Test
    public void testRemoveVariableNullExecutionId() {
<span class="nc" id="L895">        assertThatThrownBy(() -&gt; runtimeService.removeVariable(null, &quot;variable&quot;))</span>
<span class="nc" id="L896">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L897">                .hasMessage(&quot;executionId is null&quot;);</span>
<span class="nc" id="L898">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testRemoveVariableLocal() {
<span class="nc" id="L903">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L904">        vars.put(&quot;variable1&quot;, &quot;value1&quot;);</span>
<span class="nc" id="L905">        vars.put(&quot;variable2&quot;, &quot;value2&quot;);</span>

<span class="nc" id="L907">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>
<span class="nc" id="L908">        runtimeService.removeVariableLocal(processInstance.getId(), &quot;variable1&quot;);</span>

<span class="nc" id="L910">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;variable1&quot;)).isNull();</span>
<span class="nc" id="L911">        assertThat(runtimeService.getVariableLocal(processInstance.getId(), &quot;variable1&quot;)).isNull();</span>
<span class="nc" id="L912">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;variable2&quot;)).isEqualTo(&quot;value2&quot;);</span>

<span class="nc" id="L914">        checkHistoricVariableUpdateEntity(&quot;variable1&quot;, processInstance.getId());</span>
<span class="nc" id="L915">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneSubProcess.bpmn20.xml&quot; })
    public void testRemoveVariableLocalWithParentScope() {
<span class="nc" id="L920">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L921">        vars.put(&quot;variable1&quot;, &quot;value1&quot;);</span>
<span class="nc" id="L922">        vars.put(&quot;variable2&quot;, &quot;value2&quot;);</span>

<span class="nc" id="L924">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;, vars);</span>
<span class="nc" id="L925">        org.flowable.task.api.Task currentTask = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L926">        runtimeService.setVariableLocal(currentTask.getExecutionId(), &quot;localVariable&quot;, &quot;local value&quot;);</span>

<span class="nc" id="L928">        assertThat(runtimeService.getVariableLocal(currentTask.getExecutionId(), &quot;localVariable&quot;)).isEqualTo(&quot;local value&quot;);</span>

<span class="nc" id="L930">        runtimeService.removeVariableLocal(currentTask.getExecutionId(), &quot;localVariable&quot;);</span>

<span class="nc" id="L932">        assertThat(runtimeService.getVariable(currentTask.getExecutionId(), &quot;localVariable&quot;)).isNull();</span>
<span class="nc" id="L933">        assertThat(runtimeService.getVariableLocal(currentTask.getExecutionId(), &quot;localVariable&quot;)).isNull();</span>

<span class="nc" id="L935">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;variable1&quot;)).isEqualTo(&quot;value1&quot;);</span>
<span class="nc" id="L936">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;variable2&quot;)).isEqualTo(&quot;value2&quot;);</span>

<span class="nc" id="L938">        assertThat(runtimeService.getVariable(currentTask.getExecutionId(), &quot;variable1&quot;)).isEqualTo(&quot;value1&quot;);</span>
<span class="nc" id="L939">        assertThat(runtimeService.getVariable(currentTask.getExecutionId(), &quot;variable2&quot;)).isEqualTo(&quot;value2&quot;);</span>

<span class="nc" id="L941">        checkHistoricVariableUpdateEntity(&quot;localVariable&quot;, processInstance.getId());</span>
<span class="nc" id="L942">    }</span>

    @Test
    public void testRemoveLocalVariableNullExecutionId() {
<span class="nc" id="L946">        assertThatThrownBy(() -&gt; runtimeService.removeVariableLocal(null, &quot;variable&quot;))</span>
<span class="nc" id="L947">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L948">                .hasMessage(&quot;executionId is null&quot;);</span>
<span class="nc" id="L949">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testRemoveVariables() {
<span class="nc" id="L954">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L955">        vars.put(&quot;variable1&quot;, &quot;value1&quot;);</span>
<span class="nc" id="L956">        vars.put(&quot;variable2&quot;, &quot;value2&quot;);</span>

<span class="nc" id="L958">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>
<span class="nc" id="L959">        runtimeService.setVariable(processInstance.getId(), &quot;variable3&quot;, &quot;value3&quot;);</span>

<span class="nc" id="L961">        runtimeService.removeVariables(processInstance.getId(), vars.keySet());</span>

<span class="nc" id="L963">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;variable1&quot;)).isNull();</span>
<span class="nc" id="L964">        assertThat(runtimeService.getVariableLocal(processInstance.getId(), &quot;variable1&quot;)).isNull();</span>
<span class="nc" id="L965">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;variable2&quot;)).isNull();</span>
<span class="nc" id="L966">        assertThat(runtimeService.getVariableLocal(processInstance.getId(), &quot;variable2&quot;)).isNull();</span>

<span class="nc" id="L968">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;variable3&quot;)).isEqualTo(&quot;value3&quot;);</span>
<span class="nc" id="L969">        assertThat(runtimeService.getVariableLocal(processInstance.getId(), &quot;variable3&quot;)).isEqualTo(&quot;value3&quot;);</span>

<span class="nc" id="L971">        checkHistoricVariableUpdateEntity(&quot;variable1&quot;, processInstance.getId());</span>
<span class="nc" id="L972">        checkHistoricVariableUpdateEntity(&quot;variable2&quot;, processInstance.getId());</span>
<span class="nc" id="L973">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneSubProcess.bpmn20.xml&quot; })
    public void testRemoveVariablesWithParentScope() {
<span class="nc" id="L978">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L979">        vars.put(&quot;variable1&quot;, &quot;value1&quot;);</span>
<span class="nc" id="L980">        vars.put(&quot;variable2&quot;, &quot;value2&quot;);</span>

<span class="nc" id="L982">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;, vars);</span>
<span class="nc" id="L983">        runtimeService.setVariable(processInstance.getId(), &quot;variable3&quot;, &quot;value3&quot;);</span>

<span class="nc" id="L985">        org.flowable.task.api.Task currentTask = taskService.createTaskQuery().singleResult();</span>

<span class="nc" id="L987">        runtimeService.removeVariables(currentTask.getExecutionId(), vars.keySet());</span>

<span class="nc" id="L989">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;variable1&quot;)).isNull();</span>
<span class="nc" id="L990">        assertThat(runtimeService.getVariableLocal(processInstance.getId(), &quot;variable1&quot;)).isNull();</span>
<span class="nc" id="L991">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;variable2&quot;)).isNull();</span>
<span class="nc" id="L992">        assertThat(runtimeService.getVariableLocal(processInstance.getId(), &quot;variable2&quot;)).isNull();</span>

<span class="nc" id="L994">        assertThat(runtimeService.getVariable(processInstance.getId(), &quot;variable3&quot;)).isEqualTo(&quot;value3&quot;);</span>
<span class="nc" id="L995">        assertThat(runtimeService.getVariableLocal(processInstance.getId(), &quot;variable3&quot;)).isEqualTo(&quot;value3&quot;);</span>

<span class="nc" id="L997">        assertThat(runtimeService.getVariable(currentTask.getExecutionId(), &quot;variable1&quot;)).isNull();</span>
<span class="nc" id="L998">        assertThat(runtimeService.getVariable(currentTask.getExecutionId(), &quot;variable2&quot;)).isNull();</span>

<span class="nc" id="L1000">        assertThat(runtimeService.getVariable(currentTask.getExecutionId(), &quot;variable3&quot;)).isEqualTo(&quot;value3&quot;);</span>

<span class="nc" id="L1002">        checkHistoricVariableUpdateEntity(&quot;variable1&quot;, processInstance.getId());</span>
<span class="nc" id="L1003">        checkHistoricVariableUpdateEntity(&quot;variable2&quot;, processInstance.getId());</span>
<span class="nc" id="L1004">    }</span>

    @Test
    public void testRemoveVariablesNullExecutionId() {
<span class="nc" id="L1008">        assertThatThrownBy(() -&gt; runtimeService.removeVariables(null, new HashSet&lt;&gt;()))</span>
<span class="nc" id="L1009">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1010">                .hasMessage(&quot;executionId is null&quot;);</span>
<span class="nc" id="L1011">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneSubProcess.bpmn20.xml&quot; })
    public void testRemoveVariablesLocalWithParentScope() {
<span class="nc" id="L1016">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1017">        vars.put(&quot;variable1&quot;, &quot;value1&quot;);</span>
<span class="nc" id="L1018">        vars.put(&quot;variable2&quot;, &quot;value2&quot;);</span>

<span class="nc" id="L1020">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;startSimpleSubProcess&quot;, vars);</span>

<span class="nc" id="L1022">        org.flowable.task.api.Task currentTask = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L1023">        Map&lt;String, Object&gt; varsToDelete = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1024">        varsToDelete.put(&quot;variable3&quot;, &quot;value3&quot;);</span>
<span class="nc" id="L1025">        varsToDelete.put(&quot;variable4&quot;, &quot;value4&quot;);</span>
<span class="nc" id="L1026">        varsToDelete.put(&quot;variable5&quot;, &quot;value5&quot;);</span>
<span class="nc" id="L1027">        runtimeService.setVariablesLocal(currentTask.getExecutionId(), varsToDelete);</span>
<span class="nc" id="L1028">        runtimeService.setVariableLocal(currentTask.getExecutionId(), &quot;variable6&quot;, &quot;value6&quot;);</span>

<span class="nc" id="L1030">        assertThat(runtimeService.getVariable(currentTask.getExecutionId(), &quot;variable3&quot;)).isEqualTo(&quot;value3&quot;);</span>
<span class="nc" id="L1031">        assertThat(runtimeService.getVariableLocal(currentTask.getExecutionId(), &quot;variable3&quot;)).isEqualTo(&quot;value3&quot;);</span>
<span class="nc" id="L1032">        assertThat(runtimeService.getVariable(currentTask.getExecutionId(), &quot;variable4&quot;)).isEqualTo(&quot;value4&quot;);</span>
<span class="nc" id="L1033">        assertThat(runtimeService.getVariableLocal(currentTask.getExecutionId(), &quot;variable4&quot;)).isEqualTo(&quot;value4&quot;);</span>
<span class="nc" id="L1034">        assertThat(runtimeService.getVariable(currentTask.getExecutionId(), &quot;variable5&quot;)).isEqualTo(&quot;value5&quot;);</span>
<span class="nc" id="L1035">        assertThat(runtimeService.getVariableLocal(currentTask.getExecutionId(), &quot;variable5&quot;)).isEqualTo(&quot;value5&quot;);</span>
<span class="nc" id="L1036">        assertThat(runtimeService.getVariable(currentTask.getExecutionId(), &quot;variable6&quot;)).isEqualTo(&quot;value6&quot;);</span>
<span class="nc" id="L1037">        assertThat(runtimeService.getVariableLocal(currentTask.getExecutionId(), &quot;variable6&quot;)).isEqualTo(&quot;value6&quot;);</span>

<span class="nc" id="L1039">        runtimeService.removeVariablesLocal(currentTask.getExecutionId(), varsToDelete.keySet());</span>

<span class="nc" id="L1041">        assertThat(runtimeService.getVariable(currentTask.getExecutionId(), &quot;variable1&quot;)).isEqualTo(&quot;value1&quot;);</span>
<span class="nc" id="L1042">        assertThat(runtimeService.getVariable(currentTask.getExecutionId(), &quot;variable2&quot;)).isEqualTo(&quot;value2&quot;);</span>

<span class="nc" id="L1044">        assertThat(runtimeService.getVariable(currentTask.getExecutionId(), &quot;variable3&quot;)).isNull();</span>
<span class="nc" id="L1045">        assertThat(runtimeService.getVariableLocal(currentTask.getExecutionId(), &quot;variable3&quot;)).isNull();</span>
<span class="nc" id="L1046">        assertThat(runtimeService.getVariable(currentTask.getExecutionId(), &quot;variable4&quot;)).isNull();</span>
<span class="nc" id="L1047">        assertThat(runtimeService.getVariableLocal(currentTask.getExecutionId(), &quot;variable4&quot;)).isNull();</span>
<span class="nc" id="L1048">        assertThat(runtimeService.getVariable(currentTask.getExecutionId(), &quot;variable5&quot;)).isNull();</span>
<span class="nc" id="L1049">        assertThat(runtimeService.getVariableLocal(currentTask.getExecutionId(), &quot;variable5&quot;)).isNull();</span>

<span class="nc" id="L1051">        assertThat(runtimeService.getVariable(currentTask.getExecutionId(), &quot;variable6&quot;)).isEqualTo(&quot;value6&quot;);</span>
<span class="nc" id="L1052">        assertThat(runtimeService.getVariableLocal(currentTask.getExecutionId(), &quot;variable6&quot;)).isEqualTo(&quot;value6&quot;);</span>

<span class="nc" id="L1054">        checkHistoricVariableUpdateEntity(&quot;variable3&quot;, processInstance.getId());</span>
<span class="nc" id="L1055">        checkHistoricVariableUpdateEntity(&quot;variable4&quot;, processInstance.getId());</span>
<span class="nc" id="L1056">        checkHistoricVariableUpdateEntity(&quot;variable5&quot;, processInstance.getId());</span>
<span class="nc" id="L1057">    }</span>

    @Test
    public void testRemoveVariablesLocalNullExecutionId() {
<span class="nc" id="L1061">        assertThatThrownBy(() -&gt; runtimeService.removeVariablesLocal(null, new HashSet&lt;&gt;()))</span>
<span class="nc" id="L1062">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1063">                .hasMessage(&quot;executionId is null&quot;);</span>
<span class="nc" id="L1064">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/RuntimeServiceTest.catchAlertSignal.bpmn20.xml&quot;,
        &quot;org/flowable/engine/test/api/runtime/RuntimeServiceTest.catchPanicSignal.bpmn20.xml&quot; })
    public void testSignalEventReceived() {

<span class="nc" id="L1071">        startSignalCatchProcesses();</span>
        // 15, because the signal catch is a scope
<span class="nc" id="L1073">        assertThat(runtimeService.createExecutionQuery().count()).isEqualTo(15);</span>
<span class="nc" id="L1074">        runtimeService.signalEventReceived(&quot;alert&quot;);</span>
<span class="nc" id="L1075">        assertThat(runtimeService.createExecutionQuery().count()).isEqualTo(9);</span>
<span class="nc" id="L1076">        runtimeService.signalEventReceived(&quot;panic&quot;);</span>
<span class="nc" id="L1077">        assertThat(runtimeService.createExecutionQuery().count()).isZero();</span>

        // //// test signalEventReceived(String, String)
<span class="nc" id="L1080">        startSignalCatchProcesses();</span>

        // signal the executions one at a time:
<span class="nc bnc" id="L1083" title="All 2 branches missed.">        for (int executions = 3; executions &gt; 0; executions--) {</span>
<span class="nc" id="L1084">            List&lt;Execution&gt; page = runtimeService.createExecutionQuery().signalEventSubscriptionName(&quot;alert&quot;).listPage(0, 1);</span>
<span class="nc" id="L1085">            runtimeService.signalEventReceived(&quot;alert&quot;, page.get(0).getId());</span>

<span class="nc" id="L1087">            assertThat(runtimeService.createExecutionQuery().signalEventSubscriptionName(&quot;alert&quot;).count()).isEqualTo(executions - 1);</span>
        }

<span class="nc bnc" id="L1090" title="All 2 branches missed.">        for (int executions = 3; executions &gt; 0; executions--) {</span>
<span class="nc" id="L1091">            List&lt;Execution&gt; page = runtimeService.createExecutionQuery().signalEventSubscriptionName(&quot;panic&quot;).listPage(0, 1);</span>
<span class="nc" id="L1092">            runtimeService.signalEventReceived(&quot;panic&quot;, page.get(0).getId());</span>

<span class="nc" id="L1094">            assertThat(runtimeService.createExecutionQuery().signalEventSubscriptionName(&quot;panic&quot;).count()).isEqualTo(executions - 1);</span>
        }

<span class="nc" id="L1097">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/RuntimeServiceTest.catchAlertMessage.bpmn20.xml&quot;,
        &quot;org/flowable/engine/test/api/runtime/RuntimeServiceTest.catchPanicMessage.bpmn20.xml&quot; })
    public void testMessageEventReceived() {

<span class="nc" id="L1104">        startMessageCatchProcesses();</span>
        // 12, because the signal catch is a scope
<span class="nc" id="L1106">        assertThat(runtimeService.createExecutionQuery().count()).isEqualTo(12);</span>

        // signal the executions one at a time:
<span class="nc bnc" id="L1109" title="All 2 branches missed.">        for (int executions = 3; executions &gt; 0; executions--) {</span>
<span class="nc" id="L1110">            List&lt;Execution&gt; page = runtimeService.createExecutionQuery().messageEventSubscriptionName(&quot;alert&quot;).listPage(0, 1);</span>
<span class="nc" id="L1111">            runtimeService.messageEventReceived(&quot;alert&quot;, page.get(0).getId());</span>

<span class="nc" id="L1113">            assertThat(runtimeService.createExecutionQuery().messageEventSubscriptionName(&quot;alert&quot;).count()).isEqualTo(executions - 1);</span>
        }

<span class="nc bnc" id="L1116" title="All 2 branches missed.">        for (int executions = 3; executions &gt; 0; executions--) {</span>
<span class="nc" id="L1117">            List&lt;Execution&gt; page = runtimeService.createExecutionQuery().messageEventSubscriptionName(&quot;panic&quot;).listPage(0, 1);</span>
<span class="nc" id="L1118">            runtimeService.messageEventReceived(&quot;panic&quot;, page.get(0).getId());</span>

<span class="nc" id="L1120">            assertThat(runtimeService.createExecutionQuery().messageEventSubscriptionName(&quot;panic&quot;).count()).isEqualTo(executions - 1);</span>
        }

<span class="nc" id="L1123">    }</span>

    @Test
    public void testSignalEventReceivedNonExistingExecution() {
<span class="nc" id="L1127">        assertThatThrownBy(() -&gt; runtimeService.signalEventReceived(&quot;alert&quot;, &quot;nonexistingExecution&quot;))</span>
<span class="nc" id="L1128">                .isExactlyInstanceOf(FlowableObjectNotFoundException.class);</span>
<span class="nc" id="L1129">    }</span>

    @Test
    public void testMessageEventReceivedNonExistingExecution() {
<span class="nc" id="L1133">        assertThatThrownBy(() -&gt; runtimeService.messageEventReceived(&quot;alert&quot;, &quot;nonexistingExecution&quot;))</span>
<span class="nc" id="L1134">                .isExactlyInstanceOf(FlowableObjectNotFoundException.class);</span>
<span class="nc" id="L1135">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/RuntimeServiceTest.catchAlertSignal.bpmn20.xml&quot; })
    public void testExecutionWaitingForDifferentSignal() {
<span class="nc" id="L1140">        runtimeService.startProcessInstanceByKey(&quot;catchAlertSignal&quot;);</span>
<span class="nc" id="L1141">        Execution execution = runtimeService.createExecutionQuery().signalEventSubscriptionName(&quot;alert&quot;).singleResult();</span>
<span class="nc" id="L1142">        assertThatThrownBy(() -&gt; runtimeService.signalEventReceived(&quot;bogusSignal&quot;, execution.getId()))</span>
<span class="nc" id="L1143">                .isExactlyInstanceOf(FlowableException.class);</span>

<span class="nc" id="L1145">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testSetProcessInstanceName() {
<span class="nc" id="L1150">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L1151">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L1152">        assertThat(processInstance.getName()).isNull();</span>

        // Set the name
<span class="nc" id="L1155">        runtimeService.setProcessInstanceName(processInstance.getId(), &quot;New name&quot;);</span>
<span class="nc" id="L1156">        processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1157">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L1158">        assertThat(processInstance.getName()).isEqualTo(&quot;New name&quot;);</span>

        // Set the name to null
<span class="nc" id="L1161">        runtimeService.setProcessInstanceName(processInstance.getId(), null);</span>
<span class="nc" id="L1162">        processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1163">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L1164">        assertThat(processInstance.getName()).isNull();</span>

        // Set name for unexisting process instance, should fail
<span class="nc" id="L1167">        assertThatThrownBy(() -&gt; runtimeService.setProcessInstanceName(&quot;unexisting&quot;, null))</span>
<span class="nc" id="L1168">                .isExactlyInstanceOf(FlowableObjectNotFoundException.class);</span>

<span class="nc" id="L1170">        processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1171">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L1172">        assertThat(processInstance.getName()).isNull();</span>

        // Set name for suspended process instance, should fail
<span class="nc" id="L1175">        String processInstanceId = processInstance.getId();</span>
<span class="nc" id="L1176">        runtimeService.suspendProcessInstanceById(processInstanceId);</span>
<span class="nc" id="L1177">        assertThatThrownBy(() -&gt; runtimeService.setProcessInstanceName(processInstanceId, null))</span>
<span class="nc" id="L1178">                .isExactlyInstanceOf(FlowableException.class)</span>
<span class="nc" id="L1179">                .hasMessage(&quot;process instance &quot; + processInstanceId + &quot; is suspended, cannot set name&quot;);</span>

<span class="nc" id="L1181">        processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1182">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L1183">        assertThat(processInstance.getName()).isNull();</span>
<span class="nc" id="L1184">    }</span>

    private void startSignalCatchProcesses() {
<span class="nc bnc" id="L1187" title="All 2 branches missed.">        for (int i = 0; i &lt; 3; i++) {</span>
<span class="nc" id="L1188">            runtimeService.startProcessInstanceByKey(&quot;catchAlertSignal&quot;);</span>
<span class="nc" id="L1189">            runtimeService.startProcessInstanceByKey(&quot;catchPanicSignal&quot;);</span>
        }
<span class="nc" id="L1191">    }</span>

    private void startMessageCatchProcesses() {
<span class="nc bnc" id="L1194" title="All 2 branches missed.">        for (int i = 0; i &lt; 3; i++) {</span>
<span class="nc" id="L1195">            runtimeService.startProcessInstanceByKey(&quot;catchAlertMessage&quot;);</span>
<span class="nc" id="L1196">            runtimeService.startProcessInstanceByKey(&quot;catchPanicMessage&quot;);</span>
        }
<span class="nc" id="L1198">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testGetVariableUnexistingVariableNameWithCast() {
<span class="nc" id="L1203">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L1204">        String variableValue = runtimeService.getVariable(processInstance.getId(), &quot;unexistingVariable&quot;, String.class);</span>
<span class="nc" id="L1205">        assertThat(variableValue).isNull();</span>
<span class="nc" id="L1206">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testGetVariableExistingVariableNameWithCast() {
<span class="nc" id="L1211">        Map&lt;String, Object&gt; params = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1212">        params.put(&quot;var1&quot;, true);</span>
<span class="nc" id="L1213">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, params);</span>
<span class="nc" id="L1214">        Boolean variableValue = runtimeService.getVariable(processInstance.getId(), &quot;var1&quot;, Boolean.class);</span>
<span class="nc" id="L1215">        assertThat(variableValue).isTrue();</span>
<span class="nc" id="L1216">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testGetVariableExistingVariableNameWithInvalidCast() {
<span class="nc" id="L1221">        Map&lt;String, Object&gt; params = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1222">        params.put(&quot;var1&quot;, true);</span>
<span class="nc" id="L1223">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, params);</span>
<span class="nc" id="L1224">        assertThatThrownBy(() -&gt; runtimeService.getVariable(processInstance.getId(), &quot;var1&quot;, String.class))</span>
<span class="nc" id="L1225">            .isExactlyInstanceOf(ClassCastException.class);</span>
<span class="nc" id="L1226">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testGetVariableLocalUnexistingVariableNameWithCast() {
<span class="nc" id="L1231">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L1232">        String variableValue = runtimeService.getVariableLocal(processInstance.getId(), &quot;var1&quot;, String.class);</span>
<span class="nc" id="L1233">        assertThat(variableValue).isNull();</span>
<span class="nc" id="L1234">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testGetVariableLocalExistingVariableNameWithCast() {
<span class="nc" id="L1239">        Map&lt;String, Object&gt; params = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1240">        params.put(&quot;var1&quot;, true);</span>
<span class="nc" id="L1241">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, params);</span>
<span class="nc" id="L1242">        Boolean variableValue = runtimeService.getVariableLocal(processInstance.getId(), &quot;var1&quot;, Boolean.class);</span>
<span class="nc" id="L1243">        assertThat(variableValue).isTrue();</span>
<span class="nc" id="L1244">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testGetVariableLocalExistingVariableNameWithInvalidCast() {
<span class="nc" id="L1249">        Map&lt;String, Object&gt; params = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1250">        params.put(&quot;var1&quot;, true);</span>
<span class="nc" id="L1251">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, params);</span>
<span class="nc" id="L1252">        assertThatThrownBy(() -&gt; runtimeService.getVariableLocal(processInstance.getId(), &quot;var1&quot;, String.class))</span>
<span class="nc" id="L1253">            .isExactlyInstanceOf(ClassCastException.class);</span>
<span class="nc" id="L1254">    }</span>

    // Test for https://activiti.atlassian.net/browse/ACT-2186
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testHistoricVariableRemovedWhenRuntimeVariableIsRemoved() {
<span class="nc bnc" id="L1260" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1261">            Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1262">            vars.put(&quot;var1&quot;, &quot;Hello&quot;);</span>
<span class="nc" id="L1263">            vars.put(&quot;var2&quot;, &quot;World&quot;);</span>
<span class="nc" id="L1264">            vars.put(&quot;var3&quot;, &quot;!&quot;);</span>
<span class="nc" id="L1265">            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

            // Verify runtime
<span class="nc" id="L1268">            assertThat(runtimeService.getVariables(processInstance.getId())).hasSize(3);</span>
<span class="nc" id="L1269">            assertThat(runtimeService.getVariables(processInstance.getId(), Arrays.asList(&quot;var1&quot;, &quot;var2&quot;, &quot;var3&quot;))).hasSize(3);</span>
<span class="nc" id="L1270">            assertThat(runtimeService.getVariable(processInstance.getId(), &quot;var2&quot;)).isNotNull();</span>

<span class="nc" id="L1272">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

            // Verify history
<span class="nc" id="L1275">            assertThat(historyService.createHistoricVariableInstanceQuery().list()).hasSize(3);</span>
<span class="nc" id="L1276">            assertThat(historyService.createHistoricVariableInstanceQuery().processInstanceId(processInstance.getId()).variableName(&quot;var2&quot;).singleResult())</span>
<span class="nc" id="L1277">                    .isNotNull();</span>

            // Remove one variable
<span class="nc" id="L1280">            runtimeService.removeVariable(processInstance.getId(), &quot;var2&quot;);</span>

<span class="nc" id="L1282">            waitForHistoryJobExecutorToProcessAllJobs(7000, 100);</span>

            // Verify runtime
<span class="nc" id="L1285">            assertThat(runtimeService.getVariables(processInstance.getId())).hasSize(2);</span>
<span class="nc" id="L1286">            assertThat(runtimeService.getVariables(processInstance.getId(), Arrays.asList(&quot;var1&quot;, &quot;var2&quot;, &quot;var3&quot;))).hasSize(2);</span>
<span class="nc" id="L1287">            assertThat(runtimeService.getVariable(processInstance.getId(), &quot;var2&quot;)).isNull();</span>

            // Verify history
<span class="nc" id="L1290">            assertThat(historyService.createHistoricVariableInstanceQuery().list()).hasSize(2);</span>
<span class="nc" id="L1291">            assertThat(historyService.createHistoricVariableInstanceQuery().processInstanceId(processInstance.getId()).variableName(&quot;var2&quot;).singleResult())</span>
<span class="nc" id="L1292">                    .isNull();</span>
        }
<span class="nc" id="L1294">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testStartTimeProcessInstance() {
<span class="nc" id="L1299">        Calendar calendar = new GregorianCalendar();</span>
<span class="nc" id="L1300">        calendar.set(Calendar.YEAR, 2010);</span>
<span class="nc" id="L1301">        calendar.set(Calendar.MONTH, 8);</span>
<span class="nc" id="L1302">        calendar.set(Calendar.DAY_OF_MONTH, 30);</span>
<span class="nc" id="L1303">        calendar.set(Calendar.HOUR_OF_DAY, 12);</span>
<span class="nc" id="L1304">        calendar.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L1305">        calendar.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L1306">        calendar.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L1307">        Date noon = calendar.getTime();</span>

<span class="nc" id="L1309">        processEngineConfiguration.getClock().setCurrentTime(noon);</span>
<span class="nc" id="L1310">        final ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L1312">        assertThat(processInstance.getStartTime()).isEqualTo(noon);</span>
<span class="nc" id="L1313">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testAuthenticatedStartUserProcessInstance() {
<span class="nc" id="L1318">        final String authenticatedUser = &quot;user1&quot;;</span>
<span class="nc" id="L1319">        identityService.setAuthenticatedUserId(authenticatedUser);</span>
<span class="nc" id="L1320">        final ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L1322">        assertThat(processInstance.getStartUserId()).isEqualTo(authenticatedUser);</span>
<span class="nc" id="L1323">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testNoAuthenticatedStartUserProcessInstance() {
<span class="nc" id="L1328">        final ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L1330">        assertThat(processInstance.getStartUserId()).isNull();</span>
<span class="nc" id="L1331">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot;)
    public void testAdhocCallbacks() {
<span class="nc" id="L1336">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L1337">                .callbackId(&quot;nonExistingCase&quot;)</span>
<span class="nc" id="L1338">                .callbackType(CallbackTypes.CASE_ADHOC_CHILD)</span>
<span class="nc" id="L1339">                .start();</span>

<span class="nc" id="L1341">        assertThat(processInstance.getCallbackId()).isEqualTo(&quot;nonExistingCase&quot;);</span>
<span class="nc" id="L1342">        assertThat(processInstance.getCallbackType()).isEqualTo(CallbackTypes.CASE_ADHOC_CHILD);</span>
<span class="nc" id="L1343">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testStartByProcessInstanceBuilderWithFallbackToDefaultTenant() {
<span class="nc" id="L1348">        ProcessInstanceBuilder processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>

<span class="nc" id="L1350">        ProcessInstance processInstance = processInstanceBuilder.processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L1351">                .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L1352">                .fallbackToDefaultTenant()</span>
<span class="nc" id="L1353">                .start();</span>

<span class="nc" id="L1355">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L1356">    }</span>

    @Test
    public void testStartByProcessInstanceBuilderWithFallbackToDefaultTenant_definitionNotFound() {
<span class="nc" id="L1360">        ProcessInstanceBuilder processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>

<span class="nc" id="L1362">        assertThatThrownBy(() -&gt; processInstanceBuilder.processDefinitionKey(&quot;nonExistingDefinition&quot;)</span>
<span class="nc" id="L1363">                .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L1364">                .fallbackToDefaultTenant()</span>
<span class="nc" id="L1365">                .start()</span>
        )
<span class="nc" id="L1367">                .isExactlyInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L1368">                .hasMessage(&quot;No process definition found for key 'nonExistingDefinition'. Fallback to default tenant was also applied.&quot;);</span>
<span class="nc" id="L1369">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; },
        tenantId = &quot;nonDefaultTenant&quot;
    )
    public void testStartByProcessInstanceBuilderWithFallbackToDefaultTenant_definitionNotFoundInNonDefaultTenant() {
<span class="nc" id="L1376">        ProcessInstanceBuilder processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>

<span class="nc" id="L1378">        assertThatThrownBy(() -&gt; processInstanceBuilder.processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L1379">                .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L1380">                .fallbackToDefaultTenant()</span>
<span class="nc" id="L1381">                .start()</span>
        )
<span class="nc" id="L1383">                .isExactlyInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L1384">                .hasMessage(&quot;No process definition found for key 'oneTaskProcess'. Fallback to default tenant was also applied.&quot;);</span>
<span class="nc" id="L1385">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testStartAsyncWithFallbackToDefaultTenant() {
<span class="nc" id="L1390">        ProcessInstanceBuilder processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>

<span class="nc" id="L1392">        ProcessInstance processInstance = processInstanceBuilder.processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L1393">                .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L1394">                .fallbackToDefaultTenant()</span>
<span class="nc" id="L1395">                .startAsync();</span>

<span class="nc" id="L1397">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L1398">    }</span>

    @Test
    public void testStartAsyncWithFallbackToDefaultTenant_definitionNotFound() {
<span class="nc" id="L1402">        ProcessInstanceBuilder processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>

<span class="nc" id="L1404">        assertThatThrownBy(() -&gt; processInstanceBuilder.processDefinitionKey(&quot;nonExistingDefinition&quot;)</span>
<span class="nc" id="L1405">                .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L1406">                .fallbackToDefaultTenant()</span>
<span class="nc" id="L1407">                .startAsync()</span>
        )
<span class="nc" id="L1409">                .isExactlyInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L1410">                .hasMessage(&quot;No process definition found for key 'nonExistingDefinition'. Fallback to default tenant was also applied.&quot;);</span>
<span class="nc" id="L1411">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; },
        tenantId = &quot;nonDefaultTenant&quot;
    )
    public void testStartAsyncWithFallbackToDefaultTenant_definitionNotFoundInNonDefaultTenant() {
<span class="nc" id="L1418">        ProcessInstanceBuilder processInstanceBuilder = runtimeService.createProcessInstanceBuilder();</span>

<span class="nc" id="L1420">        assertThatThrownBy(() -&gt; processInstanceBuilder.processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L1421">                .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L1422">                .fallbackToDefaultTenant()</span>
<span class="nc" id="L1423">                .startAsync()</span>
        )
<span class="nc" id="L1425">                .isExactlyInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L1426">                .hasMessage(&quot;No process definition found for key 'oneTaskProcess'. Fallback to default tenant was also applied.&quot;);</span>
<span class="nc" id="L1427">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot;)
    @SuppressWarnings({ &quot;rawtypes&quot;, &quot;unchecked&quot; })
    @MockitoSettings
    public void testStartProcessInstanceByProcessInstanceBuilderWithFormVariables(
            @Mock FormEngineConfigurationApi formEngineConfiguration,
            @Mock FormService formService
    ) {
        try {
<span class="nc" id="L1438">            Map engineConfigurations = processEngineConfiguration.getEngineConfigurations();</span>
<span class="nc" id="L1439">            engineConfigurations.put(EngineConfigurationConstants.KEY_FORM_ENGINE_CONFIG, formEngineConfiguration);</span>

<span class="nc" id="L1441">            ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().processDefinitionKey(</span>
<span class="nc" id="L1442">                    &quot;oneTaskProcess&quot;).latestVersion().singleResult();</span>
            
<span class="nc" id="L1444">            FormInfo formInfo = new FormInfo();</span>
<span class="nc" id="L1445">            when(formEngineConfiguration.getFormService()).thenReturn(formService);</span>
<span class="nc" id="L1446">            Map&lt;String, Object&gt; formVariables = Collections.singletonMap(&quot;intVar&quot;, 42);</span>
<span class="nc" id="L1447">            when(formService.getVariablesFromFormSubmission(&quot;theStart&quot;, &quot;startEvent&quot;, null, processDefinition.getId(), ScopeTypes.BPMN, </span>
                    formInfo, formVariables, &quot;simple&quot;))
<span class="nc" id="L1449">                    .thenReturn(Collections.singletonMap(&quot;otherIntVar&quot;, 150));</span>

<span class="nc" id="L1451">            String procId = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L1452">                    .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L1453">                    .formVariables(formVariables, formInfo, &quot;simple&quot;)</span>
<span class="nc" id="L1454">                    .start()</span>
<span class="nc" id="L1455">                    .getId();</span>

<span class="nc" id="L1457">            assertThat(runtimeService.getVariables(procId))</span>
<span class="nc" id="L1458">                    .containsOnly(</span>
<span class="nc" id="L1459">                            entry(&quot;otherIntVar&quot;, 150)</span>
                    );
        } finally {
<span class="nc" id="L1462">            processEngineConfiguration.getEngineConfigurations().remove(EngineConfigurationConstants.KEY_FORM_ENGINE_CONFIG);</span>
        }
<span class="nc" id="L1464">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>