<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProcessInstanceQueryTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.runtime</a> &gt; <span class="el_source">ProcessInstanceQueryTest.java</span></div><h1>ProcessInstanceQueryTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.engine.test.api.runtime;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.assertj.core.api.Assertions.tuple;

import java.text.SimpleDateFormat;
import java.time.Instant;
import java.time.temporal.ChronoUnit;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collections;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.stream.Collectors;

import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.api.FlowableIllegalArgumentException;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.engine.impl.test.HistoryTestHelper;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.repository.ProcessDefinition;
import org.flowable.engine.runtime.ActivityInstance;
import org.flowable.engine.runtime.Execution;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.runtime.ProcessInstanceQuery;
import org.flowable.engine.test.Deployment;
import org.flowable.task.api.Task;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import com.fasterxml.jackson.databind.node.ObjectNode;

/**
 * @author Joram Barrez
 * @author Tijs Rademakers
 * @author Frederik Heremans
 * @author Falko Menge
 * @author Filip Hrisafov
 */
<span class="nc" id="L59">public class ProcessInstanceQueryTest extends PluggableFlowableTestCase {</span>

    private static final int PROCESS_DEFINITION_KEY_DEPLOY_COUNT = 4;
    private static final int PROCESS_DEFINITION_KEY_2_DEPLOY_COUNT = 1;
    private static final int PROCESS_DEPLOY_COUNT = PROCESS_DEFINITION_KEY_DEPLOY_COUNT + PROCESS_DEFINITION_KEY_2_DEPLOY_COUNT;
    private static final String PROCESS_DEFINITION_KEY = &quot;oneTaskProcess&quot;;
    private static final String PROCESS_DEFINITION_KEY_2 = &quot;oneTaskProcess2&quot;;
    private static final String PROCESS_DEFINITION_NAME = &quot;oneTaskProcessName&quot;;
    private static final String PROCESS_DEFINITION_NAME_2 = &quot;oneTaskProcess2Name&quot;;
    private static final String PROCESS_DEFINITION_CATEGORY = &quot;org.flowable.engine.test.api.runtime.Category&quot;;
    private static final String PROCESS_DEFINITION_CATEGORY_2 = &quot;org.flowable.engine.test.api.runtime.2Category&quot;;

    private org.flowable.engine.repository.Deployment deployment;
    private List&lt;String&gt; processInstanceIds;

    /**
     * Setup starts 4 process instances of oneTaskProcess and 1 instance of oneTaskProcess2
     */
    @BeforeEach
    protected void setUp() throws Exception {
<span class="nc" id="L79">        deployment = repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/engine/test/api/runtime/oneTaskProcess.bpmn20.xml&quot;)</span>
<span class="nc" id="L80">                .addClasspathResource(&quot;org/flowable/engine/test/api/runtime/oneTaskProcess2.bpmn20.xml&quot;).deploy();</span>

<span class="nc" id="L82">        processInstanceIds = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        for (int i = 0; i &lt; PROCESS_DEFINITION_KEY_DEPLOY_COUNT; i++) {</span>
<span class="nc" id="L84">            String processInstanceId = runtimeService.startProcessInstanceByKey(PROCESS_DEFINITION_KEY, String.valueOf(i)).getId();</span>
<span class="nc" id="L85">            runtimeService.updateBusinessStatus(processInstanceId, String.valueOf(i));</span>
<span class="nc" id="L86">            processInstanceIds.add(processInstanceId);</span>
        }
        
<span class="nc" id="L89">        String processInstanceId = runtimeService.startProcessInstanceByKey(PROCESS_DEFINITION_KEY_2, &quot;1&quot;).getId();</span>
<span class="nc" id="L90">        runtimeService.updateBusinessStatus(processInstanceId, &quot;1&quot;);</span>
<span class="nc" id="L91">        processInstanceIds.add(processInstanceId);</span>
<span class="nc" id="L92">    }</span>

    @AfterEach
    protected void tearDown() throws Exception {
<span class="nc" id="L96">        deleteDeployments();</span>
<span class="nc" id="L97">    }</span>

    @Test
    public void testQueryNoSpecificsList() {
<span class="nc" id="L101">        ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery();</span>
<span class="nc" id="L102">        assertThat(query.count()).isEqualTo(PROCESS_DEPLOY_COUNT);</span>
<span class="nc" id="L103">        assertThat(query.list()).hasSize(PROCESS_DEPLOY_COUNT);</span>
<span class="nc" id="L104">    }</span>

    @Test
    public void testQueryNoSpecificsSingleResult() {
<span class="nc" id="L108">        ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery();</span>
<span class="nc" id="L109">        assertThatThrownBy(() -&gt; query.singleResult())</span>
<span class="nc" id="L110">                .isExactlyInstanceOf(FlowableException.class);</span>
<span class="nc" id="L111">    }</span>

    @Test
    public void testQueryByProcessDefinitionKeySingleResult() {
<span class="nc" id="L115">        ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery().processDefinitionKey(PROCESS_DEFINITION_KEY_2);</span>
<span class="nc" id="L116">        assertThat(query.count()).isEqualTo(PROCESS_DEFINITION_KEY_2_DEPLOY_COUNT);</span>
<span class="nc" id="L117">        assertThat(query.list()).hasSize(PROCESS_DEFINITION_KEY_2_DEPLOY_COUNT);</span>
<span class="nc" id="L118">        assertThat(query.singleResult()).isNotNull();</span>
<span class="nc" id="L119">    }</span>

    @Test
    public void testQueryByInvalidProcessDefinitionKey() {
<span class="nc" id="L123">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;invalid&quot;).singleResult()).isNull();</span>
<span class="nc" id="L124">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;invalid&quot;).list()).isEmpty();</span>
<span class="nc" id="L125">    }</span>

    @Test
    public void testQueryByProcessDefinitionKeyMultipleResults() {
<span class="nc" id="L129">        ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery().processDefinitionKey(PROCESS_DEFINITION_KEY);</span>
<span class="nc" id="L130">        assertThat(query.count()).isEqualTo(PROCESS_DEFINITION_KEY_DEPLOY_COUNT);</span>
<span class="nc" id="L131">        assertThat(query.list()).hasSize(PROCESS_DEFINITION_KEY_DEPLOY_COUNT);</span>
<span class="nc" id="L132">        assertThatThrownBy(() -&gt; query.singleResult())</span>
<span class="nc" id="L133">                .isExactlyInstanceOf(FlowableException.class);</span>
<span class="nc" id="L134">    }</span>

    @Test
    public void testQueryByProcessDefinitionKeys() {
<span class="nc" id="L138">        final Set&lt;String&gt; processDefinitionKeySet = new HashSet&lt;&gt;(2);</span>
<span class="nc" id="L139">        processDefinitionKeySet.add(PROCESS_DEFINITION_KEY);</span>
<span class="nc" id="L140">        processDefinitionKeySet.add(PROCESS_DEFINITION_KEY_2);</span>

<span class="nc" id="L142">        ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery().processDefinitionKeys(processDefinitionKeySet);</span>
<span class="nc" id="L143">        assertThat(query.count()).isEqualTo(PROCESS_DEPLOY_COUNT);</span>
<span class="nc" id="L144">        assertThat(query.list()).hasSize(PROCESS_DEPLOY_COUNT);</span>
<span class="nc" id="L145">        assertThatThrownBy(() -&gt; query.singleResult())</span>
<span class="nc" id="L146">                .isExactlyInstanceOf(FlowableException.class);</span>
<span class="nc" id="L147">    }</span>

    @Test
    public void testQueryByInvalidProcessDefinitionKeys() {
<span class="nc" id="L151">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().processDefinitionKeys(null))</span>
<span class="nc" id="L152">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>

<span class="nc" id="L154">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().processDefinitionKeys(Collections.emptySet()))</span>
<span class="nc" id="L155">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L156">    }</span>

    @Test
    public void testQueryByProcessInstanceId() {
<span class="nc bnc" id="L160" title="All 2 branches missed.">        for (String processInstanceId : processInstanceIds) {</span>
<span class="nc" id="L161">            assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(processInstanceId).singleResult()).isNotNull();</span>
<span class="nc" id="L162">            assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(processInstanceId).list()).hasSize(1);</span>
<span class="nc" id="L163">        }</span>
<span class="nc" id="L164">    }</span>

    @Test
    public void testQueryByProcessDefinitionCategory() {
<span class="nc" id="L168">        List&lt;ProcessInstance&gt; instances = runtimeService.createProcessInstanceQuery().processDefinitionCategory(PROCESS_DEFINITION_CATEGORY).list();</span>
<span class="nc" id="L169">        assertThat(instances).hasSize(PROCESS_DEFINITION_KEY_DEPLOY_COUNT);</span>

<span class="nc" id="L171">        assertThat(instances)</span>
<span class="nc" id="L172">                .extracting(ProcessInstance::getBusinessKey, ProcessInstance::getProcessDefinitionKey, ProcessInstance::getProcessDefinitionName,</span>
                        ProcessInstance::getProcessDefinitionVersion, ProcessInstance::getProcessDefinitionCategory, ProcessInstance::getDeploymentId)
<span class="nc" id="L174">                .as(&quot;businessKey, processDefinitionKey, processDefinitionName, processDefinitionVersion, processDefinitionCategory, deploymentId&quot;)</span>
<span class="nc" id="L175">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L176">                        tuple(&quot;0&quot;, PROCESS_DEFINITION_KEY, &quot;oneTaskProcessName&quot;, 1, PROCESS_DEFINITION_CATEGORY, deployment.getId()),</span>
<span class="nc" id="L177">                        tuple(&quot;1&quot;, PROCESS_DEFINITION_KEY, &quot;oneTaskProcessName&quot;, 1, PROCESS_DEFINITION_CATEGORY, deployment.getId()),</span>
<span class="nc" id="L178">                        tuple(&quot;2&quot;, PROCESS_DEFINITION_KEY, &quot;oneTaskProcessName&quot;, 1, PROCESS_DEFINITION_CATEGORY, deployment.getId()),</span>
<span class="nc" id="L179">                        tuple(&quot;3&quot;, PROCESS_DEFINITION_KEY, &quot;oneTaskProcessName&quot;, 1, PROCESS_DEFINITION_CATEGORY, deployment.getId()));</span>

<span class="nc" id="L181">        instances = runtimeService.createProcessInstanceQuery().processDefinitionCategory(PROCESS_DEFINITION_CATEGORY_2).list();</span>
<span class="nc" id="L182">        assertThat(instances).hasSize(PROCESS_DEFINITION_KEY_2_DEPLOY_COUNT);</span>

<span class="nc" id="L184">        assertThat(instances)</span>
<span class="nc" id="L185">                .extracting(ProcessInstance::getBusinessKey, ProcessInstance::getProcessDefinitionKey, ProcessInstance::getProcessDefinitionName,</span>
                        ProcessInstance::getProcessDefinitionVersion, ProcessInstance::getProcessDefinitionCategory, ProcessInstance::getDeploymentId)
<span class="nc" id="L187">                .as(&quot;businessKey, processDefinitionKey, processDefinitionName, processDefinitionVersion, processDefinitionCategory, deploymentId&quot;)</span>
<span class="nc" id="L188">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L189">                        tuple(&quot;1&quot;, PROCESS_DEFINITION_KEY_2, &quot;oneTaskProcess2Name&quot;, 1, PROCESS_DEFINITION_CATEGORY_2, deployment.getId())</span>
                );
<span class="nc" id="L191">    }</span>

    @Test
    public void testOrQueryByProcessDefinitionCategory() {
<span class="nc" id="L195">        assertThat(</span>
<span class="nc" id="L196">                runtimeService.createProcessInstanceQuery().or().processDefinitionCategory(PROCESS_DEFINITION_CATEGORY).processDefinitionId(&quot;undefined&quot;).endOr()</span>
<span class="nc" id="L197">                        .count()).isEqualTo(PROCESS_DEFINITION_KEY_DEPLOY_COUNT);</span>
<span class="nc" id="L198">        assertThat(runtimeService.createProcessInstanceQuery().or().processDefinitionCategory(PROCESS_DEFINITION_CATEGORY_2).processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L199">                .endOr().count()).isEqualTo(PROCESS_DEFINITION_KEY_2_DEPLOY_COUNT);</span>
<span class="nc" id="L200">    }</span>

    @Test
    public void testQueryByProcessInstanceName() {
<span class="nc" id="L204">        runtimeService.setProcessInstanceName(processInstanceIds.get(0), &quot;new name&quot;);</span>
<span class="nc" id="L205">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceName(&quot;new name&quot;).singleResult()).isNotNull();</span>
<span class="nc" id="L206">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceName(&quot;new name&quot;).list()).hasSize(1);</span>

<span class="nc" id="L208">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceName(&quot;unexisting&quot;).singleResult()).isNull();</span>
<span class="nc" id="L209">    }</span>

    @Test
    public void testOrQueryByProcessInstanceName() {
<span class="nc" id="L213">        runtimeService.setProcessInstanceName(processInstanceIds.get(0), &quot;new name&quot;);</span>
<span class="nc" id="L214">        assertThat(runtimeService.createProcessInstanceQuery().or().processInstanceName(&quot;new name&quot;).processDefinitionId(&quot;undefined&quot;).endOr().singleResult())</span>
<span class="nc" id="L215">                .isNotNull();</span>
<span class="nc" id="L216">        assertThat(runtimeService.createProcessInstanceQuery().or().processInstanceName(&quot;new name&quot;).processDefinitionId(&quot;undefined&quot;).endOr().list()).hasSize(1);</span>

<span class="nc" id="L218">        assertThat(runtimeService.createProcessInstanceQuery()</span>
<span class="nc" id="L219">                .or()</span>
<span class="nc" id="L220">                .processInstanceName(&quot;new name&quot;)</span>
<span class="nc" id="L221">                .processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L222">                .endOr()</span>
<span class="nc" id="L223">                .or()</span>
<span class="nc" id="L224">                .processDefinitionKey(PROCESS_DEFINITION_KEY)</span>
<span class="nc" id="L225">                .processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L226">                .singleResult()).isNotNull();</span>

<span class="nc" id="L228">        assertThat(runtimeService.createProcessInstanceQuery().or().processInstanceName(&quot;unexisting&quot;).processDefinitionId(&quot;undefined&quot;).endOr().singleResult())</span>
<span class="nc" id="L229">                .isNull();</span>

<span class="nc" id="L231">        assertThat(runtimeService.createProcessInstanceQuery()</span>
<span class="nc" id="L232">                .or()</span>
<span class="nc" id="L233">                .processInstanceName(&quot;unexisting&quot;)</span>
<span class="nc" id="L234">                .processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L235">                .endOr()</span>
<span class="nc" id="L236">                .or()</span>
<span class="nc" id="L237">                .processDefinitionKey(PROCESS_DEFINITION_KEY)</span>
<span class="nc" id="L238">                .processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L239">                .endOr()</span>
<span class="nc" id="L240">                .singleResult()).isNull();</span>
<span class="nc" id="L241">    }</span>

    @Test
    public void testQueryByProcessInstanceNameLike() {
<span class="nc" id="L245">        runtimeService.setProcessInstanceName(processInstanceIds.get(0), &quot;new name&quot;);</span>
<span class="nc" id="L246">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceNameLike(&quot;% name&quot;).singleResult()).isNotNull();</span>
<span class="nc" id="L247">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceNameLike(&quot;new name&quot;).list()).hasSize(1);</span>

<span class="nc" id="L249">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceNameLike(&quot;%nope&quot;).singleResult()).isNull();</span>
<span class="nc" id="L250">    }</span>

    @Test
    public void testOrQueryByProcessInstanceNameLike() {
<span class="nc" id="L254">        runtimeService.setProcessInstanceName(processInstanceIds.get(0), &quot;new name&quot;);</span>
<span class="nc" id="L255">        assertThat(runtimeService.createProcessInstanceQuery().or().processInstanceNameLike(&quot;% name&quot;).processDefinitionId(&quot;undefined&quot;).endOr().singleResult())</span>
<span class="nc" id="L256">                .isNotNull();</span>
<span class="nc" id="L257">        assertThat(runtimeService.createProcessInstanceQuery().or().processInstanceNameLike(&quot;new name&quot;).processDefinitionId(&quot;undefined&quot;).endOr().list())</span>
<span class="nc" id="L258">                .hasSize(1);</span>

<span class="nc" id="L260">        assertThat(runtimeService.createProcessInstanceQuery().or().processInstanceNameLike(&quot;%nope&quot;).processDefinitionId(&quot;undefined&quot;).endOr().singleResult())</span>
<span class="nc" id="L261">                .isNull();</span>
<span class="nc" id="L262">    }</span>

    @Test
    public void testOrQueryByProcessInstanceNameLikeIgnoreCase() {
<span class="nc" id="L266">        runtimeService.setProcessInstanceName(processInstanceIds.get(0), &quot;new name&quot;);</span>
<span class="nc" id="L267">        runtimeService.setProcessInstanceName(processInstanceIds.get(1), &quot;other Name!&quot;);</span>

        // Runtime
<span class="nc" id="L270">        assertThat(runtimeService.createProcessInstanceQuery().or().processInstanceNameLikeIgnoreCase(&quot;%name%&quot;).processDefinitionId(&quot;undefined&quot;).endOr().list())</span>
<span class="nc" id="L271">                .hasSize(2);</span>
<span class="nc" id="L272">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceNameLikeIgnoreCase(&quot;%name%&quot;).list()).hasSize(2);</span>
<span class="nc" id="L273">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceNameLikeIgnoreCase(&quot;%NAME%&quot;).list()).hasSize(2);</span>
<span class="nc" id="L274">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceNameLikeIgnoreCase(&quot;%NaM%&quot;).list()).hasSize(2);</span>
<span class="nc" id="L275">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceNameLikeIgnoreCase(&quot;%the%&quot;).list()).hasSize(1);</span>
<span class="nc" id="L276">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceNameLikeIgnoreCase(&quot;new%&quot;).list()).hasSize(1);</span>
<span class="nc" id="L277">        assertThat(runtimeService.createProcessInstanceQuery().or().processInstanceNameLikeIgnoreCase(&quot;%nope&quot;).processDefinitionId(&quot;undefined&quot;).endOr()</span>
<span class="nc" id="L278">                .singleResult()).isNull();</span>

<span class="nc bnc" id="L280" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
            // History
<span class="nc" id="L282">            assertThat(historyService.createHistoricProcessInstanceQuery().or().processInstanceNameLikeIgnoreCase(&quot;%name%&quot;).processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L283">                    .endOr().list()).hasSize(2);</span>
<span class="nc" id="L284">            assertThat(historyService.createHistoricProcessInstanceQuery().processInstanceNameLikeIgnoreCase(&quot;%name%&quot;).list()).hasSize(2);</span>
<span class="nc" id="L285">            assertThat(historyService.createHistoricProcessInstanceQuery().processInstanceNameLikeIgnoreCase(&quot;%NAME%&quot;).list()).hasSize(2);</span>
<span class="nc" id="L286">            assertThat(historyService.createHistoricProcessInstanceQuery().processInstanceNameLikeIgnoreCase(&quot;%NaM%&quot;).list()).hasSize(2);</span>
<span class="nc" id="L287">            assertThat(historyService.createHistoricProcessInstanceQuery().processInstanceNameLikeIgnoreCase(&quot;%the%&quot;).list()).hasSize(1);</span>
<span class="nc" id="L288">            assertThat(historyService.createHistoricProcessInstanceQuery().processInstanceNameLikeIgnoreCase(&quot;new%&quot;).list()).hasSize(1);</span>
<span class="nc" id="L289">            assertThat(</span>
<span class="nc" id="L290">                    historyService.createHistoricProcessInstanceQuery().or().processInstanceNameLikeIgnoreCase(&quot;%nope&quot;).processDefinitionId(&quot;undefined&quot;).endOr()</span>
<span class="nc" id="L291">                            .singleResult()).isNull();</span>
        }
<span class="nc" id="L293">    }</span>

    @Test
    public void testQueryByBusinessKeyAndProcessDefinitionKey() {
<span class="nc" id="L297">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessKey(&quot;0&quot;, PROCESS_DEFINITION_KEY).count()).isEqualTo(1);</span>
<span class="nc" id="L298">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessKey(&quot;1&quot;, PROCESS_DEFINITION_KEY).count()).isEqualTo(1);</span>
<span class="nc" id="L299">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessKey(&quot;2&quot;, PROCESS_DEFINITION_KEY).count()).isEqualTo(1);</span>
<span class="nc" id="L300">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessKey(&quot;3&quot;, PROCESS_DEFINITION_KEY).count()).isEqualTo(1);</span>
<span class="nc" id="L301">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessKey(&quot;1&quot;, PROCESS_DEFINITION_KEY_2).count()).isEqualTo(1);</span>
<span class="nc" id="L302">    }</span>

    @Test
    public void testQueryByBusinessKey() {
<span class="nc" id="L306">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessKey(&quot;0&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L307">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessKey(&quot;1&quot;).count()).isEqualTo(2);</span>
<span class="nc" id="L308">    }</span>

    @Test
    public void testQueryByBusinessKeyLike() {
<span class="nc" id="L312">        processInstanceIds.add(runtimeService.startProcessInstanceByKey(PROCESS_DEFINITION_KEY, &quot;1A&quot;).getId());</span>
<span class="nc" id="L313">        processInstanceIds.add(runtimeService.startProcessInstanceByKey(PROCESS_DEFINITION_KEY, &quot;A1&quot;).getId());</span>
<span class="nc" id="L314">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessKeyLike(&quot;%0&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L315">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessKeyLike(&quot;1%&quot;).count()).isEqualTo(3);</span>
<span class="nc" id="L316">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessKeyLike(&quot;%1&quot;).count()).isEqualTo(3);</span>
<span class="nc" id="L317">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessKeyLike(&quot;%1%&quot;).count()).isEqualTo(4);</span>
<span class="nc" id="L318">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessKeyLike(&quot;%A%&quot;).count()).isEqualTo(2);</span>
<span class="nc" id="L319">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessKeyLike(&quot;%B%&quot;).count()).isZero();</span>
<span class="nc" id="L320">    }</span>

    @Test
    public void testQueryByInvalidBusinessKey() {
<span class="nc" id="L324">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessKey(&quot;invalid&quot;).count()).isZero();</span>

<span class="nc" id="L326">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().processInstanceBusinessKey(null).count())</span>
<span class="nc" id="L327">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L328">    }</span>
    
    @Test
    public void testQueryByBusinessStatus() {
<span class="nc" id="L332">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessStatus(&quot;0&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L333">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessStatus(&quot;1&quot;).count()).isEqualTo(2);</span>
<span class="nc" id="L334">    }</span>

    @Test
    public void testQueryByBusinessStatusLike() {
<span class="nc" id="L338">        String processInstanceId = runtimeService.startProcessInstanceByKey(PROCESS_DEFINITION_KEY).getId();</span>
<span class="nc" id="L339">        processInstanceIds.add(processInstanceId);</span>
<span class="nc" id="L340">        runtimeService.updateBusinessStatus(processInstanceId, &quot;1A&quot;);</span>
        
<span class="nc" id="L342">        processInstanceId = runtimeService.startProcessInstanceByKey(PROCESS_DEFINITION_KEY).getId();</span>
<span class="nc" id="L343">        processInstanceIds.add(processInstanceId);</span>
<span class="nc" id="L344">        runtimeService.updateBusinessStatus(processInstanceId, &quot;A1&quot;);</span>
        
<span class="nc" id="L346">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessStatusLike(&quot;%0&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L347">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessStatusLike(&quot;1%&quot;).count()).isEqualTo(3);</span>
<span class="nc" id="L348">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessStatusLike(&quot;%1&quot;).count()).isEqualTo(3);</span>
<span class="nc" id="L349">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessStatusLike(&quot;%1%&quot;).count()).isEqualTo(4);</span>
<span class="nc" id="L350">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessStatusLike(&quot;%A%&quot;).count()).isEqualTo(2);</span>
<span class="nc" id="L351">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessStatusLike(&quot;%B%&quot;).count()).isZero();</span>
<span class="nc" id="L352">    }</span>

    @Test
    public void testQueryByInvalidBusinessStatus() {
<span class="nc" id="L356">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessStatus(&quot;invalid&quot;).count()).isZero();</span>

<span class="nc" id="L358">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().processInstanceBusinessStatus(null).count())</span>
<span class="nc" id="L359">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L360">    }</span>

    @Test
    public void testQueryByProcessDefinitionId() {
<span class="nc" id="L364">        final ProcessDefinition processDefinition1 = repositoryService.createProcessDefinitionQuery().processDefinitionKey(PROCESS_DEFINITION_KEY)</span>
<span class="nc" id="L365">                .singleResult();</span>
<span class="nc" id="L366">        ProcessInstanceQuery query1 = runtimeService.createProcessInstanceQuery().processDefinitionId(processDefinition1.getId());</span>
<span class="nc" id="L367">        assertThat(query1.count()).isEqualTo(PROCESS_DEFINITION_KEY_DEPLOY_COUNT);</span>
<span class="nc" id="L368">        assertThat(query1.list()).hasSize(PROCESS_DEFINITION_KEY_DEPLOY_COUNT);</span>
<span class="nc" id="L369">        assertThatThrownBy(() -&gt; query1.singleResult())</span>
<span class="nc" id="L370">                .isExactlyInstanceOf(FlowableException.class);</span>

<span class="nc" id="L372">        final ProcessDefinition processDefinition2 = repositoryService.createProcessDefinitionQuery().processDefinitionKey(PROCESS_DEFINITION_KEY_2)</span>
<span class="nc" id="L373">                .singleResult();</span>
<span class="nc" id="L374">        ProcessInstanceQuery query2 = runtimeService.createProcessInstanceQuery().processDefinitionId(processDefinition2.getId());</span>
<span class="nc" id="L375">        assertThat(query2.count()).isEqualTo(PROCESS_DEFINITION_KEY_2_DEPLOY_COUNT);</span>
<span class="nc" id="L376">        assertThat(query2.list()).hasSize(PROCESS_DEFINITION_KEY_2_DEPLOY_COUNT);</span>
<span class="nc" id="L377">        assertThat(query2.singleResult()).isNotNull();</span>
<span class="nc" id="L378">    }</span>

    @Test
    public void testQueryByProcessDefinitionIds() {
<span class="nc" id="L382">        final ProcessDefinition processDefinition1 = repositoryService.createProcessDefinitionQuery().processDefinitionKey(PROCESS_DEFINITION_KEY)</span>
<span class="nc" id="L383">                .singleResult();</span>
<span class="nc" id="L384">        final ProcessDefinition processDefinition2 = repositoryService.createProcessDefinitionQuery().processDefinitionKey(PROCESS_DEFINITION_KEY_2)</span>
<span class="nc" id="L385">                .singleResult();</span>

<span class="nc" id="L387">        final Set&lt;String&gt; processDefinitionIdSet = new HashSet&lt;&gt;(2);</span>
<span class="nc" id="L388">        processDefinitionIdSet.add(processDefinition1.getId());</span>
<span class="nc" id="L389">        processDefinitionIdSet.add(processDefinition2.getId());</span>

<span class="nc" id="L391">        ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery().processDefinitionIds(processDefinitionIdSet);</span>
<span class="nc" id="L392">        assertThat(query.count()).isEqualTo(PROCESS_DEPLOY_COUNT);</span>
<span class="nc" id="L393">        assertThat(query.list()).hasSize(PROCESS_DEPLOY_COUNT);</span>
<span class="nc" id="L394">        assertThatThrownBy(() -&gt; query.singleResult())</span>
<span class="nc" id="L395">                .isExactlyInstanceOf(FlowableException.class);</span>
<span class="nc" id="L396">    }</span>

    @Test
    public void testQueryByInvalidProcessDefinitionIds() {
<span class="nc" id="L400">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().processDefinitionIds(null))</span>
<span class="nc" id="L401">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>

<span class="nc" id="L403">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().processDefinitionIds(Collections.emptySet()))</span>
<span class="nc" id="L404">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L405">    }</span>

    @Test
    public void testQueryByProcessDefinitionName() {
<span class="nc" id="L409">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionName(PROCESS_DEFINITION_NAME).count())</span>
<span class="nc" id="L410">                .isEqualTo(PROCESS_DEFINITION_KEY_DEPLOY_COUNT);</span>
<span class="nc" id="L411">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionName(PROCESS_DEFINITION_NAME_2).count())</span>
<span class="nc" id="L412">                .isEqualTo(PROCESS_DEFINITION_KEY_2_DEPLOY_COUNT);</span>
<span class="nc" id="L413">    }</span>

    @Test
    public void testOrQueryByProcessDefinitionName() {
<span class="nc" id="L417">        assertThat(runtimeService.createProcessInstanceQuery().or().processDefinitionName(PROCESS_DEFINITION_NAME).processDefinitionId(&quot;undefined&quot;).endOr()</span>
<span class="nc" id="L418">                .count()).isEqualTo(PROCESS_DEFINITION_KEY_DEPLOY_COUNT);</span>
<span class="nc" id="L419">        assertThat(runtimeService.createProcessInstanceQuery().or().processDefinitionName(PROCESS_DEFINITION_NAME_2).processDefinitionId(&quot;undefined&quot;).endOr()</span>
<span class="nc" id="L420">                .count()).isEqualTo(PROCESS_DEFINITION_KEY_2_DEPLOY_COUNT);</span>
<span class="nc" id="L421">    }</span>

    @Test
    public void testQueryByInvalidProcessDefinitionName() {
<span class="nc" id="L425">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionName(&quot;invalid&quot;).singleResult()).isNull();</span>
<span class="nc" id="L426">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionName(&quot;invalid&quot;).count()).isZero();</span>
<span class="nc" id="L427">    }</span>

    @Test
    public void testQueryByDeploymentId() {
<span class="nc" id="L431">        List&lt;ProcessInstance&gt; instances = runtimeService.createProcessInstanceQuery().deploymentId(deployment.getId()).list();</span>
<span class="nc" id="L432">        assertThat(instances).hasSize(PROCESS_DEPLOY_COUNT);</span>
<span class="nc" id="L433">        ProcessInstance processInstance = instances.get(0);</span>
<span class="nc" id="L434">        assertThat(processInstance.getDeploymentId()).isEqualTo(deployment.getId());</span>
<span class="nc" id="L435">        assertThat(processInstance.getProcessDefinitionVersion()).isEqualTo(1);</span>
<span class="nc" id="L436">        assertThat(processInstance.getProcessDefinitionKey()).isEqualTo(PROCESS_DEFINITION_KEY);</span>
<span class="nc" id="L437">        assertThat(processInstance.getProcessDefinitionName()).isEqualTo(&quot;oneTaskProcessName&quot;);</span>
<span class="nc" id="L438">        assertThat(processInstance.getProcessDefinitionCategory()).isEqualTo(PROCESS_DEFINITION_CATEGORY);</span>
<span class="nc" id="L439">        assertThat(runtimeService.createProcessInstanceQuery().deploymentId(deployment.getId()).count()).isEqualTo(PROCESS_DEPLOY_COUNT);</span>
<span class="nc" id="L440">    }</span>

    @Test
    public void testQueryByDeploymentIdIn() {
<span class="nc" id="L444">        List&lt;String&gt; deploymentIds = Collections.singletonList(deployment.getId());</span>
<span class="nc" id="L445">        List&lt;ProcessInstance&gt; instances = runtimeService.createProcessInstanceQuery().deploymentIdIn(deploymentIds).list();</span>
<span class="nc" id="L446">        assertThat(instances).hasSize(PROCESS_DEPLOY_COUNT);</span>

<span class="nc" id="L448">        assertThat(instances)</span>
<span class="nc" id="L449">                .extracting(ProcessInstance::getBusinessKey, ProcessInstance::getProcessDefinitionKey, ProcessInstance::getProcessDefinitionName,</span>
                        ProcessInstance::getProcessDefinitionVersion, ProcessInstance::getDeploymentId)
<span class="nc" id="L451">                .as(&quot;businessKey, processDefinitionKey, processDefinitionName, processDefinitionVersion, deploymentId&quot;)</span>
<span class="nc" id="L452">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L453">                        tuple(&quot;0&quot;, PROCESS_DEFINITION_KEY, &quot;oneTaskProcessName&quot;, 1, deployment.getId()),</span>
<span class="nc" id="L454">                        tuple(&quot;1&quot;, PROCESS_DEFINITION_KEY, &quot;oneTaskProcessName&quot;, 1, deployment.getId()),</span>
<span class="nc" id="L455">                        tuple(&quot;2&quot;, PROCESS_DEFINITION_KEY, &quot;oneTaskProcessName&quot;, 1, deployment.getId()),</span>
<span class="nc" id="L456">                        tuple(&quot;3&quot;, PROCESS_DEFINITION_KEY, &quot;oneTaskProcessName&quot;, 1, deployment.getId()),</span>
<span class="nc" id="L457">                        tuple(&quot;1&quot;, PROCESS_DEFINITION_KEY_2, &quot;oneTaskProcess2Name&quot;, 1, deployment.getId())</span>
                );

<span class="nc" id="L460">        assertThat(runtimeService.createProcessInstanceQuery().deploymentIdIn(deploymentIds).count()).isEqualTo(PROCESS_DEPLOY_COUNT);</span>

<span class="nc" id="L462">        assertThat(runtimeService.createProcessInstanceQuery().deploymentIdIn(Collections.singletonList(&quot;dummy&quot;)).list()).isEmpty();</span>

<span class="nc" id="L464">        assertThat(runtimeService.createProcessInstanceQuery()</span>
<span class="nc" id="L465">                .or()</span>
<span class="nc" id="L466">                .processInstanceId(&quot;invalid&quot;)</span>
<span class="nc" id="L467">                .deploymentIdIn(deploymentIds)</span>
<span class="nc" id="L468">                .endOr()</span>
<span class="nc" id="L469">                .count()).isEqualTo(PROCESS_DEPLOY_COUNT);</span>
<span class="nc" id="L470">    }</span>

    @Test
    public void testOrQueryByDeploymentId() {
<span class="nc" id="L474">        List&lt;ProcessInstance&gt; instances = runtimeService.createProcessInstanceQuery().or().deploymentId(deployment.getId()).processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L475">                .endOr().list();</span>
<span class="nc" id="L476">        assertThat(instances).hasSize(PROCESS_DEPLOY_COUNT);</span>
<span class="nc" id="L477">        ProcessInstance processInstance = instances.get(0);</span>
<span class="nc" id="L478">        assertThat(processInstance.getDeploymentId()).isEqualTo(deployment.getId());</span>
<span class="nc" id="L479">        assertThat(processInstance.getProcessDefinitionVersion()).isEqualTo(Integer.valueOf(1));</span>
<span class="nc" id="L480">        assertThat(processInstance.getProcessDefinitionKey()).isEqualTo(PROCESS_DEFINITION_KEY);</span>
<span class="nc" id="L481">        assertThat(processInstance.getProcessDefinitionName()).isEqualTo(&quot;oneTaskProcessName&quot;);</span>

<span class="nc" id="L483">        instances = runtimeService.createProcessInstanceQuery()</span>
<span class="nc" id="L484">                .or()</span>
<span class="nc" id="L485">                .deploymentId(deployment.getId())</span>
<span class="nc" id="L486">                .processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L487">                .endOr()</span>
<span class="nc" id="L488">                .or()</span>
<span class="nc" id="L489">                .processDefinitionKey(PROCESS_DEFINITION_KEY)</span>
<span class="nc" id="L490">                .processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L491">                .endOr()</span>
<span class="nc" id="L492">                .list();</span>
<span class="nc" id="L493">        assertThat(instances).hasSize(4);</span>

<span class="nc" id="L495">        instances = runtimeService.createProcessInstanceQuery()</span>
<span class="nc" id="L496">                .or()</span>
<span class="nc" id="L497">                .deploymentId(deployment.getId())</span>
<span class="nc" id="L498">                .processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L499">                .endOr()</span>
<span class="nc" id="L500">                .or()</span>
<span class="nc" id="L501">                .processDefinitionKey(&quot;undefined&quot;)</span>
<span class="nc" id="L502">                .processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L503">                .endOr()</span>
<span class="nc" id="L504">                .list();</span>
<span class="nc" id="L505">        assertThat(instances).isEmpty();</span>

<span class="nc" id="L507">        assertThat(runtimeService.createProcessInstanceQuery().or().deploymentId(deployment.getId()).processDefinitionId(&quot;undefined&quot;).endOr().count())</span>
<span class="nc" id="L508">                .isEqualTo(PROCESS_DEPLOY_COUNT);</span>

<span class="nc" id="L510">        assertThat(runtimeService.createProcessInstanceQuery()</span>
<span class="nc" id="L511">                .or()</span>
<span class="nc" id="L512">                .deploymentId(deployment.getId())</span>
<span class="nc" id="L513">                .processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L514">                .endOr()</span>
<span class="nc" id="L515">                .or()</span>
<span class="nc" id="L516">                .processDefinitionKey(PROCESS_DEFINITION_KEY)</span>
<span class="nc" id="L517">                .processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L518">                .endOr()</span>
<span class="nc" id="L519">                .count()).isEqualTo(4);</span>

<span class="nc" id="L521">        assertThat(runtimeService.createProcessInstanceQuery()</span>
<span class="nc" id="L522">                .or()</span>
<span class="nc" id="L523">                .deploymentId(deployment.getId())</span>
<span class="nc" id="L524">                .processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L525">                .endOr()</span>
<span class="nc" id="L526">                .or()</span>
<span class="nc" id="L527">                .processDefinitionKey(&quot;undefined&quot;)</span>
<span class="nc" id="L528">                .processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L529">                .endOr()</span>
<span class="nc" id="L530">                .count()).isZero();</span>
<span class="nc" id="L531">    }</span>

    @Test
    public void testOrQueryByDeploymentIdIn() {
<span class="nc" id="L535">        List&lt;String&gt; deploymentIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L536">        deploymentIds.add(deployment.getId());</span>
<span class="nc" id="L537">        List&lt;ProcessInstance&gt; instances = runtimeService.createProcessInstanceQuery().or().deploymentIdIn(deploymentIds).processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L538">                .endOr().list();</span>
<span class="nc" id="L539">        assertThat(instances).hasSize(PROCESS_DEPLOY_COUNT);</span>

<span class="nc" id="L541">        ProcessInstance processInstance = instances.get(0);</span>
<span class="nc" id="L542">        assertThat(processInstance.getDeploymentId()).isEqualTo(deployment.getId());</span>
<span class="nc" id="L543">        assertThat(processInstance.getProcessDefinitionVersion()).isEqualTo(Integer.valueOf(1));</span>
<span class="nc" id="L544">        assertThat(processInstance.getProcessDefinitionKey()).isEqualTo(PROCESS_DEFINITION_KEY);</span>
<span class="nc" id="L545">        assertThat(processInstance.getProcessDefinitionName()).isEqualTo(&quot;oneTaskProcessName&quot;);</span>

<span class="nc" id="L547">        assertThat(runtimeService.createProcessInstanceQuery().or().deploymentIdIn(deploymentIds).processDefinitionId(&quot;undefined&quot;).endOr().count())</span>
<span class="nc" id="L548">                .isEqualTo(PROCESS_DEPLOY_COUNT);</span>
<span class="nc" id="L549">    }</span>

    @Test
    public void testQueryByInvalidDeploymentId() {
<span class="nc" id="L553">        assertThat(runtimeService.createProcessInstanceQuery().deploymentId(&quot;invalid&quot;).singleResult()).isNull();</span>
<span class="nc" id="L554">        assertThat(runtimeService.createProcessInstanceQuery().deploymentId(&quot;invalid&quot;).count()).isZero();</span>
<span class="nc" id="L555">    }</span>

    @Test
    public void testOrQueryByInvalidDeploymentId() {
<span class="nc" id="L559">        assertThat(runtimeService.createProcessInstanceQuery().or().deploymentId(&quot;invalid&quot;).processDefinitionId(&quot;undefined&quot;).endOr().singleResult()).isNull();</span>
<span class="nc" id="L560">        assertThat(runtimeService.createProcessInstanceQuery().or().deploymentId(&quot;invalid&quot;).processDefinitionId(&quot;undefined&quot;).endOr().count()).isZero();</span>
<span class="nc" id="L561">    }</span>

    @Test
    public void testQueryByInvalidProcessInstanceId() {
<span class="nc" id="L565">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(&quot;I do not exist&quot;).singleResult()).isNull();</span>
<span class="nc" id="L566">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(&quot;I do not exist&quot;).list()).isEmpty();</span>
<span class="nc" id="L567">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/superProcess.bpmn20.xml&quot;, &quot;org/flowable/engine/test/api/runtime/subProcess.bpmn20.xml&quot; })
    public void testQueryBySuperProcessInstanceId() {
<span class="nc" id="L572">        ProcessInstance superProcessInstance = runtimeService.startProcessInstanceByKey(&quot;subProcessQueryTest&quot;);</span>

<span class="nc" id="L574">        ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery().superProcessInstanceId(superProcessInstance.getId());</span>
<span class="nc" id="L575">        ProcessInstance subProcessInstance = query.singleResult();</span>
<span class="nc" id="L576">        assertThat(subProcessInstance).isNotNull();</span>
<span class="nc" id="L577">        assertThat(query.list()).hasSize(1);</span>
<span class="nc" id="L578">        assertThat(query.count()).isEqualTo(1);</span>
<span class="nc" id="L579">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/superProcess.bpmn20.xml&quot;, &quot;org/flowable/engine/test/api/runtime/subProcess.bpmn20.xml&quot; })
    public void testOrQueryBySuperProcessInstanceId() {
<span class="nc" id="L584">        ProcessInstance superProcessInstance = runtimeService.startProcessInstanceByKey(&quot;subProcessQueryTest&quot;);</span>

<span class="nc" id="L586">        ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery().or().superProcessInstanceId(superProcessInstance.getId())</span>
<span class="nc" id="L587">                .processDefinitionId(&quot;undefined&quot;).endOr();</span>
<span class="nc" id="L588">        ProcessInstance subProcessInstance = query.singleResult();</span>
<span class="nc" id="L589">        assertThat(subProcessInstance).isNotNull();</span>
<span class="nc" id="L590">        assertThat(query.list()).hasSize(1);</span>
<span class="nc" id="L591">        assertThat(query.count()).isEqualTo(1);</span>
<span class="nc" id="L592">    }</span>
    
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/currentActivityTestProcess.bpmn20.xml&quot; })
    public void testQueryByActiveActivityId() {
<span class="nc" id="L597">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;currentActivityProcessTest&quot;);</span>
<span class="nc" id="L598">        Task task = taskService.createTaskQuery().processInstanceId(processInstance1.getId()).singleResult();</span>
<span class="nc" id="L599">        taskService.complete(task.getId());</span>
        
<span class="nc" id="L601">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;currentActivityProcessTest&quot;);</span>
<span class="nc" id="L602">        ProcessInstance processInstance3 = runtimeService.startProcessInstanceByKey(&quot;currentActivityProcessTest&quot;);</span>
        
<span class="nc" id="L604">        List&lt;String&gt; queryIds = runtimeService.createProcessInstanceQuery().activeActivityId(&quot;task1&quot;).list().stream()</span>
<span class="nc" id="L605">            .map(ProcessInstance::getId)</span>
<span class="nc" id="L606">            .collect(Collectors.toList());</span>
        
<span class="nc" id="L608">        assertThat(queryIds.size()).isEqualTo(2);</span>
<span class="nc" id="L609">        assertThat(queryIds.contains(processInstance2.getId())).isTrue();</span>
<span class="nc" id="L610">        assertThat(queryIds.contains(processInstance3.getId())).isTrue();</span>
        
<span class="nc" id="L612">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(processInstance1.getId()).activeActivityId(&quot;task1&quot;).count()).isZero();</span>
        
<span class="nc" id="L614">        queryIds = runtimeService.createProcessInstanceQuery().activeActivityId(&quot;task3&quot;).list().stream()</span>
<span class="nc" id="L615">                .map(ProcessInstance::getId)</span>
<span class="nc" id="L616">                .collect(Collectors.toList());</span>
        
<span class="nc" id="L618">        assertThat(queryIds.size()).isEqualTo(1);</span>
<span class="nc" id="L619">        assertThat(queryIds.contains(processInstance1.getId())).isTrue();</span>
        
<span class="nc" id="L621">        Set&lt;String&gt; activityIds = new HashSet&lt;&gt;();</span>
<span class="nc" id="L622">        activityIds.add(&quot;task1&quot;);</span>
<span class="nc" id="L623">        activityIds.add(&quot;task3&quot;);</span>
        
<span class="nc" id="L625">        queryIds = runtimeService.createProcessInstanceQuery().activeActivityIds(activityIds).list().stream()</span>
<span class="nc" id="L626">                .map(ProcessInstance::getId)</span>
<span class="nc" id="L627">                .collect(Collectors.toList());</span>
     
<span class="nc" id="L629">        assertThat(queryIds.size()).isEqualTo(3);</span>
<span class="nc" id="L630">        assertThat(queryIds.contains(processInstance1.getId())).isTrue();</span>
<span class="nc" id="L631">        assertThat(queryIds.contains(processInstance2.getId())).isTrue();</span>
<span class="nc" id="L632">        assertThat(queryIds.contains(processInstance3.getId())).isTrue();</span>
        
<span class="nc" id="L634">        activityIds = new HashSet&lt;&gt;();</span>
<span class="nc" id="L635">        activityIds.add(&quot;task2&quot;);</span>
<span class="nc" id="L636">        activityIds.add(&quot;task3&quot;);</span>
        
<span class="nc" id="L638">        queryIds = runtimeService.createProcessInstanceQuery().activeActivityIds(activityIds).list().stream()</span>
<span class="nc" id="L639">                .map(ProcessInstance::getId)</span>
<span class="nc" id="L640">                .collect(Collectors.toList());</span>
        
<span class="nc" id="L642">        assertThat(queryIds.size()).isEqualTo(1);</span>
<span class="nc" id="L643">        assertThat(queryIds.contains(processInstance1.getId())).isTrue();</span>
        
<span class="nc" id="L645">        activityIds = new HashSet&lt;&gt;();</span>
<span class="nc" id="L646">        activityIds.add(&quot;task2&quot;);</span>
<span class="nc" id="L647">        activityIds.add(&quot;task4&quot;);</span>
<span class="nc" id="L648">        assertThat(runtimeService.createProcessInstanceQuery().activeActivityIds(activityIds).count()).isZero();</span>
<span class="nc" id="L649">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/superProcess.bpmn20.xml&quot;, &quot;org/flowable/engine/test/api/runtime/subProcess.bpmn20.xml&quot; })
    public void testQueryByInvolvedUser() {
<span class="nc" id="L654">        ProcessInstance superProcessInstance = runtimeService.startProcessInstanceByKey(&quot;subProcessQueryTest&quot;);</span>
<span class="nc" id="L655">        runtimeService.addUserIdentityLink(superProcessInstance.getId(), &quot;kermit&quot;, &quot;specialLink&quot;);</span>

<span class="nc" id="L657">        ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery().superProcessInstanceId(superProcessInstance.getId());</span>
<span class="nc" id="L658">        ProcessInstance subProcessInstance = query.singleResult();</span>
<span class="nc" id="L659">        assertThat(subProcessInstance).isNotNull();</span>
<span class="nc" id="L660">        runtimeService.addUserIdentityLink(subProcessInstance.getId(), &quot;kermit&quot;, &quot;anotherLink&quot;);</span>

<span class="nc" id="L662">        assertThat(runtimeService.createProcessInstanceQuery().involvedUser(&quot;kermit&quot;, &quot;specialLink&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L663">        assertThat(runtimeService.createProcessInstanceQuery().involvedUser(&quot;kermit&quot;, &quot;specialLink&quot;).singleResult().getId())</span>
<span class="nc" id="L664">                .isEqualTo(superProcessInstance.getId());</span>

<span class="nc" id="L666">        assertThat(runtimeService.createProcessInstanceQuery().involvedUser(&quot;kermit&quot;, &quot;anotherLink&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L667">        assertThat(runtimeService.createProcessInstanceQuery().involvedUser(&quot;kermit&quot;, &quot;anotherLink&quot;).singleResult().getId())</span>
<span class="nc" id="L668">                .isEqualTo(subProcessInstance.getId());</span>

<span class="nc" id="L670">        assertThat(runtimeService.createProcessInstanceQuery().involvedUser(&quot;kermit&quot;, &quot;undefined&quot;).count()).isZero();</span>

<span class="nc" id="L672">        assertThat(runtimeService.createProcessInstanceQuery().or().involvedUser(&quot;kermit&quot;, &quot;specialLink&quot;).processDefinitionKey(&quot;undefined&quot;).endOr().count())</span>
<span class="nc" id="L673">                .isEqualTo(1);</span>
<span class="nc" id="L674">        assertThat(</span>
<span class="nc" id="L675">                runtimeService.createProcessInstanceQuery().or().involvedUser(&quot;kermit&quot;, &quot;specialLink&quot;).processDefinitionKey(&quot;undefined&quot;).endOr().singleResult()</span>
<span class="nc" id="L676">                        .getId()).isEqualTo(superProcessInstance.getId());</span>

<span class="nc" id="L678">        assertThat(runtimeService.createProcessInstanceQuery().or().involvedUser(&quot;kermit&quot;, &quot;specialLink&quot;).processDefinitionKey(&quot;subProcessQueryTest&quot;).endOr()</span>
<span class="nc" id="L679">                .count()).isEqualTo(1);</span>
<span class="nc" id="L680">        assertThat(runtimeService.createProcessInstanceQuery().or().involvedUser(&quot;kermit&quot;, &quot;specialLink&quot;).processDefinitionKey(&quot;subProcessQueryTest&quot;).endOr()</span>
<span class="nc" id="L681">                .singleResult().getId()).isEqualTo(superProcessInstance.getId());</span>

<span class="nc" id="L683">        assertThat(runtimeService.createProcessInstanceQuery().or().involvedUser(&quot;kermit&quot;, &quot;undefined&quot;).processDefinitionKey(&quot;undefined&quot;).endOr().count())</span>
<span class="nc" id="L684">                .isZero();</span>
<span class="nc" id="L685">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/superProcess.bpmn20.xml&quot;, &quot;org/flowable/engine/test/api/runtime/subProcess.bpmn20.xml&quot; })
    public void testQueryByInvolvedGroup() {
<span class="nc" id="L690">        ProcessInstance superProcessInstance = runtimeService.startProcessInstanceByKey(&quot;subProcessQueryTest&quot;);</span>
<span class="nc" id="L691">        runtimeService.addGroupIdentityLink(superProcessInstance.getId(), &quot;sales&quot;, &quot;specialLink&quot;);</span>

<span class="nc" id="L693">        ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery().superProcessInstanceId(superProcessInstance.getId());</span>
<span class="nc" id="L694">        ProcessInstance subProcessInstance = query.singleResult();</span>
<span class="nc" id="L695">        assertThat(subProcessInstance).isNotNull();</span>
<span class="nc" id="L696">        runtimeService.addGroupIdentityLink(subProcessInstance.getId(), &quot;sales&quot;, &quot;anotherLink&quot;);</span>

<span class="nc" id="L698">        assertThat(runtimeService.createProcessInstanceQuery().involvedGroup(&quot;sales&quot;, &quot;specialLink&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L699">        assertThat(runtimeService.createProcessInstanceQuery().involvedGroup(&quot;sales&quot;, &quot;specialLink&quot;).singleResult().getId())</span>
<span class="nc" id="L700">                .isEqualTo(superProcessInstance.getId());</span>

<span class="nc" id="L702">        assertThat(runtimeService.createProcessInstanceQuery().involvedGroup(&quot;sales&quot;, &quot;anotherLink&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L703">        assertThat(runtimeService.createProcessInstanceQuery().involvedGroup(&quot;sales&quot;, &quot;anotherLink&quot;).singleResult().getId())</span>
<span class="nc" id="L704">                .isEqualTo(subProcessInstance.getId());</span>

<span class="nc" id="L706">        assertThat(runtimeService.createProcessInstanceQuery().involvedGroup(&quot;sales&quot;, &quot;undefined&quot;).count()).isZero();</span>

<span class="nc" id="L708">        assertThat(runtimeService.createProcessInstanceQuery().or().involvedGroup(&quot;sales&quot;, &quot;specialLink&quot;).processDefinitionKey(&quot;undefined&quot;).endOr().count())</span>
<span class="nc" id="L709">                .isEqualTo(1);</span>
<span class="nc" id="L710">        assertThat(</span>
<span class="nc" id="L711">                runtimeService.createProcessInstanceQuery().or().involvedGroup(&quot;sales&quot;, &quot;specialLink&quot;).processDefinitionKey(&quot;undefined&quot;).endOr().singleResult()</span>
<span class="nc" id="L712">                        .getId()).isEqualTo(superProcessInstance.getId());</span>

<span class="nc" id="L714">        assertThat(runtimeService.createProcessInstanceQuery().or().involvedGroup(&quot;sales&quot;, &quot;specialLink&quot;).processDefinitionKey(&quot;subProcessQueryTest&quot;).endOr()</span>
<span class="nc" id="L715">                .count()).isEqualTo(1);</span>
<span class="nc" id="L716">        assertThat(runtimeService.createProcessInstanceQuery().or().involvedGroup(&quot;sales&quot;, &quot;specialLink&quot;).processDefinitionKey(&quot;subProcessQueryTest&quot;).endOr()</span>
<span class="nc" id="L717">                .singleResult().getId()).isEqualTo(superProcessInstance.getId());</span>

<span class="nc" id="L719">        assertThat(runtimeService.createProcessInstanceQuery().or().involvedGroup(&quot;sales&quot;, &quot;undefined&quot;).processDefinitionKey(&quot;undefined&quot;).endOr().count())</span>
<span class="nc" id="L720">                .isZero();</span>
<span class="nc" id="L721">    }</span>

    @Test
    public void testQueryByInvalidSuperProcessInstanceId() {
<span class="nc" id="L725">        assertThat(runtimeService.createProcessInstanceQuery().superProcessInstanceId(&quot;invalid&quot;).singleResult()).isNull();</span>
<span class="nc" id="L726">        assertThat(runtimeService.createProcessInstanceQuery().superProcessInstanceId(&quot;invalid&quot;).list()).isEmpty();</span>
<span class="nc" id="L727">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/superProcess.bpmn20.xml&quot;, &quot;org/flowable/engine/test/api/runtime/subProcess.bpmn20.xml&quot; })
    public void testQueryBySubProcessInstanceId() {
<span class="nc" id="L732">        ProcessInstance superProcessInstance = runtimeService.startProcessInstanceByKey(&quot;subProcessQueryTest&quot;);</span>

<span class="nc" id="L734">        ProcessInstance subProcessInstance = runtimeService.createProcessInstanceQuery().superProcessInstanceId(superProcessInstance.getId()).singleResult();</span>
<span class="nc" id="L735">        assertThat(subProcessInstance).isNotNull();</span>
<span class="nc" id="L736">        assertThat(runtimeService.createProcessInstanceQuery().subProcessInstanceId(subProcessInstance.getId()).singleResult().getId())</span>
<span class="nc" id="L737">                .isEqualTo(superProcessInstance.getId());</span>
<span class="nc" id="L738">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/superProcess.bpmn20.xml&quot;, &quot;org/flowable/engine/test/api/runtime/subProcess.bpmn20.xml&quot; })
    public void testOrQueryBySubProcessInstanceId() {
<span class="nc" id="L743">        ProcessInstance superProcessInstance = runtimeService.startProcessInstanceByKey(&quot;subProcessQueryTest&quot;);</span>

<span class="nc" id="L745">        ProcessInstance subProcessInstance = runtimeService.createProcessInstanceQuery().or().superProcessInstanceId(superProcessInstance.getId())</span>
<span class="nc" id="L746">                .processDefinitionId(&quot;undefined&quot;).singleResult();</span>
<span class="nc" id="L747">        assertThat(subProcessInstance).isNotNull();</span>
<span class="nc" id="L748">        assertThat(runtimeService.createProcessInstanceQuery().or().subProcessInstanceId(subProcessInstance.getId()).processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L749">                .singleResult()</span>
<span class="nc" id="L750">                .getId()).isEqualTo(superProcessInstance.getId());</span>
<span class="nc" id="L751">    }</span>

    @Test
    public void testQueryByInvalidSubProcessInstanceId() {
<span class="nc" id="L755">        assertThat(runtimeService.createProcessInstanceQuery().subProcessInstanceId(&quot;invalid&quot;).singleResult()).isNull();</span>
<span class="nc" id="L756">        assertThat(runtimeService.createProcessInstanceQuery().subProcessInstanceId(&quot;invalid&quot;).list()).isEmpty();</span>
<span class="nc" id="L757">    }</span>

    // Nested subprocess make the query complexer, hence this test
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/superProcessWithNestedSubProcess.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/runtime/nestedSubProcess.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/runtime/subProcess.bpmn20.xml&quot; })
    public void testQueryBySuperProcessInstanceIdNested() {
<span class="nc" id="L765">        ProcessInstance superProcessInstance = runtimeService.startProcessInstanceByKey(&quot;nestedSubProcessQueryTest&quot;);</span>

<span class="nc" id="L767">        ProcessInstance subProcessInstance = runtimeService.createProcessInstanceQuery().superProcessInstanceId(superProcessInstance.getId()).singleResult();</span>
<span class="nc" id="L768">        assertThat(subProcessInstance).isNotNull();</span>

<span class="nc" id="L770">        ProcessInstance nestedSubProcessInstance = runtimeService.createProcessInstanceQuery().superProcessInstanceId(subProcessInstance.getId())</span>
<span class="nc" id="L771">                .singleResult();</span>
<span class="nc" id="L772">        assertThat(nestedSubProcessInstance).isNotNull();</span>
<span class="nc" id="L773">    }</span>

    // Nested subprocess make the query complexer, hence this test
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/superProcessWithNestedSubProcess.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/runtime/nestedSubProcess.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/runtime/subProcess.bpmn20.xml&quot; })
    public void testQueryBySubProcessInstanceIdNested() {
<span class="nc" id="L781">        ProcessInstance superProcessInstance = runtimeService.startProcessInstanceByKey(&quot;nestedSubProcessQueryTest&quot;);</span>

<span class="nc" id="L783">        ProcessInstance subProcessInstance = runtimeService.createProcessInstanceQuery().superProcessInstanceId(superProcessInstance.getId()).singleResult();</span>
<span class="nc" id="L784">        assertThat(runtimeService.createProcessInstanceQuery().subProcessInstanceId(subProcessInstance.getId()).singleResult().getId())</span>
<span class="nc" id="L785">                .isEqualTo(superProcessInstance.getId());</span>

<span class="nc" id="L787">        ProcessInstance nestedSubProcessInstance = runtimeService.createProcessInstanceQuery().superProcessInstanceId(subProcessInstance.getId())</span>
<span class="nc" id="L788">                .singleResult();</span>
<span class="nc" id="L789">        assertThat(runtimeService.createProcessInstanceQuery().subProcessInstanceId(nestedSubProcessInstance.getId()).singleResult().getId())</span>
<span class="nc" id="L790">                .isEqualTo(subProcessInstance.getId());</span>
<span class="nc" id="L791">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/superProcessWithNestedSubProcess.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/runtime/nestedSubProcess.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/runtime/subProcess.bpmn20.xml&quot; })
    public void testQueryWithExcludeSubprocesses() {
<span class="nc" id="L798">        ProcessInstance superProcessInstance = runtimeService.startProcessInstanceByKey(&quot;nestedSubProcessQueryTest&quot;);</span>
<span class="nc" id="L799">        ProcessInstance subProcessInstance = runtimeService.createProcessInstanceQuery().superProcessInstanceId(superProcessInstance.getId()).singleResult();</span>
<span class="nc" id="L800">        ProcessInstance nestedSubProcessInstance = runtimeService.createProcessInstanceQuery().superProcessInstanceId(subProcessInstance.getId())</span>
<span class="nc" id="L801">                .singleResult();</span>

<span class="nc" id="L803">        List&lt;ProcessInstance&gt; instanceList = runtimeService.createProcessInstanceQuery().excludeSubprocesses(true).list();</span>
<span class="nc" id="L804">        assertThat(instanceList).hasSize(6);</span>

<span class="nc" id="L806">        boolean superProcessFound = false;</span>
<span class="nc" id="L807">        boolean subProcessFound = false;</span>
<span class="nc" id="L808">        boolean nestedSubProcessFound = false;</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">        for (ProcessInstance processInstance : instanceList) {</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">            if (processInstance.getId().equals(superProcessInstance.getId())) {</span>
<span class="nc" id="L811">                superProcessFound = true;</span>
<span class="nc bnc" id="L812" title="All 2 branches missed.">            } else if (processInstance.getId().equals(subProcessInstance.getId())) {</span>
<span class="nc" id="L813">                subProcessFound = true;</span>
<span class="nc bnc" id="L814" title="All 2 branches missed.">            } else if (processInstance.getId().equals(nestedSubProcessInstance.getId())) {</span>
<span class="nc" id="L815">                nestedSubProcessFound = true;</span>
            }
<span class="nc" id="L817">        }</span>
<span class="nc" id="L818">        assertThat(superProcessFound).isTrue();</span>
<span class="nc" id="L819">        assertThat(subProcessFound).isFalse();</span>
<span class="nc" id="L820">        assertThat(nestedSubProcessFound).isFalse();</span>

<span class="nc" id="L822">        instanceList = runtimeService.createProcessInstanceQuery().excludeSubprocesses(false).list();</span>
<span class="nc" id="L823">        assertThat(instanceList).hasSize(8);</span>
<span class="nc" id="L824">    }</span>

    @Test
    public void testQueryPaging() {
<span class="nc" id="L828">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(PROCESS_DEFINITION_KEY).count())</span>
<span class="nc" id="L829">                .isEqualTo(PROCESS_DEFINITION_KEY_DEPLOY_COUNT);</span>
<span class="nc" id="L830">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(PROCESS_DEFINITION_KEY).listPage(0, 2)).hasSize(2);</span>
<span class="nc" id="L831">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(PROCESS_DEFINITION_KEY).listPage(1, 3)).hasSize(3);</span>
<span class="nc" id="L832">    }</span>

    @Test
    public void testQuerySorting() {
<span class="nc" id="L836">        assertThat(runtimeService.createProcessInstanceQuery().orderByProcessInstanceId().asc().list()).hasSize(PROCESS_DEPLOY_COUNT);</span>
<span class="nc" id="L837">        assertThat(runtimeService.createProcessInstanceQuery().orderByProcessDefinitionId().asc().list()).hasSize(PROCESS_DEPLOY_COUNT);</span>
<span class="nc" id="L838">        assertThat(runtimeService.createProcessInstanceQuery().orderByProcessDefinitionKey().asc().list()).hasSize(PROCESS_DEPLOY_COUNT);</span>

<span class="nc" id="L840">        assertThat(runtimeService.createProcessInstanceQuery().orderByProcessInstanceId().desc().list()).hasSize(PROCESS_DEPLOY_COUNT);</span>
<span class="nc" id="L841">        assertThat(runtimeService.createProcessInstanceQuery().orderByProcessDefinitionId().desc().list()).hasSize(PROCESS_DEPLOY_COUNT);</span>
<span class="nc" id="L842">        assertThat(runtimeService.createProcessInstanceQuery().orderByProcessDefinitionKey().desc().list()).hasSize(PROCESS_DEPLOY_COUNT);</span>

<span class="nc" id="L844">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(PROCESS_DEFINITION_KEY).orderByProcessInstanceId().asc().list())</span>
<span class="nc" id="L845">                .hasSize(PROCESS_DEFINITION_KEY_DEPLOY_COUNT);</span>
<span class="nc" id="L846">        assertThat(runtimeService.createProcessInstanceQuery().processDefinitionKey(PROCESS_DEFINITION_KEY).orderByProcessInstanceId().desc().list())</span>
<span class="nc" id="L847">                .hasSize(PROCESS_DEFINITION_KEY_DEPLOY_COUNT);</span>
<span class="nc" id="L848">    }</span>

    @Test
    public void testQueryInvalidSorting() {
        // asc - desc not called -&gt; exception
<span class="nc" id="L853">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().orderByProcessDefinitionId().list())</span>
<span class="nc" id="L854">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class);</span>
<span class="nc" id="L855">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryStringVariable() {
<span class="nc" id="L860">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L861">        vars.put(&quot;stringVar&quot;, &quot;abcdef&quot;);</span>
<span class="nc" id="L862">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L864">        vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L865">        vars.put(&quot;stringVar&quot;, &quot;abcdef&quot;);</span>
<span class="nc" id="L866">        vars.put(&quot;stringVar2&quot;, &quot;ghijkl&quot;);</span>
<span class="nc" id="L867">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L869">        vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L870">        vars.put(&quot;stringVar&quot;, &quot;azerty&quot;);</span>
<span class="nc" id="L871">        ProcessInstance processInstance3 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

        // Test EQUAL on single string variable, should result in 2 matches
<span class="nc" id="L874">        ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;stringVar&quot;, &quot;abcdef&quot;);</span>
<span class="nc" id="L875">        List&lt;ProcessInstance&gt; processInstances = query.list();</span>
<span class="nc" id="L876">        assertThat(processInstances).hasSize(2);</span>

        // Test EQUAL on two string variables, should result in single match
<span class="nc" id="L879">        query = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;stringVar&quot;, &quot;abcdef&quot;).variableValueEquals(&quot;stringVar2&quot;, &quot;ghijkl&quot;);</span>
<span class="nc" id="L880">        ProcessInstance resultInstance = query.singleResult();</span>
<span class="nc" id="L881">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L882">        assertThat(resultInstance.getId()).isEqualTo(processInstance2.getId());</span>

        // Test NOT_EQUAL, should return only 1 resultInstance
<span class="nc" id="L885">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueNotEquals(&quot;stringVar&quot;, &quot;abcdef&quot;).singleResult();</span>
<span class="nc" id="L886">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L887">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

        // Test GREATER_THAN, should return only matching 'azerty'
<span class="nc" id="L890">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;stringVar&quot;, &quot;abcdef&quot;).singleResult();</span>
<span class="nc" id="L891">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L892">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L894">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;stringVar&quot;, &quot;z&quot;).singleResult();</span>
<span class="nc" id="L895">        assertThat(resultInstance).isNull();</span>

        // Test GREATER_THAN_OR_EQUAL, should return 3 results
<span class="nc" id="L898">        assertThat(runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;stringVar&quot;, &quot;abcdef&quot;).count()).isEqualTo(3);</span>
<span class="nc" id="L899">        assertThat(runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;stringVar&quot;, &quot;z&quot;).count()).isZero();</span>

        // Test LESS_THAN, should return 2 results
<span class="nc" id="L902">        processInstances = runtimeService.createProcessInstanceQuery().variableValueLessThan(&quot;stringVar&quot;, &quot;abcdeg&quot;).list();</span>
<span class="nc" id="L903">        assertThat(processInstances)</span>
<span class="nc" id="L904">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L905">                .containsExactlyInAnyOrder(processInstance1.getId(), processInstance2.getId());</span>

<span class="nc" id="L907">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLessThan(&quot;stringVar&quot;, &quot;abcdef&quot;).count()).isZero();</span>
<span class="nc" id="L908">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLessThanOrEqual(&quot;stringVar&quot;, &quot;z&quot;).count()).isEqualTo(3);</span>

        // Test LESS_THAN_OR_EQUAL
<span class="nc" id="L911">        processInstances = runtimeService.createProcessInstanceQuery().variableValueLessThanOrEqual(&quot;stringVar&quot;, &quot;abcdef&quot;).list();</span>
<span class="nc" id="L912">        assertThat(processInstances)</span>
<span class="nc" id="L913">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L914">                .containsExactlyInAnyOrder(processInstance1.getId(), processInstance2.getId());</span>

<span class="nc" id="L916">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLessThanOrEqual(&quot;stringVar&quot;, &quot;z&quot;).count()).isEqualTo(3);</span>
<span class="nc" id="L917">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLessThanOrEqual(&quot;stringVar&quot;, &quot;aa&quot;).count()).isZero();</span>

        // Test LIKE
<span class="nc" id="L920">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueLike(&quot;stringVar&quot;, &quot;azert%&quot;).singleResult();</span>
<span class="nc" id="L921">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L922">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L924">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueLike(&quot;stringVar&quot;, &quot;%y&quot;).singleResult();</span>
<span class="nc" id="L925">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L926">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L928">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueLike(&quot;stringVar&quot;, &quot;%zer%&quot;).singleResult();</span>
<span class="nc" id="L929">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L930">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L932">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLike(&quot;stringVar&quot;, &quot;a%&quot;).count()).isEqualTo(3);</span>
<span class="nc" id="L933">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLike(&quot;stringVar&quot;, &quot;%x%&quot;).count()).isZero();</span>

        // Test value-only matching
<span class="nc" id="L936">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;azerty&quot;).singleResult();</span>
<span class="nc" id="L937">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L938">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L940">        processInstances = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;abcdef&quot;).list();</span>
<span class="nc" id="L941">        assertThat(processInstances)</span>
<span class="nc" id="L942">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L943">                .containsExactlyInAnyOrder(processInstance1.getId(), processInstance2.getId());</span>

<span class="nc" id="L945">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;notmatchinganyvalues&quot;).singleResult();</span>
<span class="nc" id="L946">        assertThat(resultInstance).isNull();</span>

<span class="nc" id="L948">        runtimeService.deleteProcessInstance(processInstance1.getId(), &quot;test&quot;);</span>
<span class="nc" id="L949">        runtimeService.deleteProcessInstance(processInstance2.getId(), &quot;test&quot;);</span>
<span class="nc" id="L950">        runtimeService.deleteProcessInstance(processInstance3.getId(), &quot;test&quot;);</span>
<span class="nc" id="L951">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryLongVariable() {
<span class="nc" id="L956">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L957">        vars.put(&quot;longVar&quot;, 12345L);</span>
<span class="nc" id="L958">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L960">        vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L961">        vars.put(&quot;longVar&quot;, 12345L);</span>
<span class="nc" id="L962">        vars.put(&quot;longVar2&quot;, 67890L);</span>
<span class="nc" id="L963">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L965">        vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L966">        vars.put(&quot;longVar&quot;, 55555L);</span>
<span class="nc" id="L967">        ProcessInstance processInstance3 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

        // Query on single long variable, should result in 2 matches
<span class="nc" id="L970">        ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;longVar&quot;, 12345L);</span>
<span class="nc" id="L971">        List&lt;ProcessInstance&gt; processInstances = query.list();</span>
<span class="nc" id="L972">        assertThat(processInstances).hasSize(2);</span>

        // Query on two long variables, should result in single match
<span class="nc" id="L975">        query = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;longVar&quot;, 12345L).variableValueEquals(&quot;longVar2&quot;, 67890L);</span>
<span class="nc" id="L976">        ProcessInstance resultInstance = query.singleResult();</span>
<span class="nc" id="L977">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L978">        assertThat(resultInstance.getId()).isEqualTo(processInstance2.getId());</span>

        // Query with unexisting variable value
<span class="nc" id="L981">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;longVar&quot;, 999L).singleResult();</span>
<span class="nc" id="L982">        assertThat(resultInstance).isNull();</span>

        // Test NOT_EQUALS
<span class="nc" id="L985">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueNotEquals(&quot;longVar&quot;, 12345L).singleResult();</span>
<span class="nc" id="L986">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L987">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

        // Test GREATER_THAN
<span class="nc" id="L990">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;longVar&quot;, 44444L).singleResult();</span>
<span class="nc" id="L991">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L992">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L994">        assertThat(runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;longVar&quot;, 55555L).count()).isZero();</span>
<span class="nc" id="L995">        assertThat(runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;longVar&quot;, 1L).count()).isEqualTo(3);</span>

        // Test GREATER_THAN_OR_EQUAL
<span class="nc" id="L998">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;longVar&quot;, 44444L).singleResult();</span>
<span class="nc" id="L999">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1000">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1002">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;longVar&quot;, 55555L).singleResult();</span>
<span class="nc" id="L1003">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1004">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1006">        assertThat(runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;longVar&quot;, 1L).count()).isEqualTo(3);</span>

        // Test LESS_THAN
<span class="nc" id="L1009">        processInstances = runtimeService.createProcessInstanceQuery().variableValueLessThan(&quot;longVar&quot;, 55555L).list();</span>
<span class="nc" id="L1010">        assertThat(processInstances)</span>
<span class="nc" id="L1011">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L1012">                .containsExactlyInAnyOrder(processInstance1.getId(), processInstance2.getId());</span>

<span class="nc" id="L1014">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLessThan(&quot;longVar&quot;, 12345L).count()).isZero();</span>
<span class="nc" id="L1015">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLessThan(&quot;longVar&quot;, 66666L).count()).isEqualTo(3);</span>

        // Test LESS_THAN_OR_EQUAL
<span class="nc" id="L1018">        processInstances = runtimeService.createProcessInstanceQuery().variableValueLessThanOrEqual(&quot;longVar&quot;, 55555L).list();</span>
<span class="nc" id="L1019">        assertThat(processInstances).hasSize(3);</span>

<span class="nc" id="L1021">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLessThanOrEqual(&quot;longVar&quot;, 12344L).count()).isZero();</span>

        // Test value-only matching
<span class="nc" id="L1024">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueEquals(55555L).singleResult();</span>
<span class="nc" id="L1025">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1026">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1028">        processInstances = runtimeService.createProcessInstanceQuery().variableValueEquals(12345L).list();</span>
<span class="nc" id="L1029">        assertThat(processInstances)</span>
<span class="nc" id="L1030">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L1031">                .containsExactlyInAnyOrder(processInstance1.getId(), processInstance2.getId());</span>

<span class="nc" id="L1033">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueEquals(999L).singleResult();</span>
<span class="nc" id="L1034">        assertThat(resultInstance).isNull();</span>

<span class="nc" id="L1036">        runtimeService.deleteProcessInstance(processInstance1.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1037">        runtimeService.deleteProcessInstance(processInstance2.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1038">        runtimeService.deleteProcessInstance(processInstance3.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1039">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryDoubleVariable() {
<span class="nc" id="L1044">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1045">        vars.put(&quot;doubleVar&quot;, 12345.6789);</span>
<span class="nc" id="L1046">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1048">        vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1049">        vars.put(&quot;doubleVar&quot;, 12345.6789);</span>
<span class="nc" id="L1050">        vars.put(&quot;doubleVar2&quot;, 9876.54321);</span>
<span class="nc" id="L1051">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1053">        vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1054">        vars.put(&quot;doubleVar&quot;, 55555.5555);</span>
<span class="nc" id="L1055">        ProcessInstance processInstance3 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

        // Query on single double variable, should result in 2 matches
<span class="nc" id="L1058">        ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;doubleVar&quot;, 12345.6789);</span>
<span class="nc" id="L1059">        List&lt;ProcessInstance&gt; processInstances = query.list();</span>
<span class="nc" id="L1060">        assertThat(processInstances).hasSize(2);</span>

        // Query on two double variables, should result in single value
<span class="nc" id="L1063">        query = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;doubleVar&quot;, 12345.6789).variableValueEquals(&quot;doubleVar2&quot;, 9876.54321);</span>
<span class="nc" id="L1064">        ProcessInstance resultInstance = query.singleResult();</span>
<span class="nc" id="L1065">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1066">        assertThat(resultInstance.getId()).isEqualTo(processInstance2.getId());</span>

        // Query with unexisting variable value
<span class="nc" id="L1069">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;doubleVar&quot;, 9999.99).singleResult();</span>
<span class="nc" id="L1070">        assertThat(resultInstance).isNull();</span>

        // Test NOT_EQUALS
<span class="nc" id="L1073">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueNotEquals(&quot;doubleVar&quot;, 12345.6789).singleResult();</span>
<span class="nc" id="L1074">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1075">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

        // Test GREATER_THAN
<span class="nc" id="L1078">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;doubleVar&quot;, 44444.4444).singleResult();</span>
<span class="nc" id="L1079">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1080">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1082">        assertThat(runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;doubleVar&quot;, 55555.5555).count()).isZero();</span>
<span class="nc" id="L1083">        assertThat(runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;doubleVar&quot;, 1.234).count()).isEqualTo(3);</span>

        // Test GREATER_THAN_OR_EQUAL
<span class="nc" id="L1086">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;doubleVar&quot;, 44444.4444).singleResult();</span>
<span class="nc" id="L1087">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1088">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1090">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;doubleVar&quot;, 55555.5555).singleResult();</span>
<span class="nc" id="L1091">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1092">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1094">        assertThat(runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;doubleVar&quot;, 1.234).count()).isEqualTo(3);</span>

        // Test LESS_THAN
<span class="nc" id="L1097">        processInstances = runtimeService.createProcessInstanceQuery().variableValueLessThan(&quot;doubleVar&quot;, 55555.5555).list();</span>
<span class="nc" id="L1098">        assertThat(processInstances).hasSize(2);</span>

<span class="nc" id="L1100">        assertThat(processInstances)</span>
<span class="nc" id="L1101">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L1102">                .containsExactlyInAnyOrder(processInstance1.getId(), processInstance2.getId());</span>

<span class="nc" id="L1104">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLessThan(&quot;doubleVar&quot;, 12345.6789).count()).isZero();</span>
<span class="nc" id="L1105">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLessThan(&quot;doubleVar&quot;, 66666.6666).count()).isEqualTo(3);</span>

        // Test LESS_THAN_OR_EQUAL
<span class="nc" id="L1108">        processInstances = runtimeService.createProcessInstanceQuery().variableValueLessThanOrEqual(&quot;doubleVar&quot;, 55555.5555).list();</span>
<span class="nc" id="L1109">        assertThat(processInstances).hasSize(3);</span>

<span class="nc" id="L1111">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLessThanOrEqual(&quot;doubleVar&quot;, 12344.6789).count()).isZero();</span>

        // Test value-only matching
<span class="nc" id="L1114">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueEquals(55555.5555).singleResult();</span>
<span class="nc" id="L1115">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1116">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1118">        processInstances = runtimeService.createProcessInstanceQuery().variableValueEquals(12345.6789).list();</span>
<span class="nc" id="L1119">        assertThat(processInstances)</span>
<span class="nc" id="L1120">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L1121">                .containsExactlyInAnyOrder(processInstance1.getId(), processInstance2.getId());</span>

<span class="nc" id="L1123">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueEquals(999.999).singleResult();</span>
<span class="nc" id="L1124">        assertThat(resultInstance).isNull();</span>

<span class="nc" id="L1126">        runtimeService.deleteProcessInstance(processInstance1.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1127">        runtimeService.deleteProcessInstance(processInstance2.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1128">        runtimeService.deleteProcessInstance(processInstance3.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1129">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryIntegerVariable() {
<span class="nc" id="L1134">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1135">        vars.put(&quot;integerVar&quot;, 12345);</span>
<span class="nc" id="L1136">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1138">        vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1139">        vars.put(&quot;integerVar&quot;, 12345);</span>
<span class="nc" id="L1140">        vars.put(&quot;integerVar2&quot;, 67890);</span>
<span class="nc" id="L1141">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1143">        vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1144">        vars.put(&quot;integerVar&quot;, 55555);</span>
<span class="nc" id="L1145">        ProcessInstance processInstance3 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

        // Query on single integer variable, should result in 2 matches
<span class="nc" id="L1148">        ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;integerVar&quot;, 12345);</span>
<span class="nc" id="L1149">        List&lt;ProcessInstance&gt; processInstances = query.list();</span>
<span class="nc" id="L1150">        assertThat(processInstances).hasSize(2);</span>

        // Query on two integer variables, should result in single value
<span class="nc" id="L1153">        query = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;integerVar&quot;, 12345).variableValueEquals(&quot;integerVar2&quot;, 67890);</span>
<span class="nc" id="L1154">        ProcessInstance resultInstance = query.singleResult();</span>
<span class="nc" id="L1155">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1156">        assertThat(resultInstance.getId()).isEqualTo(processInstance2.getId());</span>

        // Query with unexisting variable value
<span class="nc" id="L1159">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;integerVar&quot;, 9999).singleResult();</span>
<span class="nc" id="L1160">        assertThat(resultInstance).isNull();</span>

        // Test NOT_EQUALS
<span class="nc" id="L1163">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueNotEquals(&quot;integerVar&quot;, 12345).singleResult();</span>
<span class="nc" id="L1164">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1165">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

        // Test GREATER_THAN
<span class="nc" id="L1168">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;integerVar&quot;, 44444).singleResult();</span>
<span class="nc" id="L1169">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1170">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1172">        assertThat(runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;integerVar&quot;, 55555).count()).isZero();</span>
<span class="nc" id="L1173">        assertThat(runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;integerVar&quot;, 1).count()).isEqualTo(3);</span>

        // Test GREATER_THAN_OR_EQUAL
<span class="nc" id="L1176">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;integerVar&quot;, 44444).singleResult();</span>
<span class="nc" id="L1177">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1178">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1180">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;integerVar&quot;, 55555).singleResult();</span>
<span class="nc" id="L1181">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1182">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1184">        assertThat(runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;integerVar&quot;, 1).count()).isEqualTo(3);</span>

        // Test LESS_THAN
<span class="nc" id="L1187">        processInstances = runtimeService.createProcessInstanceQuery().variableValueLessThan(&quot;integerVar&quot;, 55555).list();</span>
<span class="nc" id="L1188">        assertThat(processInstances)</span>
<span class="nc" id="L1189">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L1190">                .containsExactlyInAnyOrder(processInstance1.getId(), processInstance2.getId());</span>

<span class="nc" id="L1192">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLessThan(&quot;integerVar&quot;, 12345).count()).isZero();</span>
<span class="nc" id="L1193">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLessThan(&quot;integerVar&quot;, 66666).count()).isEqualTo(3);</span>

        // Test LESS_THAN_OR_EQUAL
<span class="nc" id="L1196">        processInstances = runtimeService.createProcessInstanceQuery().variableValueLessThanOrEqual(&quot;integerVar&quot;, 55555).list();</span>
<span class="nc" id="L1197">        assertThat(processInstances).hasSize(3);</span>

<span class="nc" id="L1199">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLessThanOrEqual(&quot;integerVar&quot;, 12344).count()).isZero();</span>

        // Test value-only matching
<span class="nc" id="L1202">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueEquals(55555).singleResult();</span>
<span class="nc" id="L1203">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1204">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1206">        processInstances = runtimeService.createProcessInstanceQuery().variableValueEquals(12345).list();</span>
<span class="nc" id="L1207">        assertThat(processInstances)</span>
<span class="nc" id="L1208">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L1209">                .containsExactlyInAnyOrder(processInstance1.getId(), processInstance2.getId());</span>

<span class="nc" id="L1211">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueEquals(9999).singleResult();</span>
<span class="nc" id="L1212">        assertThat(resultInstance).isNull();</span>

<span class="nc" id="L1214">        runtimeService.deleteProcessInstance(processInstance1.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1215">        runtimeService.deleteProcessInstance(processInstance2.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1216">        runtimeService.deleteProcessInstance(processInstance3.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1217">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testOrQueryIntegerVariable() {
<span class="nc" id="L1222">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1223">        vars.put(&quot;integerVar&quot;, 12345);</span>
<span class="nc" id="L1224">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1226">        vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1227">        vars.put(&quot;integerVar&quot;, 12345);</span>
<span class="nc" id="L1228">        vars.put(&quot;integerVar2&quot;, 67890);</span>
<span class="nc" id="L1229">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1231">        vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1232">        vars.put(&quot;integerVar&quot;, 55555);</span>
<span class="nc" id="L1233">        ProcessInstance processInstance3 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

        // Query on single integer variable, should result in 2 matches
<span class="nc" id="L1236">        ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery().or().variableValueEquals(&quot;integerVar&quot;, 12345).processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L1237">                .endOr();</span>
<span class="nc" id="L1238">        List&lt;ProcessInstance&gt; processInstances = query.list();</span>
<span class="nc" id="L1239">        assertThat(processInstances).hasSize(2);</span>

<span class="nc" id="L1241">        query = runtimeService.createProcessInstanceQuery()</span>
<span class="nc" id="L1242">                .or()</span>
<span class="nc" id="L1243">                .variableValueEquals(&quot;integerVar&quot;, 12345)</span>
<span class="nc" id="L1244">                .processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L1245">                .endOr()</span>
<span class="nc" id="L1246">                .or()</span>
<span class="nc" id="L1247">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L1248">                .processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L1249">                .endOr();</span>
<span class="nc" id="L1250">        processInstances = query.list();</span>
<span class="nc" id="L1251">        assertThat(processInstances).hasSize(2);</span>

        // Query on two integer variables, should result in single value
<span class="nc" id="L1254">        query = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;integerVar&quot;, 12345).or().variableValueEquals(&quot;integerVar2&quot;, 67890)</span>
<span class="nc" id="L1255">                .processDefinitionId(&quot;undefined&quot;).endOr();</span>
<span class="nc" id="L1256">        ProcessInstance resultInstance = query.singleResult();</span>
<span class="nc" id="L1257">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1258">        assertThat(resultInstance.getId()).isEqualTo(processInstance2.getId());</span>

        // Query with unexisting variable value
<span class="nc" id="L1261">        resultInstance = runtimeService.createProcessInstanceQuery().or().variableValueEquals(&quot;integerVar&quot;, 9999).processDefinitionId(&quot;undefined&quot;).endOr()</span>
<span class="nc" id="L1262">                .singleResult();</span>
<span class="nc" id="L1263">        assertThat(resultInstance).isNull();</span>

        // Test NOT_EQUALS
<span class="nc" id="L1266">        resultInstance = runtimeService.createProcessInstanceQuery().or().variableValueNotEquals(&quot;integerVar&quot;, 12345).processDefinitionId(&quot;undefined&quot;).endOr()</span>
<span class="nc" id="L1267">                .singleResult();</span>
<span class="nc" id="L1268">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1269">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

        // Test GREATER_THAN
<span class="nc" id="L1272">        resultInstance = runtimeService.createProcessInstanceQuery().or().variableValueGreaterThan(&quot;integerVar&quot;, 44444).processDefinitionId(&quot;undefined&quot;).endOr()</span>
<span class="nc" id="L1273">                .singleResult();</span>
<span class="nc" id="L1274">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1275">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1277">        resultInstance = runtimeService.createProcessInstanceQuery()</span>
<span class="nc" id="L1278">                .or()</span>
<span class="nc" id="L1279">                .variableValueGreaterThan(&quot;integerVar&quot;, 44444)</span>
<span class="nc" id="L1280">                .processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L1281">                .endOr()</span>
<span class="nc" id="L1282">                .or()</span>
<span class="nc" id="L1283">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L1284">                .processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L1285">                .endOr()</span>
<span class="nc" id="L1286">                .singleResult();</span>
<span class="nc" id="L1287">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1288">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1290">        assertThat(</span>
<span class="nc" id="L1291">                runtimeService.createProcessInstanceQuery().or().variableValueGreaterThan(&quot;integerVar&quot;, 55555).processDefinitionId(&quot;undefined&quot;).endOr().count())</span>
<span class="nc" id="L1292">                .isZero();</span>
<span class="nc" id="L1293">        assertThat(runtimeService.createProcessInstanceQuery().or().variableValueGreaterThan(&quot;integerVar&quot;, 1).processDefinitionId(&quot;undefined&quot;).endOr().count())</span>
<span class="nc" id="L1294">                .isEqualTo(3);</span>

        // Test GREATER_THAN_OR_EQUAL
<span class="nc" id="L1297">        resultInstance = runtimeService.createProcessInstanceQuery().or().variableValueGreaterThanOrEqual(&quot;integerVar&quot;, 44444).processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L1298">                .endOr().singleResult();</span>
<span class="nc" id="L1299">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1300">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1302">        resultInstance = runtimeService.createProcessInstanceQuery().or().variableValueGreaterThanOrEqual(&quot;integerVar&quot;, 55555).processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L1303">                .endOr().singleResult();</span>
<span class="nc" id="L1304">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1305">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1307">        assertThat(runtimeService.createProcessInstanceQuery().or().variableValueGreaterThanOrEqual(&quot;integerVar&quot;, 1).processDefinitionId(&quot;undefined&quot;).endOr()</span>
<span class="nc" id="L1308">                .count()).isEqualTo(3);</span>

        // Test LESS_THAN
<span class="nc" id="L1311">        processInstances = runtimeService.createProcessInstanceQuery().or().variableValueLessThan(&quot;integerVar&quot;, 55555).processDefinitionId(&quot;undefined&quot;).endOr()</span>
<span class="nc" id="L1312">                .list();</span>
<span class="nc" id="L1313">        assertThat(processInstances)</span>
<span class="nc" id="L1314">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L1315">                .containsExactlyInAnyOrder(processInstance1.getId(), processInstance2.getId());</span>

<span class="nc" id="L1317">        assertThat(runtimeService.createProcessInstanceQuery().or().variableValueLessThan(&quot;integerVar&quot;, 12345).processDefinitionId(&quot;undefined&quot;).endOr().count())</span>
<span class="nc" id="L1318">                .isZero();</span>
<span class="nc" id="L1319">        assertThat(runtimeService.createProcessInstanceQuery().or().variableValueLessThan(&quot;integerVar&quot;, 66666).processDefinitionId(&quot;undefined&quot;).endOr().count())</span>
<span class="nc" id="L1320">                .isEqualTo(3);</span>

        // Test LESS_THAN_OR_EQUAL
<span class="nc" id="L1323">        processInstances = runtimeService.createProcessInstanceQuery().or().variableValueLessThanOrEqual(&quot;integerVar&quot;, 55555).processDefinitionId(&quot;undefined&quot;)</span>
<span class="nc" id="L1324">                .endOr().list();</span>
<span class="nc" id="L1325">        assertThat(processInstances).hasSize(3);</span>

<span class="nc" id="L1327">        assertThat(runtimeService.createProcessInstanceQuery().or().variableValueLessThanOrEqual(&quot;integerVar&quot;, 12344).processDefinitionId(&quot;undefined&quot;).endOr()</span>
<span class="nc" id="L1328">                .count()).isZero();</span>

        // Test value-only matching
<span class="nc" id="L1331">        resultInstance = runtimeService.createProcessInstanceQuery().or().variableValueEquals(55555).processDefinitionId(&quot;undefined&quot;).endOr().singleResult();</span>
<span class="nc" id="L1332">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1333">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1335">        processInstances = runtimeService.createProcessInstanceQuery().or().variableValueEquals(12345).processDefinitionId(&quot;undefined&quot;).endOr().list();</span>
<span class="nc" id="L1336">        assertThat(processInstances)</span>
<span class="nc" id="L1337">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L1338">                .containsExactlyInAnyOrder(processInstance1.getId(), processInstance2.getId());</span>

<span class="nc" id="L1340">        resultInstance = runtimeService.createProcessInstanceQuery().or().variableValueEquals(9999).processDefinitionId(&quot;undefined&quot;).endOr().singleResult();</span>
<span class="nc" id="L1341">        assertThat(resultInstance).isNull();</span>

<span class="nc" id="L1343">        runtimeService.deleteProcessInstance(processInstance1.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1344">        runtimeService.deleteProcessInstance(processInstance2.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1345">        runtimeService.deleteProcessInstance(processInstance3.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1346">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryShortVariable() {
<span class="nc" id="L1351">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1352">        short shortVar = 1234;</span>
<span class="nc" id="L1353">        vars.put(&quot;shortVar&quot;, shortVar);</span>
<span class="nc" id="L1354">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1356">        short shortVar2 = 6789;</span>
<span class="nc" id="L1357">        vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1358">        vars.put(&quot;shortVar&quot;, shortVar);</span>
<span class="nc" id="L1359">        vars.put(&quot;shortVar2&quot;, shortVar2);</span>
<span class="nc" id="L1360">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1362">        vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1363">        vars.put(&quot;shortVar&quot;, (short) 5555);</span>
<span class="nc" id="L1364">        ProcessInstance processInstance3 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

        // Query on single short variable, should result in 2 matches
<span class="nc" id="L1367">        ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;shortVar&quot;, shortVar);</span>
<span class="nc" id="L1368">        List&lt;ProcessInstance&gt; processInstances = query.list();</span>
<span class="nc" id="L1369">        assertThat(processInstances).hasSize(2);</span>

        // Query on two short variables, should result in single value
<span class="nc" id="L1372">        query = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;shortVar&quot;, shortVar).variableValueEquals(&quot;shortVar2&quot;, shortVar2);</span>
<span class="nc" id="L1373">        ProcessInstance resultInstance = query.singleResult();</span>
<span class="nc" id="L1374">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1375">        assertThat(resultInstance.getId()).isEqualTo(processInstance2.getId());</span>

        // Query with unexisting variable value
<span class="nc" id="L1378">        short unexistingValue = (short) 9999;</span>
<span class="nc" id="L1379">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;shortVar&quot;, unexistingValue).singleResult();</span>
<span class="nc" id="L1380">        assertThat(resultInstance).isNull();</span>

        // Test NOT_EQUALS
<span class="nc" id="L1383">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueNotEquals(&quot;shortVar&quot;, (short) 1234).singleResult();</span>
<span class="nc" id="L1384">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1385">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

        // Test GREATER_THAN
<span class="nc" id="L1388">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;shortVar&quot;, (short) 4444).singleResult();</span>
<span class="nc" id="L1389">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1390">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1392">        assertThat(runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;shortVar&quot;, (short) 5555).count()).isZero();</span>
<span class="nc" id="L1393">        assertThat(runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;shortVar&quot;, (short) 1).count()).isEqualTo(3);</span>

        // Test GREATER_THAN_OR_EQUAL
<span class="nc" id="L1396">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;shortVar&quot;, (short) 4444).singleResult();</span>
<span class="nc" id="L1397">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1398">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1400">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;shortVar&quot;, (short) 5555).singleResult();</span>
<span class="nc" id="L1401">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1402">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1404">        assertThat(runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;shortVar&quot;, (short) 1).count()).isEqualTo(3);</span>

        // Test LESS_THAN
<span class="nc" id="L1407">        processInstances = runtimeService.createProcessInstanceQuery().variableValueLessThan(&quot;shortVar&quot;, (short) 5555).list();</span>
<span class="nc" id="L1408">        assertThat(processInstances)</span>
<span class="nc" id="L1409">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L1410">                .containsExactlyInAnyOrder(processInstance1.getId(), processInstance2.getId());</span>

<span class="nc" id="L1412">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLessThan(&quot;shortVar&quot;, (short) 1234).count()).isZero();</span>
<span class="nc" id="L1413">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLessThan(&quot;shortVar&quot;, (short) 6666).count()).isEqualTo(3);</span>

        // Test LESS_THAN_OR_EQUAL
<span class="nc" id="L1416">        processInstances = runtimeService.createProcessInstanceQuery().variableValueLessThanOrEqual(&quot;shortVar&quot;, (short) 5555).list();</span>
<span class="nc" id="L1417">        assertThat(processInstances).hasSize(3);</span>

<span class="nc" id="L1419">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLessThanOrEqual(&quot;shortVar&quot;, (short) 1233).count()).isZero();</span>

        // Test value-only matching
<span class="nc" id="L1422">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueEquals((short) 5555).singleResult();</span>
<span class="nc" id="L1423">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1424">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1426">        processInstances = runtimeService.createProcessInstanceQuery().variableValueEquals((short) 1234).list();</span>
<span class="nc" id="L1427">        assertThat(processInstances)</span>
<span class="nc" id="L1428">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L1429">                .containsExactlyInAnyOrder(processInstance1.getId(), processInstance2.getId());</span>

<span class="nc" id="L1431">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueEquals((short) 999).singleResult();</span>
<span class="nc" id="L1432">        assertThat(resultInstance).isNull();</span>

<span class="nc" id="L1434">        runtimeService.deleteProcessInstance(processInstance1.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1435">        runtimeService.deleteProcessInstance(processInstance2.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1436">        runtimeService.deleteProcessInstance(processInstance3.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1437">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryDateVariable() throws Exception {
<span class="nc" id="L1442">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1443">        Date date1 = Calendar.getInstance().getTime();</span>
<span class="nc" id="L1444">        vars.put(&quot;dateVar&quot;, date1);</span>

<span class="nc" id="L1446">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1448">        Calendar cal2 = Calendar.getInstance();</span>
<span class="nc" id="L1449">        cal2.add(Calendar.SECOND, 1);</span>

<span class="nc" id="L1451">        Date date2 = cal2.getTime();</span>
<span class="nc" id="L1452">        vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1453">        vars.put(&quot;dateVar&quot;, date1);</span>
<span class="nc" id="L1454">        vars.put(&quot;dateVar2&quot;, date2);</span>
<span class="nc" id="L1455">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1457">        Calendar nextYear = Calendar.getInstance();</span>
<span class="nc" id="L1458">        nextYear.add(Calendar.YEAR, 1);</span>
<span class="nc" id="L1459">        vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1460">        vars.put(&quot;dateVar&quot;, nextYear.getTime());</span>
<span class="nc" id="L1461">        ProcessInstance processInstance3 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1463">        Calendar nextMonth = Calendar.getInstance();</span>
<span class="nc" id="L1464">        nextMonth.add(Calendar.MONTH, 1);</span>

<span class="nc" id="L1466">        Calendar twoYearsLater = Calendar.getInstance();</span>
<span class="nc" id="L1467">        twoYearsLater.add(Calendar.YEAR, 2);</span>

<span class="nc" id="L1469">        Calendar oneYearAgo = Calendar.getInstance();</span>
<span class="nc" id="L1470">        oneYearAgo.add(Calendar.YEAR, -1);</span>

        // Query on single short variable, should result in 2 matches
<span class="nc" id="L1473">        ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;dateVar&quot;, date1);</span>
<span class="nc" id="L1474">        List&lt;ProcessInstance&gt; processInstances = query.list();</span>
<span class="nc" id="L1475">        assertThat(processInstances).hasSize(2);</span>

        // Query on two short variables, should result in single value
<span class="nc" id="L1478">        query = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;dateVar&quot;, date1).variableValueEquals(&quot;dateVar2&quot;, date2);</span>
<span class="nc" id="L1479">        ProcessInstance resultInstance = query.singleResult();</span>
<span class="nc" id="L1480">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1481">        assertThat(resultInstance.getId()).isEqualTo(processInstance2.getId());</span>

        // Query with unexisting variable value
<span class="nc" id="L1484">        Date unexistingDate = new SimpleDateFormat(&quot;dd/MM/yyyy hh:mm:ss&quot;).parse(&quot;01/01/1989 12:00:00&quot;);</span>
<span class="nc" id="L1485">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;dateVar&quot;, unexistingDate).singleResult();</span>
<span class="nc" id="L1486">        assertThat(resultInstance).isNull();</span>

        // Test NOT_EQUALS
<span class="nc" id="L1489">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueNotEquals(&quot;dateVar&quot;, date1).singleResult();</span>
<span class="nc" id="L1490">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1491">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

        // Test GREATER_THAN
<span class="nc" id="L1494">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;dateVar&quot;, nextMonth.getTime()).singleResult();</span>
<span class="nc" id="L1495">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1496">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1498">        assertThat(runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;dateVar&quot;, nextYear.getTime()).count()).isZero();</span>
<span class="nc" id="L1499">        assertThat(runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;dateVar&quot;, oneYearAgo.getTime()).count()).isEqualTo(3);</span>

        // Test GREATER_THAN_OR_EQUAL
<span class="nc" id="L1502">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;dateVar&quot;, nextMonth.getTime()).singleResult();</span>
<span class="nc" id="L1503">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1504">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1506">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;dateVar&quot;, nextYear.getTime()).singleResult();</span>
<span class="nc" id="L1507">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1508">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1510">        assertThat(runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;dateVar&quot;, oneYearAgo.getTime()).count()).isEqualTo(3);</span>

        // Test LESS_THAN
<span class="nc" id="L1513">        processInstances = runtimeService.createProcessInstanceQuery().variableValueLessThan(&quot;dateVar&quot;, nextYear.getTime()).list();</span>
<span class="nc" id="L1514">        assertThat(processInstances)</span>
<span class="nc" id="L1515">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L1516">                .containsExactlyInAnyOrder(processInstance1.getId(), processInstance2.getId());</span>

<span class="nc" id="L1518">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLessThan(&quot;dateVar&quot;, date1).count()).isZero();</span>
<span class="nc" id="L1519">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLessThan(&quot;dateVar&quot;, twoYearsLater.getTime()).count()).isEqualTo(3);</span>

        // Test LESS_THAN_OR_EQUAL
<span class="nc" id="L1522">        processInstances = runtimeService.createProcessInstanceQuery().variableValueLessThanOrEqual(&quot;dateVar&quot;, nextYear.getTime()).list();</span>
<span class="nc" id="L1523">        assertThat(processInstances).hasSize(3);</span>

<span class="nc" id="L1525">        assertThat(runtimeService.createProcessInstanceQuery().variableValueLessThanOrEqual(&quot;dateVar&quot;, oneYearAgo.getTime()).count()).isZero();</span>

        // Test value-only matching
<span class="nc" id="L1528">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueEquals(nextYear.getTime()).singleResult();</span>
<span class="nc" id="L1529">        assertThat(resultInstance).isNotNull();</span>
<span class="nc" id="L1530">        assertThat(resultInstance.getId()).isEqualTo(processInstance3.getId());</span>

<span class="nc" id="L1532">        processInstances = runtimeService.createProcessInstanceQuery().variableValueEquals(date1).list();</span>
<span class="nc" id="L1533">        assertThat(processInstances)</span>
<span class="nc" id="L1534">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L1535">                .containsExactlyInAnyOrder(processInstance1.getId(), processInstance2.getId());</span>

<span class="nc" id="L1537">        resultInstance = runtimeService.createProcessInstanceQuery().variableValueEquals(twoYearsLater.getTime()).singleResult();</span>
<span class="nc" id="L1538">        assertThat(resultInstance).isNull();</span>

<span class="nc" id="L1540">        runtimeService.deleteProcessInstance(processInstance1.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1541">        runtimeService.deleteProcessInstance(processInstance2.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1542">        runtimeService.deleteProcessInstance(processInstance3.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1543">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testBooleanVariable() throws Exception {

        // TEST EQUALS
<span class="nc" id="L1550">        HashMap&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1551">        vars.put(&quot;booleanVar&quot;, true);</span>
<span class="nc" id="L1552">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1554">        vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1555">        vars.put(&quot;booleanVar&quot;, false);</span>
<span class="nc" id="L1556">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1558">        List&lt;ProcessInstance&gt; instances = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;booleanVar&quot;, true).list();</span>
<span class="nc" id="L1559">        assertThat(instances).isNotNull();</span>
<span class="nc" id="L1560">        assertThat(instances)</span>
<span class="nc" id="L1561">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L1562">                .containsExactly(processInstance1.getId());</span>

<span class="nc" id="L1564">        instances = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;booleanVar&quot;, false).list();</span>
<span class="nc" id="L1565">        assertThat(instances).isNotNull();</span>
<span class="nc" id="L1566">        assertThat(instances)</span>
<span class="nc" id="L1567">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L1568">                .containsExactly(processInstance2.getId());</span>

        // TEST NOT_EQUALS
<span class="nc" id="L1571">        instances = runtimeService.createProcessInstanceQuery().variableValueNotEquals(&quot;booleanVar&quot;, true).list();</span>
<span class="nc" id="L1572">        assertThat(instances).isNotNull();</span>
<span class="nc" id="L1573">        assertThat(instances)</span>
<span class="nc" id="L1574">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L1575">                .containsExactly(processInstance2.getId());</span>

<span class="nc" id="L1577">        instances = runtimeService.createProcessInstanceQuery().variableValueNotEquals(&quot;booleanVar&quot;, false).list();</span>
<span class="nc" id="L1578">        assertThat(instances).isNotNull();</span>
<span class="nc" id="L1579">        assertThat(instances)</span>
<span class="nc" id="L1580">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L1581">                .containsExactly(processInstance1.getId());</span>

        // Test value-only matching
<span class="nc" id="L1584">        instances = runtimeService.createProcessInstanceQuery().variableValueEquals(true).list();</span>
<span class="nc" id="L1585">        assertThat(instances).isNotNull();</span>
<span class="nc" id="L1586">        assertThat(instances)</span>
<span class="nc" id="L1587">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L1588">                .containsExactly(processInstance1.getId());</span>

        // Test unsupported operations
<span class="nc" id="L1591">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;booleanVar&quot;, true))</span>
<span class="nc" id="L1592">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1593">                .hasMessage(&quot;Booleans and null cannot be used in 'greater than' condition&quot;);</span>

<span class="nc" id="L1595">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;booleanVar&quot;, true))</span>
<span class="nc" id="L1596">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1597">                .hasMessage(&quot;Booleans and null cannot be used in 'greater than or equal' condition&quot;);</span>

<span class="nc" id="L1599">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueLessThan(&quot;booleanVar&quot;, true))</span>
<span class="nc" id="L1600">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1601">                .hasMessage(&quot;Booleans and null cannot be used in 'less than' condition&quot;);</span>

<span class="nc" id="L1603">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueLessThanOrEqual(&quot;booleanVar&quot;, true))</span>
<span class="nc" id="L1604">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1605">                .hasMessage(&quot;Booleans and null cannot be used in 'less than or equal' condition&quot;);</span>

<span class="nc" id="L1607">        runtimeService.deleteProcessInstance(processInstance1.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1608">        runtimeService.deleteProcessInstance(processInstance2.getId(), &quot;test&quot;);</span>

        // Test value-only matching, no results present
<span class="nc" id="L1611">        instances = runtimeService.createProcessInstanceQuery().variableValueEquals(true).list();</span>
<span class="nc" id="L1612">        assertThat(instances).isEmpty();</span>
<span class="nc" id="L1613">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryVariablesUpdatedToNullValue() {
        // Start process instance with different types of variables
<span class="nc" id="L1619">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1620">        variables.put(&quot;longVar&quot;, 928374L);</span>
<span class="nc" id="L1621">        variables.put(&quot;shortVar&quot;, (short) 123);</span>
<span class="nc" id="L1622">        variables.put(&quot;integerVar&quot;, 1234);</span>
<span class="nc" id="L1623">        variables.put(&quot;stringVar&quot;, &quot;coca-cola&quot;);</span>
<span class="nc" id="L1624">        variables.put(&quot;dateVar&quot;, new Date());</span>
<span class="nc" id="L1625">        variables.put(&quot;booleanVar&quot;, true);</span>
<span class="nc" id="L1626">        variables.put(&quot;nullVar&quot;, null);</span>
<span class="nc" id="L1627">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, variables);</span>

<span class="nc" id="L1629">        ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;longVar&quot;, null).variableValueEquals(&quot;shortVar&quot;, null)</span>
<span class="nc" id="L1630">                .variableValueEquals(&quot;integerVar&quot;, null)</span>
<span class="nc" id="L1631">                .variableValueEquals(&quot;stringVar&quot;, null).variableValueEquals(&quot;booleanVar&quot;, null).variableValueEquals(&quot;dateVar&quot;, null);</span>

<span class="nc" id="L1633">        ProcessInstanceQuery notQuery = runtimeService.createProcessInstanceQuery().variableValueNotEquals(&quot;longVar&quot;, null)</span>
<span class="nc" id="L1634">                .variableValueNotEquals(&quot;shortVar&quot;, null)</span>
<span class="nc" id="L1635">                .variableValueNotEquals(&quot;integerVar&quot;, null).variableValueNotEquals(&quot;stringVar&quot;, null).variableValueNotEquals(&quot;booleanVar&quot;, null)</span>
<span class="nc" id="L1636">                .variableValueNotEquals(&quot;dateVar&quot;, null);</span>

<span class="nc" id="L1638">        assertThat(query.singleResult()).isNull();</span>
<span class="nc" id="L1639">        assertThat(notQuery.singleResult()).isNotNull();</span>

        // Set all existing variables values to null
<span class="nc" id="L1642">        runtimeService.setVariable(processInstance.getId(), &quot;longVar&quot;, null);</span>
<span class="nc" id="L1643">        runtimeService.setVariable(processInstance.getId(), &quot;shortVar&quot;, null);</span>
<span class="nc" id="L1644">        runtimeService.setVariable(processInstance.getId(), &quot;integerVar&quot;, null);</span>
<span class="nc" id="L1645">        runtimeService.setVariable(processInstance.getId(), &quot;stringVar&quot;, null);</span>
<span class="nc" id="L1646">        runtimeService.setVariable(processInstance.getId(), &quot;dateVar&quot;, null);</span>
<span class="nc" id="L1647">        runtimeService.setVariable(processInstance.getId(), &quot;nullVar&quot;, null);</span>
<span class="nc" id="L1648">        runtimeService.setVariable(processInstance.getId(), &quot;booleanVar&quot;, null);</span>

<span class="nc" id="L1650">        Execution queryResult = query.singleResult();</span>
<span class="nc" id="L1651">        assertThat(queryResult).isNotNull();</span>
<span class="nc" id="L1652">        assertThat(queryResult.getId()).isEqualTo(processInstance.getId());</span>
<span class="nc" id="L1653">        assertThat(notQuery.singleResult()).isNull();</span>
<span class="nc" id="L1654">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryNullVariable() throws Exception {
<span class="nc" id="L1659">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1660">        vars.put(&quot;nullVar&quot;, null);</span>
<span class="nc" id="L1661">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1663">        vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1664">        vars.put(&quot;nullVar&quot;, &quot;notnull&quot;);</span>
<span class="nc" id="L1665">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1667">        vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1668">        vars.put(&quot;nullVarLong&quot;, &quot;notnull&quot;);</span>
<span class="nc" id="L1669">        ProcessInstance processInstance3 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1671">        vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1672">        vars.put(&quot;nullVarDouble&quot;, &quot;notnull&quot;);</span>
<span class="nc" id="L1673">        ProcessInstance processInstance4 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1675">        vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1676">        vars.put(&quot;nullVarByte&quot;, &quot;testbytes&quot;.getBytes());</span>
<span class="nc" id="L1677">        ProcessInstance processInstance5 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

        // Query on null value, should return one value
<span class="nc" id="L1680">        ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;nullVar&quot;, null);</span>
<span class="nc" id="L1681">        List&lt;ProcessInstance&gt; processInstances = query.list();</span>
<span class="nc" id="L1682">        assertThat(processInstances).isNotNull();</span>
<span class="nc" id="L1683">        assertThat(processInstances)</span>
<span class="nc" id="L1684">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L1685">                .containsExactly(processInstance1.getId());</span>

        // Test NOT_EQUALS null
<span class="nc" id="L1688">        assertThat(runtimeService.createProcessInstanceQuery().variableValueNotEquals(&quot;nullVar&quot;, null).count()).isEqualTo(1);</span>
<span class="nc" id="L1689">        assertThat(runtimeService.createProcessInstanceQuery().variableValueNotEquals(&quot;nullVarLong&quot;, null).count()).isEqualTo(1);</span>
<span class="nc" id="L1690">        assertThat(runtimeService.createProcessInstanceQuery().variableValueNotEquals(&quot;nullVarDouble&quot;, null).count()).isEqualTo(1);</span>
        // When a byte-array reference is present, the variable is not considered null
<span class="nc" id="L1692">        assertThat(runtimeService.createProcessInstanceQuery().variableValueNotEquals(&quot;nullVarByte&quot;, null).count()).isEqualTo(1);</span>

        // Test value-only
<span class="nc" id="L1695">        assertThat(runtimeService.createProcessInstanceQuery().variableValueEquals(null).count()).isEqualTo(1);</span>

        // All other variable queries with null should throw exception
<span class="nc" id="L1698">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueGreaterThan(&quot;nullVar&quot;, null))</span>
<span class="nc" id="L1699">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1700">                .hasMessage(&quot;Booleans and null cannot be used in 'greater than' condition&quot;);</span>

<span class="nc" id="L1702">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(&quot;nullVar&quot;, null))</span>
<span class="nc" id="L1703">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1704">                .hasMessage(&quot;Booleans and null cannot be used in 'greater than or equal' condition&quot;);</span>

<span class="nc" id="L1706">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueLessThan(&quot;nullVar&quot;, null))</span>
<span class="nc" id="L1707">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1708">                .hasMessage(&quot;Booleans and null cannot be used in 'less than' condition&quot;);</span>

<span class="nc" id="L1710">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueLessThanOrEqual(&quot;nullVar&quot;, null))</span>
<span class="nc" id="L1711">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1712">                .hasMessage(&quot;Booleans and null cannot be used in 'less than or equal' condition&quot;);</span>

<span class="nc" id="L1714">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueLike(&quot;nullVar&quot;, null))</span>
<span class="nc" id="L1715">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1716">                .hasMessage(&quot;Only string values can be used with 'like' condition&quot;);</span>

<span class="nc" id="L1718">        runtimeService.deleteProcessInstance(processInstance1.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1719">        runtimeService.deleteProcessInstance(processInstance2.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1720">        runtimeService.deleteProcessInstance(processInstance3.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1721">        runtimeService.deleteProcessInstance(processInstance4.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1722">        runtimeService.deleteProcessInstance(processInstance5.getId(), &quot;test&quot;);</span>

        // Test value-only, no more null-variables exist
<span class="nc" id="L1725">        assertThat(runtimeService.createProcessInstanceQuery().variableValueEquals(null).count()).isZero();</span>
<span class="nc" id="L1726">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryEqualsIgnoreCase() {
<span class="nc" id="L1731">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1732">        vars.put(&quot;mixed&quot;, &quot;AbCdEfG&quot;);</span>
<span class="nc" id="L1733">        vars.put(&quot;upper&quot;, &quot;ABCDEFG&quot;);</span>
<span class="nc" id="L1734">        vars.put(&quot;lower&quot;, &quot;abcdefg&quot;);</span>
<span class="nc" id="L1735">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1737">        ProcessInstance instance = runtimeService.createProcessInstanceQuery().variableValueEqualsIgnoreCase(&quot;mixed&quot;, &quot;abcdefg&quot;).singleResult();</span>
<span class="nc" id="L1738">        assertThat(instance).isNotNull();</span>
<span class="nc" id="L1739">        assertThat(instance.getId()).isEqualTo(processInstance1.getId());</span>

<span class="nc" id="L1741">        instance = runtimeService.createProcessInstanceQuery().variableValueEqualsIgnoreCase(&quot;lower&quot;, &quot;abcdefg&quot;).singleResult();</span>
<span class="nc" id="L1742">        assertThat(instance).isNotNull();</span>
<span class="nc" id="L1743">        assertThat(instance.getId()).isEqualTo(processInstance1.getId());</span>

<span class="nc" id="L1745">        instance = runtimeService.createProcessInstanceQuery().variableValueEqualsIgnoreCase(&quot;upper&quot;, &quot;abcdefg&quot;).singleResult();</span>
<span class="nc" id="L1746">        assertThat(instance).isNotNull();</span>
<span class="nc" id="L1747">        assertThat(instance.getId()).isEqualTo(processInstance1.getId());</span>

        // Pass in non-lower-case string
<span class="nc" id="L1750">        instance = runtimeService.createProcessInstanceQuery().variableValueEqualsIgnoreCase(&quot;upper&quot;, &quot;ABCdefg&quot;).singleResult();</span>
<span class="nc" id="L1751">        assertThat(instance).isNotNull();</span>
<span class="nc" id="L1752">        assertThat(instance.getId()).isEqualTo(processInstance1.getId());</span>

        // Pass in null-value, should cause exception
<span class="nc" id="L1755">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueEqualsIgnoreCase(&quot;upper&quot;, null).singleResult())</span>
<span class="nc" id="L1756">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1757">                .hasMessage(&quot;value is null&quot;);</span>

        // Pass in null name, should cause exception
<span class="nc" id="L1760">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueEqualsIgnoreCase(null, &quot;abcdefg&quot;).singleResult())</span>
<span class="nc" id="L1761">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1762">                .hasMessage(&quot;name is null&quot;);</span>

        // Test NOT equals
<span class="nc" id="L1765">        instance = runtimeService.createProcessInstanceQuery().variableValueNotEqualsIgnoreCase(&quot;upper&quot;, &quot;UIOP&quot;).singleResult();</span>
<span class="nc" id="L1766">        assertThat(instance).isNotNull();</span>

        // Should return result when using &quot;ABCdefg&quot; case-insensitive while
        // normal not-equals won't
<span class="nc" id="L1770">        instance = runtimeService.createProcessInstanceQuery().variableValueNotEqualsIgnoreCase(&quot;upper&quot;, &quot;ABCdefg&quot;).singleResult();</span>
<span class="nc" id="L1771">        assertThat(instance).isNull();</span>
<span class="nc" id="L1772">        instance = runtimeService.createProcessInstanceQuery().variableValueNotEquals(&quot;upper&quot;, &quot;ABCdefg&quot;).singleResult();</span>
<span class="nc" id="L1773">        assertThat(instance).isNotNull();</span>

        // Pass in null-value, should cause exception
<span class="nc" id="L1776">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueNotEqualsIgnoreCase(&quot;upper&quot;, null).singleResult())</span>
<span class="nc" id="L1777">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1778">                .hasMessage(&quot;value is null&quot;);</span>

        // Pass in null name, should cause exception
<span class="nc" id="L1781">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueNotEqualsIgnoreCase(null, &quot;abcdefg&quot;).singleResult())</span>
<span class="nc" id="L1782">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1783">                .hasMessage(&quot;name is null&quot;);</span>
<span class="nc" id="L1784">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryLikeIgnoreCase() {
<span class="nc" id="L1789">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1790">        vars.put(&quot;mixed&quot;, &quot;AbCdEfG&quot;);</span>
<span class="nc" id="L1791">        vars.put(&quot;upper&quot;, &quot;ABCDEFG&quot;);</span>
<span class="nc" id="L1792">        vars.put(&quot;lower&quot;, &quot;abcdefg&quot;);</span>
<span class="nc" id="L1793">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1795">        ProcessInstance instance = runtimeService.createProcessInstanceQuery().variableValueLikeIgnoreCase(&quot;mixed&quot;, &quot;abcd%&quot;).singleResult();</span>
<span class="nc" id="L1796">        assertThat(instance).isNotNull();</span>
<span class="nc" id="L1797">        assertThat(instance.getId()).isEqualTo(processInstance1.getId());</span>

<span class="nc" id="L1799">        instance = runtimeService.createProcessInstanceQuery().variableValueLikeIgnoreCase(&quot;lower&quot;, &quot;abcde%&quot;).singleResult();</span>
<span class="nc" id="L1800">        assertThat(instance).isNotNull();</span>
<span class="nc" id="L1801">        assertThat(instance.getId()).isEqualTo(processInstance1.getId());</span>

<span class="nc" id="L1803">        instance = runtimeService.createProcessInstanceQuery().variableValueLikeIgnoreCase(&quot;upper&quot;, &quot;abcd%&quot;).singleResult();</span>
<span class="nc" id="L1804">        assertThat(instance).isNotNull();</span>
<span class="nc" id="L1805">        assertThat(instance.getId()).isEqualTo(processInstance1.getId());</span>

        // Pass in non-lower-case string
<span class="nc" id="L1808">        instance = runtimeService.createProcessInstanceQuery().variableValueLikeIgnoreCase(&quot;upper&quot;, &quot;ABCde%&quot;).singleResult();</span>
<span class="nc" id="L1809">        assertThat(instance).isNotNull();</span>
<span class="nc" id="L1810">        assertThat(instance.getId()).isEqualTo(processInstance1.getId());</span>

        // Pass in null-value, should cause exception
<span class="nc" id="L1813">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueLikeIgnoreCase(&quot;upper&quot;, null).singleResult())</span>
<span class="nc" id="L1814">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1815">                .hasMessage(&quot;value is null&quot;);</span>

        // Pass in null name, should cause exception
<span class="nc" id="L1818">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueLikeIgnoreCase(null, &quot;abcdefg&quot;).singleResult())</span>
<span class="nc" id="L1819">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1820">                .hasMessage(&quot;name is null&quot;);</span>
<span class="nc" id="L1821">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryInvalidTypes() throws Exception {
<span class="nc" id="L1827">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1828">        vars.put(&quot;bytesVar&quot;, &quot;test&quot;.getBytes());</span>
<span class="nc" id="L1829">        vars.put(&quot;serializableVar&quot;, new DummySerializable());</span>

<span class="nc" id="L1831">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1833">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;bytesVar&quot;, &quot;test&quot;.getBytes()).list())</span>
<span class="nc" id="L1834">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1835">                .hasMessage(&quot;Variables of type ByteArray cannot be used to query&quot;);</span>

<span class="nc" id="L1837">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;serializableVar&quot;, new DummySerializable()).list())</span>
<span class="nc" id="L1838">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1839">                .hasMessage(&quot;Variables of type ByteArray cannot be used to query&quot;);</span>

<span class="nc" id="L1841">        runtimeService.deleteProcessInstance(processInstance.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1842">    }</span>

    @Test
    public void testQueryVariablesNullNameArgument() {
<span class="nc" id="L1846">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueEquals(null, &quot;value&quot;))</span>
<span class="nc" id="L1847">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1848">                .hasMessage(&quot;name is null&quot;);</span>
<span class="nc" id="L1849">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueNotEquals(null, &quot;value&quot;))</span>
<span class="nc" id="L1850">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1851">                .hasMessage(&quot;name is null&quot;);</span>
<span class="nc" id="L1852">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueGreaterThan(null, &quot;value&quot;))</span>
<span class="nc" id="L1853">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1854">                .hasMessage(&quot;name is null&quot;);</span>
<span class="nc" id="L1855">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueGreaterThanOrEqual(null, &quot;value&quot;))</span>
<span class="nc" id="L1856">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1857">                .hasMessage(&quot;name is null&quot;);</span>
<span class="nc" id="L1858">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueLessThan(null, &quot;value&quot;))</span>
<span class="nc" id="L1859">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1860">                .hasMessage(&quot;name is null&quot;);</span>
<span class="nc" id="L1861">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueLessThanOrEqual(null, &quot;value&quot;))</span>
<span class="nc" id="L1862">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1863">                .hasMessage(&quot;name is null&quot;);</span>
<span class="nc" id="L1864">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().variableValueLike(null, &quot;value&quot;))</span>
<span class="nc" id="L1865">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1866">                .hasMessage(&quot;name is null&quot;);</span>
<span class="nc" id="L1867">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryAllVariableTypes() throws Exception {
<span class="nc" id="L1872">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1873">        vars.put(&quot;nullVar&quot;, null);</span>
<span class="nc" id="L1874">        vars.put(&quot;stringVar&quot;, &quot;string&quot;);</span>
<span class="nc" id="L1875">        vars.put(&quot;longVar&quot;, 10L);</span>
<span class="nc" id="L1876">        vars.put(&quot;doubleVar&quot;, 1.2);</span>
<span class="nc" id="L1877">        vars.put(&quot;integerVar&quot;, 1234);</span>
<span class="nc" id="L1878">        vars.put(&quot;booleanVar&quot;, true);</span>
<span class="nc" id="L1879">        vars.put(&quot;shortVar&quot;, (short) 123);</span>

<span class="nc" id="L1881">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1883">        ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;nullVar&quot;, null).variableValueEquals(&quot;stringVar&quot;, &quot;string&quot;)</span>
<span class="nc" id="L1884">                .variableValueEquals(&quot;longVar&quot;, 10L)</span>
<span class="nc" id="L1885">                .variableValueEquals(&quot;doubleVar&quot;, 1.2).variableValueEquals(&quot;integerVar&quot;, 1234).variableValueEquals(&quot;booleanVar&quot;, true)</span>
<span class="nc" id="L1886">                .variableValueEquals(&quot;shortVar&quot;, (short) 123);</span>

<span class="nc" id="L1888">        List&lt;ProcessInstance&gt; processInstances = query.list();</span>
<span class="nc" id="L1889">        assertThat(processInstances).isNotNull();</span>
<span class="nc" id="L1890">        assertThat(processInstances)</span>
<span class="nc" id="L1891">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L1892">                .containsExactly(processInstance.getId());</span>

<span class="nc" id="L1894">        runtimeService.deleteProcessInstance(processInstance.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1895">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testClashingValues() throws Exception {
<span class="nc" id="L1900">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1901">        vars.put(&quot;var&quot;, 1234L);</span>

<span class="nc" id="L1903">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1905">        Map&lt;String, Object&gt; vars2 = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1906">        vars2.put(&quot;var&quot;, 1234);</span>

<span class="nc" id="L1908">        ProcessInstance processInstance2 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars2);</span>

<span class="nc" id="L1910">        List&lt;ProcessInstance&gt; foundInstances = runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L1911">                .variableValueEquals(&quot;var&quot;, 1234L).list();</span>

<span class="nc" id="L1913">        assertThat(foundInstances)</span>
<span class="nc" id="L1914">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L1915">                .containsExactly(processInstance.getId());</span>

<span class="nc" id="L1917">        runtimeService.deleteProcessInstance(processInstance.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1918">        runtimeService.deleteProcessInstance(processInstance2.getId(), &quot;test&quot;);</span>
<span class="nc" id="L1919">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testVariableExistsQuery() {
<span class="nc" id="L1924">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1925">        vars.put(&quot;mixed&quot;, &quot;AbCdEfG&quot;);</span>
<span class="nc" id="L1926">        vars.put(&quot;upper&quot;, &quot;ABCDEFG&quot;);</span>
<span class="nc" id="L1927">        vars.put(&quot;lower&quot;, &quot;abcdefg&quot;);</span>
<span class="nc" id="L1928">        ProcessInstance processInstance1 = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, vars);</span>

<span class="nc" id="L1930">        ProcessInstance instance = runtimeService.createProcessInstanceQuery().variableExists(&quot;mixed&quot;).singleResult();</span>
<span class="nc" id="L1931">        assertThat(instance).isNotNull();</span>
<span class="nc" id="L1932">        assertThat(instance.getId()).isEqualTo(processInstance1.getId());</span>

<span class="nc" id="L1934">        List&lt;ProcessInstance&gt; instances = runtimeService.createProcessInstanceQuery().variableNotExists(&quot;lower&quot;).list();</span>
<span class="nc" id="L1935">        assertThat(instances).hasSize(5);</span>

<span class="nc" id="L1937">        instances = runtimeService.createProcessInstanceQuery().variableExists(&quot;lower&quot;).variableValueEquals(&quot;upper&quot;, &quot;ABCDEFG&quot;).list();</span>
<span class="nc" id="L1938">        assertThat(instances).hasSize(1);</span>

<span class="nc" id="L1940">        instances = runtimeService.createProcessInstanceQuery().or().variableExists(&quot;mixed&quot;).variableValueEquals(&quot;upper&quot;, &quot;ABCDEFG&quot;).endOr().list();</span>
<span class="nc" id="L1941">        assertThat(instances).hasSize(1);</span>

<span class="nc" id="L1943">        instances = runtimeService.createProcessInstanceQuery().or().variableNotExists(&quot;mixed&quot;).variableValueEquals(&quot;upper&quot;, &quot;ABCDEFG&quot;).endOr().list();</span>
<span class="nc" id="L1944">        assertThat(instances).hasSize(6);</span>

<span class="nc" id="L1946">        instances = runtimeService.createProcessInstanceQuery().or().variableNotExists(&quot;mixed&quot;).endOr().or().variableValueEquals(&quot;upper&quot;, &quot;ABCDEFG&quot;).endOr()</span>
<span class="nc" id="L1947">                .list();</span>
<span class="nc" id="L1948">        assertThat(instances).isEmpty();</span>
<span class="nc" id="L1949">    }</span>

    @Test
    public void testQueryByProcessInstanceIds() {
<span class="nc" id="L1953">        Set&lt;String&gt; processInstanceIds = new HashSet&lt;&gt;(this.processInstanceIds);</span>

        // start an instance that will not be part of the query
<span class="nc" id="L1956">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess2&quot;, &quot;2&quot;);</span>

<span class="nc" id="L1958">        ProcessInstanceQuery processInstanceQuery = runtimeService.createProcessInstanceQuery().processInstanceIds(processInstanceIds);</span>
<span class="nc" id="L1959">        assertThat(processInstanceQuery.count()).isEqualTo(5);</span>

<span class="nc" id="L1961">        List&lt;ProcessInstance&gt; processInstances = processInstanceQuery.list();</span>
<span class="nc" id="L1962">        assertThat(processInstances).hasSize(5);</span>

<span class="nc bnc" id="L1964" title="All 2 branches missed.">        for (ProcessInstance processInstance : processInstances) {</span>
<span class="nc" id="L1965">            assertThat(processInstanceIds).contains(processInstance.getId());</span>
<span class="nc" id="L1966">        }</span>
<span class="nc" id="L1967">    }</span>

    @Test
    public void testQueryByProcessInstanceIdsEmpty() {
<span class="nc" id="L1971">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().processInstanceIds(new HashSet&lt;&gt;()))</span>
<span class="nc" id="L1972">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1973">                .hasMessage(&quot;Set of process instance ids is empty&quot;);</span>
<span class="nc" id="L1974">    }</span>

    @Test
    public void testQueryByProcessInstanceIdsNull() {
<span class="nc" id="L1978">        assertThatThrownBy(() -&gt; runtimeService.createProcessInstanceQuery().processInstanceIds(null))</span>
<span class="nc" id="L1979">                .isExactlyInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L1980">                .hasMessage(&quot;Set of process instance ids is null&quot;);</span>
<span class="nc" id="L1981">    }</span>

    @Test
    public void testNativeQuery() {
        // just test that the query will be constructed and executed, details
        // are tested in the TaskQueryTest
<span class="nc" id="L1987">        assertThat(managementService.getTableName(ProcessInstance.class, false)).isEqualTo(&quot;ACT_RU_EXECUTION&quot;);</span>

<span class="nc" id="L1989">        long piCount = runtimeService.createProcessInstanceQuery().count();</span>

        // There are 2 executions for each process instance
<span class="nc" id="L1992">        assertThat(runtimeService.createNativeProcessInstanceQuery().sql(&quot;SELECT * FROM &quot; + managementService.getTableName(ProcessInstance.class)).list())</span>
<span class="nc" id="L1993">                .hasSize((int) piCount * 2);</span>
<span class="nc" id="L1994">        assertThat(</span>
<span class="nc" id="L1995">                runtimeService.createNativeProcessInstanceQuery().sql(&quot;SELECT count(*) FROM &quot; + managementService.getTableName(ProcessInstance.class)).count())</span>
<span class="nc" id="L1996">                .isEqualTo(piCount * 2);</span>
<span class="nc" id="L1997">    }</span>

    /**
     * Test confirming fix for ACT-1731
     */
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testIncludeBinaryVariables() throws Exception {
        // Start process with a binary variable
<span class="nc" id="L2006">        ProcessInstance processInstance = runtimeService</span>
<span class="nc" id="L2007">                .startProcessInstanceByKey(&quot;oneTaskProcess&quot;, Collections.singletonMap(&quot;binaryVariable&quot;, (Object) &quot;It is I, le binary&quot;.getBytes()));</span>

<span class="nc" id="L2009">        processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).includeProcessVariables().singleResult();</span>
<span class="nc" id="L2010">        assertThat(processInstance).isNotNull();</span>
        // Query process, including variables
<span class="nc" id="L2012">        byte[] bytes = (byte[]) processInstance.getProcessVariables().get(&quot;binaryVariable&quot;);</span>
<span class="nc" id="L2013">        assertThat(new String(bytes)).isEqualTo(&quot;It is I, le binary&quot;);</span>
<span class="nc" id="L2014">    }</span>

    @Test
    public void testNativeQueryPaging() {
<span class="nc" id="L2018">        assertThat(</span>
<span class="nc" id="L2019">                runtimeService.createNativeProcessInstanceQuery().sql(&quot;SELECT * FROM &quot; + managementService.getTableName(ProcessInstance.class)).listPage(0, 5))</span>
<span class="nc" id="L2020">                .hasSize(5);</span>
<span class="nc" id="L2021">    }</span>

    @Test
    public void testLocalizeProcess() throws Exception {
<span class="nc" id="L2025">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L2027">        List&lt;ProcessInstance&gt; processes = runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2028">        assertThat(processes)</span>
<span class="nc" id="L2029">                .extracting(ProcessInstance::getName, ProcessInstance::getDescription)</span>
<span class="nc" id="L2030">                .containsExactly(tuple(null, null));</span>

<span class="nc" id="L2032">        ObjectNode infoNode = dynamicBpmnService.getProcessDefinitionInfo(processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L2033">        dynamicBpmnService.changeLocalizationName(&quot;en-GB&quot;, &quot;oneTaskProcess&quot;, &quot;The One org.flowable.task.service.Task Process 'en-GB' localized name&quot;, infoNode);</span>
<span class="nc" id="L2034">        dynamicBpmnService</span>
<span class="nc" id="L2035">                .changeLocalizationDescription(&quot;en-GB&quot;, &quot;oneTaskProcess&quot;, &quot;The One org.flowable.task.service.Task Process 'en-GB' localized description&quot;,</span>
                        infoNode);
<span class="nc" id="L2037">        dynamicBpmnService.saveProcessDefinitionInfo(processInstance.getProcessDefinitionId(), infoNode);</span>

<span class="nc" id="L2039">        dynamicBpmnService.changeLocalizationName(&quot;en&quot;, &quot;oneTaskProcess&quot;, &quot;The One org.flowable.task.service.Task Process 'en' localized name&quot;, infoNode);</span>
<span class="nc" id="L2040">        dynamicBpmnService</span>
<span class="nc" id="L2041">                .changeLocalizationDescription(&quot;en&quot;, &quot;oneTaskProcess&quot;, &quot;The One org.flowable.task.service.Task Process 'en' localized description&quot;, infoNode);</span>
<span class="nc" id="L2042">        dynamicBpmnService.saveProcessDefinitionInfo(processInstance.getProcessDefinitionId(), infoNode);</span>

<span class="nc" id="L2044">        processes = runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L2045">        assertThat(processes)</span>
<span class="nc" id="L2046">                .extracting(ProcessInstance::getName, ProcessInstance::getDescription)</span>
<span class="nc" id="L2047">                .containsExactly(tuple(null, null));</span>

<span class="nc" id="L2049">        processes = runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).locale(&quot;es&quot;).list();</span>
<span class="nc" id="L2050">        assertThat(processes)</span>
<span class="nc" id="L2051">                .extracting(ProcessInstance::getName, ProcessInstance::getDescription)</span>
<span class="nc" id="L2052">                .containsExactly(tuple(&quot;Nombre del proceso&quot;, &quot;Descripción del proceso&quot;));</span>

<span class="nc" id="L2054">        processes = runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).locale(&quot;en-GB&quot;).list();</span>
<span class="nc" id="L2055">        assertThat(processes)</span>
<span class="nc" id="L2056">                .extracting(ProcessInstance::getName, ProcessInstance::getDescription)</span>
<span class="nc" id="L2057">                .containsExactly(tuple(&quot;The One org.flowable.task.service.Task Process 'en-GB' localized name&quot;,</span>
                        &quot;The One org.flowable.task.service.Task Process 'en-GB' localized description&quot;));

<span class="nc" id="L2060">        processes = runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).listPage(0, 10);</span>
<span class="nc" id="L2061">        assertThat(processes)</span>
<span class="nc" id="L2062">                .extracting(ProcessInstance::getName, ProcessInstance::getDescription)</span>
<span class="nc" id="L2063">                .containsExactly(tuple(null, null));</span>

<span class="nc" id="L2065">        processes = runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).locale(&quot;es&quot;).listPage(0, 10);</span>
<span class="nc" id="L2066">        assertThat(processes)</span>
<span class="nc" id="L2067">                .extracting(ProcessInstance::getName, ProcessInstance::getDescription)</span>
<span class="nc" id="L2068">                .containsExactly(tuple(&quot;Nombre del proceso&quot;, &quot;Descripción del proceso&quot;));</span>

<span class="nc" id="L2070">        processes = runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).locale(&quot;en-GB&quot;).listPage(0, 10);</span>
<span class="nc" id="L2071">        assertThat(processes)</span>
<span class="nc" id="L2072">                .extracting(ProcessInstance::getName, ProcessInstance::getDescription)</span>
<span class="nc" id="L2073">                .containsExactly(tuple(&quot;The One org.flowable.task.service.Task Process 'en-GB' localized name&quot;,</span>
                        &quot;The One org.flowable.task.service.Task Process 'en-GB' localized description&quot;));

<span class="nc" id="L2076">        processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2077">        assertThat(processInstance.getName()).isNull();</span>
<span class="nc" id="L2078">        assertThat(processInstance.getDescription()).isNull();</span>

<span class="nc" id="L2080">        processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).locale(&quot;es&quot;).singleResult();</span>
<span class="nc" id="L2081">        assertThat(processInstance.getName()).isEqualTo(&quot;Nombre del proceso&quot;);</span>
<span class="nc" id="L2082">        assertThat(processInstance.getDescription()).isEqualTo(&quot;Descripción del proceso&quot;);</span>

<span class="nc" id="L2084">        processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).locale(&quot;en-GB&quot;).singleResult();</span>
<span class="nc" id="L2085">        assertThat(processInstance.getName()).isEqualTo(&quot;The One org.flowable.task.service.Task Process 'en-GB' localized name&quot;);</span>
<span class="nc" id="L2086">        assertThat(processInstance.getDescription()).isEqualTo(&quot;The One org.flowable.task.service.Task Process 'en-GB' localized description&quot;);</span>

<span class="nc" id="L2088">        processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L2089">        assertThat(processInstance.getName()).isNull();</span>
<span class="nc" id="L2090">        assertThat(processInstance.getDescription()).isNull();</span>

<span class="nc" id="L2092">        processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).locale(&quot;en&quot;).singleResult();</span>
<span class="nc" id="L2093">        assertThat(processInstance.getName()).isEqualTo(&quot;The One org.flowable.task.service.Task Process 'en' localized name&quot;);</span>
<span class="nc" id="L2094">        assertThat(processInstance.getDescription()).isEqualTo(&quot;The One org.flowable.task.service.Task Process 'en' localized description&quot;);</span>

<span class="nc" id="L2096">        processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).locale(&quot;en-AU&quot;).withLocalizationFallback()</span>
<span class="nc" id="L2097">                .singleResult();</span>
<span class="nc" id="L2098">        assertThat(processInstance.getName()).isEqualTo(&quot;The One org.flowable.task.service.Task Process 'en' localized name&quot;);</span>
<span class="nc" id="L2099">        assertThat(processInstance.getDescription()).isEqualTo(&quot;The One org.flowable.task.service.Task Process 'en' localized description&quot;);</span>
<span class="nc" id="L2100">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryStartedBefore() throws Exception {
<span class="nc" id="L2105">        Calendar calendar = new GregorianCalendar();</span>
<span class="nc" id="L2106">        calendar.set(Calendar.YEAR, 2010);</span>
<span class="nc" id="L2107">        calendar.set(Calendar.MONTH, 8);</span>
<span class="nc" id="L2108">        calendar.set(Calendar.DAY_OF_MONTH, 30);</span>
<span class="nc" id="L2109">        calendar.set(Calendar.HOUR_OF_DAY, 12);</span>
<span class="nc" id="L2110">        calendar.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L2111">        calendar.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L2112">        calendar.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L2113">        Date noon = calendar.getTime();</span>

<span class="nc" id="L2115">        processEngineConfiguration.getClock().setCurrentTime(noon);</span>

<span class="nc" id="L2117">        calendar.add(Calendar.HOUR_OF_DAY, 1);</span>
<span class="nc" id="L2118">        Date hourLater = calendar.getTime();</span>

<span class="nc" id="L2120">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L2122">        List&lt;ProcessInstance&gt; processInstances = runtimeService.createProcessInstanceQuery().startedBefore(hourLater).list();</span>

<span class="nc" id="L2124">        assertThat(processInstances).hasSize(1);</span>
<span class="nc" id="L2125">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryStartedAfter() throws Exception {
<span class="nc" id="L2130">        Calendar calendar = new GregorianCalendar();</span>
<span class="nc" id="L2131">        calendar.set(Calendar.YEAR, 2030);</span>
<span class="nc" id="L2132">        calendar.set(Calendar.MONTH, 8);</span>
<span class="nc" id="L2133">        calendar.set(Calendar.DAY_OF_MONTH, 30);</span>
<span class="nc" id="L2134">        calendar.set(Calendar.HOUR_OF_DAY, 12);</span>
<span class="nc" id="L2135">        calendar.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L2136">        calendar.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L2137">        calendar.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L2138">        Date noon = calendar.getTime();</span>

<span class="nc" id="L2140">        processEngineConfiguration.getClock().setCurrentTime(noon);</span>

<span class="nc" id="L2142">        calendar.add(Calendar.HOUR_OF_DAY, -1);</span>
<span class="nc" id="L2143">        Date hourEarlier = calendar.getTime();</span>

<span class="nc" id="L2145">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L2147">        List&lt;ProcessInstance&gt; processInstances = runtimeService.createProcessInstanceQuery().startedAfter(hourEarlier).list();</span>

<span class="nc" id="L2149">        assertThat(processInstances).hasSize(1);</span>
<span class="nc" id="L2150">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryStartedBy() throws Exception {
<span class="nc" id="L2155">        final String authenticatedUser = &quot;user1&quot;;</span>
<span class="nc" id="L2156">        identityService.setAuthenticatedUserId(authenticatedUser);</span>
<span class="nc" id="L2157">        runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>

<span class="nc" id="L2159">        List&lt;ProcessInstance&gt; processInstances = runtimeService.createProcessInstanceQuery().startedBy(authenticatedUser).list();</span>

<span class="nc" id="L2161">        assertThat(processInstances).hasSize(1);</span>
<span class="nc" id="L2162">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryOrderedByStartTime() throws Exception {
<span class="nc" id="L2167">        Instant now = Instant.now();</span>

<span class="nc" id="L2169">        processEngineConfiguration.getClock().setCurrentTime(Date.from(now));</span>
<span class="nc" id="L2170">        String nowInstanceId = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, &quot;now&quot;).getId();</span>

<span class="nc" id="L2172">        processEngineConfiguration.getClock().setCurrentTime(Date.from(now.minus(1, ChronoUnit.HOURS)));</span>
<span class="nc" id="L2173">        String nowMinus1InstanceId = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, &quot;now&quot;).getId();</span>

<span class="nc" id="L2175">        processEngineConfiguration.getClock().setCurrentTime(Date.from(now.plus(1, ChronoUnit.HOURS)));</span>
<span class="nc" id="L2176">        String nowPlus1InstanceId = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, &quot;now&quot;).getId();</span>

<span class="nc" id="L2178">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessKey(&quot;now&quot;).orderByStartTime().asc().list())</span>
<span class="nc" id="L2179">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L2180">                .as(&quot;ascending order by startTime&quot;)</span>
<span class="nc" id="L2181">                .containsExactly(nowMinus1InstanceId, nowInstanceId, nowPlus1InstanceId);</span>

<span class="nc" id="L2183">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceBusinessKey(&quot;now&quot;).orderByStartTime().desc().list())</span>
<span class="nc" id="L2184">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L2185">                .as(&quot;descending order by startTime&quot;)</span>
<span class="nc" id="L2186">                .containsExactly(nowPlus1InstanceId, nowInstanceId, nowMinus1InstanceId);</span>
<span class="nc" id="L2187">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryByInvalidCallbackId() {
<span class="nc" id="L2192">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, &quot;now&quot;).getId();</span>
<span class="nc" id="L2193">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(processInstanceId).processInstanceCallbackId(&quot;foo&quot;).list()).isNullOrEmpty();</span>
<span class="nc" id="L2194">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryByInvalidCallbackType() {
<span class="nc" id="L2199">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, &quot;now&quot;).getId();</span>
<span class="nc" id="L2200">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(processInstanceId).processInstanceCallbackType(&quot;foo&quot;).list()).isNullOrEmpty();</span>
<span class="nc" id="L2201">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryByReferenceId() {
<span class="nc" id="L2206">        String processInstanceId = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L2207">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L2208">                .referenceId(&quot;testReferenceId&quot;)</span>
<span class="nc" id="L2209">                .start()</span>
<span class="nc" id="L2210">                .getId();</span>

<span class="nc" id="L2212">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceReferenceId(&quot;testReferenceId&quot;).list())</span>
<span class="nc" id="L2213">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L2214">                .containsExactly(processInstanceId);</span>
<span class="nc" id="L2215">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryByInvalidReferenceId() {
<span class="nc" id="L2220">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, &quot;now&quot;).getId();</span>
<span class="nc" id="L2221">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(processInstanceId).processInstanceReferenceId(&quot;foo&quot;).list()).isNullOrEmpty();</span>
<span class="nc" id="L2222">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryByReferenceType() {
<span class="nc" id="L2227">        String processInstanceId = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L2228">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L2229">                .referenceType(&quot;testReferenceType&quot;)</span>
<span class="nc" id="L2230">                .start()</span>
<span class="nc" id="L2231">                .getId();</span>

<span class="nc" id="L2233">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceReferenceType(&quot;testReferenceType&quot;).list())</span>
<span class="nc" id="L2234">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L2235">                .containsExactly(processInstanceId);</span>
<span class="nc" id="L2236">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryByInvalidReferenceType() {
<span class="nc" id="L2241">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;, &quot;now&quot;).getId();</span>
<span class="nc" id="L2242">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(processInstanceId).processInstanceReferenceType(&quot;foo&quot;).list()).isNullOrEmpty();</span>
<span class="nc" id="L2243">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryByReferenceIdAndType() {
<span class="nc" id="L2248">        String[] processInstanceIds = new String[6];</span>
<span class="nc bnc" id="L2249" title="All 2 branches missed.">        for (int i = 0; i &lt; processInstanceIds.length; i++) {</span>
<span class="nc" id="L2250">            String processInstanceId = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L2251">                    .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L2252">                    .referenceId(&quot;testReferenceId&quot;)</span>
<span class="nc" id="L2253">                    .referenceType(&quot;testReferenceType&quot;)</span>
<span class="nc" id="L2254">                    .start()</span>
<span class="nc" id="L2255">                    .getId();</span>
<span class="nc" id="L2256">            processInstanceIds[i] = processInstanceId;</span>
        }

<span class="nc" id="L2259">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceReferenceId(&quot;testReferenceId&quot;).processInstanceReferenceType(&quot;testReferenceType&quot;)</span>
<span class="nc" id="L2260">                .list())</span>
<span class="nc" id="L2261">                .extracting(ProcessInstance::getId)</span>
<span class="nc" id="L2262">                .containsExactly(processInstanceIds);</span>
<span class="nc" id="L2263">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot; })
    public void testQueryVariableValueEqualsAndNotEquals() {
<span class="nc" id="L2268">        ProcessInstance processWithStringValue = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L2269">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L2270">                .name(&quot;With string value&quot;)</span>
<span class="nc" id="L2271">                .variable(&quot;var&quot;, &quot;TEST&quot;)</span>
<span class="nc" id="L2272">                .start();</span>

<span class="nc" id="L2274">        ProcessInstance processWithNullValue = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L2275">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L2276">                .name(&quot;With null value&quot;)</span>
<span class="nc" id="L2277">                .variable(&quot;var&quot;, null)</span>
<span class="nc" id="L2278">                .start();</span>

<span class="nc" id="L2280">        ProcessInstance processWithLongValue = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L2281">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L2282">                .name(&quot;With long value&quot;)</span>
<span class="nc" id="L2283">                .variable(&quot;var&quot;, 100L)</span>
<span class="nc" id="L2284">                .start();</span>

<span class="nc" id="L2286">        ProcessInstance processWithDoubleValue = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L2287">                .processDefinitionKey(&quot;oneTaskProcess&quot;)</span>
<span class="nc" id="L2288">                .name(&quot;With double value&quot;)</span>
<span class="nc" id="L2289">                .variable(&quot;var&quot;, 45.55)</span>
<span class="nc" id="L2290">                .start();</span>

<span class="nc" id="L2292">        assertThat(runtimeService.createProcessInstanceQuery().variableValueNotEquals(&quot;var&quot;, &quot;TEST&quot;).list())</span>
<span class="nc" id="L2293">                .extracting(ProcessInstance::getName, ProcessInstance::getId)</span>
<span class="nc" id="L2294">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2295">                        tuple(&quot;With null value&quot;, processWithNullValue.getId()),</span>
<span class="nc" id="L2296">                        tuple(&quot;With long value&quot;, processWithLongValue.getId()),</span>
<span class="nc" id="L2297">                        tuple(&quot;With double value&quot;, processWithDoubleValue.getId())</span>
                );

<span class="nc" id="L2300">        assertThat(runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;var&quot;, &quot;TEST&quot;).list())</span>
<span class="nc" id="L2301">                .extracting(ProcessInstance::getName, ProcessInstance::getId)</span>
<span class="nc" id="L2302">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2303">                        tuple(&quot;With string value&quot;, processWithStringValue.getId())</span>
                );

<span class="nc" id="L2306">        assertThat(runtimeService.createProcessInstanceQuery().variableValueNotEquals(&quot;var&quot;, 100L).list())</span>
<span class="nc" id="L2307">                .extracting(ProcessInstance::getName, ProcessInstance::getId)</span>
<span class="nc" id="L2308">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2309">                        tuple(&quot;With string value&quot;, processWithStringValue.getId()),</span>
<span class="nc" id="L2310">                        tuple(&quot;With null value&quot;, processWithNullValue.getId()),</span>
<span class="nc" id="L2311">                        tuple(&quot;With double value&quot;, processWithDoubleValue.getId())</span>
                );

<span class="nc" id="L2314">        assertThat(runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;var&quot;, 100L).list())</span>
<span class="nc" id="L2315">                .extracting(ProcessInstance::getName, ProcessInstance::getId)</span>
<span class="nc" id="L2316">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2317">                        tuple(&quot;With long value&quot;, processWithLongValue.getId())</span>
                );

<span class="nc" id="L2320">        assertThat(runtimeService.createProcessInstanceQuery().variableValueNotEquals(&quot;var&quot;, 45.55).list())</span>
<span class="nc" id="L2321">                .extracting(ProcessInstance::getName, ProcessInstance::getId)</span>
<span class="nc" id="L2322">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2323">                        tuple(&quot;With string value&quot;, processWithStringValue.getId()),</span>
<span class="nc" id="L2324">                        tuple(&quot;With null value&quot;, processWithNullValue.getId()),</span>
<span class="nc" id="L2325">                        tuple(&quot;With long value&quot;, processWithLongValue.getId())</span>
                );

<span class="nc" id="L2328">        assertThat(runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;var&quot;, 45.55).list())</span>
<span class="nc" id="L2329">                .extracting(ProcessInstance::getName, ProcessInstance::getId)</span>
<span class="nc" id="L2330">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2331">                        tuple(&quot;With double value&quot;, processWithDoubleValue.getId())</span>
                );

<span class="nc" id="L2334">        assertThat(runtimeService.createProcessInstanceQuery().variableValueNotEquals(&quot;var&quot;, &quot;test&quot;).list())</span>
<span class="nc" id="L2335">                .extracting(ProcessInstance::getName, ProcessInstance::getId)</span>
<span class="nc" id="L2336">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2337">                        tuple(&quot;With string value&quot;, processWithStringValue.getId()),</span>
<span class="nc" id="L2338">                        tuple(&quot;With null value&quot;, processWithNullValue.getId()),</span>
<span class="nc" id="L2339">                        tuple(&quot;With long value&quot;, processWithLongValue.getId()),</span>
<span class="nc" id="L2340">                        tuple(&quot;With double value&quot;, processWithDoubleValue.getId())</span>
                );

<span class="nc" id="L2343">        assertThat(runtimeService.createProcessInstanceQuery().variableValueNotEqualsIgnoreCase(&quot;var&quot;, &quot;test&quot;).list())</span>
<span class="nc" id="L2344">                .extracting(ProcessInstance::getName, ProcessInstance::getId)</span>
<span class="nc" id="L2345">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2346">                        tuple(&quot;With null value&quot;, processWithNullValue.getId()),</span>
<span class="nc" id="L2347">                        tuple(&quot;With long value&quot;, processWithLongValue.getId()),</span>
<span class="nc" id="L2348">                        tuple(&quot;With double value&quot;, processWithDoubleValue.getId())</span>
                );

<span class="nc" id="L2351">        assertThat(runtimeService.createProcessInstanceQuery().variableValueEquals(&quot;var&quot;, &quot;test&quot;).list())</span>
<span class="nc" id="L2352">                .extracting(ProcessInstance::getName, ProcessInstance::getId)</span>
<span class="nc" id="L2353">                .isEmpty();</span>

<span class="nc" id="L2355">        assertThat(runtimeService.createProcessInstanceQuery().variableValueEqualsIgnoreCase(&quot;var&quot;, &quot;test&quot;).list())</span>
<span class="nc" id="L2356">                .extracting(ProcessInstance::getName, ProcessInstance::getId)</span>
<span class="nc" id="L2357">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2358">                        tuple(&quot;With string value&quot;, processWithStringValue.getId())</span>
                );
<span class="nc" id="L2360">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/simpleParallelCallActivity.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/simpleInnerCallActivity.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/simpleProcessWithUserTasks.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot;
    })
    public void testQueryByRootScopeId() {
<span class="nc" id="L2370">        runtimeService.startProcessInstanceByKey(&quot;simpleParallelCallActivity&quot;);</span>
<span class="nc" id="L2371">        List&lt;String&gt; validationList = runtimeService.createProcessInstanceQuery().list().stream().map(ProcessInstance::getId).toList();</span>

<span class="nc" id="L2373">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;simpleParallelCallActivity&quot;);</span>

<span class="nc" id="L2375">        ActivityInstance firstLevelCallActivity1 = runtimeService.createActivityInstanceQuery()</span>
<span class="nc" id="L2376">                .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2377">                .activityId(&quot;callActivity1&quot;).singleResult();</span>

<span class="nc" id="L2379">        ActivityInstance secondLevelCallActivity1_1 = runtimeService.createActivityInstanceQuery()</span>
<span class="nc" id="L2380">                .processInstanceId(firstLevelCallActivity1.getCalledProcessInstanceId())</span>
<span class="nc" id="L2381">                .activityId(&quot;callActivity1&quot;).singleResult();</span>

<span class="nc" id="L2383">        ActivityInstance thirdLevelCallActivity1_1_1 = runtimeService.createActivityInstanceQuery()</span>
<span class="nc" id="L2384">                .processInstanceId(secondLevelCallActivity1_1.getCalledProcessInstanceId())</span>
<span class="nc" id="L2385">                .activityId(&quot;callActivity1&quot;).singleResult();</span>

<span class="nc" id="L2387">        ActivityInstance secondLevelCallActivity1_2 = runtimeService.createActivityInstanceQuery()</span>
<span class="nc" id="L2388">                .processInstanceId(firstLevelCallActivity1.getCalledProcessInstanceId())</span>
<span class="nc" id="L2389">                .activityId(&quot;callActivity2&quot;).singleResult();</span>

<span class="nc" id="L2391">        ActivityInstance firstLevelCallActivity2 = runtimeService.createActivityInstanceQuery().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2392">                .activityId(&quot;callActivity2&quot;).singleResult();</span>

<span class="nc" id="L2394">        List&lt;ProcessInstance&gt; result = runtimeService.createProcessInstanceQuery().processInstanceRootScopeId(processInstance.getId()).list();</span>

<span class="nc" id="L2396">        assertThat(result)</span>
<span class="nc" id="L2397">                .extracting(ProcessInstance::getId, ProcessInstance::getProcessDefinitionKey)</span>
<span class="nc" id="L2398">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2399">                        tuple(firstLevelCallActivity1.getCalledProcessInstanceId(), &quot;simpleInnerParallelCallActivity&quot;),</span>
<span class="nc" id="L2400">                        tuple(secondLevelCallActivity1_1.getCalledProcessInstanceId(), &quot;simpleProcessWithUserTaskAndCallActivity&quot;),</span>
<span class="nc" id="L2401">                        tuple(thirdLevelCallActivity1_1_1.getCalledProcessInstanceId(), &quot;oneTaskProcess&quot;),</span>
<span class="nc" id="L2402">                        tuple(secondLevelCallActivity1_2.getCalledProcessInstanceId(), &quot;oneTaskProcess&quot;),</span>
<span class="nc" id="L2403">                        tuple(firstLevelCallActivity2.getCalledProcessInstanceId(), &quot;oneTaskProcess&quot;)</span>
                );

<span class="nc" id="L2406">        assertThat(result).extracting(ProcessInstance::getId).doesNotContainAnyElementsOf(validationList);</span>
<span class="nc" id="L2407">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/engine/test/api/simpleParallelCallActivity.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/simpleInnerCallActivity.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/simpleProcessWithUserTasks.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/api/oneTaskProcess.bpmn20.xml&quot;
    })
    public void testQueryByParentScopeId() {
<span class="nc" id="L2417">        ProcessInstance validationProcessInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L2418">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;simpleParallelCallActivity&quot;);</span>

<span class="nc" id="L2420">        List&lt;ProcessInstance&gt; result = runtimeService.createProcessInstanceQuery().processInstanceParentScopeId(processInstance.getId()).list();</span>
<span class="nc" id="L2421">        assertThat(result).isEmpty();</span>

<span class="nc" id="L2423">        assertThat(result).extracting(ProcessInstance::getId).doesNotContain(</span>
<span class="nc" id="L2424">                validationProcessInstance.getId()</span>
        );

<span class="nc" id="L2427">        ActivityInstance firstLevelCallActivity1 = runtimeService.createActivityInstanceQuery().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L2428">                .activityId(&quot;callActivity1&quot;).singleResult();</span>

<span class="nc" id="L2430">        ActivityInstance secondLevelCallActivity1 = runtimeService.createActivityInstanceQuery()</span>
<span class="nc" id="L2431">                .processInstanceId(firstLevelCallActivity1.getCalledProcessInstanceId())</span>
<span class="nc" id="L2432">                .activityId(&quot;callActivity1&quot;).singleResult();</span>
<span class="nc" id="L2433">        ActivityInstance secondLevelCallActivity2 = runtimeService.createActivityInstanceQuery()</span>
<span class="nc" id="L2434">                .processInstanceId(firstLevelCallActivity1.getCalledProcessInstanceId())</span>
<span class="nc" id="L2435">                .activityId(&quot;callActivity2&quot;).singleResult();</span>

<span class="nc" id="L2437">        result = runtimeService.createProcessInstanceQuery().processInstanceParentScopeId(firstLevelCallActivity1.getCalledProcessInstanceId()).list();</span>

<span class="nc" id="L2439">        assertThat(result)</span>
<span class="nc" id="L2440">                .extracting(ProcessInstance::getId, ProcessInstance::getProcessDefinitionKey)</span>
<span class="nc" id="L2441">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L2442">                        tuple(secondLevelCallActivity1.getCalledProcessInstanceId(), &quot;simpleProcessWithUserTaskAndCallActivity&quot;),</span>
<span class="nc" id="L2443">                        tuple(secondLevelCallActivity2.getCalledProcessInstanceId(), &quot;oneTaskProcess&quot;)</span>
                );

<span class="nc" id="L2446">        assertThat(result).extracting(ProcessInstance::getId).doesNotContain(</span>
<span class="nc" id="L2447">                validationProcessInstance.getId()</span>
        );
<span class="nc" id="L2449">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>