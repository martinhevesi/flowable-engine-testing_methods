<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PlanItemInjectionTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.cmmn.test.runtime</a> &gt; <span class="el_source">PlanItemInjectionTest.java</span></div><h1>PlanItemInjectionTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.cmmn.test.runtime;

import static org.assertj.core.api.Assertions.assertThat;
import static org.flowable.cmmn.api.runtime.PlanItemInstanceState.ACTIVE;
import static org.flowable.cmmn.api.runtime.PlanItemInstanceState.AVAILABLE;

import java.util.List;

import org.flowable.cmmn.api.history.HistoricPlanItemInstance;
import org.flowable.cmmn.api.repository.CaseDefinition;
import org.flowable.cmmn.api.runtime.CaseInstance;
import org.flowable.cmmn.api.runtime.PlanItemInstance;
import org.flowable.cmmn.engine.CmmnEngineConfiguration;
import org.flowable.cmmn.engine.impl.deployer.CmmnDeploymentManager;
import org.flowable.cmmn.engine.impl.persistence.entity.deploy.CaseDefinitionCacheEntry;
import org.flowable.cmmn.engine.test.CmmnDeployment;
import org.flowable.cmmn.engine.test.FlowableCmmnTestCase;
import org.flowable.cmmn.engine.test.impl.CmmnHistoryTestHelper;
import org.flowable.cmmn.engine.test.impl.CmmnTestRunner;
import org.flowable.cmmn.model.Case;
import org.flowable.cmmn.model.CaseElement;
import org.flowable.cmmn.model.CmmnModel;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.task.api.Task;
import org.junit.Test;

/**
 * Testing dynamic injection of a new plan item at runtime.
 *
 * @author Micha Kiener
 */
<span class="nc" id="L44">public class PlanItemInjectionTest extends FlowableCmmnTestCase {</span>

    protected CmmnDeploymentManager deploymentManager;

    @Test
    @CmmnDeployment
    public void testDynamicPlanItemInjection() {
<span class="nc" id="L51">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;dynamicPlanItemInjection&quot;).start();</span>

<span class="nc" id="L53">        List&lt;PlanItemInstance&gt; planItemInstances = getPlanItemInstances(caseInstance.getId());</span>

<span class="nc" id="L55">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L56">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L57">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L58">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>

        // inject new plan item into Stage A
<span class="nc" id="L61">        PlanItemInstance injectedTask = dynamicCmmnService</span>
<span class="nc" id="L62">                .createInjectedPlanItemInstanceBuilder()</span>
<span class="nc" id="L63">                .name(&quot;Injected Task A&quot;)</span>
<span class="nc" id="L64">                .caseDefinitionId(caseInstance.getCaseDefinitionId())</span>
<span class="nc" id="L65">                .elementId(getPlanItemInstanceByName(planItemInstances, &quot;Task A&quot;, ACTIVE).getElementId())</span>
<span class="nc" id="L66">                .createInStage(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Stage A&quot;, ACTIVE));</span>

<span class="nc" id="L68">        assertThat(injectedTask).isNotNull();</span>
<span class="nc" id="L69">        assertThat(injectedTask.getState()).isEqualTo(ACTIVE);</span>

<span class="nc" id="L71">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L72">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L73">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L74">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L75">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>
<span class="nc" id="L76">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task A&quot;, ACTIVE);</span>

<span class="nc" id="L78">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery()</span>
<span class="nc" id="L79">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L80">                .active()</span>
<span class="nc" id="L81">                .list();</span>

<span class="nc" id="L83">        assertThat(tasks).hasSize(2);</span>
<span class="nc" id="L84">        assertSingleTaskExists(tasks, &quot;Task A&quot;);</span>
<span class="nc" id="L85">        assertSingleTaskExists(tasks, &quot;Injected Task A&quot;);</span>

        // test the query for the derived case definition (in this unit test, it will be the same as the running one)
<span class="nc" id="L88">        List&lt;PlanItemInstance&gt; derivedPlanItems = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L89">                .derivedCaseDefinitionId(caseInstance.getCaseDefinitionId())</span>
<span class="nc" id="L90">                .list();</span>

<span class="nc" id="L92">        assertThat(derivedPlanItems).isNotNull();</span>
<span class="nc" id="L93">        assertThat(derivedPlanItems)</span>
<span class="nc" id="L94">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L95">                .containsExactly(&quot;Injected Task A&quot;);</span>

<span class="nc" id="L97">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task A&quot;, ACTIVE));</span>
<span class="nc" id="L98">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L99">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L100">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L101">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L102">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task A&quot;, ACTIVE);</span>

<span class="nc" id="L104">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Injected Task A&quot;, ACTIVE));</span>
<span class="nc" id="L105">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L106">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L107">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, ACTIVE);</span>
<span class="nc" id="L108">        assertPlanItemInstanceState(planItemInstances, &quot;Task B&quot;, ACTIVE);</span>
<span class="nc" id="L109">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/PlanItemInjectionTest.testDynamicPlanItemInjection.cmmn&quot; })
    public void testDynamicPlanItemInjectionInCase() {
<span class="nc" id="L114">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;dynamicPlanItemInjection&quot;).start();</span>

<span class="nc" id="L116">        List&lt;PlanItemInstance&gt; planItemInstances = getPlanItemInstances(caseInstance.getId());</span>

<span class="nc" id="L118">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L119">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L120">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L121">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>

        // inject new plan item into case instance
<span class="nc" id="L124">        PlanItemInstance injectedTask = dynamicCmmnService</span>
<span class="nc" id="L125">                .createInjectedPlanItemInstanceBuilder()</span>
<span class="nc" id="L126">                .name(&quot;Injected Task A&quot;)</span>
<span class="nc" id="L127">                .caseDefinitionId(caseInstance.getCaseDefinitionId())</span>
<span class="nc" id="L128">                .elementId(getPlanItemInstanceByName(planItemInstances, &quot;Task A&quot;, ACTIVE).getElementId())</span>
<span class="nc" id="L129">                .createInCase(caseInstance.getId());</span>

<span class="nc" id="L131">        assertThat(injectedTask).isNotNull();</span>
<span class="nc" id="L132">        assertThat(injectedTask.getState()).isEqualTo(ACTIVE);</span>

<span class="nc" id="L134">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L135">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L136">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L137">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L138">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>
<span class="nc" id="L139">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task A&quot;, ACTIVE);</span>

<span class="nc" id="L141">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery()</span>
<span class="nc" id="L142">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L143">                .active()</span>
<span class="nc" id="L144">                .list();</span>

<span class="nc" id="L146">        assertThat(tasks).hasSize(2);</span>
<span class="nc" id="L147">        assertSingleTaskExists(tasks, &quot;Task A&quot;);</span>
<span class="nc" id="L148">        assertSingleTaskExists(tasks, &quot;Injected Task A&quot;);</span>

        // test the query for the derived case definition (in this unit test, it will be the same as the running one)
<span class="nc" id="L151">        List&lt;PlanItemInstance&gt; derivedPlanItems = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L152">                .derivedCaseDefinitionId(caseInstance.getCaseDefinitionId())</span>
<span class="nc" id="L153">                .list();</span>

<span class="nc" id="L155">        assertThat(derivedPlanItems).isNotNull();</span>
<span class="nc" id="L156">        assertThat(derivedPlanItems)</span>
<span class="nc" id="L157">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L158">                .containsExactly(&quot;Injected Task A&quot;);</span>

<span class="nc" id="L160">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task A&quot;, ACTIVE));</span>
<span class="nc" id="L161">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L162">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L163">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, ACTIVE);</span>
<span class="nc" id="L164">        assertPlanItemInstanceState(planItemInstances, &quot;Task B&quot;, ACTIVE);</span>
<span class="nc" id="L165">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task A&quot;, ACTIVE);</span>

<span class="nc" id="L167">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task B&quot;, ACTIVE));</span>
<span class="nc" id="L168">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L169">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L170">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task A&quot;, ACTIVE);</span>

<span class="nc" id="L172">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Injected Task A&quot;, ACTIVE));</span>

<span class="nc" id="L174">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().count()).isZero();</span>
<span class="nc" id="L175">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isZero();</span>

<span class="nc bnc" id="L177" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L178">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isEqualTo(1);</span>

<span class="nc" id="L180">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L181">                .planItemInstanceDerivedCaseDefinitionId(caseInstance.getCaseDefinitionId())</span>
<span class="nc" id="L182">                .list();</span>

<span class="nc" id="L184">            assertThat(historicPlanItemInstances).isNotNull();</span>
<span class="nc" id="L185">            assertThat(historicPlanItemInstances)</span>
<span class="nc" id="L186">                .extracting(HistoricPlanItemInstance::getName)</span>
<span class="nc" id="L187">                .containsExactly(&quot;Injected Task A&quot;);</span>
        }
<span class="nc" id="L189">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/PlanItemInjectionTest.testDynamicPlanItemInjection.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/PlanItemInjectionTest.dynamicPlanItemTemplates.cmmn&quot; })
    public void testDynamicPlanItemInjectionFromTemplate() {
<span class="nc" id="L195">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;dynamicPlanItemInjection&quot;).start();</span>

<span class="nc" id="L197">        List&lt;PlanItemInstance&gt; planItemInstances = getPlanItemInstances(caseInstance.getId());</span>

<span class="nc" id="L199">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L200">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L201">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L202">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>

<span class="nc" id="L204">        CaseDefinition dynamicPlanItemCase = cmmnRepositoryService.createCaseDefinitionQuery()</span>
<span class="nc" id="L205">                .caseDefinitionKey(&quot;dynamicPlanItemCase&quot;)</span>
<span class="nc" id="L206">                .latestVersion()</span>
<span class="nc" id="L207">                .singleResult();</span>

<span class="nc" id="L209">        CaseElement templateTask = getCase(dynamicPlanItemCase.getId()).getAllCaseElements().get(&quot;planItem1&quot;);</span>

        // inject new plan item into Stage A
<span class="nc" id="L212">        PlanItemInstance injectedTask = dynamicCmmnService</span>
<span class="nc" id="L213">                .createInjectedPlanItemInstanceBuilder()</span>
<span class="nc" id="L214">                .name(&quot;Injected Task A&quot;)</span>
<span class="nc" id="L215">                .caseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L216">                .elementId(templateTask.getId())</span>
<span class="nc" id="L217">                .createInStage(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Stage A&quot;, ACTIVE));</span>

<span class="nc" id="L219">        assertThat(injectedTask).isNotNull();</span>
<span class="nc" id="L220">        assertThat(injectedTask.getState()).isEqualTo(ACTIVE);</span>

<span class="nc" id="L222">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L223">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L224">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L225">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L226">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>
<span class="nc" id="L227">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task A&quot;, ACTIVE);</span>

<span class="nc" id="L229">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery()</span>
<span class="nc" id="L230">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L231">                .active()</span>
<span class="nc" id="L232">                .list();</span>

<span class="nc" id="L234">        assertThat(tasks).hasSize(2);</span>
<span class="nc" id="L235">        assertSingleTaskExists(tasks, &quot;Task A&quot;);</span>
<span class="nc" id="L236">        assertSingleTaskExists(tasks, &quot;Injected Task A&quot;);</span>

        // test the query for the derived case definition (in this unit test, it will be a different one from the running case one)
<span class="nc" id="L239">        List&lt;PlanItemInstance&gt; derivedPlanItems = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L240">                .derivedCaseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L241">                .list();</span>

<span class="nc" id="L243">        assertThat(derivedPlanItems).isNotNull();</span>
<span class="nc" id="L244">        assertThat(derivedPlanItems)</span>
<span class="nc" id="L245">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L246">                .containsExactly(&quot;Injected Task A&quot;);</span>

<span class="nc" id="L248">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task A&quot;, ACTIVE));</span>
<span class="nc" id="L249">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L250">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L251">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L252">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L253">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task A&quot;, ACTIVE);</span>

<span class="nc" id="L255">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Injected Task A&quot;, ACTIVE));</span>
<span class="nc" id="L256">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L257">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L258">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, ACTIVE);</span>
<span class="nc" id="L259">        assertPlanItemInstanceState(planItemInstances, &quot;Task B&quot;, ACTIVE);</span>

<span class="nc bnc" id="L261" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L262">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L263">                .planItemInstanceDerivedCaseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L264">                .list();</span>

<span class="nc" id="L266">            assertThat(historicPlanItemInstances).isNotNull();</span>
<span class="nc" id="L267">            assertThat(historicPlanItemInstances)</span>
<span class="nc" id="L268">                .extracting(HistoricPlanItemInstance::getName)</span>
<span class="nc" id="L269">                .containsExactly(&quot;Injected Task A&quot;);</span>
        }
<span class="nc" id="L271">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/PlanItemInjectionTest.testDynamicPlanItemInjection.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/PlanItemInjectionTest.dynamicPlanItemTemplates.cmmn&quot; })
    public void testDynamicPlanItemInjectionFromTemplateInCase() {
<span class="nc" id="L277">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;dynamicPlanItemInjection&quot;).start();</span>

<span class="nc" id="L279">        List&lt;PlanItemInstance&gt; planItemInstances = getPlanItemInstances(caseInstance.getId());</span>

<span class="nc" id="L281">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L282">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L283">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L284">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>

<span class="nc" id="L286">        CaseDefinition dynamicPlanItemCase = cmmnRepositoryService.createCaseDefinitionQuery()</span>
<span class="nc" id="L287">                .caseDefinitionKey(&quot;dynamicPlanItemCase&quot;)</span>
<span class="nc" id="L288">                .latestVersion()</span>
<span class="nc" id="L289">                .singleResult();</span>

<span class="nc" id="L291">        CaseElement templateTask = getCase(dynamicPlanItemCase.getId()).getAllCaseElements().get(&quot;planItem1&quot;);</span>

        // inject new plan item into case instance
<span class="nc" id="L294">        PlanItemInstance injectedTask = dynamicCmmnService</span>
<span class="nc" id="L295">                .createInjectedPlanItemInstanceBuilder()</span>
<span class="nc" id="L296">                .name(&quot;Injected Task A&quot;)</span>
<span class="nc" id="L297">                .caseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L298">                .elementId(templateTask.getId())</span>
<span class="nc" id="L299">                .createInCase(caseInstance.getId());</span>

<span class="nc" id="L301">        assertThat(injectedTask).isNotNull();</span>
<span class="nc" id="L302">        assertThat(injectedTask.getState()).isEqualTo(ACTIVE);</span>

<span class="nc" id="L304">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L305">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L306">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L307">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L308">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>
<span class="nc" id="L309">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task A&quot;, ACTIVE);</span>

<span class="nc" id="L311">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery()</span>
<span class="nc" id="L312">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L313">                .active()</span>
<span class="nc" id="L314">                .list();</span>

<span class="nc" id="L316">        assertThat(tasks).hasSize(2);</span>
<span class="nc" id="L317">        assertSingleTaskExists(tasks, &quot;Task A&quot;);</span>
<span class="nc" id="L318">        assertSingleTaskExists(tasks, &quot;Injected Task A&quot;);</span>

        // test the query for the derived case definition (in this unit test, it will be a different one from the running case one)
<span class="nc" id="L321">        List&lt;PlanItemInstance&gt; derivedPlanItems = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L322">                .derivedCaseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L323">                .list();</span>

<span class="nc" id="L325">        assertThat(derivedPlanItems).isNotNull();</span>
<span class="nc" id="L326">        assertThat(derivedPlanItems)</span>
<span class="nc" id="L327">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L328">                .containsExactly(&quot;Injected Task A&quot;);</span>

<span class="nc" id="L330">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task A&quot;, ACTIVE));</span>
<span class="nc" id="L331">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L332">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L333">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, ACTIVE);</span>
<span class="nc" id="L334">        assertPlanItemInstanceState(planItemInstances, &quot;Task B&quot;, ACTIVE);</span>
<span class="nc" id="L335">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task A&quot;, ACTIVE);</span>

<span class="nc" id="L337">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task B&quot;, ACTIVE));</span>
<span class="nc" id="L338">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L339">        assertThat(planItemInstances).hasSize(1);</span>
<span class="nc" id="L340">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task A&quot;, ACTIVE);</span>

<span class="nc" id="L342">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Injected Task A&quot;, ACTIVE));</span>

<span class="nc" id="L344">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().count()).isZero();</span>
<span class="nc" id="L345">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isZero();</span>

<span class="nc bnc" id="L347" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L348">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isEqualTo(1);</span>

<span class="nc" id="L350">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L351">                .planItemInstanceDerivedCaseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L352">                .list();</span>

<span class="nc" id="L354">            assertThat(historicPlanItemInstances).isNotNull();</span>
<span class="nc" id="L355">            assertThat(historicPlanItemInstances)</span>
<span class="nc" id="L356">                .extracting(HistoricPlanItemInstance::getName)</span>
<span class="nc" id="L357">                .containsExactly(&quot;Injected Task A&quot;);</span>
        }
<span class="nc" id="L359">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/PlanItemInjectionTest.testDynamicPlanItemInjection.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/PlanItemInjectionTest.dynamicPlanItemTemplates.cmmn&quot; })
    public void testDynamicStagePlanItemInjectionFromTemplate() {
<span class="nc" id="L365">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;dynamicPlanItemInjection&quot;).start();</span>

<span class="nc" id="L367">        List&lt;PlanItemInstance&gt; planItemInstances = getPlanItemInstances(caseInstance.getId());</span>

<span class="nc" id="L369">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L370">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L371">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L372">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>

<span class="nc" id="L374">        CaseDefinition dynamicPlanItemCase = cmmnRepositoryService.createCaseDefinitionQuery()</span>
<span class="nc" id="L375">                .caseDefinitionKey(&quot;dynamicPlanItemCase&quot;)</span>
<span class="nc" id="L376">                .latestVersion()</span>
<span class="nc" id="L377">                .singleResult();</span>

<span class="nc" id="L379">        CaseElement templateStage = getCase(dynamicPlanItemCase.getId()).getAllCaseElements().get(&quot;planItem5&quot;);</span>

        // inject new plan item into Stage A
<span class="nc" id="L382">        PlanItemInstance injectedStage = dynamicCmmnService</span>
<span class="nc" id="L383">                .createInjectedPlanItemInstanceBuilder()</span>
<span class="nc" id="L384">                .name(&quot;Injected Stage&quot;)</span>
<span class="nc" id="L385">                .caseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L386">                .elementId(templateStage.getId())</span>
<span class="nc" id="L387">                .createInStage(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Stage A&quot;, ACTIVE));</span>

<span class="nc" id="L389">        assertThat(injectedStage).isNotNull();</span>
<span class="nc" id="L390">        assertThat(injectedStage.getState()).isEqualTo(ACTIVE);</span>

<span class="nc" id="L392">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L393">        assertThat(planItemInstances).hasSize(6);</span>
<span class="nc" id="L394">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L395">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L396">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>
<span class="nc" id="L397">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L398">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task A&quot;, ACTIVE);</span>
<span class="nc" id="L399">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task B&quot;, AVAILABLE);</span>
<span class="nc" id="L400">        assertThat(getPlanItemInstanceByName(planItemInstances, &quot;Injected Stage&quot;, ACTIVE).isStage()).isTrue();</span>

<span class="nc" id="L402">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery()</span>
<span class="nc" id="L403">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L404">                .active()</span>
<span class="nc" id="L405">                .list();</span>

<span class="nc" id="L407">        assertThat(tasks).hasSize(2);</span>
<span class="nc" id="L408">        assertSingleTaskExists(tasks, &quot;Task A&quot;);</span>
<span class="nc" id="L409">        assertSingleTaskExists(tasks, &quot;Injected Task A&quot;);</span>

        // test the query for the derived case definition (in this unit test, it will be a different one from the running case one)
<span class="nc" id="L412">        List&lt;PlanItemInstance&gt; derivedPlanItems = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L413">                .derivedCaseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L414">                .list();</span>

<span class="nc" id="L416">        assertThat(derivedPlanItems).hasSize(3);</span>

<span class="nc" id="L418">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task A&quot;, ACTIVE));</span>
<span class="nc" id="L419">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L420">        assertThat(planItemInstances).hasSize(5);</span>
<span class="nc" id="L421">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L422">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L423">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L424">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task A&quot;, ACTIVE);</span>
<span class="nc" id="L425">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task B&quot;, AVAILABLE);</span>

<span class="nc" id="L427">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Injected Task A&quot;, ACTIVE));</span>
<span class="nc" id="L428">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L429">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L430">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L431">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L432">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L433">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task B&quot;, ACTIVE);</span>

<span class="nc" id="L435">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Injected Task B&quot;, ACTIVE));</span>
<span class="nc" id="L436">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L437">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L438">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, ACTIVE);</span>
<span class="nc" id="L439">        assertPlanItemInstanceState(planItemInstances, &quot;Task B&quot;, ACTIVE);</span>

<span class="nc bnc" id="L441" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L442">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L443">                .planItemInstanceDerivedCaseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L444">                .list();</span>

<span class="nc" id="L446">            assertThat(historicPlanItemInstances).hasSize(3);</span>
        }
<span class="nc" id="L448">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/PlanItemInjectionTest.testDynamicPlanItemInjection.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/PlanItemInjectionTest.dynamicPlanItemTemplates.cmmn&quot; })
    public void testDynamicStagePlanItemInjectionFromTemplateInCase() {
<span class="nc" id="L454">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;dynamicPlanItemInjection&quot;).start();</span>

<span class="nc" id="L456">        List&lt;PlanItemInstance&gt; planItemInstances = getPlanItemInstances(caseInstance.getId());</span>

<span class="nc" id="L458">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L459">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L460">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L461">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>

<span class="nc" id="L463">        CaseDefinition dynamicPlanItemCase = cmmnRepositoryService.createCaseDefinitionQuery()</span>
<span class="nc" id="L464">                .caseDefinitionKey(&quot;dynamicPlanItemCase&quot;)</span>
<span class="nc" id="L465">                .latestVersion()</span>
<span class="nc" id="L466">                .singleResult();</span>

<span class="nc" id="L468">        CaseElement templateStage = getCase(dynamicPlanItemCase.getId()).getAllCaseElements().get(&quot;planItem5&quot;);</span>

        // inject new plan item into running case
<span class="nc" id="L471">        PlanItemInstance injectedStage = dynamicCmmnService</span>
<span class="nc" id="L472">                .createInjectedPlanItemInstanceBuilder()</span>
<span class="nc" id="L473">                .name(&quot;Injected Stage&quot;)</span>
<span class="nc" id="L474">                .caseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L475">                .elementId(templateStage.getId())</span>
<span class="nc" id="L476">                .createInCase(caseInstance.getId());</span>

<span class="nc" id="L478">        assertThat(injectedStage).isNotNull();</span>
<span class="nc" id="L479">        assertThat(injectedStage.getState()).isEqualTo(ACTIVE);</span>

<span class="nc" id="L481">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L482">        assertThat(planItemInstances).hasSize(6);</span>
<span class="nc" id="L483">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L484">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L485">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>
<span class="nc" id="L486">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L487">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task A&quot;, ACTIVE);</span>
<span class="nc" id="L488">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task B&quot;, AVAILABLE);</span>
<span class="nc" id="L489">        assertThat(getPlanItemInstanceByName(planItemInstances, &quot;Injected Stage&quot;, ACTIVE).isStage()).isTrue();</span>

<span class="nc" id="L491">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery()</span>
<span class="nc" id="L492">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L493">                .active()</span>
<span class="nc" id="L494">                .list();</span>

<span class="nc" id="L496">        assertThat(tasks).hasSize(2);</span>
<span class="nc" id="L497">        assertSingleTaskExists(tasks, &quot;Task A&quot;);</span>
<span class="nc" id="L498">        assertSingleTaskExists(tasks, &quot;Injected Task A&quot;);</span>

        // test the query for the derived case definition (in this unit test, it will be a different one from the running case one)
<span class="nc" id="L501">        List&lt;PlanItemInstance&gt; derivedPlanItems = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L502">                .derivedCaseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L503">                .list();</span>

<span class="nc" id="L505">        assertThat(derivedPlanItems).hasSize(3);</span>

<span class="nc" id="L507">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task A&quot;, ACTIVE));</span>
<span class="nc" id="L508">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L509">        assertThat(planItemInstances).hasSize(5);</span>
<span class="nc" id="L510">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, ACTIVE);</span>
<span class="nc" id="L511">        assertPlanItemInstanceState(planItemInstances, &quot;Task B&quot;, ACTIVE);</span>
<span class="nc" id="L512">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L513">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task A&quot;, ACTIVE);</span>
<span class="nc" id="L514">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task B&quot;, AVAILABLE);</span>

<span class="nc" id="L516">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Injected Task A&quot;, ACTIVE));</span>
<span class="nc" id="L517">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L518">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L519">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, ACTIVE);</span>
<span class="nc" id="L520">        assertPlanItemInstanceState(planItemInstances, &quot;Task B&quot;, ACTIVE);</span>
<span class="nc" id="L521">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L522">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task B&quot;, ACTIVE);</span>

<span class="nc" id="L524">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task B&quot;, ACTIVE));</span>
<span class="nc" id="L525">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L526">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L527">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L528">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Task B&quot;, ACTIVE);</span>

<span class="nc" id="L530">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Injected Task B&quot;, ACTIVE));</span>

<span class="nc" id="L532">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().count()).isZero();</span>
<span class="nc" id="L533">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isZero();</span>

<span class="nc bnc" id="L535" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L536">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isEqualTo(1);</span>

<span class="nc" id="L538">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L539">                .planItemInstanceDerivedCaseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L540">                .list();</span>

<span class="nc" id="L542">            assertThat(historicPlanItemInstances).hasSize(3);</span>
        }
<span class="nc" id="L544">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/PlanItemInjectionTest.testDynamicPlanItemInjection.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/PlanItemInjectionTest.dynamicPlanItemTemplates.cmmn&quot; })
    public void testDynamicStagePlanItemInjectionWithSentryFromTemplate() {
<span class="nc" id="L550">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;dynamicPlanItemInjection&quot;).start();</span>

<span class="nc" id="L552">        List&lt;PlanItemInstance&gt; planItemInstances = getPlanItemInstances(caseInstance.getId());</span>

<span class="nc" id="L554">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L555">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L556">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L557">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>

<span class="nc" id="L559">        CaseDefinition dynamicPlanItemCase = cmmnRepositoryService.createCaseDefinitionQuery()</span>
<span class="nc" id="L560">                .caseDefinitionKey(&quot;dynamicPlanItemCase&quot;)</span>
<span class="nc" id="L561">                .latestVersion()</span>
<span class="nc" id="L562">                .singleResult();</span>

        // already make sure the condition for the injected stage entry sentry will be satisfied when the stage will be injected
<span class="nc" id="L565">        cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;injectedStageEnabled&quot;, true);</span>

<span class="nc" id="L567">        CaseElement templateStage = getCase(dynamicPlanItemCase.getId()).getAllCaseElements().get(&quot;planItem8&quot;);</span>

        // inject new plan item into Stage A
<span class="nc" id="L570">        PlanItemInstance injectedStage = dynamicCmmnService</span>
<span class="nc" id="L571">                .createInjectedPlanItemInstanceBuilder()</span>
<span class="nc" id="L572">                .name(&quot;Injected Stage&quot;)</span>
<span class="nc" id="L573">                .caseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L574">                .elementId(templateStage.getId())</span>
<span class="nc" id="L575">                .createInStage(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Stage A&quot;, ACTIVE));</span>

<span class="nc" id="L577">        assertThat(injectedStage).isNotNull();</span>
<span class="nc" id="L578">        assertThat(injectedStage.getState()).isEqualTo(ACTIVE);</span>

<span class="nc" id="L580">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L581">        assertThat(planItemInstances).hasSize(6);</span>
<span class="nc" id="L582">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L583">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L584">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L585">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>
<span class="nc" id="L586">        assertPlanItemInstanceState(planItemInstances, &quot;Task X&quot;, ACTIVE);</span>
<span class="nc" id="L587">        assertPlanItemInstanceState(planItemInstances, &quot;Task Y&quot;, ACTIVE);</span>

<span class="nc" id="L589">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery()</span>
<span class="nc" id="L590">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L591">                .active()</span>
<span class="nc" id="L592">                .list();</span>

<span class="nc" id="L594">        assertThat(tasks).hasSize(3);</span>
<span class="nc" id="L595">        assertSingleTaskExists(tasks, &quot;Task A&quot;);</span>
<span class="nc" id="L596">        assertSingleTaskExists(tasks, &quot;Task X&quot;);</span>
<span class="nc" id="L597">        assertSingleTaskExists(tasks, &quot;Task Y&quot;);</span>

        // test the query for the derived case definition (in this unit test, it will be a different one from the running case one)
<span class="nc" id="L600">        List&lt;PlanItemInstance&gt; derivedPlanItems = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L601">                .derivedCaseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L602">                .list();</span>

<span class="nc" id="L604">        assertThat(derivedPlanItems).hasSize(3);</span>

<span class="nc" id="L606">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task A&quot;, ACTIVE));</span>
<span class="nc" id="L607">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L608">        assertThat(planItemInstances).hasSize(5);</span>
<span class="nc" id="L609">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L610">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L611">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L612">        assertPlanItemInstanceState(planItemInstances, &quot;Task X&quot;, ACTIVE);</span>
<span class="nc" id="L613">        assertPlanItemInstanceState(planItemInstances, &quot;Task Y&quot;, ACTIVE);</span>

<span class="nc" id="L615">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task X&quot;, ACTIVE));</span>
<span class="nc" id="L616">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L617">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L618">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L619">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L620">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L621">        assertPlanItemInstanceState(planItemInstances, &quot;Task Y&quot;, ACTIVE);</span>

<span class="nc" id="L623">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task Y&quot;, ACTIVE));</span>
<span class="nc" id="L624">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L625">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L626">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, ACTIVE);</span>
<span class="nc" id="L627">        assertPlanItemInstanceState(planItemInstances, &quot;Task B&quot;, ACTIVE);</span>
<span class="nc" id="L628">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/PlanItemInjectionTest.testDynamicPlanItemInjection.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/PlanItemInjectionTest.dynamicPlanItemTemplates.cmmn&quot; })
    public void testDynamicStagePlanItemInjectionWithSentryFromTemplateInCase() {
<span class="nc" id="L634">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;dynamicPlanItemInjection&quot;).start();</span>

<span class="nc" id="L636">        List&lt;PlanItemInstance&gt; planItemInstances = getPlanItemInstances(caseInstance.getId());</span>

<span class="nc" id="L638">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L639">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L640">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L641">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>

<span class="nc" id="L643">        CaseDefinition dynamicPlanItemCase = cmmnRepositoryService.createCaseDefinitionQuery()</span>
<span class="nc" id="L644">                .caseDefinitionKey(&quot;dynamicPlanItemCase&quot;)</span>
<span class="nc" id="L645">                .latestVersion()</span>
<span class="nc" id="L646">                .singleResult();</span>

        // already make sure the condition for the injected stage entry sentry will be satisfied when the stage will be injected
<span class="nc" id="L649">        cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;injectedStageEnabled&quot;, true);</span>

<span class="nc" id="L651">        CaseElement templateStage = getCase(dynamicPlanItemCase.getId()).getAllCaseElements().get(&quot;planItem8&quot;);</span>

        // inject new plan item into running case
<span class="nc" id="L654">        PlanItemInstance injectedStage = dynamicCmmnService</span>
<span class="nc" id="L655">                .createInjectedPlanItemInstanceBuilder()</span>
<span class="nc" id="L656">                .name(&quot;Injected Stage&quot;)</span>
<span class="nc" id="L657">                .caseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L658">                .elementId(templateStage.getId())</span>
<span class="nc" id="L659">                .createInCase(caseInstance.getId());</span>

<span class="nc" id="L661">        assertThat(injectedStage).isNotNull();</span>
<span class="nc" id="L662">        assertThat(injectedStage.getState()).isEqualTo(ACTIVE);</span>

<span class="nc" id="L664">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L665">        assertThat(planItemInstances).hasSize(6);</span>
<span class="nc" id="L666">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L667">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L668">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L669">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>
<span class="nc" id="L670">        assertPlanItemInstanceState(planItemInstances, &quot;Task X&quot;, ACTIVE);</span>
<span class="nc" id="L671">        assertPlanItemInstanceState(planItemInstances, &quot;Task Y&quot;, ACTIVE);</span>

<span class="nc" id="L673">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery()</span>
<span class="nc" id="L674">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L675">                .active()</span>
<span class="nc" id="L676">                .list();</span>

<span class="nc" id="L678">        assertThat(tasks).hasSize(3);</span>
<span class="nc" id="L679">        assertSingleTaskExists(tasks, &quot;Task A&quot;);</span>
<span class="nc" id="L680">        assertSingleTaskExists(tasks, &quot;Task X&quot;);</span>
<span class="nc" id="L681">        assertSingleTaskExists(tasks, &quot;Task Y&quot;);</span>

        // test the query for the derived case definition (in this unit test, it will be a different one from the running case one)
<span class="nc" id="L684">        List&lt;PlanItemInstance&gt; derivedPlanItems = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L685">                .derivedCaseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L686">                .list();</span>

<span class="nc" id="L688">        assertThat(derivedPlanItems).hasSize(3);</span>

<span class="nc" id="L690">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task A&quot;, ACTIVE));</span>
<span class="nc" id="L691">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L692">        assertThat(planItemInstances).hasSize(5);</span>
<span class="nc" id="L693">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, ACTIVE);</span>
<span class="nc" id="L694">        assertPlanItemInstanceState(planItemInstances, &quot;Task B&quot;, ACTIVE);</span>
<span class="nc" id="L695">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L696">        assertPlanItemInstanceState(planItemInstances, &quot;Task X&quot;, ACTIVE);</span>
<span class="nc" id="L697">        assertPlanItemInstanceState(planItemInstances, &quot;Task Y&quot;, ACTIVE);</span>

<span class="nc" id="L699">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task X&quot;, ACTIVE));</span>
<span class="nc" id="L700">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L701">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L702">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, ACTIVE);</span>
<span class="nc" id="L703">        assertPlanItemInstanceState(planItemInstances, &quot;Task B&quot;, ACTIVE);</span>
<span class="nc" id="L704">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L705">        assertPlanItemInstanceState(planItemInstances, &quot;Task Y&quot;, ACTIVE);</span>

<span class="nc" id="L707">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task B&quot;, ACTIVE));</span>
<span class="nc" id="L708">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L709">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L710">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L711">        assertPlanItemInstanceState(planItemInstances, &quot;Task Y&quot;, ACTIVE);</span>

<span class="nc" id="L713">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task Y&quot;, ACTIVE));</span>

<span class="nc" id="L715">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().count()).isZero();</span>
<span class="nc" id="L716">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isZero();</span>

<span class="nc bnc" id="L718" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L719">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isEqualTo(1);</span>

<span class="nc" id="L721">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L722">                .planItemInstanceDerivedCaseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L723">                .list();</span>

<span class="nc" id="L725">            assertThat(historicPlanItemInstances).hasSize(3);</span>
        }
<span class="nc" id="L727">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/PlanItemInjectionTest.testDynamicPlanItemInjection.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/PlanItemInjectionTest.dynamicPlanItemTemplates.cmmn&quot; })
    public void testDynamicStagePlanItemInjectionWithSentryConditionFromTemplate() {
<span class="nc" id="L733">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;dynamicPlanItemInjection&quot;).start();</span>

<span class="nc" id="L735">        List&lt;PlanItemInstance&gt; planItemInstances = getPlanItemInstances(caseInstance.getId());</span>

<span class="nc" id="L737">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L738">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L739">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L740">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>

<span class="nc" id="L742">        CaseDefinition dynamicPlanItemCase = cmmnRepositoryService.createCaseDefinitionQuery()</span>
<span class="nc" id="L743">                .caseDefinitionKey(&quot;dynamicPlanItemCase&quot;)</span>
<span class="nc" id="L744">                .latestVersion()</span>
<span class="nc" id="L745">                .singleResult();</span>

<span class="nc" id="L747">        CaseElement templateStage = getCase(dynamicPlanItemCase.getId()).getAllCaseElements().get(&quot;planItem8&quot;);</span>

        // inject new plan item into Stage A
<span class="nc" id="L750">        PlanItemInstance injectedStage = dynamicCmmnService</span>
<span class="nc" id="L751">                .createInjectedPlanItemInstanceBuilder()</span>
<span class="nc" id="L752">                .name(&quot;Injected Stage&quot;)</span>
<span class="nc" id="L753">                .caseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L754">                .elementId(templateStage.getId())</span>
<span class="nc" id="L755">                .createInStage(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Stage A&quot;, ACTIVE));</span>

<span class="nc" id="L757">        assertThat(injectedStage).isNotNull();</span>
<span class="nc" id="L758">        assertThat(injectedStage.getState()).isEqualTo(AVAILABLE);</span>

<span class="nc" id="L760">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L761">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L762">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L763">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L764">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>
<span class="nc" id="L765">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, AVAILABLE);</span>
<span class="nc" id="L766">        assertThat(getPlanItemInstanceByName(planItemInstances, &quot;Injected Stage&quot;, AVAILABLE).isStage()).isTrue();</span>

<span class="nc" id="L768">        cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;injectedStageEnabled&quot;, true);</span>
<span class="nc" id="L769">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L770">        assertThat(planItemInstances).hasSize(6);</span>
<span class="nc" id="L771">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L772">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L773">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L774">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>
<span class="nc" id="L775">        assertPlanItemInstanceState(planItemInstances, &quot;Task X&quot;, ACTIVE);</span>
<span class="nc" id="L776">        assertPlanItemInstanceState(planItemInstances, &quot;Task Y&quot;, ACTIVE);</span>

<span class="nc" id="L778">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery()</span>
<span class="nc" id="L779">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L780">                .active()</span>
<span class="nc" id="L781">                .list();</span>

<span class="nc" id="L783">        assertThat(tasks).hasSize(3);</span>
<span class="nc" id="L784">        assertSingleTaskExists(tasks, &quot;Task A&quot;);</span>
<span class="nc" id="L785">        assertSingleTaskExists(tasks, &quot;Task X&quot;);</span>
<span class="nc" id="L786">        assertSingleTaskExists(tasks, &quot;Task Y&quot;);</span>

        // test the query for the derived case definition (in this unit test, it will be a different one from the running case one)
<span class="nc" id="L789">        List&lt;PlanItemInstance&gt; derivedPlanItems = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L790">                .derivedCaseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L791">                .list();</span>

<span class="nc" id="L793">        assertThat(derivedPlanItems).hasSize(3);</span>

<span class="nc" id="L795">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task A&quot;, ACTIVE));</span>
<span class="nc" id="L796">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L797">        assertThat(planItemInstances).hasSize(5);</span>
<span class="nc" id="L798">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L799">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L800">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L801">        assertPlanItemInstanceState(planItemInstances, &quot;Task X&quot;, ACTIVE);</span>
<span class="nc" id="L802">        assertPlanItemInstanceState(planItemInstances, &quot;Task Y&quot;, ACTIVE);</span>

<span class="nc" id="L804">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task X&quot;, ACTIVE));</span>
<span class="nc" id="L805">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L806">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L807">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L808">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L809">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L810">        assertPlanItemInstanceState(planItemInstances, &quot;Task Y&quot;, ACTIVE);</span>

<span class="nc" id="L812">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task Y&quot;, ACTIVE));</span>
<span class="nc" id="L813">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L814">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L815">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, ACTIVE);</span>
<span class="nc" id="L816">        assertPlanItemInstanceState(planItemInstances, &quot;Task B&quot;, ACTIVE);</span>
<span class="nc" id="L817">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/PlanItemInjectionTest.testDynamicPlanItemInjection.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/PlanItemInjectionTest.dynamicPlanItemTemplates.cmmn&quot; })
    public void testDynamicStagePlanItemInjectionWithSentryConditionFromTemplateInCase() {
<span class="nc" id="L823">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;dynamicPlanItemInjection&quot;).start();</span>

<span class="nc" id="L825">        List&lt;PlanItemInstance&gt; planItemInstances = getPlanItemInstances(caseInstance.getId());</span>

<span class="nc" id="L827">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L828">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L829">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L830">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>

<span class="nc" id="L832">        CaseDefinition dynamicPlanItemCase = cmmnRepositoryService.createCaseDefinitionQuery()</span>
<span class="nc" id="L833">                .caseDefinitionKey(&quot;dynamicPlanItemCase&quot;)</span>
<span class="nc" id="L834">                .latestVersion()</span>
<span class="nc" id="L835">                .singleResult();</span>

<span class="nc" id="L837">        CaseElement templateStage = getCase(dynamicPlanItemCase.getId()).getAllCaseElements().get(&quot;planItem8&quot;);</span>

        // inject new plan item into running case
<span class="nc" id="L840">        PlanItemInstance injectedStage = dynamicCmmnService</span>
<span class="nc" id="L841">                .createInjectedPlanItemInstanceBuilder()</span>
<span class="nc" id="L842">                .name(&quot;Injected Stage&quot;)</span>
<span class="nc" id="L843">                .caseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L844">                .elementId(templateStage.getId())</span>
<span class="nc" id="L845">                .createInCase(caseInstance.getId());</span>

<span class="nc" id="L847">        assertThat(injectedStage).isNotNull();</span>
<span class="nc" id="L848">        assertThat(injectedStage.getState()).isEqualTo(AVAILABLE);</span>

<span class="nc" id="L850">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L851">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L852">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L853">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L854">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>
<span class="nc" id="L855">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, AVAILABLE);</span>
<span class="nc" id="L856">        assertThat(getPlanItemInstanceByName(planItemInstances, &quot;Injected Stage&quot;, AVAILABLE).isStage()).isTrue();</span>

<span class="nc" id="L858">        cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;injectedStageEnabled&quot;, true);</span>
<span class="nc" id="L859">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L860">        assertThat(planItemInstances).hasSize(6);</span>
<span class="nc" id="L861">        assertPlanItemInstanceState(planItemInstances, &quot;Stage A&quot;, ACTIVE);</span>
<span class="nc" id="L862">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, AVAILABLE);</span>
<span class="nc" id="L863">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L864">        assertPlanItemInstanceState(planItemInstances, &quot;Task A&quot;, ACTIVE);</span>
<span class="nc" id="L865">        assertPlanItemInstanceState(planItemInstances, &quot;Task X&quot;, ACTIVE);</span>
<span class="nc" id="L866">        assertPlanItemInstanceState(planItemInstances, &quot;Task Y&quot;, ACTIVE);</span>

<span class="nc" id="L868">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery()</span>
<span class="nc" id="L869">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L870">                .active()</span>
<span class="nc" id="L871">                .list();</span>

<span class="nc" id="L873">        assertThat(tasks).hasSize(3);</span>
<span class="nc" id="L874">        assertSingleTaskExists(tasks, &quot;Task A&quot;);</span>
<span class="nc" id="L875">        assertSingleTaskExists(tasks, &quot;Task X&quot;);</span>
<span class="nc" id="L876">        assertSingleTaskExists(tasks, &quot;Task Y&quot;);</span>

        // test the query for the derived case definition (in this unit test, it will be a different one from the running case one)
<span class="nc" id="L879">        List&lt;PlanItemInstance&gt; derivedPlanItems = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L880">                .derivedCaseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L881">                .list();</span>

<span class="nc" id="L883">        assertThat(derivedPlanItems).hasSize(3);</span>

<span class="nc" id="L885">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task A&quot;, ACTIVE));</span>
<span class="nc" id="L886">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L887">        assertThat(planItemInstances).hasSize(5);</span>
<span class="nc" id="L888">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, ACTIVE);</span>
<span class="nc" id="L889">        assertPlanItemInstanceState(planItemInstances, &quot;Task B&quot;, ACTIVE);</span>
<span class="nc" id="L890">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L891">        assertPlanItemInstanceState(planItemInstances, &quot;Task X&quot;, ACTIVE);</span>
<span class="nc" id="L892">        assertPlanItemInstanceState(planItemInstances, &quot;Task Y&quot;, ACTIVE);</span>

<span class="nc" id="L894">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task X&quot;, ACTIVE));</span>
<span class="nc" id="L895">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L896">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L897">        assertPlanItemInstanceState(planItemInstances, &quot;Stage B&quot;, ACTIVE);</span>
<span class="nc" id="L898">        assertPlanItemInstanceState(planItemInstances, &quot;Task B&quot;, ACTIVE);</span>
<span class="nc" id="L899">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L900">        assertPlanItemInstanceState(planItemInstances, &quot;Task Y&quot;, ACTIVE);</span>

<span class="nc" id="L902">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task B&quot;, ACTIVE));</span>
<span class="nc" id="L903">        planItemInstances = getPlanItemInstances(caseInstance.getId());</span>
<span class="nc" id="L904">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L905">        assertPlanItemInstanceState(planItemInstances, &quot;Injected Stage&quot;, ACTIVE);</span>
<span class="nc" id="L906">        assertPlanItemInstanceState(planItemInstances, &quot;Task Y&quot;, ACTIVE);</span>

<span class="nc" id="L908">        cmmnRuntimeService.triggerPlanItemInstance(getPlanItemInstanceIdByNameAndState(planItemInstances, &quot;Task Y&quot;, ACTIVE));</span>

<span class="nc" id="L910">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().count()).isZero();</span>
<span class="nc" id="L911">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isZero();</span>

<span class="nc bnc" id="L913" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L914">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isEqualTo(1);</span>

<span class="nc" id="L916">            List&lt;HistoricPlanItemInstance&gt; historicPlanItemInstances = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L917">                .planItemInstanceDerivedCaseDefinitionId(dynamicPlanItemCase.getId())</span>
<span class="nc" id="L918">                .list();</span>

<span class="nc" id="L920">            assertThat(historicPlanItemInstances).hasSize(3);</span>
        }
<span class="nc" id="L922">    }</span>

    @Override
    public void setupServices() {
<span class="nc" id="L926">        super.setupServices();</span>
<span class="nc" id="L927">        CmmnEngineConfiguration cmmnEngineConfiguration = CmmnTestRunner.getCmmnEngineConfiguration();</span>
<span class="nc" id="L928">        this.deploymentManager = cmmnEngineConfiguration.getDeploymentManager();</span>
<span class="nc" id="L929">    }</span>

    protected CmmnModel getCmmnModel(String caseDefinitionId) {
<span class="nc" id="L932">        CaseDefinitionCacheEntry cacheEntry = deploymentManager.getCaseDefinitionCache().get(caseDefinitionId);</span>
<span class="nc bnc" id="L933" title="All 2 branches missed.">        if (cacheEntry != null) {</span>
<span class="nc" id="L934">            return cacheEntry.getCmmnModel();</span>
        }
<span class="nc" id="L936">        deploymentManager.findDeployedCaseDefinitionById(caseDefinitionId);</span>
<span class="nc" id="L937">        return deploymentManager.getCaseDefinitionCache().get(caseDefinitionId).getCmmnModel();</span>
    }

    protected Case getCase(String caseDefinitionId) {
<span class="nc" id="L941">        return getCmmnModel(caseDefinitionId).getPrimaryCase();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>