<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PlanItemInstanceQueryTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.cmmn.test.runtime</a> &gt; <span class="el_source">PlanItemInstanceQueryTest.java</span></div><h1>PlanItemInstanceQueryTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.cmmn.test.runtime;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.tuple;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.List;

import org.flowable.cmmn.api.history.HistoricPlanItemInstance;
import org.flowable.cmmn.api.runtime.CaseInstance;
import org.flowable.cmmn.api.runtime.PlanItemDefinitionType;
import org.flowable.cmmn.api.runtime.PlanItemInstance;
import org.flowable.cmmn.api.runtime.PlanItemInstanceState;
import org.flowable.cmmn.api.runtime.UserEventListenerInstance;
import org.flowable.cmmn.engine.PlanItemLocalizationManager;
import org.flowable.cmmn.engine.test.CmmnDeployment;
import org.flowable.cmmn.engine.test.FlowableCmmnTestCase;
import org.flowable.task.api.Task;
import org.junit.Before;
import org.junit.Test;

/**
 * @author Joram Barrez
 */
<span class="nc" id="L39">public class PlanItemInstanceQueryTest extends FlowableCmmnTestCase {</span>

    protected String caseDefinitionId;

    @Before
    public void deployCaseDefinition() {
<span class="nc" id="L45">        String deploymentId = addDeploymentForAutoCleanup(cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L46">                .addClasspathResource(&quot;org/flowable/cmmn/test/runtime/PlanItemInstanceQueryTest.testPlanItemInstanceQuery.cmmn&quot;)</span>
<span class="nc" id="L47">                .deploy());</span>
<span class="nc" id="L48">        caseDefinitionId = cmmnRepositoryService.createCaseDefinitionQuery()</span>
<span class="nc" id="L49">                .deploymentId(deploymentId)</span>
<span class="nc" id="L50">                .singleResult()</span>
<span class="nc" id="L51">                .getId();</span>
<span class="nc" id="L52">    }</span>

    @Test
    public void testByCaseDefinitionId() {
<span class="nc" id="L56">        startInstances(5);</span>
<span class="nc" id="L57">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().list()).hasSize(20);</span>
<span class="nc" id="L58">    }</span>

    @Test
    public void testByCaseInstanceId() {
<span class="nc" id="L62">        List&lt;String&gt; caseInstanceIds = startInstances(3);</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">        for (String caseInstanceId : caseInstanceIds) {</span>
<span class="nc" id="L64">            assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstanceId).list()).hasSize(4);</span>
<span class="nc" id="L65">        }</span>
<span class="nc" id="L66">    }</span>

    @Test
    public void testByStageInstanceId() {
<span class="nc" id="L70">        startInstances(1);</span>
<span class="nc" id="L71">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L72">                .planItemDefinitionType(PlanItemDefinitionType.STAGE)</span>
<span class="nc" id="L73">                .planItemInstanceName(&quot;Stage one&quot;)</span>
<span class="nc" id="L74">                .singleResult();</span>
<span class="nc" id="L75">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().stageInstanceId(planItemInstance.getId()).count()).isEqualTo(2);</span>
<span class="nc" id="L76">    }</span>

    @Test
    public void testByPlanItemInstanceId() {
<span class="nc" id="L80">        startInstances(1);</span>
<span class="nc" id="L81">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().list();</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">        for (PlanItemInstance planItemInstance : planItemInstances) {</span>
<span class="nc" id="L83">            assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceId(planItemInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L84">        }</span>
<span class="nc" id="L85">    }</span>

    @Test
    public void testByElementId() {
<span class="nc" id="L89">        startInstances(4);</span>
<span class="nc" id="L90">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceElementId(&quot;planItem3&quot;).list()).hasSize(4);</span>
<span class="nc" id="L91">    }</span>

    @Test
    public void testByName() {
<span class="nc" id="L95">        startInstances(9);</span>
<span class="nc" id="L96">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).list()).hasSize(9);</span>
<span class="nc" id="L97">    }</span>

    @Test
    public void testByState() {
<span class="nc" id="L101">        startInstances(1);</span>
<span class="nc" id="L102">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceState(PlanItemInstanceState.ACTIVE).list()).hasSize(2);</span>
<span class="nc" id="L103">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceStateActive().list()).hasSize(2);</span>

<span class="nc" id="L105">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceState(PlanItemInstanceState.AVAILABLE).list()).hasSize(1);</span>
<span class="nc" id="L106">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceStateAvailable().list()).hasSize(1);</span>

<span class="nc" id="L108">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceState(PlanItemInstanceState.ENABLED).list()).hasSize(1);</span>
<span class="nc" id="L109">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceStateEnabled().list()).hasSize(1);</span>
<span class="nc" id="L110">    }</span>

    @Test
    public void testByPlanItemDefinitionType() {
<span class="nc" id="L114">        startInstances(3);</span>
<span class="nc" id="L115">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemDefinitionType(PlanItemDefinitionType.HUMAN_TASK).list()).hasSize(6);</span>
<span class="nc" id="L116">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemDefinitionType(PlanItemDefinitionType.STAGE).list()).hasSize(6);</span>
<span class="nc" id="L117">    }</span>

    @Test
    public void testByPlanItemDefinitionTypes() {
<span class="nc" id="L121">        startInstances(2);</span>
<span class="nc" id="L122">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L123">                .planItemDefinitionTypes(Arrays.asList(PlanItemDefinitionType.STAGE, PlanItemDefinitionType.HUMAN_TASK)).list()).hasSize(8);</span>
<span class="nc" id="L124">    }</span>

    @Test
    public void testByStateEnabled() {
<span class="nc" id="L128">        startInstances(4);</span>
<span class="nc" id="L129">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L130">                .planItemInstanceStateEnabled()</span>
<span class="nc" id="L131">                .list();</span>
<span class="nc" id="L132">        assertThat(planItemInstances)</span>
<span class="nc" id="L133">                .hasSize(4)</span>
<span class="nc" id="L134">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L135">                .containsOnly(&quot;B&quot;);</span>
<span class="nc" id="L136">    }</span>

    @Test
    public void testByStateDisabled() {
<span class="nc" id="L140">        startInstances(5);</span>

<span class="nc" id="L142">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L143">                .planItemInstanceStateEnabled()</span>
<span class="nc" id="L144">                .list();</span>
<span class="nc" id="L145">        cmmnRuntimeService.disablePlanItemInstance(planItemInstances.get(0).getId());</span>
<span class="nc" id="L146">        cmmnRuntimeService.disablePlanItemInstance(planItemInstances.get(1).getId());</span>

<span class="nc" id="L148">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceStateDisabled().list())</span>
<span class="nc" id="L149">                .hasSize(2)</span>
<span class="nc" id="L150">                .extracting(PlanItemInstance::getName).containsOnly(&quot;B&quot;);</span>
<span class="nc" id="L151">    }</span>

    @Test
    public void testByStateAvailable() {
<span class="nc" id="L155">        startInstances(3);</span>

<span class="nc" id="L157">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L158">                .planItemInstanceStateAvailable()</span>
<span class="nc" id="L159">                .orderByName().asc()</span>
<span class="nc" id="L160">                .list();</span>

<span class="nc" id="L162">        assertThat(planItemInstances)</span>
<span class="nc" id="L163">                .hasSize(3)</span>
<span class="nc" id="L164">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L165">                .containsOnly(&quot;Stage two&quot;);</span>
<span class="nc" id="L166">    }</span>

    @Test
    public void testByStateActive() {
<span class="nc" id="L170">        startInstances(2);</span>

<span class="nc" id="L172">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L173">                .planItemInstanceStateActive()</span>
<span class="nc" id="L174">                .orderByName().asc()</span>
<span class="nc" id="L175">                .list();</span>

<span class="nc" id="L177">        assertThat(planItemInstances)</span>
<span class="nc" id="L178">                .hasSize(4)</span>
<span class="nc" id="L179">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L180">                .containsExactly(&quot;A&quot;, &quot;A&quot;, &quot;Stage one&quot;, &quot;Stage one&quot;);</span>
<span class="nc" id="L181">    }</span>

    @Test
    public void testByStateAndType() {
<span class="nc" id="L185">        startInstances(3);</span>
<span class="nc" id="L186">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L187">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L188">                .planItemDefinitionType(PlanItemDefinitionType.HUMAN_TASK)</span>
<span class="nc" id="L189">                .list()).hasSize(3);</span>

<span class="nc" id="L191">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L192">                .planItemInstanceState(PlanItemInstanceState.ENABLED)</span>
<span class="nc" id="L193">                .planItemDefinitionType(PlanItemDefinitionType.HUMAN_TASK)</span>
<span class="nc" id="L194">                .list()).hasSize(3);</span>
<span class="nc" id="L195">    }</span>

    @Test
    public void testByStateCompleted() {
<span class="nc" id="L199">        startInstances(4);</span>

<span class="nc" id="L201">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().list();</span>
<span class="nc" id="L202">        cmmnTaskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L203">        cmmnTaskService.complete(tasks.get(1).getId());</span>
<span class="nc" id="L204">        cmmnTaskService.complete(tasks.get(3).getId());</span>

<span class="nc" id="L206">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L207">                .planItemInstanceStateCompleted()</span>
<span class="nc" id="L208">                .ended()</span>
<span class="nc" id="L209">                .list();</span>
<span class="nc" id="L210">        assertThat(planItemInstances)</span>
<span class="nc" id="L211">                .hasSize(3)</span>
<span class="nc" id="L212">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L213">                .containsOnly(&quot;A&quot;);</span>

        // includeEnded should also return the same result
<span class="nc" id="L216">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceStateCompleted().includeEnded().list()).hasSize(3);</span>

        // Without ended, should only return runtime plan item instances
<span class="nc" id="L219">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceStateCompleted().list()).isEmpty();</span>
<span class="nc" id="L220">    }</span>

    @Test
    @CmmnDeployment
    public void testByStateTerminated() {
<span class="nc" id="L225">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L226">                .caseDefinitionKey(&quot;testQueryByStateTerminated&quot;).start();</span>

<span class="nc" id="L228">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L229">                .ended()</span>
<span class="nc" id="L230">                .planItemInstanceStateTerminated()</span>
<span class="nc" id="L231">                .list();</span>
<span class="nc" id="L232">        assertThat(planItemInstances).isEmpty();</span>

        // Completing the user event will terminate A/C/Stage for c
<span class="nc" id="L235">        UserEventListenerInstance userEventListenerInstance = cmmnRuntimeService.createUserEventListenerInstanceQuery()</span>
<span class="nc" id="L236">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L237">                .singleResult();</span>
<span class="nc" id="L238">        cmmnRuntimeService.completeUserEventListenerInstance(userEventListenerInstance.getId());</span>

<span class="nc" id="L240">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L241">                .ended()</span>
<span class="nc" id="L242">                .planItemInstanceStateTerminated()</span>
<span class="nc" id="L243">                .orderByName().asc()</span>
<span class="nc" id="L244">                .list();</span>
<span class="nc" id="L245">        assertThat(planItemInstances)</span>
<span class="nc" id="L246">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L247">                .containsExactly(&quot;A&quot;, &quot;C&quot;, &quot;The Stage&quot;);</span>
<span class="nc" id="L248">    }</span>

    @Test
    public void testIncludeEnded() {
<span class="nc" id="L252">        startInstances(11);</span>

<span class="nc" id="L254">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().list();</span>
<span class="nc" id="L255">        cmmnTaskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L256">        cmmnTaskService.complete(tasks.get(1).getId());</span>
<span class="nc" id="L257">        cmmnTaskService.complete(tasks.get(2).getId());</span>
<span class="nc" id="L258">        cmmnTaskService.complete(tasks.get(3).getId());</span>

<span class="nc" id="L260">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).list();</span>
<span class="nc" id="L261">        assertThat(planItemInstances).hasSize(7); // 11 - 4 (runtime only)</span>

<span class="nc" id="L263">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).includeEnded().list();</span>
<span class="nc" id="L264">        assertThat(planItemInstances).hasSize(11);</span>

<span class="nc" id="L266">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).ended().list();</span>
<span class="nc" id="L267">        assertThat(planItemInstances).hasSize(4);</span>
<span class="nc" id="L268">    }</span>

    @Test
    public void testCreatedBefore() {
<span class="nc" id="L272">        Date now = new Date();</span>
<span class="nc" id="L273">        setClockTo(now);</span>
<span class="nc" id="L274">        startInstances(3);</span>
<span class="nc" id="L275">        setClockTo(new Date(now.getTime() + 20000));</span>
<span class="nc" id="L276">        startInstances(4);</span>

<span class="nc" id="L278">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L279">                .planItemInstanceName(&quot;A&quot;)</span>
<span class="nc" id="L280">                .planItemDefinitionType(PlanItemDefinitionType.HUMAN_TASK)</span>
<span class="nc" id="L281">                .planItemInstanceCreatedBefore(new Date(now.getTime() + 10000))</span>
<span class="nc" id="L282">                .list();</span>
<span class="nc" id="L283">        assertThat(planItemInstances).hasSize(3);</span>

<span class="nc" id="L285">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L286">                .planItemInstanceName(&quot;A&quot;)</span>
<span class="nc" id="L287">                .planItemDefinitionType(PlanItemDefinitionType.HUMAN_TASK)</span>
<span class="nc" id="L288">                .planItemInstanceCreatedBefore(new Date(now.getTime() + 30000))</span>
<span class="nc" id="L289">                .list();</span>
<span class="nc" id="L290">        assertThat(planItemInstances).hasSize(7);</span>
<span class="nc" id="L291">    }</span>

    @Test
    public void testCreatedAfter() {
<span class="nc" id="L295">        Date now = new Date();</span>
<span class="nc" id="L296">        setClockTo(now);</span>
<span class="nc" id="L297">        startInstances(2);</span>
<span class="nc" id="L298">        setClockTo(new Date(now.getTime() + 20000));</span>
<span class="nc" id="L299">        startInstances(8);</span>

<span class="nc" id="L301">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L302">                .planItemInstanceName(&quot;A&quot;)</span>
<span class="nc" id="L303">                .planItemDefinitionType(PlanItemDefinitionType.HUMAN_TASK)</span>
<span class="nc" id="L304">                .planItemInstanceCreatedAfter(new Date(now.getTime() - 10000))</span>
<span class="nc" id="L305">                .list();</span>
<span class="nc" id="L306">        assertThat(planItemInstances).hasSize(10);</span>

<span class="nc" id="L308">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L309">                .planItemInstanceName(&quot;A&quot;)</span>
<span class="nc" id="L310">                .planItemDefinitionType(PlanItemDefinitionType.HUMAN_TASK)</span>
<span class="nc" id="L311">                .planItemInstanceCreatedAfter(new Date(now.getTime() + 10000))</span>
<span class="nc" id="L312">                .list();</span>
<span class="nc" id="L313">        assertThat(planItemInstances).hasSize(8);</span>
<span class="nc" id="L314">    }</span>

    @Test
    public void testLastAvailableBeforeAndAfter() {
<span class="nc" id="L318">        Date now = new Date();</span>
<span class="nc" id="L319">        setClockTo(now);</span>
<span class="nc" id="L320">        startInstances(3);</span>
<span class="nc" id="L321">        setClockTo(new Date(now.getTime() + 20000));</span>
<span class="nc" id="L322">        startInstances(5);</span>

<span class="nc" id="L324">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L325">                .planItemInstanceName(&quot;A&quot;)</span>
<span class="nc" id="L326">                .planItemDefinitionType(PlanItemDefinitionType.HUMAN_TASK)</span>
<span class="nc" id="L327">                .planItemInstanceLastAvailableAfter(new Date(now.getTime() - 10000))</span>
<span class="nc" id="L328">                .list();</span>
<span class="nc" id="L329">        assertThat(planItemInstances).hasSize(8);</span>

<span class="nc" id="L331">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L332">                .planItemInstanceName(&quot;A&quot;)</span>
<span class="nc" id="L333">                .planItemDefinitionType(PlanItemDefinitionType.HUMAN_TASK)</span>
<span class="nc" id="L334">                .planItemInstanceLastAvailableBefore(new Date(now.getTime() - 10000))</span>
<span class="nc" id="L335">                .list();</span>
<span class="nc" id="L336">        assertThat(planItemInstances).isEmpty();</span>

<span class="nc" id="L338">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L339">                .planItemInstanceName(&quot;A&quot;)</span>
<span class="nc" id="L340">                .planItemDefinitionType(PlanItemDefinitionType.HUMAN_TASK)</span>
<span class="nc" id="L341">                .planItemInstanceLastAvailableAfter(new Date(now.getTime() + 10000))</span>
<span class="nc" id="L342">                .list();</span>
<span class="nc" id="L343">        assertThat(planItemInstances).hasSize(5);</span>

<span class="nc" id="L345">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L346">                .planItemInstanceName(&quot;A&quot;)</span>
<span class="nc" id="L347">                .planItemDefinitionType(PlanItemDefinitionType.HUMAN_TASK)</span>
<span class="nc" id="L348">                .planItemInstanceLastAvailableBefore(new Date(now.getTime() + 10000))</span>
<span class="nc" id="L349">                .list();</span>
<span class="nc" id="L350">        assertThat(planItemInstances).hasSize(3);</span>
<span class="nc" id="L351">    }</span>

    @Test
    public void testLastEnabledBeforeAndAfter() {
<span class="nc" id="L355">        Date now = new Date();</span>
<span class="nc" id="L356">        setClockTo(now);</span>
<span class="nc" id="L357">        startInstances(2);</span>
<span class="nc" id="L358">        setClockTo(now.getTime() + 10000);</span>
<span class="nc" id="L359">        startInstances(3);</span>

        // Before
<span class="nc" id="L362">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L363">                .planItemInstanceLastEnabledBefore(new Date(now.getTime() + 30000)).list();</span>
<span class="nc" id="L364">        assertThat(planItemInstances).hasSize(5);</span>

<span class="nc" id="L366">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L367">                .planItemInstanceLastEnabledBefore(new Date(now.getTime() + 5000)).list();</span>
<span class="nc" id="L368">        assertThat(planItemInstances).hasSize(2);</span>

<span class="nc" id="L370">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L371">                .planItemInstanceLastEnabledBefore(new Date(now.getTime() - 1000)).list();</span>
<span class="nc" id="L372">        assertThat(planItemInstances).isEmpty();</span>

        // After
<span class="nc" id="L375">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L376">                .planItemInstanceLastEnabledAfter(new Date(now.getTime() - 5000)).list();</span>
<span class="nc" id="L377">        assertThat(planItemInstances).hasSize(5);</span>

<span class="nc" id="L379">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L380">                .planItemInstanceLastEnabledAfter(new Date(now.getTime() + 250000)).list();</span>
<span class="nc" id="L381">        assertThat(planItemInstances).isEmpty();</span>
<span class="nc" id="L382">    }</span>

    @Test
    public void testLastDisabledBeforeAndAfter() {
<span class="nc" id="L386">        Date now = setClockFixedToCurrentTime();</span>
<span class="nc" id="L387">        setClockTo(now);</span>
<span class="nc" id="L388">        startInstances(3);</span>

<span class="nc" id="L390">        String planItemInstanceId = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L391">                .planItemInstanceName(&quot;B&quot;).planItemInstanceStateEnabled().listPage(0, 1).get(0).getId();</span>
<span class="nc" id="L392">        cmmnRuntimeService.disablePlanItemInstance(planItemInstanceId);</span>

<span class="nc" id="L394">        setClockTo(now.getTime() + 10000);</span>
<span class="nc" id="L395">        cmmnRuntimeService.disablePlanItemInstance(cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L396">                .planItemInstanceName(&quot;B&quot;).planItemInstanceStateEnabled().listPage(0, 1).get(0).getId());</span>

        // Before
<span class="nc" id="L399">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastDisabledBefore(new Date(now.getTime() + 20000)).list()).hasSize(2);</span>
<span class="nc" id="L400">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastDisabledBefore(new Date(now.getTime() + 5000)).list()).hasSize(1);</span>
<span class="nc" id="L401">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastDisabledBefore(new Date(now.getTime() - 5000)).list()).isEmpty();</span>

        // After
<span class="nc" id="L404">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastDisabledAfter(new Date(now.getTime())).list()).hasSize(2);</span>
<span class="nc" id="L405">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastDisabledAfter(new Date(now.getTime() + 5000)).list()).hasSize(1);</span>
<span class="nc" id="L406">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastDisabledAfter(new Date(now.getTime() + 11000)).list()).isEmpty();</span>

        // Re-enable and disable
<span class="nc" id="L409">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceId(planItemInstanceId).singleResult();</span>
<span class="nc" id="L410">        Date lastEnabledTime = planItemInstance.getLastEnabledTime();</span>
<span class="nc" id="L411">        assertThat(lastEnabledTime).isNotNull();</span>

<span class="nc" id="L413">        setClockTo(now.getTime() + 30000);</span>
<span class="nc" id="L414">        cmmnRuntimeService.enablePlanItemInstance(planItemInstanceId);</span>
<span class="nc" id="L415">        cmmnRuntimeService.disablePlanItemInstance(planItemInstanceId);</span>

<span class="nc" id="L417">        planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceId(planItemInstanceId).singleResult();</span>
<span class="nc" id="L418">        assertThat(planItemInstance.getLastEnabledTime()).isNotEqualTo(lastEnabledTime);</span>

        // Recheck queries
<span class="nc" id="L421">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastDisabledBefore(new Date(now.getTime() + 20000)).list()).hasSize(1);</span>
<span class="nc" id="L422">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastDisabledBefore(new Date(now.getTime() + 5000)).list()).isEmpty();</span>
<span class="nc" id="L423">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastDisabledAfter(new Date(now.getTime())).list()).hasSize(2);</span>
<span class="nc" id="L424">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastDisabledAfter(new Date(now.getTime() + 15000)).list()).hasSize(1);</span>
<span class="nc" id="L425">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastDisabledAfter(new Date(now.getTime() + 35000)).list()).isEmpty();</span>
<span class="nc" id="L426">    }</span>

    @Test
    public void testLastStartedBeforeAndAfter() {
<span class="nc" id="L430">        Date now = new Date();</span>
<span class="nc" id="L431">        setClockTo(now);</span>
<span class="nc" id="L432">        startInstances(4);</span>

<span class="nc" id="L434">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastStartedAfter(new Date(now.getTime() - 1000)).list()).hasSize(8);</span>
<span class="nc" id="L435">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastStartedAfter(new Date(now.getTime() + 1000)).list()).isEmpty();</span>

<span class="nc" id="L437">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastStartedBefore(new Date(now.getTime() + 1000)).list()).hasSize(8);</span>
<span class="nc" id="L438">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastStartedBefore(new Date(now.getTime() - 1000)).list()).isEmpty();</span>

        // Starting an enabled planitem
<span class="nc" id="L441">        setClockTo(now.getTime() + 10000);</span>
<span class="nc" id="L442">        cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).listPage(0, 2)</span>
<span class="nc" id="L443">                .forEach(p -&gt; cmmnRuntimeService.startPlanItemInstance(p.getId()));</span>

<span class="nc" id="L445">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastStartedAfter(new Date(now.getTime() - 1000)).list()).hasSize(10);</span>
<span class="nc" id="L446">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastStartedAfter(new Date(now.getTime() + 5000)).list()).hasSize(2);</span>
<span class="nc" id="L447">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastStartedAfter(new Date(now.getTime() + 15000)).list()).isEmpty();</span>

<span class="nc" id="L449">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastStartedBefore(new Date(now.getTime() + 1000)).list()).hasSize(8);</span>
<span class="nc" id="L450">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastStartedBefore(new Date(now.getTime() + 15000)).list()).hasSize(10);</span>
<span class="nc" id="L451">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceLastStartedBefore(new Date(now.getTime() - 1000)).list()).isEmpty();</span>

<span class="nc" id="L453">    }</span>

    @Test
    public void testCompletedBeforeAndAfter() {
<span class="nc" id="L457">        startInstances(5);</span>
<span class="nc" id="L458">        Date now = new Date();</span>
<span class="nc" id="L459">        setClockTo(now);</span>

<span class="nc" id="L461">        List&lt;Task&gt; tasks = cmmnTaskService.createTaskQuery().listPage(0, 2);</span>
<span class="nc" id="L462">        setClockTo(now.getTime() + 10000);</span>
<span class="nc" id="L463">        cmmnTaskService.complete(tasks.get(0).getId());</span>
<span class="nc" id="L464">        setClockTo(now.getTime() + 20000);</span>
<span class="nc" id="L465">        cmmnTaskService.complete(tasks.get(1).getId());</span>

        // Completed
<span class="nc" id="L468">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceCompletedBefore(new Date(now.getTime() + 30000)).list()).isEmpty();</span>
<span class="nc" id="L469">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceCompletedBefore(new Date(now.getTime() + 30000)).includeEnded().list())</span>
<span class="nc" id="L470">                .hasSize(2);</span>
<span class="nc" id="L471">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceCompletedBefore(new Date(now.getTime() + 15000)).includeEnded().list())</span>
<span class="nc" id="L472">                .hasSize(1);</span>

<span class="nc" id="L474">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceCompletedAfter(new Date(now.getTime())).list()).isEmpty();</span>
<span class="nc" id="L475">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceCompletedAfter(new Date(now.getTime())).includeEnded().list()).hasSize(2);</span>
<span class="nc" id="L476">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceCompletedAfter(new Date(now.getTime())).ended().list()).hasSize(2);</span>
<span class="nc" id="L477">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceCompletedAfter(new Date(now.getTime() + 15000)).includeEnded().list())</span>
<span class="nc" id="L478">                .hasSize(1);</span>

        // Same queries, but with endedBefore/After
<span class="nc" id="L481">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceEndedBefore(new Date(now.getTime() + 30000)).list()).isEmpty();</span>
<span class="nc" id="L482">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceEndedBefore(new Date(now.getTime() + 30000)).includeEnded().list())</span>
<span class="nc" id="L483">                .hasSize(2);</span>
<span class="nc" id="L484">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceEndedBefore(new Date(now.getTime() + 15000)).includeEnded().list())</span>
<span class="nc" id="L485">                .hasSize(1);</span>

<span class="nc" id="L487">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceEndedAfter(new Date(now.getTime())).list()).isEmpty();</span>
<span class="nc" id="L488">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceEndedAfter(new Date(now.getTime())).includeEnded().list()).hasSize(2);</span>
<span class="nc" id="L489">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceEndedAfter(new Date(now.getTime())).ended().list()).hasSize(2);</span>
<span class="nc" id="L490">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceEndedAfter(new Date(now.getTime() + 15000)).includeEnded().list())</span>
<span class="nc" id="L491">                .hasSize(1);</span>
<span class="nc" id="L492">    }</span>

    @Test
    public void testLastOccurredBeforeAndAfter() {
<span class="nc" id="L496">        Date now = new Date();</span>
<span class="nc" id="L497">        setClockTo(now);</span>
<span class="nc" id="L498">        startInstances(2);</span>

<span class="nc" id="L500">        cmmnRuntimeService.completeStagePlanItemInstance(cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L501">                .planItemInstanceName(&quot;Stage one&quot;).listPage(0, 1).get(0).getId(), true);</span>

<span class="nc" id="L503">        setClockTo(now.getTime() + 10000);</span>
<span class="nc" id="L504">        cmmnRuntimeService.completeStagePlanItemInstance(cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L505">                .planItemInstanceName(&quot;Stage one&quot;).listPage(0, 1).get(0).getId(), true);</span>

        // Occurred (milestone)
<span class="nc" id="L508">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceOccurredAfter(new Date(now.getTime() - 1000)).list()).isEmpty();</span>
<span class="nc" id="L509">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceOccurredAfter(new Date(now.getTime() - 1000)).includeEnded().list())</span>
<span class="nc" id="L510">                .hasSize(2);</span>
<span class="nc" id="L511">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceOccurredAfter(new Date(now.getTime() + 1000)).includeEnded().list())</span>
<span class="nc" id="L512">                .hasSize(1);</span>
<span class="nc" id="L513">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceOccurredAfter(new Date(now.getTime() + 15000)).includeEnded().list())</span>
<span class="nc" id="L514">                .isEmpty();</span>

<span class="nc" id="L516">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceOccurredBefore(new Date(now.getTime() + 20000)).includeEnded().list())</span>
<span class="nc" id="L517">                .hasSize(2);</span>
<span class="nc" id="L518">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceOccurredBefore(new Date(now.getTime() + 5000)).includeEnded().list())</span>
<span class="nc" id="L519">                .hasSize(1);</span>
<span class="nc" id="L520">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceOccurredBefore(new Date(now.getTime() - 1000)).includeEnded().list())</span>
<span class="nc" id="L521">                .isEmpty();</span>
<span class="nc" id="L522">    }</span>

    @Test
    @CmmnDeployment
    public void testExitBeforeAndAfter() {
<span class="nc" id="L527">        Date now = new Date();</span>
<span class="nc" id="L528">        setClockTo(now);</span>

<span class="nc" id="L530">        cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testQueryByStateTerminated&quot;).start();</span>
<span class="nc" id="L531">        UserEventListenerInstance userEventListenerInstance = cmmnRuntimeService.createUserEventListenerInstanceQuery().singleResult();</span>
<span class="nc" id="L532">        cmmnRuntimeService.completeUserEventListenerInstance(userEventListenerInstance.getId());</span>

<span class="nc" id="L534">        setClockTo(now.getTime() + 10000);</span>
<span class="nc" id="L535">        cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testQueryByStateTerminated&quot;).start();</span>
<span class="nc" id="L536">        userEventListenerInstance = cmmnRuntimeService.createUserEventListenerInstanceQuery().singleResult();</span>
<span class="nc" id="L537">        cmmnRuntimeService.completeUserEventListenerInstance(userEventListenerInstance.getId());</span>

        // Terminated before/after
<span class="nc" id="L540">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().planItemInstanceExitAfter(new Date(now.getTime() - 1000)).list()).hasSize(6);</span>
<span class="nc" id="L541">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().planItemInstanceExitAfter(new Date(now.getTime() + 1000)).list()).hasSize(3);</span>
<span class="nc" id="L542">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().planItemInstanceExitAfter(new Date(now.getTime() + 20000)).list())</span>
<span class="nc" id="L543">                .isEmpty();</span>

<span class="nc" id="L545">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().planItemInstanceExitBefore(new Date(now.getTime() - 1000)).list())</span>
<span class="nc" id="L546">                .isEmpty();</span>
<span class="nc" id="L547">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().planItemInstanceExitBefore(new Date(now.getTime() + 1000)).list())</span>
<span class="nc" id="L548">                .hasSize(3);</span>
<span class="nc" id="L549">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().planItemInstanceExitBefore(new Date(now.getTime() + 20000)).list())</span>
<span class="nc" id="L550">                .hasSize(6);</span>

        // Ended before/after
<span class="nc" id="L553">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().planItemInstanceEndedAfter(new Date(now.getTime() - 1000)).list())</span>
<span class="nc" id="L554">                .hasSize(8); // + 2 for user event listener</span>
<span class="nc" id="L555">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().planItemInstanceEndedAfter(new Date(now.getTime() + 1000)).list())</span>
<span class="nc" id="L556">                .hasSize(4);</span>
<span class="nc" id="L557">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().planItemInstanceEndedAfter(new Date(now.getTime() + 20000)).list())</span>
<span class="nc" id="L558">                .isEmpty();</span>

<span class="nc" id="L560">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().planItemInstanceEndedBefore(new Date(now.getTime() - 1000)).list())</span>
<span class="nc" id="L561">                .isEmpty();</span>
<span class="nc" id="L562">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().planItemInstanceEndedBefore(new Date(now.getTime() + 1000)).list())</span>
<span class="nc" id="L563">                .hasSize(4);</span>
<span class="nc" id="L564">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().planItemInstanceEndedBefore(new Date(now.getTime() + 20000)).list())</span>
<span class="nc" id="L565">                .hasSize(8);</span>

<span class="nc" id="L567">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded()</span>
<span class="nc" id="L568">                .planItemDefinitionType(PlanItemDefinitionType.USER_EVENT_LISTENER)</span>
<span class="nc" id="L569">                .planItemInstanceEndedAfter(new Date(now.getTime() - 1000)).list()).hasSize(2);</span>

<span class="nc" id="L571">    }</span>

    @Test
    @CmmnDeployment
    public void testTerminateBeforeAndAfter() {
<span class="nc" id="L576">        Date now = new Date();</span>
<span class="nc" id="L577">        setClockTo(now);</span>
<span class="nc" id="L578">        cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTerminate&quot;).start();</span>

<span class="nc" id="L580">        PlanItemInstance stagePlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L581">                .planItemDefinitionType(PlanItemDefinitionType.STAGE)</span>
<span class="nc" id="L582">                .planItemInstanceName(&quot;The Stage&quot;)</span>
<span class="nc" id="L583">                .singleResult();</span>

<span class="nc" id="L585">        cmmnRuntimeService.terminatePlanItemInstance(stagePlanItemInstance.getId());</span>
<span class="nc" id="L586">        assertThat(cmmnTaskService.createTaskQuery().taskName(&quot;D&quot;).singleResult()).isNotNull();</span>

        // Terminated
<span class="nc" id="L589">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().planItemInstanceTerminatedBefore(new Date(now.getTime() + 1000)).list())</span>
<span class="nc" id="L590">                .hasSize(2); // 2 -&gt; stage and C</span>
<span class="nc" id="L591">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().planItemInstanceTerminatedBefore(new Date(now.getTime() - 1000)).list())</span>
<span class="nc" id="L592">                .isEmpty();</span>

<span class="nc" id="L594">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().planItemInstanceTerminatedAfter(new Date(now.getTime() + 1000)).list())</span>
<span class="nc" id="L595">                .isEmpty();</span>
<span class="nc" id="L596">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().planItemInstanceTerminatedAfter(new Date(now.getTime() - 1000)).list())</span>
<span class="nc" id="L597">                .hasSize(2);</span>

        // Ended
<span class="nc" id="L600">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().planItemInstanceEndedBefore(new Date(now.getTime() + 1000)).list())</span>
<span class="nc" id="L601">                .hasSize(2); // 2 -&gt; stage and C</span>
<span class="nc" id="L602">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().planItemInstanceEndedBefore(new Date(now.getTime() - 1000)).list())</span>
<span class="nc" id="L603">                .isEmpty();</span>

<span class="nc" id="L605">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().planItemInstanceEndedAfter(new Date(now.getTime() + 1000)).list())</span>
<span class="nc" id="L606">                .isEmpty();</span>
<span class="nc" id="L607">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().includeEnded().planItemInstanceEndedAfter(new Date(now.getTime() - 1000)).list())</span>
<span class="nc" id="L608">                .hasSize(2);</span>
<span class="nc" id="L609">    }</span>

    @Test
    @CmmnDeployment
    public void testWaitRepetitionOfNestedStages() {
<span class="nc" id="L614">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L615">                .caseDefinitionKey(&quot;testWaitRepetitionOfNestedStages&quot;)</span>
<span class="nc" id="L616">                .variable(&quot;stage1&quot;, false)</span>
<span class="nc" id="L617">                .variable(&quot;stage11&quot;, false)</span>
<span class="nc" id="L618">                .variable(&quot;stage12&quot;, false)</span>
<span class="nc" id="L619">                .start();</span>

<span class="nc" id="L621">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().list())</span>
<span class="nc" id="L622">                .extracting(PlanItemInstance::getPlanItemDefinitionId, PlanItemInstance::getState)</span>
<span class="nc" id="L623">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L624">                        tuple(&quot;oneexpandedstage1&quot;, &quot;available&quot;),</span>
<span class="nc" id="L625">                        tuple(&quot;oneexpandedstage2&quot;, &quot;available&quot;)</span>
                );

<span class="nc" id="L628">        cmmnRuntimeService.createChangePlanItemStateBuilder()</span>
<span class="nc" id="L629">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L630">                .activatePlanItemDefinitionIds(Arrays.asList(&quot;oneexpandedstage4&quot;))</span>
<span class="nc" id="L631">                .changeState();</span>

<span class="nc" id="L633">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().list())</span>
<span class="nc" id="L634">                .extracting(PlanItemInstance::getPlanItemDefinitionId, PlanItemInstance::getState)</span>
<span class="nc" id="L635">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L636">                        tuple(&quot;oneexpandedstage1&quot;, &quot;active&quot;),</span>
<span class="nc" id="L637">                        tuple(&quot;oneexpandedstage1&quot;, &quot;wait_repetition&quot;),</span>
<span class="nc" id="L638">                        tuple(&quot;oneexpandedstage2&quot;, &quot;available&quot;),</span>
<span class="nc" id="L639">                        tuple(&quot;oneexpandedstage6&quot;, &quot;available&quot;),</span>
<span class="nc" id="L640">                        tuple(&quot;oneexpandedstage4&quot;, &quot;active&quot;),</span>
<span class="nc" id="L641">                        tuple(&quot;oneexpandedstage4&quot;, &quot;wait_repetition&quot;), // FIXME: this plan item instance is missing</span>
<span class="nc" id="L642">                        tuple(&quot;oneeventlistener1&quot;, &quot;available&quot;),</span>
<span class="nc" id="L643">                        tuple(&quot;onehumantask1&quot;, &quot;available&quot;)</span>
                );
<span class="nc" id="L645">    }</span>

    @Test
    public void testLocalization() {
<span class="nc" id="L649">        startInstances(1);</span>

<span class="nc" id="L651">        cmmnEngineConfiguration.setPlanItemLocalizationManager(new PlanItemLocalizationManager() {</span>
            @Override
            public void localize(PlanItemInstance planItemInstance, String locale, boolean withLocalizationFallback) {
<span class="nc bnc" id="L654" title="All 2 branches missed.">                if (&quot;pt&quot;.equals(locale)) {</span>
<span class="nc" id="L655">                    planItemInstance.setLocalizedName(&quot;Plano traduzido&quot;);</span>
                }
<span class="nc" id="L657">            }</span>

            @Override
            public void localize(HistoricPlanItemInstance historicPlanItemInstance, String locale, boolean withLocalizationFallback) {

<span class="nc" id="L662">            }</span>
        });

<span class="nc" id="L665">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().list())</span>
<span class="nc" id="L666">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L667">                .containsExactlyInAnyOrder(</span>
                        &quot;Stage one&quot;,
                        &quot;Stage two&quot;,
                        &quot;A&quot;,
                        &quot;B&quot;
                );

<span class="nc" id="L674">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().locale(&quot;pt&quot;).list())</span>
<span class="nc" id="L675">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L676">                .containsExactlyInAnyOrder(</span>
                        &quot;Plano traduzido&quot;,
                        &quot;Plano traduzido&quot;,
                        &quot;Plano traduzido&quot;,
                        &quot;Plano traduzido&quot;
                );
<span class="nc" id="L682">    }</span>

    public void testQueryVariableValueEqualsAndNotEquals() {
<span class="nc" id="L685">        CaseInstance caseWithStringValue = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L686">                .caseDefinitionKey(&quot;testPlanItemInstanceQuery&quot;)</span>
<span class="nc" id="L687">                .name(&quot;With string value&quot;)</span>
<span class="nc" id="L688">                .start();</span>

<span class="nc" id="L690">        CaseInstance caseWithNullValue = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L691">                .caseDefinitionKey(&quot;testPlanItemInstanceQuery&quot;)</span>
<span class="nc" id="L692">                .name(&quot;With null value&quot;)</span>
<span class="nc" id="L693">                .start();</span>

<span class="nc" id="L695">        CaseInstance caseWithLongValue = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L696">                .caseDefinitionKey(&quot;testPlanItemInstanceQuery&quot;)</span>
<span class="nc" id="L697">                .name(&quot;With long value&quot;)</span>
<span class="nc" id="L698">                .start();</span>

<span class="nc" id="L700">        CaseInstance caseWithDoubleValue = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L701">                .caseDefinitionKey(&quot;testPlanItemInstanceQuery&quot;)</span>
<span class="nc" id="L702">                .name(&quot;With double value&quot;)</span>
<span class="nc" id="L703">                .start();</span>

<span class="nc" id="L705">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;Stage one&quot;).list())</span>
<span class="nc" id="L706">                .hasSize(4);</span>

<span class="nc" id="L708">        PlanItemInstance planItemWithStringValue = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L709">                .caseInstanceId(caseWithStringValue.getId())</span>
<span class="nc" id="L710">                .planItemInstanceName(&quot;Stage one&quot;)</span>
<span class="nc" id="L711">                .singleResult();</span>

<span class="nc" id="L713">        assertThat(planItemWithStringValue).isNotNull();</span>

<span class="nc" id="L715">        PlanItemInstance planItemWithNullValue = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L716">                .caseInstanceId(caseWithNullValue.getId())</span>
<span class="nc" id="L717">                .planItemInstanceName(&quot;Stage one&quot;)</span>
<span class="nc" id="L718">                .singleResult();</span>

<span class="nc" id="L720">        assertThat(planItemWithNullValue).isNotNull();</span>

<span class="nc" id="L722">        PlanItemInstance planItemWithLongValue = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L723">                .caseInstanceId(caseWithLongValue.getId())</span>
<span class="nc" id="L724">                .planItemInstanceName(&quot;Stage one&quot;)</span>
<span class="nc" id="L725">                .singleResult();</span>

<span class="nc" id="L727">        assertThat(planItemWithLongValue).isNotNull();</span>

<span class="nc" id="L729">        PlanItemInstance planItemWithDoubleValue = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L730">                .caseInstanceId(caseWithDoubleValue.getId())</span>
<span class="nc" id="L731">                .planItemInstanceName(&quot;Stage one&quot;)</span>
<span class="nc" id="L732">                .singleResult();</span>

<span class="nc" id="L734">        assertThat(planItemWithDoubleValue).isNotNull();</span>

<span class="nc" id="L736">        assertThat(cmmnRuntimeService.hasLocalVariable(planItemWithStringValue.getId(), &quot;var&quot;)).isFalse();</span>
<span class="nc" id="L737">        cmmnRuntimeService.setLocalVariable(planItemWithStringValue.getId(), &quot;var&quot;, &quot;TEST&quot;);</span>
<span class="nc" id="L738">        assertThat(cmmnRuntimeService.hasLocalVariable(planItemWithStringValue.getId(), &quot;var&quot;)).isTrue();</span>
<span class="nc" id="L739">        cmmnRuntimeService.setLocalVariable(planItemWithNullValue.getId(), &quot;var&quot;, null);</span>
<span class="nc" id="L740">        cmmnRuntimeService.setLocalVariable(planItemWithLongValue.getId(), &quot;var&quot;, 100L);</span>
<span class="nc" id="L741">        cmmnRuntimeService.setLocalVariable(planItemWithDoubleValue.getId(), &quot;var&quot;, 45.55);</span>

<span class="nc" id="L743">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueNotEquals(&quot;var&quot;, &quot;TEST&quot;).list())</span>
<span class="nc" id="L744">                .extracting(PlanItemInstance::getName, PlanItemInstance::getCaseInstanceId)</span>
<span class="nc" id="L745">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L746">                        tuple(&quot;Stage one&quot;, caseWithNullValue.getId()),</span>
<span class="nc" id="L747">                        tuple(&quot;Stage one&quot;, caseWithLongValue.getId()),</span>
<span class="nc" id="L748">                        tuple(&quot;Stage one&quot;, caseWithDoubleValue.getId())</span>
                );

<span class="nc" id="L751">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueEquals(&quot;var&quot;, &quot;TEST&quot;).list())</span>
<span class="nc" id="L752">                .extracting(PlanItemInstance::getName, PlanItemInstance::getCaseInstanceId)</span>
<span class="nc" id="L753">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L754">                        tuple(&quot;Stage one&quot;, caseWithStringValue.getId())</span>
                );

<span class="nc" id="L757">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueNotEquals(&quot;var&quot;, 100L).list())</span>
<span class="nc" id="L758">                .extracting(PlanItemInstance::getName, PlanItemInstance::getCaseInstanceId)</span>
<span class="nc" id="L759">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L760">                        tuple(&quot;Stage one&quot;, caseWithStringValue.getId()),</span>
<span class="nc" id="L761">                        tuple(&quot;Stage one&quot;, caseWithNullValue.getId()),</span>
<span class="nc" id="L762">                        tuple(&quot;Stage one&quot;, caseWithDoubleValue.getId())</span>
                );

<span class="nc" id="L765">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueEquals(&quot;var&quot;, 100L).list())</span>
<span class="nc" id="L766">                .extracting(PlanItemInstance::getName, PlanItemInstance::getCaseInstanceId)</span>
<span class="nc" id="L767">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L768">                        tuple(&quot;Stage one&quot;, caseWithLongValue.getId())</span>
                );

<span class="nc" id="L771">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueNotEquals(&quot;var&quot;, 45.55).list())</span>
<span class="nc" id="L772">                .extracting(PlanItemInstance::getName, PlanItemInstance::getCaseInstanceId)</span>
<span class="nc" id="L773">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L774">                        tuple(&quot;Stage one&quot;, caseWithStringValue.getId()),</span>
<span class="nc" id="L775">                        tuple(&quot;Stage one&quot;, caseWithNullValue.getId()),</span>
<span class="nc" id="L776">                        tuple(&quot;Stage one&quot;, caseWithLongValue.getId())</span>
                );

<span class="nc" id="L779">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueEquals(&quot;var&quot;, 45.55).list())</span>
<span class="nc" id="L780">                .extracting(PlanItemInstance::getName, PlanItemInstance::getCaseInstanceId)</span>
<span class="nc" id="L781">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L782">                        tuple(&quot;Stage one&quot;, caseWithDoubleValue.getId())</span>
                );

<span class="nc" id="L785">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueNotEquals(&quot;var&quot;, &quot;test&quot;).list())</span>
<span class="nc" id="L786">                .extracting(PlanItemInstance::getName, PlanItemInstance::getCaseInstanceId)</span>
<span class="nc" id="L787">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L788">                        tuple(&quot;Stage one&quot;, caseWithStringValue.getId()),</span>
<span class="nc" id="L789">                        tuple(&quot;Stage one&quot;, caseWithNullValue.getId()),</span>
<span class="nc" id="L790">                        tuple(&quot;Stage one&quot;, caseWithLongValue.getId()),</span>
<span class="nc" id="L791">                        tuple(&quot;Stage one&quot;, caseWithDoubleValue.getId())</span>
                );

<span class="nc" id="L794">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueNotEqualsIgnoreCase(&quot;var&quot;, &quot;test&quot;).list())</span>
<span class="nc" id="L795">                .extracting(PlanItemInstance::getName, PlanItemInstance::getCaseInstanceId)</span>
<span class="nc" id="L796">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L797">                        tuple(&quot;Stage one&quot;, caseWithNullValue.getId()),</span>
<span class="nc" id="L798">                        tuple(&quot;Stage one&quot;, caseWithLongValue.getId()),</span>
<span class="nc" id="L799">                        tuple(&quot;Stage one&quot;, caseWithDoubleValue.getId())</span>
                );

<span class="nc" id="L802">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueEquals(&quot;var&quot;, &quot;test&quot;).list())</span>
<span class="nc" id="L803">                .extracting(PlanItemInstance::getName, PlanItemInstance::getCaseInstanceId)</span>
<span class="nc" id="L804">                .isEmpty();</span>

<span class="nc" id="L806">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueEqualsIgnoreCase(&quot;var&quot;, &quot;test&quot;).list())</span>
<span class="nc" id="L807">                .extracting(PlanItemInstance::getName, PlanItemInstance::getCaseInstanceId)</span>
<span class="nc" id="L808">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L809">                        tuple(&quot;Stage one&quot;, caseWithStringValue.getId())</span>
                );
<span class="nc" id="L811">    }</span>

    private List&lt;String&gt; startInstances(int numberOfInstances) {
<span class="nc" id="L814">        List&lt;String&gt; caseInstanceIds = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L815" title="All 2 branches missed.">        for (int i = 0; i &lt; numberOfInstances; i++) {</span>
<span class="nc" id="L816">            caseInstanceIds.add(cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testPlanItemInstanceQuery&quot;).start().getId());</span>
        }
<span class="nc" id="L818">        return caseInstanceIds;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>