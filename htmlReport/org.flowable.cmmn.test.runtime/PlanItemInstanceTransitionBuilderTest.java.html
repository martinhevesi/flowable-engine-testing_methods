<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PlanItemInstanceTransitionBuilderTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.cmmn.test.runtime</a> &gt; <span class="el_source">PlanItemInstanceTransitionBuilderTest.java</span></div><h1>PlanItemInstanceTransitionBuilderTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.cmmn.test.runtime;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.assertj.core.api.Assertions.entry;

import java.util.Collections;

import org.flowable.cmmn.api.runtime.CaseInstance;
import org.flowable.cmmn.api.runtime.PlanItemDefinitionType;
import org.flowable.cmmn.api.runtime.PlanItemInstance;
import org.flowable.cmmn.api.runtime.PlanItemInstanceState;
import org.flowable.cmmn.engine.test.CmmnDeployment;
import org.flowable.cmmn.engine.test.FlowableCmmnTestCase;
import org.flowable.common.engine.api.FlowableIllegalArgumentException;
import org.flowable.common.engine.api.FlowableIllegalStateException;
import org.flowable.common.engine.impl.util.CollectionUtil;
import org.flowable.form.api.FormInfo;
import org.junit.Test;

/**
 * @author Joram Barrez
 */
<span class="nc" id="L36">public class PlanItemInstanceTransitionBuilderTest extends FlowableCmmnTestCase {</span>

    @Test
    @CmmnDeployment
    public void testTrigger() {
<span class="nc" id="L41">        cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>
<span class="nc" id="L42">        assertThat(cmmnTaskService.createTaskQuery().taskName(&quot;A&quot;).singleResult()).isNotNull();</span>

<span class="nc" id="L44">        PlanItemInstance planItemInstanceA = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).singleResult();</span>
<span class="nc" id="L45">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId())</span>
<span class="nc" id="L46">                .trigger();</span>

<span class="nc" id="L48">        assertThat(cmmnTaskService.createTaskQuery().taskName(&quot;A&quot;).singleResult()).isNull();</span>
<span class="nc" id="L49">    }</span>

    @Test
    @CmmnDeployment
    public void testInvalidTrigger() {
<span class="nc" id="L54">        cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>

<span class="nc" id="L56">        PlanItemInstance planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>

<span class="nc" id="L58">        assertThatThrownBy(() -&gt;  cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceB.getId()).trigger())</span>
<span class="nc" id="L59">            .isInstanceOf(FlowableIllegalStateException.class);</span>
<span class="nc" id="L60">    }</span>

    @Test
    @CmmnDeployment
    public void testInvalidTriggerEventListener() {
<span class="nc" id="L65">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>

<span class="nc" id="L67">        PlanItemInstance eventListenerPlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L68">            .planItemDefinitionType(PlanItemDefinitionType.GENERIC_EVENT_LISTENER).singleResult();</span>
<span class="nc" id="L69">        assertThat(eventListenerPlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.UNAVAILABLE);</span>

<span class="nc" id="L71">        assertThatThrownBy(() -&gt;  cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(eventListenerPlanItemInstance.getId()).trigger())</span>
<span class="nc" id="L72">            .isInstanceOf(FlowableIllegalStateException.class);</span>
<span class="nc" id="L73">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/runtime/PlanItemInstanceTransitionBuilderTest.testTrigger.cmmn&quot;)
    public void testInvalidTriggerWithChildTaskInfo() {
<span class="nc" id="L78">        cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>

<span class="nc" id="L80">        PlanItemInstance planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>

<span class="nc" id="L82">        assertThatThrownBy(() -&gt;  cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceB.getId()).childTaskVariable(&quot;testVar&quot;, &quot;Test&quot;).trigger())</span>
<span class="nc" id="L83">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L84">                .hasMessage(&quot;Child task variables can only be set when starting a plan item instance&quot;);</span>

<span class="nc" id="L86">        assertThatThrownBy(() -&gt;  cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceB.getId()).childTaskVariables(Collections.singletonMap(&quot;testVar&quot;, &quot;Test&quot;)).trigger())</span>
<span class="nc" id="L87">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L88">                .hasMessage(&quot;Child task variables can only be set when starting a plan item instance&quot;);</span>

<span class="nc" id="L90">        assertThatThrownBy(() -&gt;  cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceB.getId()).childTaskFormVariables(Collections.singletonMap(&quot;testVar&quot;, &quot;Test&quot;), new FormInfo(), &quot;test&quot;).trigger())</span>
<span class="nc" id="L91">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L92">                .hasMessage(&quot;Child form variables can only be set when starting a plan item instance&quot;);</span>
<span class="nc" id="L93">    }</span>

    @Test
    @CmmnDeployment
    public void testTriggerWithVariables() {
<span class="nc" id="L98">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>
<span class="nc" id="L99">        assertThat(cmmnTaskService.createTaskQuery().taskName(&quot;A&quot;).singleResult()).isNotNull();</span>

<span class="nc" id="L101">        PlanItemInstance planItemInstanceA = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).singleResult();</span>
<span class="nc" id="L102">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId())</span>
<span class="nc" id="L103">                .variables(CollectionUtil.map(&quot;var1&quot;, 123, &quot;var2&quot;, 456))</span>
<span class="nc" id="L104">                .trigger();</span>

<span class="nc" id="L106">        assertThat(cmmnTaskService.createTaskQuery().taskName(&quot;A&quot;).singleResult()).isNull();</span>
<span class="nc" id="L107">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId()))</span>
<span class="nc" id="L108">                .containsOnly(</span>
<span class="nc" id="L109">                        entry(&quot;var1&quot;, 123),</span>
<span class="nc" id="L110">                        entry(&quot;var2&quot;, 456)</span>
                );
<span class="nc" id="L112">    }</span>

    @Test
    @CmmnDeployment
    public void testTriggerWithVariable() {
<span class="nc" id="L117">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>
<span class="nc" id="L118">        assertThat(cmmnTaskService.createTaskQuery().taskName(&quot;A&quot;).singleResult()).isNotNull();</span>

<span class="nc" id="L120">        PlanItemInstance planItemInstanceA = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).singleResult();</span>
<span class="nc" id="L121">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId())</span>
<span class="nc" id="L122">                .variable(&quot;var1&quot;, 123)</span>
<span class="nc" id="L123">                .variable(&quot;var2&quot;, 456)</span>
<span class="nc" id="L124">                .trigger();</span>

<span class="nc" id="L126">        assertThat(cmmnTaskService.createTaskQuery().taskName(&quot;A&quot;).singleResult()).isNull();</span>
<span class="nc" id="L127">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId()))</span>
<span class="nc" id="L128">                .containsOnly(</span>
<span class="nc" id="L129">                        entry(&quot;var1&quot;, 123),</span>
<span class="nc" id="L130">                        entry(&quot;var2&quot;, 456)</span>
                );
<span class="nc" id="L132">    }</span>

    @Test
    @CmmnDeployment
    public void testTriggerWithTransientVariables() {
<span class="nc" id="L137">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>
<span class="nc" id="L138">        assertThat(cmmnTaskService.createTaskQuery().taskName(&quot;A&quot;).singleResult()).isNotNull();</span>

<span class="nc" id="L140">        PlanItemInstance planItemInstanceA = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).singleResult();</span>
<span class="nc" id="L141">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId())</span>
<span class="nc" id="L142">                .transientVariables(CollectionUtil.map(&quot;sentryVar&quot;, true, &quot;otherVar&quot;, 123456))</span>
<span class="nc" id="L143">                .trigger();</span>

<span class="nc" id="L145">        assertThat(cmmnTaskService.createTaskQuery().taskName(&quot;A&quot;).singleResult()).isNull();</span>
<span class="nc" id="L146">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId())).isEmpty();</span>

        // Transient variable should have triggered the sentry
<span class="nc" id="L149">        assertThat(cmmnTaskService.createTaskQuery().taskName(&quot;D&quot;).singleResult()).isNotNull();</span>
<span class="nc" id="L150">    }</span>

    @Test
    @CmmnDeployment
    public void testTriggerWithTransientVariable() {
<span class="nc" id="L155">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>
<span class="nc" id="L156">        assertThat(cmmnTaskService.createTaskQuery().taskName(&quot;A&quot;).singleResult()).isNotNull();</span>

<span class="nc" id="L158">        PlanItemInstance planItemInstanceA = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).singleResult();</span>
<span class="nc" id="L159">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId())</span>
<span class="nc" id="L160">                .transientVariable(&quot;sentryVar&quot;, true)</span>
<span class="nc" id="L161">                .transientVariable(&quot;otherVar&quot;, 123456)</span>
<span class="nc" id="L162">                .trigger();</span>

<span class="nc" id="L164">        assertThat(cmmnTaskService.createTaskQuery().taskName(&quot;A&quot;).singleResult()).isNull();</span>
<span class="nc" id="L165">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId())).isEmpty();</span>

        // Transient variable should have triggered the sentry
<span class="nc" id="L168">        assertThat(cmmnTaskService.createTaskQuery().taskName(&quot;D&quot;).singleResult()).isNotNull();</span>
<span class="nc" id="L169">    }</span>

    @Test
    @CmmnDeployment
    public void testEnable() {
<span class="nc" id="L174">        cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>

<span class="nc" id="L176">        PlanItemInstance planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L177">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceB.getId()).enable();</span>

<span class="nc" id="L179">        planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L180">        assertThat(planItemInstanceB.getState()).isEqualTo(PlanItemInstanceState.ENABLED);</span>
<span class="nc" id="L181">    }</span>

    @Test
    @CmmnDeployment
    public void testInvalidEnable() {
<span class="nc" id="L186">        cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>

<span class="nc" id="L188">        PlanItemInstance planItemInstanceA = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).singleResult();</span>

<span class="nc" id="L190">        assertThatThrownBy(() -&gt;  cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId()).enable())</span>
<span class="nc" id="L191">            .isInstanceOf(FlowableIllegalStateException.class);</span>
<span class="nc" id="L192">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/runtime/PlanItemInstanceTransitionBuilderTest.testEnable.cmmn&quot;)
    public void testInvalidEnableWithChildTaskInfo() {
<span class="nc" id="L197">        cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>

<span class="nc" id="L199">        PlanItemInstance planItemInstanceA = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).singleResult();</span>

<span class="nc" id="L201">        assertThatThrownBy(() -&gt;  cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId()).childTaskVariable(&quot;testVar&quot;, &quot;Test&quot;).enable())</span>
<span class="nc" id="L202">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L203">                .hasMessage(&quot;Child task variables can only be set when starting a plan item instance&quot;);</span>

<span class="nc" id="L205">        assertThatThrownBy(() -&gt;  cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId()).childTaskVariables(Collections.singletonMap(&quot;testVar&quot;, &quot;Test&quot;)).enable())</span>
<span class="nc" id="L206">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L207">                .hasMessage(&quot;Child task variables can only be set when starting a plan item instance&quot;);</span>

<span class="nc" id="L209">        assertThatThrownBy(() -&gt;  cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId()).childTaskFormVariables(Collections.singletonMap(&quot;testVar&quot;, &quot;Test&quot;), new FormInfo(), &quot;test&quot;).enable())</span>
<span class="nc" id="L210">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L211">                .hasMessage(&quot;Child form variables can only be set when starting a plan item instance&quot;);</span>
<span class="nc" id="L212">    }</span>

    @Test
    @CmmnDeployment
    public void testEnableWithVariable() {
<span class="nc" id="L217">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>

<span class="nc" id="L219">        PlanItemInstance planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L220">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceB.getId())</span>
<span class="nc" id="L221">                .variable(&quot;var1&quot;, &quot;hello&quot;)</span>
<span class="nc" id="L222">                .variable(&quot;var2&quot;, &quot;world&quot;)</span>
<span class="nc" id="L223">                .enable();</span>

<span class="nc" id="L225">        planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L226">        assertThat(planItemInstanceB.getState()).isEqualTo(PlanItemInstanceState.ENABLED);</span>

<span class="nc" id="L228">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId()))</span>
<span class="nc" id="L229">                .containsOnly(</span>
<span class="nc" id="L230">                        entry(&quot;var1&quot;, &quot;hello&quot;),</span>
<span class="nc" id="L231">                        entry(&quot;var2&quot;, &quot;world&quot;)</span>
                );
<span class="nc" id="L233">    }</span>

    @Test
    @CmmnDeployment
    public void testEnableWithVariables() {
<span class="nc" id="L238">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>

<span class="nc" id="L240">        PlanItemInstance planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L241">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceB.getId())</span>
<span class="nc" id="L242">                .variables(CollectionUtil.map(&quot;var1&quot;, &quot;hello&quot;, &quot;var2&quot;, &quot;world&quot;))</span>
<span class="nc" id="L243">                .enable();</span>

<span class="nc" id="L245">        planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L246">        assertThat(planItemInstanceB.getState()).isEqualTo(PlanItemInstanceState.ENABLED);</span>

<span class="nc" id="L248">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId()))</span>
<span class="nc" id="L249">                .containsOnly(</span>
<span class="nc" id="L250">                        entry(&quot;var1&quot;, &quot;hello&quot;),</span>
<span class="nc" id="L251">                        entry(&quot;var2&quot;, &quot;world&quot;)</span>
                );
<span class="nc" id="L253">    }</span>

    @Test
    @CmmnDeployment
    public void testEnableWithLocalVariable() {
<span class="nc" id="L258">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>

<span class="nc" id="L260">        PlanItemInstance planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L261">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceB.getId())</span>
<span class="nc" id="L262">                .localVariable(&quot;localVariable&quot;, &quot;hello&quot;)</span>
<span class="nc" id="L263">                .variable(&quot;caseInstanceVar&quot;, &quot;world&quot;)</span>
<span class="nc" id="L264">                .enable();</span>

<span class="nc" id="L266">        planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L267">        assertThat(planItemInstanceB.getState()).isEqualTo(PlanItemInstanceState.ENABLED);</span>

<span class="nc" id="L269">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId()))</span>
<span class="nc" id="L270">                .containsOnly(</span>
<span class="nc" id="L271">                        entry(&quot;caseInstanceVar&quot;, &quot;world&quot;)</span>
                );
<span class="nc" id="L273">    }</span>

    @Test
    @CmmnDeployment
    public void testEnableWithTransientVariable() {
<span class="nc" id="L278">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>

<span class="nc" id="L280">        PlanItemInstance planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L281">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceB.getId())</span>
<span class="nc" id="L282">                .transientVariable(&quot;sentryVar&quot;, true)</span>
<span class="nc" id="L283">                .transientVariable(&quot;otherVar&quot;, 123)</span>
<span class="nc" id="L284">                .enable();</span>

<span class="nc" id="L286">        planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L287">        assertThat(planItemInstanceB.getState()).isEqualTo(PlanItemInstanceState.ENABLED);</span>

<span class="nc" id="L289">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId())).isEmpty();</span>
<span class="nc" id="L290">        assertThat(cmmnTaskService.createTaskQuery().taskName(&quot;D&quot;).singleResult()).isNotNull();</span>
<span class="nc" id="L291">    }</span>

    @Test
    @CmmnDeployment
    public void testEnableWithTransientVariables() {
<span class="nc" id="L296">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>

<span class="nc" id="L298">        PlanItemInstance planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L299">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceB.getId())</span>
<span class="nc" id="L300">                .transientVariables(CollectionUtil.map(&quot;sentryVar&quot;, true, &quot;otherVar&quot;, 123))</span>
<span class="nc" id="L301">                .variable(&quot;persistentVar&quot;, 456)</span>
<span class="nc" id="L302">                .enable();</span>

<span class="nc" id="L304">        planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L305">        assertThat(planItemInstanceB.getState()).isEqualTo(PlanItemInstanceState.ENABLED);</span>

<span class="nc" id="L307">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId())).containsOnly(</span>
<span class="nc" id="L308">                entry(&quot;persistentVar&quot;, 456)</span>
        );
<span class="nc" id="L310">        assertThat(cmmnTaskService.createTaskQuery().taskName(&quot;D&quot;).singleResult()).isNotNull();</span>
<span class="nc" id="L311">    }</span>

    @Test
    @CmmnDeployment
    public void testDisable() {
<span class="nc" id="L316">        cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>

        // Need to enable before disabling
<span class="nc" id="L319">        PlanItemInstance planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L320">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceB.getId()).enable();</span>

<span class="nc" id="L322">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceB.getId()).disable();</span>

<span class="nc" id="L324">        planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L325">        assertThat(planItemInstanceB.getState()).isEqualTo(PlanItemInstanceState.DISABLED);</span>
<span class="nc" id="L326">    }</span>

    @Test
    @CmmnDeployment
    public void testInvalidDisable() {
<span class="nc" id="L331">        cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>

<span class="nc" id="L333">        PlanItemInstance planItemInstanceA = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).singleResult();</span>

<span class="nc" id="L335">        assertThatThrownBy(() -&gt;  cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId()).disable())</span>
<span class="nc" id="L336">            .isInstanceOf(FlowableIllegalStateException.class);</span>
<span class="nc" id="L337">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/runtime/PlanItemInstanceTransitionBuilderTest.testDisable.cmmn&quot;)
    public void testInvalidDisableWithChildTaskInfo() {
<span class="nc" id="L342">        cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>

<span class="nc" id="L344">        PlanItemInstance planItemInstanceA = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).singleResult();</span>

<span class="nc" id="L346">        assertThatThrownBy(() -&gt;  cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId()).childTaskVariable(&quot;testVar&quot;, &quot;Test&quot;).disable())</span>
<span class="nc" id="L347">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L348">                .hasMessage(&quot;Child task variables can only be set when starting a plan item instance&quot;);</span>

<span class="nc" id="L350">        assertThatThrownBy(() -&gt;  cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId()).childTaskVariables(Collections.singletonMap(&quot;testVar&quot;, &quot;Test&quot;)).disable())</span>
<span class="nc" id="L351">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L352">                .hasMessage(&quot;Child task variables can only be set when starting a plan item instance&quot;);</span>

<span class="nc" id="L354">        assertThatThrownBy(() -&gt;  cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId()).childTaskFormVariables(Collections.singletonMap(&quot;testVar&quot;, &quot;Test&quot;), new FormInfo(), &quot;test&quot;).disable())</span>
<span class="nc" id="L355">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L356">                .hasMessage(&quot;Child form variables can only be set when starting a plan item instance&quot;);</span>
<span class="nc" id="L357">    }</span>

    @Test
    @CmmnDeployment
    public void testDisableWithVariable() {
<span class="nc" id="L362">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>

        // Need to enable before disabling
<span class="nc" id="L365">        PlanItemInstance planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L366">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceB.getId()).enable();</span>

<span class="nc" id="L368">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceB.getId())</span>
<span class="nc" id="L369">                .variable(&quot;var1&quot;, &quot;test&quot;)</span>
<span class="nc" id="L370">                .disable();</span>

<span class="nc" id="L372">        planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L373">        assertThat(planItemInstanceB.getState()).isEqualTo(PlanItemInstanceState.DISABLED);</span>

<span class="nc" id="L375">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId())).containsOnly(</span>
<span class="nc" id="L376">                entry(&quot;var1&quot;, &quot;test&quot;)</span>
        );
<span class="nc" id="L378">    }</span>

    @Test
    @CmmnDeployment
    public void testDisableWithVariables() {
<span class="nc" id="L383">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>

        // Need to enable before disabling
<span class="nc" id="L386">        PlanItemInstance planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L387">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceB.getId()).enable();</span>

<span class="nc" id="L389">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceB.getId())</span>
<span class="nc" id="L390">                .variables(CollectionUtil.map(&quot;var1&quot;, &quot;test&quot;, &quot;var2&quot;, &quot;anotherTest&quot;))</span>
<span class="nc" id="L391">                .disable();</span>

<span class="nc" id="L393">        planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L394">        assertThat(planItemInstanceB.getState()).isEqualTo(PlanItemInstanceState.DISABLED);</span>

<span class="nc" id="L396">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId()))</span>
<span class="nc" id="L397">                .containsOnly(</span>
<span class="nc" id="L398">                        entry(&quot;var1&quot;, &quot;test&quot;),</span>
<span class="nc" id="L399">                        entry(&quot;var2&quot;, &quot;anotherTest&quot;)</span>
                );
<span class="nc" id="L401">    }</span>

    @Test
    @CmmnDeployment
    public void testDisableWithTransientVariable() {
<span class="nc" id="L406">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>
<span class="nc" id="L407">        PlanItemInstance planItemInstanceD = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;D&quot;).singleResult();</span>
<span class="nc" id="L408">        assertThat(planItemInstanceD.getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>

        // Need to enable before disabling
<span class="nc" id="L411">        PlanItemInstance planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L412">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceB.getId()).enable();</span>

<span class="nc" id="L414">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceB.getId())</span>
<span class="nc" id="L415">                .variables(CollectionUtil.map(&quot;var1&quot;, &quot;test&quot;, &quot;var2&quot;, &quot;anotherTest&quot;))</span>
<span class="nc" id="L416">                .transientVariable(&quot;sentryVar&quot;, true)</span>
<span class="nc" id="L417">                .disable();</span>

<span class="nc" id="L419">        planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L420">        assertThat(planItemInstanceB.getState()).isEqualTo(PlanItemInstanceState.DISABLED);</span>

<span class="nc" id="L422">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId()))</span>
<span class="nc" id="L423">                .containsOnly(</span>
<span class="nc" id="L424">                        entry(&quot;var1&quot;, &quot;test&quot;),</span>
<span class="nc" id="L425">                        entry(&quot;var2&quot;, &quot;anotherTest&quot;)</span>
                );

<span class="nc" id="L428">        planItemInstanceD = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;D&quot;).singleResult();</span>
<span class="nc" id="L429">        assertThat(planItemInstanceD.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L430">    }</span>

    @Test
    @CmmnDeployment
    public void testDisableWithTransientVariables() {
<span class="nc" id="L435">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>
<span class="nc" id="L436">        PlanItemInstance planItemInstanceD = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;D&quot;).singleResult();</span>
<span class="nc" id="L437">        assertThat(planItemInstanceD.getState()).isEqualTo(PlanItemInstanceState.AVAILABLE);</span>

        // Need to enable before disabling
<span class="nc" id="L440">        PlanItemInstance planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L441">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceB.getId()).enable();</span>

<span class="nc" id="L443">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceB.getId())</span>
<span class="nc" id="L444">                .transientVariables(CollectionUtil.map(&quot;sentryVar&quot;, true, &quot;otherVar&quot;, &quot;test&quot;))</span>
<span class="nc" id="L445">                .disable();</span>

<span class="nc" id="L447">        planItemInstanceB = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;B&quot;).singleResult();</span>
<span class="nc" id="L448">        assertThat(planItemInstanceB.getState()).isEqualTo(PlanItemInstanceState.DISABLED);</span>

<span class="nc" id="L450">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId())).isEmpty();</span>

<span class="nc" id="L452">        planItemInstanceD = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;D&quot;).singleResult();</span>
<span class="nc" id="L453">        assertThat(planItemInstanceD.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L454">    }</span>

    @Test
    @CmmnDeployment
    public void testTerminate() {
<span class="nc" id="L459">        cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>

<span class="nc" id="L461">        PlanItemInstance planItemInstanceA = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).singleResult();</span>
<span class="nc" id="L462">        assertThat(planItemInstanceA.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L463">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().count()).isEqualTo(5);</span>

<span class="nc" id="L465">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId()).terminate();</span>
<span class="nc" id="L466">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().count()).isEqualTo(4);</span>

<span class="nc" id="L468">        planItemInstanceA = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).includeEnded().singleResult();</span>
<span class="nc" id="L469">        assertThat(planItemInstanceA.getState()).isEqualTo(PlanItemInstanceState.TERMINATED);</span>
<span class="nc" id="L470">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/runtime/PlanItemInstanceTransitionBuilderTest.testTerminate.cmmn&quot;)
    public void testInvalidTerminateWithChildTaskInfo() {
<span class="nc" id="L475">        cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>

<span class="nc" id="L477">        PlanItemInstance planItemInstanceA = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).singleResult();</span>

<span class="nc" id="L479">        assertThatThrownBy(() -&gt;  cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId()).childTaskVariable(&quot;testVar&quot;, &quot;Test&quot;).terminate())</span>
<span class="nc" id="L480">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L481">                .hasMessage(&quot;Child task variables can only be set when starting a plan item instance&quot;);</span>

<span class="nc" id="L483">        assertThatThrownBy(() -&gt;  cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId()).childTaskVariables(Collections.singletonMap(&quot;testVar&quot;, &quot;Test&quot;)).terminate())</span>
<span class="nc" id="L484">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L485">                .hasMessage(&quot;Child task variables can only be set when starting a plan item instance&quot;);</span>

<span class="nc" id="L487">        assertThatThrownBy(() -&gt;  cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId()).childTaskFormVariables(Collections.singletonMap(&quot;testVar&quot;, &quot;Test&quot;), new FormInfo(), &quot;test&quot;).terminate())</span>
<span class="nc" id="L488">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L489">                .hasMessage(&quot;Child form variables can only be set when starting a plan item instance&quot;);</span>
<span class="nc" id="L490">    }</span>

    @Test
    @CmmnDeployment
    public void testTerminateWithVariable() {
<span class="nc" id="L495">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>

<span class="nc" id="L497">        PlanItemInstance planItemInstanceA = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).singleResult();</span>
<span class="nc" id="L498">        assertThat(planItemInstanceA.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L499">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().count()).isEqualTo(5);</span>

<span class="nc" id="L501">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId())</span>
<span class="nc" id="L502">                .variable(&quot;var1&quot;, &quot;hello&quot;)</span>
<span class="nc" id="L503">                .variable(&quot;var2&quot;, &quot;world&quot;)</span>
<span class="nc" id="L504">                .terminate();</span>
<span class="nc" id="L505">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().count()).isEqualTo(4);</span>

<span class="nc" id="L507">        planItemInstanceA = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).includeEnded().singleResult();</span>
<span class="nc" id="L508">        assertThat(planItemInstanceA.getState()).isEqualTo(PlanItemInstanceState.TERMINATED);</span>

<span class="nc" id="L510">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId()))</span>
<span class="nc" id="L511">                .containsOnly(</span>
<span class="nc" id="L512">                        entry(&quot;var1&quot;, &quot;hello&quot;),</span>
<span class="nc" id="L513">                        entry(&quot;var2&quot;, &quot;world&quot;)</span>
                );
<span class="nc" id="L515">    }</span>

    @Test
    @CmmnDeployment
    public void testTerminateWithVariables() {
<span class="nc" id="L520">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>

<span class="nc" id="L522">        PlanItemInstance planItemInstanceA = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).singleResult();</span>
<span class="nc" id="L523">        assertThat(planItemInstanceA.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L524">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().count()).isEqualTo(5);</span>

<span class="nc" id="L526">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId())</span>
<span class="nc" id="L527">                .variables(CollectionUtil.map(&quot;var1&quot;, &quot;hello&quot;))</span>
<span class="nc" id="L528">                .terminate();</span>
<span class="nc" id="L529">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().count()).isEqualTo(4);</span>

<span class="nc" id="L531">        planItemInstanceA = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).includeEnded().singleResult();</span>
<span class="nc" id="L532">        assertThat(planItemInstanceA.getState()).isEqualTo(PlanItemInstanceState.TERMINATED);</span>

<span class="nc" id="L534">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId())).containsOnly(</span>
<span class="nc" id="L535">                entry(&quot;var1&quot;, &quot;hello&quot;)</span>
        );
<span class="nc" id="L537">    }</span>

    @Test
    @CmmnDeployment
    public void testTerminateWithTransientVariable() {
<span class="nc" id="L542">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>
<span class="nc" id="L543">        assertThat(cmmnTaskService.createTaskQuery().taskName(&quot;D&quot;).singleResult()).isNull();</span>

<span class="nc" id="L545">        PlanItemInstance planItemInstanceA = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).singleResult();</span>
<span class="nc" id="L546">        assertThat(planItemInstanceA.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L547">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().count()).isEqualTo(5);</span>

<span class="nc" id="L549">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId())</span>
<span class="nc" id="L550">                .variable(&quot;var1&quot;, &quot;hello&quot;)</span>
<span class="nc" id="L551">                .variable(&quot;var2&quot;, &quot;world&quot;)</span>
<span class="nc" id="L552">                .transientVariable(&quot;sentryVar&quot;, true)</span>
<span class="nc" id="L553">                .terminate();</span>
<span class="nc" id="L554">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().count()).isEqualTo(4);</span>

<span class="nc" id="L556">        planItemInstanceA = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).includeEnded().singleResult();</span>
<span class="nc" id="L557">        assertThat(planItemInstanceA.getState()).isEqualTo(PlanItemInstanceState.TERMINATED);</span>

<span class="nc" id="L559">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId()))</span>
<span class="nc" id="L560">                .containsOnly(</span>
<span class="nc" id="L561">                        entry(&quot;var1&quot;, &quot;hello&quot;),</span>
<span class="nc" id="L562">                        entry(&quot;var2&quot;, &quot;world&quot;)</span>
                );

<span class="nc" id="L565">        assertThat(cmmnTaskService.createTaskQuery().taskName(&quot;D&quot;).singleResult()).isNotNull();</span>
<span class="nc" id="L566">    }</span>

    @Test
    @CmmnDeployment
    public void testTerminateWithTransientVariables() {
<span class="nc" id="L571">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testTransitionBuilder&quot;).start();</span>
<span class="nc" id="L572">        assertThat(cmmnTaskService.createTaskQuery().taskName(&quot;D&quot;).singleResult()).isNull();</span>

<span class="nc" id="L574">        PlanItemInstance planItemInstanceA = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).singleResult();</span>
<span class="nc" id="L575">        assertThat(planItemInstanceA.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L576">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().count()).isEqualTo(5);</span>

<span class="nc" id="L578">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstanceA.getId())</span>
<span class="nc" id="L579">                .transientVariables(CollectionUtil.map(&quot;sentryVar&quot;, true))</span>
<span class="nc" id="L580">                .terminate();</span>
<span class="nc" id="L581">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().count()).isEqualTo(4);</span>

<span class="nc" id="L583">        planItemInstanceA = cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;A&quot;).includeEnded().singleResult();</span>
<span class="nc" id="L584">        assertThat(planItemInstanceA.getState()).isEqualTo(PlanItemInstanceState.TERMINATED);</span>

<span class="nc" id="L586">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId())).isEmpty();</span>
<span class="nc" id="L587">        assertThat(cmmnTaskService.createTaskQuery().taskName(&quot;D&quot;).singleResult()).isNotNull();</span>
<span class="nc" id="L588">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/PlanItemInstanceTransitionBuilderTest.testStartCaseTask.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/PlanItemInstanceTransitionBuilderTest.childcase.cmmn&quot;
    })
    public void testStartCaseTask() {
<span class="nc" id="L596">        CaseInstance parentCaseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testStartChildCase&quot;).start();</span>
<span class="nc" id="L597">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceParentId(parentCaseInstance.getId()).singleResult()).isNull();</span>

<span class="nc" id="L599">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(parentCaseInstance.getId()).singleResult();</span>
<span class="nc" id="L600">        assertThat(planItemInstance.getState()).isEqualTo(PlanItemInstanceState.ENABLED);</span>

<span class="nc" id="L602">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstance.getId()).start();</span>
<span class="nc" id="L603">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceParentId(parentCaseInstance.getId()).singleResult()).isNotNull();</span>
<span class="nc" id="L604">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/PlanItemInstanceTransitionBuilderTest.testStartCaseTask.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/PlanItemInstanceTransitionBuilderTest.childcase.cmmn&quot;
    })
    public void testStartCaseTaskWithVariable() {
<span class="nc" id="L612">        CaseInstance parentCaseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testStartChildCase&quot;).start();</span>
<span class="nc" id="L613">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceParentId(parentCaseInstance.getId()).singleResult()).isNull();</span>

<span class="nc" id="L615">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(parentCaseInstance.getId()).singleResult();</span>
<span class="nc" id="L616">        assertThat(planItemInstance.getState()).isEqualTo(PlanItemInstanceState.ENABLED);</span>

<span class="nc" id="L618">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstance.getId())</span>
<span class="nc" id="L619">                .variable(&quot;someVar&quot;, &quot;someValue&quot;)</span>
<span class="nc" id="L620">                .start();</span>

<span class="nc" id="L622">        CaseInstance childCaseInstance = cmmnRuntimeService.createCaseInstanceQuery().caseInstanceParentId(parentCaseInstance.getId()).singleResult();</span>
<span class="nc" id="L623">        assertThat(childCaseInstance).isNotNull();</span>

<span class="nc" id="L625">        assertThat(cmmnRuntimeService.getVariables(parentCaseInstance.getId()))</span>
<span class="nc" id="L626">                .containsOnly(</span>
<span class="nc" id="L627">                        entry(&quot;someVar&quot;, &quot;someValue&quot;)</span>
                );
<span class="nc" id="L629">        assertThat(cmmnRuntimeService.getVariables(childCaseInstance.getId())).isEmpty();</span>
<span class="nc" id="L630">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/PlanItemInstanceTransitionBuilderTest.testStartCaseTask.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/PlanItemInstanceTransitionBuilderTest.childcase.cmmn&quot;
    })
    public void testStartCaseTaskWithVariables() {
<span class="nc" id="L638">        CaseInstance parentCaseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testStartChildCase&quot;).start();</span>
<span class="nc" id="L639">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceParentId(parentCaseInstance.getId()).singleResult()).isNull();</span>

<span class="nc" id="L641">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(parentCaseInstance.getId()).singleResult();</span>
<span class="nc" id="L642">        assertThat(planItemInstance.getState()).isEqualTo(PlanItemInstanceState.ENABLED);</span>

<span class="nc" id="L644">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstance.getId())</span>
<span class="nc" id="L645">                .variables(CollectionUtil.map(&quot;someVar&quot;, &quot;someValue&quot;, &quot;otherVar&quot;, 123))</span>
<span class="nc" id="L646">                .start();</span>

<span class="nc" id="L648">        CaseInstance childCaseInstance = cmmnRuntimeService.createCaseInstanceQuery().caseInstanceParentId(parentCaseInstance.getId()).singleResult();</span>
<span class="nc" id="L649">        assertThat(childCaseInstance).isNotNull();</span>

<span class="nc" id="L651">        assertThat(cmmnRuntimeService.getVariables(parentCaseInstance.getId()))</span>
<span class="nc" id="L652">                .containsOnly(</span>
<span class="nc" id="L653">                        entry(&quot;someVar&quot;, &quot;someValue&quot;),</span>
<span class="nc" id="L654">                        entry(&quot;otherVar&quot;, 123)</span>
                );
<span class="nc" id="L656">        assertThat(cmmnRuntimeService.getVariables(childCaseInstance.getId())).isEmpty();</span>
<span class="nc" id="L657">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/PlanItemInstanceTransitionBuilderTest.testStartCaseTask.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/PlanItemInstanceTransitionBuilderTest.childcase.cmmn&quot;
    })
    public void testStartCaseTaskWithChildTaskVariable() {
<span class="nc" id="L665">        CaseInstance parentCaseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testStartChildCase&quot;).start();</span>
<span class="nc" id="L666">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceParentId(parentCaseInstance.getId()).singleResult()).isNull();</span>

<span class="nc" id="L668">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(parentCaseInstance.getId()).singleResult();</span>
<span class="nc" id="L669">        assertThat(planItemInstance.getState()).isEqualTo(PlanItemInstanceState.ENABLED);</span>

<span class="nc" id="L671">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstance.getId())</span>
<span class="nc" id="L672">                .variable(&quot;parentVar1&quot;, 123)</span>
<span class="nc" id="L673">                .childTaskVariable(&quot;childVar1&quot;, 1)</span>
<span class="nc" id="L674">                .childTaskVariable(&quot;childVar2&quot;, 2)</span>
<span class="nc" id="L675">                .childTaskVariable(&quot;childVar3&quot;, 3)</span>
<span class="nc" id="L676">                .start();</span>

<span class="nc" id="L678">        CaseInstance childCaseInstance = cmmnRuntimeService.createCaseInstanceQuery().caseInstanceParentId(parentCaseInstance.getId()).singleResult();</span>
<span class="nc" id="L679">        assertThat(childCaseInstance).isNotNull();</span>

<span class="nc" id="L681">        assertThat(cmmnRuntimeService.getVariables(parentCaseInstance.getId()))</span>
<span class="nc" id="L682">                .containsOnly(</span>
<span class="nc" id="L683">                        entry(&quot;parentVar1&quot;, 123)</span>
                );
<span class="nc" id="L685">        assertThat(cmmnRuntimeService.getVariables(childCaseInstance.getId()))</span>
<span class="nc" id="L686">                .containsOnly(</span>
<span class="nc" id="L687">                        entry(&quot;childVar1&quot;, 1),</span>
<span class="nc" id="L688">                        entry(&quot;childVar2&quot;, 2),</span>
<span class="nc" id="L689">                        entry(&quot;childVar3&quot;, 3)</span>
                );
<span class="nc" id="L691">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/PlanItemInstanceTransitionBuilderTest.testStartCaseTask.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/PlanItemInstanceTransitionBuilderTest.childcase.cmmn&quot;
    })
    public void testStartCaseTaskWithChildTaskVariables() {
<span class="nc" id="L699">        CaseInstance parentCaseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testStartChildCase&quot;).start();</span>
<span class="nc" id="L700">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceParentId(parentCaseInstance.getId()).singleResult()).isNull();</span>

<span class="nc" id="L702">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(parentCaseInstance.getId()).singleResult();</span>
<span class="nc" id="L703">        assertThat(planItemInstance.getState()).isEqualTo(PlanItemInstanceState.ENABLED);</span>

<span class="nc" id="L705">        cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(planItemInstance.getId())</span>
<span class="nc" id="L706">                .variable(&quot;parentVar1&quot;, 123)</span>
<span class="nc" id="L707">                .childTaskVariables(CollectionUtil.map(&quot;childVar1&quot;, 1, &quot;childVar2&quot;, 2))</span>
<span class="nc" id="L708">                .start();</span>

<span class="nc" id="L710">        CaseInstance childCaseInstance = cmmnRuntimeService.createCaseInstanceQuery().caseInstanceParentId(parentCaseInstance.getId()).singleResult();</span>
<span class="nc" id="L711">        assertThat(childCaseInstance).isNotNull();</span>

<span class="nc" id="L713">        assertThat(cmmnRuntimeService.getVariables(parentCaseInstance.getId()))</span>
<span class="nc" id="L714">                .containsOnly(</span>
<span class="nc" id="L715">                        entry(&quot;parentVar1&quot;, 123)</span>
                );
<span class="nc" id="L717">        assertThat(cmmnRuntimeService.getVariables(childCaseInstance.getId()))</span>
<span class="nc" id="L718">                .containsOnly(</span>
<span class="nc" id="L719">                        entry(&quot;childVar1&quot;, 1),</span>
<span class="nc" id="L720">                        entry(&quot;childVar2&quot;, 2)</span>
                );
<span class="nc" id="L722">    }</span>

    @Test
    public void testInvalidArguments() {
<span class="nc" id="L726">        assertThatThrownBy(() -&gt; cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(&quot;dummy&quot;).childTaskFormVariables(Collections.emptyMap(), null, &quot;test&quot;))</span>
<span class="nc" id="L727">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L728">                .hasMessage(&quot;formInfo is null&quot;);</span>

<span class="nc" id="L730">        assertThatThrownBy(() -&gt; cmmnRuntimeService.createPlanItemInstanceTransitionBuilder(&quot;dummy&quot;).formVariables(Collections.emptyMap(), null, &quot;test&quot;))</span>
<span class="nc" id="L731">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L732">                .hasMessage(&quot;formInfo is null&quot;);</span>
<span class="nc" id="L733">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>