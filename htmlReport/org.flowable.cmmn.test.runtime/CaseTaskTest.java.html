<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CaseTaskTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.cmmn.test.runtime</a> &gt; <span class="el_source">CaseTaskTest.java</span></div><h1>CaseTaskTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.cmmn.test.runtime;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.assertj.core.api.Assertions.tuple;

import java.util.Collections;
import java.util.List;
import java.util.Map;

import org.flowable.cmmn.api.CallbackTypes;
import org.flowable.cmmn.api.history.HistoricCaseInstance;
import org.flowable.cmmn.api.history.HistoricPlanItemInstance;
import org.flowable.cmmn.api.runtime.CaseInstance;
import org.flowable.cmmn.api.runtime.PlanItemDefinitionType;
import org.flowable.cmmn.api.runtime.PlanItemInstance;
import org.flowable.cmmn.api.runtime.PlanItemInstanceState;
import org.flowable.cmmn.api.runtime.UserEventListenerInstance;
import org.flowable.cmmn.engine.test.CmmnDeployment;
import org.flowable.cmmn.engine.test.FlowableCmmnTestCase;
import org.flowable.cmmn.engine.test.impl.CmmnHistoryTestHelper;
import org.flowable.common.engine.api.FlowableObjectNotFoundException;
import org.flowable.common.engine.api.constant.ReferenceTypes;
import org.flowable.common.engine.api.scope.ScopeTypes;
import org.flowable.common.engine.impl.DefaultTenantProvider;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.entitylink.api.EntityLink;
import org.flowable.entitylink.api.EntityLinkType;
import org.flowable.entitylink.api.HierarchyType;
import org.flowable.entitylink.api.history.HistoricEntityLink;
import org.flowable.task.api.Task;
import org.flowable.task.api.history.HistoricTaskInstance;
import org.flowable.variable.api.history.HistoricVariableInstance;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;

/**
 * @author Joram Barrez
 * @author Filip Hrisafov
 */
<span class="nc" id="L54">public class CaseTaskTest extends FlowableCmmnTestCase {</span>

    protected String oneTaskCaseDeploymentId;

    @Before
    public void deployOneTaskCaseDefinition() {
<span class="nc" id="L60">        oneTaskCaseDeploymentId = cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L61">                .addClasspathResource(&quot;org/flowable/cmmn/test/runtime/oneTaskCase.cmmn&quot;).deploy().getId();</span>
<span class="nc" id="L62">    }</span>

    @After
    public void deleteOneTaskCaseDefinition() {
<span class="nc" id="L66">        cmmnRepositoryService.deleteDeployment(oneTaskCaseDeploymentId, true);</span>
<span class="nc" id="L67">    }</span>

    @Test
    @CmmnDeployment
    public void testBasicBlocking() {
<span class="nc" id="L72">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L73">        assertBlockingCaseTaskFlow(caseInstance);</span>
<span class="nc" id="L74">    }</span>

    @Test
    @CmmnDeployment
    public void testCaseReferenceExpression() {
<span class="nc" id="L79">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L80">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L81">                .variable(&quot;myVar&quot;, &quot;oneTaskCase&quot;)</span>
<span class="nc" id="L82">                .start();</span>
<span class="nc" id="L83">        assertBlockingCaseTaskFlow(caseInstance);</span>
<span class="nc" id="L84">    }</span>

    @Test
    public void testBasicBlockingWithTenant() {
<span class="nc" id="L88">        cmmnRepositoryService.deleteDeployment(oneTaskCaseDeploymentId, true);</span>
<span class="nc" id="L89">        oneTaskCaseDeploymentId = cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L90">                .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L91">                .addClasspathResource(&quot;org/flowable/cmmn/test/runtime/CaseTaskTest.testBasicBlocking.cmmn&quot;)</span>
<span class="nc" id="L92">                .addClasspathResource(&quot;org/flowable/cmmn/test/runtime/oneTaskCase.cmmn&quot;)</span>
<span class="nc" id="L93">                .deploy().getId();</span>

<span class="nc" id="L95">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).tenantId(&quot;flowable&quot;).start();</span>
<span class="nc" id="L96">        assertBlockingCaseTaskFlow(caseInstance);</span>
<span class="nc" id="L97">    }</span>

    @Test
    public void testBasicBlockingWithTenantAndGlobalDeployment() {
<span class="nc" id="L101">        cmmnRepositoryService.deleteDeployment(oneTaskCaseDeploymentId, true);</span>
<span class="nc" id="L102">        oneTaskCaseDeploymentId = cmmnRepositoryService.createDeployment().</span>
<span class="nc" id="L103">                addClasspathResource(&quot;org/flowable/cmmn/test/runtime/oneTaskCase.cmmn&quot;).</span>
<span class="nc" id="L104">                deploy().getId();</span>
<span class="nc" id="L105">        String parentCaseDeploymentId = cmmnRepositoryService.createDeployment().</span>
<span class="nc" id="L106">                tenantId(&quot;flowable&quot;).</span>
<span class="nc" id="L107">                addClasspathResource(&quot;org/flowable/cmmn/test/runtime/CaseTaskTest.testBasicBlocking.cmmn&quot;).</span>
<span class="nc" id="L108">                deploy().getId();</span>

<span class="nc" id="L110">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).tenantId(&quot;flowable&quot;).start();</span>
<span class="nc" id="L111">        assertThatThrownBy(() -&gt; assertBlockingCaseTaskFlow(caseInstance))</span>
<span class="nc" id="L112">                .isInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L113">                .hasMessage(&quot;Case definition was not found by key 'oneTaskCase' and tenant 'flowable'&quot;);</span>
<span class="nc" id="L114">        cmmnRepositoryService.deleteDeployment(parentCaseDeploymentId, true);</span>
<span class="nc" id="L115">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/CaseTaskTest.testSimpleBlockingSubCase.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/CaseTaskTest.testSimpleBlockingSubCaseChildCase.cmmn&quot;
    })
    public void testSimpleBlockingSubCase() {
<span class="nc" id="L123">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;endEndCase&quot;).start();</span>

        // Verify case task plan item instance
<span class="nc" id="L126">        PlanItemInstance caseTaskPlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L127">                .planItemDefinitionType(PlanItemDefinitionType.CASE_TASK)</span>
<span class="nc" id="L128">                .singleResult();</span>
<span class="nc" id="L129">        assertThat(caseTaskPlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>

        // Verify child case instance
<span class="nc" id="L132">        CaseInstance childCaseInstance = cmmnRuntimeService.createCaseInstanceQuery().caseInstanceParentId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L133">        assertThat(childCaseInstance.getCallbackId()).isEqualTo(caseTaskPlanItemInstance.getId());</span>
<span class="nc" id="L134">        assertThat(childCaseInstance.getCallbackType()).isEqualTo(CallbackTypes.PLAN_ITEM_CHILD_CASE);</span>

<span class="nc" id="L136">        PlanItemInstance humanTaskPlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L137">                .caseInstanceId(childCaseInstance.getId())</span>
<span class="nc" id="L138">                .planItemDefinitionType(PlanItemDefinitionType.HUMAN_TASK)</span>
<span class="nc" id="L139">                .singleResult();</span>
<span class="nc" id="L140">        assertThat(humanTaskPlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>

<span class="nc" id="L142">        assertThat(caseTaskPlanItemInstance.getReferenceId()).isEqualTo(childCaseInstance.getId());</span>
<span class="nc" id="L143">        assertThat(caseTaskPlanItemInstance.getReferenceType()).isEqualTo(ReferenceTypes.PLAN_ITEM_CHILD_CASE);</span>

<span class="nc bnc" id="L145" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L146">            HistoricCaseInstance historicChildCaseInstance = cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(childCaseInstance.getId())</span>
<span class="nc" id="L147">                    .singleResult();</span>
<span class="nc" id="L148">            assertThat(historicChildCaseInstance.getCallbackId()).isEqualTo(cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L149">                    .caseInstanceId(caseInstance.getId()).planItemDefinitionType(PlanItemDefinitionType.CASE_TASK).singleResult().getId());</span>
<span class="nc" id="L150">            assertThat(historicChildCaseInstance.getCallbackType()).isEqualTo(CallbackTypes.PLAN_ITEM_CHILD_CASE);</span>

<span class="nc" id="L152">            HistoricPlanItemInstance historicCaseTaskPlanItemInstance = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L153">                    .planItemInstanceId(caseTaskPlanItemInstance.getId()).singleResult();</span>

<span class="nc" id="L155">            assertThat(historicCaseTaskPlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>
<span class="nc" id="L156">            assertThat(historicCaseTaskPlanItemInstance.getReferenceId()).isEqualTo(historicChildCaseInstance.getId());</span>
<span class="nc" id="L157">            assertThat(historicCaseTaskPlanItemInstance.getReferenceType()).isEqualTo(ReferenceTypes.PLAN_ITEM_CHILD_CASE);</span>
        }

<span class="nc" id="L160">        PlanItemInstance stagePlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L161">                .caseInstanceId(childCaseInstance.getId())</span>
<span class="nc" id="L162">                .planItemDefinitionType(PlanItemDefinitionType.STAGE)</span>
<span class="nc" id="L163">                .singleResult();</span>
<span class="nc" id="L164">        assertThat(stagePlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.ACTIVE);</span>

        // Completing the task should complete both case instances
<span class="nc" id="L167">        cmmnTaskService.complete(cmmnTaskService.createTaskQuery().caseInstanceId(childCaseInstance.getId()).singleResult().getId());</span>
<span class="nc" id="L168">        assertCaseInstanceEnded(childCaseInstance);</span>
<span class="nc" id="L169">        assertCaseInstanceEnded(caseInstance);</span>
<span class="nc" id="L170">    }</span>

    @Test
    @CmmnDeployment
    public void testBasicSubHumanTask() {
<span class="nc" id="L175">        String oneHumanTaskDeploymentId = cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L176">                .addClasspathResource(&quot;org/flowable/cmmn/test/runtime/oneHumanTaskCase.cmmn&quot;).deploy().getId();</span>

        try {
<span class="nc" id="L179">            CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L180">            Task taskBeforeSubTask = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L181">            assertThat(taskBeforeSubTask.getName()).isEqualTo(&quot;Task One&quot;);</span>
<span class="nc" id="L182">            Task childTask = cmmnTaskService.createTaskQuery().caseInstanceIdWithChildren(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L183">            assertThat(childTask.getId()).isEqualTo(taskBeforeSubTask.getId());</span>

<span class="nc" id="L185">            cmmnTaskService.complete(taskBeforeSubTask.getId());</span>

<span class="nc" id="L187">            Task taskInSubTask = cmmnTaskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L188">            assertThat(taskInSubTask.getName()).isEqualTo(&quot;Sub task&quot;);</span>
<span class="nc" id="L189">            childTask = cmmnTaskService.createTaskQuery().caseInstanceIdWithChildren(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L190">            assertThat(childTask.getId()).isEqualTo(taskInSubTask.getId());</span>

<span class="nc bnc" id="L192" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L193">                List&lt;HistoricTaskInstance&gt; childTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceIdWithChildren(caseInstance.getId())</span>
<span class="nc" id="L194">                    .list();</span>
<span class="nc" id="L195">                assertThat(childTasks)</span>
<span class="nc" id="L196">                    .extracting(HistoricTaskInstance::getId)</span>
<span class="nc" id="L197">                    .containsExactlyInAnyOrder(taskBeforeSubTask.getId(), taskInSubTask.getId());</span>
            }

<span class="nc" id="L200">            cmmnTaskService.complete(taskInSubTask.getId());</span>

<span class="nc" id="L202">            Task taskAfterSubTask = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L203">            assertThat(taskAfterSubTask.getName()).isEqualTo(&quot;Task Two&quot;);</span>
<span class="nc" id="L204">            childTask = cmmnTaskService.createTaskQuery().caseInstanceIdWithChildren(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L205">            assertThat(childTask.getId()).isEqualTo(taskAfterSubTask.getId());</span>

<span class="nc bnc" id="L207" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L208">                List&lt;HistoricTaskInstance&gt; childTasks = cmmnHistoryService.createHistoricTaskInstanceQuery().caseInstanceIdWithChildren(caseInstance.getId()).list();</span>
<span class="nc" id="L209">                assertThat(childTasks)</span>
<span class="nc" id="L210">                    .extracting(HistoricTaskInstance::getId)</span>
<span class="nc" id="L211">                    .containsExactlyInAnyOrder(taskBeforeSubTask.getId(), taskInSubTask.getId(), taskAfterSubTask.getId());</span>
            }

        } finally {
<span class="nc" id="L215">            cmmnRepositoryService.deleteDeployment(oneHumanTaskDeploymentId, true);</span>
        }

<span class="nc" id="L218">    }</span>

    protected void assertBlockingCaseTaskFlow(CaseInstance caseInstance) {
<span class="nc" id="L221">        assertThat(caseInstance).isNotNull();</span>
<span class="nc" id="L222">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc bnc" id="L224" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L225">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isZero();</span>
<span class="nc" id="L226">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isEqualTo(1);</span>
        }

<span class="nc" id="L229">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L230">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L231">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L232">                .singleResult();</span>
<span class="nc" id="L233">        assertThat(planItemInstance).isNotNull();</span>

<span class="nc" id="L235">        List&lt;EntityLink&gt; entityLinks = cmmnRuntimeService.getEntityLinkChildrenForCaseInstance(caseInstance.getId());</span>
<span class="nc" id="L236">        assertThat(entityLinks).isEmpty();</span>

        // Triggering the task should start the child case instance
<span class="nc" id="L239">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>
<span class="nc" id="L240">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isEqualTo(2);</span>

<span class="nc bnc" id="L242" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L243">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isZero();</span>
        }

<span class="nc" id="L246">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L247">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L248">                .orderByName().asc()</span>
<span class="nc" id="L249">                .list();</span>
<span class="nc" id="L250">        assertThat(planItemInstances)</span>
<span class="nc" id="L251">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L252">                .containsExactly(&quot;The Case&quot;, &quot;The Task&quot;);</span>
<span class="nc" id="L253">        assertThat(planItemInstances.get(1).getTenantId()).isEqualTo(planItemInstance.getTenantId());</span>

<span class="nc" id="L255">        entityLinks = cmmnRuntimeService.getEntityLinkChildrenForCaseInstance(caseInstance.getId());</span>
<span class="nc" id="L256">        assertThat(entityLinks).hasSize(1);</span>
<span class="nc" id="L257">        EntityLink entityLink = entityLinks.get(0);</span>

<span class="nc" id="L259">        checkEntityLink(entityLink, caseInstance, planItemInstances.get(1).getCaseInstanceId());</span>

<span class="nc" id="L261">        List&lt;EntityLink&gt; entityLinkParentsForCaseInstance = cmmnRuntimeService.getEntityLinkParentsForCaseInstance(entityLink.getReferenceScopeId());</span>
<span class="nc" id="L262">        assertThat(entityLinkParentsForCaseInstance).hasSize(1);</span>

<span class="nc" id="L264">        checkEntityLink(entityLinkParentsForCaseInstance.get(0), caseInstance, planItemInstances.get(1).getCaseInstanceId());</span>

        // Triggering the task from the child case instance should complete the child case instance
<span class="nc" id="L267">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstances.get(1).getId());</span>
<span class="nc" id="L268">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc bnc" id="L270" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L271">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isEqualTo(1);</span>
<span class="nc" id="L272">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isEqualTo(1);</span>
        }

<span class="nc" id="L275">        planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L276">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L277">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L278">                .singleResult();</span>
<span class="nc" id="L279">        assertThat(planItemInstance.getName()).isEqualTo(&quot;Task Two&quot;);</span>
<span class="nc" id="L280">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>

<span class="nc" id="L282">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isZero();</span>

<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L285">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isZero();</span>
<span class="nc" id="L286">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isEqualTo(2);</span>

<span class="nc" id="L288">            List&lt;HistoricEntityLink&gt; historicEntityLinks = cmmnHistoryService.getHistoricEntityLinkChildrenForCaseInstance(caseInstance.getId());</span>
<span class="nc" id="L289">            assertThat(historicEntityLinks).hasSize(1);</span>

<span class="nc" id="L291">            checkHistoricEntityLink(historicEntityLinks.get(0), caseInstance, planItemInstances.get(1).getCaseInstanceId());</span>

<span class="nc" id="L293">            List&lt;HistoricEntityLink&gt; historicEntityLinkParentForCaseInstance = cmmnHistoryService</span>
<span class="nc" id="L294">                .getHistoricEntityLinkParentsForCaseInstance(entityLink.getReferenceScopeId());</span>
<span class="nc" id="L295">            assertThat(historicEntityLinkParentForCaseInstance).hasSize(1);</span>

<span class="nc" id="L297">            checkHistoricEntityLink(historicEntityLinkParentForCaseInstance.get(0), caseInstance, planItemInstances.get(1).getCaseInstanceId());</span>
        }
<span class="nc" id="L299">    }</span>

    private void checkEntityLink(EntityLink entityLink, CaseInstance caseInstance, String referenceScopeId) {
<span class="nc" id="L302">        assertThat(entityLink.getLinkType()).isEqualTo(EntityLinkType.CHILD);</span>
<span class="nc" id="L303">        assertThat(entityLink.getCreateTime()).isNotNull();</span>
<span class="nc" id="L304">        assertThat(entityLink.getScopeId()).isEqualTo(caseInstance.getId());</span>
<span class="nc" id="L305">        assertThat(entityLink.getScopeType()).isEqualTo(ScopeTypes.CMMN);</span>
<span class="nc" id="L306">        assertThat(entityLink.getScopeDefinitionId()).isNull();</span>
<span class="nc" id="L307">        assertThat(entityLink.getReferenceScopeId()).isEqualTo(referenceScopeId);</span>
<span class="nc" id="L308">        assertThat(entityLink.getReferenceScopeType()).isEqualTo(ScopeTypes.CMMN);</span>
<span class="nc" id="L309">        assertThat(entityLink.getReferenceScopeDefinitionId()).isNull();</span>
<span class="nc" id="L310">        assertThat(entityLink.getHierarchyType()).isEqualTo(HierarchyType.ROOT);</span>
<span class="nc" id="L311">    }</span>

    private void checkHistoricEntityLink(HistoricEntityLink historicEntityLink, CaseInstance caseInstance, String referenceScopeId) {
<span class="nc bnc" id="L314" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L315">            assertThat(historicEntityLink.getLinkType()).isEqualTo(EntityLinkType.CHILD);</span>
<span class="nc" id="L316">            assertThat(historicEntityLink.getCreateTime()).isNotNull();</span>
<span class="nc" id="L317">            assertThat(historicEntityLink.getScopeId()).isEqualTo(caseInstance.getId());</span>
<span class="nc" id="L318">            assertThat(historicEntityLink.getScopeType()).isEqualTo(ScopeTypes.CMMN);</span>
<span class="nc" id="L319">            assertThat(historicEntityLink.getScopeDefinitionId()).isNull();</span>
<span class="nc" id="L320">            assertThat(historicEntityLink.getReferenceScopeId()).isEqualTo(referenceScopeId);</span>
<span class="nc" id="L321">            assertThat(historicEntityLink.getReferenceScopeType()).isEqualTo(ScopeTypes.CMMN);</span>
<span class="nc" id="L322">            assertThat(historicEntityLink.getReferenceScopeDefinitionId()).isNull();</span>
<span class="nc" id="L323">            assertThat(historicEntityLink.getHierarchyType()).isEqualTo(HierarchyType.ROOT);</span>
        }
<span class="nc" id="L325">    }</span>

    // Same as testBasicBlocking(), but now with a non-blocking case task
    @Test
    @CmmnDeployment
    public void testBasicNonBlocking() {
<span class="nc" id="L331">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L332">        assertThat(caseInstance).isNotNull();</span>
<span class="nc" id="L333">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc bnc" id="L335" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L336">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isZero();</span>
<span class="nc" id="L337">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isEqualTo(1);</span>
        }

<span class="nc" id="L340">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L341">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L342">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L343">                .singleResult();</span>
<span class="nc" id="L344">        assertThat(planItemInstance).isNotNull();</span>

        // Triggering the task should start the case instance (which is non-blocking -&gt; directly go to task two)
<span class="nc" id="L347">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>

<span class="nc" id="L349">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isEqualTo(2);</span>

<span class="nc" id="L351">        CaseInstance childCaseInstance = cmmnRuntimeService.createCaseInstanceQuery().caseInstanceParentId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L352">        assertThat(childCaseInstance).isNotNull();</span>

<span class="nc" id="L354">        PlanItemInstance caseTaskPlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L355">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L356">                .planItemDefinitionType(PlanItemDefinitionType.CASE_TASK)</span>
<span class="nc" id="L357">                .includeEnded()</span>
<span class="nc" id="L358">                .singleResult();</span>
<span class="nc" id="L359">        assertThat(caseTaskPlanItemInstance).isNotNull();</span>
<span class="nc" id="L360">        assertThat(caseTaskPlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.COMPLETED);</span>
<span class="nc" id="L361">        assertThat(caseTaskPlanItemInstance.getReferenceId()).isEqualTo(childCaseInstance.getId());</span>
<span class="nc" id="L362">        assertThat(caseTaskPlanItemInstance.getReferenceType()).isEqualTo(ReferenceTypes.PLAN_ITEM_CHILD_CASE);</span>

<span class="nc" id="L364">        assertThat(childCaseInstance.getCallbackId()).isNull();</span>
<span class="nc" id="L365">        assertThat(childCaseInstance.getCallbackType()).isNull();</span>

<span class="nc bnc" id="L367" title="All 2 branches missed.">        if (cmmnEngineConfiguration.isEnableEntityLinks()) {</span>
<span class="nc" id="L368">            List&lt;EntityLink&gt; entityLinks = cmmnRuntimeService.getEntityLinkChildrenForCaseInstance(caseInstance.getId());</span>
<span class="nc" id="L369">            assertThat(entityLinks).isEmpty();</span>
        }

<span class="nc bnc" id="L372" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L373">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isZero();</span>

<span class="nc" id="L375">            HistoricCaseInstance historicChildCaseInstance = cmmnHistoryService.createHistoricCaseInstanceQuery()</span>
<span class="nc" id="L376">                    .caseInstanceId(childCaseInstance.getId())</span>
<span class="nc" id="L377">                    .singleResult();</span>

<span class="nc" id="L379">            assertThat(historicChildCaseInstance.getCallbackId()).isNull();</span>
<span class="nc" id="L380">            assertThat(historicChildCaseInstance.getCallbackType()).isNull();</span>

<span class="nc" id="L382">            HistoricPlanItemInstance historicCaseTaskPlanItemInstance = cmmnHistoryService.createHistoricPlanItemInstanceQuery()</span>
<span class="nc" id="L383">                    .planItemInstanceId(caseTaskPlanItemInstance.getId()).singleResult();</span>

<span class="nc" id="L385">            assertThat(historicCaseTaskPlanItemInstance.getState()).isEqualTo(PlanItemInstanceState.COMPLETED);</span>
<span class="nc" id="L386">            assertThat(historicCaseTaskPlanItemInstance.getReferenceId()).isEqualTo(historicChildCaseInstance.getId());</span>
<span class="nc" id="L387">            assertThat(historicCaseTaskPlanItemInstance.getReferenceType()).isEqualTo(ReferenceTypes.PLAN_ITEM_CHILD_CASE);</span>

<span class="nc bnc" id="L389" title="All 2 branches missed.">            if (cmmnEngineConfiguration.isEnableEntityLinks()) {</span>
<span class="nc" id="L390">                List&lt;HistoricEntityLink&gt; entityLinks = cmmnHistoryService.getHistoricEntityLinkChildrenForCaseInstance(caseInstance.getId());</span>
<span class="nc" id="L391">                assertThat(entityLinks).isEmpty();</span>
            }
        }

<span class="nc" id="L395">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L396">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L397">                .orderByName().asc()</span>
<span class="nc" id="L398">                .list();</span>
<span class="nc" id="L399">        assertThat(planItemInstances)</span>
<span class="nc" id="L400">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L401">                .containsExactly(&quot;Task Two&quot;, &quot;The Task&quot;);</span>

<span class="nc" id="L403">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstances.get(0).getId());</span>
<span class="nc" id="L404">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc bnc" id="L406" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L407">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isEqualTo(1);</span>
<span class="nc" id="L408">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isEqualTo(1);</span>
        }

<span class="nc" id="L411">        planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L412">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L413">                .singleResult();</span>
<span class="nc" id="L414">        assertThat(planItemInstance.getName()).isEqualTo(&quot;The Task&quot;);</span>
<span class="nc" id="L415">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>

<span class="nc" id="L417">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isZero();</span>

<span class="nc bnc" id="L419" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L420">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isZero();</span>
<span class="nc" id="L421">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isEqualTo(2);</span>
        }
<span class="nc" id="L423">    }</span>

    @Test
    @CmmnDeployment
    public void testRuntimeServiceTriggerCasePlanItemInstance() {
<span class="nc" id="L428">        cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L429">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isEqualTo(2);</span>

<span class="nc bnc" id="L431" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L432">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isZero();</span>
<span class="nc" id="L433">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isEqualTo(2);</span>
        }

<span class="nc" id="L436">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L437">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L438">                .orderByName().asc()</span>
<span class="nc" id="L439">                .list();</span>
<span class="nc" id="L440">        assertThat(planItemInstances)</span>
<span class="nc" id="L441">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L442">                .containsExactly(&quot;Task One&quot;, &quot;The Case&quot;, &quot;The Task&quot;);</span>

        // Triggering the planitem of the case should terminate the case and go to task two
<span class="nc" id="L445">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstances.get(1).getId());</span>

<span class="nc" id="L447">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc bnc" id="L449" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L450">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isEqualTo(1);</span>
<span class="nc" id="L451">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isEqualTo(1);</span>
        }

<span class="nc" id="L454">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L455">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L456">                .orderByName().asc()</span>
<span class="nc" id="L457">                .list();</span>
<span class="nc" id="L458">        assertThat(planItemInstances)</span>
<span class="nc" id="L459">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L460">                .containsExactly(&quot;Task One&quot;, &quot;Task Two&quot;);</span>
<span class="nc" id="L461">    }</span>

    @Test
    @CmmnDeployment
    public void testRuntimeServiceTriggerNonBlockingCasePlanItem() {
<span class="nc" id="L466">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L467">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isEqualTo(2);</span>

<span class="nc bnc" id="L469" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L470">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isZero();</span>
<span class="nc" id="L471">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isEqualTo(2);</span>
        }

<span class="nc" id="L474">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L475">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L476">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L477">                .orderByName().asc()</span>
<span class="nc" id="L478">                .singleResult();</span>
<span class="nc" id="L479">        assertThat(planItemInstance.getName()).isEqualTo(&quot;Task One&quot;);</span>

        // Triggering the task plan item completes the parent case, but the child case remains
<span class="nc" id="L482">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>
<span class="nc" id="L483">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc bnc" id="L485" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L486">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isEqualTo(1);</span>
<span class="nc" id="L487">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isEqualTo(1);</span>
        }

<span class="nc" id="L490">        planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L491">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L492">                .orderByName().asc()</span>
<span class="nc" id="L493">                .singleResult();</span>
<span class="nc" id="L494">        assertThat(planItemInstance.getName()).isEqualTo(&quot;The Task&quot;);</span>
<span class="nc" id="L495">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>
<span class="nc" id="L496">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isZero();</span>

<span class="nc bnc" id="L498" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L499">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isEqualTo(2);</span>
<span class="nc" id="L500">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isZero();</span>
        }
<span class="nc" id="L502">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/runtime/CaseTaskTest.testRuntimeServiceTriggerNonBlockingCasePlanItem.cmmn&quot;)
    public void testRuntimeServiceCompleteNonBlockingCase() {
<span class="nc" id="L507">        cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L508">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isEqualTo(2);</span>

<span class="nc bnc" id="L510" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L511">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isZero();</span>
<span class="nc" id="L512">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isEqualTo(2);</span>
        }

<span class="nc" id="L515">        CaseInstance oneTaskCase = cmmnRuntimeService.createCaseInstanceQuery().caseDefinitionKey(&quot;oneTaskCase&quot;).singleResult();</span>
<span class="nc" id="L516">        assertThat(oneTaskCase).isNotNull();</span>

<span class="nc" id="L518">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L519">                .caseInstanceId(oneTaskCase.getId())</span>
<span class="nc" id="L520">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L521">                .orderByName().asc()</span>
<span class="nc" id="L522">                .singleResult();</span>
<span class="nc" id="L523">        assertThat(planItemInstance.getName()).isEqualTo(&quot;The Task&quot;);</span>

        // Triggering the task plan item completes the parent case, but the child case remains
<span class="nc" id="L526">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>
<span class="nc" id="L527">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc bnc" id="L529" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L530">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isEqualTo(1);</span>
<span class="nc" id="L531">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isEqualTo(1);</span>
        }

<span class="nc" id="L534">        planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L535">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L536">                .orderByName().asc()</span>
<span class="nc" id="L537">                .singleResult();</span>
<span class="nc" id="L538">        assertThat(planItemInstance.getName()).isEqualTo(&quot;Task One&quot;);</span>
<span class="nc" id="L539">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>
<span class="nc" id="L540">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isZero();</span>

<span class="nc bnc" id="L542" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L543">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isEqualTo(2);</span>
<span class="nc" id="L544">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isZero();</span>
        }
<span class="nc" id="L546">    }</span>

    @Test
    @CmmnDeployment
    public void testTerminateCaseInstanceWithNonBlockingCaseTask() {
<span class="nc" id="L551">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>

<span class="nc bnc" id="L553" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L554">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isZero();</span>
<span class="nc" id="L555">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isEqualTo(2);</span>
        }

<span class="nc" id="L558">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L559">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L560">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L561">                .singleResult();</span>
<span class="nc" id="L562">        assertThat(planItemInstance.getName()).isEqualTo(&quot;Task One&quot;);</span>

        // Terminating the parent case instance should not terminate the child (it's non-blocking)
<span class="nc" id="L565">        cmmnRuntimeService.terminateCaseInstance(caseInstance.getId());</span>
<span class="nc" id="L566">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>

<span class="nc bnc" id="L568" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L569">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isEqualTo(1);</span>
<span class="nc" id="L570">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isEqualTo(1);</span>
        }

        // Terminate child
<span class="nc" id="L574">        CaseInstance childCaseInstance = cmmnRuntimeService.createCaseInstanceQuery().caseInstanceParentId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L575">        assertThat(childCaseInstance).isNotNull();</span>

<span class="nc bnc" id="L577" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L578">            HistoricCaseInstance historicChildCaseInstance = cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceParentId(caseInstance.getId())</span>
<span class="nc" id="L579">                .singleResult();</span>
<span class="nc" id="L580">            assertThat(historicChildCaseInstance).isNotNull();</span>

<span class="nc" id="L582">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().withoutCaseInstanceParent().singleResult().getId())</span>
<span class="nc" id="L583">                    .isEqualTo(caseInstance.getId());</span>
        }

<span class="nc" id="L586">        cmmnRuntimeService.terminateCaseInstance(childCaseInstance.getId());</span>

<span class="nc bnc" id="L588" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L589">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isEqualTo(2);</span>
<span class="nc" id="L590">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isZero();</span>
        }
<span class="nc" id="L592">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/CaseTaskTest.terminateAvailableCaseTask.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/oneHumanTaskCase.cmmn&quot;
    })
    public void testTerminateAvailableCaseTask() {
<span class="nc" id="L600">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;terminateAvailableCaseTask&quot;).start();</span>

<span class="nc" id="L602">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L603">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L604">                .planItemDefinitionType(PlanItemDefinitionType.CASE_TASK)</span>
<span class="nc" id="L605">                .planItemInstanceStateAvailable().singleResult();</span>
<span class="nc" id="L606">        assertThat(planItemInstance.getName()).isEqualTo(&quot;myCase&quot;);</span>

        // When the event listener now occurs, the stage should be exited, also exiting the case task plan item
<span class="nc" id="L609">        UserEventListenerInstance userEventListenerInstance = cmmnRuntimeService.createUserEventListenerInstanceQuery()</span>
<span class="nc" id="L610">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L611">                .singleResult();</span>
<span class="nc" id="L612">        cmmnRuntimeService.completeUserEventListenerInstance(userEventListenerInstance.getId());</span>

<span class="nc" id="L614">        assertCaseInstanceEnded(caseInstance);</span>
<span class="nc" id="L615">    }</span>

    @Test
    @CmmnDeployment
    public void testTerminateCaseInstanceWithNestedCaseTasks() {
<span class="nc" id="L620">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>

<span class="nc bnc" id="L622" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L623">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isZero();</span>
<span class="nc" id="L624">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isEqualTo(4);</span>
        }

<span class="nc" id="L627">        cmmnRuntimeService.terminateCaseInstance(caseInstance.getId());</span>

<span class="nc bnc" id="L629" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L630">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isEqualTo(4);</span>
<span class="nc" id="L631">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isZero();</span>

<span class="nc" id="L633">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().list())</span>
<span class="nc" id="L634">                .extracting(HistoricCaseInstance::getState)</span>
<span class="nc" id="L635">                .containsOnly(PlanItemInstanceState.TERMINATED);</span>
        }
<span class="nc" id="L637">    }</span>

    @Test
    @CmmnDeployment
    public void testFallbackToDefaultTenant() {
<span class="nc" id="L642">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L643">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L644">                .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L645">                .overrideCaseDefinitionTenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L646">                .fallbackToDefaultTenant()</span>
<span class="nc" id="L647">                .start();</span>

<span class="nc" id="L649">        assertBlockingCaseTaskFlow(caseInstance);</span>
<span class="nc" id="L650">        assertThat(caseInstance.getTenantId()).isEqualTo(&quot;flowable&quot;);</span>
<span class="nc" id="L651">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/runtime/CaseTaskTest.testGlobalFallbackToDefaultTenant.cmmn&quot;, tenantId = &quot;defaultFlowable&quot;)
    public void testGlobalFallbackToDefaultTenant() {
<span class="nc" id="L656">        String tenantDeploymentId = cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L657">                .addClasspathResource(&quot;org/flowable/cmmn/test/runtime/oneTaskCase.cmmn&quot;)</span>
<span class="nc" id="L658">                .tenantId(&quot;defaultFlowable&quot;)</span>
<span class="nc" id="L659">                .deploy()</span>
<span class="nc" id="L660">                .getId();</span>

<span class="nc" id="L662">        DefaultTenantProvider originalDefaultTenantProvider = cmmnEngineConfiguration.getDefaultTenantProvider();</span>
<span class="nc" id="L663">        cmmnEngineConfiguration.setFallbackToDefaultTenant(true);</span>
<span class="nc" id="L664">        cmmnEngineConfiguration.setDefaultTenantValue(&quot;defaultFlowable&quot;);</span>
        try {
<span class="nc" id="L666">            CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L667">                    .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L668">                    .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L669">                    .overrideCaseDefinitionTenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L670">                    .fallbackToDefaultTenant()</span>
<span class="nc" id="L671">                    .start();</span>

<span class="nc" id="L673">            assertBlockingCaseTaskFlow(caseInstance);</span>
<span class="nc" id="L674">            assertThat(caseInstance.getTenantId()).isEqualTo(&quot;flowable&quot;);</span>

        } finally {
<span class="nc" id="L677">            cmmnEngineConfiguration.setFallbackToDefaultTenant(false);</span>
<span class="nc" id="L678">            cmmnEngineConfiguration.setDefaultTenantProvider(originalDefaultTenantProvider);</span>
<span class="nc" id="L679">            cmmnRepositoryService.deleteDeployment(tenantDeploymentId, true);</span>
        }
<span class="nc" id="L681">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/runtime/CaseTaskTest.testGlobalFallbackToDefaultTenant.cmmn&quot;, tenantId = &quot;defaultFlowable&quot;)
    public void testGlobalFallbackToDefaultTenantNoDefinition() {
<span class="nc" id="L686">        DefaultTenantProvider originalDefaultTenantProvider = cmmnEngineConfiguration.getDefaultTenantProvider();</span>
<span class="nc" id="L687">        cmmnEngineConfiguration.setFallbackToDefaultTenant(true);</span>
<span class="nc" id="L688">        cmmnEngineConfiguration.setDefaultTenantValue(&quot;defaultFlowable&quot;);</span>
        try {
<span class="nc" id="L690">            CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L691">                    .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L692">                    .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L693">                    .overrideCaseDefinitionTenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L694">                    .fallbackToDefaultTenant()</span>
<span class="nc" id="L695">                    .start();</span>
<span class="nc" id="L696">            assertThatThrownBy(() -&gt; assertBlockingCaseTaskFlow(caseInstance))</span>
<span class="nc" id="L697">                    .isInstanceOf(FlowableObjectNotFoundException.class);</span>
        } finally {
<span class="nc" id="L699">            cmmnEngineConfiguration.setFallbackToDefaultTenant(false);</span>
<span class="nc" id="L700">            cmmnEngineConfiguration.setDefaultTenantProvider(originalDefaultTenantProvider);</span>
        }
<span class="nc" id="L702">    }</span>

    @Test
    @CmmnDeployment
    public void testFallbackToDefaultTenantFalse() {
<span class="nc" id="L707">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L708">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L709">                .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L710">                .overrideCaseDefinitionTenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L711">                .fallbackToDefaultTenant()</span>
<span class="nc" id="L712">                .start();</span>
<span class="nc" id="L713">        assertThatThrownBy(() -&gt; assertBlockingCaseTaskFlow(caseInstance))</span>
<span class="nc" id="L714">                .isInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L715">                .hasMessage(&quot;Case definition was not found by key 'oneTaskCase' and tenant 'flowable'&quot;);</span>
<span class="nc" id="L716">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/CaseTaskTest.testSameDeployment.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/oneTaskCase.cmmn&quot;
    })
    public void testSameDeployment() {
<span class="nc" id="L724">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L725">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L726">                .start();</span>

<span class="nc" id="L728">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L729">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L730">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L731">                .singleResult();</span>
<span class="nc" id="L732">        assertThat(planItemInstance).isNotNull();</span>

        // Triggering the task should start the child case instance
<span class="nc" id="L735">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>

<span class="nc" id="L737">        CaseInstance childCase = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L738">                .caseInstanceParentId(caseInstance.getId())</span>
<span class="nc" id="L739">                .singleResult();</span>

<span class="nc" id="L741">        assertThat(childCase).isNotNull();</span>

<span class="nc" id="L743">        PlanItemInstance childPlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L744">                .caseInstanceId(childCase.getId())</span>
<span class="nc" id="L745">                .singleResult();</span>

<span class="nc" id="L747">        assertThat(childPlanItemInstance).isNotNull();</span>
<span class="nc" id="L748">        assertThat(childPlanItemInstance.getName()).isEqualTo(&quot;The Task&quot;);</span>

<span class="nc" id="L750">        String v2Deployment = cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L751">                .addClasspathResource(&quot;org/flowable/cmmn/test/runtime/oneTaskCaseV2.cmmn&quot;)</span>
<span class="nc" id="L752">                .deploy()</span>
<span class="nc" id="L753">                .getId();</span>

        try {
            // Starting after V2 deployment should use the same deployment task
<span class="nc" id="L757">            caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L758">                    .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L759">                    .start();</span>

<span class="nc" id="L761">            planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L762">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L763">                    .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L764">                    .singleResult();</span>
<span class="nc" id="L765">            assertThat(planItemInstance).isNotNull();</span>

            // Triggering the task should start the child case instance
<span class="nc" id="L768">            cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>

<span class="nc" id="L770">            childCase = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L771">                    .caseInstanceParentId(caseInstance.getId())</span>
<span class="nc" id="L772">                    .singleResult();</span>

<span class="nc" id="L774">            assertThat(childCase).isNotNull();</span>

<span class="nc" id="L776">            childPlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L777">                    .caseInstanceId(childCase.getId())</span>
<span class="nc" id="L778">                    .singleResult();</span>

<span class="nc" id="L780">            assertThat(childPlanItemInstance).isNotNull();</span>
<span class="nc" id="L781">            assertThat(childPlanItemInstance.getName()).isEqualTo(&quot;The Task&quot;);</span>
        } finally {
<span class="nc" id="L783">            cmmnRepositoryService.deleteDeployment(v2Deployment, true);</span>
        }
<span class="nc" id="L785">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/CaseTaskTest.testSameDeployment.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/oneTaskCase.cmmn&quot;
    }, tenantId = &quot;flowable&quot;)
    public void testSameDeploymentDifferentTenants() {
<span class="nc" id="L793">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L794">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L795">                .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L796">                .start();</span>

<span class="nc" id="L798">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L799">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L800">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L801">                .singleResult();</span>
<span class="nc" id="L802">        assertThat(planItemInstance).isNotNull();</span>

        // Triggering the task should start the child case instance
<span class="nc" id="L805">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>

<span class="nc" id="L807">        CaseInstance childCase = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L808">                .caseInstanceParentId(caseInstance.getId())</span>
<span class="nc" id="L809">                .singleResult();</span>

<span class="nc" id="L811">        assertThat(childCase).isNotNull();</span>
<span class="nc" id="L812">        assertThat(childCase.getTenantId()).isEqualTo(&quot;flowable&quot;);</span>

<span class="nc" id="L814">        PlanItemInstance childPlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L815">                .caseInstanceId(childCase.getId())</span>
<span class="nc" id="L816">                .singleResult();</span>

<span class="nc" id="L818">        assertThat(childPlanItemInstance).isNotNull();</span>
<span class="nc" id="L819">        assertThat(childPlanItemInstance.getName()).isEqualTo(&quot;The Task&quot;);</span>

<span class="nc" id="L821">        String v2Deployment = cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L822">                .addClasspathResource(&quot;org/flowable/cmmn/test/runtime/oneTaskCaseV2.cmmn&quot;)</span>
<span class="nc" id="L823">                .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L824">                .deploy()</span>
<span class="nc" id="L825">                .getId();</span>

        try {
            // Starting after V2 deployment should use the same deployment task
<span class="nc" id="L829">            caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L830">                    .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L831">                    .tenantId(&quot;flowable&quot;)</span>
<span class="nc" id="L832">                    .start();</span>

<span class="nc" id="L834">            planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L835">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L836">                    .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L837">                    .singleResult();</span>
<span class="nc" id="L838">            assertThat(planItemInstance).isNotNull();</span>

            // Triggering the task should start the child case instance
<span class="nc" id="L841">            cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>

<span class="nc" id="L843">            childCase = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L844">                    .caseInstanceParentId(caseInstance.getId())</span>
<span class="nc" id="L845">                    .singleResult();</span>

<span class="nc" id="L847">            assertThat(childCase).isNotNull();</span>
<span class="nc" id="L848">            assertThat(childCase.getTenantId()).isEqualTo(&quot;flowable&quot;);</span>

<span class="nc" id="L850">            childPlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L851">                    .caseInstanceId(childCase.getId())</span>
<span class="nc" id="L852">                    .singleResult();</span>

<span class="nc" id="L854">            assertThat(childPlanItemInstance).isNotNull();</span>
<span class="nc" id="L855">            assertThat(childPlanItemInstance.getName()).isEqualTo(&quot;The Task&quot;);</span>
        } finally {
<span class="nc" id="L857">            cmmnRepositoryService.deleteDeployment(v2Deployment, true);</span>
        }
<span class="nc" id="L859">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/CaseTaskTest.testSameDeploymentGlobal.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/oneTaskCase.cmmn&quot;
    })
    public void testGlobalSameDeployment() {
<span class="nc" id="L867">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L868">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L869">                .start();</span>

<span class="nc" id="L871">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L872">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L873">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L874">                .singleResult();</span>
<span class="nc" id="L875">        assertThat(planItemInstance).isNotNull();</span>

        // Triggering the task should start the child case instance
<span class="nc" id="L878">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>

<span class="nc" id="L880">        CaseInstance childCase = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L881">                .caseInstanceParentId(caseInstance.getId())</span>
<span class="nc" id="L882">                .singleResult();</span>

<span class="nc" id="L884">        assertThat(childCase).isNotNull();</span>

<span class="nc" id="L886">        PlanItemInstance childPlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L887">                .caseInstanceId(childCase.getId())</span>
<span class="nc" id="L888">                .singleResult();</span>

<span class="nc" id="L890">        assertThat(childPlanItemInstance).isNotNull();</span>
<span class="nc" id="L891">        assertThat(childPlanItemInstance.getName()).isEqualTo(&quot;The Task&quot;);</span>

<span class="nc" id="L893">        String v2Deployment = cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L894">                .addClasspathResource(&quot;org/flowable/cmmn/test/runtime/oneTaskCaseV2.cmmn&quot;)</span>
<span class="nc" id="L895">                .deploy()</span>
<span class="nc" id="L896">                .getId();</span>

        try {
            // Starting after V2 deployment should not use the same deployment task
<span class="nc" id="L900">            caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L901">                    .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L902">                    .start();</span>

<span class="nc" id="L904">            planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L905">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L906">                    .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L907">                    .singleResult();</span>
<span class="nc" id="L908">            assertThat(planItemInstance).isNotNull();</span>

            // Triggering the task should start the child case instance
<span class="nc" id="L911">            cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>

<span class="nc" id="L913">            childCase = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L914">                    .caseInstanceParentId(caseInstance.getId())</span>
<span class="nc" id="L915">                    .singleResult();</span>

<span class="nc" id="L917">            assertThat(childCase).isNotNull();</span>

<span class="nc" id="L919">            childPlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L920">                    .caseInstanceId(childCase.getId())</span>
<span class="nc" id="L921">                    .singleResult();</span>

<span class="nc" id="L923">            assertThat(childPlanItemInstance).isNotNull();</span>
<span class="nc" id="L924">            assertThat(childPlanItemInstance.getName()).isEqualTo(&quot;The Task V2&quot;);</span>
        } finally {
<span class="nc" id="L926">            cmmnRepositoryService.deleteDeployment(v2Deployment, true);</span>
        }
<span class="nc" id="L928">    }</span>

    @Test
    @CmmnDeployment
    public void testSameDeploymentFalse() {
<span class="nc" id="L933">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L934">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L935">                .start();</span>

<span class="nc" id="L937">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L938">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L939">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L940">                .singleResult();</span>
<span class="nc" id="L941">        assertThat(planItemInstance).isNotNull();</span>

        // Triggering the task should start the child case instance
<span class="nc" id="L944">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>

<span class="nc" id="L946">        CaseInstance childCase = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L947">                .caseInstanceParentId(caseInstance.getId())</span>
<span class="nc" id="L948">                .singleResult();</span>

<span class="nc" id="L950">        assertThat(childCase).isNotNull();</span>

<span class="nc" id="L952">        PlanItemInstance childPlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L953">                .caseInstanceId(childCase.getId())</span>
<span class="nc" id="L954">                .singleResult();</span>

<span class="nc" id="L956">        assertThat(childPlanItemInstance).isNotNull();</span>
<span class="nc" id="L957">        assertThat(childPlanItemInstance.getName()).isEqualTo(&quot;The Task&quot;);</span>

<span class="nc" id="L959">        String v2Deployment = cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L960">                .addClasspathResource(&quot;org/flowable/cmmn/test/runtime/oneTaskCaseV2.cmmn&quot;)</span>
<span class="nc" id="L961">                .deploy()</span>
<span class="nc" id="L962">                .getId();</span>

        try {
            // Starting after V2 deployment should not use the same deployment task
<span class="nc" id="L966">            caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L967">                    .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L968">                    .start();</span>

<span class="nc" id="L970">            planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L971">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L972">                    .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L973">                    .singleResult();</span>
<span class="nc" id="L974">            assertThat(planItemInstance).isNotNull();</span>

            // Triggering the task should start the child case instance
<span class="nc" id="L977">            cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>

<span class="nc" id="L979">            childCase = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L980">                    .caseInstanceParentId(caseInstance.getId())</span>
<span class="nc" id="L981">                    .singleResult();</span>

<span class="nc" id="L983">            assertThat(childCase).isNotNull();</span>

<span class="nc" id="L985">            childPlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L986">                    .caseInstanceId(childCase.getId())</span>
<span class="nc" id="L987">                    .singleResult();</span>

<span class="nc" id="L989">            assertThat(childPlanItemInstance).isNotNull();</span>
<span class="nc" id="L990">            assertThat(childPlanItemInstance.getName()).isEqualTo(&quot;The Task V2&quot;);</span>
        } finally {
<span class="nc" id="L992">            cmmnRepositoryService.deleteDeployment(v2Deployment, true);</span>
        }

<span class="nc" id="L995">    }</span>

    @Test
    public void testEntityLinksAreDeleted() {
<span class="nc" id="L999">        String deploymentId = cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L1000">                .addClasspathResource(&quot;org/flowable/cmmn/test/runtime/oneHumanTaskCase.cmmn&quot;).deploy().getId();</span>

<span class="nc" id="L1002">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;oneHumanTaskCase&quot;).start();</span>
        try {
<span class="nc" id="L1004">            Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L1005">            assertThat(task.getName()).isEqualTo(&quot;Sub task&quot;);</span>

<span class="nc" id="L1007">            assertThat(cmmnRuntimeService.getEntityLinkChildrenForCaseInstance(caseInstance.getId())).hasSize(1);</span>

<span class="nc bnc" id="L1009" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1010">                assertThat(cmmnHistoryService.getHistoricEntityLinkChildrenForCaseInstance(caseInstance.getId())).hasSize(1);</span>
            }

<span class="nc" id="L1013">            cmmnTaskService.complete(task.getId());</span>

<span class="nc bnc" id="L1015" title="All 2 branches missed.">            if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1016">                assertThat(cmmnHistoryService.getHistoricEntityLinkChildrenForCaseInstance(caseInstance.getId())).hasSize(1);</span>
            }
        } finally {
<span class="nc" id="L1019">            cmmnRepositoryService.deleteDeployment(deploymentId, true);</span>
        }

<span class="nc bnc" id="L1022" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1023">            assertThat(cmmnHistoryService.getHistoricEntityLinkChildrenForCaseInstance(caseInstance.getId())).isEmpty();</span>
        }
<span class="nc" id="L1025">    }</span>

    @Test
    @CmmnDeployment
    public void testIOParameters() {
<span class="nc" id="L1030">        String innerCaseDeploymentId = cmmnRepositoryService.createDeployment()</span>
<span class="nc" id="L1031">                .addClasspathResource(&quot;org/flowable/cmmn/test/runtime/oneHumanTaskCase.cmmn&quot;)</span>
<span class="nc" id="L1032">                .deploy()</span>
<span class="nc" id="L1033">                .getId();</span>
<span class="nc" id="L1034">        String inVariableContent = &quot;Variable Test Content In&quot;;</span>
<span class="nc" id="L1035">        String outVariableContent = &quot;Variable Test Content Out&quot;;</span>
<span class="nc" id="L1036">        CaseInstance outerCaseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L1037">                .caseDefinitionKey(&quot;outerCase&quot;)</span>
<span class="nc" id="L1038">                .variable(&quot;testContentOuterTaskIn&quot;, inVariableContent)</span>
<span class="nc" id="L1039">                .start();</span>

<span class="nc" id="L1041">        CaseInstance innerCaseInstance = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1042">                .caseDefinitionKey(&quot;oneHumanTaskCase&quot;)</span>
<span class="nc" id="L1043">                .includeCaseVariables()</span>
<span class="nc" id="L1044">                .singleResult();</span>

<span class="nc" id="L1046">        assertThat(innerCaseInstance.getCaseVariables())</span>
<span class="nc" id="L1047">                .isNotNull()</span>
<span class="nc" id="L1048">                .containsExactlyEntriesOf(Collections.singletonMap(&quot;testContentInnerTaskIn&quot;, inVariableContent));</span>

<span class="nc" id="L1050">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(innerCaseInstance.getId()).singleResult();</span>
<span class="nc" id="L1051">        cmmnTaskService.complete(task.getId(), Collections.singletonMap(&quot;testContentInnerTaskOut&quot;, outVariableContent));</span>

<span class="nc bnc" id="L1053" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1054">            Map&lt;String, Object&gt; outerCaseVariables = cmmnHistoryService.createHistoricCaseInstanceQuery()</span>
<span class="nc" id="L1055">                .caseInstanceId(outerCaseInstance.getId())</span>
<span class="nc" id="L1056">                .includeCaseVariables()</span>
<span class="nc" id="L1057">                .singleResult()</span>
<span class="nc" id="L1058">                .getCaseVariables();</span>

<span class="nc" id="L1060">            assertThat(outerCaseVariables)</span>
<span class="nc" id="L1061">                .isNotNull()</span>
<span class="nc" id="L1062">                .containsEntry(&quot;testContentOuterTaskOut&quot;, outVariableContent);</span>
        }
<span class="nc" id="L1064">        cmmnRepositoryService.deleteDeployment(innerCaseDeploymentId, true);</span>
<span class="nc" id="L1065">    }</span>

    @Test
    @CmmnDeployment
    public void testWithSpecifiedBusinessKey() {
<span class="nc" id="L1070">        cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L1071">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L1072">                .start();</span>

<span class="nc" id="L1074">        CaseInstance subCase = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1075">                .caseDefinitionKey(&quot;oneTaskCase&quot;)</span>
<span class="nc" id="L1076">                .singleResult();</span>

<span class="nc" id="L1078">        assertThat(subCase)</span>
<span class="nc" id="L1079">                .isNotNull()</span>
<span class="nc" id="L1080">                .extracting(CaseInstance::getBusinessKey)</span>
<span class="nc" id="L1081">                .isEqualTo(&quot;myBusinessKey&quot;);</span>

<span class="nc" id="L1083">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L1084">                .caseInstanceId(subCase.getId())</span>
<span class="nc" id="L1085">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L1086">                .singleResult();</span>
<span class="nc" id="L1087">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>
<span class="nc" id="L1088">    }</span>

    @Test
    @CmmnDeployment
    public void testWithSpecifiedBusinessKeyAndInheritBusinessKey() {
<span class="nc" id="L1093">        cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L1094">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L1095">                .businessKey(&quot;dummyBusinessKey&quot;)</span>
<span class="nc" id="L1096">                .start();</span>

<span class="nc" id="L1098">        CaseInstance subCase = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1099">                .caseDefinitionKey(&quot;oneTaskCase&quot;)</span>
<span class="nc" id="L1100">                .singleResult();</span>

<span class="nc" id="L1102">        assertThat(subCase)</span>
<span class="nc" id="L1103">                .isNotNull()</span>
<span class="nc" id="L1104">                .extracting(CaseInstance::getBusinessKey)</span>
<span class="nc" id="L1105">                .isEqualTo(&quot;myBusinessKey&quot;);</span>

<span class="nc" id="L1107">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L1108">                .caseInstanceId(subCase.getId())</span>
<span class="nc" id="L1109">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L1110">                .singleResult();</span>
<span class="nc" id="L1111">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>
<span class="nc" id="L1112">    }</span>

    @Test
    @CmmnDeployment
    public void testWithInheritBusinessKey() {
<span class="nc" id="L1117">        cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L1118">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L1119">                .businessKey(&quot;myBusinessKey&quot;)</span>
<span class="nc" id="L1120">                .start();</span>

<span class="nc" id="L1122">        CaseInstance subCase = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1123">                .caseDefinitionKey(&quot;oneTaskCase&quot;)</span>
<span class="nc" id="L1124">                .singleResult();</span>

<span class="nc" id="L1126">        assertThat(subCase)</span>
<span class="nc" id="L1127">                .isNotNull()</span>
<span class="nc" id="L1128">                .extracting(CaseInstance::getBusinessKey)</span>
<span class="nc" id="L1129">                .isEqualTo(&quot;myBusinessKey&quot;);</span>

<span class="nc" id="L1131">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L1132">                .caseInstanceId(subCase.getId())</span>
<span class="nc" id="L1133">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L1134">                .singleResult();</span>
<span class="nc" id="L1135">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>
<span class="nc" id="L1136">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/runtime/CaseTaskTest.testWithInheritBusinessKey.cmmn&quot;)
    public void testWithInheritBusinessKeyButWithoutBusinessKey() {
<span class="nc" id="L1141">        cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L1142">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L1143">                .start();</span>

<span class="nc" id="L1145">        CaseInstance subCase = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1146">                .caseDefinitionKey(&quot;oneTaskCase&quot;)</span>
<span class="nc" id="L1147">                .singleResult();</span>

<span class="nc" id="L1149">        assertThat(subCase)</span>
<span class="nc" id="L1150">                .isNotNull()</span>
<span class="nc" id="L1151">                .extracting(CaseInstance::getBusinessKey)</span>
<span class="nc" id="L1152">                .isNull();</span>

<span class="nc" id="L1154">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L1155">                .caseInstanceId(subCase.getId())</span>
<span class="nc" id="L1156">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L1157">                .singleResult();</span>
<span class="nc" id="L1158">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>
<span class="nc" id="L1159">    }</span>

    @Test
    @CmmnDeployment
    public void testIdVariableName() {
<span class="nc" id="L1164">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L1165">                .caseDefinitionKey(&quot;testIdVariableName&quot;)</span>
<span class="nc" id="L1166">                .start();</span>

<span class="nc" id="L1168">        CaseInstance subCase = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1169">                .caseDefinitionKey(&quot;oneTaskCase&quot;)</span>
<span class="nc" id="L1170">                .singleResult();</span>

<span class="nc" id="L1172">        assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;caseIdVariable&quot;)).isEqualTo(subCase.getId());</span>
<span class="nc" id="L1173">    }</span>

    @Test
    @CmmnDeployment
    public void testIdVariableNameExpression() {
<span class="nc" id="L1178">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L1179">                .caseDefinitionKey(&quot;testIdVariableName&quot;)</span>
<span class="nc" id="L1180">                .variable(&quot;idVariableName&quot;, &quot;test&quot;)</span>
<span class="nc" id="L1181">                .start();</span>

<span class="nc" id="L1183">        CaseInstance subCase = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L1184">                .caseDefinitionKey(&quot;oneTaskCase&quot;)</span>
<span class="nc" id="L1185">                .singleResult();</span>

<span class="nc" id="L1187">        assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;test&quot;)).isEqualTo(subCase.getId());</span>
<span class="nc" id="L1188">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/CaseTaskTest.testThreeLevelRootCase.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/CaseTaskTest.testThreeLevelLevel1Case.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/oneHumanTaskCase.cmmn&quot;
    })
    public void testThreeLevelCase() {
<span class="nc" id="L1197">        CaseInstance rootCase = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L1198">                .caseDefinitionKey(&quot;rootCase&quot;)</span>
<span class="nc" id="L1199">                .start();</span>

<span class="nc" id="L1201">        String rootCaseId = rootCase.getId();</span>
        
<span class="nc" id="L1203">        PlanItemInstance rootCasePlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L1204">                .caseInstanceId(rootCaseId)</span>
<span class="nc" id="L1205">                .planItemDefinitionId(&quot;caseTask&quot;)</span>
<span class="nc" id="L1206">                .singleResult();</span>

<span class="nc" id="L1208">        String level1CaseId = (String) rootCase.getCaseVariables().get(&quot;caseIdVariable&quot;);</span>
        
<span class="nc" id="L1210">        PlanItemInstance level1CasePlanItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L1211">                .caseInstanceId(level1CaseId)</span>
<span class="nc" id="L1212">                .planItemDefinitionId(&quot;caseTask&quot;)</span>
<span class="nc" id="L1213">                .singleResult();</span>
        
<span class="nc" id="L1215">        String oneHumanTaskCaseId = (String) cmmnRuntimeService.getVariable(level1CaseId, &quot;caseIdVariable&quot;);</span>

<span class="nc" id="L1217">        Task task = cmmnTaskService.createTaskQuery().caseInstanceIdWithChildren(rootCaseId).singleResult();</span>
<span class="nc" id="L1218">        assertThat(task.getScopeId()).isEqualTo(oneHumanTaskCaseId);</span>

<span class="nc" id="L1220">        List&lt;EntityLink&gt; entityLinks = cmmnRuntimeService.getEntityLinkChildrenForCaseInstance(rootCaseId);</span>

<span class="nc" id="L1222">        assertThat(entityLinks)</span>
<span class="nc" id="L1223">                .extracting(EntityLink::getScopeId, EntityLink::getSubScopeId, EntityLink::getParentElementId, </span>
                        EntityLink::getScopeType, EntityLink::getHierarchyType, EntityLink::getReferenceScopeId,
                        EntityLink::getReferenceScopeType, EntityLink::getLinkType)
<span class="nc" id="L1226">                .as(&quot;scopeId, subScopeId, parentElementId, scopeType, hierarchyType, referenceScopeId, referenceScopeType, linkType&quot;)</span>
<span class="nc" id="L1227">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1228">                        tuple(rootCaseId, rootCasePlanItemInstance.getId(), &quot;caseTask&quot;, ScopeTypes.CMMN, HierarchyType.ROOT, level1CaseId, ScopeTypes.CMMN, EntityLinkType.CHILD),</span>
<span class="nc" id="L1229">                        tuple(rootCaseId, level1CasePlanItemInstance.getId(), &quot;caseTask&quot;, ScopeTypes.CMMN, HierarchyType.ROOT, oneHumanTaskCaseId, ScopeTypes.CMMN, EntityLinkType.CHILD),</span>
<span class="nc" id="L1230">                        tuple(rootCaseId, task.getSubScopeId(), &quot;theTask&quot;, ScopeTypes.CMMN, HierarchyType.ROOT, task.getId(), ScopeTypes.TASK, EntityLinkType.CHILD)</span>
                );

<span class="nc" id="L1233">        assertThat(entityLinks)</span>
<span class="nc" id="L1234">                .extracting(EntityLink::getRootScopeId, EntityLink::getRootScopeType)</span>
<span class="nc" id="L1235">                .containsOnly(</span>
<span class="nc" id="L1236">                        tuple(rootCaseId, ScopeTypes.CMMN)</span>
                );

<span class="nc" id="L1239">        entityLinks = cmmnRuntimeService.getEntityLinkChildrenForCaseInstance(level1CaseId);</span>

<span class="nc" id="L1241">        assertThat(entityLinks)</span>
<span class="nc" id="L1242">                .extracting(EntityLink::getScopeId, EntityLink::getSubScopeId, EntityLink::getParentElementId, </span>
                        EntityLink::getScopeType, EntityLink::getHierarchyType, EntityLink::getReferenceScopeId,
                        EntityLink::getReferenceScopeType, EntityLink::getLinkType)
<span class="nc" id="L1245">                .as(&quot;scopeId, subScopeId, parentElementId, scopeType, hierarchyType, referenceScopeId, referenceScopeType, linkType&quot;)</span>
<span class="nc" id="L1246">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1247">                        tuple(level1CaseId, level1CasePlanItemInstance.getId(), &quot;caseTask&quot;, ScopeTypes.CMMN, HierarchyType.PARENT, oneHumanTaskCaseId, ScopeTypes.CMMN, EntityLinkType.CHILD),</span>
<span class="nc" id="L1248">                        tuple(level1CaseId, task.getSubScopeId(), &quot;theTask&quot;, ScopeTypes.CMMN, HierarchyType.GRAND_PARENT, task.getId(), ScopeTypes.TASK, EntityLinkType.CHILD)</span>
                );

<span class="nc" id="L1251">        assertThat(entityLinks)</span>
<span class="nc" id="L1252">                .extracting(EntityLink::getRootScopeId, EntityLink::getRootScopeType)</span>
<span class="nc" id="L1253">                .containsOnly(</span>
<span class="nc" id="L1254">                        tuple(rootCaseId, ScopeTypes.CMMN)</span>
                );

<span class="nc" id="L1257">        entityLinks = cmmnRuntimeService.getEntityLinkChildrenForCaseInstance(oneHumanTaskCaseId);</span>

<span class="nc" id="L1259">        assertThat(entityLinks)</span>
<span class="nc" id="L1260">                .extracting(EntityLink::getScopeId, EntityLink::getSubScopeId, EntityLink::getParentElementId,</span>
                        EntityLink::getScopeType, EntityLink::getHierarchyType, EntityLink::getReferenceScopeId,
                        EntityLink::getReferenceScopeType, EntityLink::getLinkType)
<span class="nc" id="L1263">                .as(&quot;scopeId, subScopeId, parentElementId, scopeType, hierarchyType, referenceScopeId, referenceScopeType, linkType&quot;)</span>
<span class="nc" id="L1264">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1265">                        tuple(oneHumanTaskCaseId, task.getSubScopeId(), &quot;theTask&quot;, ScopeTypes.CMMN, HierarchyType.PARENT, task.getId(), ScopeTypes.TASK, EntityLinkType.CHILD)</span>
                );

<span class="nc bnc" id="L1268" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1269">            List&lt;HistoricEntityLink&gt; historicEntityLinks = cmmnHistoryService.getHistoricEntityLinkChildrenForCaseInstance(rootCaseId);</span>

<span class="nc" id="L1271">            assertThat(historicEntityLinks)</span>
<span class="nc" id="L1272">                .extracting(HistoricEntityLink::getScopeId, HistoricEntityLink::getSubScopeId, HistoricEntityLink::getParentElementId,</span>
                    HistoricEntityLink::getScopeType, HistoricEntityLink::getHierarchyType, HistoricEntityLink::getReferenceScopeId,
                    HistoricEntityLink::getReferenceScopeType, HistoricEntityLink::getLinkType)
<span class="nc" id="L1275">                .as(&quot;scopeId, subScopeId, parentElementId, scopeType, hierarchyType, referenceScopeId, referenceScopeType, linkType&quot;)</span>
<span class="nc" id="L1276">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1277">                    tuple(rootCaseId, rootCasePlanItemInstance.getId(), &quot;caseTask&quot;, ScopeTypes.CMMN, HierarchyType.ROOT, level1CaseId, ScopeTypes.CMMN,</span>
                        EntityLinkType.CHILD),
<span class="nc" id="L1279">                    tuple(rootCaseId, level1CasePlanItemInstance.getId(), &quot;caseTask&quot;, ScopeTypes.CMMN, HierarchyType.ROOT, oneHumanTaskCaseId, ScopeTypes.CMMN,</span>
                        EntityLinkType.CHILD),
<span class="nc" id="L1281">                    tuple(rootCaseId, task.getSubScopeId(), &quot;theTask&quot;, ScopeTypes.CMMN, HierarchyType.ROOT, task.getId(), ScopeTypes.TASK, EntityLinkType.CHILD)</span>
                );

<span class="nc" id="L1284">            assertThat(historicEntityLinks)</span>
<span class="nc" id="L1285">                .extracting(HistoricEntityLink::getRootScopeId, HistoricEntityLink::getRootScopeType)</span>
<span class="nc" id="L1286">                .containsOnly(</span>
<span class="nc" id="L1287">                    tuple(rootCaseId, ScopeTypes.CMMN)</span>
                );

<span class="nc" id="L1290">            historicEntityLinks = cmmnHistoryService.getHistoricEntityLinkChildrenForCaseInstance(level1CaseId);</span>

<span class="nc" id="L1292">            assertThat(historicEntityLinks)</span>
<span class="nc" id="L1293">                .extracting(HistoricEntityLink::getScopeId, HistoricEntityLink::getSubScopeId, HistoricEntityLink::getParentElementId,</span>
                    HistoricEntityLink::getScopeType, HistoricEntityLink::getHierarchyType, HistoricEntityLink::getReferenceScopeId,
                    HistoricEntityLink::getReferenceScopeType, HistoricEntityLink::getLinkType)
<span class="nc" id="L1296">                .as(&quot;scopeId, subScopeId, parentElementId, scopeType, hierarchyType, referenceScopeId, referenceScopeType, linkType&quot;)</span>
<span class="nc" id="L1297">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1298">                    tuple(level1CaseId, level1CasePlanItemInstance.getId(), &quot;caseTask&quot;, ScopeTypes.CMMN, HierarchyType.PARENT, oneHumanTaskCaseId,</span>
                        ScopeTypes.CMMN, EntityLinkType.CHILD),
<span class="nc" id="L1300">                    tuple(level1CaseId, task.getSubScopeId(), &quot;theTask&quot;, ScopeTypes.CMMN, HierarchyType.GRAND_PARENT, task.getId(), ScopeTypes.TASK,</span>
                        EntityLinkType.CHILD)
                );

<span class="nc" id="L1304">            assertThat(historicEntityLinks)</span>
<span class="nc" id="L1305">                .extracting(HistoricEntityLink::getRootScopeId, HistoricEntityLink::getRootScopeType)</span>
<span class="nc" id="L1306">                .containsOnly(</span>
<span class="nc" id="L1307">                    tuple(rootCaseId, ScopeTypes.CMMN)</span>
                );

<span class="nc" id="L1310">            historicEntityLinks = cmmnHistoryService.getHistoricEntityLinkChildrenForCaseInstance(oneHumanTaskCaseId);</span>

<span class="nc" id="L1312">            assertThat(historicEntityLinks)</span>
<span class="nc" id="L1313">                .extracting(HistoricEntityLink::getScopeId, HistoricEntityLink::getSubScopeId, HistoricEntityLink::getParentElementId,</span>
                    HistoricEntityLink::getScopeType, HistoricEntityLink::getHierarchyType, HistoricEntityLink::getReferenceScopeId,
                    HistoricEntityLink::getReferenceScopeType, HistoricEntityLink::getLinkType)
<span class="nc" id="L1316">                .as(&quot;scopeId, subScopeId, parentElementId, scopeType, hierarchyType, referenceScopeId, referenceScopeType, linkType&quot;)</span>
<span class="nc" id="L1317">                .containsExactlyInAnyOrder(</span>
<span class="nc" id="L1318">                    tuple(oneHumanTaskCaseId, task.getSubScopeId(), &quot;theTask&quot;, ScopeTypes.CMMN, HierarchyType.PARENT, task.getId(), ScopeTypes.TASK,</span>
                        EntityLinkType.CHILD)
                );

<span class="nc" id="L1322">            assertThat(historicEntityLinks)</span>
<span class="nc" id="L1323">                .extracting(HistoricEntityLink::getRootScopeId, HistoricEntityLink::getRootScopeType)</span>
<span class="nc" id="L1324">                .containsOnly(</span>
<span class="nc" id="L1325">                    tuple(rootCaseId, ScopeTypes.CMMN)</span>
                );
        }
<span class="nc" id="L1328">    }</span>

    @Test
    @CmmnDeployment(extraResources = &quot;org/flowable/cmmn/test/runtime/CaseTaskTest.testSubCaseExitsParentCaseSubCase.cmmn&quot;)
    public void testSubCaseExitsParentCase() {
        // Case instance starts and ends immediately
<span class="nc" id="L1334">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;main&quot;).start();</span>

<span class="nc bnc" id="L1336" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1337">            HistoricCaseInstance historicSubCaseInstance = cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceParentId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L1338">            assertThat(historicSubCaseInstance.getEndTime()).isNotNull();</span>
        }

<span class="nc" id="L1341">        assertCaseInstanceEnded(caseInstance);</span>

<span class="nc bnc" id="L1343" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1344">            HistoricVariableInstance historicVariableInstance = cmmnHistoryService.createHistoricVariableInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L1345">            assertThat(historicVariableInstance.getValue()).isEqualTo(&quot;test&quot;);</span>
        }
<span class="nc" id="L1347">    }</span>

    @Test
    @CmmnDeployment(extraResources = &quot;org/flowable/cmmn/test/runtime/CaseTaskTest.testSubCaseExitsParentCaseSubCaseWithWaitState.cmmn&quot;)
    public void testSubCaseWithWaitStateExitsParentCase() {
<span class="nc" id="L1352">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;main&quot;).start();</span>

<span class="nc" id="L1354">        Task task = cmmnTaskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L1355">        assertThat(task).isNotNull();</span>

<span class="nc" id="L1357">        CaseInstance subCaseInstance = cmmnRuntimeService.createCaseInstanceQuery().caseInstanceParentId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L1358">        assertThat(subCaseInstance).isNotNull();</span>

<span class="nc bnc" id="L1360" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1361">            HistoricCaseInstance historicSubCaseInstance = cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceParentId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L1362">            assertThat(historicSubCaseInstance.getEndTime()).isNull();</span>
        }

<span class="nc" id="L1365">        cmmnTaskService.complete(task.getId());</span>

<span class="nc" id="L1367">        assertCaseInstanceEnded(subCaseInstance);</span>
<span class="nc" id="L1368">        assertCaseInstanceEnded(caseInstance);</span>

<span class="nc bnc" id="L1370" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1371">            HistoricVariableInstance historicVariableInstance = cmmnHistoryService.createHistoricVariableInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L1372">            assertThat(historicVariableInstance.getValue()).isEqualTo(&quot;test&quot;);</span>
        }

<span class="nc" id="L1375">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>