<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RuntimeServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.cmmn.test.runtime</a> &gt; <span class="el_source">RuntimeServiceTest.java</span></div><h1>RuntimeServiceTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.cmmn.test.runtime;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.assertj.core.api.Assertions.tuple;

import java.time.Instant;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.flowable.cmmn.api.history.HistoricCaseInstance;
import org.flowable.cmmn.api.history.HistoricCaseInstanceQuery;
import org.flowable.cmmn.api.history.HistoricMilestoneInstance;
import org.flowable.cmmn.api.repository.CaseDefinition;
import org.flowable.cmmn.api.runtime.CaseInstance;
import org.flowable.cmmn.api.runtime.CaseInstanceQuery;
import org.flowable.cmmn.api.runtime.CaseInstanceState;
import org.flowable.cmmn.api.runtime.MilestoneInstance;
import org.flowable.cmmn.api.runtime.PlanItemInstance;
import org.flowable.cmmn.api.runtime.PlanItemInstanceState;
import org.flowable.cmmn.engine.interceptor.StartCaseInstanceAfterContext;
import org.flowable.cmmn.engine.interceptor.StartCaseInstanceBeforeContext;
import org.flowable.cmmn.engine.interceptor.StartCaseInstanceInterceptor;
import org.flowable.cmmn.engine.test.CmmnDeployment;
import org.flowable.cmmn.engine.test.FlowableCmmnTestCase;
import org.flowable.cmmn.engine.test.impl.CmmnHistoryTestHelper;
import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.api.FlowableIllegalArgumentException;
import org.flowable.common.engine.api.FlowableObjectNotFoundException;
import org.flowable.common.engine.api.scope.ScopeTypes;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.common.engine.impl.identity.Authentication;
import org.flowable.identitylink.api.IdentityLink;
import org.flowable.identitylink.api.IdentityLinkType;
import org.flowable.identitylink.api.history.HistoricIdentityLink;
import org.flowable.variable.api.persistence.entity.VariableInstance;
import org.junit.Test;

/**
 * @author Joram Barrez
 * @author Filip Hrisafov
 */
<span class="nc" id="L60">public class RuntimeServiceTest extends FlowableCmmnTestCase {</span>

<span class="nc" id="L62">    private static final Map&lt;String, Object&gt; VARIABLES = new HashMap&lt;&gt;();</span>

    static {
<span class="nc" id="L65">        VARIABLES.put(&quot;var&quot;, &quot;test&quot;);</span>
<span class="nc" id="L66">        VARIABLES.put(&quot;numberVar&quot;, 10);</span>
<span class="nc" id="L67">    }</span>

    @Test
    @CmmnDeployment
    public void testStartSimplePassthroughCase() {
<span class="nc" id="L72">        CaseDefinition caseDefinition = cmmnRepositoryService.createCaseDefinitionQuery().singleResult();</span>
<span class="nc" id="L73">        assertThat(caseDefinition.getKey()).isEqualTo(&quot;myCase&quot;);</span>
<span class="nc" id="L74">        assertThat(caseDefinition.getResourceName()).isNotNull();</span>
<span class="nc" id="L75">        assertThat(caseDefinition.getDeploymentId()).isNotNull();</span>
<span class="nc" id="L76">        assertThat(caseDefinition.getVersion()).isPositive();</span>

<span class="nc" id="L78">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionId(caseDefinition.getId()).start();</span>
<span class="nc" id="L79">        assertThat(caseInstance).isNotNull();</span>
<span class="nc" id="L80">        assertThat(caseInstance.getCaseDefinitionId()).isEqualTo(caseDefinition.getId());</span>
<span class="nc" id="L81">        assertThat(caseInstance.getStartTime()).isNotNull();</span>
<span class="nc" id="L82">        assertThat(caseInstance.getState()).isEqualTo(CaseInstanceState.COMPLETED);</span>

<span class="nc" id="L84">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isZero();</span>

<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L87">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isZero();</span>
<span class="nc" id="L88">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isEqualTo(1);</span>

<span class="nc" id="L90">            List&lt;HistoricMilestoneInstance&gt; milestoneInstances = cmmnHistoryService.createHistoricMilestoneInstanceQuery()</span>
<span class="nc" id="L91">                .milestoneInstanceCaseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L92">                .orderByMilestoneName().asc()</span>
<span class="nc" id="L93">                .list();</span>
<span class="nc" id="L94">            assertThat(milestoneInstances)</span>
<span class="nc" id="L95">                .extracting(HistoricMilestoneInstance::getName)</span>
<span class="nc" id="L96">                .containsExactly(&quot;PlanItem Milestone One&quot;, &quot;PlanItem Milestone Two&quot;);</span>
        }
<span class="nc" id="L98">    }</span>

    @Test
    @CmmnDeployment
    public void testStartSimplePassthroughCaseWithBlockingTask() {
<span class="nc" id="L103">        CaseDefinition caseDefinition = cmmnRepositoryService.createCaseDefinitionQuery().singleResult();</span>
<span class="nc" id="L104">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionId(caseDefinition.getId()).start();</span>
<span class="nc" id="L105">        assertThat(caseInstance.getState()).isEqualTo(CaseInstanceState.ACTIVE);</span>

<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L108">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isEqualTo(1);</span>
<span class="nc" id="L109">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isZero();</span>
        }

<span class="nc" id="L112">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(4);</span>

<span class="nc" id="L114">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L115">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L116">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L117">                .singleResult();</span>
<span class="nc" id="L118">        assertThat(planItemInstance).isNotNull();</span>
<span class="nc" id="L119">        assertThat(planItemInstance.getName()).isEqualTo(&quot;Task A&quot;);</span>

<span class="nc" id="L121">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>
<span class="nc" id="L122">        List&lt;MilestoneInstance&gt; mileStones = cmmnRuntimeService.createMilestoneInstanceQuery()</span>
<span class="nc" id="L123">                .milestoneInstanceCaseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L124">                .list();</span>
<span class="nc" id="L125">        assertThat(mileStones)</span>
<span class="nc" id="L126">                .extracting(MilestoneInstance::getName)</span>
<span class="nc" id="L127">                .containsExactly(&quot;PlanItem Milestone One&quot;);</span>

<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L130">            List&lt;HistoricMilestoneInstance&gt; historicMilestoneInstances = cmmnHistoryService.createHistoricMilestoneInstanceQuery()</span>
<span class="nc" id="L131">                .milestoneInstanceCaseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L132">                .list();</span>
<span class="nc" id="L133">            assertThat(historicMilestoneInstances)</span>
<span class="nc" id="L134">                .extracting(HistoricMilestoneInstance::getName)</span>
<span class="nc" id="L135">                .containsExactly(&quot;PlanItem Milestone One&quot;);</span>
        }

<span class="nc" id="L138">        planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L139">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L140">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L141">                .singleResult();</span>
<span class="nc" id="L142">        assertThat(planItemInstance).isNotNull();</span>
<span class="nc" id="L143">        assertThat(planItemInstance.getName()).isEqualTo(&quot;Task B&quot;);</span>
<span class="nc" id="L144">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>

<span class="nc" id="L146">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isZero();</span>

<span class="nc bnc" id="L148" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L149">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isZero();</span>
<span class="nc" id="L150">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isEqualTo(1);</span>
<span class="nc" id="L151">            assertThat(cmmnHistoryService.createHistoricMilestoneInstanceQuery().milestoneInstanceCaseInstanceId(caseInstance.getId()).count()).isEqualTo(2);</span>
        }

<span class="nc bnc" id="L154" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L155">            HistoricCaseInstance historicCaseInstance = cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L156">            assertThat(historicCaseInstance).isNotNull();</span>
<span class="nc" id="L157">            assertThat(historicCaseInstance.getStartTime()).isNotNull();</span>
<span class="nc" id="L158">            assertThat(historicCaseInstance.getEndTime()).isNotNull();</span>
<span class="nc" id="L159">            assertThat(historicCaseInstance.getState()).isEqualTo(CaseInstanceState.COMPLETED);</span>
        }
<span class="nc" id="L161">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/RuntimeServiceTest.testStartSimplePassthroughCaseWithBlockingTask.cmmn&quot; })
    public void testBlockingTaskWithStartInterceptor() {
<span class="nc" id="L166">        TestStartCaseInstanceInterceptor testStartCaseInstanceInterceptor = new TestStartCaseInstanceInterceptor();</span>
<span class="nc" id="L167">        cmmnEngineConfiguration.setStartCaseInstanceInterceptor(testStartCaseInstanceInterceptor);</span>

        try {
<span class="nc" id="L170">            CaseDefinition caseDefinition = cmmnRepositoryService.createCaseDefinitionQuery().singleResult();</span>
<span class="nc" id="L171">            CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionId(caseDefinition.getId()).start();</span>
<span class="nc" id="L172">            assertThat(caseInstance.getState()).isEqualTo(CaseInstanceState.ACTIVE);</span>

<span class="nc" id="L174">            assertThat(testStartCaseInstanceInterceptor.getBeforeStartCaseInstanceCounter()).isEqualTo(1);</span>
<span class="nc" id="L175">            assertThat(testStartCaseInstanceInterceptor.getAfterStartCaseInstanceCounter()).isEqualTo(1);</span>

<span class="nc" id="L177">            assertThat(caseInstance.getBusinessKey()).isEqualTo(&quot;testKey&quot;);</span>
<span class="nc" id="L178">            assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;beforeContextVar&quot;)).isEqualTo(&quot;test&quot;);</span>

        } finally {
<span class="nc" id="L181">            cmmnEngineConfiguration.setStartCaseInstanceInterceptor(null);</span>
        }
<span class="nc" id="L183">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/RuntimeServiceTest.testStartSimplePassthroughCaseWithBlockingTask.cmmn&quot; })
    public void testVariableQueryWithBlockingTask() {
<span class="nc" id="L188">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L189">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L190">                .variables(VARIABLES)</span>
<span class="nc" id="L191">                .start();</span>

<span class="nc bnc" id="L193" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L194">            assertNonEmptyQueryIncludeVariables(1, VARIABLES,</span>
<span class="nc" id="L195">                cmmnRuntimeService.createCaseInstanceQuery().variableValueEquals(&quot;var&quot;, &quot;test&quot;),</span>
<span class="nc" id="L196">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueEquals(&quot;var&quot;, &quot;test&quot;)</span>
            );
<span class="nc" id="L198">            assertEmptyQuery(</span>
<span class="nc" id="L199">                cmmnRuntimeService.createCaseInstanceQuery().variableValueEquals(&quot;var&quot;, &quot;test2&quot;),</span>
<span class="nc" id="L200">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueEquals(&quot;var&quot;, &quot;test2&quot;)</span>
            );
<span class="nc" id="L202">            assertNonEmptyQueryIncludeVariables(1, VARIABLES,</span>
<span class="nc" id="L203">                cmmnRuntimeService.createCaseInstanceQuery().variableValueEqualsIgnoreCase(&quot;var&quot;, &quot;TEST&quot;),</span>
<span class="nc" id="L204">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueEqualsIgnoreCase(&quot;var&quot;, &quot;TEST&quot;)</span>
            );
<span class="nc" id="L206">            assertEmptyQuery(</span>
<span class="nc" id="L207">                cmmnRuntimeService.createCaseInstanceQuery().variableValueEqualsIgnoreCase(&quot;var&quot;, &quot;TEST2&quot;),</span>
<span class="nc" id="L208">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueEqualsIgnoreCase(&quot;var&quot;, &quot;TEST2&quot;)</span>
            );
<span class="nc" id="L210">            assertNonEmptyQueryIncludeVariables(1, VARIABLES,</span>
<span class="nc" id="L211">                cmmnRuntimeService.createCaseInstanceQuery().variableValueNotEquals(&quot;var&quot;, &quot;test2&quot;),</span>
<span class="nc" id="L212">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueNotEquals(&quot;var&quot;, &quot;test2&quot;)</span>
            );
<span class="nc" id="L214">            assertEmptyQuery(</span>
<span class="nc" id="L215">                cmmnRuntimeService.createCaseInstanceQuery().variableValueNotEquals(&quot;var&quot;, &quot;test&quot;),</span>
<span class="nc" id="L216">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueNotEquals(&quot;var&quot;, &quot;test&quot;)</span>
            );
<span class="nc" id="L218">            assertNonEmptyQueryIncludeVariables(1, VARIABLES,</span>
<span class="nc" id="L219">                cmmnRuntimeService.createCaseInstanceQuery().variableValueNotEqualsIgnoreCase(&quot;var&quot;, &quot;TEST2&quot;),</span>
                null
            );
<span class="nc" id="L222">            assertEmptyQuery(</span>
<span class="nc" id="L223">                cmmnRuntimeService.createCaseInstanceQuery().variableValueNotEqualsIgnoreCase(&quot;var&quot;, &quot;TEST&quot;),</span>
                null
            );
<span class="nc" id="L226">            assertNonEmptyQueryIncludeVariables(1, VARIABLES,</span>
<span class="nc" id="L227">                cmmnRuntimeService.createCaseInstanceQuery().variableValueLike(&quot;var&quot;, &quot;te%&quot;),</span>
<span class="nc" id="L228">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueLike(&quot;var&quot;, &quot;te%&quot;)</span>
            );
<span class="nc" id="L230">            assertEmptyQuery(</span>
<span class="nc" id="L231">                cmmnRuntimeService.createCaseInstanceQuery().variableValueLike(&quot;var&quot;, &quot;te2%&quot;),</span>
<span class="nc" id="L232">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueLike(&quot;var&quot;, &quot;te2%&quot;)</span>
            );
<span class="nc" id="L234">            assertNonEmptyQueryIncludeVariables(1, VARIABLES,</span>
<span class="nc" id="L235">                cmmnRuntimeService.createCaseInstanceQuery().variableValueLikeIgnoreCase(&quot;var&quot;, &quot;TE%&quot;),</span>
<span class="nc" id="L236">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueLikeIgnoreCase(&quot;var&quot;, &quot;TE%&quot;)</span>
            );
<span class="nc" id="L238">            assertEmptyQuery(</span>
<span class="nc" id="L239">                cmmnRuntimeService.createCaseInstanceQuery().variableValueLikeIgnoreCase(&quot;var&quot;, &quot;TE2%&quot;),</span>
<span class="nc" id="L240">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueLikeIgnoreCase(&quot;var&quot;, &quot;TE2%&quot;)</span>
            );
<span class="nc" id="L242">            assertNonEmptyQueryIncludeVariables(1, VARIABLES,</span>
<span class="nc" id="L243">                cmmnRuntimeService.createCaseInstanceQuery().variableValueGreaterThan(&quot;numberVar&quot;, 5),</span>
<span class="nc" id="L244">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueGreaterThan(&quot;numberVar&quot;, 5)</span>
            );
<span class="nc" id="L246">            assertEmptyQuery(</span>
<span class="nc" id="L247">                cmmnRuntimeService.createCaseInstanceQuery().variableValueGreaterThan(&quot;numberVar&quot;, 11),</span>
<span class="nc" id="L248">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueGreaterThan(&quot;numberVar&quot;, 11)</span>
            );
<span class="nc" id="L250">            assertNonEmptyQueryIncludeVariables(1, VARIABLES,</span>
<span class="nc" id="L251">                cmmnRuntimeService.createCaseInstanceQuery().variableValueGreaterThanOrEqual(&quot;numberVar&quot;, 10),</span>
<span class="nc" id="L252">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueGreaterThanOrEqual(&quot;numberVar&quot;, 10)</span>
            );
<span class="nc" id="L254">            assertEmptyQuery(</span>
<span class="nc" id="L255">                cmmnRuntimeService.createCaseInstanceQuery().variableValueGreaterThanOrEqual(&quot;numberVar&quot;, 11),</span>
<span class="nc" id="L256">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueGreaterThanOrEqual(&quot;numberVar&quot;, 11)</span>
            );
<span class="nc" id="L258">            assertNonEmptyQueryIncludeVariables(1, VARIABLES,</span>
<span class="nc" id="L259">                cmmnRuntimeService.createCaseInstanceQuery().variableValueLessThan(&quot;numberVar&quot;, 20),</span>
<span class="nc" id="L260">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueLessThan(&quot;numberVar&quot;, 20)</span>
            );
<span class="nc" id="L262">            assertEmptyQuery(</span>
<span class="nc" id="L263">                cmmnRuntimeService.createCaseInstanceQuery().variableValueLessThan(&quot;numberVar&quot;, 5),</span>
<span class="nc" id="L264">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueLessThan(&quot;numberVar&quot;, 5)</span>
            );
<span class="nc" id="L266">            assertNonEmptyQueryIncludeVariables(1, VARIABLES,</span>
<span class="nc" id="L267">                cmmnRuntimeService.createCaseInstanceQuery().variableValueLessThanOrEqual(&quot;numberVar&quot;, 10),</span>
<span class="nc" id="L268">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueLessThanOrEqual(&quot;numberVar&quot;, 10)</span>
            );
<span class="nc" id="L270">            assertEmptyQuery(</span>
<span class="nc" id="L271">                cmmnRuntimeService.createCaseInstanceQuery().variableValueLessThanOrEqual(&quot;numberVar&quot;, 9),</span>
<span class="nc" id="L272">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueLessThanOrEqual(&quot;numberVar&quot;, 9)</span>
            );
        }

<span class="nc" id="L276">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L277">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L278">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L279">                .singleResult();</span>
<span class="nc" id="L280">        assertThat(planItemInstance).isNotNull();</span>
<span class="nc" id="L281">        assertThat(planItemInstance.getName()).isEqualTo(&quot;Task A&quot;);</span>

<span class="nc" id="L283">        Map&lt;String, Object&gt; varMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L284">        varMap.put(&quot;numberVar&quot;, 11);</span>
<span class="nc" id="L285">        cmmnRuntimeService.setVariables(caseInstance.getId(), varMap);</span>

<span class="nc" id="L287">        Map&lt;String, Object&gt; localVarMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L288">        localVarMap.put(&quot;localVar&quot;, &quot;test&quot;);</span>
<span class="nc" id="L289">        cmmnRuntimeService.setLocalVariables(planItemInstance.getId(), localVarMap);</span>

<span class="nc" id="L291">        Map&lt;String, Object&gt; updatedVariables = new HashMap&lt;&gt;(VARIABLES);</span>
<span class="nc" id="L292">        updatedVariables.put(&quot;numberVar&quot;, 11);</span>

<span class="nc bnc" id="L294" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L295">            assertNonEmptyQueryIncludeVariables(1, updatedVariables,</span>
<span class="nc" id="L296">                cmmnRuntimeService.createCaseInstanceQuery().variableValueGreaterThan(&quot;numberVar&quot;, 10),</span>
<span class="nc" id="L297">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueGreaterThan(&quot;numberVar&quot;, 10)</span>
            );
<span class="nc" id="L299">            assertEmptyQuery(</span>
<span class="nc" id="L300">                cmmnRuntimeService.createCaseInstanceQuery().variableValueGreaterThan(&quot;numberVar&quot;, 11),</span>
<span class="nc" id="L301">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueGreaterThan(&quot;numberVar&quot;, 11)</span>
            );
<span class="nc" id="L303">            assertNonEmptyQueryIncludeVariables(1, updatedVariables,</span>
<span class="nc" id="L304">                cmmnRuntimeService.createCaseInstanceQuery().variableValueGreaterThanOrEqual(&quot;numberVar&quot;, 11),</span>
<span class="nc" id="L305">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueGreaterThanOrEqual(&quot;numberVar&quot;, 11)</span>
            );
<span class="nc" id="L307">            assertEmptyQuery(</span>
<span class="nc" id="L308">                cmmnRuntimeService.createCaseInstanceQuery().variableValueGreaterThanOrEqual(&quot;numberVar&quot;, 12),</span>
<span class="nc" id="L309">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueGreaterThanOrEqual(&quot;numberVar&quot;, 12)</span>
            );

<span class="nc" id="L312">            assertEmptyQuery(</span>
<span class="nc" id="L313">                cmmnRuntimeService.createCaseInstanceQuery().variableValueEquals(&quot;localVar&quot;, &quot;test&quot;),</span>
<span class="nc" id="L314">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueEquals(&quot;localVar&quot;, &quot;test&quot;)</span>
            );
        }

<span class="nc" id="L318">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>
<span class="nc" id="L319">        planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L320">                .planItemInstanceState(PlanItemInstanceState.ACTIVE).singleResult();</span>
<span class="nc" id="L321">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>

<span class="nc bnc" id="L323" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L324">            assertEmptyQuery(</span>
<span class="nc" id="L325">                cmmnRuntimeService.createCaseInstanceQuery(),</span>
<span class="nc" id="L326">                cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished()</span>
            );
        }
<span class="nc" id="L329">    }</span>

    private void assertNonEmptyQueryIncludeVariables(int expectedCount, Map&lt;String, Object&gt; expectedVariables,
            CaseInstanceQuery caseInstanceQuery,
            HistoricCaseInstanceQuery historicCaseInstanceQuery) {
<span class="nc" id="L334">        assertThat(caseInstanceQuery.count()).isEqualTo(expectedCount);</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">        if (historicCaseInstanceQuery != null) {</span>
<span class="nc" id="L336">            assertThat(historicCaseInstanceQuery.count()).isEqualTo(expectedCount);</span>
        }
        // assert singleResult
<span class="nc bnc" id="L339" title="All 2 branches missed.">        if (expectedCount == 1) {</span>
<span class="nc" id="L340">            CaseInstance fetchedCaseInstance = caseInstanceQuery.includeCaseVariables().singleResult();</span>
<span class="nc" id="L341">            assertThat(fetchedCaseInstance.getCaseVariables()).isEqualTo(expectedVariables);</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">            if (historicCaseInstanceQuery != null) {</span>
<span class="nc" id="L343">                HistoricCaseInstance fetchedHistoricCaseInstance = historicCaseInstanceQuery.includeCaseVariables().singleResult();</span>
<span class="nc" id="L344">                assertThat(fetchedHistoricCaseInstance.getCaseVariables()).isEqualTo(expectedVariables);</span>
            }
<span class="nc bnc" id="L346" title="All 2 branches missed.">        } else if (expectedCount &gt; 1) {</span>
<span class="nc" id="L347">            assertThatThrownBy(() -&gt; caseInstanceQuery.includeCaseVariables().singleResult())</span>
<span class="nc" id="L348">                    .isInstanceOf(FlowableException.class)</span>
<span class="nc" id="L349">                    .hasMessage(&quot;Query return &quot; + expectedCount + &quot; results instead of max 1&quot;);</span>

<span class="nc bnc" id="L351" title="All 2 branches missed.">            if (historicCaseInstanceQuery != null) {</span>
<span class="nc" id="L352">                assertThatThrownBy(() -&gt; historicCaseInstanceQuery.includeCaseVariables().singleResult())</span>
<span class="nc" id="L353">                        .isInstanceOf(FlowableException.class)</span>
<span class="nc" id="L354">                        .hasMessage(&quot;Query return &quot; + expectedCount + &quot; results instead of max 1&quot;);</span>
            }
        }

        // assert query list
<span class="nc" id="L359">        List&lt;CaseInstance&gt; caseInstances = caseInstanceQuery.includeCaseVariables().list();</span>
<span class="nc" id="L360">        assertThat(caseInstances).hasSize(expectedCount);</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">        for (CaseInstance caseInstance : caseInstances) {</span>
<span class="nc" id="L362">            assertThat(caseInstance.getCaseVariables()).isEqualTo(expectedVariables);</span>
<span class="nc" id="L363">        }</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">        if (historicCaseInstanceQuery != null) {</span>
<span class="nc" id="L365">            List&lt;HistoricCaseInstance&gt; historicCaseInstances = historicCaseInstanceQuery.includeCaseVariables().list();</span>
<span class="nc" id="L366">            assertThat(historicCaseInstances).hasSize(expectedCount);</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">            for (HistoricCaseInstance historicCaseInstance : historicCaseInstances) {</span>
<span class="nc" id="L368">                assertThat(historicCaseInstance.getCaseVariables()).isEqualTo(expectedVariables);</span>
<span class="nc" id="L369">            }</span>
        }
<span class="nc" id="L371">    }</span>

    private void assertPaginationQueryIncludeVariables(int expectedStart, int expectedCount, List&lt;CaseInstance&gt; caseInstances) {
<span class="nc" id="L374">        assertThat(caseInstances).hasSize(expectedCount);</span>
<span class="nc" id="L375">        Map&lt;String, Object&gt; expectedVariables = new HashMap&lt;&gt;(VARIABLES);</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">        for (int i = 0; i &lt; expectedCount; i++) {</span>
<span class="nc" id="L377">            CaseInstance caseInstance = caseInstances.get(i);</span>
<span class="nc" id="L378">            expectedVariables.put(&quot;counter&quot;, expectedStart + i);</span>
<span class="nc" id="L379">            assertThat(caseInstance.getName()).isEqualTo(&quot;A&quot; + (expectedStart + i));</span>
<span class="nc" id="L380">            assertThat(caseInstance.getCaseVariables()).isEqualTo(expectedVariables);</span>
        }
<span class="nc" id="L382">    }</span>

    private void assertPaginationHistoricQueryIncludeVariables(int expectedStart, int expectedCount, List&lt;HistoricCaseInstance&gt; caseInstances) {
<span class="nc" id="L385">        assertThat(caseInstances).hasSize(expectedCount);</span>
<span class="nc" id="L386">        Map&lt;String, Object&gt; expectedVariables = new HashMap&lt;&gt;(VARIABLES);</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">        for (int i = 0; i &lt; expectedCount; i++) {</span>
<span class="nc" id="L388">            HistoricCaseInstance caseInstance = caseInstances.get(i);</span>
<span class="nc" id="L389">            expectedVariables.put(&quot;counter&quot;, expectedStart + i);</span>
<span class="nc" id="L390">            assertThat(caseInstance.getName()).isEqualTo(&quot;A&quot; + (expectedStart + i));</span>
<span class="nc" id="L391">            assertThat(caseInstance.getCaseVariables()).isEqualTo(expectedVariables);</span>
        }
<span class="nc" id="L393">    }</span>

    private void assertEmptyQuery(CaseInstanceQuery caseInstanceQuery, HistoricCaseInstanceQuery historicCaseInstanceQuery) {
<span class="nc" id="L396">        assertThat(caseInstanceQuery.count()).isZero();</span>
<span class="nc" id="L397">        assertThat(caseInstanceQuery.includeCaseVariables().singleResult()).isNull();</span>
<span class="nc" id="L398">        List&lt;CaseInstance&gt; caseInstances = caseInstanceQuery.includeCaseVariables().list();</span>
<span class="nc" id="L399">        assertThat(caseInstances).isEmpty();</span>

<span class="nc bnc" id="L401" title="All 2 branches missed.">        if (historicCaseInstanceQuery != null) {</span>
<span class="nc" id="L402">            assertThat(historicCaseInstanceQuery.count()).isZero();</span>
<span class="nc" id="L403">            assertThat(historicCaseInstanceQuery.includeCaseVariables().singleResult()).isNull();</span>
<span class="nc" id="L404">            List&lt;HistoricCaseInstance&gt; historicCaseInstances = historicCaseInstanceQuery.includeCaseVariables().list();</span>
<span class="nc" id="L405">            assertThat(historicCaseInstances).isEmpty();</span>
        }
<span class="nc" id="L407">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/RuntimeServiceTest.testStartSimplePassthroughCaseWithBlockingTask.cmmn&quot; })
    public void testPlanItemVariableQueryWithBlockingTask() {
<span class="nc" id="L412">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L413">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L414">                .variable(&quot;var&quot;, &quot;test&quot;)</span>
<span class="nc" id="L415">                .variable(&quot;numberVar&quot;, 10)</span>
<span class="nc" id="L416">                .start();</span>

<span class="nc" id="L418">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueEquals(&quot;var&quot;, &quot;test&quot;).count()).isEqualTo(4);</span>
<span class="nc" id="L419">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueEquals(&quot;var&quot;, &quot;test2&quot;).count()).isZero();</span>
<span class="nc" id="L420">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueEqualsIgnoreCase(&quot;var&quot;, &quot;TEST&quot;).count()).isEqualTo(4);</span>
<span class="nc" id="L421">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueEqualsIgnoreCase(&quot;var&quot;, &quot;TEST2&quot;).count()).isZero();</span>
<span class="nc" id="L422">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueNotEquals(&quot;var&quot;, &quot;test2&quot;).count()).isEqualTo(4);</span>
<span class="nc" id="L423">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueNotEquals(&quot;var&quot;, &quot;test&quot;).count()).isZero();</span>
<span class="nc" id="L424">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueNotEqualsIgnoreCase(&quot;var&quot;, &quot;TEST2&quot;).count()).isEqualTo(4);</span>
<span class="nc" id="L425">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueNotEqualsIgnoreCase(&quot;var&quot;, &quot;TEST&quot;).count()).isZero();</span>
<span class="nc" id="L426">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueLike(&quot;var&quot;, &quot;te%&quot;).count()).isEqualTo(4);</span>
<span class="nc" id="L427">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueLike(&quot;var&quot;, &quot;te2%&quot;).count()).isZero();</span>
<span class="nc" id="L428">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueLikeIgnoreCase(&quot;var&quot;, &quot;TE%&quot;).count()).isEqualTo(4);</span>
<span class="nc" id="L429">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueLikeIgnoreCase(&quot;var&quot;, &quot;TE2%&quot;).count()).isZero();</span>
<span class="nc" id="L430">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueGreaterThan(&quot;numberVar&quot;, 5).count()).isEqualTo(4);</span>
<span class="nc" id="L431">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueGreaterThan(&quot;numberVar&quot;, 11).count()).isZero();</span>
<span class="nc" id="L432">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueGreaterThanOrEqual(&quot;numberVar&quot;, 10).count()).isEqualTo(4);</span>
<span class="nc" id="L433">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueGreaterThanOrEqual(&quot;numberVar&quot;, 11).count()).isZero();</span>
<span class="nc" id="L434">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueLessThan(&quot;numberVar&quot;, 20).count()).isEqualTo(4);</span>
<span class="nc" id="L435">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueLessThan(&quot;numberVar&quot;, 5).count()).isZero();</span>
<span class="nc" id="L436">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueLessThanOrEqual(&quot;numberVar&quot;, 10).count()).isEqualTo(4);</span>
<span class="nc" id="L437">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueLessThanOrEqual(&quot;numberVar&quot;, 9).count()).isZero();</span>

<span class="nc" id="L439">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L440">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L441">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L442">                .singleResult();</span>
<span class="nc" id="L443">        assertThat(planItemInstance).isNotNull();</span>
<span class="nc" id="L444">        assertThat(planItemInstance.getName()).isEqualTo(&quot;Task A&quot;);</span>

<span class="nc" id="L446">        Map&lt;String, Object&gt; varMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L447">        varMap.put(&quot;numberVar&quot;, 11);</span>
<span class="nc" id="L448">        cmmnRuntimeService.setVariables(caseInstance.getId(), varMap);</span>

<span class="nc" id="L450">        Map&lt;String, Object&gt; localVarMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L451">        localVarMap.put(&quot;localVar&quot;, &quot;test&quot;);</span>
<span class="nc" id="L452">        localVarMap.put(&quot;localNumberVar&quot;, 15);</span>
<span class="nc" id="L453">        cmmnRuntimeService.setLocalVariables(planItemInstance.getId(), localVarMap);</span>

<span class="nc" id="L455">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueGreaterThan(&quot;numberVar&quot;, 10).count()).isEqualTo(4);</span>
<span class="nc" id="L456">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueGreaterThan(&quot;numberVar&quot;, 11).count()).isZero();</span>
<span class="nc" id="L457">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueGreaterThanOrEqual(&quot;numberVar&quot;, 11).count()).isEqualTo(4);</span>
<span class="nc" id="L458">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueGreaterThanOrEqual(&quot;numberVar&quot;, 12).count()).isZero();</span>

<span class="nc" id="L460">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseVariableValueEquals(&quot;localVar&quot;, &quot;test&quot;).count()).isZero();</span>

<span class="nc" id="L462">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueEquals(&quot;localVar&quot;, &quot;test&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L463">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueEquals(&quot;localVar&quot;, &quot;test2&quot;).count()).isZero();</span>
<span class="nc" id="L464">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueEqualsIgnoreCase(&quot;localVar&quot;, &quot;TEST&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L465">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueEqualsIgnoreCase(&quot;localVar&quot;, &quot;TEST2&quot;).count()).isZero();</span>
<span class="nc" id="L466">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueNotEquals(&quot;localVar&quot;, &quot;test2&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L467">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueNotEquals(&quot;localVar&quot;, &quot;test&quot;).count()).isZero();</span>
<span class="nc" id="L468">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueNotEqualsIgnoreCase(&quot;localVar&quot;, &quot;TEST2&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L469">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueNotEqualsIgnoreCase(&quot;localVar&quot;, &quot;TEST&quot;).count()).isZero();</span>
<span class="nc" id="L470">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueLike(&quot;localVar&quot;, &quot;te%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L471">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueLike(&quot;localVar&quot;, &quot;te2%&quot;).count()).isZero();</span>
<span class="nc" id="L472">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueLikeIgnoreCase(&quot;localVar&quot;, &quot;TE%&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L473">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueLikeIgnoreCase(&quot;localVar&quot;, &quot;TE2%&quot;).count()).isZero();</span>
<span class="nc" id="L474">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueGreaterThan(&quot;localNumberVar&quot;, 5).count()).isEqualTo(1);</span>
<span class="nc" id="L475">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueGreaterThan(&quot;localNumberVar&quot;, 17).count()).isZero();</span>
<span class="nc" id="L476">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueGreaterThanOrEqual(&quot;localNumberVar&quot;, 15).count()).isEqualTo(1);</span>
<span class="nc" id="L477">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueGreaterThanOrEqual(&quot;localNumberVar&quot;, 16).count()).isZero();</span>
<span class="nc" id="L478">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueLessThan(&quot;localNumberVar&quot;, 20).count()).isEqualTo(1);</span>
<span class="nc" id="L479">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueLessThan(&quot;localNumberVar&quot;, 5).count()).isZero();</span>
<span class="nc" id="L480">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueLessThanOrEqual(&quot;localNumberVar&quot;, 15).count()).isEqualTo(1);</span>
<span class="nc" id="L481">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().variableValueLessThanOrEqual(&quot;localNumberVar&quot;, 9).count()).isZero();</span>

<span class="nc" id="L483">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>
<span class="nc" id="L484">        planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L485">                .planItemInstanceState(PlanItemInstanceState.ACTIVE).singleResult();</span>
<span class="nc" id="L486">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>

<span class="nc" id="L488">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isZero();</span>
<span class="nc" id="L489">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/RuntimeServiceTest.testStartSimplePassthroughCaseWithBlockingTask.cmmn&quot; })
    public void testLocalVariablesWithBlockingTask() {
<span class="nc" id="L494">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>

<span class="nc" id="L496">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L497">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L498">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L499">                .singleResult();</span>
<span class="nc" id="L500">        assertThat(planItemInstance).isNotNull();</span>
<span class="nc" id="L501">        assertThat(planItemInstance.getName()).isEqualTo(&quot;Task A&quot;);</span>

<span class="nc" id="L503">        Map&lt;String, Object&gt; varMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L504">        varMap.put(&quot;localVar&quot;, &quot;test&quot;);</span>
<span class="nc" id="L505">        cmmnRuntimeService.setLocalVariables(planItemInstance.getId(), varMap);</span>

<span class="nc" id="L507">        assertThat(cmmnRuntimeService.getLocalVariable(planItemInstance.getId(), &quot;localVar&quot;)).isEqualTo(&quot;test&quot;);</span>
<span class="nc" id="L508">        assertThat(cmmnRuntimeService.getLocalVariables(planItemInstance.getId())).hasSize(1);</span>
<span class="nc" id="L509">        assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;localVar&quot;)).isNull();</span>

<span class="nc" id="L511">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>

<span class="nc" id="L513">        planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L514">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L515">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L516">                .singleResult();</span>
<span class="nc" id="L517">        assertThat(planItemInstance).isNotNull();</span>
<span class="nc" id="L518">        assertThat(planItemInstance.getName()).isEqualTo(&quot;Task B&quot;);</span>

<span class="nc" id="L520">        assertThat(cmmnRuntimeService.getLocalVariable(planItemInstance.getId(), &quot;localVar&quot;)).isNull();</span>

<span class="nc" id="L522">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>

<span class="nc" id="L524">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isZero();</span>
<span class="nc" id="L525">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/RuntimeServiceTest.testStartSimplePassthroughCaseWithBlockingTask.cmmn&quot; })
    public void testRemoveLocalVariablesWithBlockingTask() {
<span class="nc" id="L530">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>

<span class="nc" id="L532">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L533">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L534">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L535">                .singleResult();</span>
<span class="nc" id="L536">        assertThat(planItemInstance).isNotNull();</span>
<span class="nc" id="L537">        assertThat(planItemInstance.getName()).isEqualTo(&quot;Task A&quot;);</span>

<span class="nc" id="L539">        Map&lt;String, Object&gt; localVarMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L540">        localVarMap.put(&quot;localVar&quot;, &quot;test&quot;);</span>
<span class="nc" id="L541">        cmmnRuntimeService.setLocalVariables(planItemInstance.getId(), localVarMap);</span>

<span class="nc" id="L543">        Map&lt;String, Object&gt; varMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L544">        varMap.put(&quot;var&quot;, &quot;test&quot;);</span>
<span class="nc" id="L545">        cmmnRuntimeService.setVariables(caseInstance.getId(), varMap);</span>

<span class="nc" id="L547">        assertThat(cmmnRuntimeService.getLocalVariable(planItemInstance.getId(), &quot;localVar&quot;)).isEqualTo(&quot;test&quot;);</span>
<span class="nc" id="L548">        assertThat(cmmnRuntimeService.getLocalVariables(planItemInstance.getId())).hasSize(1);</span>

<span class="nc" id="L550">        assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;var&quot;)).isEqualTo(&quot;test&quot;);</span>
<span class="nc" id="L551">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId())).hasSize(1);</span>

<span class="nc" id="L553">        cmmnRuntimeService.removeLocalVariable(planItemInstance.getId(), &quot;localVar&quot;);</span>
<span class="nc" id="L554">        assertThat(cmmnRuntimeService.getLocalVariable(planItemInstance.getId(), &quot;localVar&quot;)).isNull();</span>

<span class="nc" id="L556">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>

<span class="nc" id="L558">        planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L559">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L560">                .planItemInstanceState(PlanItemInstanceState.ACTIVE)</span>
<span class="nc" id="L561">                .singleResult();</span>
<span class="nc" id="L562">        assertThat(planItemInstance).isNotNull();</span>
<span class="nc" id="L563">        assertThat(planItemInstance.getName()).isEqualTo(&quot;Task B&quot;);</span>

<span class="nc" id="L565">        assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;var&quot;)).isEqualTo(&quot;test&quot;);</span>
<span class="nc" id="L566">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId())).hasSize(1);</span>

<span class="nc" id="L568">        cmmnRuntimeService.removeVariable(caseInstance.getId(), &quot;var&quot;);</span>
<span class="nc" id="L569">        assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;var&quot;)).isNull();</span>

<span class="nc" id="L571">        cmmnRuntimeService.triggerPlanItemInstance(planItemInstance.getId());</span>

<span class="nc" id="L573">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().count()).isZero();</span>

<span class="nc bnc" id="L575" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L576">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().unfinished().count()).isZero();</span>
<span class="nc" id="L577">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().finished().count()).isEqualTo(1);</span>
        }
<span class="nc" id="L579">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/RuntimeServiceTest.testStartSimplePassthroughCaseWithBlockingTask.cmmn&quot; })
    public void testIncludeVariableSingleResultQueryWithBlockingTask() {
<span class="nc" id="L584">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L585">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L586">                .variables(VARIABLES)</span>
<span class="nc" id="L587">                .start();</span>

<span class="nc bnc" id="L589" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L590">            assertNonEmptyQueryIncludeVariables(1, VARIABLES,</span>
<span class="nc" id="L591">                cmmnRuntimeService.createCaseInstanceQuery().includeCaseVariables(),</span>
<span class="nc" id="L592">                cmmnHistoryService.createHistoricCaseInstanceQuery().includeCaseVariables()</span>
            );
        }

<span class="nc" id="L596">        Map&lt;String, Object&gt; updatedVariables = new HashMap&lt;&gt;(VARIABLES);</span>
<span class="nc" id="L597">        updatedVariables.put(&quot;newVar&quot;, 14.2);</span>
<span class="nc" id="L598">        cmmnRuntimeService.setVariables(caseInstance.getId(), updatedVariables);</span>

<span class="nc bnc" id="L600" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L601">            assertNonEmptyQueryIncludeVariables(1, updatedVariables,</span>
<span class="nc" id="L602">                cmmnRuntimeService.createCaseInstanceQuery().includeCaseVariables(),</span>
<span class="nc" id="L603">                cmmnHistoryService.createHistoricCaseInstanceQuery().includeCaseVariables()</span>
            );
        }
<span class="nc" id="L606">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/RuntimeServiceTest.testStartSimplePassthroughCaseWithBlockingTask.cmmn&quot; })
    public void testIncludeVariableListQueryWithBlockingTask() {
<span class="nc" id="L611">        Map&lt;String, Object&gt; variablesA = new HashMap&lt;&gt;();</span>
<span class="nc" id="L612">        variablesA.put(&quot;var&quot;, &quot;test&quot;);</span>
<span class="nc" id="L613">        variablesA.put(&quot;numberVar&quot;, 10);</span>
<span class="nc" id="L614">        Map&lt;String, Object&gt; variablesB = new HashMap&lt;&gt;();</span>
<span class="nc" id="L615">        variablesB.put(&quot;var&quot;, &quot;test&quot;);</span>
<span class="nc" id="L616">        variablesB.put(&quot;numberVar&quot;, 10);</span>
<span class="nc" id="L617">        variablesB.put(&quot;floatVar&quot;, 10.1);</span>

<span class="nc" id="L619">        Instant now = setClockFixedToCurrentTime().toInstant();</span>
<span class="nc" id="L620">        cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L621">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L622">                .name(&quot;A&quot;)</span>
<span class="nc" id="L623">                .variables(variablesA)</span>
<span class="nc" id="L624">                .start();</span>
<span class="nc" id="L625">        setClockTo(Date.from(now.plusSeconds(1)));</span>
<span class="nc" id="L626">        cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L627">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L628">                .name(&quot;B&quot;)</span>
<span class="nc" id="L629">                .variables(variablesB)</span>
<span class="nc" id="L630">                .start();</span>
<span class="nc" id="L631">        setClockTo(Date.from(now.plusSeconds(2)));</span>
<span class="nc" id="L632">        cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L633">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L634">                .name(&quot;C&quot;)</span>
<span class="nc" id="L635">                .start();</span>

<span class="nc" id="L637">        List&lt;CaseInstance&gt; caseInstancesWithVariables = cmmnRuntimeService.createCaseInstanceQuery().includeCaseVariables().orderByStartTime().asc().list();</span>
<span class="nc" id="L638">        assertThat(caseInstancesWithVariables)</span>
<span class="nc" id="L639">                .extracting(CaseInstance::getCaseVariables)</span>
<span class="nc" id="L640">                .containsExactly(variablesA, variablesB, Collections.EMPTY_MAP);</span>

<span class="nc" id="L642">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().includeCaseVariables().orderByStartTime().asc().count()).isEqualTo(3);</span>

<span class="nc bnc" id="L644" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L645">            List&lt;HistoricCaseInstance&gt; historicCaseInstancesWithVariables = cmmnHistoryService.createHistoricCaseInstanceQuery().includeCaseVariables()</span>
<span class="nc" id="L646">                .orderByStartTime().asc().list();</span>
<span class="nc" id="L647">            assertThat(historicCaseInstancesWithVariables)</span>
<span class="nc" id="L648">                .extracting(HistoricCaseInstance::getCaseVariables)</span>
<span class="nc" id="L649">                .containsExactly(variablesA, variablesB, Collections.EMPTY_MAP);</span>

<span class="nc" id="L651">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().includeCaseVariables().orderByStartTime().asc().count()).isEqualTo(3);</span>
        }
<span class="nc" id="L653">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/RuntimeServiceTest.testStartSimplePassthroughCaseWithBlockingTask.cmmn&quot; })
    public void testIncludeSameVariableListQueryWithBlockingTask() {
<span class="nc" id="L658">        Instant now = setClockFixedToCurrentTime().toInstant();</span>
<span class="nc" id="L659">        cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L660">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L661">                .name(&quot;A&quot;)</span>
<span class="nc" id="L662">                .variables(VARIABLES)</span>
<span class="nc" id="L663">                .start();</span>
<span class="nc" id="L664">        setClockTo(Date.from(now.plusSeconds(1)));</span>
<span class="nc" id="L665">        cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L666">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L667">                .name(&quot;B&quot;)</span>
<span class="nc" id="L668">                .variables(VARIABLES)</span>
<span class="nc" id="L669">                .start();</span>
<span class="nc" id="L670">        setClockTo(Date.from(now.plusSeconds(2)));</span>
<span class="nc" id="L671">        cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L672">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L673">                .variables(VARIABLES)</span>
<span class="nc" id="L674">                .name(&quot;C&quot;)</span>
<span class="nc" id="L675">                .start();</span>

<span class="nc bnc" id="L677" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L678">            assertNonEmptyQueryIncludeVariables(3, VARIABLES,</span>
<span class="nc" id="L679">                cmmnRuntimeService.createCaseInstanceQuery().orderByStartTime().asc(),</span>
<span class="nc" id="L680">                cmmnHistoryService.createHistoricCaseInstanceQuery().orderByStartTime().asc()</span>
            );
        }
<span class="nc" id="L683">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/RuntimeServiceTest.testStartSimplePassthroughCaseWithBlockingTask.cmmn&quot; })
    public void includeVariablesWithPaginationQueries() {
<span class="nc" id="L688">        createCaseInstances();</span>

<span class="nc" id="L690">        testIncludeVariablesWithPagination(cmmnRuntimeService.createCaseInstanceQuery().includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L691">        testIncludeVariablesWithPagination(</span>
<span class="nc" id="L692">                cmmnRuntimeService.createCaseInstanceQuery().variableValueEquals(&quot;var&quot;, &quot;test&quot;).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L693">        testIncludeVariablesWithPagination(</span>
<span class="nc" id="L694">                cmmnRuntimeService.createCaseInstanceQuery().variableValueEqualsIgnoreCase(&quot;var&quot;, &quot;TEST&quot;).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L695">        testIncludeVariablesWithPagination(</span>
<span class="nc" id="L696">                cmmnRuntimeService.createCaseInstanceQuery().variableValueNotEquals(&quot;var&quot;, &quot;test2&quot;).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L697">        testIncludeVariablesWithPagination(</span>
<span class="nc" id="L698">                cmmnRuntimeService.createCaseInstanceQuery().variableValueNotEqualsIgnoreCase(&quot;var&quot;, &quot;TEST2&quot;).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L699">        testIncludeVariablesWithPagination(</span>
<span class="nc" id="L700">                cmmnRuntimeService.createCaseInstanceQuery().variableValueLike(&quot;var&quot;, &quot;te%&quot;).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L701">        testIncludeVariablesWithPagination(</span>
<span class="nc" id="L702">                cmmnRuntimeService.createCaseInstanceQuery().variableValueLikeIgnoreCase(&quot;var&quot;, &quot;TE%&quot;).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L703">        testIncludeVariablesWithPagination(</span>
<span class="nc" id="L704">                cmmnRuntimeService.createCaseInstanceQuery().variableValueGreaterThan(&quot;numberVar&quot;, 5).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L705">        testIncludeVariablesWithPagination(</span>
<span class="nc" id="L706">                cmmnRuntimeService.createCaseInstanceQuery().variableValueGreaterThanOrEqual(&quot;numberVar&quot;, 10).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L707">        testIncludeVariablesWithPagination(</span>
<span class="nc" id="L708">                cmmnRuntimeService.createCaseInstanceQuery().variableValueLessThan(&quot;numberVar&quot;, 20).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L709">        testIncludeVariablesWithPagination(</span>
<span class="nc" id="L710">                cmmnRuntimeService.createCaseInstanceQuery().variableValueLessThanOrEqual(&quot;numberVar&quot;, 10).includeCaseVariables().orderByStartTime().asc());</span>

<span class="nc bnc" id="L712" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L713">            testIncludeVariablesWithPagination(cmmnHistoryService.createHistoricCaseInstanceQuery().includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L714">            testIncludeVariablesWithPagination(</span>
<span class="nc" id="L715">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueEquals(&quot;var&quot;, &quot;test&quot;).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L716">            testIncludeVariablesWithPagination(</span>
<span class="nc" id="L717">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueEqualsIgnoreCase(&quot;var&quot;, &quot;TEST&quot;).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L718">            testIncludeVariablesWithPagination(</span>
<span class="nc" id="L719">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueNotEquals(&quot;var&quot;, &quot;test2&quot;).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L720">            testIncludeVariablesWithPagination(</span>
<span class="nc" id="L721">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueLike(&quot;var&quot;, &quot;te%&quot;).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L722">            testIncludeVariablesWithPagination(</span>
<span class="nc" id="L723">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueLikeIgnoreCase(&quot;var&quot;, &quot;TE%&quot;).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L724">            testIncludeVariablesWithPagination(</span>
<span class="nc" id="L725">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueGreaterThan(&quot;numberVar&quot;, 5).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L726">            testIncludeVariablesWithPagination(</span>
<span class="nc" id="L727">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueGreaterThanOrEqual(&quot;numberVar&quot;, 10).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L728">            testIncludeVariablesWithPagination(</span>
<span class="nc" id="L729">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueLessThan(&quot;numberVar&quot;, 20).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L730">            testIncludeVariablesWithPagination(</span>
<span class="nc" id="L731">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueLessThanOrEqual(&quot;numberVar&quot;, 10).includeCaseVariables().orderByStartTime().asc());</span>
        }
<span class="nc" id="L733">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/RuntimeServiceTest.testStartSimplePassthroughCaseWithBlockingTask.cmmn&quot; })
    public void includeVariablesWithEmptyPaginationQueries() {
<span class="nc" id="L738">        createCaseInstances();</span>

<span class="nc" id="L740">        testIncludeVariablesOnEmptyQueryWithPagination(</span>
<span class="nc" id="L741">                cmmnRuntimeService.createCaseInstanceQuery().variableValueEquals(&quot;var&quot;, &quot;test2&quot;).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L742">        testIncludeVariablesOnEmptyQueryWithPagination(</span>
<span class="nc" id="L743">                cmmnRuntimeService.createCaseInstanceQuery().variableValueEqualsIgnoreCase(&quot;var&quot;, &quot;TEST2&quot;).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L744">        testIncludeVariablesOnEmptyQueryWithPagination(</span>
<span class="nc" id="L745">                cmmnRuntimeService.createCaseInstanceQuery().variableValueNotEquals(&quot;var&quot;, &quot;test&quot;).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L746">        testIncludeVariablesOnEmptyQueryWithPagination(</span>
<span class="nc" id="L747">                cmmnRuntimeService.createCaseInstanceQuery().variableValueNotEqualsIgnoreCase(&quot;var&quot;, &quot;TEST&quot;).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L748">        testIncludeVariablesOnEmptyQueryWithPagination(</span>
<span class="nc" id="L749">                cmmnRuntimeService.createCaseInstanceQuery().variableValueLike(&quot;var&quot;, &quot;te2%&quot;).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L750">        testIncludeVariablesOnEmptyQueryWithPagination(</span>
<span class="nc" id="L751">                cmmnRuntimeService.createCaseInstanceQuery().variableValueLikeIgnoreCase(&quot;var&quot;, &quot;TE2%&quot;).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L752">        testIncludeVariablesOnEmptyQueryWithPagination(</span>
<span class="nc" id="L753">                cmmnRuntimeService.createCaseInstanceQuery().variableValueGreaterThan(&quot;numberVar&quot;, 11).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L754">        testIncludeVariablesOnEmptyQueryWithPagination(</span>
<span class="nc" id="L755">                cmmnRuntimeService.createCaseInstanceQuery().variableValueGreaterThanOrEqual(&quot;numberVar&quot;, 11).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L756">        testIncludeVariablesOnEmptyQueryWithPagination(</span>
<span class="nc" id="L757">                cmmnRuntimeService.createCaseInstanceQuery().variableValueLessThan(&quot;numberVar&quot;, 5).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L758">        testIncludeVariablesOnEmptyQueryWithPagination(</span>
<span class="nc" id="L759">                cmmnRuntimeService.createCaseInstanceQuery().variableValueLessThanOrEqual(&quot;numberVar&quot;, 9).includeCaseVariables().orderByStartTime().asc());</span>

<span class="nc bnc" id="L761" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L762">            testIncludeVariablesOnEmptyQueryWithPagination(</span>
<span class="nc" id="L763">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueEquals(&quot;var&quot;, &quot;test2&quot;).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L764">            testIncludeVariablesOnEmptyQueryWithPagination(</span>
<span class="nc" id="L765">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueEqualsIgnoreCase(&quot;var&quot;, &quot;TEST2&quot;).includeCaseVariables().orderByStartTime()</span>
<span class="nc" id="L766">                    .asc());</span>
<span class="nc" id="L767">            testIncludeVariablesOnEmptyQueryWithPagination(</span>
<span class="nc" id="L768">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueNotEquals(&quot;var&quot;, &quot;test&quot;).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L769">            testIncludeVariablesOnEmptyQueryWithPagination(</span>
<span class="nc" id="L770">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueLike(&quot;var&quot;, &quot;te2%&quot;).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L771">            testIncludeVariablesOnEmptyQueryWithPagination(</span>
<span class="nc" id="L772">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueLikeIgnoreCase(&quot;var&quot;, &quot;TE2%&quot;).includeCaseVariables().orderByStartTime()</span>
<span class="nc" id="L773">                    .asc());</span>
<span class="nc" id="L774">            testIncludeVariablesOnEmptyQueryWithPagination(</span>
<span class="nc" id="L775">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueGreaterThan(&quot;numberVar&quot;, 11).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L776">            testIncludeVariablesOnEmptyQueryWithPagination(</span>
<span class="nc" id="L777">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueGreaterThanOrEqual(&quot;numberVar&quot;, 11).includeCaseVariables().orderByStartTime()</span>
<span class="nc" id="L778">                    .asc());</span>
<span class="nc" id="L779">            testIncludeVariablesOnEmptyQueryWithPagination(</span>
<span class="nc" id="L780">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueLessThan(&quot;numberVar&quot;, 5).includeCaseVariables().orderByStartTime().asc());</span>
<span class="nc" id="L781">            testIncludeVariablesOnEmptyQueryWithPagination(</span>
<span class="nc" id="L782">                cmmnHistoryService.createHistoricCaseInstanceQuery().variableValueLessThanOrEqual(&quot;numberVar&quot;, 9).includeCaseVariables().orderByStartTime()</span>
<span class="nc" id="L783">                    .asc());</span>
        }
<span class="nc" id="L785">    }</span>

    private void createCaseInstances() {
<span class="nc" id="L788">        Map&lt;String, Object&gt; variablesWithCounter = new HashMap&lt;&gt;(VARIABLES);</span>

<span class="nc" id="L790">        Instant now = Instant.now();</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">        for (int i = 0; i &lt; 100; i++) {</span>
<span class="nc" id="L792">            variablesWithCounter.put(&quot;counter&quot;, i);</span>
<span class="nc" id="L793">            setClockTo(Date.from(now.plusSeconds(i)));</span>
<span class="nc" id="L794">            cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L795">                    .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L796">                    .name(&quot;A&quot; + i)</span>
<span class="nc" id="L797">                    .variables(variablesWithCounter)</span>
<span class="nc" id="L798">                    .start();</span>
        }
<span class="nc" id="L800">        setClockTo(null);</span>
<span class="nc" id="L801">    }</span>

    private void testIncludeVariablesWithPagination(CaseInstanceQuery caseInstanceQuery) {
<span class="nc" id="L804">        assertPaginationQueryIncludeVariables(20, 10, caseInstanceQuery.listPage(20, 10));</span>
<span class="nc" id="L805">        assertPaginationQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(0, 0));</span>
<span class="nc" id="L806">        assertPaginationQueryIncludeVariables(0, 100, caseInstanceQuery.listPage(0, -1));</span>
<span class="nc" id="L807">        assertPaginationQueryIncludeVariables(0, 100, caseInstanceQuery.listPage(-1, -1));</span>
<span class="nc" id="L808">        assertPaginationQueryIncludeVariables(0, 100, caseInstanceQuery.listPage(-1, -2));</span>
<span class="nc" id="L809">        assertPaginationQueryIncludeVariables(90, 10, caseInstanceQuery.listPage(90, 20));</span>
<span class="nc" id="L810">        assertPaginationQueryIncludeVariables(90, 10, caseInstanceQuery.listPage(90, 10));</span>
<span class="nc" id="L811">        assertPaginationQueryIncludeVariables(0, 20, caseInstanceQuery.listPage(-10, 20));</span>
<span class="nc" id="L812">        assertPaginationQueryIncludeVariables(0, 100, caseInstanceQuery.listPage(0, Integer.MAX_VALUE));</span>
<span class="nc" id="L813">        assertPaginationQueryIncludeVariables(20, 80, caseInstanceQuery.listPage(20, -1));</span>
<span class="nc" id="L814">    }</span>

    private void testIncludeVariablesWithPagination(HistoricCaseInstanceQuery caseInstanceQuery) {
<span class="nc" id="L817">        assertPaginationHistoricQueryIncludeVariables(20, 10, caseInstanceQuery.listPage(20, 10));</span>
<span class="nc" id="L818">        assertPaginationHistoricQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(0, 0));</span>
<span class="nc" id="L819">        assertPaginationHistoricQueryIncludeVariables(0, 100, caseInstanceQuery.listPage(0, -1));</span>
<span class="nc" id="L820">        assertPaginationHistoricQueryIncludeVariables(0, 100, caseInstanceQuery.listPage(-1, -1));</span>
<span class="nc" id="L821">        assertPaginationHistoricQueryIncludeVariables(0, 100, caseInstanceQuery.listPage(-1, -2));</span>
<span class="nc" id="L822">        assertPaginationHistoricQueryIncludeVariables(90, 10, caseInstanceQuery.listPage(90, 20));</span>
<span class="nc" id="L823">        assertPaginationHistoricQueryIncludeVariables(90, 10, caseInstanceQuery.listPage(90, 10));</span>
<span class="nc" id="L824">        assertPaginationHistoricQueryIncludeVariables(0, 20, caseInstanceQuery.listPage(-10, 20));</span>
<span class="nc" id="L825">        assertPaginationHistoricQueryIncludeVariables(0, 100, caseInstanceQuery.listPage(0, Integer.MAX_VALUE));</span>
<span class="nc" id="L826">        assertPaginationHistoricQueryIncludeVariables(20, 80, caseInstanceQuery.listPage(20, -1));</span>
<span class="nc" id="L827">    }</span>

    private void testIncludeVariablesOnEmptyQueryWithPagination(CaseInstanceQuery caseInstanceQuery) {
<span class="nc" id="L830">        assertPaginationQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(20, 10));</span>
<span class="nc" id="L831">        assertPaginationQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(0, 0));</span>
<span class="nc" id="L832">        assertPaginationQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(0, -1));</span>
<span class="nc" id="L833">        assertPaginationQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(-1, -1));</span>
<span class="nc" id="L834">        assertPaginationQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(-1, -2));</span>
<span class="nc" id="L835">        assertPaginationQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(90, 20));</span>
<span class="nc" id="L836">        assertPaginationQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(90, 10));</span>
<span class="nc" id="L837">        assertPaginationQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(-10, 20));</span>
<span class="nc" id="L838">        assertPaginationQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(20, -1));</span>
<span class="nc" id="L839">        assertPaginationQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(0, Integer.MAX_VALUE));</span>
<span class="nc" id="L840">    }</span>

    private void testIncludeVariablesOnEmptyQueryWithPagination(HistoricCaseInstanceQuery caseInstanceQuery) {
<span class="nc" id="L843">        assertPaginationHistoricQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(20, 10));</span>
<span class="nc" id="L844">        assertPaginationHistoricQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(0, 0));</span>
<span class="nc" id="L845">        assertPaginationHistoricQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(0, -1));</span>
<span class="nc" id="L846">        assertPaginationHistoricQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(-1, -1));</span>
<span class="nc" id="L847">        assertPaginationHistoricQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(-1, -2));</span>
<span class="nc" id="L848">        assertPaginationHistoricQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(90, 20));</span>
<span class="nc" id="L849">        assertPaginationHistoricQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(90, 10));</span>
<span class="nc" id="L850">        assertPaginationHistoricQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(-10, 20));</span>
<span class="nc" id="L851">        assertPaginationHistoricQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(20, -1));</span>
<span class="nc" id="L852">        assertPaginationHistoricQueryIncludeVariables(0, 0, caseInstanceQuery.listPage(0, Integer.MAX_VALUE));</span>
<span class="nc" id="L853">    }</span>

    @Test
    @CmmnDeployment
    public void testTerminateCaseInstance() {

        // Task A active
<span class="nc" id="L860">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L861">        cmmnRuntimeService.terminateCaseInstance(caseInstance.getId());</span>
<span class="nc" id="L862">        assertCaseInstanceEnded(caseInstance, 0);</span>

        // Task B active
<span class="nc" id="L865">        caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L866">        cmmnRuntimeService.triggerPlanItemInstance(cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L867">                .caseInstanceId(caseInstance.getId()).planItemInstanceState(PlanItemInstanceState.ACTIVE).singleResult().getId());</span>
<span class="nc" id="L868">        cmmnRuntimeService.terminateCaseInstance(caseInstance.getId());</span>
<span class="nc" id="L869">        assertCaseInstanceEnded(caseInstance, 1);</span>

<span class="nc bnc" id="L871" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L872">            HistoricCaseInstance historicCaseInstance = cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L873">                    .singleResult();</span>
<span class="nc" id="L874">            assertThat(historicCaseInstance).isNotNull();</span>
<span class="nc" id="L875">            assertThat(historicCaseInstance.getStartTime()).isNotNull();</span>
<span class="nc" id="L876">            assertThat(historicCaseInstance.getEndTime()).isNotNull();</span>
<span class="nc" id="L877">            assertThat(historicCaseInstance.getState()).isEqualTo(CaseInstanceState.TERMINATED);</span>
        }
<span class="nc" id="L879">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/runtime/oneHumanTaskCase.cmmn&quot;)
    public void testTerminateCaseInstanceWithPlanItemVariables() {
<span class="nc" id="L884">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;oneHumanTaskCase&quot;).start();</span>
<span class="nc" id="L885">        assertThat(cmmnRuntimeService.createVariableInstanceQuery().list())</span>
<span class="nc" id="L886">                .extracting(VariableInstance::getName)</span>
<span class="nc" id="L887">                .isEmpty();</span>

<span class="nc" id="L889">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L890">                .planItemDefinitionId(&quot;theTask&quot;)</span>
<span class="nc" id="L891">                .singleResult();</span>

<span class="nc" id="L893">        cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;caseVar&quot;, &quot;test&quot;);</span>
<span class="nc" id="L894">        cmmnRuntimeService.setLocalVariable(planItemInstance.getId(), &quot;localVar&quot;, &quot;test&quot;);</span>

<span class="nc" id="L896">        assertThat(cmmnRuntimeService.createVariableInstanceQuery().list())</span>
<span class="nc" id="L897">                .extracting(VariableInstance::getName)</span>
<span class="nc" id="L898">                .containsExactlyInAnyOrder(&quot;caseVar&quot;, &quot;localVar&quot;);</span>

<span class="nc" id="L900">        cmmnRuntimeService.terminateCaseInstance(caseInstance.getId());</span>

<span class="nc" id="L902">        assertThat(cmmnRuntimeService.createVariableInstanceQuery().list())</span>
<span class="nc" id="L903">                .extracting(VariableInstance::getName)</span>
<span class="nc" id="L904">                .isEmpty();</span>
<span class="nc" id="L905">    }</span>
    
    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/RuntimeServiceTest.testDeleteCaseInstance.cmmn&quot; })
    public void testBulkDeleteCaseInstances() {

<span class="nc" id="L911">        CaseInstance caseInstance1 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L912">        CaseInstance caseInstance2 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L913">        CaseInstance caseInstance3 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>

<span class="nc" id="L915">        cmmnRuntimeService.triggerPlanItemInstance(cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L916">                .caseInstanceId(caseInstance2.getId()).planItemInstanceState(PlanItemInstanceState.ACTIVE).singleResult().getId());</span>

<span class="nc" id="L918">        Set&lt;String&gt; caseInstanceIdList = new HashSet&lt;&gt;();</span>
<span class="nc" id="L919">        caseInstanceIdList.add(caseInstance1.getId());</span>
<span class="nc" id="L920">        caseInstanceIdList.add(caseInstance2.getId());</span>

<span class="nc" id="L922">        cmmnRuntimeService.bulkDeleteCaseInstances(caseInstanceIdList);</span>
<span class="nc" id="L923">        assertCaseInstanceEnded(caseInstance1, 0);</span>
<span class="nc" id="L924">        assertCaseInstanceEnded(caseInstance2, 1);</span>
<span class="nc" id="L925">        assertCaseInstanceNotEnded(caseInstance3);</span>
<span class="nc bnc" id="L926" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L927">            HistoricCaseInstance historicCaseInstance = cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L928">                    .singleResult();</span>
<span class="nc" id="L929">            assertThat(historicCaseInstance).isNotNull();</span>
<span class="nc" id="L930">            assertThat(historicCaseInstance.getStartTime()).isNotNull();</span>
<span class="nc" id="L931">            assertThat(historicCaseInstance.getEndTime()).isNotNull();</span>
<span class="nc" id="L932">            assertThat(historicCaseInstance.getState()).isEqualTo(CaseInstanceState.TERMINATED);</span>
        }

<span class="nc" id="L935">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/RuntimeServiceTest.testTerminateCaseInstance.cmmn&quot; })
    public void testBulkTerminateCaseInstances() {

<span class="nc" id="L941">        CaseInstance caseInstance1 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L942">        CaseInstance caseInstance2 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L943">        CaseInstance caseInstance3 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>

<span class="nc" id="L945">        cmmnRuntimeService.triggerPlanItemInstance(cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L946">                .caseInstanceId(caseInstance2.getId()).planItemInstanceState(PlanItemInstanceState.ACTIVE).singleResult().getId());</span>

<span class="nc" id="L948">        Set&lt;String&gt; caseInstanceIdList = new HashSet&lt;&gt;();</span>
<span class="nc" id="L949">        caseInstanceIdList.add(caseInstance1.getId());</span>
<span class="nc" id="L950">        caseInstanceIdList.add(caseInstance2.getId());</span>

<span class="nc" id="L952">        cmmnRuntimeService.bulkTerminateCaseInstances(caseInstanceIdList);</span>

<span class="nc" id="L954">        assertCaseInstanceEnded(caseInstance1, 0);</span>
<span class="nc" id="L955">        assertCaseInstanceEnded(caseInstance2, 1);</span>
<span class="nc" id="L956">        assertCaseInstanceNotEnded(caseInstance3);</span>
<span class="nc bnc" id="L957" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L958">            HistoricCaseInstance historicCaseInstance = cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance2.getId())</span>
<span class="nc" id="L959">                    .singleResult();</span>
<span class="nc" id="L960">            assertThat(historicCaseInstance).isNotNull();</span>
<span class="nc" id="L961">            assertThat(historicCaseInstance.getStartTime()).isNotNull();</span>
<span class="nc" id="L962">            assertThat(historicCaseInstance.getEndTime()).isNotNull();</span>
<span class="nc" id="L963">            assertThat(historicCaseInstance.getState()).isEqualTo(CaseInstanceState.TERMINATED);</span>
        }
<span class="nc" id="L965">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance3.getId()).singleResult()).isNotNull();</span>
<span class="nc" id="L966">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/RuntimeServiceTest.testTerminateCaseInstance.cmmn&quot; })
    public void testInvalidBulkTerminateCaseInstances() {

<span class="nc" id="L972">        CaseInstance caseInstance1 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L973">        CaseInstance caseInstance2 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L974">        CaseInstance caseInstance3 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>

<span class="nc" id="L976">        cmmnRuntimeService.triggerPlanItemInstance(cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L977">                .caseInstanceId(caseInstance2.getId()).planItemInstanceState(PlanItemInstanceState.ACTIVE).singleResult().getId());</span>

<span class="nc" id="L979">        Set&lt;String&gt; caseInstanceIdList = new HashSet&lt;&gt;();</span>
<span class="nc" id="L980">        caseInstanceIdList.add(caseInstance1.getId());</span>
<span class="nc" id="L981">        caseInstanceIdList.add(caseInstance2.getId());</span>
<span class="nc" id="L982">        caseInstanceIdList.add(&quot;inValidId&quot;);</span>

<span class="nc" id="L984">        assertThatThrownBy(() -&gt; cmmnRuntimeService.bulkTerminateCaseInstances(caseInstanceIdList))</span>
<span class="nc" id="L985">                .isInstanceOf(FlowableObjectNotFoundException.class).hasMessage(&quot;No case instance found for id inValidId&quot;);</span>

<span class="nc" id="L987">        assertCaseInstanceNotEnded(caseInstance1);</span>
<span class="nc" id="L988">        assertCaseInstanceNotEnded(caseInstance2);</span>
<span class="nc" id="L989">        assertCaseInstanceNotEnded(caseInstance3);</span>

<span class="nc" id="L991">        assertThatThrownBy(() -&gt; cmmnRuntimeService.bulkTerminateCaseInstances(null))</span>
<span class="nc" id="L992">                .isInstanceOf(FlowableIllegalArgumentException.class).hasMessage(&quot;caseInstanceIds are null&quot;);</span>
<span class="nc" id="L993">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/RuntimeServiceTest.testTerminateCaseInstance.cmmn&quot; })
    public void testInvalidBulkDeleteCaseInstances() {

<span class="nc" id="L999">        CaseInstance caseInstance1 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L1000">        CaseInstance caseInstance2 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L1001">        CaseInstance caseInstance3 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>

<span class="nc" id="L1003">        cmmnRuntimeService.triggerPlanItemInstance(cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L1004">                .caseInstanceId(caseInstance2.getId()).planItemInstanceState(PlanItemInstanceState.ACTIVE).singleResult().getId());</span>

<span class="nc" id="L1006">        Set&lt;String&gt; caseInstanceIdList = new HashSet&lt;&gt;();</span>
<span class="nc" id="L1007">        caseInstanceIdList.add(caseInstance1.getId());</span>
<span class="nc" id="L1008">        caseInstanceIdList.add(caseInstance2.getId());</span>
<span class="nc" id="L1009">        caseInstanceIdList.add(&quot;inValidId&quot;);</span>

<span class="nc" id="L1011">        assertThatThrownBy(() -&gt; cmmnRuntimeService.bulkDeleteCaseInstances(caseInstanceIdList))</span>
<span class="nc" id="L1012">                .isInstanceOf(FlowableObjectNotFoundException.class).hasMessage(&quot;Cannot find case instance for id inValidId&quot;);</span>

<span class="nc" id="L1014">        assertCaseInstanceNotEnded(caseInstance1);</span>
<span class="nc" id="L1015">        assertCaseInstanceNotEnded(caseInstance2);</span>
<span class="nc" id="L1016">        assertCaseInstanceNotEnded(caseInstance3);</span>

<span class="nc" id="L1018">        assertThatThrownBy(() -&gt; cmmnRuntimeService.bulkDeleteCaseInstances(null))</span>
<span class="nc" id="L1019">                .isInstanceOf(FlowableIllegalArgumentException.class).hasMessage(&quot;caseInstanceIds are null&quot;);</span>
<span class="nc" id="L1020">    }</span>

    @Test
    @CmmnDeployment
    public void testDeleteCaseInstance() {

        // Task A active
<span class="nc" id="L1027">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L1028">        cmmnRuntimeService.deleteCaseInstance(caseInstance.getId());</span>
<span class="nc" id="L1029">        assertCaseInstanceEnded(caseInstance, 0);</span>

        // Task B active
<span class="nc" id="L1032">        caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L1033">        cmmnRuntimeService.triggerPlanItemInstance(cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L1034">                .caseInstanceId(caseInstance.getId()).planItemInstanceState(PlanItemInstanceState.ACTIVE).singleResult().getId());</span>
<span class="nc" id="L1035">        cmmnRuntimeService.deleteCaseInstance(caseInstance.getId());</span>
<span class="nc" id="L1036">        assertCaseInstanceEnded(caseInstance, 1);</span>

<span class="nc bnc" id="L1038" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1039">            HistoricCaseInstance historicCaseInstance = cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1040">                    .singleResult();</span>
<span class="nc" id="L1041">            assertThat(historicCaseInstance).isNotNull();</span>
<span class="nc" id="L1042">            assertThat(historicCaseInstance.getStartTime()).isNotNull();</span>
<span class="nc" id="L1043">            assertThat(historicCaseInstance.getEndTime()).isNotNull();</span>
<span class="nc" id="L1044">            assertThat(historicCaseInstance.getState()).isEqualTo(CaseInstanceState.TERMINATED);</span>
        }
<span class="nc" id="L1046">    }</span>
    
    @Test
    @CmmnDeployment
    public void testDeleteCaseInstanceWithListener() {
<span class="nc" id="L1051">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L1052">        cmmnRuntimeService.triggerPlanItemInstance(cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L1053">                .caseInstanceId(caseInstance.getId()).planItemInstanceState(PlanItemInstanceState.ACTIVE).singleResult().getId());</span>
        
<span class="nc" id="L1055">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L1056">            cmmnRuntimeService.terminateCaseInstance(caseInstance.getId());</span>
<span class="nc" id="L1057">        }).isInstanceOf(FlowableException.class);</span>
        
<span class="nc" id="L1059">        cmmnRuntimeService.deleteCaseInstance(caseInstance.getId());</span>
<span class="nc" id="L1060">        assertCaseInstanceEnded(caseInstance, 1);</span>

<span class="nc bnc" id="L1062" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1063">            HistoricCaseInstance historicCaseInstance = cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1064">                    .singleResult();</span>
<span class="nc" id="L1065">            assertThat(historicCaseInstance).isNotNull();</span>
<span class="nc" id="L1066">            assertThat(historicCaseInstance.getStartTime()).isNotNull();</span>
<span class="nc" id="L1067">            assertThat(historicCaseInstance.getEndTime()).isNotNull();</span>
<span class="nc" id="L1068">            assertThat(historicCaseInstance.getState()).isEqualTo(CaseInstanceState.TERMINATED);</span>
        }
<span class="nc" id="L1070">    }</span>
    
    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/RuntimeServiceTest.testDeleteCaseInstanceWithListenerAndCaseTask.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/RuntimeServiceTest.testDeleteCaseInstanceWithListener.cmmn&quot;
    })
    public void testDeleteCaseInstanceWithListenerAndCaseTask() {
<span class="nc" id="L1078">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCaseWithCaseTask&quot;).start();</span>
<span class="nc" id="L1079">        cmmnRuntimeService.triggerPlanItemInstance(cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L1080">                .caseInstanceId(caseInstance.getId()).planItemInstanceState(PlanItemInstanceState.ACTIVE).singleResult().getId());</span>
        
<span class="nc" id="L1082">        CaseInstance subCaseInstance = cmmnRuntimeService.createCaseInstanceQuery().caseDefinitionKey(&quot;myCase&quot;).singleResult();</span>
<span class="nc" id="L1083">        assertThat(subCaseInstance).isNotNull();</span>
        
<span class="nc" id="L1085">        assertThatThrownBy(() -&gt; {</span>
<span class="nc" id="L1086">            cmmnRuntimeService.terminateCaseInstance(caseInstance.getId());</span>
<span class="nc" id="L1087">        }).isInstanceOf(FlowableException.class);</span>
        
<span class="nc" id="L1089">        cmmnRuntimeService.deleteCaseInstance(caseInstance.getId());</span>
<span class="nc" id="L1090">        assertCaseInstanceEnded(caseInstance, 0);</span>
<span class="nc" id="L1091">        assertCaseInstanceEnded(subCaseInstance, 0);</span>

<span class="nc bnc" id="L1093" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1094">            HistoricCaseInstance historicCaseInstance = cmmnHistoryService.createHistoricCaseInstanceQuery()</span>
<span class="nc" id="L1095">                    .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1096">                    .singleResult();</span>
<span class="nc" id="L1097">            assertThat(historicCaseInstance).isNotNull();</span>
<span class="nc" id="L1098">            assertThat(historicCaseInstance.getStartTime()).isNotNull();</span>
<span class="nc" id="L1099">            assertThat(historicCaseInstance.getEndTime()).isNotNull();</span>
<span class="nc" id="L1100">            assertThat(historicCaseInstance.getState()).isEqualTo(CaseInstanceState.TERMINATED);</span>
            
<span class="nc" id="L1102">            HistoricCaseInstance historicSubCaseInstance = cmmnHistoryService.createHistoricCaseInstanceQuery()</span>
<span class="nc" id="L1103">                    .caseInstanceId(subCaseInstance.getId())</span>
<span class="nc" id="L1104">                    .singleResult();</span>
<span class="nc" id="L1105">            assertThat(historicSubCaseInstance).isNotNull();</span>
<span class="nc" id="L1106">            assertThat(historicSubCaseInstance.getStartTime()).isNotNull();</span>
<span class="nc" id="L1107">            assertThat(historicSubCaseInstance.getEndTime()).isNotNull();</span>
<span class="nc" id="L1108">            assertThat(historicSubCaseInstance.getState()).isEqualTo(CaseInstanceState.TERMINATED);</span>
        }
<span class="nc" id="L1110">    }</span>

    @Test
    @CmmnDeployment
    public void testTerminateCaseInstanceWithNestedStages() {
<span class="nc" id="L1115">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L1116">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isEqualTo(8);</span>
<span class="nc" id="L1117">        cmmnRuntimeService.terminateCaseInstance(caseInstance.getId());</span>
<span class="nc" id="L1118">        assertCaseInstanceEnded(caseInstance, 0);</span>

<span class="nc bnc" id="L1120" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1121">            HistoricCaseInstance historicCaseInstance = cmmnHistoryService.createHistoricCaseInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L1122">                    .singleResult();</span>
<span class="nc" id="L1123">            assertThat(historicCaseInstance).isNotNull();</span>
<span class="nc" id="L1124">            assertThat(historicCaseInstance.getStartTime()).isNotNull();</span>
<span class="nc" id="L1125">            assertThat(historicCaseInstance.getEndTime()).isNotNull();</span>
<span class="nc" id="L1126">            assertThat(historicCaseInstance.getState()).isEqualTo(CaseInstanceState.TERMINATED);</span>
        }
<span class="nc" id="L1128">    }</span>

    @Test
    @CmmnDeployment
    public void testCaseInstanceProperties() {
<span class="nc" id="L1133">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L1134">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L1135">                .name(&quot;test name&quot;)</span>
<span class="nc" id="L1136">                .businessKey(&quot;test business key&quot;)</span>
<span class="nc" id="L1137">                .start();</span>

<span class="nc" id="L1139">        caseInstance = cmmnRuntimeService.createCaseInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L1140">        assertThat(caseInstance.getName()).isEqualTo(&quot;test name&quot;);</span>
<span class="nc" id="L1141">        assertThat(caseInstance.getBusinessKey()).isEqualTo(&quot;test business key&quot;);</span>
<span class="nc" id="L1142">    }</span>

    @Test
    @CmmnDeployment
    public void testCaseInstanceStarterIdentityLink() {
<span class="nc" id="L1147">        Authentication.setAuthenticatedUserId(&quot;testUser&quot;);</span>
<span class="nc" id="L1148">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L1149">        Authentication.setAuthenticatedUserId(null);</span>

<span class="nc" id="L1151">        List&lt;IdentityLink&gt; caseIdentityLinks = cmmnRuntimeService.getIdentityLinksForCaseInstance(caseInstance.getId());</span>
<span class="nc" id="L1152">        assertThat(caseIdentityLinks)</span>
<span class="nc" id="L1153">                .extracting(IdentityLink::getScopeId, IdentityLink::getScopeType, IdentityLink::getType, IdentityLink::getUserId)</span>
<span class="nc" id="L1154">                .containsExactly(tuple(caseInstance.getId(), ScopeTypes.CMMN, IdentityLinkType.STARTER, &quot;testUser&quot;));</span>

<span class="nc bnc" id="L1156" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1157">            List&lt;HistoricIdentityLink&gt; historicIdentityLinks = cmmnHistoryService.getHistoricIdentityLinksForCaseInstance(caseInstance.getId());</span>
<span class="nc" id="L1158">            assertThat(historicIdentityLinks)</span>
<span class="nc" id="L1159">                    .extracting(</span>
                            HistoricIdentityLink::getScopeId,
                            HistoricIdentityLink::getScopeType,
                            HistoricIdentityLink::getType,
                            HistoricIdentityLink::getUserId)
<span class="nc" id="L1164">                    .containsExactly(tuple(caseInstance.getId(), ScopeTypes.CMMN, IdentityLinkType.STARTER, &quot;testUser&quot;));</span>
        }
<span class="nc" id="L1166">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/RuntimeServiceTest.testStartSimplePassthroughCaseWithBlockingTask.cmmn&quot; })
    public void planItemQueryWithoutTenant() {
<span class="nc" id="L1171">        cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L1172">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L1173">                .variable(&quot;var&quot;, &quot;test&quot;)</span>
<span class="nc" id="L1174">                .variable(&quot;numberVar&quot;, 10)</span>
<span class="nc" id="L1175">                .start();</span>

<span class="nc" id="L1177">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;Task A&quot;).planItemInstanceWithoutTenantId().count()).isEqualTo(1);</span>
<span class="nc" id="L1178">        assertThat(cmmnRuntimeService.createPlanItemInstanceQuery().planItemInstanceName(&quot;Task A&quot;).planItemInstanceWithoutTenantId().list()).hasSize(1);</span>
<span class="nc" id="L1179">    }</span>

    @Test
    @CmmnDeployment(resources = { &quot;org/flowable/cmmn/test/runtime/RuntimeServiceTest.testStartSimplePassthroughCaseWithBlockingTask.cmmn&quot; })
    public void testCaseInstanceQueryWithOrderByStartTime() {
<span class="nc" id="L1184">        Instant now = Instant.now();</span>
<span class="nc" id="L1185">        setClockTo(Date.from(now));</span>

<span class="nc" id="L1187">        CaseInstance case1 = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L1188">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L1189">                .businessKey(&quot;firstCase&quot;)</span>
<span class="nc" id="L1190">                .start();</span>

<span class="nc" id="L1192">        setClockTo(Date.from(now.plusSeconds(10)));</span>

<span class="nc" id="L1194">        CaseInstance case2 = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L1195">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L1196">                .businessKey(&quot;secondCase&quot;)</span>
<span class="nc" id="L1197">                .start();</span>

<span class="nc" id="L1199">        setClockTo(Date.from(now.plusSeconds(40)));</span>

<span class="nc" id="L1201">        CaseInstance case3 = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L1202">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L1203">                .businessKey(&quot;thirdCase&quot;)</span>
<span class="nc" id="L1204">                .start();</span>

<span class="nc" id="L1206">        setClockTo(Date.from(now.plusSeconds(70)));</span>

<span class="nc" id="L1208">        CaseInstance case4 = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L1209">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L1210">                .businessKey(&quot;fourthCase&quot;)</span>
<span class="nc" id="L1211">                .start();</span>

<span class="nc" id="L1213">        setClockTo(Date.from(now.plusSeconds(100)));</span>

<span class="nc" id="L1215">        CaseInstance case5 = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L1216">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L1217">                .businessKey(&quot;fifthCase&quot;)</span>
<span class="nc" id="L1218">                .start();</span>

<span class="nc" id="L1220">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().orderByStartTime().asc().list())</span>
<span class="nc" id="L1221">                .extracting(CaseInstance::getId, CaseInstance::getBusinessKey)</span>
<span class="nc" id="L1222">                .containsExactly(</span>
<span class="nc" id="L1223">                        tuple(case1.getId(), &quot;firstCase&quot;),</span>
<span class="nc" id="L1224">                        tuple(case2.getId(), &quot;secondCase&quot;),</span>
<span class="nc" id="L1225">                        tuple(case3.getId(), &quot;thirdCase&quot;),</span>
<span class="nc" id="L1226">                        tuple(case4.getId(), &quot;fourthCase&quot;),</span>
<span class="nc" id="L1227">                        tuple(case5.getId(), &quot;fifthCase&quot;)</span>
                );

<span class="nc" id="L1230">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().orderByStartTime().asc().listPage(0, 3))</span>
<span class="nc" id="L1231">                .extracting(CaseInstance::getId, CaseInstance::getBusinessKey)</span>
<span class="nc" id="L1232">                .containsExactly(</span>
<span class="nc" id="L1233">                        tuple(case1.getId(), &quot;firstCase&quot;),</span>
<span class="nc" id="L1234">                        tuple(case2.getId(), &quot;secondCase&quot;),</span>
<span class="nc" id="L1235">                        tuple(case3.getId(), &quot;thirdCase&quot;)</span>
                );

<span class="nc" id="L1238">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().orderByStartTime().asc().listPage(3, 10))</span>
<span class="nc" id="L1239">                .extracting(CaseInstance::getId, CaseInstance::getBusinessKey)</span>
<span class="nc" id="L1240">                .containsExactly(</span>
<span class="nc" id="L1241">                        tuple(case4.getId(), &quot;fourthCase&quot;),</span>
<span class="nc" id="L1242">                        tuple(case5.getId(), &quot;fifthCase&quot;)</span>
                );

<span class="nc" id="L1245">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().orderByStartTime().asc().listPage(10, 20))</span>
<span class="nc" id="L1246">                .extracting(CaseInstance::getId, CaseInstance::getBusinessKey)</span>
<span class="nc" id="L1247">                .isEmpty();</span>

<span class="nc bnc" id="L1249" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1250">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().orderByStartTime().asc().list())</span>
<span class="nc" id="L1251">                .extracting(HistoricCaseInstance::getId, HistoricCaseInstance::getBusinessKey)</span>
<span class="nc" id="L1252">                .containsExactly(</span>
<span class="nc" id="L1253">                    tuple(case1.getId(), &quot;firstCase&quot;),</span>
<span class="nc" id="L1254">                    tuple(case2.getId(), &quot;secondCase&quot;),</span>
<span class="nc" id="L1255">                    tuple(case3.getId(), &quot;thirdCase&quot;),</span>
<span class="nc" id="L1256">                    tuple(case4.getId(), &quot;fourthCase&quot;),</span>
<span class="nc" id="L1257">                    tuple(case5.getId(), &quot;fifthCase&quot;)</span>
                );

<span class="nc" id="L1260">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().orderByStartTime().asc().listPage(0, 3))</span>
<span class="nc" id="L1261">                .extracting(HistoricCaseInstance::getId, HistoricCaseInstance::getBusinessKey)</span>
<span class="nc" id="L1262">                .containsExactly(</span>
<span class="nc" id="L1263">                    tuple(case1.getId(), &quot;firstCase&quot;),</span>
<span class="nc" id="L1264">                    tuple(case2.getId(), &quot;secondCase&quot;),</span>
<span class="nc" id="L1265">                    tuple(case3.getId(), &quot;thirdCase&quot;)</span>
                );

<span class="nc" id="L1268">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().orderByStartTime().asc().listPage(3, 10))</span>
<span class="nc" id="L1269">                .extracting(HistoricCaseInstance::getId, HistoricCaseInstance::getBusinessKey)</span>
<span class="nc" id="L1270">                .containsExactly(</span>
<span class="nc" id="L1271">                    tuple(case4.getId(), &quot;fourthCase&quot;),</span>
<span class="nc" id="L1272">                    tuple(case5.getId(), &quot;fifthCase&quot;)</span>
                );

<span class="nc" id="L1275">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().orderByStartTime().asc().listPage(10, 20))</span>
<span class="nc" id="L1276">                .extracting(HistoricCaseInstance::getId, HistoricCaseInstance::getBusinessKey)</span>
<span class="nc" id="L1277">                .isEmpty();</span>
        }
<span class="nc" id="L1279">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/runtime/RuntimeServiceTest.testStartSimplePassthroughCaseWithBlockingTask.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/oneHumanTaskCase.cmmn&quot;
    })
    public void testCaseInstanceQueryWithOrderByCaseDefinitionId() {
<span class="nc" id="L1287">        CaseInstance case1 = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L1288">                .caseDefinitionKey(&quot;myCase&quot;)</span>
<span class="nc" id="L1289">                .businessKey(&quot;Pass Through Case&quot;)</span>
<span class="nc" id="L1290">                .start();</span>

<span class="nc" id="L1292">        CaseInstance case2 = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L1293">                .caseDefinitionKey(&quot;oneHumanTaskCase&quot;)</span>
<span class="nc" id="L1294">                .businessKey(&quot;One Human Task Case&quot;)</span>
<span class="nc" id="L1295">                .start();</span>

        String caseBusinessKeyWithHigherCaseDefId;
        String caseBusinessKeyWithLowerCaseDefId;

<span class="nc bnc" id="L1300" title="All 2 branches missed.">        if (case1.getCaseDefinitionId().compareTo(case2.getCaseDefinitionId()) &gt; 0) {</span>
            // Case Definition Id 1 has higher id
<span class="nc" id="L1302">            caseBusinessKeyWithHigherCaseDefId = case1.getBusinessKey();</span>
<span class="nc" id="L1303">            caseBusinessKeyWithLowerCaseDefId = case2.getBusinessKey();</span>
        } else {
<span class="nc" id="L1305">            caseBusinessKeyWithHigherCaseDefId = case2.getBusinessKey();</span>
<span class="nc" id="L1306">            caseBusinessKeyWithLowerCaseDefId = case1.getBusinessKey();</span>
        }

<span class="nc" id="L1309">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().orderByCaseDefinitionId().asc().list())</span>
<span class="nc" id="L1310">                .extracting(CaseInstance::getBusinessKey)</span>
<span class="nc" id="L1311">                .containsExactly(</span>
                        caseBusinessKeyWithLowerCaseDefId,
                        caseBusinessKeyWithHigherCaseDefId
                );

<span class="nc" id="L1316">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().orderByCaseDefinitionId().asc().listPage(0, 3))</span>
<span class="nc" id="L1317">                .extracting(CaseInstance::getBusinessKey)</span>
<span class="nc" id="L1318">                .containsExactly(</span>
                        caseBusinessKeyWithLowerCaseDefId,
                        caseBusinessKeyWithHigherCaseDefId
                );

<span class="nc" id="L1323">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().orderByCaseDefinitionId().asc().listPage(10, 20))</span>
<span class="nc" id="L1324">                .extracting(CaseInstance::getId, CaseInstance::getBusinessKey)</span>
<span class="nc" id="L1325">                .isEmpty();</span>

<span class="nc" id="L1327">        assertThat(cmmnRuntimeService.createCaseInstanceQuery().orderByCaseDefinitionId().desc().list())</span>
<span class="nc" id="L1328">                .extracting(CaseInstance::getBusinessKey)</span>
<span class="nc" id="L1329">                .containsExactly(</span>
                        caseBusinessKeyWithHigherCaseDefId,
                        caseBusinessKeyWithLowerCaseDefId
                );

<span class="nc bnc" id="L1334" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L1335">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().orderByCaseDefinitionId().asc().list())</span>
<span class="nc" id="L1336">                .extracting(HistoricCaseInstance::getBusinessKey)</span>
<span class="nc" id="L1337">                .containsExactly(</span>
                        caseBusinessKeyWithLowerCaseDefId,
                        caseBusinessKeyWithHigherCaseDefId
                );

<span class="nc" id="L1342">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().orderByCaseDefinitionId().asc().listPage(0, 3))</span>
<span class="nc" id="L1343">                .extracting(HistoricCaseInstance::getBusinessKey)</span>
<span class="nc" id="L1344">                .containsExactly(</span>
                        caseBusinessKeyWithLowerCaseDefId,
                        caseBusinessKeyWithHigherCaseDefId
                );

<span class="nc" id="L1349">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().orderByCaseDefinitionId().asc().listPage(10, 20))</span>
<span class="nc" id="L1350">                .extracting(HistoricCaseInstance::getBusinessKey)</span>
<span class="nc" id="L1351">                .isEmpty();</span>

<span class="nc" id="L1353">            assertThat(cmmnHistoryService.createHistoricCaseInstanceQuery().orderByCaseDefinitionId().desc().list())</span>
<span class="nc" id="L1354">                    .extracting(HistoricCaseInstance::getBusinessKey)</span>
<span class="nc" id="L1355">                    .containsExactly(</span>
                            caseBusinessKeyWithHigherCaseDefId,
                            caseBusinessKeyWithLowerCaseDefId
                    );
        }
<span class="nc" id="L1360">    }</span>

<span class="nc" id="L1362">    protected class TestStartCaseInstanceInterceptor implements StartCaseInstanceInterceptor {</span>

<span class="nc" id="L1364">        protected int beforeStartCaseInstanceCounter = 0;</span>
<span class="nc" id="L1365">        protected int afterStartCaseInstanceCounter = 0;</span>

        @Override
        public void beforeStartCaseInstance(StartCaseInstanceBeforeContext instanceContext) {
<span class="nc" id="L1369">            beforeStartCaseInstanceCounter++;</span>
<span class="nc" id="L1370">            Map&lt;String, Object&gt; varMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1371">            varMap.put(&quot;beforeContextVar&quot;, &quot;test&quot;);</span>
<span class="nc" id="L1372">            instanceContext.setVariables(varMap);</span>
<span class="nc" id="L1373">            instanceContext.setBusinessKey(&quot;testKey&quot;);</span>
<span class="nc" id="L1374">        }</span>

        @Override
        public void afterStartCaseInstance(StartCaseInstanceAfterContext instanceContext) {
<span class="nc" id="L1378">            afterStartCaseInstanceCounter++;</span>
<span class="nc" id="L1379">        }</span>

        public int getBeforeStartCaseInstanceCounter() {
<span class="nc" id="L1382">            return beforeStartCaseInstanceCounter;</span>
        }

        public int getAfterStartCaseInstanceCounter() {
<span class="nc" id="L1386">            return afterStartCaseInstanceCounter;</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>