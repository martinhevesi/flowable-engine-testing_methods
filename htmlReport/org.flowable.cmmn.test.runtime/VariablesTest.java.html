<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>VariablesTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.cmmn.test.runtime</a> &gt; <span class="el_source">VariablesTest.java</span></div><h1>VariablesTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.cmmn.test.runtime;

import static java.util.stream.Collectors.toMap;
import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.assertj.core.api.Assertions.entry;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.StringJoiner;
import java.util.stream.Stream;

import org.apache.commons.lang3.tuple.ImmutablePair;
import org.apache.commons.lang3.tuple.Pair;
import org.flowable.cmmn.api.CmmnRuntimeService;
import org.flowable.cmmn.api.delegate.DelegatePlanItemInstance;
import org.flowable.cmmn.api.delegate.PlanItemJavaDelegate;
import org.flowable.cmmn.api.history.HistoricMilestoneInstance;
import org.flowable.cmmn.api.runtime.CaseInstance;
import org.flowable.cmmn.api.runtime.PlanItemInstance;
import org.flowable.cmmn.engine.impl.CmmnManagementServiceImpl;
import org.flowable.cmmn.engine.impl.util.CommandContextUtil;
import org.flowable.cmmn.engine.test.CmmnDeployment;
import org.flowable.cmmn.engine.test.FlowableCmmnTestCase;
import org.flowable.cmmn.engine.test.impl.CmmnHistoryTestHelper;
import org.flowable.common.engine.api.FlowableIllegalArgumentException;
import org.flowable.common.engine.api.FlowableObjectNotFoundException;
import org.flowable.common.engine.api.scope.ScopeTypes;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.common.engine.impl.interceptor.Command;
import org.flowable.common.engine.impl.interceptor.CommandContext;
import org.flowable.common.engine.impl.util.CollectionUtil;
import org.flowable.task.api.Task;
import org.flowable.variable.api.history.HistoricVariableInstance;
import org.flowable.variable.api.persistence.entity.VariableInstance;
import org.flowable.variable.api.types.ValueFields;
import org.flowable.variable.api.types.VariableType;
import org.flowable.variable.service.VariableServiceConfiguration;
import org.flowable.variable.service.impl.persistence.entity.VariableInstanceEntity;
import org.junit.Test;

/**
 * @author Joram Barrez
 */
<span class="nc" id="L64">public class VariablesTest extends FlowableCmmnTestCase {</span>

    @Test
    @CmmnDeployment
    public void testGetVariables() {
<span class="nc" id="L69">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L70">        variables.put(&quot;stringVar&quot;, &quot;Hello World&quot;);</span>
<span class="nc" id="L71">        variables.put(&quot;intVar&quot;, 42);</span>
<span class="nc" id="L72">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).variables(variables).start();</span>

<span class="nc" id="L74">        Map&lt;String, Object&gt; variablesFromGet = cmmnRuntimeService.getVariables(caseInstance.getId());</span>
<span class="nc" id="L75">        assertThat(variablesFromGet)</span>
<span class="nc" id="L76">                .containsKeys(&quot;stringVar&quot;, &quot;intVar&quot;)</span>
<span class="nc" id="L77">                .containsEntry(&quot;stringVar&quot;, &quot;Hello World&quot;);</span>
<span class="nc" id="L78">        assertThat(((Integer) variablesFromGet.get(&quot;intVar&quot;)).intValue()).isEqualTo(42);</span>

<span class="nc" id="L80">        Map&lt;String, VariableInstance&gt; variableInstancesFromGet = cmmnRuntimeService.getVariableInstances(caseInstance.getId());</span>
<span class="nc" id="L81">        assertThat(variableInstancesFromGet).containsKey(&quot;stringVar&quot;);</span>
<span class="nc" id="L82">        VariableInstance variableInstance = variableInstancesFromGet.get(&quot;stringVar&quot;);</span>
<span class="nc" id="L83">        assertThat(variableInstance.getValue()).isEqualTo(&quot;Hello World&quot;);</span>
<span class="nc" id="L84">        assertThat(variableInstance.getTypeName()).isEqualTo(&quot;string&quot;);</span>
<span class="nc" id="L85">        assertThat(variableInstancesFromGet).containsKey(&quot;intVar&quot;);</span>
<span class="nc" id="L86">        variableInstance = variableInstancesFromGet.get(&quot;intVar&quot;);</span>
<span class="nc" id="L87">        assertThat(((Integer) variableInstance.getValue()).intValue()).isEqualTo(42);</span>
<span class="nc" id="L88">        assertThat(variableInstance.getTypeName()).isEqualTo(&quot;integer&quot;);</span>

<span class="nc" id="L90">        assertThat((String) cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;stringVar&quot;)).isEqualTo(&quot;Hello World&quot;);</span>
<span class="nc" id="L91">        assertThat(((Integer) cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;intVar&quot;)).intValue()).isEqualTo(42);</span>
<span class="nc" id="L92">        assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;doesNotExist&quot;)).isNull();</span>

<span class="nc" id="L94">        variableInstance = cmmnRuntimeService.getVariableInstance(caseInstance.getId(), &quot;stringVar&quot;);</span>
<span class="nc" id="L95">        assertThat(variableInstance.getValue()).isEqualTo(&quot;Hello World&quot;);</span>
<span class="nc" id="L96">        assertThat(variableInstance.getTypeName()).isEqualTo(&quot;string&quot;);</span>
<span class="nc" id="L97">        variableInstance = cmmnRuntimeService.getVariableInstance(caseInstance.getId(), &quot;intVar&quot;);</span>
<span class="nc" id="L98">        assertThat(((Integer) variableInstance.getValue()).intValue()).isEqualTo(42);</span>
<span class="nc" id="L99">        assertThat(variableInstance.getTypeName()).isEqualTo(&quot;integer&quot;);</span>
<span class="nc" id="L100">        variableInstance = cmmnRuntimeService.getVariableInstance(caseInstance.getId(), &quot;doesNotExist&quot;);</span>
<span class="nc" id="L101">        assertThat(variableInstance).isNull();</span>
<span class="nc" id="L102">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/runtime/oneHumanTaskCase.cmmn&quot;)
    public void testGetSpecificVariablesOnly() {
<span class="nc" id="L107">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L108">                .caseDefinitionKey(&quot;oneHumanTaskCase&quot;)</span>
<span class="nc" id="L109">                .variable(&quot;stringVar&quot;, &quot;Hello World&quot;)</span>
<span class="nc" id="L110">                .variable(&quot;intVar&quot;, 42)</span>
<span class="nc" id="L111">                .variable(&quot;doubleVar&quot;, 10.5)</span>
<span class="nc" id="L112">                .start();</span>

<span class="nc" id="L114">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId()))</span>
<span class="nc" id="L115">                .containsOnly(</span>
<span class="nc" id="L116">                        entry(&quot;stringVar&quot;, &quot;Hello World&quot;),</span>
<span class="nc" id="L117">                        entry(&quot;intVar&quot;, 42),</span>
<span class="nc" id="L118">                        entry(&quot;doubleVar&quot;, 10.5)</span>
                );

<span class="nc" id="L121">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId(), Arrays.asList(&quot;stringVar&quot;, &quot;doubleVar&quot;, &quot;dummyVar&quot;)))</span>
<span class="nc" id="L122">                .containsOnly(</span>
<span class="nc" id="L123">                        entry(&quot;stringVar&quot;, &quot;Hello World&quot;),</span>
<span class="nc" id="L124">                        entry(&quot;doubleVar&quot;, 10.5)</span>
                );
<span class="nc" id="L126">    }</span>

    @Test
    @CmmnDeployment
    public void testGetLocalVariables() {
<span class="nc" id="L131">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L132">        variables.put(&quot;stringVar&quot;, &quot;Hello World&quot;);</span>
<span class="nc" id="L133">        variables.put(&quot;intVar&quot;, 42);</span>
<span class="nc" id="L134">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).variables(variables).start();</span>

<span class="nc" id="L136">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().planItemDefinitionId(&quot;nestedTask&quot;)</span>
<span class="nc" id="L137">                .caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L138">        cmmnRuntimeService.setLocalVariable(planItemInstance.getId(), &quot;stringVar&quot;, &quot;Changed value&quot;);</span>
<span class="nc" id="L139">        cmmnRuntimeService.setLocalVariable(planItemInstance.getId(), &quot;intVar&quot;, 21);</span>

<span class="nc" id="L141">        Map&lt;String, Object&gt; variablesFromGet = cmmnRuntimeService.getVariables(caseInstance.getId());</span>
<span class="nc" id="L142">        assertThat(variablesFromGet)</span>
<span class="nc" id="L143">                .containsKeys(&quot;stringVar&quot;, &quot;intVar&quot;)</span>
<span class="nc" id="L144">                .containsEntry(&quot;stringVar&quot;, &quot;Hello World&quot;);</span>
<span class="nc" id="L145">        assertThat(((Integer) variablesFromGet.get(&quot;intVar&quot;)).intValue()).isEqualTo(42);</span>

<span class="nc" id="L147">        Map&lt;String, VariableInstance&gt; variableInstancesFromGet = cmmnRuntimeService.getVariableInstances(caseInstance.getId());</span>
<span class="nc" id="L148">        assertThat(variableInstancesFromGet).containsKey(&quot;stringVar&quot;);</span>
<span class="nc" id="L149">        VariableInstance variableInstance = variableInstancesFromGet.get(&quot;stringVar&quot;);</span>
<span class="nc" id="L150">        assertThat(variableInstance.getValue()).isEqualTo(&quot;Hello World&quot;);</span>
<span class="nc" id="L151">        assertThat(variableInstance.getTypeName()).isEqualTo(&quot;string&quot;);</span>
<span class="nc" id="L152">        assertThat(variableInstancesFromGet).containsKey(&quot;intVar&quot;);</span>
<span class="nc" id="L153">        variableInstance = variableInstancesFromGet.get(&quot;intVar&quot;);</span>
<span class="nc" id="L154">        assertThat(((Integer) variableInstance.getValue()).intValue()).isEqualTo(42);</span>
<span class="nc" id="L155">        assertThat(variableInstance.getTypeName()).isEqualTo(&quot;integer&quot;);</span>

<span class="nc" id="L157">        Map&lt;String, Object&gt; localVariablesFromGet = cmmnRuntimeService.getLocalVariables(planItemInstance.getId());</span>
<span class="nc" id="L158">        assertThat(localVariablesFromGet)</span>
<span class="nc" id="L159">                .containsKeys(&quot;stringVar&quot;, &quot;intVar&quot;)</span>
<span class="nc" id="L160">                .containsEntry(&quot;stringVar&quot;, &quot;Changed value&quot;);</span>
<span class="nc" id="L161">        assertThat(((Integer) localVariablesFromGet.get(&quot;intVar&quot;)).intValue()).isEqualTo(21);</span>

<span class="nc" id="L163">        Map&lt;String, VariableInstance&gt; localVariableInstancesFromGet = cmmnRuntimeService.getLocalVariableInstances(planItemInstance.getId());</span>
<span class="nc" id="L164">        assertThat(localVariableInstancesFromGet).containsKey(&quot;stringVar&quot;);</span>
<span class="nc" id="L165">        variableInstance = localVariableInstancesFromGet.get(&quot;stringVar&quot;);</span>
<span class="nc" id="L166">        assertThat(variableInstance.getValue()).isEqualTo(&quot;Changed value&quot;);</span>
<span class="nc" id="L167">        assertThat(variableInstance.getTypeName()).isEqualTo(&quot;string&quot;);</span>
<span class="nc" id="L168">        assertThat(variableInstancesFromGet).containsKey(&quot;intVar&quot;);</span>
<span class="nc" id="L169">        variableInstance = localVariableInstancesFromGet.get(&quot;intVar&quot;);</span>
<span class="nc" id="L170">        assertThat(((Integer) variableInstance.getValue()).intValue()).isEqualTo(21);</span>
<span class="nc" id="L171">        assertThat(variableInstance.getTypeName()).isEqualTo(&quot;integer&quot;);</span>
<span class="nc" id="L172">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/runtime/oneHumanTaskCase.cmmn&quot;)
    public void testGetSpecificLocalVariables() {
<span class="nc" id="L177">        cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L178">                .caseDefinitionKey(&quot;oneHumanTaskCase&quot;)</span>
<span class="nc" id="L179">                .variable(&quot;stringVar&quot;, &quot;Hello World&quot;)</span>
<span class="nc" id="L180">                .variable(&quot;intVar&quot;, 42)</span>
<span class="nc" id="L181">                .variable(&quot;doubleVar&quot;, 10.5)</span>
<span class="nc" id="L182">                .start();</span>

<span class="nc" id="L184">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().singleResult();</span>
<span class="nc" id="L185">        cmmnRuntimeService.setLocalVariable(planItemInstance.getId(), &quot;stringVar&quot;, &quot;Changed value&quot;);</span>
<span class="nc" id="L186">        cmmnRuntimeService.setLocalVariable(planItemInstance.getId(), &quot;intVar&quot;, 21);</span>
<span class="nc" id="L187">        cmmnRuntimeService.setLocalVariable(planItemInstance.getId(), &quot;doubleVar&quot;, 12.6);</span>

<span class="nc" id="L189">        assertThat(cmmnRuntimeService.getLocalVariables(planItemInstance.getId()))</span>
<span class="nc" id="L190">                .containsOnly(</span>
<span class="nc" id="L191">                        entry(&quot;stringVar&quot;, &quot;Changed value&quot;),</span>
<span class="nc" id="L192">                        entry(&quot;intVar&quot;, 21),</span>
<span class="nc" id="L193">                        entry(&quot;doubleVar&quot;, 12.6)</span>
                );

<span class="nc" id="L196">        assertThat(cmmnRuntimeService.getLocalVariables(planItemInstance.getId(), Arrays.asList(&quot;stringVar&quot;, &quot;doubleVar&quot;, &quot;dummyVar&quot;)))</span>
<span class="nc" id="L197">                .containsOnly(</span>
<span class="nc" id="L198">                        entry(&quot;stringVar&quot;, &quot;Changed value&quot;),</span>
<span class="nc" id="L199">                        entry(&quot;doubleVar&quot;, 12.6)</span>
                );
<span class="nc" id="L201">    }</span>

    @Test
    @CmmnDeployment
    public void testSetVariables() {
<span class="nc" id="L206">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).start();</span>
<span class="nc" id="L207">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L208">        variables.put(&quot;stringVar&quot;, &quot;Hello World&quot;);</span>
<span class="nc" id="L209">        variables.put(&quot;intVar&quot;, 42);</span>
<span class="nc" id="L210">        cmmnRuntimeService.setVariables(caseInstance.getId(), variables);</span>

<span class="nc" id="L212">        assertThat((String) cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;stringVar&quot;)).isEqualTo(&quot;Hello World&quot;);</span>
<span class="nc" id="L213">        assertThat(((Integer) cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;intVar&quot;)).intValue()).isEqualTo(42);</span>
<span class="nc" id="L214">        assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;doesNotExist&quot;)).isNull();</span>
<span class="nc" id="L215">    }</span>

    @Test
    @CmmnDeployment
    public void testRemoveVariables() {
<span class="nc" id="L220">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L221">        variables.put(&quot;stringVar&quot;, &quot;Hello World&quot;);</span>
<span class="nc" id="L222">        variables.put(&quot;intVar&quot;, 42);</span>
<span class="nc" id="L223">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).variables(variables).start();</span>
<span class="nc" id="L224">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId())).hasSize(2);</span>

<span class="nc" id="L226">        cmmnRuntimeService.removeVariable(caseInstance.getId(), &quot;stringVar&quot;);</span>
<span class="nc" id="L227">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId())).hasSize(1);</span>
<span class="nc" id="L228">        assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;StringVar&quot;)).isNull();</span>
<span class="nc" id="L229">        assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;intVar&quot;)).isNotNull();</span>
<span class="nc" id="L230">    }</span>

    @Test
    @CmmnDeployment
    public void testSerializableVariable() {
<span class="nc" id="L235">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L236">        variables.put(&quot;myVariable&quot;, new MyVariable(&quot;Hello World&quot;));</span>
<span class="nc" id="L237">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).variables(variables).start();</span>

<span class="nc" id="L239">        MyVariable myVariable = (MyVariable) cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;myVariable&quot;);</span>
<span class="nc" id="L240">        assertThat(myVariable.value).isEqualTo(&quot;Hello World&quot;);</span>

<span class="nc" id="L242">        cmmnEngineConfiguration.getCommandExecutor().execute(new Command&lt;Void&gt;() {</span>

            @Override
            public Void execute(CommandContext commandContext) {
<span class="nc" id="L246">                VariableInstance variableInstance = cmmnRuntimeService.getVariableInstance(caseInstance.getId(), &quot;myVariable&quot;);</span>
<span class="nc" id="L247">                MyVariable myVariable = (MyVariable) variableInstance.getValue();</span>
<span class="nc" id="L248">                assertThat(myVariable.value).isEqualTo(&quot;Hello World&quot;);</span>

<span class="nc" id="L250">                return null;</span>
            }
        });
<span class="nc" id="L253">    }</span>

    @Test
    @CmmnDeployment
    public void testResolveMilestoneNameAsExpression() {
<span class="nc" id="L258">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L259">        variables.put(&quot;myVariable&quot;, &quot;Hello from test&quot;);</span>
<span class="nc" id="L260">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L261">                .caseDefinitionKey(&quot;myCase&quot;).variables(variables).start();</span>
<span class="nc" id="L262">        assertCaseInstanceEnded(caseInstance);</span>

<span class="nc bnc" id="L264" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L265">            HistoricMilestoneInstance historicMilestoneInstance = cmmnHistoryService.createHistoricMilestoneInstanceQuery()</span>
<span class="nc" id="L266">                .milestoneInstanceCaseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L267">            assertThat(historicMilestoneInstance.getName()).isEqualTo(&quot;Milestone Hello from test and delegate&quot;);</span>
        }
<span class="nc" id="L269">    }</span>

    @Test
    @CmmnDeployment
    public void testHistoricVariables() {
<span class="nc" id="L274">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L275">        variables.put(&quot;stringVar&quot;, &quot;test&quot;);</span>
<span class="nc" id="L276">        variables.put(&quot;intVar&quot;, 123);</span>
<span class="nc" id="L277">        variables.put(&quot;doubleVar&quot;, 123.123);</span>
<span class="nc" id="L278">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;myCase&quot;).variables(variables).start();</span>

        // verify variables
<span class="nc" id="L281">        assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;stringVar&quot;)).isEqualTo(&quot;test&quot;);</span>
        
<span class="nc" id="L283">        VariableInstance variableInstance = cmmnRuntimeService.createVariableInstanceQuery().variableName(&quot;stringVar&quot;)</span>
<span class="nc" id="L284">                .singleResult();</span>
<span class="nc" id="L285">        assertThat(variableInstance.getScopeId()).isEqualTo(caseInstance.getId());</span>
<span class="nc" id="L286">        assertThat(variableInstance.getScopeType()).isEqualTo(ScopeTypes.CMMN);</span>
<span class="nc" id="L287">        assertThat(variableInstance.getValue()).isEqualTo(&quot;test&quot;);</span>
<span class="nc" id="L288">        assertThat(variableInstance.getSubScopeId()).isNull();</span>

<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L291">            HistoricVariableInstance historicVariableInstance = cmmnHistoryService.createHistoricVariableInstanceQuery().variableName(&quot;stringVar&quot;)</span>
<span class="nc" id="L292">                .singleResult();</span>
<span class="nc" id="L293">            assertThat(historicVariableInstance.getScopeId()).isEqualTo(caseInstance.getId());</span>
<span class="nc" id="L294">            assertThat(historicVariableInstance.getScopeType()).isEqualTo(ScopeTypes.CMMN);</span>
<span class="nc" id="L295">            assertThat(historicVariableInstance.getValue()).isEqualTo(&quot;test&quot;);</span>
<span class="nc" id="L296">            assertThat(historicVariableInstance.getSubScopeId()).isNull();</span>
        }

<span class="nc" id="L299">        assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;intVar&quot;)).isEqualTo(123);</span>
        
<span class="nc" id="L301">        variableInstance = cmmnRuntimeService.createVariableInstanceQuery().variableName(&quot;intVar&quot;)</span>
<span class="nc" id="L302">                .singleResult();</span>
<span class="nc" id="L303">        assertThat(variableInstance.getScopeId()).isEqualTo(caseInstance.getId());</span>
<span class="nc" id="L304">        assertThat(variableInstance.getScopeType()).isEqualTo(ScopeTypes.CMMN);</span>
<span class="nc" id="L305">        assertThat(variableInstance.getValue()).isEqualTo(123);</span>
<span class="nc" id="L306">        assertThat(variableInstance.getSubScopeId()).isNull();</span>

<span class="nc bnc" id="L308" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L309">            HistoricVariableInstance historicVariableInstance = cmmnHistoryService.createHistoricVariableInstanceQuery().variableName(&quot;intVar&quot;).singleResult();</span>
<span class="nc" id="L310">            assertThat(historicVariableInstance.getScopeId()).isEqualTo(caseInstance.getId());</span>
<span class="nc" id="L311">            assertThat(historicVariableInstance.getScopeType()).isEqualTo(ScopeTypes.CMMN);</span>
<span class="nc" id="L312">            assertThat(historicVariableInstance.getValue()).isEqualTo(123);</span>
<span class="nc" id="L313">            assertThat(historicVariableInstance.getSubScopeId()).isNull();</span>
        }

<span class="nc" id="L316">        assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;doubleVar&quot;)).isEqualTo(123.123);</span>
        
<span class="nc" id="L318">        variableInstance = cmmnRuntimeService.createVariableInstanceQuery().variableName(&quot;doubleVar&quot;)</span>
<span class="nc" id="L319">                .singleResult();</span>
<span class="nc" id="L320">        assertThat(variableInstance.getScopeId()).isEqualTo(caseInstance.getId());</span>
<span class="nc" id="L321">        assertThat(variableInstance.getScopeType()).isEqualTo(ScopeTypes.CMMN);</span>
<span class="nc" id="L322">        assertThat(variableInstance.getValue()).isEqualTo(123.123);</span>
<span class="nc" id="L323">        assertThat(variableInstance.getSubScopeId()).isNull();</span>

<span class="nc bnc" id="L325" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L326">            HistoricVariableInstance historicVariableInstance = cmmnHistoryService.createHistoricVariableInstanceQuery().variableName(&quot;doubleVar&quot;).singleResult();</span>
<span class="nc" id="L327">            assertThat(historicVariableInstance.getScopeId()).isEqualTo(caseInstance.getId());</span>
<span class="nc" id="L328">            assertThat(historicVariableInstance.getScopeType()).isEqualTo(ScopeTypes.CMMN);</span>
<span class="nc" id="L329">            assertThat(historicVariableInstance.getValue()).isEqualTo(123.123);</span>
<span class="nc" id="L330">            assertThat(historicVariableInstance.getSubScopeId()).isNull();</span>
        }

        // Update variables
<span class="nc" id="L334">        Map&lt;String, Object&gt; newVariables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L335">        newVariables.put(&quot;stringVar&quot;, &quot;newValue&quot;);</span>
<span class="nc" id="L336">        newVariables.put(&quot;otherStringVar&quot;, &quot;test number 2&quot;);</span>
<span class="nc" id="L337">        cmmnRuntimeService.setVariables(caseInstance.getId(), newVariables);</span>

<span class="nc" id="L339">        assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;stringVar&quot;)).isEqualTo(&quot;newValue&quot;);</span>
        
<span class="nc" id="L341">        assertThat(cmmnRuntimeService.createVariableInstanceQuery().variableName(&quot;stringVar&quot;).singleResult().getValue()).isEqualTo(&quot;newValue&quot;);</span>
<span class="nc" id="L342">        assertThat(cmmnRuntimeService.createVariableInstanceQuery().variableName(&quot;otherStringVar&quot;).singleResult().getValue())</span>
<span class="nc" id="L343">            .isEqualTo(&quot;test number 2&quot;);</span>

<span class="nc bnc" id="L345" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L346">            assertThat(cmmnHistoryService.createHistoricVariableInstanceQuery().variableName(&quot;stringVar&quot;).singleResult().getValue()).isEqualTo(&quot;newValue&quot;);</span>
<span class="nc" id="L347">            assertThat(cmmnHistoryService.createHistoricVariableInstanceQuery().variableName(&quot;otherStringVar&quot;).singleResult().getValue())</span>
<span class="nc" id="L348">                .isEqualTo(&quot;test number 2&quot;);</span>
        }

        // Delete variables
<span class="nc" id="L352">        cmmnRuntimeService.removeVariable(caseInstance.getId(), &quot;stringVar&quot;);</span>
<span class="nc" id="L353">        assertThat(cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;stringVar&quot;)).isNull();</span>

<span class="nc bnc" id="L355" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L356">            assertThat(cmmnHistoryService.createHistoricVariableInstanceQuery().variableName(&quot;stringVar&quot;).singleResult()).isNull();</span>
<span class="nc" id="L357">            assertThat(cmmnHistoryService.createHistoricVariableInstanceQuery().variableName(&quot;otherStringVar&quot;).singleResult()).isNotNull();</span>
        }
<span class="nc" id="L359">    }</span>

    @Test
    @CmmnDeployment
    public void testTransientVariables() {
<span class="nc" id="L364">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L365">        variables.put(&quot;transientStartVar&quot;, &quot;Hello from test&quot;);</span>
<span class="nc" id="L366">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L367">                .caseDefinitionKey(&quot;myCase&quot;).transientVariables(variables).start();</span>


<span class="nc bnc" id="L370" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L371">            HistoricMilestoneInstance historicMilestoneInstance = cmmnHistoryService.createHistoricMilestoneInstanceQuery()</span>
<span class="nc" id="L372">                .milestoneInstanceCaseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L373">            assertThat(historicMilestoneInstance.getName()).isEqualTo(&quot;Milestone Hello from test and delegate&quot;);</span>

<span class="nc" id="L375">            assertThat(cmmnHistoryService.createHistoricVariableInstanceQuery().caseInstanceId(caseInstance.getId()).count()).isZero();</span>
        }

        // Variables should not be persisted
<span class="nc" id="L379">        assertThat(cmmnRuntimeService.getVariables(caseInstance.getId())).isEmpty();</span>
<span class="nc" id="L380">    }</span>

    @Test
    @CmmnDeployment
    public void testBlockingExpressionBasedOnVariable() {
        // Blocking
<span class="nc" id="L386">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L387">                .caseDefinitionKey(&quot;testBlockingExpression&quot;)</span>
<span class="nc" id="L388">                .variable(&quot;nameVar&quot;, &quot;First Task&quot;)</span>
<span class="nc" id="L389">                .variable(&quot;blockB&quot;, true)</span>
<span class="nc" id="L390">                .start();</span>

<span class="nc" id="L392">        List&lt;PlanItemInstance&gt; planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L393">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L394">                .planItemInstanceStateActive()</span>
<span class="nc" id="L395">                .orderByName().asc()</span>
<span class="nc" id="L396">                .list();</span>
<span class="nc" id="L397">        assertThat(planItemInstances).hasSize(2);</span>
<span class="nc" id="L398">        assertThat(planItemInstances.get(0).getName()).isEqualTo(&quot;B&quot;);</span>
<span class="nc" id="L399">        assertThat(planItemInstances.get(1).getName()).isEqualTo(&quot;First Task&quot;);</span>

        // Non-blocking
<span class="nc" id="L402">        caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L403">                .caseDefinitionKey(&quot;testBlockingExpression&quot;)</span>
<span class="nc" id="L404">                .variable(&quot;nameVar&quot;, &quot;Second Task&quot;)</span>
<span class="nc" id="L405">                .variable(&quot;blockB&quot;, false)</span>
<span class="nc" id="L406">                .start();</span>

<span class="nc" id="L408">        planItemInstances = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L409">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L410">                .planItemInstanceStateActive()</span>
<span class="nc" id="L411">                .list();</span>
<span class="nc" id="L412">        assertThat(planItemInstances)</span>
<span class="nc" id="L413">                .extracting(PlanItemInstance::getName)</span>
<span class="nc" id="L414">                .containsExactly(&quot;Second Task&quot;);</span>
<span class="nc" id="L415">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/task/CmmnTaskServiceTest.testOneHumanTaskCase.cmmn&quot;)
    public void testSetVariableOnRootCase() {
<span class="nc" id="L420">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L421">                .variable(&quot;varToUpdate&quot;, &quot;initialValue&quot;)</span>
<span class="nc" id="L422">                .caseDefinitionKey(&quot;oneHumanTaskCase&quot;)</span>
<span class="nc" id="L423">                .start();</span>

<span class="nc" id="L425">        cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;varToUpdate&quot;, &quot;newValue&quot;);</span>

<span class="nc" id="L427">        CaseInstance updatedCaseInstance = cmmnRuntimeService.createCaseInstanceQuery().</span>
<span class="nc" id="L428">                caseInstanceId(caseInstance.getId()).</span>
<span class="nc" id="L429">                includeCaseVariables().</span>
<span class="nc" id="L430">                singleResult();</span>
<span class="nc" id="L431">        assertThat(updatedCaseInstance.getCaseVariables()).containsEntry(&quot;varToUpdate&quot;, &quot;newValue&quot;);</span>
<span class="nc" id="L432">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/task/CmmnTaskServiceTest.testOneHumanTaskCase.cmmn&quot;)
    public void testSetVariableOnNonExistingCase() {
<span class="nc" id="L437">        assertThatThrownBy(() -&gt; cmmnRuntimeService.setVariable(&quot;NON-EXISTING-CASE&quot;, &quot;varToUpdate&quot;, &quot;newValue&quot;))</span>
<span class="nc" id="L438">                .isInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L439">                .hasMessage(&quot;No case instance found for id NON-EXISTING-CASE&quot;);</span>
<span class="nc" id="L440">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/task/CmmnTaskServiceTest.testOneHumanTaskCase.cmmn&quot;)
    public void testSetVariableWithoutName() {
<span class="nc" id="L445">        assertThatThrownBy(() -&gt; cmmnRuntimeService.setVariable(&quot;NON-EXISTING-CASE&quot;, null, &quot;newValue&quot;))</span>
<span class="nc" id="L446">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L447">                .hasMessage(&quot;variable name is null&quot;);</span>
<span class="nc" id="L448">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/task/CmmnTaskServiceTest.testOneHumanTaskCase.cmmn&quot;)
    public void testSetVariableOnRootCaseWithExpression() {
<span class="nc" id="L453">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L454">                .variable(&quot;varToUpdate&quot;, &quot;initialValue&quot;)</span>
<span class="nc" id="L455">                .caseDefinitionKey(&quot;oneHumanTaskCase&quot;)</span>
<span class="nc" id="L456">                .start();</span>

<span class="nc" id="L458">        cmmnRuntimeService.setVariable(caseInstance.getId(), &quot;${varToUpdate}&quot;, &quot;newValue&quot;);</span>

<span class="nc" id="L460">        CaseInstance updatedCaseInstance = cmmnRuntimeService.createCaseInstanceQuery().</span>
<span class="nc" id="L461">                caseInstanceId(caseInstance.getId()).</span>
<span class="nc" id="L462">                includeCaseVariables().</span>
<span class="nc" id="L463">                singleResult();</span>
<span class="nc" id="L464">        assertThat(updatedCaseInstance.getCaseVariables())</span>
<span class="nc" id="L465">                .as(&quot;resolving variable name expressions does not make sense when it is set locally&quot;)</span>
<span class="nc" id="L466">                .containsEntry(&quot;varToUpdate&quot;, &quot;newValue&quot;);</span>
<span class="nc" id="L467">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/task/CmmnTaskServiceTest.testOneHumanTaskCase.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/VariablesTest.rootProcess.cmmn&quot;
    })
    public void testSetVariableOnSubCase() {
<span class="nc" id="L475">        cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L476">                .caseDefinitionKey(&quot;rootCase&quot;)</span>
<span class="nc" id="L477">                .start();</span>
<span class="nc" id="L478">        CaseInstance subCaseInstance = cmmnRuntimeService.createCaseInstanceQuery().caseDefinitionKey(&quot;oneHumanTaskCase&quot;).singleResult();</span>

<span class="nc" id="L480">        cmmnRuntimeService.setVariable(subCaseInstance.getId(), &quot;varToUpdate&quot;, &quot;newValue&quot;);</span>

<span class="nc" id="L482">        CaseInstance updatedCaseInstance = cmmnRuntimeService.createCaseInstanceQuery().</span>
<span class="nc" id="L483">                caseInstanceId(subCaseInstance.getId()).</span>
<span class="nc" id="L484">                includeCaseVariables().</span>
<span class="nc" id="L485">                singleResult();</span>
<span class="nc" id="L486">        assertThat(updatedCaseInstance.getCaseVariables()).containsEntry(&quot;varToUpdate&quot;, &quot;newValue&quot;);</span>
<span class="nc" id="L487">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/task/CmmnTaskServiceTest.testOneHumanTaskCase.cmmn&quot;)
    public void testSetVariablesOnRootCase() {
<span class="nc" id="L492">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L493">                .variable(&quot;varToUpdate&quot;, &quot;initialValue&quot;)</span>
<span class="nc" id="L494">                .caseDefinitionKey(&quot;oneHumanTaskCase&quot;)</span>
<span class="nc" id="L495">                .start();</span>
<span class="nc" id="L496">        Map&lt;String, Object&gt; variables = Stream.of(new ImmutablePair&lt;String, Object&gt;(&quot;varToUpdate&quot;, &quot;newValue&quot;)).collect(</span>
<span class="nc" id="L497">                toMap(Pair::getKey, Pair::getValue)</span>
        );
<span class="nc" id="L499">        cmmnRuntimeService.setVariables(caseInstance.getId(), variables);</span>

<span class="nc" id="L501">        CaseInstance updatedCaseInstance = cmmnRuntimeService.createCaseInstanceQuery().</span>
<span class="nc" id="L502">                caseInstanceId(caseInstance.getId()).</span>
<span class="nc" id="L503">                includeCaseVariables().</span>
<span class="nc" id="L504">                singleResult();</span>
<span class="nc" id="L505">        assertThat(updatedCaseInstance.getCaseVariables()).isEqualTo(variables);</span>
<span class="nc" id="L506">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/task/CmmnTaskServiceTest.testOneHumanTaskCase.cmmn&quot;)
    public void testSetVariablesOnNonExistingCase() {
<span class="nc" id="L511">        Map&lt;String, Object&gt; variables = Stream.of(new ImmutablePair&lt;String, Object&gt;(&quot;varToUpdate&quot;, &quot;newValue&quot;)).collect(</span>
<span class="nc" id="L512">                toMap(Pair::getKey, Pair::getValue)</span>
        );

<span class="nc" id="L515">        assertThatThrownBy(() -&gt; cmmnRuntimeService.setVariables(&quot;NON-EXISTING-CASE&quot;, variables))</span>
<span class="nc" id="L516">                .isInstanceOf(FlowableObjectNotFoundException.class)</span>
<span class="nc" id="L517">                .hasMessage(&quot;No case instance found for id NON-EXISTING-CASE&quot;);</span>
<span class="nc" id="L518">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/task/CmmnTaskServiceTest.testOneHumanTaskCase.cmmn&quot;)
    public void testSetVariablesWithEmptyMap() {
<span class="nc" id="L524">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L525">                .variable(&quot;varToUpdate&quot;, &quot;initialValue&quot;)</span>
<span class="nc" id="L526">                .caseDefinitionKey(&quot;oneHumanTaskCase&quot;)</span>
<span class="nc" id="L527">                .start();</span>

<span class="nc" id="L529">        assertThatThrownBy(() -&gt; cmmnRuntimeService.setVariables(caseInstance.getId(), Collections.EMPTY_MAP))</span>
<span class="nc" id="L530">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L531">                .hasMessage(&quot;variables is empty&quot;);</span>
<span class="nc" id="L532">    }</span>

    @Test
    @CmmnDeployment(resources = {
            &quot;org/flowable/cmmn/test/task/CmmnTaskServiceTest.testOneHumanTaskCase.cmmn&quot;,
            &quot;org/flowable/cmmn/test/runtime/VariablesTest.rootProcess.cmmn&quot;
    })
    public void testSetVariablesOnSubCase() {
<span class="nc" id="L540">        cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L541">                .caseDefinitionKey(&quot;rootCase&quot;)</span>
<span class="nc" id="L542">                .start();</span>
<span class="nc" id="L543">        CaseInstance subCaseInstance = cmmnRuntimeService.createCaseInstanceQuery().caseDefinitionKey(&quot;oneHumanTaskCase&quot;).singleResult();</span>
<span class="nc" id="L544">        Map&lt;String, Object&gt; variables = CollectionUtil.singletonMap(&quot;varToUpdate&quot;, &quot;newValue&quot;);</span>
<span class="nc" id="L545">        cmmnRuntimeService.setVariables(subCaseInstance.getId(), variables);</span>

<span class="nc" id="L547">        CaseInstance updatedCaseInstance = cmmnRuntimeService.createCaseInstanceQuery().</span>
<span class="nc" id="L548">                caseInstanceId(subCaseInstance.getId()).</span>
<span class="nc" id="L549">                includeCaseVariables().</span>
<span class="nc" id="L550">                singleResult();</span>
<span class="nc" id="L551">        assertThat(updatedCaseInstance.getCaseVariables()).isEqualTo(variables);</span>
<span class="nc" id="L552">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/task/CmmnTaskServiceTest.testOneHumanTaskCase.cmmn&quot;)
    public void testIncludeVariablesWithSerializableVariable() {
<span class="nc" id="L557">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L558">                .caseDefinitionKey(&quot;oneHumanTaskCase&quot;)</span>
<span class="nc" id="L559">                .variable(&quot;myVar&quot;, new CustomTestVariable(&quot;test&quot;, 123))</span>
<span class="nc" id="L560">                .start();</span>

<span class="nc" id="L562">        CaseInstance caseInstanceWithVariables = cmmnRuntimeService.createCaseInstanceQuery()</span>
<span class="nc" id="L563">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L564">                .includeCaseVariables()</span>
<span class="nc" id="L565">                .singleResult();</span>

<span class="nc" id="L567">        CustomTestVariable customTestVariable = (CustomTestVariable) caseInstanceWithVariables.getCaseVariables().get(&quot;myVar&quot;);</span>
<span class="nc" id="L568">        assertThat(customTestVariable.someValue).isEqualTo(&quot;test&quot;);</span>
<span class="nc" id="L569">        assertThat(customTestVariable.someInt).isEqualTo(123);</span>
<span class="nc" id="L570">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/task/CmmnTaskServiceTest.testOneHumanTaskCase.cmmn&quot;)
    public void testAccessToScopeIdWhenSettingVariable() {
<span class="nc" id="L575">        addVariableTypeIfNotExists(CustomAccessCaseInstanceVariableType.INSTANCE);</span>

<span class="nc" id="L577">        CustomAccessCaseType customVar = new CustomAccessCaseType();</span>
<span class="nc" id="L578">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L579">                .caseDefinitionKey(&quot;oneHumanTaskCase&quot;)</span>
<span class="nc" id="L580">                .variable(&quot;customVar&quot;, customVar)</span>
<span class="nc" id="L581">                .start();</span>

<span class="nc" id="L583">        assertThat(customVar.getProcessInstanceId())</span>
<span class="nc" id="L584">                .as(&quot;custom var process instance id&quot;)</span>
<span class="nc" id="L585">                .isNull();</span>

<span class="nc" id="L587">        assertThat(customVar.getExecutionId())</span>
<span class="nc" id="L588">                .as(&quot;custom var execution id&quot;)</span>
<span class="nc" id="L589">                .isNull();</span>

<span class="nc" id="L591">        assertThat(customVar.getTaskId())</span>
<span class="nc" id="L592">                .as(&quot;custom var task id&quot;)</span>
<span class="nc" id="L593">                .isNull();</span>

<span class="nc" id="L595">        assertThat(customVar.getScopeId())</span>
<span class="nc" id="L596">                .as(&quot;custom var scope id&quot;)</span>
<span class="nc" id="L597">                .isEqualTo(caseInstance.getId());</span>

<span class="nc" id="L599">        assertThat(customVar.getSubScopeId())</span>
<span class="nc" id="L600">                .as(&quot;custom var sub scope id&quot;)</span>
<span class="nc" id="L601">                .isNull();</span>

<span class="nc" id="L603">        assertThat(customVar.getScopeType())</span>
<span class="nc" id="L604">                .as(&quot;custom var scope type&quot;)</span>
<span class="nc" id="L605">                .isEqualTo(ScopeTypes.CMMN);</span>

<span class="nc" id="L607">        customVar = (CustomAccessCaseType) cmmnRuntimeService.getVariable(caseInstance.getId(), &quot;customVar&quot;);</span>

<span class="nc" id="L609">        assertThat(customVar.getProcessInstanceId())</span>
<span class="nc" id="L610">                .as(&quot;custom var process instance id&quot;)</span>
<span class="nc" id="L611">                .isNull();</span>

<span class="nc" id="L613">        assertThat(customVar.getExecutionId())</span>
<span class="nc" id="L614">                .as(&quot;custom var execution id&quot;)</span>
<span class="nc" id="L615">                .isNull();</span>

<span class="nc" id="L617">        assertThat(customVar.getTaskId())</span>
<span class="nc" id="L618">                .as(&quot;custom var task id&quot;)</span>
<span class="nc" id="L619">                .isNull();</span>

<span class="nc" id="L621">        assertThat(customVar.getScopeId())</span>
<span class="nc" id="L622">                .as(&quot;custom var scope id&quot;)</span>
<span class="nc" id="L623">                .isEqualTo(caseInstance.getId());</span>

<span class="nc" id="L625">        assertThat(customVar.getSubScopeId())</span>
<span class="nc" id="L626">                .as(&quot;custom var sub scope id&quot;)</span>
<span class="nc" id="L627">                .isNull();</span>

<span class="nc" id="L629">        assertThat(customVar.getScopeType())</span>
<span class="nc" id="L630">                .as(&quot;custom var scope type&quot;)</span>
<span class="nc" id="L631">                .isEqualTo(ScopeTypes.CMMN);</span>
<span class="nc" id="L632">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/task/CmmnTaskServiceTest.testOneHumanTaskCase.cmmn&quot;)
    public void testAccessToTaskIdWhenSettingLocalVariableOnTask() {
<span class="nc" id="L637">        addVariableTypeIfNotExists(CustomAccessCaseInstanceVariableType.INSTANCE);</span>

<span class="nc" id="L639">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L640">                .caseDefinitionKey(&quot;oneHumanTaskCase&quot;)</span>
<span class="nc" id="L641">                .start();</span>

<span class="nc" id="L643">        Task task = cmmnTaskService.createTaskQuery()</span>
<span class="nc" id="L644">                .caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L645">                .singleResult();</span>

<span class="nc" id="L647">        assertThat(task).isNotNull();</span>

<span class="nc" id="L649">        CustomAccessCaseType customVar = new CustomAccessCaseType();</span>
<span class="nc" id="L650">        cmmnTaskService.setVariableLocal(task.getId(), &quot;customTaskVar&quot;, customVar);</span>

<span class="nc" id="L652">        assertThat(customVar.getProcessInstanceId())</span>
<span class="nc" id="L653">                .as(&quot;custom var process instance id&quot;)</span>
<span class="nc" id="L654">                .isNull();</span>

<span class="nc" id="L656">        assertThat(customVar.getExecutionId())</span>
<span class="nc" id="L657">                .as(&quot;custom var execution id&quot;)</span>
<span class="nc" id="L658">                .isNull();</span>

<span class="nc" id="L660">        assertThat(customVar.getTaskId())</span>
<span class="nc" id="L661">                .as(&quot;custom var task id&quot;)</span>
<span class="nc" id="L662">                .isEqualTo(task.getId());</span>

<span class="nc" id="L664">        assertThat(customVar.getScopeId())</span>
<span class="nc" id="L665">                .as(&quot;custom var scope id&quot;)</span>
<span class="nc" id="L666">                .isEqualTo(caseInstance.getId());</span>

<span class="nc" id="L668">        assertThat(customVar.getSubScopeId())</span>
<span class="nc" id="L669">                .as(&quot;custom var sub scope id&quot;)</span>
<span class="nc" id="L670">                .isEqualTo(task.getSubScopeId());</span>

<span class="nc" id="L672">        assertThat(customVar.getScopeType())</span>
<span class="nc" id="L673">                .as(&quot;custom var scope type&quot;)</span>
<span class="nc" id="L674">                .isEqualTo(ScopeTypes.CMMN);</span>

<span class="nc" id="L676">        customVar = (CustomAccessCaseType) cmmnTaskService.getVariableLocal(task.getId(), &quot;customTaskVar&quot;);</span>

<span class="nc" id="L678">        assertThat(customVar.getProcessInstanceId())</span>
<span class="nc" id="L679">                .as(&quot;custom var process instance id&quot;)</span>
<span class="nc" id="L680">                .isNull();</span>

<span class="nc" id="L682">        assertThat(customVar.getExecutionId())</span>
<span class="nc" id="L683">                .as(&quot;custom var execution id&quot;)</span>
<span class="nc" id="L684">                .isNull();</span>

<span class="nc" id="L686">        assertThat(customVar.getTaskId())</span>
<span class="nc" id="L687">                .as(&quot;custom var task id&quot;)</span>
<span class="nc" id="L688">                .isEqualTo(task.getId());</span>

<span class="nc" id="L690">        assertThat(customVar.getScopeId())</span>
<span class="nc" id="L691">                .as(&quot;custom var scope id&quot;)</span>
<span class="nc" id="L692">                .isEqualTo(caseInstance.getId());</span>

<span class="nc" id="L694">        assertThat(customVar.getSubScopeId())</span>
<span class="nc" id="L695">                .as(&quot;custom var sub scope id&quot;)</span>
<span class="nc" id="L696">                .isEqualTo(task.getSubScopeId());</span>

<span class="nc" id="L698">        assertThat(customVar.getScopeType())</span>
<span class="nc" id="L699">                .as(&quot;custom var scope type&quot;)</span>
<span class="nc" id="L700">                .isEqualTo(ScopeTypes.CMMN);</span>
<span class="nc" id="L701">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/task/CmmnTaskServiceTest.testOneHumanTaskCase.cmmn&quot;)
    public void testAccessToSubScopeIdWhenSettingLocalVariableOnExecution() {
<span class="nc" id="L706">        addVariableTypeIfNotExists(CustomAccessCaseInstanceVariableType.INSTANCE);</span>

<span class="nc" id="L708">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L709">                .caseDefinitionKey(&quot;oneHumanTaskCase&quot;)</span>
<span class="nc" id="L710">                .start();</span>

<span class="nc" id="L712">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery()</span>
<span class="nc" id="L713">                .planItemDefinitionId(&quot;theTask&quot;)</span>
<span class="nc" id="L714">                .singleResult();</span>

<span class="nc" id="L716">        assertThat(planItemInstance).isNotNull();</span>

<span class="nc" id="L718">        CustomAccessCaseType customVar = new CustomAccessCaseType();</span>
<span class="nc" id="L719">        cmmnRuntimeService.setLocalVariable(planItemInstance.getId(), &quot;customPlanItemVar&quot;, customVar);</span>

<span class="nc" id="L721">        assertThat(customVar.getProcessInstanceId())</span>
<span class="nc" id="L722">                .as(&quot;custom var process instance id&quot;)</span>
<span class="nc" id="L723">                .isNull();</span>

<span class="nc" id="L725">        assertThat(customVar.getExecutionId())</span>
<span class="nc" id="L726">                .as(&quot;custom var execution id&quot;)</span>
<span class="nc" id="L727">                .isNull();</span>

<span class="nc" id="L729">        assertThat(customVar.getTaskId())</span>
<span class="nc" id="L730">                .as(&quot;custom var task id&quot;)</span>
<span class="nc" id="L731">                .isNull();</span>

<span class="nc" id="L733">        assertThat(customVar.getScopeId())</span>
<span class="nc" id="L734">                .as(&quot;custom var scope id&quot;)</span>
<span class="nc" id="L735">                .isEqualTo(caseInstance.getId());</span>

<span class="nc" id="L737">        assertThat(customVar.getSubScopeId())</span>
<span class="nc" id="L738">                .as(&quot;custom var sub scope id&quot;)</span>
<span class="nc" id="L739">                .isEqualTo(planItemInstance.getId());</span>

<span class="nc" id="L741">        assertThat(customVar.getScopeType())</span>
<span class="nc" id="L742">                .as(&quot;custom var scope type&quot;)</span>
<span class="nc" id="L743">                .isEqualTo(ScopeTypes.CMMN);</span>

<span class="nc" id="L745">        customVar = (CustomAccessCaseType) cmmnRuntimeService.getLocalVariable(planItemInstance.getId(), &quot;customPlanItemVar&quot;);</span>

<span class="nc" id="L747">        assertThat(customVar.getProcessInstanceId())</span>
<span class="nc" id="L748">                .as(&quot;custom var process instance id&quot;)</span>
<span class="nc" id="L749">                .isNull();</span>

<span class="nc" id="L751">        assertThat(customVar.getExecutionId())</span>
<span class="nc" id="L752">                .as(&quot;custom var execution id&quot;)</span>
<span class="nc" id="L753">                .isNull();</span>

<span class="nc" id="L755">        assertThat(customVar.getTaskId())</span>
<span class="nc" id="L756">                .as(&quot;custom var task id&quot;)</span>
<span class="nc" id="L757">                .isNull();</span>

<span class="nc" id="L759">        assertThat(customVar.getScopeId())</span>
<span class="nc" id="L760">                .as(&quot;custom var scope id&quot;)</span>
<span class="nc" id="L761">                .isEqualTo(caseInstance.getId());</span>

<span class="nc" id="L763">        assertThat(customVar.getSubScopeId())</span>
<span class="nc" id="L764">                .as(&quot;custom var sub scope id&quot;)</span>
<span class="nc" id="L765">                .isEqualTo(planItemInstance.getId());</span>

<span class="nc" id="L767">        assertThat(customVar.getScopeType())</span>
<span class="nc" id="L768">                .as(&quot;custom var scope type&quot;)</span>
<span class="nc" id="L769">                .isEqualTo(ScopeTypes.CMMN);</span>
<span class="nc" id="L770">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/task/CmmnTaskServiceTest.testOneHumanTaskCase.cmmn&quot;)
    public void testImmutableEmptyCollectionVariable() {
<span class="nc" id="L775">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L776">                .caseDefinitionKey(&quot;oneHumanTaskCase&quot;)</span>
<span class="nc" id="L777">                .variable(&quot;listVar&quot;, Collections.emptyList())</span>
<span class="nc" id="L778">                .variable(&quot;setVar&quot;, Collections.emptySet())</span>
<span class="nc" id="L779">                .start();</span>

<span class="nc" id="L781">        VariableInstance variableInstance = cmmnRuntimeService.getVariableInstance(caseInstance.getId(), &quot;listVar&quot;);</span>

<span class="nc" id="L783">        assertThat(variableInstance.getTypeName()).isEqualTo(&quot;emptyCollection&quot;);</span>
<span class="nc" id="L784">        assertThat(variableInstance.getValue()).asList().isEmpty();</span>

<span class="nc" id="L786">        variableInstance = cmmnRuntimeService   .getVariableInstance(caseInstance.getId(), &quot;setVar&quot;);</span>

<span class="nc" id="L788">        assertThat(variableInstance.getTypeName()).isEqualTo(&quot;emptyCollection&quot;);</span>
<span class="nc" id="L789">        assertThat(variableInstance.getValue())</span>
<span class="nc" id="L790">                .isInstanceOfSatisfying(Set.class, set -&gt; assertThat(set).isEmpty());</span>
<span class="nc" id="L791">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/task/CmmnTaskServiceTest.testOneHumanTaskCase.cmmn&quot;)
    public void testEmptyCollectionVariable() {
<span class="nc" id="L796">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L797">                .caseDefinitionKey(&quot;oneHumanTaskCase&quot;)</span>
<span class="nc" id="L798">                .variable(&quot;listVar&quot;, new ArrayList&lt;&gt;())</span>
<span class="nc" id="L799">                .variable(&quot;setVar&quot;, new HashSet&lt;&gt;())</span>
<span class="nc" id="L800">                .start();</span>

<span class="nc" id="L802">        VariableInstance variableInstance = cmmnRuntimeService.getVariableInstance(caseInstance.getId(), &quot;listVar&quot;);</span>

<span class="nc" id="L804">        assertThat(variableInstance.getTypeName()).isEqualTo(&quot;serializable&quot;);</span>
<span class="nc" id="L805">        assertThat(variableInstance.getValue()).asList().isEmpty();</span>

<span class="nc" id="L807">        variableInstance = cmmnRuntimeService   .getVariableInstance(caseInstance.getId(), &quot;setVar&quot;);</span>

<span class="nc" id="L809">        assertThat(variableInstance.getTypeName()).isEqualTo(&quot;serializable&quot;);</span>
<span class="nc" id="L810">        assertThat(variableInstance.getValue())</span>
<span class="nc" id="L811">                .isInstanceOfSatisfying(Set.class, set -&gt; assertThat(set).isEmpty());</span>
<span class="nc" id="L812">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/task/CmmnTaskServiceTest.testOneHumanTaskCase.cmmn&quot;)
    public void testVariableInstanceQueryExcludeLocalVariables() {
<span class="nc" id="L817">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder()</span>
<span class="nc" id="L818">                .caseDefinitionKey(&quot;oneHumanTaskCase&quot;)</span>
<span class="nc" id="L819">                .variable(&quot;myVar&quot;, &quot;test1&quot;)</span>
<span class="nc" id="L820">                .start();</span>

<span class="nc" id="L822">        PlanItemInstance planItemInstance = cmmnRuntimeService.createPlanItemInstanceQuery().planItemDefinitionId(&quot;theTask&quot;)</span>
<span class="nc" id="L823">                .caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L824">        cmmnRuntimeService.setLocalVariable(planItemInstance.getId(), &quot;myLocalVar&quot;, &quot;test2&quot;);</span>

<span class="nc" id="L826">        Task task = cmmnTaskService.createTaskQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L827">        cmmnTaskService.setVariableLocal(task.getId(),&quot;localTaskVariable&quot;,&quot;localTaskVarValue&quot;);</span>
<span class="nc" id="L828">        List&lt;VariableInstance&gt; vars = cmmnRuntimeService.createVariableInstanceQuery().planItemInstanceId(planItemInstance.getId()).list();</span>

<span class="nc" id="L830">        assertThat(vars.size()).isEqualTo(2);</span>
<span class="nc" id="L831">        assertThat(vars).extracting(VariableInstance::getValue).containsExactlyInAnyOrder(&quot;test2&quot;,&quot;localTaskVarValue&quot;);</span>

<span class="nc" id="L833">        vars = cmmnRuntimeService.createVariableInstanceQuery().caseInstanceId(caseInstance.getId()).excludeLocalVariables().list();</span>

<span class="nc" id="L835">        assertThat(vars.size()).isEqualTo(1);</span>
<span class="nc" id="L836">        assertThat(vars).extracting(VariableInstance::getValue).containsExactlyInAnyOrder(&quot;test1&quot;);</span>

<span class="nc bnc" id="L838" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L839">            List&lt;HistoricVariableInstance&gt; historyVars = cmmnHistoryService.createHistoricVariableInstanceQuery().caseInstanceId(caseInstance.getId())</span>
<span class="nc" id="L840">                    .excludeLocalVariables().list();</span>

<span class="nc" id="L842">            assertThat(historyVars.size()).isEqualTo(1);</span>
<span class="nc" id="L843">            assertThat(historyVars).extracting(HistoricVariableInstance::getValue).containsExactlyInAnyOrder(&quot;test1&quot;);</span>
        }
<span class="nc" id="L845">    }</span>

    @Test
    @CmmnDeployment(resources = &quot;org/flowable/cmmn/test/task/CmmnTaskServiceTest.testOneHumanTaskCase.cmmn&quot;)
    public void testUpdateMetaInfo() {
<span class="nc" id="L850">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L851">        variables.put(&quot;myVariable&quot;, &quot;Hello World&quot;);</span>
<span class="nc" id="L852">        CaseInstance caseInstance = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;oneHumanTaskCase&quot;).variables(variables).start();</span>

<span class="nc" id="L854">        VariableInstance variableInstance = cmmnRuntimeService.createVariableInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L855">        assertThat(variableInstance.getMetaInfo()).isNull();</span>

<span class="nc" id="L857">        ((CmmnManagementServiceImpl) cmmnManagementService).executeCommand(commandContext -&gt; {</span>
<span class="nc" id="L858">            List&lt;VariableInstanceEntity&gt; variablesInstances = CommandContextUtil.getVariableService(commandContext)</span>
<span class="nc" id="L859">                    .findVariableInstanceByScopeIdAndScopeType(caseInstance.getId(), ScopeTypes.CMMN);</span>
<span class="nc" id="L860">            assertThat(variablesInstances).extracting(ValueFields::getName).containsExactly(&quot;myVariable&quot;);</span>

<span class="nc" id="L862">            VariableInstanceEntity variableInstanceEntity = variablesInstances.get(0);</span>
<span class="nc" id="L863">            variableInstanceEntity.setMetaInfo(&quot;test meta info&quot;);</span>
<span class="nc" id="L864">            VariableServiceConfiguration variableServiceConfiguration = cmmnEngineConfiguration.getVariableServiceConfiguration();</span>
<span class="nc" id="L865">            variableServiceConfiguration.getVariableInstanceEntityManager().update(variableInstanceEntity);</span>
<span class="nc bnc" id="L866" title="All 2 branches missed.">            if (variableServiceConfiguration.getInternalHistoryVariableManager() != null) {</span>
<span class="nc" id="L867">                variableServiceConfiguration.getInternalHistoryVariableManager()</span>
<span class="nc" id="L868">                        .recordVariableUpdate(variableInstanceEntity, commandContext.getClock().getCurrentTime());</span>
            }

<span class="nc" id="L871">            return null;</span>
        });

<span class="nc" id="L874">        variableInstance = cmmnRuntimeService.createVariableInstanceQuery().caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L875">        assertThat(variableInstance.getMetaInfo()).isEqualTo(&quot;test meta info&quot;);</span>

<span class="nc bnc" id="L877" title="All 2 branches missed.">        if (CmmnHistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, cmmnEngineConfiguration)) {</span>
<span class="nc" id="L878">            HistoricVariableInstance historicVariableInstance = cmmnHistoryService.createHistoricVariableInstanceQuery()</span>
<span class="nc" id="L879">                    .caseInstanceId(caseInstance.getId()).singleResult();</span>
<span class="nc" id="L880">            assertThat(historicVariableInstance.getMetaInfo()).isEqualTo(&quot;test meta info&quot;);</span>
        }

<span class="nc" id="L883">    }</span>

    @Test
    @CmmnDeployment
    public void testSettingGettingMultipleTimesInSameTransaction() {
<span class="nc" id="L888">        TestSetGetVariablesDelegate.REMOVE_VARS_IN_LAST_ROUND = true;</span>
<span class="nc" id="L889">        CaseInstance caseInstance1 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testSettingGettingMultipleTimesInSameTransaction&quot;).start();</span>
<span class="nc" id="L890">        assertThat(cmmnRuntimeService.getVariables(caseInstance1.getId())).isEmpty();</span>

<span class="nc" id="L892">        TestSetGetVariablesDelegate.REMOVE_VARS_IN_LAST_ROUND = false;</span>
<span class="nc" id="L893">        CaseInstance caseInstance2 = cmmnRuntimeService.createCaseInstanceBuilder().caseDefinitionKey(&quot;testSettingGettingMultipleTimesInSameTransaction&quot;).start();</span>
<span class="nc" id="L894">        Map&lt;String, Object&gt; variables = cmmnRuntimeService.getVariables(caseInstance2.getId());</span>
<span class="nc" id="L895">        assertThat(variables).hasSize(100);</span>
<span class="nc bnc" id="L896" title="All 2 branches missed.">        for (String variableName : variables.keySet()) {</span>
<span class="nc" id="L897">            assertThat(variables.get(variableName)).isNotNull();</span>
<span class="nc" id="L898">        }</span>
<span class="nc" id="L899">    }</span>

    protected void addVariableTypeIfNotExists(VariableType variableType) {
        // We can't remove the VariableType after every test since it would cause the test
        // to fail due to not being able to get the variable value during deleting
<span class="nc bnc" id="L904" title="All 2 branches missed.">        if (cmmnEngineConfiguration.getVariableTypes().getTypeIndex(variableType) == -1) {</span>
<span class="nc" id="L905">            cmmnEngineConfiguration.getVariableTypes().addType(variableType);</span>
        }
<span class="nc" id="L907">    }</span>

    // Test helper classes

<span class="nc" id="L911">    static class CustomAccessCaseType {</span>

        protected String processInstanceId;
        protected String executionId;
        protected String taskId;
        protected String scopeId;
        protected String subScopeId;
        protected String scopeType;

        public String getProcessInstanceId() {
<span class="nc" id="L921">            return processInstanceId;</span>
        }

        public void setProcessInstanceId(String processInstanceId) {
<span class="nc" id="L925">            this.processInstanceId = processInstanceId;</span>
<span class="nc" id="L926">        }</span>

        public String getExecutionId() {
<span class="nc" id="L929">            return executionId;</span>
        }

        public void setExecutionId(String executionId) {
<span class="nc" id="L933">            this.executionId = executionId;</span>
<span class="nc" id="L934">        }</span>

        public String getTaskId() {
<span class="nc" id="L937">            return taskId;</span>
        }

        public void setTaskId(String taskId) {
<span class="nc" id="L941">            this.taskId = taskId;</span>
<span class="nc" id="L942">        }</span>

        public String getScopeId() {
<span class="nc" id="L945">            return scopeId;</span>
        }

        public void setScopeId(String scopeId) {
<span class="nc" id="L949">            this.scopeId = scopeId;</span>
<span class="nc" id="L950">        }</span>

        public String getSubScopeId() {
<span class="nc" id="L953">            return subScopeId;</span>
        }

        public void setSubScopeId(String subScopeId) {
<span class="nc" id="L957">            this.subScopeId = subScopeId;</span>
<span class="nc" id="L958">        }</span>

        public String getScopeType() {
<span class="nc" id="L961">            return scopeType;</span>
        }

        public void setScopeType(String scopeType) {
<span class="nc" id="L965">            this.scopeType = scopeType;</span>
<span class="nc" id="L966">        }</span>
    }

<span class="nc" id="L969">    static class CustomAccessCaseInstanceVariableType implements VariableType {</span>

<span class="nc" id="L971">        static final CustomAccessCaseInstanceVariableType INSTANCE = new CustomAccessCaseInstanceVariableType();</span>

        @Override
        public String getTypeName() {
<span class="nc" id="L975">            return &quot;CustomAccessCaseInstanceVariableType&quot;;</span>
        }

        @Override
        public boolean isCachable() {
<span class="nc" id="L980">            return true;</span>
        }

        @Override
        public boolean isAbleToStore(Object value) {
<span class="nc" id="L985">            return value instanceof CustomAccessCaseType;</span>
        }

        @Override
        public void setValue(Object value, ValueFields valueFields) {
<span class="nc" id="L990">            CustomAccessCaseType customValue = (CustomAccessCaseType) value;</span>

<span class="nc" id="L992">            customValue.setProcessInstanceId(valueFields.getProcessInstanceId());</span>
<span class="nc" id="L993">            customValue.setExecutionId(valueFields.getExecutionId());</span>
<span class="nc" id="L994">            customValue.setTaskId(valueFields.getTaskId());</span>
<span class="nc" id="L995">            customValue.setScopeId(valueFields.getScopeId());</span>
<span class="nc" id="L996">            customValue.setSubScopeId(valueFields.getSubScopeId());</span>
<span class="nc" id="L997">            customValue.setScopeType(valueFields.getScopeType());</span>

<span class="nc" id="L999">            String textValue = new StringJoiner(&quot;,&quot;)</span>
<span class="nc" id="L1000">                    .add(customValue.getProcessInstanceId())</span>
<span class="nc" id="L1001">                    .add(customValue.getExecutionId())</span>
<span class="nc" id="L1002">                    .add(customValue.getTaskId())</span>
<span class="nc" id="L1003">                    .add(customValue.getScopeId())</span>
<span class="nc" id="L1004">                    .add(customValue.getSubScopeId())</span>
<span class="nc" id="L1005">                    .add(customValue.getScopeType())</span>
<span class="nc" id="L1006">                    .toString();</span>
<span class="nc" id="L1007">            valueFields.setTextValue(textValue);</span>
<span class="nc" id="L1008">        }</span>

        @Override
        public Object getValue(ValueFields valueFields) {
<span class="nc" id="L1012">            String textValue = valueFields.getTextValue();</span>
<span class="nc" id="L1013">            String[] values = textValue.split(&quot;,&quot;);</span>

<span class="nc" id="L1015">            CustomAccessCaseType customValue = new CustomAccessCaseType();</span>
<span class="nc" id="L1016">            customValue.setProcessInstanceId(valueAt(values, 0));</span>
<span class="nc" id="L1017">            customValue.setExecutionId(valueAt(values, 1));</span>
<span class="nc" id="L1018">            customValue.setTaskId(valueAt(values, 2));</span>
<span class="nc" id="L1019">            customValue.setScopeId(valueAt(values, 3));</span>
<span class="nc" id="L1020">            customValue.setSubScopeId(valueAt(values, 4));</span>
<span class="nc" id="L1021">            customValue.setScopeType(valueAt(values, 5));</span>

<span class="nc" id="L1023">            return customValue;</span>
        }

        protected String valueAt(String[] array, int index) {
<span class="nc bnc" id="L1027" title="All 2 branches missed.">            if (array.length &gt; index) {</span>
<span class="nc" id="L1028">                return getValue(array[index]);</span>
            }

<span class="nc" id="L1031">            return null;</span>
        }

        protected String getValue(String value) {
<span class="nc bnc" id="L1035" title="All 2 branches missed.">            return &quot;null&quot;.equals(value) ? null : value;</span>
        }
    }

    public static class MyVariable implements Serializable {

        private static final long serialVersionUID = 1L;

        private String value;

<span class="nc" id="L1045">        public MyVariable(String value) {</span>
<span class="nc" id="L1046">            this.value = value;</span>
<span class="nc" id="L1047">        }</span>

    }

<span class="nc" id="L1051">    public static class SetVariableDelegate implements PlanItemJavaDelegate {</span>

        @Override
        public void execute(DelegatePlanItemInstance planItemInstance) {
<span class="nc" id="L1055">            String variableValue = (String) planItemInstance.getVariable(&quot;myVariable&quot;);</span>
<span class="nc" id="L1056">            planItemInstance.setVariable(&quot;myVariable&quot;, variableValue + &quot; and delegate&quot;);</span>
<span class="nc" id="L1057">        }</span>

    }

<span class="nc" id="L1061">    public static class SetTransientVariableDelegate implements PlanItemJavaDelegate {</span>

        @Override
        public void execute(DelegatePlanItemInstance planItemInstance) {
<span class="nc" id="L1065">            String variableValue = (String) planItemInstance.getVariable(&quot;transientStartVar&quot;);</span>
<span class="nc" id="L1066">            planItemInstance.setTransientVariable(&quot;transientVar&quot;, variableValue + &quot; and delegate&quot;);</span>
<span class="nc" id="L1067">        }</span>

    }

    public static class CustomTestVariable implements Serializable {

        private String someValue;
        private int someInt;

<span class="nc" id="L1076">        public CustomTestVariable(String someValue, int someInt) {</span>
<span class="nc" id="L1077">            this.someValue = someValue;</span>
<span class="nc" id="L1078">            this.someInt = someInt;</span>
<span class="nc" id="L1079">        }</span>
    }

<span class="nc" id="L1082">    public static class TestSetGetVariablesDelegate implements PlanItemJavaDelegate {</span>

<span class="nc" id="L1084">        public static boolean REMOVE_VARS_IN_LAST_ROUND = true;</span>

        @Override
        public void execute(DelegatePlanItemInstance planItemInstance) {
<span class="nc" id="L1088">            String caseInstanceId = planItemInstance.getCaseInstanceId();</span>
<span class="nc" id="L1089">            CmmnRuntimeService cmmnRuntimeService = CommandContextUtil.getCmmnRuntimeService();</span>

<span class="nc" id="L1091">            int nrOfLoops = 100;</span>
<span class="nc bnc" id="L1092" title="All 2 branches missed.">            for (int nrOfRounds = 0; nrOfRounds &lt; 4; nrOfRounds++) {</span>

                // Set
<span class="nc bnc" id="L1095" title="All 2 branches missed.">                for (int i = 0; i &lt; nrOfLoops; i++) {</span>
<span class="nc" id="L1096">                    cmmnRuntimeService.setVariable(caseInstanceId, &quot;test_&quot; + i, i);</span>
                }

                // Get
<span class="nc bnc" id="L1100" title="All 2 branches missed.">                for (int i = 0; i &lt; nrOfLoops; i++) {</span>
<span class="nc bnc" id="L1101" title="All 2 branches missed.">                    if (cmmnRuntimeService.getVariable(caseInstanceId, &quot;test_&quot; + i) == null) {</span>
<span class="nc" id="L1102">                        throw new RuntimeException(&quot;This exception shouldn't happen&quot;);</span>
                    }
                }

                // Remove
<span class="nc bnc" id="L1107" title="All 4 branches missed.">                if (REMOVE_VARS_IN_LAST_ROUND &amp;&amp; nrOfRounds == 3) {</span>
<span class="nc bnc" id="L1108" title="All 2 branches missed.">                    for (int i = 0; i &lt; nrOfLoops; i++) {</span>
<span class="nc" id="L1109">                        cmmnRuntimeService.removeVariable(caseInstanceId, &quot;test_&quot; + i);</span>
                    }
                }

            }
<span class="nc" id="L1114">        }</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>