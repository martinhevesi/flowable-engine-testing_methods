<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ExecutionListenerTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.examples.bpmn.executionlistener</a> &gt; <span class="el_source">ExecutionListenerTest.java</span></div><h1>ExecutionListenerTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.examples.bpmn.executionlistener;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.assertj.core.api.Assertions.tuple;
import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;

import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.flowable.common.engine.api.FlowableIllegalArgumentException;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.engine.delegate.ExecutionListener;
import org.flowable.engine.history.HistoricProcessInstance;
import org.flowable.engine.impl.test.HistoryTestHelper;
import org.flowable.engine.impl.test.JobTestHelper;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.runtime.ProcessInstanceBuilder;
import org.flowable.engine.test.Deployment;
import org.flowable.eventsubscription.api.EventSubscription;
import org.flowable.examples.bpmn.executionlistener.CurrentActivityExecutionListener.CurrentActivity;
import org.flowable.examples.bpmn.executionlistener.RecorderExecutionListener.RecordedEvent;
import org.flowable.job.api.Job;
import org.flowable.task.api.Task;
import org.junit.jupiter.api.Test;

/**
 * @author Frederik Heremans
 * @author Filip Hrisafov
 */
<span class="nc" id="L47">public class ExecutionListenerTest extends PluggableFlowableTestCase {</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenersProcess.bpmn20.xml&quot; })
    public void testExecutionListenersOnAllPossibleElements() {
<span class="nc" id="L52">        RecorderExecutionListener.clear();</span>

        // Process start executionListener will have executionListener class
        // that sets 2 variables
<span class="nc" id="L56">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;executionListenersProcess&quot;, &quot;businessKey123&quot;);</span>

<span class="nc" id="L58">        String varSetInExecutionListener = (String) runtimeService.getVariable(processInstance.getId(), &quot;variableSetInExecutionListener&quot;);</span>
<span class="nc" id="L59">        assertThat(varSetInExecutionListener).isEqualTo(&quot;firstValue&quot;);</span>

        // Check if business key was available in execution listener
<span class="nc" id="L62">        String businessKey = (String) runtimeService.getVariable(processInstance.getId(), &quot;businessKeyInExecution&quot;);</span>
<span class="nc" id="L63">        assertThat(businessKey).isEqualTo(&quot;businessKey123&quot;);</span>

        // Transition take executionListener will set 2 variables
<span class="nc" id="L66">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L67">        assertThat(task).isNotNull();</span>
<span class="nc" id="L68">        taskService.complete(task.getId());</span>

<span class="nc" id="L70">        varSetInExecutionListener = (String) runtimeService.getVariable(processInstance.getId(), &quot;variableSetInExecutionListener&quot;);</span>

<span class="nc" id="L72">        assertThat(varSetInExecutionListener).isEqualTo(&quot;secondValue&quot;);</span>

<span class="nc" id="L74">        ExampleExecutionListenerPojo myPojo = new ExampleExecutionListenerPojo();</span>
<span class="nc" id="L75">        runtimeService.setVariable(processInstance.getId(), &quot;myPojo&quot;, myPojo);</span>

<span class="nc" id="L77">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L78">        assertThat(task).isNotNull();</span>
<span class="nc" id="L79">        taskService.complete(task.getId());</span>

        // First usertask uses a method-expression as executionListener:
        // ${myPojo.myMethod(execution.eventName)}
<span class="nc" id="L83">        ExampleExecutionListenerPojo pojoVariable = (ExampleExecutionListenerPojo) runtimeService.getVariable(processInstance.getId(), &quot;myPojo&quot;);</span>
<span class="nc" id="L84">        assertThat(pojoVariable.getReceivedEventName()).isEqualTo(&quot;end&quot;);</span>

<span class="nc" id="L86">        task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L87">        assertThat(task).isNotNull();</span>
<span class="nc" id="L88">        taskService.complete(task.getId());</span>

<span class="nc" id="L90">        assertProcessEnded(processInstance.getId());</span>

<span class="nc" id="L92">        List&lt;RecordedEvent&gt; events = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L93">        assertThat(events)</span>
<span class="nc" id="L94">                .extracting(RecordedEvent::getParameter)</span>
<span class="nc" id="L95">                .containsExactly(&quot;End Process Listener&quot;);</span>
<span class="nc" id="L96">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenersStartEndEvent.bpmn20.xml&quot; })
    public void testExecutionListenersOnStartEndEvents() {
<span class="nc" id="L101">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L103">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;executionListenersProcess&quot;);</span>
<span class="nc" id="L104">        assertProcessEnded(processInstance.getId());</span>

<span class="nc" id="L106">        List&lt;RecordedEvent&gt; recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L107">        assertThat(recordedEvents)</span>
<span class="nc" id="L108">                .extracting(RecordedEvent::getActivityId, RecordedEvent::getActivityName, RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L109">                .containsExactly(</span>
<span class="nc" id="L110">                        tuple(&quot;theStart&quot;, &quot;Start Event&quot;, &quot;Start Event Listener&quot;, &quot;end&quot;),</span>
<span class="nc" id="L111">                        tuple(&quot;noneEvent&quot;, &quot;None Event&quot;, &quot;Intermediate Catch Event Listener&quot;, &quot;end&quot;),</span>
<span class="nc" id="L112">                        tuple(&quot;signalEvent&quot;, &quot;Signal Event&quot;, &quot;Intermediate Throw Event Listener&quot;, &quot;start&quot;),</span>
<span class="nc" id="L113">                        tuple(&quot;theEnd&quot;, &quot;End Event&quot;, &quot;End Event Listener&quot;, &quot;start&quot;)</span>
                );
<span class="nc" id="L115">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenersMultiInstanceSequentialProcess.bpmn20.xml&quot; })
    public void testExecutionListenersOnSequentialMultiInstance() {
<span class="nc" id="L120">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L122">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L123">                .processDefinitionKey(&quot;executionListenersProcess&quot;)</span>
<span class="nc" id="L124">                .transientVariable(&quot;numberOfIterations&quot;, 2)</span>
<span class="nc" id="L125">                .start();</span>
<span class="nc" id="L126">        assertProcessEnded(processInstance.getId());</span>

<span class="nc" id="L128">        List&lt;RecordedEvent&gt; recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L129">        assertThat(recordedEvents)</span>
<span class="nc" id="L130">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L131">                .containsExactly(</span>
<span class="nc" id="L132">                        tuple(&quot;theTask&quot;, &quot;Start Multi Instance Root&quot;, &quot;start&quot;),</span>
<span class="nc" id="L133">                        tuple(&quot;theTask&quot;, &quot;Start 0&quot;, &quot;start&quot;),</span>
<span class="nc" id="L134">                        tuple(&quot;theTask&quot;, &quot;End 0&quot;, &quot;end&quot;),</span>
<span class="nc" id="L135">                        tuple(&quot;theTask&quot;, &quot;Start 1&quot;, &quot;start&quot;),</span>
<span class="nc" id="L136">                        tuple(&quot;theTask&quot;, &quot;End 1&quot;, &quot;end&quot;),</span>
<span class="nc" id="L137">                        tuple(&quot;theTask&quot;, &quot;End Multi Instance Root&quot;, &quot;end&quot;)</span>
                );
<span class="nc" id="L139">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenersMultiInstanceSequentialProcessAsync.bpmn20.xml&quot; })
    public void testExecutionListenersOnSequentialMultiInstanceAsync() {
<span class="nc" id="L144">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L146">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L147">                .processDefinitionKey(&quot;executionListenersProcess&quot;)</span>
<span class="nc" id="L148">                .variable(&quot;numberOfIterations&quot;, 2)</span>
<span class="nc" id="L149">                .start();</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">        for (int i = 0; i &lt; 2; i++) {</span>
<span class="nc" id="L151">            Job job = managementService.createJobQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L152">            managementService.executeJob(job.getId());</span>
        }
<span class="nc" id="L154">        assertProcessEnded(processInstance.getId());</span>

<span class="nc" id="L156">        List&lt;RecordedEvent&gt; recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L157">        assertThat(recordedEvents)</span>
<span class="nc" id="L158">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L159">                .containsExactly(</span>
<span class="nc" id="L160">                        tuple(&quot;theTask&quot;, &quot;Start Multi Instance Root&quot;, &quot;start&quot;),</span>
<span class="nc" id="L161">                        tuple(&quot;theTask&quot;, &quot;Start 0&quot;, &quot;start&quot;),</span>
<span class="nc" id="L162">                        tuple(&quot;theTask&quot;, &quot;End 0&quot;, &quot;end&quot;),</span>
<span class="nc" id="L163">                        tuple(&quot;theTask&quot;, &quot;Start 1&quot;, &quot;start&quot;),</span>
<span class="nc" id="L164">                        tuple(&quot;theTask&quot;, &quot;End 1&quot;, &quot;end&quot;),</span>
<span class="nc" id="L165">                        tuple(&quot;theTask&quot;, &quot;End Multi Instance Root&quot;, &quot;end&quot;)</span>
                );
<span class="nc" id="L167">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenersMultiInstanceParallelProcess.bpmn20.xml&quot; })
    public void testExecutionListenersOnParallelMultiInstance() {
<span class="nc" id="L172">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L174">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L175">                .processDefinitionKey(&quot;executionListenersProcess&quot;)</span>
<span class="nc" id="L176">                .transientVariable(&quot;numberOfIterations&quot;, 2)</span>
<span class="nc" id="L177">                .start();</span>
<span class="nc" id="L178">        assertProcessEnded(processInstance.getId());</span>

<span class="nc" id="L180">        List&lt;RecordedEvent&gt; recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L181">        assertThat(recordedEvents)</span>
<span class="nc" id="L182">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L183">                .containsExactly(</span>
<span class="nc" id="L184">                        tuple(&quot;theTask&quot;, &quot;Start Multi Instance Root&quot;, &quot;start&quot;),</span>
<span class="nc" id="L185">                        tuple(&quot;theTask&quot;, &quot;Start 0&quot;, &quot;start&quot;),</span>
<span class="nc" id="L186">                        tuple(&quot;theTask&quot;, &quot;End 0&quot;, &quot;end&quot;),</span>
<span class="nc" id="L187">                        tuple(&quot;theTask&quot;, &quot;Start 1&quot;, &quot;start&quot;),</span>
<span class="nc" id="L188">                        tuple(&quot;theTask&quot;, &quot;End 1&quot;, &quot;end&quot;),</span>
<span class="nc" id="L189">                        tuple(&quot;theTask&quot;, &quot;End Multi Instance Root&quot;, &quot;end&quot;)</span>
                );
<span class="nc" id="L191">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenersMultiInstanceParallelProcessAsync.bpmn20.xml&quot; })
    public void testExecutionListenersOnParallelMultiInstanceAsync() {
<span class="nc" id="L196">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L198">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L199">                .processDefinitionKey(&quot;executionListenersProcess&quot;)</span>
<span class="nc" id="L200">                .variable(&quot;numberOfIterations&quot;, 2)</span>
<span class="nc" id="L201">                .start();</span>
<span class="nc" id="L202">        List&lt;Job&gt; jobs = managementService.createJobQuery().processInstanceId(processInstance.getId()).list();</span>
<span class="nc" id="L203">        jobs.forEach(job -&gt; managementService.executeJob(job.getId()));</span>
<span class="nc" id="L204">        assertProcessEnded(processInstance.getId());</span>

<span class="nc" id="L206">        List&lt;RecordedEvent&gt; recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L207">        assertThat(recordedEvents)</span>
<span class="nc" id="L208">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L209">                .containsExactly(</span>
<span class="nc" id="L210">                        tuple(&quot;theTask&quot;, &quot;Start Multi Instance Root&quot;, &quot;start&quot;),</span>
<span class="nc" id="L211">                        tuple(&quot;theTask&quot;, &quot;Start 0&quot;, &quot;start&quot;),</span>
<span class="nc" id="L212">                        tuple(&quot;theTask&quot;, &quot;End 0&quot;, &quot;end&quot;),</span>
<span class="nc" id="L213">                        tuple(&quot;theTask&quot;, &quot;Start 1&quot;, &quot;start&quot;),</span>
<span class="nc" id="L214">                        tuple(&quot;theTask&quot;, &quot;End 1&quot;, &quot;end&quot;),</span>
<span class="nc" id="L215">                        tuple(&quot;theTask&quot;, &quot;End Multi Instance Root&quot;, &quot;end&quot;)</span>
                );
<span class="nc" id="L217">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenersFieldInjectionProcess.bpmn20.xml&quot; })
    public void testExecutionListenerFieldInjection() {
<span class="nc" id="L222">        Map&lt;String, Object&gt; variables = new HashMap&lt;&gt;();</span>
<span class="nc" id="L223">        variables.put(&quot;myVar&quot;, &quot;listening!&quot;);</span>

<span class="nc" id="L225">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;executionListenersProcess&quot;, variables);</span>

<span class="nc" id="L227">        Object varSetByListener = runtimeService.getVariable(processInstance.getId(), &quot;var&quot;);</span>
<span class="nc" id="L228">        assertThat(varSetByListener).isInstanceOf(String.class);</span>

        // Result is a concatenation of fixed injected field and injected expression
<span class="nc" id="L231">        assertThat(varSetByListener).isEqualTo(&quot;Yes, I am listening!&quot;);</span>
<span class="nc" id="L232">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenersCurrentActivity.bpmn20.xml&quot; })
    public void testExecutionListenerCurrentActivity() {

<span class="nc" id="L238">        CurrentActivityExecutionListener.clear();</span>

<span class="nc" id="L240">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;executionListenersProcess&quot;);</span>
<span class="nc" id="L241">        assertProcessEnded(processInstance.getId());</span>

<span class="nc" id="L243">        List&lt;CurrentActivity&gt; currentActivities = CurrentActivityExecutionListener.getCurrentActivities();</span>
<span class="nc" id="L244">        assertThat(currentActivities)</span>
<span class="nc" id="L245">                .extracting(CurrentActivity::getActivityId, CurrentActivity::getActivityName)</span>
<span class="nc" id="L246">                .containsExactly(</span>
<span class="nc" id="L247">                        tuple(&quot;theStart&quot;, &quot;Start Event&quot;),</span>
<span class="nc" id="L248">                        tuple(&quot;noneEvent&quot;, &quot;None Event&quot;),</span>
<span class="nc" id="L249">                        tuple(&quot;theEnd&quot;, &quot;End Event&quot;)</span>
                );
<span class="nc" id="L251">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenersForSubprocessStartEndEvent.bpmn20.xml&quot; })
    public void testExecutionListenersForSubprocessStartEndEvents() {
<span class="nc" id="L256">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L258">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;executionListenersProcess&quot;);</span>

<span class="nc" id="L260">        List&lt;RecordedEvent&gt; recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L261">        assertThat(recordedEvents)</span>
<span class="nc" id="L262">                .extracting(RecordedEvent::getParameter)</span>
<span class="nc" id="L263">                .containsExactly(&quot;Process Start&quot;);</span>

<span class="nc" id="L265">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L267">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L268">        taskService.complete(task.getId());</span>

<span class="nc" id="L270">        assertProcessEnded(processInstance.getId());</span>

<span class="nc" id="L272">        recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L273">        assertThat(recordedEvents)</span>
<span class="nc" id="L274">                .extracting(RecordedEvent::getParameter)</span>
<span class="nc" id="L275">                .containsExactly(&quot;Subprocess Start&quot;, &quot;Subprocess End&quot;, &quot;Process End&quot;);</span>
<span class="nc" id="L276">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenersProcess.bpmn20.xml&quot; })
    public void testExecutionListenersOnAsyncProcessStart() {
<span class="nc" id="L281">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L283">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;executionListenersProcess&quot;).</span>
<span class="nc" id="L284">            businessKey(&quot;businessKey123&quot;).startAsync();</span>
<span class="nc" id="L285">        String varSetInExecutionListener = (String) runtimeService.getVariable(processInstance.getId(), &quot;variableSetInExecutionListener&quot;);</span>
        // ProcessStartExecutionListeners are executed from the asynchronous job
<span class="nc" id="L287">        assertThat(varSetInExecutionListener).isNull();</span>

<span class="nc" id="L289">        JobTestHelper.waitForJobExecutorToProcessAllJobs(processEngineConfiguration, managementService, 2000, 200);</span>

        // Process start executionListener will have executionListener class
        // that sets 2 variables
<span class="nc" id="L293">        varSetInExecutionListener = (String) runtimeService.getVariable(processInstance.getId(), &quot;variableSetInExecutionListener&quot;);</span>
<span class="nc" id="L294">        assertThat(varSetInExecutionListener).isEqualTo(&quot;firstValue&quot;);</span>

        // Check if business key was available in execution listener
<span class="nc" id="L297">        String businessKey = (String) runtimeService.getVariable(processInstance.getId(), &quot;businessKeyInExecution&quot;);</span>
<span class="nc" id="L298">        assertThat(businessKey).isEqualTo(&quot;businessKey123&quot;);</span>

<span class="nc" id="L300">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenerDelegateExpressionThrowsException.bpmn20.xml&quot; })
    public void testExecutionListenerWithDelegateExpressionThrowsFlowableException() {
<span class="nc" id="L305">        ProcessInstanceBuilder builder = runtimeService</span>
<span class="nc" id="L306">                .createProcessInstanceBuilder()</span>
<span class="nc" id="L307">                .processDefinitionKey(&quot;executionListenersProcess&quot;)</span>
<span class="nc" id="L308">                .transientVariable(&quot;bean&quot;, (ExecutionListener) delegateExecution -&gt; {</span>
<span class="nc" id="L309">                    throw new FlowableIllegalArgumentException(&quot;Message from listener&quot;);</span>
                });
<span class="nc" id="L311">        assertThatThrownBy(builder::start)</span>
<span class="nc" id="L312">                .isInstanceOf(FlowableIllegalArgumentException.class)</span>
<span class="nc" id="L313">                .hasNoCause()</span>
<span class="nc" id="L314">                .hasMessage(&quot;Message from listener&quot;);</span>
<span class="nc" id="L315">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenerDelegateExpressionThrowsException.bpmn20.xml&quot; })
    public void testExecutionListenerWithDelegateExpressionThrowsNonFlowableException() {
<span class="nc" id="L320">        ProcessInstanceBuilder builder = runtimeService</span>
<span class="nc" id="L321">                .createProcessInstanceBuilder()</span>
<span class="nc" id="L322">                .processDefinitionKey(&quot;executionListenersProcess&quot;)</span>
<span class="nc" id="L323">                .transientVariable(&quot;bean&quot;, (ExecutionListener) delegateExecution -&gt; {</span>
<span class="nc" id="L324">                    throw new RuntimeException(&quot;Message from listener&quot;);</span>
                });
<span class="nc" id="L326">        assertThatThrownBy(builder::start)</span>
<span class="nc" id="L327">                .isExactlyInstanceOf(RuntimeException.class)</span>
<span class="nc" id="L328">                .hasNoCause()</span>
<span class="nc" id="L329">                .hasMessage(&quot;Message from listener&quot;);</span>
<span class="nc" id="L330">    }</span>

    /**
     * https://github.com/flowable/flowable-engine/issues/3327
     */
    @Test
    @Deployment(resources = { &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenerJavaDelegate.bpmn20.xml&quot; })
    public void testJavaDelegateAsExecutionListenerFollowsCorrectFlow() {
<span class="nc" id="L338">        ProcessInstance myFlow = runtimeService.startProcessInstanceByKey(&quot;MyFlow&quot;);</span>
<span class="nc" id="L339">        String myActions = runtimeService.getVariable(myFlow.getId(), &quot;myActions&quot;, String.class);</span>
<span class="nc" id="L340">        Task task = assertDoesNotThrow(() -&gt; taskService.createTaskQuery().singleResult(), &quot;Only one task 'Production Manager' must be returned.&quot;);</span>
<span class="nc" id="L341">        assertThat(task.getName()).isEqualTo(&quot;Production Manager&quot;);</span>
<span class="nc" id="L342">        assertThat(myActions).isEqualTo(&quot;Start executionListener,ProductionManager taskListener&quot;);</span>
<span class="nc" id="L343">    }</span>

    /**
     * We do not expect the boundary event to handle eventListener bpmn errors at all.
     * Only the parent scoped error event handlers are able to handle bpmn errors thrown from execution listeners.
     *
     * The reason is to be consistent with signals and timers.
     * The boundary event is not yet initialized at the time the execution listener gets invoked.
     *
     * This test validates this behavior for the 'start' executionListener.
     */
    @Test
    @Deployment(resources = &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenerTest.testThrowAndCatchBpmnErrorInSubProcess.bpmn20.xml&quot;)
    public void testThrowBpmnErrorFromListenerIsHandledByErrorHandlingSubProcessNotByBoundaryEventStart() {
<span class="nc" id="L357">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L358">        vars.put(&quot;throwErrorCodeStartListener&quot;, &quot;EXECUTION_LISTENER_BPMN_ERROR&quot;);</span>
<span class="nc" id="L359">        vars.put(&quot;eventType&quot;, &quot;start&quot;);</span>
<span class="nc" id="L360">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;errorHandlingProcess&quot;, vars);</span>

<span class="nc" id="L362">        assertThat(processInstance.getProcessVariables())</span>
<span class="nc" id="L363">                .containsEntry(&quot;error_handled_sub_process&quot;, &quot;true&quot;)</span>
<span class="nc" id="L364">                .doesNotContainKey(&quot;_script_task&quot;)</span>
<span class="nc" id="L365">                .doesNotContainKey(&quot;error_handled_boundary_event&quot;);</span>
<span class="nc" id="L366">    }</span>

    /**
     * We do not expect the boundary event to handle eventListener bpmn errors at all.
     * Only the parent scoped error event handlers are able to handle bpmn errors thrown from execution listeners.
     *
     * The reason is to be consistent with signals and timers.
     * The boundary events lifecycle is bound to the task execution and gets cleaned up
     *
     * This test validates this behavior for the 'end' executionListener
     */
    @Test
    @Deployment(resources = &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenerTest.testThrowAndCatchBpmnErrorInSubProcess.bpmn20.xml&quot;)
    public void testThrowBpmnErrorFromListenerIsHandledByErrorHandlingSubProcessNotByBoundaryEventEnd() {
<span class="nc" id="L380">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L381">        vars.put(&quot;throwErrorCodeEndListener&quot;, &quot;EXECUTION_LISTENER_BPMN_ERROR&quot;);</span>
<span class="nc" id="L382">        vars.put(&quot;eventType&quot;, &quot;start&quot;);</span>
<span class="nc" id="L383">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;errorHandlingProcess&quot;, vars);</span>

<span class="nc" id="L385">        assertThat(processInstance.getProcessVariables())</span>
<span class="nc" id="L386">                .containsEntry(&quot;error_handled_sub_process&quot;, &quot;true&quot;)</span>
<span class="nc" id="L387">                .containsEntry(&quot;_script_task&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L388">                .doesNotContainKey(&quot;error_handled_boundary_event&quot;);</span>
<span class="nc" id="L389">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenerTest.testThrowAndCatchBpmnErrorInSubProcess.bpmn20.xml&quot;)
    public void testThrowBpmnErrorFromSequenceFlowListenerIsHandledByErrorHandlingSubProcessStart() {
<span class="nc" id="L394">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L395">        vars.put(&quot;throwErrorCodeStartListenerSequenceFlow&quot;, &quot;EXECUTION_LISTENER_BPMN_ERROR&quot;);</span>
<span class="nc" id="L396">        vars.put(&quot;eventType&quot;, &quot;start&quot;);</span>
<span class="nc" id="L397">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;errorHandlingProcess&quot;, vars);</span>

<span class="nc" id="L399">        assertThat(processInstance.getProcessVariables())</span>
<span class="nc" id="L400">                .containsEntry(&quot;error_handled_sub_process&quot;, &quot;true&quot;)</span>
<span class="nc" id="L401">                .doesNotContainEntry(&quot;_script_task&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L402">                .doesNotContainKey(&quot;error_handled_boundary_event&quot;);</span>
<span class="nc" id="L403">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenerTest.testThrowAndCatchBpmnErrorInSubProcess.bpmn20.xml&quot;)
    public void testThrowBpmnErrorFromSequenceFlowListenerIsHandledByErrorHandlingSubProcessEnd() {
<span class="nc" id="L408">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L409">        vars.put(&quot;throwErrorCodeEndListenerSequenceFlow&quot;, &quot;EXECUTION_LISTENER_BPMN_ERROR&quot;);</span>
<span class="nc" id="L410">        vars.put(&quot;eventType&quot;, &quot;start&quot;);</span>
<span class="nc" id="L411">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;errorHandlingProcess&quot;, vars);</span>

<span class="nc" id="L413">        assertThat(processInstance.getProcessVariables())</span>
<span class="nc" id="L414">                .containsEntry(&quot;error_handled_sub_process&quot;, &quot;true&quot;)</span>
<span class="nc" id="L415">                .doesNotContainEntry(&quot;_script_task&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L416">                .doesNotContainKey(&quot;error_handled_boundary_event&quot;);</span>
<span class="nc" id="L417">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenerTest.testThrowAndCatchBpmnErrorInSubProcess.bpmn20.xml&quot;)
    public void testThrowBpmnErrorFromStartEventistenerIsHandledByErrorHandlingSubProcessStart() {
<span class="nc" id="L422">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L423">        vars.put(&quot;throwErrorCodeStartListenerStartEvent&quot;, &quot;EXECUTION_LISTENER_BPMN_ERROR&quot;);</span>
<span class="nc" id="L424">        vars.put(&quot;eventType&quot;, &quot;start&quot;);</span>
<span class="nc" id="L425">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;errorHandlingProcess&quot;, vars);</span>

<span class="nc" id="L427">        assertThat(processInstance.getProcessVariables())</span>
<span class="nc" id="L428">                .containsEntry(&quot;error_handled_sub_process&quot;, &quot;true&quot;)</span>
<span class="nc" id="L429">                .doesNotContainEntry(&quot;_script_task&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L430">                .doesNotContainKey(&quot;error_handled_boundary_event&quot;);</span>
<span class="nc" id="L431">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenerTest.testThrowAndCatchBpmnErrorInSubProcess.bpmn20.xml&quot;)
    public void testThrowBpmnErrorFromStartEventistenerIsHandledByErrorHandlingSubProcessEnd() {
<span class="nc" id="L436">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L437">        vars.put(&quot;throwErrorCodeEndListenerStartEvent&quot;, &quot;EXECUTION_LISTENER_BPMN_ERROR&quot;);</span>
<span class="nc" id="L438">        vars.put(&quot;eventType&quot;, &quot;start&quot;);</span>
<span class="nc" id="L439">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;errorHandlingProcess&quot;, vars);</span>

<span class="nc" id="L441">        assertThat(processInstance.getProcessVariables())</span>
<span class="nc" id="L442">                .containsEntry(&quot;error_handled_sub_process&quot;, &quot;true&quot;)</span>
<span class="nc" id="L443">                .doesNotContainEntry(&quot;_script_task&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L444">                .doesNotContainKey(&quot;error_handled_boundary_event&quot;);</span>
<span class="nc" id="L445">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenerTest.testThrowBpmnErrorCatchOnSubprocessWithAccessErrorContext.bpmn20.xml&quot;)
    public void testThrowBpmnErrorCatchOnSubprocessStart() {
<span class="nc" id="L450">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L451">        vars.put(&quot;throwErrorStartListener&quot;, &quot;MY_ERROR&quot;);</span>

<span class="nc" id="L453">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;errorHandlingSubProcess&quot;, vars);</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L455">            Map&lt;String, Object&gt; processVariables = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L456">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L457">                    .includeProcessVariables().singleResult()</span>
<span class="nc" id="L458">                    .getProcessVariables();</span>
<span class="nc" id="L459">            assertThat(processVariables)</span>
<span class="nc" id="L460">                    .containsEntry(&quot;handled_error&quot;, &quot;MY_ERROR&quot;)</span>
<span class="nc" id="L461">                    .doesNotContainKey(&quot;error_code&quot;);</span>
        }
<span class="nc" id="L463">        assertThat(processInstance.getProcessVariables())</span>
<span class="nc" id="L464">                .containsEntry(&quot;handled_error&quot;, &quot;MY_ERROR&quot;)</span>
<span class="nc" id="L465">                .doesNotContainKey(&quot;_script_task&quot;);</span>
<span class="nc" id="L466">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenerTest.testThrowBpmnErrorCatchOnSubprocessWithAccessErrorContext.bpmn20.xml&quot;)
    public void testThrowBpmnErrorCatchOnSubprocessEnd() {
<span class="nc" id="L471">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L472">        vars.put(&quot;throwErrorEndListener&quot;, &quot;MY_ERROR&quot;);</span>

<span class="nc" id="L474">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;errorHandlingSubProcess&quot;, vars);</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L476">            Map&lt;String, Object&gt; processVariables = historyService.createHistoricProcessInstanceQuery()</span>
<span class="nc" id="L477">                    .processInstanceId(processInstance.getId())</span>
<span class="nc" id="L478">                    .includeProcessVariables().singleResult()</span>
<span class="nc" id="L479">                    .getProcessVariables();</span>
<span class="nc" id="L480">            assertThat(processVariables)</span>
<span class="nc" id="L481">                    .containsEntry(&quot;handled_error&quot;, &quot;MY_ERROR&quot;)</span>
<span class="nc" id="L482">                    .containsEntry(&quot;_script_task&quot;, &quot;executed&quot;);</span>
        }

<span class="nc" id="L485">        assertThat(processInstance.getProcessVariables())</span>
<span class="nc" id="L486">                .containsEntry(&quot;handled_error&quot;, &quot;MY_ERROR&quot;)</span>
<span class="nc" id="L487">                .containsEntry(&quot;_script_task&quot;, &quot;executed&quot;);</span>
<span class="nc" id="L488">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenerTest.testThrowBpmnErrorCatchParentBoundary.bpmn20.xml&quot;)
    public void testThrowBpmnErrorCatchOnParentBoundaryEventStart() {
<span class="nc" id="L493">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L494">        vars.put(&quot;throwErrorStartListener&quot;, &quot;MY_ERROR&quot;);</span>

<span class="nc" id="L496">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;errorProcess&quot;, vars);</span>

<span class="nc" id="L498">        assertThat(processInstance.getProcessVariables())</span>
<span class="nc" id="L499">                .containsEntry(&quot;error_handled&quot;, &quot;parent_boundary&quot;)</span>
<span class="nc" id="L500">                .doesNotContainEntry(&quot;_script_task&quot;, &quot;executed&quot;);</span>
<span class="nc" id="L501">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenerTest.testThrowBpmnErrorCatchParentBoundary.bpmn20.xml&quot;)
    public void testThrowBpmnErrorCatchOnParentBoundaryEventEnd() {
<span class="nc" id="L506">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L507">        vars.put(&quot;throwErrorEndListener&quot;, &quot;MY_ERROR&quot;);</span>

<span class="nc" id="L509">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;errorProcess&quot;, vars);</span>

<span class="nc" id="L511">        assertThat(processInstance.getProcessVariables())</span>
<span class="nc" id="L512">                .containsEntry(&quot;error_handled&quot;, &quot;parent_boundary&quot;)</span>
<span class="nc" id="L513">                .containsEntry(&quot;_script_task&quot;, &quot;executed&quot;);</span>
<span class="nc" id="L514">    }</span>

    @Test
    @Deployment(resources =
            &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenerTest.testThrowBpmnErrorCatchBoundaryEventSubProcessMultiInstanceSequential.bpmn20.xml&quot;)
    public void testThrowBpmnErrorCatchBoundaryEventSubProcessMultiInstanceSequentialStart() {
        {
            // SubProcess ExecutionListener
<span class="nc" id="L522">            ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;subProcessErrorHandling&quot;)</span>
<span class="nc" id="L523">                    .transientVariable(&quot;elements&quot;, Arrays.asList(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;))</span>
<span class="nc" id="L524">                    .transientVariable(&quot;throwErrorSubProcessStartListener&quot;, &quot;EXECUTION_LISTENER_BPMN_ERROR&quot;)</span>
<span class="nc" id="L525">                    .transientVariable(&quot;direction&quot;, &quot;subprocess&quot;)</span>
<span class="nc" id="L526">                    .start();</span>

<span class="nc" id="L528">            assertThat(processInstance.getProcessVariables())</span>
<span class="nc" id="L529">                    .containsEntry(&quot;error_handled&quot;, &quot;true&quot;)</span>
<span class="nc" id="L530">                    .hasSize(1)</span>
<span class="nc" id="L531">                    .doesNotContainKey(&quot;startListener_element_1&quot;)</span>
<span class="nc" id="L532">                    .doesNotContainKey(&quot;element_1&quot;)</span>
<span class="nc" id="L533">                    .doesNotContainKey(&quot;element_2&quot;)</span>
<span class="nc" id="L534">                    .doesNotContainKey(&quot;element_3&quot;);</span>
        }
        {
            // SubProcess Activity ExecutionListener throws BpmnError (element 2)
<span class="nc" id="L538">            ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;subProcessErrorHandling&quot;)</span>
<span class="nc" id="L539">                    .transientVariable(&quot;elements&quot;, Arrays.asList(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;))</span>
<span class="nc" id="L540">                    .transientVariable(&quot;throwErrorSubProcessTaskStartListener&quot;, &quot;EXECUTION_LISTENER_BPMN_ERROR&quot;)</span>
<span class="nc" id="L541">                    .transientVariable(&quot;direction&quot;, &quot;subprocess&quot;)</span>
<span class="nc" id="L542">                    .start();</span>

            // element 2 throws the exception and interrupts execution of other items.
<span class="nc" id="L545">            assertThat(processInstance.getProcessVariables())</span>
<span class="nc" id="L546">                    .containsEntry(&quot;error_handled&quot;, &quot;true&quot;)</span>
<span class="nc" id="L547">                    .containsEntry(&quot;startProcessListener_null&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L548">                    .containsEntry(&quot;startProcessListener_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L549">                    .containsEntry(&quot;startListener_element_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L550">                    .containsEntry(&quot;element_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L551">                    .containsEntry(&quot;endListener_element_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L552">                    .containsEntry(&quot;endProcessListener_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L553">                    .containsEntry(&quot;startProcessListener_2&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L554">                    .hasSize(8)</span>
<span class="nc" id="L555">                    .doesNotContainKeys(&quot;endProcessListener_null&quot;);</span>
        }
<span class="nc" id="L557">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenerTest.testThrowBpmnErrorCatchBoundaryEventSubProcessMultiInstanceSequential.bpmn20.xml&quot; })
    public void testThrowBpmnErrorCatchBoundaryEventSubProcessMultiInstanceSequentialEnd() {
        {
            // SubProcess ExecutionListener
<span class="nc" id="L565">            ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;subProcessErrorHandling&quot;)</span>
<span class="nc" id="L566">                    .transientVariable(&quot;direction&quot;, &quot;subprocess&quot;)</span>
<span class="nc" id="L567">                    .transientVariable(&quot;elements&quot;, Arrays.asList(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;))</span>
<span class="nc" id="L568">                    .transientVariable(&quot;throwErrorSubProcessEndListener&quot;, &quot;EXECUTION_LISTENER_BPMN_ERROR&quot;)</span>
<span class="nc" id="L569">                    .start();</span>

<span class="nc" id="L571">            assertThat(processInstance.getProcessVariables())</span>
<span class="nc" id="L572">                    .containsEntry(&quot;startProcessListener_null&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L573">                    .containsEntry(&quot;startProcessListener_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L574">                    .containsEntry(&quot;startListener_element_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L575">                    .containsEntry(&quot;element_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L576">                    .containsEntry(&quot;endListener_element_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L577">                    .containsEntry(&quot;endProcessListener_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L578">                    .containsEntry(&quot;startProcessListener_2&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L579">                    .containsEntry(&quot;startListener_element_2&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L580">                    .containsEntry(&quot;element_2&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L581">                    .containsEntry(&quot;endListener_element_2&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L582">                    .containsEntry(&quot;endProcessListener_2&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L583">                    .containsEntry(&quot;startProcessListener_2&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L584">                    .containsEntry(&quot;startListener_element_3&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L585">                    .containsEntry(&quot;element_3&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L586">                    .containsEntry(&quot;endListener_element_3&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L587">                    .containsEntry(&quot;endProcessListener_3&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L588">                    .containsEntry(&quot;error_handled&quot;, &quot;true&quot;)</span>
<span class="nc" id="L589">                    .hasSize(17)</span>
<span class="nc" id="L590">                    .doesNotContainKey(&quot;endProcessListener_null&quot;);</span>
        }
        {
            // SubProcess Activity ExecutionListener
<span class="nc" id="L594">            ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;subProcessErrorHandling&quot;)</span>
<span class="nc" id="L595">                    .transientVariable(&quot;direction&quot;, &quot;subprocess&quot;)</span>
<span class="nc" id="L596">                    .transientVariable(&quot;elements&quot;, Arrays.asList(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;))</span>
<span class="nc" id="L597">                    .transientVariable(&quot;throwErrorSubProcessTaskEndListener&quot;, &quot;EXECUTION_LISTENER_BPMN_ERROR&quot;)</span>
<span class="nc" id="L598">                    .start();</span>

            // element 2 throws the exception and interrupts execution of other items.
<span class="nc" id="L601">            assertThat(processInstance.getProcessVariables())</span>
<span class="nc" id="L602">                    .containsEntry(&quot;error_handled&quot;, &quot;true&quot;)</span>
<span class="nc" id="L603">                    .containsEntry(&quot;startProcessListener_null&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L604">                    .containsEntry(&quot;startProcessListener_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L605">                    .containsEntry(&quot;startListener_element_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L606">                    .containsEntry(&quot;element_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L607">                    .containsEntry(&quot;endListener_element_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L608">                    .containsEntry(&quot;endProcessListener_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L609">                    .containsEntry(&quot;startProcessListener_2&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L610">                    .containsEntry(&quot;startListener_element_2&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L611">                    .containsEntry(&quot;element_2&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L612">                    .hasSize(10)</span>
<span class="nc" id="L613">                    .doesNotContainKey(&quot;endProcessListener_null&quot;);</span>
        }
<span class="nc" id="L615">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenerTest.testThrowBpmnErrorCatchEventSubProcessMultiInstanceParallel.bpmn20.xml&quot; })
    public void testThrowBpmnErrorCatchBoundaryEventSubProcessMultiInstanceParallelStart() {
        {
            // SubProcess ExecutionListener
<span class="nc" id="L623">            ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;subProcessErrorHandling&quot;)</span>
<span class="nc" id="L624">                    .transientVariable(&quot;throwErrorSubProcessStartListener&quot;, &quot;EXECUTION_LISTENER_BPMN_ERROR&quot;)</span>
<span class="nc" id="L625">                    .transientVariable(&quot;elements&quot;, Arrays.asList(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;))</span>
<span class="nc" id="L626">                    .transientVariable(&quot;direction&quot;, &quot;subprocess&quot;)</span>
<span class="nc" id="L627">                    .start();</span>

<span class="nc" id="L629">            assertThat(processInstance.getProcessVariables())</span>
<span class="nc" id="L630">                    .containsEntry(&quot;error_handled&quot;, &quot;true&quot;)</span>
<span class="nc" id="L631">                    .hasSize(1);</span>
        }
        {
            // SubProcess Activity ExecutionListener
<span class="nc" id="L635">            ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;subProcessErrorHandling&quot;)</span>
<span class="nc" id="L636">                    .transientVariable(&quot;throwErrorSubProcessTaskStartListener&quot;, &quot;EXECUTION_LISTENER_BPMN_ERROR&quot;)</span>
<span class="nc" id="L637">                    .transientVariable(&quot;elements&quot;, Arrays.asList(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;))</span>
<span class="nc" id="L638">                    .transientVariable(&quot;direction&quot;, &quot;subprocess&quot;)</span>
<span class="nc" id="L639">                    .start();</span>
<span class="nc" id="L640">            assertThat(processInstance.getProcessVariables())</span>
<span class="nc" id="L641">                    .containsEntry(&quot;error_handled&quot;, &quot;true&quot;)</span>
<span class="nc" id="L642">                    .containsEntry(&quot;startProcessListener_null&quot;, &quot;executed&quot;)</span>
                    /* This is different to sequential: Process executionListeners are executed, for all instances*/
<span class="nc" id="L644">                    .containsEntry(&quot;startProcessListener_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L645">                    .containsEntry(&quot;startProcessListener_2&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L646">                    .containsEntry(&quot;startProcessListener_3&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L647">                    .containsEntry(&quot;startListener_element_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L648">                    .containsEntry(&quot;element_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L649">                    .hasSize(7)</span>
                    /* this is different to 'sequential'. End listeners of element_1 are NOT called, because element_2 throws the error in
                        the start listener before the node of element_1 is left. */
<span class="nc" id="L652">                    .doesNotContainKey(&quot;endProcessListener_null&quot;);</span>
        }
<span class="nc" id="L654">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenerTest.testThrowBpmnErrorCatchEventSubProcessMultiInstanceParallelAsync.bpmn20.xml&quot; })
    public void testThrowBpmnErrorCatchBoundaryEventSubProcessMultiInstanceParallelStartAsync() {
        {
            // SubProcess ExecutionListener
<span class="nc" id="L662">            ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;subProcessErrorHandling&quot;)</span>
<span class="nc" id="L663">                    .transientVariable(&quot;throwErrorSubProcessStartListener&quot;, &quot;EXECUTION_LISTENER_BPMN_ERROR&quot;)</span>
<span class="nc" id="L664">                    .transientVariable(&quot;elements&quot;, Arrays.asList(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;))</span>
<span class="nc" id="L665">                    .transientVariable(&quot;direction&quot;, &quot;subprocess&quot;)</span>
<span class="nc" id="L666">                    .start();</span>

<span class="nc" id="L668">            assertThat(processInstance.getProcessVariables())</span>
<span class="nc" id="L669">                    .containsEntry(&quot;error_handled&quot;, &quot;true&quot;)</span>
<span class="nc" id="L670">                    .hasSize(1);</span>
        }

        // SubProcess Activity ExecutionListener
<span class="nc" id="L674">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;subProcessErrorHandling&quot;)</span>
<span class="nc" id="L675">                .variable(&quot;throwErrorSubProcessTaskStartListener&quot;, &quot;EXECUTION_LISTENER_BPMN_ERROR&quot;)</span>
<span class="nc" id="L676">                .variable(&quot;elements&quot;, Arrays.asList(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;))</span>
<span class="nc" id="L677">                .transientVariable(&quot;direction&quot;, &quot;subprocess&quot;)</span>
<span class="nc" id="L678">                .start();</span>
<span class="nc" id="L679">        List&lt;Job&gt; jobQuery = managementService.createJobQuery().processInstanceId(processInstance.getProcessInstanceId()).list();</span>
<span class="nc" id="L680">        assertThat(jobQuery).hasSize(3);</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">        if (!jobQuery.isEmpty()) {</span>
<span class="nc" id="L682">            jobQuery.forEach(job -&gt; {</span>
<span class="nc" id="L683">                Job updatedJob = managementService.createJobQuery().jobId(job.getId()).singleResult();</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">                if (updatedJob != null) {</span>
<span class="nc" id="L685">                    managementService.executeJob(updatedJob.getId());</span>
                }
<span class="nc" id="L687">            });</span>
        }
<span class="nc bnc" id="L689" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L690">            HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery().includeProcessVariables()</span>
<span class="nc" id="L691">                    .processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L692">            assertThat(historicProcessInstance.getProcessVariables())</span>
<span class="nc" id="L693">                    .containsEntry(&quot;error_handled&quot;, &quot;true&quot;)</span>
<span class="nc" id="L694">                    .containsEntry(&quot;startProcessListener_null&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L695">                    .containsEntry(&quot;startProcessListener_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L696">                    .containsEntry(&quot;startProcessListener_2&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L697">                    .doesNotContainKey(&quot;endProcessListener_null&quot;);</span>
        }
<span class="nc" id="L699">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenerTest.testThrowBpmnErrorCatchEventSubProcessMultiInstanceParallelAsync.bpmn20.xml&quot; })
    public void testThrowBpmnErrorCatchBoundaryEventSubProcessMultiInstanceParallelEndAsync() {
        {
            // SubProcess ExecutionListener
<span class="nc" id="L707">            ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;subProcessErrorHandling&quot;)</span>
<span class="nc" id="L708">                    .variable(&quot;throwErrorSubProcessEndListener&quot;, &quot;EXECUTION_LISTENER_BPMN_ERROR&quot;)</span>
<span class="nc" id="L709">                    .variable(&quot;elements&quot;, Arrays.asList(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;))</span>
<span class="nc" id="L710">                    .transientVariable(&quot;direction&quot;, &quot;subprocess&quot;)</span>
<span class="nc" id="L711">                    .start();</span>

<span class="nc" id="L713">            List&lt;Job&gt; jobQuery = managementService.createJobQuery().processInstanceId(processInstance.getProcessInstanceId()).list();</span>
<span class="nc" id="L714">            assertThat(jobQuery).hasSize(3);</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">            if (!jobQuery.isEmpty()) {</span>
<span class="nc" id="L716">                jobQuery.forEach(job -&gt; {</span>
<span class="nc" id="L717">                    Job updatedJob = managementService.createJobQuery().jobId(job.getId()).singleResult();</span>
<span class="nc bnc" id="L718" title="All 2 branches missed.">                    if (updatedJob != null) {</span>
<span class="nc" id="L719">                        managementService.executeJob(updatedJob.getId());</span>
                    }
<span class="nc" id="L721">                });</span>
            }
<span class="nc bnc" id="L723" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L724">                HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery().includeProcessVariables()</span>
<span class="nc" id="L725">                        .processInstanceId(processInstance.getId()).singleResult();</span>

<span class="nc" id="L727">                assertThat(historicProcessInstance.getProcessVariables())</span>
<span class="nc" id="L728">                        .containsEntry(&quot;error_handled&quot;, &quot;true&quot;);</span>
            }

        }

        // SubProcess Activity ExecutionListener
<span class="nc" id="L734">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;subProcessErrorHandling&quot;)</span>
<span class="nc" id="L735">                .variable(&quot;throwErrorSubProcessTaskEndListener&quot;, &quot;EXECUTION_LISTENER_BPMN_ERROR&quot;)</span>
<span class="nc" id="L736">                .variable(&quot;elements&quot;, Arrays.asList(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;))</span>
<span class="nc" id="L737">                .transientVariable(&quot;direction&quot;, &quot;subprocess&quot;)</span>
<span class="nc" id="L738">                .start();</span>
<span class="nc" id="L739">        List&lt;Job&gt; jobQuery = managementService.createJobQuery().processInstanceId(processInstance.getProcessInstanceId()).list();</span>
<span class="nc" id="L740">        assertThat(jobQuery).hasSize(3);</span>
<span class="nc bnc" id="L741" title="All 2 branches missed.">        if (!jobQuery.isEmpty()) {</span>
<span class="nc" id="L742">            jobQuery.forEach(job -&gt; {</span>
<span class="nc" id="L743">                Job updatedJob = managementService.createJobQuery().jobId(job.getId()).singleResult();</span>
<span class="nc bnc" id="L744" title="All 2 branches missed.">                if (updatedJob != null) {</span>
<span class="nc" id="L745">                    managementService.executeJob(updatedJob.getId());</span>
                }
<span class="nc" id="L747">            });</span>
        }

<span class="nc bnc" id="L750" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L751">            HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery().includeProcessVariables()</span>
<span class="nc" id="L752">                    .processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L753">            assertThat(historicProcessInstance.getProcessVariables())</span>
<span class="nc" id="L754">                    .containsEntry(&quot;error_handled&quot;, &quot;true&quot;)</span>
<span class="nc" id="L755">                    .containsEntry(&quot;startProcessListener_null&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L756">                    .containsEntry(&quot;startProcessListener_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L757">                    .containsEntry(&quot;startProcessListener_2&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L758">                    .containsEntry(&quot;startListener_element_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L759">                    .containsEntry(&quot;element_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L760">                    .doesNotContainKey(&quot;endProcessListener_null&quot;);</span>
        }
<span class="nc" id="L762">    }</span>

    @Test
    @Deployment(resources = {
            &quot;org/flowable/examples/bpmn/executionlistener/ExecutionListenerTest.testThrowBpmnErrorCatchEventSubProcessMultiInstanceParallel.bpmn20.xml&quot; })
    public void testThrowBpmnErrorCatchEventSubProcessMultiInstanceParallelEnd() {
        {
            // SubProcess ExecutionListener
<span class="nc" id="L770">            ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;subProcessErrorHandling&quot;)</span>
<span class="nc" id="L771">                    .transientVariable(&quot;throwErrorSubProcessEndListener&quot;, &quot;EXECUTION_LISTENER_BPMN_ERROR&quot;)</span>
<span class="nc" id="L772">                    .transientVariable(&quot;direction&quot;, &quot;subprocess&quot;)</span>
<span class="nc" id="L773">                    .transientVariable(&quot;elements&quot;, Arrays.asList(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;))</span>
<span class="nc" id="L774">                    .start();</span>

<span class="nc" id="L776">            assertThat(processInstance.getProcessVariables())</span>
<span class="nc" id="L777">                    .containsEntry(&quot;error_handled&quot;, &quot;true&quot;)</span>
<span class="nc" id="L778">                    .containsEntry(&quot;startProcessListener_null&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L779">                    .containsEntry(&quot;startProcessListener_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L780">                    .containsEntry(&quot;startProcessListener_2&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L781">                    .containsEntry(&quot;startProcessListener_3&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L782">                    .containsEntry(&quot;startListener_element_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L783">                    .containsEntry(&quot;element_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L784">                    .containsEntry(&quot;startListener_element_2&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L785">                    .containsEntry(&quot;element_2&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L786">                    .containsEntry(&quot;startListener_element_3&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L787">                    .containsEntry(&quot;element_3&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L788">                    .containsEntry(&quot;endListener_element_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L789">                    .containsEntry(&quot;endListener_element_2&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L790">                    .containsEntry(&quot;endListener_element_3&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L791">                    .hasSize(14);</span>
        }
        {
                // SubProcess Activity ExecutionListener
<span class="nc" id="L795">                ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder().processDefinitionKey(&quot;subProcessErrorHandling&quot;)</span>
<span class="nc" id="L796">                        .transientVariable(&quot;elements&quot;, Arrays.asList(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;))</span>
<span class="nc" id="L797">                        .transientVariable(&quot;throwErrorSubProcessTaskEndListener&quot;, &quot;EXECUTION_LISTENER_BPMN_ERROR&quot;)</span>
<span class="nc" id="L798">                        .transientVariable(&quot;direction&quot;, &quot;subprocess&quot;)</span>
<span class="nc" id="L799">                        .start();</span>

                // element 2 throws the exception and interrupts execution of other items.
<span class="nc" id="L802">                assertThat(processInstance.getProcessVariables())</span>
<span class="nc" id="L803">                        .containsEntry(&quot;error_handled&quot;, &quot;true&quot;)</span>
<span class="nc" id="L804">                        .containsEntry(&quot;startProcessListener_null&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L805">                        .containsEntry(&quot;startProcessListener_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L806">                        .containsEntry(&quot;startListener_element_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L807">                        .containsEntry(&quot;element_1&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L808">                        .containsEntry(&quot;endListener_element_1&quot;, &quot;executed&quot;)</span>
                        // Those look a bit unexpected at first. But we throw the error in the endListener.
                        // Therefore, for parallel multi instance execution the actual tasks have already been executed.
<span class="nc" id="L811">                        .containsEntry(&quot;startProcessListener_2&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L812">                        .containsEntry(&quot;startListener_element_2&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L813">                        .containsEntry(&quot;element_2&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L814">                        .containsEntry(&quot;startListener_element_3&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L815">                        .containsEntry(&quot;startProcessListener_3&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L816">                        .containsEntry(&quot;element_3&quot;, &quot;executed&quot;)</span>
<span class="nc" id="L817">                        .hasSize(12);</span>
        }
<span class="nc" id="L819">    }</span>

    @Test
    @Deployment
    public void testExecutionListenersOnTimerBoundary() {
<span class="nc" id="L824">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L826">        runtimeService.startProcessInstanceByKey(&quot;executionListenersProcess&quot;);</span>

<span class="nc" id="L828">        Job timerJob = managementService.createTimerJobQuery().singleResult();</span>
<span class="nc" id="L829">        assertThat(timerJob).isNotNull();</span>
<span class="nc" id="L830">        Job job = managementService.moveTimerToExecutableJob(timerJob.getId());</span>
<span class="nc" id="L831">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L833">        List&lt;RecordedEvent&gt; recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L834">        assertThat(recordedEvents)</span>
<span class="nc" id="L835">                .extracting(RecordedEvent::getActivityId, RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L836">                .containsExactly(</span>
<span class="nc" id="L837">                        tuple(&quot;boundary&quot;, &quot;Start boundary&quot;, &quot;start&quot;),</span>
<span class="nc" id="L838">                        tuple(&quot;boundary&quot;, &quot;End boundary&quot;, &quot;end&quot;)</span>
                );
<span class="nc" id="L840">    }</span>

    @Test
    @Deployment
    public void testExecutionListenersOnTimerBoundaryNonInterrupting() {
<span class="nc" id="L845">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L847">        runtimeService.startProcessInstanceByKey(&quot;executionListenersProcess&quot;);</span>

<span class="nc" id="L849">        Job timerJob = managementService.createTimerJobQuery().singleResult();</span>
<span class="nc" id="L850">        assertThat(timerJob).isNotNull();</span>
<span class="nc" id="L851">        Job job = managementService.moveTimerToExecutableJob(timerJob.getId());</span>
<span class="nc" id="L852">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L854">        List&lt;RecordedEvent&gt; recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L855">        assertThat(recordedEvents)</span>
<span class="nc" id="L856">                .extracting(RecordedEvent::getActivityId, RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L857">                .containsExactly(</span>
<span class="nc" id="L858">                        tuple(&quot;boundary&quot;, &quot;Start boundary&quot;, &quot;start&quot;),</span>
<span class="nc" id="L859">                        tuple(&quot;boundary&quot;, &quot;End boundary&quot;, &quot;end&quot;)</span>
                );

<span class="nc" id="L862">        timerJob = managementService.createTimerJobQuery().singleResult();</span>
<span class="nc" id="L863">        assertThat(timerJob).isNotNull();</span>
<span class="nc" id="L864">        job = managementService.moveTimerToExecutableJob(timerJob.getId());</span>
<span class="nc" id="L865">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L867">        recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L868">        assertThat(recordedEvents)</span>
<span class="nc" id="L869">                .extracting(RecordedEvent::getActivityId, RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L870">                .containsExactly(</span>
<span class="nc" id="L871">                        tuple(&quot;boundary&quot;, &quot;Start boundary&quot;, &quot;start&quot;),</span>
<span class="nc" id="L872">                        tuple(&quot;boundary&quot;, &quot;End boundary&quot;, &quot;end&quot;),</span>

<span class="nc" id="L874">                        tuple(&quot;boundary&quot;, &quot;Start boundary&quot;, &quot;start&quot;),</span>
<span class="nc" id="L875">                        tuple(&quot;boundary&quot;, &quot;End boundary&quot;, &quot;end&quot;)</span>
                );
<span class="nc" id="L877">    }</span>

    @Test
    @Deployment
    public void testExecutionListenersOnMessageBoundary() {
<span class="nc" id="L882">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L884">        runtimeService.startProcessInstanceByKey(&quot;executionListenersProcess&quot;);</span>

<span class="nc" id="L886">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L887">        assertThat(eventSubscription).isNotNull();</span>
<span class="nc" id="L888">        runtimeService.messageEventReceived(&quot;testMessage&quot;, eventSubscription.getExecutionId());</span>
<span class="nc" id="L889">        List&lt;RecordedEvent&gt; recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L890">        assertThat(recordedEvents)</span>
<span class="nc" id="L891">                .extracting(RecordedEvent::getActivityId, RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L892">                .containsExactly(</span>
<span class="nc" id="L893">                        tuple(&quot;boundary&quot;, &quot;Start boundary&quot;, &quot;start&quot;),</span>
<span class="nc" id="L894">                        tuple(&quot;boundary&quot;, &quot;End boundary&quot;, &quot;end&quot;)</span>
                );
<span class="nc" id="L896">    }</span>

    @Test
    @Deployment
    public void testExecutionListenersOnMessageBoundaryNonInterrupting() {
<span class="nc" id="L901">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L903">        runtimeService.startProcessInstanceByKey(&quot;executionListenersProcess&quot;);</span>

<span class="nc" id="L905">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L906">        assertThat(eventSubscription).isNotNull();</span>
<span class="nc" id="L907">        runtimeService.messageEventReceived(&quot;testMessage&quot;, eventSubscription.getExecutionId());</span>

<span class="nc" id="L909">        List&lt;RecordedEvent&gt; recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L910">        assertThat(recordedEvents)</span>
<span class="nc" id="L911">                .extracting(RecordedEvent::getActivityId, RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L912">                .containsExactly(</span>
<span class="nc" id="L913">                        tuple(&quot;boundary&quot;, &quot;Start boundary&quot;, &quot;start&quot;),</span>
<span class="nc" id="L914">                        tuple(&quot;boundary&quot;, &quot;End boundary&quot;, &quot;end&quot;)</span>
                );

<span class="nc" id="L917">        eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L918">        assertThat(eventSubscription).isNotNull();</span>
<span class="nc" id="L919">        runtimeService.messageEventReceived(&quot;testMessage&quot;, eventSubscription.getExecutionId());</span>

<span class="nc" id="L921">        recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L922">        assertThat(recordedEvents)</span>
<span class="nc" id="L923">                .extracting(RecordedEvent::getActivityId, RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L924">                .containsExactly(</span>
<span class="nc" id="L925">                        tuple(&quot;boundary&quot;, &quot;Start boundary&quot;, &quot;start&quot;),</span>
<span class="nc" id="L926">                        tuple(&quot;boundary&quot;, &quot;End boundary&quot;, &quot;end&quot;),</span>

<span class="nc" id="L928">                        tuple(&quot;boundary&quot;, &quot;Start boundary&quot;, &quot;start&quot;),</span>
<span class="nc" id="L929">                        tuple(&quot;boundary&quot;, &quot;End boundary&quot;, &quot;end&quot;)</span>
                );
<span class="nc" id="L931">    }</span>

    @Test
    @Deployment
    public void testExecutionListenersOnEventSubProcessTimerStart() {
<span class="nc" id="L936">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L938">        runtimeService.startProcessInstanceByKey(&quot;executionListenersProcess&quot;);</span>

<span class="nc" id="L940">        Job timerJob = managementService.createTimerJobQuery().singleResult();</span>
<span class="nc" id="L941">        assertThat(timerJob).isNotNull();</span>
<span class="nc" id="L942">        Job job = managementService.moveTimerToExecutableJob(timerJob.getId());</span>
<span class="nc" id="L943">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L945">        List&lt;RecordedEvent&gt; recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L946">        assertThat(recordedEvents)</span>
<span class="nc" id="L947">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L948">                .containsExactly(</span>
<span class="nc" id="L949">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L950">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;)</span>
                );
<span class="nc" id="L952">    }</span>

    @Test
    @Deployment
    public void testExecutionListenersOnEventSubProcessTimerStartNonInterrupting() {
<span class="nc" id="L957">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L959">        runtimeService.startProcessInstanceByKey(&quot;executionListenersProcess&quot;);</span>

<span class="nc" id="L961">        Job timerJob = managementService.createTimerJobQuery().singleResult();</span>
<span class="nc" id="L962">        assertThat(timerJob).isNotNull();</span>
<span class="nc" id="L963">        Job job = managementService.moveTimerToExecutableJob(timerJob.getId());</span>
<span class="nc" id="L964">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L966">        List&lt;RecordedEvent&gt; recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L967">        assertThat(recordedEvents)</span>
<span class="nc" id="L968">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L969">                .containsExactly(</span>
<span class="nc" id="L970">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L971">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;)</span>
                );

<span class="nc" id="L974">        timerJob = managementService.createTimerJobQuery().singleResult();</span>
<span class="nc" id="L975">        assertThat(timerJob).isNotNull();</span>
<span class="nc" id="L976">        job = managementService.moveTimerToExecutableJob(timerJob.getId());</span>
<span class="nc" id="L977">        managementService.executeJob(job.getId());</span>

<span class="nc" id="L979">        recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L980">        assertThat(recordedEvents)</span>
<span class="nc" id="L981">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L982">                .containsExactly(</span>
<span class="nc" id="L983">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L984">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;),</span>

<span class="nc" id="L986">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L987">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;)</span>
                );
<span class="nc" id="L989">    }</span>

    @Test
    @Deployment
    public void testExecutionListenersOnEventSubProcessMessageStart() {
<span class="nc" id="L994">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L996">        runtimeService.startProcessInstanceByKey(&quot;executionListenersProcess&quot;);</span>

<span class="nc" id="L998">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L999">        assertThat(eventSubscription).isNotNull();</span>
<span class="nc" id="L1000">        runtimeService.messageEventReceived(&quot;testMessage&quot;, eventSubscription.getExecutionId());</span>
<span class="nc" id="L1001">        List&lt;RecordedEvent&gt; recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L1002">        assertThat(recordedEvents)</span>
<span class="nc" id="L1003">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L1004">                .containsExactly(</span>
<span class="nc" id="L1005">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L1006">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;)</span>
                );
<span class="nc" id="L1008">    }</span>

    @Test
    @Deployment
    public void testExecutionListenersOnEventSubProcessMessageStartNonInterrupting() {
<span class="nc" id="L1013">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L1015">        runtimeService.startProcessInstanceByKey(&quot;executionListenersProcess&quot;);</span>

<span class="nc" id="L1017">        EventSubscription eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L1018">        assertThat(eventSubscription).isNotNull();</span>
<span class="nc" id="L1019">        runtimeService.messageEventReceived(&quot;testMessage&quot;, eventSubscription.getExecutionId());</span>

<span class="nc" id="L1021">        List&lt;RecordedEvent&gt; recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L1022">        assertThat(recordedEvents)</span>
<span class="nc" id="L1023">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L1024">                .containsExactly(</span>
<span class="nc" id="L1025">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L1026">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;)</span>
                );

<span class="nc" id="L1029">        eventSubscription = runtimeService.createEventSubscriptionQuery().singleResult();</span>
<span class="nc" id="L1030">        assertThat(eventSubscription).isNotNull();</span>
<span class="nc" id="L1031">        runtimeService.messageEventReceived(&quot;testMessage&quot;, eventSubscription.getExecutionId());</span>

<span class="nc" id="L1033">        recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L1034">        assertThat(recordedEvents)</span>
<span class="nc" id="L1035">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L1036">                .containsExactly(</span>
<span class="nc" id="L1037">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L1038">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;),</span>

<span class="nc" id="L1040">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L1041">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;)</span>
                );
<span class="nc" id="L1043">    }</span>
    
    @Test
    @Deployment
    public void testExecutionListenersOnEventSubProcessSignalStart() {
<span class="nc" id="L1048">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L1050">        runtimeService.startProcessInstanceByKey(&quot;executionListenersProcess&quot;);</span>

<span class="nc" id="L1052">        runtimeService.signalEventReceived(&quot;testSignal&quot;);</span>
<span class="nc" id="L1053">        List&lt;RecordedEvent&gt; recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L1054">        assertThat(recordedEvents)</span>
<span class="nc" id="L1055">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L1056">                .containsExactly(</span>
<span class="nc" id="L1057">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L1058">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;)</span>
                );
<span class="nc" id="L1060">    }</span>

    @Test
    @Deployment
    public void testExecutionListenersOnEventSubProcessSignalStartNonInterrupting() {
<span class="nc" id="L1065">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L1067">        runtimeService.startProcessInstanceByKey(&quot;executionListenersProcess&quot;);</span>

<span class="nc" id="L1069">        runtimeService.signalEventReceived(&quot;testSignal&quot;);</span>

<span class="nc" id="L1071">        List&lt;RecordedEvent&gt; recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L1072">        assertThat(recordedEvents)</span>
<span class="nc" id="L1073">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L1074">                .containsExactly(</span>
<span class="nc" id="L1075">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L1076">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;)</span>
                );

<span class="nc" id="L1079">        runtimeService.signalEventReceived(&quot;testSignal&quot;);</span>

<span class="nc" id="L1081">        recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L1082">        assertThat(recordedEvents)</span>
<span class="nc" id="L1083">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L1084">                .containsExactly(</span>
<span class="nc" id="L1085">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L1086">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;),</span>

<span class="nc" id="L1088">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L1089">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;)</span>
                );
<span class="nc" id="L1091">    }</span>

    @Test
    @Deployment
    public void testExecutionListenersOnEventSubProcessVariableStart() {
<span class="nc" id="L1096">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L1098">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;executionListenersProcess&quot;);</span>

<span class="nc" id="L1100">        runtimeService.setVariable(processInstance.getId(), &quot;var1&quot;, &quot;test&quot;);</span>

<span class="nc" id="L1102">        List&lt;RecordedEvent&gt; recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L1103">        assertThat(recordedEvents)</span>
<span class="nc" id="L1104">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L1105">                .containsExactly(</span>
<span class="nc" id="L1106">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L1107">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;)</span>
                );
<span class="nc" id="L1109">    }</span>

    @Test
    @Deployment
    public void testExecutionListenersOnEventSubProcessVariableStartNonInterrupting() {
<span class="nc" id="L1114">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L1116">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;executionListenersProcess&quot;);</span>

<span class="nc" id="L1118">        runtimeService.setVariable(processInstance.getId(), &quot;var1&quot;, &quot;test&quot;);</span>

<span class="nc" id="L1120">        List&lt;RecordedEvent&gt; recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L1121">        assertThat(recordedEvents)</span>
<span class="nc" id="L1122">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L1123">                .containsExactly(</span>
<span class="nc" id="L1124">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L1125">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;)</span>
                );

<span class="nc" id="L1128">        runtimeService.setVariable(processInstance.getId(), &quot;var1&quot;, &quot;test v2&quot;);</span>

<span class="nc" id="L1130">        recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L1131">        assertThat(recordedEvents)</span>
<span class="nc" id="L1132">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L1133">                .containsExactly(</span>
<span class="nc" id="L1134">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L1135">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;),</span>

<span class="nc" id="L1137">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L1138">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;)</span>
                );
<span class="nc" id="L1140">    }</span>

    @Test
    @Deployment
    public void testExecutionListenersOnEventSubProcessConditionalStart() {
<span class="nc" id="L1145">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L1147">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L1148">                .processDefinitionKey(&quot;executionListenersProcess&quot;)</span>
<span class="nc" id="L1149">                .variable(&quot;myVar&quot;, &quot;initial&quot;)</span>
<span class="nc" id="L1150">                .start();</span>

<span class="nc" id="L1152">        List&lt;RecordedEvent&gt; recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L1153">        assertThat(recordedEvents)</span>
<span class="nc" id="L1154">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L1155">                .isEmpty();</span>

<span class="nc" id="L1157">        runtimeService.setVariable(processInstance.getId(), &quot;myVar&quot;, &quot;test&quot;);</span>
<span class="nc" id="L1158">        runtimeService.evaluateConditionalEvents(processInstance.getId());</span>

<span class="nc" id="L1160">        recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L1161">        assertThat(recordedEvents)</span>
<span class="nc" id="L1162">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L1163">                .containsExactly(</span>
<span class="nc" id="L1164">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L1165">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;)</span>
                );
<span class="nc" id="L1167">    }</span>

    @Test
    @Deployment
    public void testExecutionListenersOnEventSubProcessConditionalStartNonInterrupting() {
<span class="nc" id="L1172">        RecorderExecutionListener.clear();</span>

<span class="nc" id="L1174">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L1175">                .processDefinitionKey(&quot;executionListenersProcess&quot;)</span>
<span class="nc" id="L1176">                .variable(&quot;myVar&quot;, &quot;initial&quot;)</span>
<span class="nc" id="L1177">                .start();</span>

<span class="nc" id="L1179">        List&lt;RecordedEvent&gt; recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L1180">        assertThat(recordedEvents)</span>
<span class="nc" id="L1181">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L1182">                .isEmpty();</span>

<span class="nc" id="L1184">        runtimeService.setVariable(processInstance.getId(), &quot;myVar&quot;, &quot;test&quot;);</span>
<span class="nc" id="L1185">        runtimeService.evaluateConditionalEvents(processInstance.getId());</span>

<span class="nc" id="L1187">        recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L1188">        assertThat(recordedEvents)</span>
<span class="nc" id="L1189">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L1190">                .containsExactly(</span>
<span class="nc" id="L1191">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L1192">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;)</span>
                );

<span class="nc" id="L1195">        runtimeService.setVariable(processInstance.getId(), &quot;myVar&quot;, &quot;test v2&quot;);</span>
<span class="nc" id="L1196">        runtimeService.evaluateConditionalEvents(processInstance.getId());</span>

<span class="nc" id="L1198">        recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L1199">        assertThat(recordedEvents)</span>
<span class="nc" id="L1200">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L1201">                .containsExactly(</span>
<span class="nc" id="L1202">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L1203">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;)</span>
                );

<span class="nc" id="L1206">        runtimeService.setVariable(processInstance.getId(), &quot;myVar&quot;, &quot;test&quot;);</span>
<span class="nc" id="L1207">        runtimeService.evaluateConditionalEvents(processInstance.getId());</span>

<span class="nc" id="L1209">        recordedEvents = RecorderExecutionListener.getRecordedEvents();</span>
<span class="nc" id="L1210">        assertThat(recordedEvents)</span>
<span class="nc" id="L1211">                .extracting(RecordedEvent::getActivityId,  RecordedEvent::getParameter, RecordedEvent::getEventName)</span>
<span class="nc" id="L1212">                .containsExactly(</span>
<span class="nc" id="L1213">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L1214">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;),</span>

<span class="nc" id="L1216">                        tuple(&quot;startSubProcess&quot;, &quot;Start subprocess&quot;, &quot;start&quot;),</span>
<span class="nc" id="L1217">                        tuple(&quot;startSubProcess&quot;, &quot;End subprocess&quot;, &quot;end&quot;)</span>
                );
<span class="nc" id="L1219">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>