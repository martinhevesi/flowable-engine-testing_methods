<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SignalEventTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.bpmn.event.signal</a> &gt; <span class="el_source">SignalEventTest.java</span></div><h1>SignalEventTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.flowable.engine.test.bpmn.event.signal;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.assertj.core.api.Assertions.tuple;
import static org.assertj.core.data.MapEntry.entry;

import java.util.Arrays;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.assertj.core.groups.Tuple;
import org.flowable.common.engine.api.FlowableException;
import org.flowable.common.engine.impl.history.HistoryLevel;
import org.flowable.common.engine.impl.util.CollectionUtil;
import org.flowable.engine.history.HistoricActivityInstance;
import org.flowable.engine.impl.test.HistoryTestHelper;
import org.flowable.engine.impl.test.PluggableFlowableTestCase;
import org.flowable.engine.repository.ProcessDefinition;
import org.flowable.engine.runtime.Execution;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.eventsubscription.api.EventSubscription;
import org.flowable.eventsubscription.service.impl.EventSubscriptionQueryImpl;
import org.flowable.eventsubscription.service.impl.persistence.entity.SignalEventSubscriptionEntity;
import org.flowable.job.api.Job;
import org.flowable.task.api.Task;
import org.flowable.validation.validator.Problems;
import org.junit.jupiter.api.Test;

/**
 * @author Tijs Rademakers
 * @author Joram Barrez
 */
<span class="nc" id="L50">public class SignalEventTest extends PluggableFlowableTestCase {</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.catchAlertSignal.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.throwAlertSignal.bpmn20.xml&quot; })
    public void testSignalCatchIntermediate() {
<span class="nc" id="L56">        runtimeService.startProcessInstanceByKey(&quot;catchSignal&quot;);</span>

<span class="nc" id="L58">        assertThat(createEventSubscriptionQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L59">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L61">        runtimeService.startProcessInstanceByKey(&quot;throwSignal&quot;);</span>

<span class="nc" id="L63">        assertThat(createEventSubscriptionQuery().count()).isZero();</span>
<span class="nc" id="L64">        assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>
<span class="nc" id="L65">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.catchAlertSignalExpression.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.throwAlertSignalExpression.bpmn20.xml&quot; })
    public void testSignalCatchIntermediateExpression() {
<span class="nc" id="L71">        Map&lt;String, Object&gt; variableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L72">        variableMap.put(&quot;mySignalName&quot;, &quot;testSignal&quot;);</span>
<span class="nc" id="L73">        runtimeService.startProcessInstanceByKey(&quot;catchSignal&quot;, variableMap);</span>

<span class="nc" id="L75">        assertThat(createEventSubscriptionQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L76">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L78">        runtimeService.startProcessInstanceByKey(&quot;throwSignal&quot;, variableMap);</span>

<span class="nc" id="L80">        assertThat(createEventSubscriptionQuery().count()).isZero();</span>
<span class="nc" id="L81">        assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>
<span class="nc" id="L82">    }</span>
    
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.catchAlertSignalWithInParameters.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.throwAlertSignalWithOutParameters.bpmn20.xml&quot; })
    public void testSignalCatchIntermediateWithParameters() {
<span class="nc" id="L88">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;catchSignal&quot;);</span>

<span class="nc" id="L90">        assertThat(createEventSubscriptionQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L91">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L93">        Map&lt;String, Object&gt; signalVariableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L94">        signalVariableMap.put(&quot;textVar&quot;, &quot;John Doe&quot;);</span>
<span class="nc" id="L95">        signalVariableMap.put(&quot;numberVar&quot;, 1);</span>
<span class="nc" id="L96">        runtimeService.startProcessInstanceByKey(&quot;throwSignal&quot;, signalVariableMap);</span>

<span class="nc" id="L98">        assertThat(createEventSubscriptionQuery().count()).isZero();</span>
<span class="nc" id="L99">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>
        
<span class="nc" id="L101">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L102">        assertThat(task).isNotNull();</span>
        
<span class="nc" id="L104">        Map&lt;String, Object&gt; variableMap = runtimeService.getVariables(processInstance.getId());</span>
<span class="nc" id="L105">        assertThat(variableMap)</span>
<span class="nc" id="L106">                .containsOnly(</span>
<span class="nc" id="L107">                        entry(&quot;myNewTextVar&quot;, &quot;John Doe&quot;),</span>
<span class="nc" id="L108">                        entry(&quot;myNewNumberVar&quot;, 1));</span>
<span class="nc" id="L109">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.catchAlertSignalBoundary.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.throwAlertSignal.bpmn20.xml&quot; })
    public void testSignalCatchBoundary() {
<span class="nc" id="L115">        runtimeService.startProcessInstanceByKey(&quot;catchSignal&quot;);</span>

<span class="nc" id="L117">        assertThat(createEventSubscriptionQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L118">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L120">        runtimeService.startProcessInstanceByKey(&quot;throwSignal&quot;);</span>

<span class="nc" id="L122">        assertThat(createEventSubscriptionQuery().count()).isZero();</span>
<span class="nc" id="L123">        assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>
<span class="nc" id="L124">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.catchAlertSignalBoundaryWithReceiveTask.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.throwAlertSignal.bpmn20.xml&quot; })
    public void testSignalCatchBoundaryWithVariables() {
<span class="nc" id="L130">        HashMap&lt;String, Object&gt; variables1 = new HashMap&lt;&gt;();</span>
<span class="nc" id="L131">        variables1.put(&quot;processName&quot;, &quot;catchSignal&quot;);</span>
<span class="nc" id="L132">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;catchSignal&quot;, variables1);</span>

<span class="nc" id="L134">        HashMap&lt;String, Object&gt; variables2 = new HashMap&lt;&gt;();</span>
<span class="nc" id="L135">        variables2.put(&quot;processName&quot;, &quot;throwSignal&quot;);</span>
<span class="nc" id="L136">        runtimeService.startProcessInstanceByKey(&quot;throwSignal&quot;, variables2);</span>

<span class="nc" id="L138">        assertThat(runtimeService.getVariable(pi.getId(), &quot;processName&quot;)).isEqualTo(&quot;catchSignal&quot;);</span>
<span class="nc" id="L139">    }</span>
    
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.catchAlertSignalBoundaryWithInParameters.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.throwAlertSignalWithOutParameters.bpmn20.xml&quot; })
    public void testSignalCatchBoundaryWithParameters() {
<span class="nc" id="L145">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;catchSignal&quot;);</span>

<span class="nc" id="L147">        assertThat(createEventSubscriptionQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L148">        assertThat(createEventSubscriptionQuery().withoutProcessInstanceId().count()).isZero();</span>
<span class="nc" id="L149">        assertThat(createEventSubscriptionQuery().withoutScopeId().count()).isEqualTo(1);</span>
<span class="nc" id="L150">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L152">        Map&lt;String, Object&gt; signalVariableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L153">        signalVariableMap.put(&quot;textVar&quot;, &quot;John Doe&quot;);</span>
<span class="nc" id="L154">        signalVariableMap.put(&quot;numberVar&quot;, 1);</span>
<span class="nc" id="L155">        runtimeService.startProcessInstanceByKey(&quot;throwSignal&quot;, signalVariableMap);</span>

<span class="nc" id="L157">        assertThat(createEventSubscriptionQuery().count()).isZero();</span>
<span class="nc" id="L158">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>
        
<span class="nc" id="L160">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L161">        assertThat(task).isNotNull();</span>
        
<span class="nc" id="L163">        Map&lt;String, Object&gt; variableMap = runtimeService.getVariables(processInstance.getId());</span>
<span class="nc" id="L164">        assertThat(variableMap)</span>
<span class="nc" id="L165">                .containsOnly(</span>
<span class="nc" id="L166">                        entry(&quot;myNewTextVar&quot;, &quot;John Doe&quot;),</span>
<span class="nc" id="L167">                        entry(&quot;myNewNumberVar&quot;, 1));</span>
<span class="nc" id="L168">    }</span>
    
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.catchAlertSignalBoundaryWithInParameters.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.throwAlertSignalWithOutParameterExpressions.bpmn20.xml&quot; })
    public void testSignalCatchBoundaryWithParameterExpressions() {
<span class="nc" id="L174">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;catchSignal&quot;);</span>

<span class="nc" id="L176">        assertThat(createEventSubscriptionQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L177">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L179">        Map&lt;String, Object&gt; signalVariableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L180">        signalVariableMap.put(&quot;firstNameVar&quot;, &quot;John&quot;);</span>
<span class="nc" id="L181">        signalVariableMap.put(&quot;lastNameVar&quot;, &quot;Doe&quot;);</span>
<span class="nc" id="L182">        runtimeService.startProcessInstanceByKey(&quot;throwSignal&quot;, signalVariableMap);</span>

<span class="nc" id="L184">        assertThat(createEventSubscriptionQuery().count()).isZero();</span>
<span class="nc" id="L185">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>
        
<span class="nc" id="L187">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L188">        assertThat(task).isNotNull();</span>
        
<span class="nc" id="L190">        Map&lt;String, Object&gt; variableMap = runtimeService.getVariables(processInstance.getId());</span>
<span class="nc" id="L191">        assertThat(variableMap)</span>
<span class="nc" id="L192">                .containsOnly(</span>
<span class="nc" id="L193">                        entry(&quot;myNewTextVar&quot;, &quot;John Doe&quot;),</span>
<span class="nc" id="L194">                        entry(&quot;myNewNumberVar&quot;, 2L));</span>
<span class="nc" id="L195">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.catchAlertSignal.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.throwAlertSignalAsynch.bpmn20.xml&quot; })
    public void testSignalCatchIntermediateAsync() {

<span class="nc" id="L202">        runtimeService.startProcessInstanceByKey(&quot;catchSignal&quot;);</span>

<span class="nc" id="L204">        assertThat(createEventSubscriptionQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L205">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L207">        runtimeService.startProcessInstanceByKey(&quot;throwSignal&quot;);</span>

<span class="nc" id="L209">        assertThat(createEventSubscriptionQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L210">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>

        // there is a job:
<span class="nc" id="L213">        assertThat(managementService.createJobQuery().count()).isEqualTo(1);</span>

        try {
<span class="nc" id="L216">            processEngineConfiguration.getClock().setCurrentTime(new Date(System.currentTimeMillis() + 1000));</span>
<span class="nc" id="L217">            waitForJobExecutorToProcessAllJobs(10000, 100L);</span>

<span class="nc" id="L219">            assertThat(createEventSubscriptionQuery().count()).isZero();</span>
<span class="nc" id="L220">            assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>
<span class="nc" id="L221">            assertThat(managementService.createJobQuery().count()).isZero();</span>
        } finally {
<span class="nc" id="L223">            processEngineConfiguration.getClock().setCurrentTime(new Date());</span>
        }
<span class="nc" id="L225">    }</span>
    
    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.catchAlertSignalBoundaryWithInParameters.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.throwAlertSignalAsynchWithOutParameters.bpmn20.xml&quot; })
    public void testSignalCatchBoundaryAsyncWithParameters() {
<span class="nc" id="L231">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;catchSignal&quot;);</span>

<span class="nc" id="L233">        assertThat(createEventSubscriptionQuery().processInstanceId(processInstance.getId()).count()).isEqualTo(1);</span>
<span class="nc" id="L234">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L236">        Map&lt;String, Object&gt; signalVariableMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L237">        signalVariableMap.put(&quot;textVar&quot;, &quot;John Doe&quot;);</span>
<span class="nc" id="L238">        signalVariableMap.put(&quot;numberVar&quot;, 1);</span>
<span class="nc" id="L239">        runtimeService.startProcessInstanceByKey(&quot;throwSignal&quot;, signalVariableMap);</span>

<span class="nc" id="L241">        assertThat(createEventSubscriptionQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L242">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>
        
<span class="nc" id="L244">        assertThat(managementService.createJobQuery().count()).isEqualTo(1);</span>
        
        try {
<span class="nc" id="L247">            processEngineConfiguration.getClock().setCurrentTime(new Date(System.currentTimeMillis() + 1000));</span>
<span class="nc" id="L248">            waitForJobExecutorToProcessAllJobs(10000, 100L);</span>

<span class="nc" id="L250">            Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L251">            assertThat(task).isNotNull();</span>
            
<span class="nc" id="L253">            Map&lt;String, Object&gt; variableMap = runtimeService.getVariables(processInstance.getId());</span>
<span class="nc" id="L254">            assertThat(variableMap)</span>
<span class="nc" id="L255">                    .containsOnly(</span>
<span class="nc" id="L256">                            entry(&quot;myNewTextVar&quot;, &quot;John Doe&quot;),</span>
<span class="nc" id="L257">                            entry(&quot;myNewNumberVar&quot;, 1));</span>
            
        } finally {
<span class="nc" id="L260">            processEngineConfiguration.getClock().setCurrentTime(new Date());</span>
        }
<span class="nc" id="L262">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.catchMultipleSignals.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.throwAlertSignal.bpmn20.xml&quot;, &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.throwAbortSignal.bpmn20.xml&quot; })
    public void testSignalCatchDifferentSignals() {

<span class="nc" id="L269">        runtimeService.startProcessInstanceByKey(&quot;catchSignal&quot;);</span>

<span class="nc" id="L271">        assertThat(createEventSubscriptionQuery().count()).isEqualTo(2);</span>
<span class="nc" id="L272">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L274">        runtimeService.startProcessInstanceByKey(&quot;throwAbort&quot;);</span>

<span class="nc" id="L276">        assertThat(createEventSubscriptionQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L277">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L279">        org.flowable.task.api.Task taskAfterAbort = taskService.createTaskQuery().taskAssignee(&quot;gonzo&quot;).singleResult();</span>
<span class="nc" id="L280">        assertThat(taskAfterAbort).isNotNull();</span>
<span class="nc" id="L281">        taskService.complete(taskAfterAbort.getId());</span>

<span class="nc" id="L283">        runtimeService.startProcessInstanceByKey(&quot;throwSignal&quot;);</span>

<span class="nc" id="L285">        assertThat(createEventSubscriptionQuery().count()).isZero();</span>
<span class="nc" id="L286">        assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>
<span class="nc" id="L287">    }</span>

    /**
     * Verifies the solution of https://jira.codehaus.org/browse/ACT-1309
     */
    @Test
    @Deployment
    public void testSignalBoundaryOnSubProcess() {
<span class="nc" id="L295">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;signalEventOnSubprocess&quot;);</span>
<span class="nc" id="L296">        runtimeService.signalEventReceived(&quot;stopSignal&quot;);</span>
<span class="nc" id="L297">        assertProcessEnded(pi.getProcessInstanceId());</span>
<span class="nc" id="L298">    }</span>

    @Test
    public void testDuplicateSignalNames() {
<span class="nc" id="L302">        assertThatThrownBy(() -&gt; repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.duplicateSignalNames.bpmn20.xml&quot;).deploy())</span>
<span class="nc" id="L303">                .isInstanceOf(Exception.class)</span>
<span class="nc" id="L304">                .hasMessageContaining(Problems.SIGNAL_DUPLICATE_NAME);</span>
<span class="nc" id="L305">    }</span>

    @Test
    public void testNoSignalName() {
<span class="nc" id="L309">        assertThatThrownBy(() -&gt;  repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.noSignalName.bpmn20.xml&quot;).deploy())</span>
<span class="nc" id="L310">                .isInstanceOf(Exception.class)</span>
<span class="nc" id="L311">                .hasMessageContaining(Problems.SIGNAL_MISSING_NAME);</span>
<span class="nc" id="L312">    }</span>

    @Test
    public void testSignalNoId() {
<span class="nc" id="L316">        assertThatThrownBy(() -&gt;  repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.signalNoId.bpmn20.xml&quot;).deploy())</span>
<span class="nc" id="L317">                .isInstanceOf(Exception.class)</span>
<span class="nc" id="L318">                .hasMessageContaining(Problems.SIGNAL_MISSING_ID);</span>
<span class="nc" id="L319">    }</span>

    @Test
    public void testSignalNoRef() {
<span class="nc" id="L323">        assertThatThrownBy(() -&gt;  repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.signalNoRef.bpmn20.xml&quot;).deploy())</span>
<span class="nc" id="L324">                .isInstanceOf(Exception.class)</span>
<span class="nc" id="L325">                .hasMessageContaining(Problems.SIGNAL_EVENT_MISSING_SIGNAL_REF);</span>
<span class="nc" id="L326">    }</span>

    private EventSubscriptionQueryImpl createEventSubscriptionQuery() {
<span class="nc" id="L329">        return new EventSubscriptionQueryImpl(processEngineConfiguration.getCommandExecutor(), processEngineConfiguration.getEventSubscriptionServiceConfiguration());</span>
    }

    /**
     * TestCase to reproduce Issue ACT-1344
     */
    @Test
    @Deployment
    public void testNonInterruptingSignal() {
<span class="nc" id="L338">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;nonInterruptingSignalEvent&quot;);</span>

<span class="nc" id="L340">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(pi.getProcessInstanceId()).list();</span>
<span class="nc" id="L341">        assertThat(tasks)</span>
<span class="nc" id="L342">                .extracting(Task::getName)</span>
<span class="nc" id="L343">                .containsOnly(&quot;My User Task&quot;);</span>

<span class="nc" id="L345">        runtimeService.signalEventReceived(&quot;alert&quot;);</span>

<span class="nc" id="L347">        tasks = taskService.createTaskQuery().processInstanceId(pi.getProcessInstanceId()).list();</span>
<span class="nc" id="L348">        assertThat(tasks)</span>
<span class="nc" id="L349">                .extracting(Task::getName)</span>
<span class="nc" id="L350">                .containsOnly(&quot;My User Task&quot;, &quot;My Second User Task&quot;);</span>

<span class="nc" id="L352">        taskService.complete(taskService.createTaskQuery().taskName(&quot;My User Task&quot;).singleResult().getId());</span>

<span class="nc" id="L354">        tasks = taskService.createTaskQuery().processInstanceId(pi.getProcessInstanceId()).list();</span>
<span class="nc" id="L355">        assertThat(tasks)</span>
<span class="nc" id="L356">                .extracting(Task::getName)</span>
<span class="nc" id="L357">                .containsOnly(&quot;My Second User Task&quot;);</span>
<span class="nc" id="L358">    }</span>
    
    @Test
    @Deployment
    public void testNonInterruptingSignalWithInParameters() {
<span class="nc" id="L363">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;nonInterruptingSignalEvent&quot;);</span>

<span class="nc" id="L365">        Task task = taskService.createTaskQuery().processInstanceId(pi.getProcessInstanceId()).singleResult();</span>

<span class="nc" id="L367">        Map&lt;String, Object&gt; payload = new HashMap&lt;&gt;();</span>
<span class="nc" id="L368">        payload.put(&quot;testVar&quot;, &quot;test&quot;);</span>
<span class="nc" id="L369">        payload.put(&quot;anotherVar&quot;, &quot;anotherTest&quot;);</span>
<span class="nc" id="L370">        payload.put(&quot;nameVar&quot;, &quot;John Doe&quot;);</span>
<span class="nc" id="L371">        runtimeService.signalEventReceived(&quot;alert&quot;, payload);</span>

<span class="nc" id="L373">        List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(pi.getProcessInstanceId()).list();</span>
<span class="nc" id="L374">        assertThat(tasks)</span>
<span class="nc" id="L375">                .extracting(Task::getName)</span>
<span class="nc" id="L376">                .containsOnly(&quot;My User Task&quot;, &quot;My Second User Task&quot;);</span>

<span class="nc" id="L378">        Map&lt;String, Object&gt; processVariableMap = runtimeService.getVariables(pi.getProcessInstanceId());</span>
<span class="nc" id="L379">        assertThat(processVariableMap)</span>
<span class="nc" id="L380">                .containsOnly(</span>
<span class="nc" id="L381">                        entry(&quot;myTestVar&quot;, &quot;test&quot;),</span>
<span class="nc" id="L382">                        entry(&quot;myAnotherVar&quot;, &quot;anotherTest&quot;)</span>
                );

<span class="nc" id="L385">        taskService.complete(taskService.createTaskQuery().taskName(&quot;My User Task&quot;).singleResult().getId());</span>

<span class="nc" id="L387">        task = taskService.createTaskQuery().processInstanceId(pi.getProcessInstanceId()).singleResult();</span>
<span class="nc" id="L388">        assertThat(task.getName()).isEqualTo(&quot;My Second User Task&quot;);</span>
<span class="nc" id="L389">    }</span>

    /**
     * TestCase to reproduce Issue ACT-1344
     */
    @Test
    @Deployment
    public void testNonInterruptingSignalWithSubProcess() {
<span class="nc" id="L397">        ProcessInstance pi = runtimeService.startProcessInstanceByKey(&quot;nonInterruptingSignalWithSubProcess&quot;);</span>
<span class="nc" id="L398">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().processInstanceId(pi.getProcessInstanceId()).list();</span>
<span class="nc" id="L399">        assertThat(tasks)</span>
<span class="nc" id="L400">                .extracting(Task::getName)</span>
<span class="nc" id="L401">                .containsOnly(&quot;Approve&quot;);</span>

<span class="nc" id="L403">        runtimeService.signalEventReceived(&quot;alert&quot;);</span>

<span class="nc" id="L405">        tasks = taskService.createTaskQuery().processInstanceId(pi.getProcessInstanceId()).list();</span>
<span class="nc" id="L406">        assertThat(tasks)</span>
<span class="nc" id="L407">                .extracting(Task::getName)</span>
<span class="nc" id="L408">                .containsOnly(&quot;Approve&quot;, &quot;Review&quot;);</span>

<span class="nc" id="L410">        taskService.complete(taskService.createTaskQuery().taskName(&quot;Approve&quot;).singleResult().getId());</span>

<span class="nc" id="L412">        tasks = taskService.createTaskQuery().processInstanceId(pi.getProcessInstanceId()).list();</span>
<span class="nc" id="L413">        assertThat(tasks)</span>
<span class="nc" id="L414">                .extracting(Task::getName)</span>
<span class="nc" id="L415">                .containsOnly(&quot;Review&quot;);</span>

<span class="nc" id="L417">        taskService.complete(taskService.createTaskQuery().taskName(&quot;Review&quot;).singleResult().getId());</span>

<span class="nc" id="L419">        tasks = taskService.createTaskQuery().processInstanceId(pi.getProcessInstanceId()).list();</span>
<span class="nc" id="L420">        assertThat(tasks).hasSize(1);</span>
<span class="nc" id="L421">    }</span>

    @Test
    @Deployment
    public void testUseSignalForExceptionsBetweenParallelPaths() {
<span class="nc" id="L426">        runtimeService.startProcessInstanceByKey(&quot;processWithSignal&quot;);</span>

        // First task should be to select the developers
<span class="nc" id="L429">        org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L430">        assertThat(task.getName()).isEqualTo(&quot;Enter developers&quot;);</span>
<span class="nc" id="L431">        taskService.complete(task.getId(), CollectionUtil.singletonMap(&quot;developers&quot;, Arrays.asList(&quot;developerOne&quot;, &quot;developerTwo&quot;, &quot;developerThree&quot;)));</span>

        // Should be three distinct tasks for each developer
<span class="nc" id="L434">        assertThat(taskService.createTaskQuery().taskAssignee(&quot;developerOne&quot;).singleResult().getName()).isEqualTo(&quot;Develop specifications&quot;);</span>
<span class="nc" id="L435">        assertThat(taskService.createTaskQuery().taskAssignee(&quot;developerTwo&quot;).singleResult().getName()).isEqualTo(&quot;Develop specifications&quot;);</span>
<span class="nc" id="L436">        assertThat(taskService.createTaskQuery().taskAssignee(&quot;developerThree&quot;).singleResult().getName()).isEqualTo(&quot;Develop specifications&quot;);</span>

        // Negotiate with client is a task for kermit
<span class="nc" id="L439">        task = taskService.createTaskQuery().taskAssignee(&quot;kermit&quot;).singleResult();</span>
<span class="nc" id="L440">        assertThat(task.getName()).isEqualTo(&quot;Negotiate with client&quot;);</span>

        // When the kermit task is completed, it throws a signal which should
        // cancel the multi instance
<span class="nc" id="L444">        taskService.complete(task.getId(), CollectionUtil.singletonMap(&quot;negotationFailed&quot;, true));</span>

        // No tasks should be open then and process should have ended
<span class="nc" id="L447">        assertThat(taskService.createTaskQuery().count()).isZero();</span>
<span class="nc" id="L448">        assertThat(runtimeService.createExecutionQuery().count()).isZero();</span>
<span class="nc" id="L449">    }</span>

    @Test
    @Deployment
    public void testSignalWithProcessInstanceScope() {
        // Start the process that catches the signal
<span class="nc" id="L455">        ProcessInstance processInstanceCatch = runtimeService.startProcessInstanceByKey(&quot;processWithSignalCatch&quot;);</span>
<span class="nc" id="L456">        assertThat(taskService.createTaskQuery().processInstanceId(processInstanceCatch.getId()).singleResult().getName()).isEqualTo(&quot;userTaskWithSignalCatch&quot;);</span>

        // Then start the process that will throw the signal
<span class="nc" id="L459">        runtimeService.startProcessInstanceByKey(&quot;processWithSignalThrow&quot;);</span>

        // Since the signal is process instance scoped, the second process shouldn't have proceeded in any way
<span class="nc" id="L462">        assertThat(taskService.createTaskQuery().processInstanceId(processInstanceCatch.getId()).singleResult().getName()).isEqualTo(&quot;userTaskWithSignalCatch&quot;);</span>

        // Let's try to trigger the catch using the API, that should also fail
<span class="nc" id="L465">        runtimeService.signalEventReceived(&quot;The Signal&quot;);</span>
<span class="nc" id="L466">        assertThat(taskService.createTaskQuery().processInstanceId(processInstanceCatch.getId()).singleResult().getName()).isEqualTo(&quot;userTaskWithSignalCatch&quot;);</span>
<span class="nc" id="L467">    }</span>
    
    @Test
    @Deployment
    public void testCallActivityWithInstanceScopeSignal() {
        // start process with call activity and catching signal   
<span class="nc" id="L473">        ProcessInstance processInstanceCatch = runtimeService.startProcessInstanceByKey(&quot;processWithSignalCatch&quot;);</span>
<span class="nc" id="L474">        assertThat(taskService.createTaskQuery().processInstanceId(processInstanceCatch.getId()).singleResult().getName()).isEqualTo(&quot;userTaskWithSignalCatch&quot;);</span>
        
<span class="nc" id="L476">        ProcessInstance throwingProcessInstance = runtimeService.createProcessInstanceQuery().superProcessInstanceId(processInstanceCatch.getId()).singleResult();</span>
<span class="nc" id="L477">        assertThat(throwingProcessInstance).isNotNull();</span>
        
<span class="nc" id="L479">        Task beforeThrowTask = taskService.createTaskQuery().processInstanceId(throwingProcessInstance.getId()).singleResult();</span>
<span class="nc" id="L480">        assertThat(beforeThrowTask.getTaskDefinitionKey()).isEqualTo(&quot;beforeThrowTask&quot;);</span>
<span class="nc" id="L481">        taskService.complete(beforeThrowTask.getId());</span>
        
<span class="nc" id="L483">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(throwingProcessInstance.getId()).count()).isZero();</span>
        
<span class="nc" id="L485">        Task afterSignalReceiveTask = taskService.createTaskQuery().processInstanceId(processInstanceCatch.getId()).singleResult();</span>
<span class="nc" id="L486">        assertThat(afterSignalReceiveTask.getTaskDefinitionKey()).isEqualTo(&quot;userTaskAfterSignalCatch&quot;);</span>
<span class="nc" id="L487">        taskService.complete(afterSignalReceiveTask.getId());</span>
        
<span class="nc" id="L489">        assertThat(runtimeService.createProcessInstanceQuery().processInstanceId(processInstanceCatch.getId()).count()).isZero();</span>
<span class="nc" id="L490">    }</span>

    @Test
    @Deployment
    public void testSignalWithGlobalScope() {
        // Start the process that catches the signal
<span class="nc" id="L496">        ProcessInstance processInstanceCatch = runtimeService.startProcessInstanceByKey(&quot;processWithSignalCatch&quot;);</span>
<span class="nc" id="L497">        assertThat(taskService.createTaskQuery().processInstanceId(processInstanceCatch.getId()).singleResult().getName()).isEqualTo(&quot;userTaskWithSignalCatch&quot;);</span>

        // Then start the process that will throw thee signal
<span class="nc" id="L500">        runtimeService.startProcessInstanceByKey(&quot;processWithSignalThrow&quot;);</span>

        // Since the signal is process instance scoped, the second process
        // shouldn't have proceeded in any way
<span class="nc" id="L504">        assertThat(taskService.createTaskQuery().processInstanceId(processInstanceCatch.getId()).singleResult().getName()).isEqualTo(&quot;userTaskAfterSignalCatch&quot;);</span>
<span class="nc" id="L505">    }</span>

    @Test
    @Deployment
    public void testAsyncTriggeredSignalEvent() {
<span class="nc" id="L510">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;processWithSignalCatch&quot;);</span>

<span class="nc" id="L512">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L513">        Execution execution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).signalEventSubscriptionName(&quot;The Signal&quot;).singleResult();</span>
<span class="nc" id="L514">        assertThat(execution).isNotNull();</span>
<span class="nc" id="L515">        assertThat(createEventSubscriptionQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L516">        assertThat(runtimeService.createExecutionQuery().count()).isEqualTo(2);</span>

<span class="nc" id="L518">        runtimeService.signalEventReceivedAsync(&quot;The Signal&quot;, execution.getId());</span>

<span class="nc" id="L520">        assertThat(managementService.createJobQuery().messages().count()).isEqualTo(1);</span>

<span class="nc" id="L522">        waitForJobExecutorToProcessAllJobs(8000L, 200L);</span>
<span class="nc" id="L523">        assertThat(createEventSubscriptionQuery().count()).isZero();</span>
<span class="nc" id="L524">        assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>
<span class="nc" id="L525">        assertThat(managementService.createJobQuery().count()).isZero();</span>
<span class="nc" id="L526">    }</span>

    @Test
    @Deployment
    public void testSignalUserTask() {
<span class="nc" id="L531">        runtimeService.startProcessInstanceByKey(&quot;catchSignal&quot;);</span>
<span class="nc" id="L532">        Execution execution = runtimeService.createExecutionQuery().onlyChildExecutions().activityId(&quot;waitState&quot;).singleResult();</span>

<span class="nc" id="L534">        assertThat(execution).isNotNull();</span>

<span class="nc" id="L536">        assertThatThrownBy(() -&gt; runtimeService.trigger(execution.getId()))</span>
<span class="nc" id="L537">                .isExactlyInstanceOf(FlowableException.class);</span>
<span class="nc" id="L538">    }</span>

    @Test
    public void testSignalStartEventFromProcess() {

        // Deploy test processes
<span class="nc" id="L544">        repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTest.testSignalStartEvent.bpmn20.xml&quot;).deploy();</span>

        // Starting the process that fires the signal should start three process
        // instances that are listening on that signal
<span class="nc" id="L548">        runtimeService.startProcessInstanceByKey(&quot;processWithSignalThrow&quot;);</span>

        // Verify
<span class="nc" id="L551">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(3);</span>
<span class="nc" id="L552">        assertThat(taskService.createTaskQuery().count()).isEqualTo(3);</span>

<span class="nc" id="L554">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().orderByTaskName().asc().list();</span>
<span class="nc" id="L555">        List&lt;String&gt; names = Arrays.asList(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;);</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">        for (int i = 0; i &lt; tasks.size(); i++) {</span>
<span class="nc" id="L557">            assertThat(tasks.get(i).getName()).isEqualTo(&quot;Task in process &quot; + names.get(i));</span>
        }

        // Start a process with a signal boundary event
<span class="nc" id="L561">        runtimeService.startProcessInstanceByKey(&quot;processWithSignalCatch&quot;);</span>
<span class="nc" id="L562">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(4);</span>
<span class="nc" id="L563">        assertThat(taskService.createTaskQuery().count()).isEqualTo(4);</span>
<span class="nc" id="L564">        assertThat(taskService.createTaskQuery().taskName(&quot;Task in process D&quot;).count()).isEqualTo(1);</span>

        // Firing the signal should now trigger the one with the boundary event
        // too
<span class="nc" id="L568">        runtimeService.startProcessInstanceByKey(&quot;processWithSignalThrow&quot;);</span>
<span class="nc" id="L569">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(7);</span>
<span class="nc" id="L570">        assertThat(taskService.createTaskQuery().count()).isEqualTo(7);</span>
<span class="nc" id="L571">        assertThat(taskService.createTaskQuery().taskName(&quot;Task after signal&quot;).count()).isEqualTo(1);</span>

        // Cleanup
<span class="nc" id="L574">        cleanup();</span>

<span class="nc" id="L576">    }</span>

    @Test
    public void testSignalStartEventFromProcesAsync() {

        // Deploy test processes
<span class="nc" id="L582">        repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTest.testSignalStartEventAsync.bpmn20.xml&quot;).deploy();</span>

        // Starting the process that fires the signal should start 1 process
        // instance that are listening on that signal, the others are done async
<span class="nc" id="L586">        runtimeService.startProcessInstanceByKey(&quot;processWithSignalThrow&quot;);</span>

        // Verify
<span class="nc" id="L589">        assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>
<span class="nc" id="L590">        assertThat(taskService.createTaskQuery().count()).isZero();</span>

<span class="nc" id="L592">        assertThat(managementService.createJobQuery().count()).isEqualTo(3);</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">        for (Job job : managementService.createJobQuery().list()) {</span>
<span class="nc" id="L594">            managementService.executeJob(job.getId());</span>
<span class="nc" id="L595">        }</span>
<span class="nc" id="L596">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(3);</span>
<span class="nc" id="L597">        assertThat(taskService.createTaskQuery().count()).isEqualTo(3);</span>

<span class="nc" id="L599">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().orderByTaskName().asc().list();</span>
<span class="nc" id="L600">        List&lt;String&gt; names = Arrays.asList(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;);</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">        for (int i = 0; i &lt; tasks.size(); i++) {</span>
<span class="nc" id="L602">            assertThat(tasks.get(i).getName()).isEqualTo(&quot;Task in process &quot; + names.get(i));</span>
        }

        // Start a process with a signal boundary event
<span class="nc" id="L606">        runtimeService.startProcessInstanceByKey(&quot;processWithSignalCatch&quot;);</span>
<span class="nc" id="L607">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(4);</span>
<span class="nc" id="L608">        assertThat(taskService.createTaskQuery().count()).isEqualTo(4);</span>
<span class="nc" id="L609">        assertThat(taskService.createTaskQuery().taskName(&quot;Task in process D&quot;).count()).isEqualTo(1);</span>

        // Firing again
<span class="nc" id="L612">        runtimeService.startProcessInstanceByKey(&quot;processWithSignalThrow&quot;);</span>

<span class="nc" id="L614">        assertThat(managementService.createJobQuery().count()).isEqualTo(4);</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">        for (Job job : managementService.createJobQuery().list()) {</span>
<span class="nc" id="L616">            managementService.executeJob(job.getId());</span>
<span class="nc" id="L617">        }</span>
<span class="nc" id="L618">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(7);</span>
<span class="nc" id="L619">        assertThat(taskService.createTaskQuery().count()).isEqualTo(7);</span>
<span class="nc" id="L620">        assertThat(taskService.createTaskQuery().taskName(&quot;Task after signal&quot;).count()).isEqualTo(1);</span>

        // Cleanup
<span class="nc" id="L623">        cleanup();</span>

<span class="nc" id="L625">    }</span>

    @Test
    public void testSignalStartEventFromAPI() {

        // Deploy test processes
<span class="nc" id="L631">        repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTest.testSignalStartEvent.bpmn20.xml&quot;).deploy();</span>

<span class="nc" id="L633">        runtimeService.signalEventReceived(&quot;The Signal&quot;);</span>

        // Verify
<span class="nc" id="L636">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(3);</span>
<span class="nc" id="L637">        assertThat(taskService.createTaskQuery().count()).isEqualTo(3);</span>

<span class="nc" id="L639">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().orderByTaskName().asc().list();</span>
<span class="nc" id="L640">        List&lt;String&gt; names = Arrays.asList(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;);</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">        for (int i = 0; i &lt; tasks.size(); i++) {</span>
<span class="nc" id="L642">            assertThat(tasks.get(i).getName()).isEqualTo(&quot;Task in process &quot; + names.get(i));</span>
        }

        // Start a process with a signal boundary event
<span class="nc" id="L646">        runtimeService.startProcessInstanceByKey(&quot;processWithSignalCatch&quot;);</span>
<span class="nc" id="L647">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(4);</span>
<span class="nc" id="L648">        assertThat(taskService.createTaskQuery().count()).isEqualTo(4);</span>
<span class="nc" id="L649">        assertThat(taskService.createTaskQuery().taskName(&quot;Task in process D&quot;).count()).isEqualTo(1);</span>

        // Firing the signal should now trigger the one with the boundary event
        // too
<span class="nc" id="L653">        runtimeService.signalEventReceived(&quot;The Signal&quot;);</span>
<span class="nc" id="L654">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(7);</span>
<span class="nc" id="L655">        assertThat(taskService.createTaskQuery().count()).isEqualTo(7);</span>
<span class="nc" id="L656">        assertThat(taskService.createTaskQuery().taskName(&quot;Task after signal&quot;).count()).isEqualTo(1);</span>

        // Cleanup
<span class="nc" id="L659">        cleanup();</span>

<span class="nc" id="L661">    }</span>

    @Test
    public void testSignalStartEventFromAPIAsync() {

        // Deploy test processes
<span class="nc" id="L667">        repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTest.testSignalStartEventAsync.bpmn20.xml&quot;).deploy();</span>

<span class="nc" id="L669">        runtimeService.signalEventReceivedAsync(&quot;The Signal&quot;);</span>

<span class="nc" id="L671">        assertThat(managementService.createJobQuery().count()).isEqualTo(3);</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">        for (Job job : managementService.createJobQuery().list()) {</span>
<span class="nc" id="L673">            managementService.executeJob(job.getId());</span>
<span class="nc" id="L674">        }</span>
<span class="nc" id="L675">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(3);</span>
<span class="nc" id="L676">        assertThat(taskService.createTaskQuery().count()).isEqualTo(3);</span>

<span class="nc" id="L678">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().orderByTaskName().asc().list();</span>
<span class="nc" id="L679">        List&lt;String&gt; names = Arrays.asList(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;);</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">        for (int i = 0; i &lt; tasks.size(); i++) {</span>
<span class="nc" id="L681">            assertThat(tasks.get(i).getName()).isEqualTo(&quot;Task in process &quot; + names.get(i));</span>
        }

        // Start a process with a signal boundary event
<span class="nc" id="L685">        runtimeService.startProcessInstanceByKey(&quot;processWithSignalCatch&quot;);</span>
<span class="nc" id="L686">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(4);</span>
<span class="nc" id="L687">        assertThat(taskService.createTaskQuery().count()).isEqualTo(4);</span>
<span class="nc" id="L688">        assertThat(taskService.createTaskQuery().taskName(&quot;Task in process D&quot;).count()).isEqualTo(1);</span>

        // Firing again
<span class="nc" id="L691">        runtimeService.signalEventReceivedAsync(&quot;The Signal&quot;);</span>

<span class="nc" id="L693">        assertThat(managementService.createJobQuery().count()).isEqualTo(4);</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">        for (Job job : managementService.createJobQuery().list()) {</span>
<span class="nc" id="L695">            managementService.executeJob(job.getId());</span>
<span class="nc" id="L696">        }</span>
<span class="nc" id="L697">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(7);</span>
<span class="nc" id="L698">        assertThat(taskService.createTaskQuery().count()).isEqualTo(7);</span>
<span class="nc" id="L699">        assertThat(taskService.createTaskQuery().taskName(&quot;Task after signal&quot;).count()).isEqualTo(1);</span>

        // Cleanup
<span class="nc" id="L702">        cleanup();</span>

<span class="nc" id="L704">    }</span>

    @Test
    @Deployment
    public void testEarlyFinishedProcess() {
<span class="nc" id="L709">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;callerProcess&quot;);</span>
<span class="nc" id="L710">        assertThat(processInstance.getId()).isNotNull();</span>
<span class="nc" id="L711">    }</span>

    @Test
    @Deployment
    public void testNoneEndEventAfterSignalInConcurrentProcess() {
<span class="nc" id="L716">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;my-process&quot;);</span>
<span class="nc" id="L717">        assertThat(processInstance).isNotNull();</span>

<span class="nc" id="L719">        org.flowable.task.api.Task task = taskService.createTaskQuery().taskDefinitionKey(&quot;usertask1&quot;).singleResult();</span>
<span class="nc" id="L720">        taskService.claim(task.getId(), &quot;user&quot;);</span>
<span class="nc" id="L721">        taskService.complete(task.getId());</span>
        
<span class="nc bnc" id="L723" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            // trigger history comment handling when necessary
        }

<span class="nc" id="L727">        task = taskService.createTaskQuery().singleResult();</span>

<span class="nc" id="L729">        assertThat(task.getTaskDefinitionKey()).isEqualTo(&quot;usertask2&quot;);</span>
<span class="nc" id="L730">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.catchAlertSignal.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.throwAlertSignal.bpmn20.xml&quot; })
    public void testSignalCatchSuspendedDefinition() {
<span class="nc" id="L736">        runtimeService.startProcessInstanceByKey(&quot;catchSignal&quot;);</span>

<span class="nc" id="L738">        assertThat(createEventSubscriptionQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L739">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L741">        repositoryService.suspendProcessDefinitionByKey(&quot;catchSignal&quot;);</span>

<span class="nc" id="L743">        runtimeService.startProcessInstanceByKey(&quot;throwSignal&quot;);</span>

<span class="nc" id="L745">        assertThat(createEventSubscriptionQuery().count()).isZero();</span>
<span class="nc" id="L746">        assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>
<span class="nc" id="L747">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.catchAlertSignal.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.throwAlertSignal.bpmn20.xml&quot; })
    public void testSignalCatchSuspendedDefinitionAndInstances() {
<span class="nc" id="L753">        runtimeService.startProcessInstanceByKey(&quot;catchSignal&quot;);</span>

<span class="nc" id="L755">        assertThat(createEventSubscriptionQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L756">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L758">        repositoryService.suspendProcessDefinitionByKey(&quot;catchSignal&quot;, true, null);</span>

<span class="nc" id="L760">        runtimeService.startProcessInstanceByKey(&quot;throwSignal&quot;);</span>

        // signal catch event is still there
<span class="nc" id="L763">        assertThat(createEventSubscriptionQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L764">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L766">        repositoryService.activateProcessDefinitionByKey(&quot;catchSignal&quot;, true, null);</span>

<span class="nc" id="L768">        runtimeService.startProcessInstanceByKey(&quot;throwSignal&quot;);</span>

        // now the signal catch event is gone
<span class="nc" id="L771">        assertThat(createEventSubscriptionQuery().count()).isZero();</span>
<span class="nc" id="L772">        assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>
<span class="nc" id="L773">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.catchAlertSignal.bpmn20.xml&quot;,
            &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTests.throwAlertSignal.bpmn20.xml&quot; })
    public void testSignalCatchSuspendedInstance() {
<span class="nc" id="L779">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;catchSignal&quot;);</span>

<span class="nc" id="L781">        assertThat(createEventSubscriptionQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L782">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L784">        runtimeService.suspendProcessInstanceById(processInstance.getId());</span>

<span class="nc" id="L786">        runtimeService.startProcessInstanceByKey(&quot;throwSignal&quot;);</span>

        // signal catch event is still there
<span class="nc" id="L789">        assertThat(createEventSubscriptionQuery().count()).isEqualTo(1);</span>
<span class="nc" id="L790">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(1);</span>

<span class="nc" id="L792">        runtimeService.activateProcessInstanceById(processInstance.getId());</span>

<span class="nc" id="L794">        runtimeService.startProcessInstanceByKey(&quot;throwSignal&quot;);</span>

        // now the signal catch event is gone
<span class="nc" id="L797">        assertThat(createEventSubscriptionQuery().count()).isZero();</span>
<span class="nc" id="L798">        assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>
<span class="nc" id="L799">    }</span>

    @Test
    public void testSignalStartEventWithSuspendedDefinition() {

<span class="nc" id="L804">        repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTest.testSignalStartEvent.bpmn20.xml&quot;).deploy();</span>

<span class="nc" id="L806">        repositoryService.suspendProcessDefinitionByKey(&quot;processWithSignalStart1&quot;);</span>

<span class="nc" id="L808">        assertThatThrownBy(() -&gt; runtimeService.startProcessInstanceByKey(&quot;processWithSignalThrow&quot;))</span>
<span class="nc" id="L809">                .as(&quot;Suspended process definition should fail&quot;)</span>
<span class="nc" id="L810">                .isExactlyInstanceOf(FlowableException.class);</span>

        // Verify
<span class="nc" id="L813">        assertThat(runtimeService.createProcessInstanceQuery().count()).isZero();</span>

<span class="nc" id="L815">        repositoryService.activateProcessDefinitionByKey(&quot;processWithSignalStart1&quot;);</span>

        // Starting the process that fires the signal should start three process
        // instances that are listening on that signal
<span class="nc" id="L819">        runtimeService.startProcessInstanceByKey(&quot;processWithSignalThrow&quot;);</span>

        // Verify
<span class="nc" id="L822">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(3);</span>
<span class="nc" id="L823">        assertThat(taskService.createTaskQuery().count()).isEqualTo(3);</span>

        // Cleanup
<span class="nc" id="L826">        cleanup();</span>

<span class="nc" id="L828">    }</span>

    /**
     * Test case for https://activiti.atlassian.net/browse/ACT-1978
     */
    @Test
    public void testSignalDeleteOnRedeploy() {

        // Deploy test processes
<span class="nc" id="L837">        repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTest.testSignalStartEvent.bpmn20.xml&quot;).deploy();</span>

        // Deploy new versions
<span class="nc" id="L840">        repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTest.testSignalStartEvent.bpmn20.xml&quot;).deploy();</span>
<span class="nc" id="L841">        repositoryService.createDeployment().addClasspathResource(&quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTest.testSignalStartEvent.bpmn20.xml&quot;).deploy();</span>

        // Firing a signal start event should only start ONE process instance
        // This used to be two, due to subscriptions not being cleaned up
<span class="nc" id="L845">        runtimeService.signalEventReceived(&quot;The Signal&quot;);</span>
<span class="nc" id="L846">        assertThat(runtimeService.createProcessInstanceQuery().count()).isEqualTo(3);</span>
<span class="nc" id="L847">        cleanup();</span>

<span class="nc" id="L849">    }</span>

    @Test
    public void testRedeployWithRuntimeEventSubscription() {
<span class="nc" id="L853">        org.flowable.engine.repository.Deployment deployment1 = repositoryService.createDeployment()</span>
<span class="nc" id="L854">            .addClasspathResource(&quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTest.testSignalBoundaryOnSubProcess.bpmn20.xml&quot;).deploy();</span>
<span class="nc" id="L855">        ProcessDefinition processDefinition1 = repositoryService.createProcessDefinitionQuery().deploymentId(deployment1.getId()).singleResult();</span>

<span class="nc" id="L857">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(processDefinition1.getId());</span>

<span class="nc" id="L859">        assertThat(runtimeService.createEventSubscriptionQuery().list())</span>
<span class="nc" id="L860">            .extracting(EventSubscription::getEventType, EventSubscription::getProcessDefinitionId, EventSubscription::getProcessInstanceId)</span>
<span class="nc" id="L861">            .containsOnly(tuple(SignalEventSubscriptionEntity.EVENT_TYPE, processDefinition1.getId(), processInstance.getId()));</span>

<span class="nc" id="L863">        org.flowable.engine.repository.Deployment deployment2 = repositoryService.createDeployment()</span>
<span class="nc" id="L864">            .addClasspathResource(&quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTest.testSignalBoundaryOnSubProcess.bpmn20.xml&quot;).deploy();</span>
<span class="nc" id="L865">        ProcessDefinition processDefinition2 = repositoryService.createProcessDefinitionQuery().deploymentId(deployment1.getId()).singleResult();</span>

<span class="nc" id="L867">        assertThat(runtimeService.createEventSubscriptionQuery().list())</span>
<span class="nc" id="L868">            .extracting(EventSubscription::getEventType, EventSubscription::getProcessDefinitionId, EventSubscription::getProcessInstanceId)</span>
<span class="nc" id="L869">            .containsOnly(tuple(SignalEventSubscriptionEntity.EVENT_TYPE, processDefinition1.getId(), processInstance.getId())); // definition should have remained the same</span>

<span class="nc" id="L871">        cleanup();</span>
<span class="nc" id="L872">    }</span>

    @Test
    @Deployment
    public void testSignalWaitOnUserTaskBoundaryEvent() {
<span class="nc" id="L877">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;signal-wait&quot;);</span>
<span class="nc" id="L878">        Execution execution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).signalEventSubscriptionName(&quot;waitsig&quot;).singleResult();</span>
<span class="nc" id="L879">        assertThat(execution).isNotNull();</span>
<span class="nc" id="L880">        runtimeService.signalEventReceived(&quot;waitsig&quot;, execution.getId());</span>
<span class="nc" id="L881">        execution = runtimeService.createExecutionQuery().processInstanceId(processInstance.getId()).signalEventSubscriptionName(&quot;waitsig&quot;).singleResult();</span>
<span class="nc" id="L882">        assertThat(execution).isNull();</span>
<span class="nc" id="L883">        org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L884">        assertThat(task).isNotNull();</span>
<span class="nc" id="L885">        assertThat(task.getName()).isEqualTo(&quot;Wait2&quot;);</span>
<span class="nc" id="L886">    }</span>

    /**
     * From https://forums.activiti.org/content/boundary-signal-causes-already-taking-transition
     */
    @Test
    @Deployment
    public void testSignalThrowAndCatchInSameTransaction() {

<span class="nc" id="L895">        String fileExistsVar = &quot;fileexists&quot;;</span>

        // remove mock file
<span class="nc" id="L898">        FileExistsMock.getInstance().removeFile();</span>

        // create first instance
<span class="nc" id="L901">        ProcessInstance firstProcessInstance = runtimeService.startProcessInstanceByKey(&quot;signalBoundaryProcess&quot;);</span>
<span class="nc" id="L902">        assertThat(firstProcessInstance).isNotNull();</span>

        // task should be &quot;add a file&quot;
<span class="nc" id="L905">        org.flowable.task.api.Task firstTask = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L906">        assertThat(firstTask.getName()).isEqualTo(&quot;Add a file&quot;);</span>

<span class="nc" id="L908">        Map&lt;String, Object&gt; vars = runtimeService.getVariables(firstTask.getExecutionId());</span>
        // file does not exists
<span class="nc" id="L910">        assertThat(vars)</span>
<span class="nc" id="L911">                .containsEntry(fileExistsVar, false);</span>

        // create second instance
<span class="nc" id="L914">        ProcessInstance secondProcessInstance = runtimeService.startProcessInstanceByKey(&quot;signalBoundaryProcess&quot;);</span>
<span class="nc" id="L915">        assertThat(secondProcessInstance).isNotNull();</span>

        // there should be two open tasks
<span class="nc" id="L918">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().list();</span>
<span class="nc" id="L919">        assertThat(tasks).hasSize(2);</span>

        // get current second task
<span class="nc" id="L922">        org.flowable.task.api.Task secondTask = taskService.createTaskQuery().processInstanceId(secondProcessInstance.getProcessInstanceId()).singleResult();</span>
        // must be also in &quot;add a file&quot;
<span class="nc" id="L924">        assertThat(secondTask.getName()).isEqualTo(&quot;Add a file&quot;);</span>

        // file does not exists yet
<span class="nc" id="L927">        vars = runtimeService.getVariables(secondTask.getExecutionId());</span>
<span class="nc" id="L928">        assertThat(vars)</span>
<span class="nc" id="L929">                .containsEntry(fileExistsVar, false);</span>

        // now, we &quot;add a file&quot;
<span class="nc" id="L932">        taskService.claim(firstTask.getId(), &quot;user&quot;);</span>
        // create the file
<span class="nc" id="L934">        FileExistsMock.getInstance().touchFile();</span>
        
<span class="nc" id="L936">        taskService.complete(firstTask.getId());</span>
        
<span class="nc bnc" id="L938" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.ACTIVITY, processEngineConfiguration)) {</span>
            // trigger history comment handling when necessary
        }

<span class="nc" id="L942">        List&lt;org.flowable.task.api.Task&gt; usingTask = taskService.createTaskQuery().taskName(&quot;Use the file&quot;).list();</span>
<span class="nc" id="L943">        assertThat(usingTask).hasSize(1);</span>
<span class="nc" id="L944">    }</span>

    @Test
    @Deployment
    public void testMultipleSignalStartEvents() {
<span class="nc" id="L949">        runtimeService.signalEventReceived(&quot;signal1&quot;);</span>
<span class="nc" id="L950">        validateTaskCounts(1, 0, 0);</span>

<span class="nc" id="L952">        runtimeService.signalEventReceived(&quot;signal2&quot;);</span>
<span class="nc" id="L953">        validateTaskCounts(1, 1, 0);</span>

<span class="nc" id="L955">        runtimeService.signalEventReceived(&quot;signal3&quot;);</span>
<span class="nc" id="L956">        validateTaskCounts(1, 1, 1);</span>

<span class="nc" id="L958">        runtimeService.signalEventReceived(&quot;signal1&quot;);</span>
<span class="nc" id="L959">        validateTaskCounts(2, 1, 1);</span>

<span class="nc" id="L961">        runtimeService.signalEventReceived(&quot;signal1&quot;);</span>
<span class="nc" id="L962">        validateTaskCounts(3, 1, 1);</span>

<span class="nc" id="L964">        runtimeService.signalEventReceived(&quot;signal3&quot;);</span>
<span class="nc" id="L965">        validateTaskCounts(3, 1, 2);</span>
<span class="nc" id="L966">    }</span>
    
    @Test
    @Deployment
    public void testSingleSignalCatchAfterEventGateway() {
<span class="nc" id="L971">        String processInstanceId = runtimeService.startProcessInstanceByKey(&quot;testSignalAfterEventGateway&quot;).getId();</span>
<span class="nc" id="L972">        assertThat(runtimeService.createEventSubscriptionQuery().processInstanceId(processInstanceId).count()).isEqualTo(1);</span>
<span class="nc" id="L973">        runtimeService.signalEventReceived(&quot;mySignal&quot;);</span>
        
<span class="nc" id="L975">        assertThat(taskService.createTaskQuery().processInstanceId(processInstanceId).count()).isEqualTo(1);</span>
<span class="nc" id="L976">    }</span>

    @Test
    @Deployment
    public void testSignalExpression() {
<span class="nc" id="L981">        assertSignalEventSubscriptions(&quot;startSignal&quot;);</span>

<span class="nc" id="L983">        runtimeService.signalEventReceived(&quot;startSignal&quot;, CollectionUtil.singletonMap(&quot;catchSignal&quot;, &quot;actualCatchSignalValue&quot;));</span>
<span class="nc" id="L984">        assertSignalEventSubscriptions(&quot;actualCatchSignalValue&quot;, &quot;eventSubprocessSignal&quot;, &quot;startSignal&quot;);</span>

<span class="nc" id="L986">        Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="nc" id="L987">        vars.put(&quot;throwSignal&quot;, &quot;eventSubprocessSignal&quot;);</span>
<span class="nc" id="L988">        vars.put(&quot;boundarySignal&quot;, &quot;actualBoundarySignalValue&quot;);</span>
<span class="nc" id="L989">        runtimeService.signalEventReceived(&quot;actualCatchSignalValue&quot;, vars);</span>

<span class="nc" id="L991">        List&lt;Task&gt; tasks = taskService.createTaskQuery().orderByTaskName().asc().list();</span>
<span class="nc" id="L992">        assertThat(tasks)</span>
<span class="nc" id="L993">                .extracting(Task::getName)</span>
<span class="nc" id="L994">                .containsExactly(&quot;T1&quot;, &quot;T3&quot;);</span>

<span class="nc" id="L996">        assertSignalEventSubscriptions(&quot;actualBoundarySignalValue&quot;, &quot;eventSubprocessSignal&quot;, &quot;startSignal&quot;);</span>
<span class="nc" id="L997">        runtimeService.signalEventReceived(&quot;actualBoundarySignalValue&quot;);</span>
<span class="nc" id="L998">    }</span>

    @Test
    @Deployment
    public void testSignalSubscriptionsRecreatedOnDeploymentDelete() {
<span class="nc" id="L1003">        runtimeService.signalEventReceived(&quot;The Signal&quot;);</span>
<span class="nc" id="L1004">        Task task = taskService.createTaskQuery().singleResult();</span>
<span class="nc" id="L1005">        assertThat(task.getName()).isEqualTo(&quot;Task in process A&quot;);</span>

<span class="nc" id="L1007">        String deploymentId = repositoryService.createDeployment()</span>
<span class="nc" id="L1008">                .addClasspathResource(</span>
                        &quot;org/flowable/engine/test/bpmn/event/signal/SignalEventTest.testSignalSubscriptionsRecreatedOnDeploymentDeleteV2.bpmn20.xml&quot;)
<span class="nc" id="L1010">                .deploy()</span>
<span class="nc" id="L1011">                .getId();</span>

<span class="nc" id="L1013">        runtimeService.signalEventReceived(&quot;The Signal&quot;);</span>

<span class="nc" id="L1015">        assertThat(taskService.createTaskQuery().list())</span>
<span class="nc" id="L1016">                .extracting(Task::getName)</span>
<span class="nc" id="L1017">                .containsExactlyInAnyOrder(</span>
                        &quot;Task in process A&quot;,
                        &quot;Task in process A v2&quot;
                );

<span class="nc" id="L1022">        repositoryService.deleteDeployment(deploymentId, true);</span>

<span class="nc" id="L1024">        assertThat(taskService.createTaskQuery().list())</span>
<span class="nc" id="L1025">                .extracting(Task::getName)</span>
<span class="nc" id="L1026">                .containsExactlyInAnyOrder(</span>
                        &quot;Task in process A&quot;
                );

<span class="nc" id="L1030">        runtimeService.signalEventReceived(&quot;The Signal&quot;);</span>

<span class="nc" id="L1032">        assertThat(taskService.createTaskQuery().list())</span>
<span class="nc" id="L1033">                .extracting(Task::getName)</span>
<span class="nc" id="L1034">                .containsExactlyInAnyOrder(</span>
                        &quot;Task in process A&quot;,
                        &quot;Task in process A&quot;
                );
<span class="nc" id="L1038">    }</span>

    @Test
    @Deployment
    public void testSignalPublishExecutionEndListener() {
<span class="nc" id="L1043">        ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span>
<span class="nc" id="L1044">                .variable(&quot;throwSignal&quot;, &quot;alertSignal&quot;)</span>
<span class="nc" id="L1045">                .processDefinitionKey(&quot;signalProcess&quot;).start();</span>
<span class="nc" id="L1046">        assertThat(processInstance.getProcessVariables()).containsEntry(&quot;script_task_executed&quot;, &quot;true&quot;).containsEntry(&quot;signal_handled&quot;, &quot;true&quot;);</span>

<span class="nc bnc" id="L1048" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoryLevelAtLeast(HistoryLevel.AUDIT, processEngineConfiguration)) {</span>
<span class="nc" id="L1049">            HistoricActivityInstance scriptTask = historyService.createHistoricActivityInstanceQuery().processInstanceId(processInstance.getId())</span>
<span class="nc" id="L1050">                    .activityId(&quot;scriptTask1&quot;).singleResult();</span>
<span class="nc" id="L1051">            assertThat(scriptTask.getEndTime()).isNotNull();</span>
        }
<span class="nc" id="L1053">    }</span>


    protected void assertSignalEventSubscriptions(String ... names) {
<span class="nc" id="L1057">        Tuple[] tuples = new Tuple[names.length];</span>
<span class="nc bnc" id="L1058" title="All 2 branches missed.">        for (int i = 0; i &lt; names.length; i++) {</span>
<span class="nc" id="L1059">            tuples[i] = Tuple.tuple(SignalEventSubscriptionEntity.EVENT_TYPE, names[i]);</span>
        }

<span class="nc" id="L1062">        assertThat(runtimeService.createEventSubscriptionQuery().orderByEventName().asc().list())</span>
<span class="nc" id="L1063">            .extracting(EventSubscription::getEventType, EventSubscription::getEventName)</span>
<span class="nc" id="L1064">            .containsOnly(tuples);</span>
<span class="nc" id="L1065">    }</span>

    private void validateTaskCounts(long taskACount, long taskBCount, long taskCCount) {
<span class="nc" id="L1068">        assertThat(taskService.createTaskQuery().taskName(&quot;Task A&quot;).count()).isEqualTo(taskACount);</span>
<span class="nc" id="L1069">        assertThat(taskService.createTaskQuery().taskName(&quot;Task B&quot;).count()).isEqualTo(taskBCount);</span>
<span class="nc" id="L1070">        assertThat(taskService.createTaskQuery().taskName(&quot;Task C&quot;).count()).isEqualTo(taskCCount);</span>
<span class="nc" id="L1071">    }</span>

    protected void cleanup() {
<span class="nc bnc" id="L1074" title="All 2 branches missed.">        for (org.flowable.engine.repository.Deployment deployment : repositoryService.createDeploymentQuery().list()) {</span>
<span class="nc" id="L1075">            repositoryService.deleteDeployment(deployment.getId(), true);</span>
<span class="nc" id="L1076">        }</span>
<span class="nc" id="L1077">    }</span>


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>