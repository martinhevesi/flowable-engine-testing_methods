<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HistoryServiceTaskLogTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">org.flowable.engine.test.api.history</a> &gt; <span class="el_source">HistoryServiceTaskLogTest.java</span></div><h1>HistoryServiceTaskLogTest.java</h1><pre class="source lang-java linenums">/* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.flowable.engine.test.api.history;

import static net.javacrumbs.jsonunit.assertj.JsonAssertions.assertThatJson;
import static org.assertj.core.api.Assertions.assertThat;

import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.List;
import java.util.function.Consumer;

import org.flowable.common.engine.impl.identity.Authentication;
import org.flowable.common.engine.impl.interceptor.Command;
import org.flowable.common.engine.impl.interceptor.CommandContext;
import org.flowable.engine.impl.cfg.ProcessEngineConfigurationImpl;
import org.flowable.engine.impl.test.HistoryTestHelper;
import org.flowable.engine.runtime.ProcessInstance;
import org.flowable.engine.test.Deployment;
import org.flowable.engine.test.impl.CustomConfigurationFlowableTestCase;
import org.flowable.identitylink.api.IdentityLinkType;
import org.flowable.job.api.HistoryJob;
import org.flowable.job.service.HistoryJobService;
import org.flowable.job.service.impl.HistoryJobQueryImpl;
import org.flowable.job.service.impl.persistence.entity.HistoryJobEntity;
import org.flowable.task.api.Task;
import org.flowable.task.api.history.HistoricTaskLogEntry;
import org.flowable.task.api.history.HistoricTaskLogEntryBuilder;
import org.flowable.task.api.history.HistoricTaskLogEntryQuery;
import org.flowable.task.service.impl.HistoricTaskLogEntryQueryImpl;
import org.flowable.task.service.impl.persistence.entity.HistoricTaskLogEntryEntity;
import org.flowable.task.service.impl.persistence.entity.HistoricTaskLogEntryEntityManager;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.Test;

/**
 * @author martin.grofcik
 */
public class HistoryServiceTaskLogTest extends CustomConfigurationFlowableTestCase {

<span class="nc" id="L53">    private SimpleDateFormat simpleDateFormat = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm&quot;);</span>

    protected Task task;

    public HistoryServiceTaskLogTest() {
<span class="nc" id="L58">        super(HistoryServiceTaskLogTest.class.getName());</span>
<span class="nc" id="L59">    }</span>

    @Override
    protected void configureConfiguration(ProcessEngineConfigurationImpl processEngineConfiguration) {
<span class="nc" id="L63">        processEngineConfiguration.setEnableHistoricTaskLogging(true);</span>
<span class="nc" id="L64">    }</span>

    @AfterEach
    public void deleteTasks() {
<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (task != null) {</span>
<span class="nc" id="L69">            deleteTaskWithLogEntries(task.getId());</span>
        }
<span class="nc" id="L71">    }</span>

    protected void deleteTaskWithLogEntries(String taskId) {
<span class="nc" id="L74">        taskService.deleteTask(taskId, true);</span>
<span class="nc" id="L75">        managementService.executeCommand(new Command&lt;Void&gt;() {</span>

            @Override
            public Void execute(CommandContext commandContext) {
<span class="nc" id="L79">                ProcessEngineConfigurationImpl processEngineConfigurationImpl = (ProcessEngineConfigurationImpl) processEngineConfiguration;</span>
<span class="nc" id="L80">                HistoricTaskLogEntryEntityManager historicTaskLogEntryEntityManager = processEngineConfigurationImpl.getTaskServiceConfiguration()</span>
<span class="nc" id="L81">                        .getHistoricTaskLogEntryEntityManager();</span>
<span class="nc" id="L82">                List&lt;HistoricTaskLogEntry&gt; taskLogEntries = historicTaskLogEntryEntityManager</span>
<span class="nc" id="L83">                        .findHistoricTaskLogEntriesByQueryCriteria(new HistoricTaskLogEntryQueryImpl(processEngineConfiguration.getCommandExecutor(), </span>
<span class="nc" id="L84">                                processEngineConfigurationImpl.getTaskServiceConfiguration()));</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                for (HistoricTaskLogEntry historicTaskLogEntry : taskLogEntries) {</span>
<span class="nc" id="L86">                    historicTaskLogEntryEntityManager.deleteHistoricTaskLogEntry(historicTaskLogEntry.getLogNumber());</span>
<span class="nc" id="L87">                }</span>
                
<span class="nc" id="L89">                HistoryJobService historyJobService = processEngineConfigurationImpl.getJobServiceConfiguration().getHistoryJobService();</span>
<span class="nc" id="L90">                List&lt;HistoryJob&gt; jobs = historyJobService.findHistoryJobsByQueryCriteria(new HistoryJobQueryImpl(commandContext, processEngineConfigurationImpl.getJobServiceConfiguration()));</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">                for (HistoryJob historyJob : jobs) {</span>
<span class="nc" id="L92">                    historyJobService.deleteHistoryJob((HistoryJobEntity) historyJob);</span>
<span class="nc" id="L93">                }</span>

<span class="nc" id="L95">                return null;</span>
            }
        });
<span class="nc" id="L98">    }</span>

    @Test
    public void createTaskEvent() {
<span class="nc" id="L102">        task = taskService.createTaskBuilder().</span>
<span class="nc" id="L103">                assignee(&quot;testAssignee&quot;).</span>
<span class="nc" id="L104">                create();</span>

        try {
<span class="nc bnc" id="L107" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L108">                List&lt;HistoricTaskLogEntry&gt; taskLogsByTaskInstanceId = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L109">                assertThat(taskLogsByTaskInstanceId).hasSize(1);</span>

<span class="nc" id="L111">                assertThat(taskLogsByTaskInstanceId.get(0)).</span>
<span class="nc" id="L112">                        extracting(HistoricTaskLogEntry::getTaskId)</span>
<span class="nc" id="L113">                        .isEqualTo(task.getId());</span>
<span class="nc" id="L114">                assertThat(taskLogsByTaskInstanceId.get(0)).</span>
<span class="nc" id="L115">                        extracting(HistoricTaskLogEntry::getType)</span>
<span class="nc" id="L116">                        .isEqualTo(&quot;USER_TASK_CREATED&quot;);</span>
<span class="nc" id="L117">                assertThat(taskLogsByTaskInstanceId.get(0)).</span>
<span class="nc" id="L118">                        extracting(HistoricTaskLogEntry::getTimeStamp)</span>
<span class="nc" id="L119">                        .isNotNull();</span>
<span class="nc" id="L120">                assertThat(taskLogsByTaskInstanceId.get(0)).</span>
<span class="nc" id="L121">                        extracting(HistoricTaskLogEntry::getUserId)</span>
<span class="nc" id="L122">                        .isNull();</span>
            }

        } finally {
<span class="nc" id="L126">            taskService.deleteTask(task.getId());</span>
        }
<span class="nc" id="L128">    }</span>

    @Test
    public void createTaskEventAsAuthenticatedUser() {
<span class="nc" id="L132">        String previousUserId = Authentication.getAuthenticatedUserId();</span>
<span class="nc" id="L133">        Authentication.setAuthenticatedUserId(&quot;testUser&quot;);</span>
        try {
<span class="nc" id="L135">            task = taskService.createTaskBuilder().</span>
<span class="nc" id="L136">                    assignee(&quot;testAssignee&quot;).</span>
<span class="nc" id="L137">                    create();</span>

<span class="nc bnc" id="L139" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L140">                List&lt;HistoricTaskLogEntry&gt; taskLogsByTaskInstanceId = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L141">                assertThat(taskLogsByTaskInstanceId).hasSize(1);</span>

<span class="nc" id="L143">                assertThat(taskLogsByTaskInstanceId.get(0)).</span>
<span class="nc" id="L144">                        extracting(HistoricTaskLogEntry::getUserId)</span>
<span class="nc" id="L145">                        .isEqualTo(&quot;testUser&quot;);</span>
            }

        } finally {
<span class="nc" id="L149">            Authentication.setAuthenticatedUserId(previousUserId);</span>
        }
<span class="nc" id="L151">    }</span>

    @Test
    public void queryForNonExistingTaskLogEntries() {
<span class="nc" id="L155">        task = taskService.createTaskBuilder().create();</span>

<span class="nc" id="L157">        List&lt;HistoricTaskLogEntry&gt; taskLogsByTaskInstanceId = historyService.createHistoricTaskLogEntryQuery().taskId(&quot;NON-EXISTING-TASK-ID&quot;).list();</span>

<span class="nc" id="L159">        assertThat(taskLogsByTaskInstanceId).isEmpty();</span>
<span class="nc" id="L160">    }</span>

    @Test
    public void queryForNullTaskLogEntries_returnsAll() {

<span class="nc" id="L165">        Task taskA = taskService.createTaskBuilder().create();</span>
<span class="nc" id="L166">        Task taskB = taskService.createTaskBuilder().create();</span>
<span class="nc" id="L167">        Task taskC = taskService.createTaskBuilder().create();</span>

        try {
<span class="nc bnc" id="L170" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L171">                List&lt;HistoricTaskLogEntry&gt; taskLogsByTaskInstanceId = historyService.createHistoricTaskLogEntryQuery().taskId(null).list();</span>
<span class="nc" id="L172">                assertThat(taskLogsByTaskInstanceId).hasSize(3);</span>
            }

        } finally {
<span class="nc" id="L176">            deleteTaskWithLogEntries(taskC.getId());</span>
<span class="nc" id="L177">            deleteTaskWithLogEntries(taskB.getId());</span>
<span class="nc" id="L178">            deleteTaskWithLogEntries(taskA.getId());</span>
        }
<span class="nc" id="L180">    }</span>

    @Test
    public void deleteTaskEventLogEntry() {
<span class="nc" id="L184">        task = taskService.createTaskBuilder().</span>
<span class="nc" id="L185">                assignee(&quot;testAssignee&quot;).</span>
<span class="nc" id="L186">                create();</span>

<span class="nc bnc" id="L188" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L189">            List&lt;HistoricTaskLogEntry&gt; taskLogsByTaskInstanceId = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L190">            assertThat(taskLogsByTaskInstanceId).hasSize(1);</span>

<span class="nc" id="L192">            historyService.deleteHistoricTaskLogEntry(taskLogsByTaskInstanceId.get(0).getLogNumber());</span>

<span class="nc" id="L194">            HistoryTestHelper.waitForJobExecutorToProcessAllHistoryJobs(processEngineConfiguration, managementService, 5000, 200);</span>
<span class="nc" id="L195">            taskLogsByTaskInstanceId = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L196">            assertThat(taskLogsByTaskInstanceId).isEmpty();</span>
        }
<span class="nc" id="L198">    }</span>

    @Test
    public void deleteNonExistingTaskEventLogEntry() {
<span class="nc" id="L202">        task = taskService.createTaskBuilder().create();</span>

<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
            // non existing log entry delete should be successful
<span class="nc" id="L206">            historyService.deleteHistoricTaskLogEntry(Long.MIN_VALUE);</span>

<span class="nc" id="L208">            assertThat(historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list()).hasSize(1);</span>
        }
<span class="nc" id="L210">    }</span>

    @Test
    public void taskAssigneeEvent() {
<span class="nc" id="L214">        task = taskService.createTaskBuilder().</span>
<span class="nc" id="L215">                assignee(&quot;initialAssignee&quot;).</span>
<span class="nc" id="L216">                create();</span>

<span class="nc" id="L218">        taskService.setAssignee(task.getId(), &quot;newAssignee&quot;);</span>

<span class="nc bnc" id="L220" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L221">            List&lt;HistoricTaskLogEntry&gt; taskLogEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L222">            assertThat(taskLogEntries).hasSize(2);</span>

<span class="nc" id="L224">            taskLogEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).type(&quot;USER_TASK_ASSIGNEE_CHANGED&quot;).list();</span>
<span class="nc" id="L225">            assertThat(taskLogEntries).hasSize(1);</span>
<span class="nc" id="L226">            assertThatJson(taskLogEntries.get(0).getData())</span>
<span class="nc" id="L227">                    .isEqualTo(&quot;{ newAssigneeId: 'newAssignee', previousAssigneeId: 'initialAssignee' }&quot;);</span>
<span class="nc" id="L228">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getTimeStamp).isNotNull();</span>
<span class="nc" id="L229">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getTaskId).isEqualTo(task.getId());</span>
<span class="nc" id="L230">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getUserId).isNull();</span>
<span class="nc" id="L231">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getType).isEqualTo(&quot;USER_TASK_ASSIGNEE_CHANGED&quot;);</span>
        }
<span class="nc" id="L233">    }</span>

    @Test
    public void changeAssigneeTaskEventAsAuthenticatedUser() {
<span class="nc" id="L237">        assertThatAuthenticatedUserIsSet(taskId -&gt; taskService.setAssignee(taskId, &quot;newAssignee&quot;));</span>
<span class="nc" id="L238">    }</span>

    @Test
    public void taskOwnerEvent() {
<span class="nc" id="L242">        task = taskService.createTaskBuilder().</span>
<span class="nc" id="L243">                assignee(&quot;initialAssignee&quot;).</span>
<span class="nc" id="L244">                create();</span>

<span class="nc" id="L246">        taskService.setOwner(task.getId(), &quot;newOwner&quot;);</span>

<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L249">            List&lt;HistoricTaskLogEntry&gt; taskLogEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L250">            assertThat(taskLogEntries).hasSize(2);</span>

<span class="nc" id="L252">            taskLogEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).type(&quot;USER_TASK_OWNER_CHANGED&quot;).list();</span>
<span class="nc" id="L253">            assertThat(taskLogEntries).hasSize(1);</span>
<span class="nc" id="L254">            assertThatJson(taskLogEntries.get(0).getData())</span>
<span class="nc" id="L255">                    .isEqualTo(&quot;{ previousOwnerId: null, newOwnerId: 'newOwner' }&quot;);</span>
<span class="nc" id="L256">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getTimeStamp).isNotNull();</span>
<span class="nc" id="L257">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getTaskId).isEqualTo(task.getId());</span>
<span class="nc" id="L258">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getUserId).isNull();</span>
<span class="nc" id="L259">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getType).isEqualTo(&quot;USER_TASK_OWNER_CHANGED&quot;);</span>
        }
<span class="nc" id="L261">    }</span>

    @Test
    public void changeOwnerTaskEventAsAuthenticatedUser() {
<span class="nc" id="L265">        assertThatAuthenticatedUserIsSet(taskId -&gt; taskService.setOwner(taskId, &quot;newOwner&quot;));</span>
<span class="nc" id="L266">    }</span>

    @Test
    public void claimTaskEvent() {
<span class="nc" id="L270">        task = taskService.createTaskBuilder().create();</span>

<span class="nc" id="L272">        taskService.claim(task.getId(), &quot;testUser&quot;);</span>

<span class="nc bnc" id="L274" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L275">            List&lt;HistoricTaskLogEntry&gt; taskLogEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L276">            assertThat(taskLogEntries).hasSize(2);</span>

<span class="nc" id="L278">            taskLogEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).type(&quot;USER_TASK_ASSIGNEE_CHANGED&quot;).list();</span>
<span class="nc" id="L279">            assertThat(taskLogEntries).hasSize(1);</span>
<span class="nc" id="L280">            assertThatJson(taskLogEntries.get(0).getData())</span>
<span class="nc" id="L281">                    .isEqualTo(&quot;{ newAssigneeId: 'testUser', previousAssigneeId: null }&quot;);</span>
<span class="nc" id="L282">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getTimeStamp).isNotNull();</span>
<span class="nc" id="L283">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getTaskId).isEqualTo(task.getId());</span>
<span class="nc" id="L284">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getUserId).isNull();</span>
<span class="nc" id="L285">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getType).isEqualTo(&quot;USER_TASK_ASSIGNEE_CHANGED&quot;);</span>
        }
<span class="nc" id="L287">    }</span>

    @Test
    public void unclaimTaskEvent() {
<span class="nc" id="L291">        task = taskService.createTaskBuilder().</span>
<span class="nc" id="L292">                assignee(&quot;initialAssignee&quot;).</span>
<span class="nc" id="L293">                create();</span>

<span class="nc" id="L295">        taskService.unclaim(task.getId());</span>

<span class="nc bnc" id="L297" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L298">            List&lt;HistoricTaskLogEntry&gt; taskLogEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L299">            assertThat(taskLogEntries).hasSize(2);</span>

<span class="nc" id="L301">            taskLogEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).type(&quot;USER_TASK_ASSIGNEE_CHANGED&quot;).list();</span>
<span class="nc" id="L302">            assertThat(taskLogEntries).hasSize(1);</span>
<span class="nc" id="L303">            assertThatJson(taskLogEntries.get(0).getData())</span>
<span class="nc" id="L304">                    .isEqualTo(&quot;{ newAssigneeId: null, previousAssigneeId: 'initialAssignee' }&quot;);</span>
<span class="nc" id="L305">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getTimeStamp).isNotNull();</span>
<span class="nc" id="L306">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getTaskId).isEqualTo(task.getId());</span>
<span class="nc" id="L307">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getUserId).isNull();</span>
<span class="nc" id="L308">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getType).isEqualTo(&quot;USER_TASK_ASSIGNEE_CHANGED&quot;);</span>
        }
<span class="nc" id="L310">    }</span>

    @Test
    public void changePriority() {
<span class="nc" id="L314">        task = taskService.createTaskBuilder().create();</span>
<span class="nc" id="L315">        taskService.setPriority(task.getId(), Integer.MAX_VALUE);</span>

<span class="nc bnc" id="L317" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L318">            List&lt;HistoricTaskLogEntry&gt; taskLogEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L319">            assertThat(taskLogEntries).hasSize(2);</span>

<span class="nc" id="L321">            taskLogEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).type(&quot;USER_TASK_PRIORITY_CHANGED&quot;).list();</span>
<span class="nc" id="L322">            assertThat(taskLogEntries).hasSize(1);</span>
<span class="nc" id="L323">            assertThatJson(taskLogEntries.get(0).getData())</span>
<span class="nc" id="L324">                    .isEqualTo(&quot;{ newPriority: 2147483647, previousPriority: 50 }&quot;);</span>
<span class="nc" id="L325">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getTimeStamp).isNotNull();</span>
<span class="nc" id="L326">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getTaskId).isEqualTo(task.getId());</span>
<span class="nc" id="L327">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getUserId).isNull();</span>
<span class="nc" id="L328">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getType).isEqualTo(&quot;USER_TASK_PRIORITY_CHANGED&quot;);</span>
        }
<span class="nc" id="L330">    }</span>

    @Test
    public void changePriorityEventAsAuthenticatedUser() {
<span class="nc" id="L334">        assertThatAuthenticatedUserIsSet(taskId -&gt; taskService.setPriority(taskId, Integer.MAX_VALUE));</span>
<span class="nc" id="L335">    }</span>

    protected void assertThatAuthenticatedUserIsSet(Consumer&lt;String&gt; functionToAssert) {

<span class="nc" id="L339">        String previousUserId = Authentication.getAuthenticatedUserId();</span>
<span class="nc" id="L340">        task = taskService.createTaskBuilder().</span>
<span class="nc" id="L341">                assignee(&quot;testAssignee&quot;).</span>
<span class="nc" id="L342">                create();</span>
<span class="nc" id="L343">        Authentication.setAuthenticatedUserId(&quot;testUser&quot;);</span>

        try {
<span class="nc" id="L346">            functionToAssert.accept(task.getId());</span>

<span class="nc bnc" id="L348" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L349">                List&lt;HistoricTaskLogEntry&gt; taskLogsByTaskInstanceId = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L350">                assertThat(taskLogsByTaskInstanceId).hasSize(2);</span>

<span class="nc" id="L352">                taskLogsByTaskInstanceId = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).userId(&quot;testUser&quot;).list();</span>
<span class="nc" id="L353">                assertThat(taskLogsByTaskInstanceId).hasSize(1);</span>
            }

        } finally {
<span class="nc" id="L357">            Authentication.setAuthenticatedUserId(previousUserId);</span>
        }
<span class="nc" id="L359">    }</span>

    @Test
    public void changeDueDate() {
<span class="nc" id="L363">        task = taskService.createTaskBuilder().create();</span>

<span class="nc" id="L365">        Date dueDate = new Date();</span>
<span class="nc" id="L366">        taskService.setDueDate(task.getId(), dueDate);</span>

<span class="nc bnc" id="L368" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L369">            List&lt;HistoricTaskLogEntry&gt; taskLogEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L370">            assertThat(taskLogEntries).hasSize(2);</span>

<span class="nc" id="L372">            taskLogEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).type(&quot;USER_TASK_DUEDATE_CHANGED&quot;).list();</span>
<span class="nc" id="L373">            assertThat(taskLogEntries).hasSize(1);</span>
<span class="nc" id="L374">            assertThatJson(taskLogEntries.get(0).getData())</span>
<span class="nc" id="L375">                    .isEqualTo(&quot;{ newDueDate: &quot; + dueDate.getTime() + &quot;, previousDueDate: null }&quot;);</span>
<span class="nc" id="L376">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getTimeStamp).isNotNull();</span>
<span class="nc" id="L377">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getTaskId).isEqualTo(task.getId());</span>
<span class="nc" id="L378">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getUserId).isNull();</span>
<span class="nc" id="L379">            assertThat(taskLogEntries.get(0)).extracting(HistoricTaskLogEntry::getType).isEqualTo(&quot;USER_TASK_DUEDATE_CHANGED&quot;);</span>
        }
<span class="nc" id="L381">    }</span>

    @Test
    public void saveTask() {
<span class="nc" id="L385">        task = taskService.createTaskBuilder().</span>
<span class="nc" id="L386">                create();</span>

<span class="nc" id="L388">        task.setName(&quot;newTaskName&quot;);</span>
<span class="nc" id="L389">        task.setAssignee(&quot;newAssignee&quot;);</span>
<span class="nc" id="L390">        task.setOwner(&quot;newOwner&quot;);</span>
<span class="nc" id="L391">        task.setPriority(Integer.MAX_VALUE);</span>
<span class="nc" id="L392">        task.setDueDate(new Date());</span>
<span class="nc" id="L393">        taskService.saveTask(task);</span>

<span class="nc bnc" id="L395" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L396">            List&lt;HistoricTaskLogEntry&gt; taskLogEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L397">            assertThat(taskLogEntries).as(&quot;The only event is user task created&quot;).hasSize(1);</span>
        }
<span class="nc" id="L399">    }</span>

    @Test
    public void changeDueDateEventAsAuthenticatedUser() {
<span class="nc" id="L403">        assertThatAuthenticatedUserIsSet(taskId -&gt; taskService.setDueDate(taskId, new Date()));</span>
<span class="nc" id="L404">    }</span>

    @Test
    public void createCustomTaskEventLog() {
<span class="nc" id="L408">        task = taskService.createTaskBuilder().create();</span>

<span class="nc" id="L410">        Date todayDate = new Date();</span>
<span class="nc" id="L411">        HistoricTaskLogEntryBuilder historicTaskLogEntryBuilder = historyService.createHistoricTaskLogEntryBuilder(task);</span>
<span class="nc" id="L412">        historicTaskLogEntryBuilder.timeStamp(todayDate);</span>
<span class="nc" id="L413">        historicTaskLogEntryBuilder.userId(&quot;testUser&quot;);</span>
<span class="nc" id="L414">        historicTaskLogEntryBuilder.type(&quot;customType&quot;);</span>
<span class="nc" id="L415">        historicTaskLogEntryBuilder.data(&quot;testData&quot;);</span>
<span class="nc" id="L416">        historicTaskLogEntryBuilder.create();</span>

<span class="nc bnc" id="L418" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L419">            List&lt;HistoricTaskLogEntry&gt; logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L420">            assertThat(logEntries).hasSize(2);</span>

<span class="nc" id="L422">            logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).type(&quot;customType&quot;).list();</span>
<span class="nc" id="L423">            assertThat(logEntries).hasSize(1);</span>
<span class="nc" id="L424">            HistoricTaskLogEntry historicTaskLogEntry = logEntries.get(0);</span>
<span class="nc" id="L425">            assertThat(historicTaskLogEntry.getLogNumber()).isNotNull();</span>
<span class="nc" id="L426">            assertThat(historicTaskLogEntry.getUserId()).isEqualTo(&quot;testUser&quot;);</span>
<span class="nc" id="L427">            assertThat(historicTaskLogEntry.getTaskId()).isEqualTo(task.getId());</span>
<span class="nc" id="L428">            assertThat(historicTaskLogEntry.getType()).isEqualTo(&quot;customType&quot;);</span>
<span class="nc" id="L429">            assertThat(simpleDateFormat.format(historicTaskLogEntry.getTimeStamp())).isEqualTo(simpleDateFormat.format(todayDate));</span>
<span class="nc" id="L430">            assertThat(historicTaskLogEntry.getData()).isEqualTo(&quot;testData&quot;);</span>
<span class="nc" id="L431">            historyService.deleteHistoricTaskLogEntry(historicTaskLogEntry.getLogNumber());</span>
        }
<span class="nc" id="L433">    }</span>

    @Test
    public void createCustomTaskEventLog_taskIdIsEnoughToCreateTaskLogEntry() {
<span class="nc" id="L437">        task = taskService.createTaskBuilder().create();</span>

<span class="nc" id="L439">        waitForHistoryJobExecutorToProcessAllJobs(20000, 200);</span>

<span class="nc" id="L441">        HistoricTaskLogEntryBuilder historicTaskLogEntryBuilder = historyService.createHistoricTaskLogEntryBuilder(task);</span>
<span class="nc" id="L442">        historicTaskLogEntryBuilder.create();</span>

<span class="nc bnc" id="L444" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L445">            List&lt;HistoricTaskLogEntry&gt; logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>

<span class="nc" id="L447">            assertThat(logEntries).hasSize(2);</span>
<span class="nc" id="L448">            HistoricTaskLogEntry historicTaskLogEntry = logEntries.get(1);</span>
<span class="nc" id="L449">            assertThat(historicTaskLogEntry.getLogNumber()).isNotNull();</span>
<span class="nc" id="L450">            assertThat(historicTaskLogEntry.getUserId()).isNull();</span>
<span class="nc" id="L451">            assertThat(historicTaskLogEntry.getTaskId()).isEqualTo(task.getId());</span>
<span class="nc" id="L452">            assertThat(historicTaskLogEntry.getType()).isNull();</span>
<span class="nc" id="L453">            assertThat(historicTaskLogEntry.getTimeStamp()).isNotNull();</span>
<span class="nc" id="L454">            assertThat(historicTaskLogEntry.getData()).isNull();</span>
        }
<span class="nc" id="L456">    }</span>

    @Test
    public void createCustomTaskEventLog_withoutTimeStamp_addsDefault() {
<span class="nc" id="L460">        task = taskService.createTaskBuilder().create();</span>

<span class="nc" id="L462">        HistoricTaskLogEntryBuilder historicTaskLogEntryBuilder = historyService.createHistoricTaskLogEntryBuilder(task);</span>
<span class="nc" id="L463">        historicTaskLogEntryBuilder.userId(&quot;testUser&quot;);</span>
<span class="nc" id="L464">        historicTaskLogEntryBuilder.type(&quot;customType&quot;);</span>
<span class="nc" id="L465">        historicTaskLogEntryBuilder.data(&quot;testData&quot;);</span>
<span class="nc" id="L466">        historicTaskLogEntryBuilder.create();</span>

<span class="nc bnc" id="L468" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L469">            List&lt;HistoricTaskLogEntry&gt; logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>

<span class="nc" id="L471">            assertThat(logEntries).hasSize(2);</span>
<span class="nc" id="L472">            HistoricTaskLogEntry historicTaskLogEntry = logEntries.get(1);</span>
<span class="nc" id="L473">            assertThat(historicTaskLogEntry.getLogNumber()).isNotNull();</span>
<span class="nc" id="L474">            assertThat(historicTaskLogEntry.getTimeStamp()).isNotNull();</span>
        }
<span class="nc" id="L476">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/oneTaskProcess.bpmn20.xml&quot; })
    public void logSuspensionStateEvents() {

<span class="nc" id="L482">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L483">        assertThat(processInstance).isNotNull();</span>

        try {
<span class="nc" id="L486">            runtimeService.suspendProcessInstanceById(processInstance.getId());</span>
<span class="nc" id="L487">            org.flowable.task.api.Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L488">            assertThat(task).isNotNull();</span>

<span class="nc bnc" id="L490" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L491">                List&lt;HistoricTaskLogEntry&gt; logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId())</span>
<span class="nc" id="L492">                        .type(&quot;USER_TASK_SUSPENSIONSTATE_CHANGED&quot;)</span>
<span class="nc" id="L493">                        .list();</span>
<span class="nc" id="L494">                assertThat(logEntries).hasSize(1);</span>

<span class="nc" id="L496">                logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L497">                assertThat(logEntries).hasSize(2);</span>
            }

<span class="nc" id="L500">            runtimeService.activateProcessInstanceById(processInstance.getId());</span>

<span class="nc" id="L502">            HistoryTestHelper.waitForJobExecutorToProcessAllHistoryJobs(processEngineConfiguration, managementService, 10000, 200);</span>
<span class="nc" id="L503">            List&lt;HistoricTaskLogEntry&gt; logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L504">            assertThat(logEntries).hasSize(3);</span>

<span class="nc" id="L506">            logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId())</span>
<span class="nc" id="L507">                    .type(&quot;USER_TASK_SUSPENSIONSTATE_CHANGED&quot;)</span>
<span class="nc" id="L508">                    .list();</span>
<span class="nc" id="L509">            assertThat(logEntries).hasSize(2);</span>

        } finally {
<span class="nc" id="L512">            String taskId = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult().getId();</span>
<span class="nc" id="L513">            managementService.executeCommand(commandContext -&gt; {</span>
<span class="nc" id="L514">                processEngineConfiguration.getTaskServiceConfiguration()</span>
<span class="nc" id="L515">                    .getHistoricTaskService().deleteHistoricTaskLogEntriesForTaskId(taskId);</span>
<span class="nc" id="L516">                return null;</span>
            });
<span class="nc" id="L518">            runtimeService.deleteProcessInstance(processInstance.getId(), &quot;clean up&quot;);</span>
        }
<span class="nc" id="L520">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/oneTaskProcess.bpmn20.xml&quot; })
    public void logProcessTaskEvents() {

<span class="nc" id="L526">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L527">        assertThat(processInstance).isNotNull();</span>

<span class="nc" id="L529">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L530">        assertThat(task).isNotNull();</span>
        try {
<span class="nc" id="L532">            taskService.setAssignee(task.getId(), &quot;newAssignee&quot;);</span>
<span class="nc" id="L533">            taskService.setOwner(task.getId(), &quot;newOwner&quot;);</span>
<span class="nc" id="L534">            taskService.complete(task.getId());</span>

<span class="nc bnc" id="L536" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L537">                List&lt;HistoricTaskLogEntry&gt; logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L538">                assertThat(logEntries).hasSize(4);</span>

<span class="nc" id="L540">                HistoricTaskLogEntry logEntry = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).type(&quot;USER_TASK_CREATED&quot;).singleResult();</span>
<span class="nc" id="L541">                assertThat(logEntry).isNotNull();</span>
<span class="nc" id="L542">                assertThat(logEntry.getProcessDefinitionId()).isEqualTo(processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L543">                assertThat(logEntry.getExecutionId()).isEqualTo(task.getExecutionId());</span>
<span class="nc" id="L544">                assertThat(logEntry.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>

<span class="nc" id="L546">                assertThat(historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).type(&quot;USER_TASK_ASSIGNEE_CHANGED&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L547">                assertThat(historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).type(&quot;USER_TASK_OWNER_CHANGED&quot;).count()).isEqualTo(1);</span>
<span class="nc" id="L548">                assertThat(historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).type(&quot;USER_TASK_COMPLETED&quot;).count()).isEqualTo(1);</span>
            }

        } finally {
<span class="nc" id="L552">            deleteTaskWithLogEntries(task.getId());</span>
        }
<span class="nc" id="L554">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/oneTaskProcess.bpmn20.xml&quot; })
    public void logAddCandidateUser() {

<span class="nc" id="L560">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L561">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
        try {
<span class="nc" id="L563">            assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L564">            assertThat(task).isNotNull();</span>

<span class="nc" id="L566">            taskService.addCandidateUser(task.getId(), &quot;newCandidateUser&quot;);</span>

<span class="nc bnc" id="L568" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L569">                List&lt;HistoricTaskLogEntry&gt; logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L570">                assertThat(logEntries).hasSize(2);</span>

<span class="nc" id="L572">                logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId())</span>
<span class="nc" id="L573">                        .type(&quot;USER_TASK_IDENTITY_LINK_ADDED&quot;)</span>
<span class="nc" id="L574">                        .list();</span>
<span class="nc" id="L575">                assertThat(logEntries).hasSize(1);</span>
<span class="nc" id="L576">                assertThatJson(logEntries.get(0).getData())</span>
<span class="nc" id="L577">                        .isEqualTo(&quot;{ type: 'candidate', userId: 'newCandidateUser' }&quot;);</span>
            }

        } finally {
<span class="nc" id="L581">            taskService.complete(task.getId());</span>
<span class="nc" id="L582">            deleteTaskWithLogEntries(task.getId());</span>
        }
<span class="nc" id="L584">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/oneTaskProcess.bpmn20.xml&quot; })
    public void logAddParticipantUser() {

<span class="nc" id="L590">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L591">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
        try {
<span class="nc" id="L593">            assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L594">            assertThat(task).isNotNull();</span>

<span class="nc" id="L596">            taskService.addUserIdentityLink(task.getId(), &quot;newCandidateUser&quot;, IdentityLinkType.PARTICIPANT);</span>

<span class="nc bnc" id="L598" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L599">                List&lt;HistoricTaskLogEntry&gt; logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L600">                assertThat(logEntries).hasSize(2);</span>

<span class="nc" id="L602">                logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId())</span>
<span class="nc" id="L603">                        .type(&quot;USER_TASK_IDENTITY_LINK_ADDED&quot;)</span>
<span class="nc" id="L604">                        .list();</span>
<span class="nc" id="L605">                assertThat(logEntries).hasSize(1);</span>
<span class="nc" id="L606">                assertThatJson(logEntries.get(0).getData())</span>
<span class="nc" id="L607">                        .isEqualTo(&quot;{ type: 'participant', userId: 'newCandidateUser' }&quot;);</span>
            }

        } finally {
<span class="nc" id="L611">            taskService.complete(task.getId());</span>
<span class="nc" id="L612">            deleteTaskWithLogEntries(task.getId());</span>
        }
<span class="nc" id="L614">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/oneTaskProcess.bpmn20.xml&quot; })
    public void logAddCandidateGroup() {

<span class="nc" id="L620">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L621">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L622">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L623">        assertThat(task).isNotNull();</span>

        try {
<span class="nc" id="L626">            taskService.addCandidateGroup(task.getId(), &quot;newCandidateGroup&quot;);</span>

<span class="nc bnc" id="L628" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L629">                List&lt;HistoricTaskLogEntry&gt; logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L630">                assertThat(logEntries).hasSize(2);</span>

<span class="nc" id="L632">                logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId())</span>
<span class="nc" id="L633">                        .type(&quot;USER_TASK_IDENTITY_LINK_ADDED&quot;)</span>
<span class="nc" id="L634">                        .list();</span>
<span class="nc" id="L635">                assertThat(logEntries).hasSize(1);</span>
<span class="nc" id="L636">                assertThatJson(logEntries.get(0).getData())</span>
<span class="nc" id="L637">                        .isEqualTo(&quot;{ type: 'candidate', groupId: 'newCandidateGroup' }&quot;);</span>
            }

        } finally {
<span class="nc" id="L641">            taskService.complete(task.getId());</span>
<span class="nc" id="L642">            deleteTaskWithLogEntries(task.getId());</span>
        }
<span class="nc" id="L644">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/oneTaskProcess.bpmn20.xml&quot; })
    public void logAddGroup() {

<span class="nc" id="L650">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L651">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L652">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L653">        assertThat(task).isNotNull();</span>
        try {

<span class="nc" id="L656">            taskService.addGroupIdentityLink(task.getId(), &quot;newCandidateGroup&quot;, IdentityLinkType.PARTICIPANT);</span>

<span class="nc bnc" id="L658" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L659">                List&lt;HistoricTaskLogEntry&gt; logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L660">                assertThat(logEntries).hasSize(2);</span>

<span class="nc" id="L662">                logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId())</span>
<span class="nc" id="L663">                        .type(&quot;USER_TASK_IDENTITY_LINK_ADDED&quot;)</span>
<span class="nc" id="L664">                        .list();</span>
<span class="nc" id="L665">                assertThat(logEntries).hasSize(1);</span>
<span class="nc" id="L666">                assertThatJson(logEntries.get(0).getData())</span>
<span class="nc" id="L667">                        .isEqualTo(&quot;{ type: 'participant', groupId: 'newCandidateGroup' }&quot;);</span>
            }

        } finally {
<span class="nc" id="L671">            taskService.complete(task.getId());</span>
<span class="nc" id="L672">            deleteTaskWithLogEntries(task.getId());</span>
        }
<span class="nc" id="L674">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/oneTaskProcess.bpmn20.xml&quot; })
    public void logDeleteCandidateGroup() {

<span class="nc" id="L680">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L681">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L682">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L683">        assertThat(task).isNotNull();</span>
<span class="nc" id="L684">        taskService.addCandidateGroup(task.getId(), &quot;newCandidateGroup&quot;);</span>
        try {
<span class="nc" id="L686">            taskService.deleteCandidateGroup(task.getId(), &quot;newCandidateGroup&quot;);</span>

<span class="nc bnc" id="L688" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L689">                List&lt;HistoricTaskLogEntry&gt; logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L690">                assertThat(logEntries).hasSize(3);</span>

<span class="nc" id="L692">                logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId())</span>
<span class="nc" id="L693">                        .type(&quot;USER_TASK_IDENTITY_LINK_REMOVED&quot;)</span>
<span class="nc" id="L694">                        .list();</span>
<span class="nc" id="L695">                assertThat(logEntries).hasSize(1);</span>
<span class="nc" id="L696">                assertThatJson(logEntries.get(0).getData())</span>
<span class="nc" id="L697">                        .isEqualTo(&quot;{ type: 'candidate', groupId: 'newCandidateGroup' }&quot;);</span>
            }

        } finally {
<span class="nc" id="L701">            taskService.complete(task.getId());</span>
<span class="nc" id="L702">            deleteTaskWithLogEntries(task.getId());</span>
        }
<span class="nc" id="L704">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/oneTaskProcess.bpmn20.xml&quot; })
    public void logDeleteCandidateUser() {

<span class="nc" id="L710">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L711">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L712">        assertThat(processInstance).isNotNull();</span>
<span class="nc" id="L713">        assertThat(task).isNotNull();</span>
<span class="nc" id="L714">        taskService.addCandidateUser(task.getId(), &quot;newCandidateUser&quot;);</span>

        try {
<span class="nc" id="L717">            taskService.deleteCandidateUser(task.getId(), &quot;newCandidateUser&quot;);</span>

<span class="nc bnc" id="L719" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L720">                List&lt;HistoricTaskLogEntry&gt; logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L721">                assertThat(logEntries).hasSize(3);</span>

<span class="nc" id="L723">                logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId())</span>
<span class="nc" id="L724">                        .type(&quot;USER_TASK_IDENTITY_LINK_REMOVED&quot;)</span>
<span class="nc" id="L725">                        .list();</span>
<span class="nc" id="L726">                assertThat(logEntries).hasSize(1);</span>
<span class="nc" id="L727">                assertThatJson(logEntries.get(0).getData())</span>
<span class="nc" id="L728">                        .isEqualTo(&quot;{ type: 'candidate', userId: 'newCandidateUser' }&quot;);</span>
            }

        } finally {
<span class="nc" id="L732">            taskService.complete(task.getId());</span>
<span class="nc" id="L733">            deleteTaskWithLogEntries(task.getId());</span>
        }
<span class="nc" id="L735">    }</span>

    @Test
    @Deployment(resources = &quot;org/flowable/engine/test/api/task/TaskIdentityLinksTest.testCustomIdentityLink.bpmn20.xml&quot;)
    public void logIdentityLinkEventsForProcessIdentityLinks() {

<span class="nc" id="L741">        runtimeService.startProcessInstanceByKey(&quot;customIdentityLink&quot;);</span>
<span class="nc" id="L742">        List&lt;org.flowable.task.api.Task&gt; tasks = taskService.createTaskQuery().taskInvolvedUser(&quot;kermit&quot;).list();</span>
<span class="nc" id="L743">        assertThat(tasks).hasSize(1);</span>
<span class="nc" id="L744">        task = tasks.get(0);</span>

<span class="nc bnc" id="L746" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L747">            List&lt;HistoricTaskLogEntry&gt; logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
            // create, identityLinkAdded, identityLinkAdded
<span class="nc" id="L749">            assertThat(logEntries).hasSize(3);</span>

<span class="nc" id="L751">            logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId())</span>
<span class="nc" id="L752">                    .type(&quot;USER_TASK_IDENTITY_LINK_ADDED&quot;)</span>
<span class="nc" id="L753">                    .list();</span>
<span class="nc" id="L754">            assertThat(logEntries).hasSize(2);</span>

<span class="nc" id="L756">            boolean hasKermit = false;</span>
<span class="nc" id="L757">            boolean hasManagement = false;</span>
<span class="nc" id="L758">            String data = logEntries.get(0).getData();</span>
<span class="nc" id="L759">            String data1 = logEntries.get(1).getData();</span>
<span class="nc bnc" id="L760" title="All 4 branches missed.">            if ((data.contains(&quot;\&quot;type\&quot;:\&quot;businessAdministrator\&quot;&quot;) &amp;&amp; data.contains(&quot;\&quot;userId\&quot;:\&quot;kermit\&quot;&quot;)) ||</span>
<span class="nc bnc" id="L761" title="All 4 branches missed.">                    (data1.contains(&quot;\&quot;type\&quot;:\&quot;businessAdministrator\&quot;&quot;) &amp;&amp; data1.contains(&quot;\&quot;userId\&quot;:\&quot;kermit\&quot;&quot;))) {</span>

<span class="nc" id="L763">                hasKermit = true;</span>
            }

<span class="nc bnc" id="L766" title="All 4 branches missed.">            if ((data.contains(&quot;\&quot;type\&quot;:\&quot;businessAdministrator\&quot;&quot;) &amp;&amp; data.contains(&quot;\&quot;groupId\&quot;:\&quot;management\&quot;&quot;)) ||</span>
<span class="nc bnc" id="L767" title="All 4 branches missed.">                    (data1.contains(&quot;\&quot;type\&quot;:\&quot;businessAdministrator\&quot;&quot;) &amp;&amp; data1.contains(&quot;\&quot;groupId\&quot;:\&quot;management\&quot;&quot;))) {</span>

<span class="nc" id="L769">                hasManagement = true;</span>
            }

<span class="nc" id="L772">            assertThat(hasKermit).isTrue();</span>
<span class="nc" id="L773">            assertThat(hasManagement).isTrue();</span>

<span class="nc" id="L775">            taskService.complete(tasks.get(0).getId());</span>

<span class="nc" id="L777">            HistoryTestHelper.waitForJobExecutorToProcessAllHistoryJobs(processEngineConfiguration, managementService, 10000, 200);</span>
<span class="nc" id="L778">            logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
            // + completed event. Do not expect identity link removed events
<span class="nc" id="L780">            assertThat(logEntries).hasSize(4);</span>

<span class="nc" id="L782">            logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId())</span>
<span class="nc" id="L783">                    .type(&quot;USER_TASK_COMPLETED&quot;)</span>
<span class="nc" id="L784">                    .list();</span>
<span class="nc" id="L785">            assertThat(logEntries).hasSize(1);</span>
        }
<span class="nc" id="L787">    }</span>

    @Test
    public void queryForTaskLogEntriesByTasKId() {

<span class="nc" id="L792">        task = taskService.createTaskBuilder().</span>
<span class="nc" id="L793">                assignee(&quot;testAssignee&quot;).</span>
<span class="nc" id="L794">                create();</span>
<span class="nc" id="L795">        Task anotherTask = taskService.createTaskBuilder().create();</span>

        try {
<span class="nc bnc" id="L798" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L799">                List&lt;HistoricTaskLogEntry&gt; logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L800">                assertThat(logEntries).hasSize(1);</span>
<span class="nc" id="L801">                assertThat(logEntries.get(0)).extracting(HistoricTaskLogEntry::getTaskId).isEqualTo(task.getId());</span>

<span class="nc" id="L803">                assertThat(historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).count()).isEqualTo(1);</span>
            }

        } finally {
<span class="nc" id="L807">            deleteTaskWithLogEntries(anotherTask.getId());</span>
        }
<span class="nc" id="L809">    }</span>

    @Test
    public void queryForTaskLogEntriesByUserId() {

<span class="nc" id="L814">        assertThatTaskLogIsFetched(historyService.createHistoricTaskLogEntryBuilder().userId(&quot;testUser&quot;),</span>
<span class="nc" id="L815">                historyService.createHistoricTaskLogEntryQuery().userId(&quot;testUser&quot;));</span>
<span class="nc" id="L816">    }</span>

    protected void assertThatTaskLogIsFetched(HistoricTaskLogEntryBuilder historicTaskLogEntryBuilder,
            HistoricTaskLogEntryQuery historicTaskLogEntryQuery) {

<span class="nc" id="L821">        task = taskService.createTaskBuilder().</span>
<span class="nc" id="L822">                assignee(&quot;testAssignee&quot;).</span>
<span class="nc" id="L823">                create();</span>
<span class="nc" id="L824">        Task anotherTask = taskService.createTaskBuilder().create();</span>
<span class="nc" id="L825">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>
<span class="nc" id="L826">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>
<span class="nc" id="L827">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>

        try {
<span class="nc bnc" id="L830" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L831">                List&lt;HistoricTaskLogEntry&gt; logEntries = historicTaskLogEntryQuery.list();</span>
<span class="nc" id="L832">                assertThat(logEntries).hasSize(3);</span>
<span class="nc" id="L833">                assertThat(logEntries).extracting(HistoricTaskLogEntry::getTaskId).containsExactly(task.getId(), task.getId(), task.getId());</span>

<span class="nc" id="L835">                assertThat(historicTaskLogEntryQuery.count()).isEqualTo(3);</span>

<span class="nc" id="L837">                List&lt;HistoricTaskLogEntry&gt; pagedLogEntries = historicTaskLogEntryQuery.listPage(1, 1);</span>
<span class="nc" id="L838">                assertThat(pagedLogEntries).hasSize(1);</span>
<span class="nc" id="L839">                assertThat(pagedLogEntries.get(0))</span>
<span class="nc" id="L840">                        .usingRecursiveComparison()</span>
<span class="nc" id="L841">                        .isEqualTo(logEntries.get(1));</span>
            }

        } finally {
<span class="nc" id="L845">            deleteTaskWithLogEntries(anotherTask.getId());</span>
        }
<span class="nc" id="L847">    }</span>
    
    protected void assertThatAllTaskLogIsFetched(HistoricTaskLogEntryBuilder historicTaskLogEntryBuilder,
            HistoricTaskLogEntryQuery historicTaskLogEntryQuery) {

<span class="nc" id="L852">        task = taskService.createTaskBuilder().</span>
<span class="nc" id="L853">                assignee(&quot;testAssignee&quot;).</span>
<span class="nc" id="L854">                create();</span>
<span class="nc" id="L855">        Task anotherTask = taskService.createTaskBuilder().create();</span>
<span class="nc" id="L856">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>
<span class="nc" id="L857">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>
<span class="nc" id="L858">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>

        try {
<span class="nc bnc" id="L861" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L862">                List&lt;HistoricTaskLogEntry&gt; logEntries = historicTaskLogEntryQuery.list();</span>
<span class="nc" id="L863">                assertThat(logEntries).hasSize(5);</span>
<span class="nc" id="L864">                assertThat(logEntries).extracting(HistoricTaskLogEntry::getTaskId).containsExactlyInAnyOrder(task.getId(), anotherTask.getId(), task.getId(), task.getId(), task.getId());</span>

<span class="nc" id="L866">                assertThat(historicTaskLogEntryQuery.count()).isEqualTo(5);</span>

<span class="nc" id="L868">                List&lt;HistoricTaskLogEntry&gt; pagedLogEntries = historicTaskLogEntryQuery.listPage(1, 1);</span>
<span class="nc" id="L869">                assertThat(pagedLogEntries).hasSize(1);</span>
<span class="nc" id="L870">                assertThat(pagedLogEntries.get(0))</span>
<span class="nc" id="L871">                        .usingRecursiveComparison()</span>
<span class="nc" id="L872">                        .isEqualTo(logEntries.get(1));</span>
            }

        } finally {
<span class="nc" id="L876">            deleteTaskWithLogEntries(anotherTask.getId());</span>
        }
<span class="nc" id="L878">    }</span>

    @Test
    public void queryForTaskLogEntriesByType() {

<span class="nc" id="L883">        assertThatTaskLogIsFetched(historyService.createHistoricTaskLogEntryBuilder().type(&quot;testType&quot;),</span>
<span class="nc" id="L884">                historyService.createHistoricTaskLogEntryQuery().type(&quot;testType&quot;));</span>
<span class="nc" id="L885">    }</span>

    @Test
    public void queryForTaskLogEntriesByProcessInstanceId() {

<span class="nc" id="L890">        assertThatTaskLogIsFetched(historyService.createHistoricTaskLogEntryBuilder().processInstanceId(&quot;testProcess&quot;),</span>
<span class="nc" id="L891">                historyService.createHistoricTaskLogEntryQuery().processInstanceId(&quot;testProcess&quot;));</span>
<span class="nc" id="L892">    }</span>

    @Test
    public void queryForTaskLogEntriesByScopeId() {

<span class="nc" id="L897">        assertThatTaskLogIsFetched(historyService.createHistoricTaskLogEntryBuilder().scopeId(&quot;testScopeId&quot;),</span>
<span class="nc" id="L898">                historyService.createHistoricTaskLogEntryQuery().scopeId(&quot;testScopeId&quot;));</span>
<span class="nc" id="L899">    }</span>

    @Test
    public void queryForTaskLogEntriesBySubScopeId() {

<span class="nc" id="L904">        assertThatTaskLogIsFetched(historyService.createHistoricTaskLogEntryBuilder().subScopeId(&quot;testSubScopeId&quot;),</span>
<span class="nc" id="L905">                historyService.createHistoricTaskLogEntryQuery().subScopeId(&quot;testSubScopeId&quot;));</span>
<span class="nc" id="L906">    }</span>

    @Test
    public void queryForTaskLogEntriesByScopeType() {

<span class="nc" id="L911">        assertThatTaskLogIsFetched(historyService.createHistoricTaskLogEntryBuilder().scopeType(&quot;testScopeType&quot;),</span>
<span class="nc" id="L912">                historyService.createHistoricTaskLogEntryQuery().scopeType(&quot;testScopeType&quot;));</span>
<span class="nc" id="L913">    }</span>

    @Test
    public void queryForTaskLogEntriesByFromTimeStamp() {

<span class="nc" id="L918">        assertThatAllTaskLogIsFetched(historyService.createHistoricTaskLogEntryBuilder().timeStamp(getInsertDate()),</span>
<span class="nc" id="L919">                historyService.createHistoricTaskLogEntryQuery().from(getCompareBeforeDate()));</span>
<span class="nc" id="L920">    }</span>

    @Test
    public void queryForTaskLogEntriesByToTimeStamp() {
        
<span class="nc" id="L925">        HistoricTaskLogEntryBuilder historicTaskLogEntryBuilder = historyService.createHistoricTaskLogEntryBuilder().timeStamp(getInsertDate());</span>
<span class="nc" id="L926">        HistoricTaskLogEntryQuery historicTaskLogEntryQuery = historyService.createHistoricTaskLogEntryQuery().to(getCompareAfterDate());</span>

<span class="nc" id="L928">        task = taskService.createTaskBuilder().</span>
<span class="nc" id="L929">                assignee(&quot;testAssignee&quot;).</span>
<span class="nc" id="L930">                create();</span>
<span class="nc" id="L931">        Task anotherTask = taskService.createTaskBuilder().create();</span>
<span class="nc" id="L932">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>
<span class="nc" id="L933">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>
<span class="nc" id="L934">        historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>

        try {
<span class="nc bnc" id="L937" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L938">                List&lt;HistoricTaskLogEntry&gt; logEntries = historicTaskLogEntryQuery.list();</span>
<span class="nc" id="L939">                assertThat(logEntries).hasSize(3);</span>
<span class="nc" id="L940">                assertThat(logEntries).extracting(HistoricTaskLogEntry::getTaskId)</span>
<span class="nc" id="L941">                        .containsExactly(task.getId(), task.getId(), task.getId());</span>

<span class="nc" id="L943">                assertThat(historicTaskLogEntryQuery.count()).isEqualTo(3);</span>

<span class="nc" id="L945">                List&lt;HistoricTaskLogEntry&gt; pagedLogEntries = historicTaskLogEntryQuery.listPage(1, 1);</span>
<span class="nc" id="L946">                assertThat(pagedLogEntries).hasSize(1);</span>
<span class="nc" id="L947">                assertThat(pagedLogEntries.get(0))</span>
<span class="nc" id="L948">                        .usingRecursiveComparison()</span>
<span class="nc" id="L949">                        .isEqualTo(logEntries.get(1));</span>
            }

        } finally {
<span class="nc" id="L953">            deleteTaskWithLogEntries(anotherTask.getId());</span>
<span class="nc" id="L954">            taskService.deleteTask(anotherTask.getId(), true);</span>
        }
<span class="nc" id="L956">    }</span>

    @Test
    public void queryForTaskLogEntriesByFromToTimeStamp() {

<span class="nc" id="L961">        assertThatTaskLogIsFetched(historyService.createHistoricTaskLogEntryBuilder().timeStamp(getInsertDate()),</span>
<span class="nc" id="L962">                historyService.createHistoricTaskLogEntryQuery().from(getCompareBeforeDate()).to(getCompareAfterDate()));</span>
<span class="nc" id="L963">    }</span>

    @Test
    public void queryForTaskLogEntriesByTenantId() {

<span class="nc" id="L968">        assertThatTaskLogIsFetched(historyService.createHistoricTaskLogEntryBuilder().timeStamp(getInsertDate()),</span>
<span class="nc" id="L969">                historyService.createHistoricTaskLogEntryQuery().from(getCompareBeforeDate()).to(getCompareAfterDate()));</span>
<span class="nc" id="L970">    }</span>

    @Test
    public void queryForTaskLogEntriesByLogNumber() {

<span class="nc" id="L975">        task = taskService.createTaskBuilder().</span>
<span class="nc" id="L976">                assignee(&quot;testAssignee&quot;).</span>
<span class="nc" id="L977">                create();</span>
<span class="nc" id="L978">        Task anotherTask = taskService.createTaskBuilder().create();</span>

        try {
<span class="nc bnc" id="L981" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L982">                HistoricTaskLogEntryBuilder historicTaskLogEntryBuilder = historyService.createHistoricTaskLogEntryBuilder();</span>
<span class="nc" id="L983">                historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>
<span class="nc" id="L984">                historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>
<span class="nc" id="L985">                historicTaskLogEntryBuilder.taskId(task.getId()).create();</span>

<span class="nc" id="L987">                HistoryTestHelper.waitForJobExecutorToProcessAllHistoryJobs(processEngineConfiguration, managementService, 10000, 200);</span>
<span class="nc" id="L988">                List&lt;HistoricTaskLogEntry&gt; allLogEntries = historyService.createHistoricTaskLogEntryQuery().list();</span>

<span class="nc" id="L990">                HistoricTaskLogEntryQuery historicTaskLogEntryQuery = historyService.createHistoricTaskLogEntryQuery().</span>
<span class="nc" id="L991">                        fromLogNumber(allLogEntries.get(1).getLogNumber()).</span>
<span class="nc" id="L992">                        toLogNumber(allLogEntries.get(allLogEntries.size() - 2).getLogNumber());</span>
<span class="nc" id="L993">                List&lt;HistoricTaskLogEntry&gt; logEntries = historicTaskLogEntryQuery.</span>
<span class="nc" id="L994">                        list();</span>
<span class="nc" id="L995">                assertThat(logEntries).hasSize(3);</span>
<span class="nc" id="L996">                assertThat(logEntries).extracting(HistoricTaskLogEntry::getLogNumber).containsExactly(</span>
<span class="nc" id="L997">                        allLogEntries.get(1).getLogNumber(), allLogEntries.get(2).getLogNumber(), allLogEntries.get(3).getLogNumber()</span>
                );

<span class="nc" id="L1000">                assertThat(historicTaskLogEntryQuery.count()).isEqualTo(3);</span>

<span class="nc" id="L1002">                List&lt;HistoricTaskLogEntry&gt; pagedLogEntries = historicTaskLogEntryQuery.listPage(1, 1);</span>
<span class="nc" id="L1003">                assertThat(pagedLogEntries).hasSize(1);</span>
<span class="nc" id="L1004">                assertThat(pagedLogEntries.get(0).getLogNumber()).isEqualTo(logEntries.get(1).getLogNumber());</span>
            }
        } finally {
<span class="nc" id="L1007">            deleteTaskWithLogEntries(anotherTask.getId());</span>
        }
<span class="nc" id="L1009">    }</span>

    @Test
    public void queryForTaskLogEntriesByNativeQuery() {
        
<span class="nc" id="L1014">        assertThat(managementService.getTableName(HistoricTaskLogEntryEntity.class, false)).isEqualTo(&quot;ACT_HI_TSK_LOG&quot;);</span>
<span class="nc" id="L1015">        assertThat(managementService.getTableName(HistoricTaskLogEntry.class, false)).isEqualTo(&quot;ACT_HI_TSK_LOG&quot;);</span>
<span class="nc" id="L1016">        HistoricTaskLogEntryBuilder historicTaskLogEntryBuilder = historyService.createHistoricTaskLogEntryBuilder();</span>
<span class="nc" id="L1017">        historicTaskLogEntryBuilder.taskId(&quot;1&quot;).create();</span>
<span class="nc" id="L1018">        historicTaskLogEntryBuilder.taskId(&quot;2&quot;).create();</span>
<span class="nc" id="L1019">        historicTaskLogEntryBuilder.taskId(&quot;3&quot;).create();</span>

<span class="nc bnc" id="L1021" title="All 2 branches missed.">        if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
            try {
<span class="nc" id="L1023">                assertThat(historyService.createNativeHistoricTaskLogEntryQuery()</span>
<span class="nc" id="L1024">                        .sql(&quot;SELECT * FROM &quot; + managementService.getTableName(HistoricTaskLogEntry.class)).list()).hasSize(3);</span>
<span class="nc" id="L1025">                assertThat(historyService.createNativeHistoricTaskLogEntryQuery()</span>
<span class="nc" id="L1026">                        .sql(&quot;SELECT count(*) FROM &quot; + managementService.getTableName(HistoricTaskLogEntry.class)).count()).isEqualTo(3);</span>

<span class="nc" id="L1028">                assertThat(historyService.createNativeHistoricTaskLogEntryQuery().parameter(&quot;taskId&quot;, &quot;1&quot;).</span>
<span class="nc" id="L1029">                        sql(&quot;SELECT count(*) FROM &quot; + managementService.getTableName(HistoricTaskLogEntry.class) + &quot; WHERE TASK_ID_ = #{taskId}&quot;).list())</span>
<span class="nc" id="L1030">                        .hasSize(1);</span>
<span class="nc" id="L1031">                assertThat(historyService.createNativeHistoricTaskLogEntryQuery().parameter(&quot;taskId&quot;, &quot;1&quot;).</span>
<span class="nc" id="L1032">                        sql(&quot;SELECT count(*) FROM &quot; + managementService.getTableName(HistoricTaskLogEntry.class) + &quot; WHERE TASK_ID_ = #{taskId}&quot;).count())</span>
<span class="nc" id="L1033">                        .isEqualTo(1);</span>
            } finally {
<span class="nc" id="L1035">                deleteTaskWithLogEntries(&quot;1&quot;);</span>
<span class="nc" id="L1036">                deleteTaskWithLogEntries(&quot;2&quot;);</span>
<span class="nc" id="L1037">                deleteTaskWithLogEntries(&quot;3&quot;);</span>
            }
        }
<span class="nc" id="L1040">    }</span>

    @Test
    public void queryForTaskLogOrderBy() {
        
<span class="nc" id="L1045">        HistoricTaskLogEntryBuilder historicTaskLogEntryBuilder = historyService.createHistoricTaskLogEntryBuilder();</span>
<span class="nc" id="L1046">        historicTaskLogEntryBuilder.taskId(&quot;1&quot;).timeStamp(getInsertDate()).create();</span>
<span class="nc" id="L1047">        waitForHistoryJobExecutorToProcessAllJobs(20000, 200);</span>
<span class="nc" id="L1048">        historicTaskLogEntryBuilder.taskId(&quot;2&quot;).timeStamp(getCompareAfterDate()).create();</span>
<span class="nc" id="L1049">        waitForHistoryJobExecutorToProcessAllJobs(20000, 200);</span>
<span class="nc" id="L1050">        historicTaskLogEntryBuilder.taskId(&quot;3&quot;).timeStamp(getCompareBeforeDate()).create();</span>
<span class="nc" id="L1051">        waitForHistoryJobExecutorToProcessAllJobs(20000, 200);</span>

        try {

<span class="nc bnc" id="L1055" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L1056">                List&lt;HistoricTaskLogEntry&gt; taskLogEntries = historyService.createHistoricTaskLogEntryQuery().list();</span>
<span class="nc" id="L1057">                assertThat(taskLogEntries).extracting(taskLogEntry -&gt; taskLogEntry.getTaskId()).containsExactlyInAnyOrder(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;);</span>

<span class="nc" id="L1059">                taskLogEntries = historyService.createHistoricTaskLogEntryQuery().orderByLogNumber().desc().list();</span>
<span class="nc" id="L1060">                assertThat(taskLogEntries).extracting(taskLogEntry -&gt; taskLogEntry.getTaskId()).containsExactly(&quot;3&quot;, &quot;2&quot;, &quot;1&quot;);</span>

<span class="nc" id="L1062">                taskLogEntries = historyService.createHistoricTaskLogEntryQuery().orderByTimeStamp().desc().list();</span>
<span class="nc" id="L1063">                assertThat(taskLogEntries).extracting(taskLogEntry -&gt; taskLogEntry.getTaskId()).containsExactly(&quot;2&quot;, &quot;1&quot;, &quot;3&quot;);</span>
            }

        } finally {
<span class="nc" id="L1067">            deleteTaskWithLogEntries(&quot;1&quot;);</span>
<span class="nc" id="L1068">            deleteTaskWithLogEntries(&quot;2&quot;);</span>
<span class="nc" id="L1069">            deleteTaskWithLogEntries(&quot;3&quot;);</span>
        }
<span class="nc" id="L1071">    }</span>

    @Test
    @Deployment(resources = { &quot;org/flowable/engine/test/api/runtime/oneTaskProcess.bpmn20.xml&quot; })
    public void logProcessTaskEventsInSameTransaction() {

<span class="nc" id="L1077">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;oneTaskProcess&quot;);</span>
<span class="nc" id="L1078">        assertThat(processInstance).isNotNull();</span>

<span class="nc" id="L1080">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span>
<span class="nc" id="L1081">        assertThat(task).isNotNull();</span>
        try {
<span class="nc" id="L1083">            managementService.executeCommand(commandContext -&gt; {</span>
<span class="nc" id="L1084">                taskService.setAssignee(task.getId(), &quot;newAssignee&quot;);</span>
<span class="nc" id="L1085">                taskService.setOwner(task.getId(), &quot;newOwner&quot;);</span>

<span class="nc" id="L1087">                return null;</span>
            });

<span class="nc bnc" id="L1090" title="All 2 branches missed.">            if (HistoryTestHelper.isHistoricTaskLoggingEnabled(processEngineConfiguration)) {</span>
<span class="nc" id="L1091">                List&lt;HistoricTaskLogEntry&gt; logEntries = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).list();</span>
<span class="nc" id="L1092">                assertThat(logEntries)</span>
<span class="nc" id="L1093">                        .extracting(HistoricTaskLogEntry::getType)</span>
<span class="nc" id="L1094">                        .containsExactlyInAnyOrder(</span>
                                &quot;USER_TASK_CREATED&quot;,
                                &quot;USER_TASK_ASSIGNEE_CHANGED&quot;,
                                &quot;USER_TASK_ASSIGNEE_CHANGED&quot;,
                                &quot;USER_TASK_OWNER_CHANGED&quot;
                        );

<span class="nc" id="L1101">                HistoricTaskLogEntry logEntry = historyService.createHistoricTaskLogEntryQuery().taskId(task.getId()).type(&quot;USER_TASK_CREATED&quot;).singleResult();</span>
<span class="nc" id="L1102">                assertThat(logEntry).isNotNull();</span>
<span class="nc" id="L1103">                assertThat(logEntry.getProcessDefinitionId()).isEqualTo(processInstance.getProcessDefinitionId());</span>
<span class="nc" id="L1104">                assertThat(logEntry.getExecutionId()).isEqualTo(task.getExecutionId());</span>
<span class="nc" id="L1105">                assertThat(logEntry.getProcessInstanceId()).isEqualTo(processInstance.getId());</span>
            }

        } finally {
<span class="nc" id="L1109">            taskService.complete(task.getId());</span>
<span class="nc" id="L1110">            deleteTaskWithLogEntries(task.getId());</span>
        }
<span class="nc" id="L1112">    }</span>


    protected Date getInsertDate() {
<span class="nc" id="L1116">        Calendar cal = new GregorianCalendar(2019, 3, 10);</span>
<span class="nc" id="L1117">        return cal.getTime();</span>
    }

    protected Date getCompareBeforeDate() {
<span class="nc" id="L1121">        Calendar cal = new GregorianCalendar(2019, 3, 9);</span>
<span class="nc" id="L1122">        return cal.getTime();</span>
    }

    protected Date getCompareAfterDate() {
<span class="nc" id="L1126">        Calendar cal = new GregorianCalendar(2019, 3, 11);</span>
<span class="nc" id="L1127">        return cal.getTime();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>